<apex:page title="棚卸" controller="ProductStockInventoryCtrl" sidebar="false" action="{!initStock}">
<apex:stylesheet value="{!URLFOR($Resource.kendoFiles2018, 'styles/kendo.common.min.css')}"/>
<apex:stylesheet value="{!URLFOR($Resource.kendoFiles2018, 'styles/kendo.default.min.css')}"/>

<apex:includeScript value="{!URLFOR($Resource.kendoFiles2018, 'js/jquery.min.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.kendoFiles2018, 'js/kendo.all.min.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.kendoFiles2018, 'js/messages/kendo.messages.ja-JP.min.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.kendoFiles2018, 'js/cultures/kendo.culture.ja-JP.min.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.queryfiles, 'js/jquery.blockUI.js')}"/>
<!-- 2014/11/25 六曜計算追加 -->
<apex:includeScript value="{!URLFOR($Resource.dateplugin, 'date/qreki.js')}" />
<apex:includeScript value="{!URLFOR($Resource.dateplugin, 'date/qrekiHelp.js')}" /> <!-- 和暦LIBのサポート関数 -->
<!-- 2015/07/10 KeyDefine追加 -->
<apex:includeScript value="{!URLFOR($Resource.queryfiles, 'js/keymaster.js')}"/>
<c:CommHeaderComp loadJsLib="false"/>
<apex:includeScript value="{!$Resource.CommJs}"/>
<!-- 2018/12/30 棚卸し機能（在庫照合、在庫数改修） by cxw BEGIN -->
<apex:includeScript value="{!URLFOR($Resource.qrlib, 'qrjslib/instascan.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.qrlib, 'qrjslib/qr_packed.js')}"/>
<!-- 2018/12/30 棚卸し機能（在庫照合、在庫数改修） by cxw END -->
<!-- 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz BEGIN -->
<meta id="view_id" name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1.0;"/>
<!-- 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz END -->
<style>
/* 画面初期化 */
html, body {
    height: 100%;
}
#contentWrapper{
    height:100%;
}
#contentWrapper .bodyDiv{
    height:auto;
}
#bodyTable{
    height:100%;
}
#contentWrap{
	/* 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz BEGIN */
    /*width: 100%;*/
    min-width:1200px;
    /* 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz END */
    height:100%;
    font-size:16px;
}
/* 画面初期化 */
.headDiv{
    width: 100%;
    height:50px;
    line-height: 50px;
    text-align: center;
}
.headerSpan{
    display: inline-block;
    text-align: center;
    height: 30px;
    line-height: 30px;
}
/* title 横幅設定 begin */
.titleItem{
    border: 1px solid #c5c5c5;
}
.titleItem>span:nth-child(1),tr.detailRow>td:nth-child(1){
    width: 50px;
    cursor: pointer;
    text-align: center;
}
.titleItem>span:nth-child(2),tr.detailRow>td:nth-child(2){
	/* 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz BEGIN */
    /* width: calc(100% - 595px); */
    width: calc(100% - 770px);
    /* 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz END */
}
/* 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz BEGIN */
.titleItem>span:nth-child(3),tr.detailRow>td:nth-child(3){
    width: 70px;
}
.titleItem>span:nth-child(4),tr.detailRow>td:nth-child(4){
    width: 90px;
}
/*
.titleItem>span:nth-child(3),tr.detailRow>td:nth-child(3){
    width: 100px;
    text-align: center;
}
.titleItem>span:nth-child(4),tr.detailRow>td:nth-child(4){
    width: 65px;
}
.titleItem>span:nth-child(5),tr.detailRow>td:nth-child(5){
    width: 70px;
}
.titleItem>span:nth-child(6),tr.detailRow>td:nth-child(6){
    width: 70px;
}
.titleItem>span:nth-child(7),tr.detailRow>td:nth-child(7){
    width: 120px;
}
.titleItem>span:nth-child(8),tr.detailRow>td:nth-child(8){
    width: 120px;
}*/
.titleItem>span:nth-child(5),tr.detailRow>td:nth-child(5){
    width: 100px;
    text-align: center;
}
.titleItem>span:nth-child(6),tr.detailRow>td:nth-child(6){
    width: 65px;
}
.titleItem>span:nth-child(7),tr.detailRow>td:nth-child(7){
    width: 70px;
}
.titleItem>span:nth-child(8),tr.detailRow>td:nth-child(8){
    width: 70px;
}
.titleItem>span:nth-child(9),tr.detailRow>td:nth-child(9){
    width: 120px;
}
.titleItem>span:nth-child(10),tr.detailRow>td:nth-child(10){
    width: 120px;
}
/* 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz END */
tr.detailRow>td{
	padding: 0px 2px;
}
/* IPAD BEGIN */
@media only screen and (min-device-width : 768px) and (max-device-width : 1024px) {
.titleItem>span:nth-child(2),tr.detailRow>td:nth-child(2){
    /* 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz BEGIN */
    /* width: calc(100% - 583px); */
    width: calc(100% - 755px);
    min-width:400px;
    /* 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz END */
}
.blockUI.blockMsg.blockPage h1{font-size: 10px;}
}
/* 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz BEGIN */
/* 
.titleItem>span:nth-child(7),tr.detailRow>td:nth-child(7){
    width: 90px;
}
.titleItem>span:nth-child(8),tr.detailRow>td:nth-child(8){
    width: 100px;
}
*/
.titleItem>span:nth-child(9),tr.detailRow>td:nth-child(9){
    width: 90px;
}
.titleItem>span:nth-child(10),tr.detailRow>td:nth-child(10){
    width: 100px;
}
/* 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz END */
/* IPAD END */
/* 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz BEGIN */
tr.detailRow .k-input[type='text'],tr.detailRow>td:nth-child(4)
	,tr.detailRow>td:nth-child(3),tr.detailRow>td:nth-child(9),tr.detailRow>td:nth-child(10)
    ,tr.detailRow>td:nth-child(6),tr.detailRow>td:nth-child(7),tr.detailRow>td:nth-child(8){
/* 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz END */
    text-align: right;
}
/* title 横幅設定 end */
/*　テーブル　*/
.inventoryTable{
    width: 100%;
    margin: 0;
    border-collapse: separate;
    border-spacing: 0;
    empty-cells: show;
    border-width: 0;
    outline: 0;
}
.gridBackGround{
    background-image: url(textures/highlight.png);
    background-image: none,-webkit-linear-gradient(top,rgba(255,255,255,.6) 0,rgba(255,255,255,.0) 100%);
    background-image: none,-moz-linear-gradient(top,rgba(255,255,255,.6) 0,rgba(255,255,255,.0) 100%);
    background-image: none,-o-linear-gradient(top,rgba(255,255,255,.6) 0,rgba(255,255,255,.0) 100%);
    background-image: none,linear-gradient(to bottom,rgba(255,255,255,.6) 0,rgba(255,255,255,.0) 100%);
    background-position: 50% 50%;
    background-color: #e3e3e3;
}
.inventoryTable tr.detailRow:nth-child(odd){
    background: white;
}
tr.detailRow>td{
    position:relative;
    border-color: #c5c5c5;
    border-style: solid;
    border-width: 0px 1px 1px 0px;
}
tr.detailRow>td:nth-child(1){
    border-color: #c5c5c5;
    border-style: solid;
    border-width: 0 1px 1px 1px;
}
.detailRow .k-input{
    width:98%;
    text-align: right;
}
/*　テーブル　*/
div.itemWrap{
    border: 2px solid #ececec;
}
div.tableWrap{
    overflow: scroll;
    max-height: 600px;
}
#functionDiv{
    display:none;
}
.p-dirty{
    top:0;
    left:0;
    width: 0;
    height: 0;
    margin: 0;
    padding: 0;
    overflow: hidden;
    border-width: 4px;
    border-style: solid;
    position: absolute;
    vertical-align: top;
    border-color: #f00 transparent transparent #f00;
}
.toolbar{
    height: 30px;
    padding:5px;
    font-size:14px;
    position:relative;
    border-style: solid;
    border-width: 0 0 1px;
    border-color: #c5c5c5;
    background-color: #eae8e8;
}
.loadinggif{
    width: 16px;
    display: inline-block;
    height: 16px;
    background-image: url("{!URLFOR($Resource.Expo, 'css/Default/loading.gif')}");
}
#functionBtn{
    position: absolute;
    left: calc(100%/2 - 50px);
}
#toolBtn{
    float:left;
}
.footDiv{
    height: 20px;
    line-height: 20px;
    padding: 5px;
}
.warningIcon{
    height:16px;
    width:16px;
    background-image: url(../img/msg_icons/warning16.png);
}
td.orgQtyClass{
    position: relative;
}
td.orgQtyClass .warningIcon{
    position: absolute;
    top: calc(100%/2 - 10px);
    left: 3px;
}
#functionBtn .k-button{
    width: 100px;
}
.displayClass{
    display:none;
}
/* モバイルのswitch BEGIN */
.switch {
  position: relative;
  display: inline-block;
  width: 40px;
  height: 23px;
}
.switch input {display:none;}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}
.slider:before {
  position: absolute;
  content: "";
  height: 19px;
  width: 19px;
  left: 2px;
  bottom: 2px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .slider {
  background-color: #2196F3;
}

input:focus + .slider {
  box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
  -webkit-transform: translateX(17px);
  -ms-transform: translateX(17px);
  transform: translateX(17px);
}
.slider.round {
  border-radius: 34px;
}

.slider.round:before {
  border-radius: 50%;
}
input:checked ~ .onchecked{
    display: block!important;
    position: absolute;
    z-index: 1;
    color: white;
    left: 3px;
    line-height: 23px;
    font-size: 14px;
}
input:checked ~ .nochecked{
    display: none!important;
}
.nochecked{
    position: absolute;
    right:3px;
    color:white;
    line-height: 23px;
    font-size: 14px;
}
/* モバイルのswitch END */
.imgClass{
	float:left;
	width: 22px;
    height: 22px;
    padding: 1px;
}
div.tableWrap .inventoryTable tr{
    height: 50px;
}
span.prodClass{
	display: table-cell;
    vertical-align: middle;
    height: 52px;
    line-height: 25px;
}
div.tableWrap.noImage .inventoryTable tr{
    height: 45px;
    line-height:45px;
}
div.tableWrap.noImage span.prodClass{
	height: 45px;
}
div.tableWrap.noImage .imgClass{
	display:none;
}
#toolBtn .k-button{
	border-radius:0px;
}
.k-button.selected{
	color: #fff;
    background-color: #f35800;
    border-color: #f85a00;
    background-image: url(textures/highlight.png);
    background-image: none,-webkit-gradient(linear,left top,left bottom,from(rgba(255,255,255,.2)),to(rgba(255,255,255,0)));
    background-image: none,-webkit-linear-gradient(top,rgba(255,255,255,.2) 0,rgba(255,255,255,0) 100%);
    background-image: none,linear-gradient(to bottom,rgba(255,255,255,.2) 0,rgba(255,255,255,0) 100%);
    -webkit-box-shadow: none;
    box-shadow: none;
}
/* 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw BEGIN */
div.tableWrap .inventoryTable tr,span.prodClass{
    height: 25px;
    line-height: auto;
}
div.tableWrap .inventoryTable tr input.k-textbox{
	padding:0px;
	line-height: auto;
	height:25px;
}
.hoverImg:hover{
	transform: scale(4);
	position: fixed;
	z-index:10;
	transition: transform .2s;
}
.hoverImg:hover + .prodClass{
	position: relative;
}
/* 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw END */
/*2018/12/30 棚卸し機能（在庫照合、在庫数改修） by cxw BEGIN*/
#caneraMode {
	position: fixed;
	width: 100%;
	height: 100%;
	z-index: 99999;
	left: 0;
	top: 0;
	background-color: white;
}

.ocrloader {
  width: 500px;
  height: 500px;
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  backface-visibility: hidden;
}
.ocrloader span {
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 3px;
  background-color: rgba(45, 183, 183, 0.54);
  z-index: 1;
  transform: translateY(200%);
  animation: move 3s infinite alternate;
  animation-iteration-count: infinite;
}
.ocrloader > div {
  z-index: 1;
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 48%;
  backface-visibility: hidden;
}
.ocrloader:before,
.ocrloader:after,
.ocrloader em:after,
.ocrloader em:before {
  border-color: #009900;
  content: "";
  position: absolute;
  width: 70px;
  height: 70px;
  border-style: solid;
  border-width: 0px;
}
.ocrloader:before {
  left: 0;
  top: 0;
  border-left-width: 5px;
  border-top-width: 5px;
}
.ocrloader:after {
  right: 0;
  top: 0;
  border-right-width: 5px;
  border-top-width: 5px;
}
.ocrloader em:before {
  left: 0;
  bottom: 0;
  border-left-width: 5px;
  border-bottom-width: 5px;
}
.ocrloader em:after {
  right: 0;
  bottom: 0;
  border-right-width: 5px;
  border-bottom-width: 5px;
}
@keyframes move {
  from {top: 0}
  to {top: 487px}
}

#caneraMode .layer {
    -webkit-overflow-scrolling: touch;
    top: 150px;
    left: 0;
    margin: 0;
    padding: 0;
    background-color: #fff;
    -webkit-background-clip: content;
    border-radius: 2px;
    box-shadow: 1px 1px 50px rgba(0,0,0,.3);
}

#caneraMode .layer-page .layer-content {
    position: relative;
    overflow: auto;
}
#caneraMode .layer-page .layer-btn {
    /*padding-top: 10px;*/
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    /*height: 60px;
    line-height: 60px;*/
}
#caneraMode .layer-btn-c {
    /*text-align: center;*/
    line-height: 35px;
    display: block;
    background-color: #fff;
    -webkit-box-flex: 1;
    -ms-flex: 1;
    flex: 1;
    margin: 0;
    border: 0;
}
/*#caneraMode .layer-btn {
    text-align: center;
    padding: 0 15px 12px;
    pointer-events: auto;
    user-select: none;
    -webkit-user-select: none;
}*/
#caneraMode .layer-btn .layer-btn0 {
    /*border-color: #1E9FFF;
    background-color: #1E9FFF;
    color: #fff;*/
    color: #26a2ff;
    width: 50%;
}
#caneraMode .layer-btn .layer-btn1 {
	width: 50%;
    border-right: 1px solid #ddd;
}
#caneraMode .layer-btn a {
	font-size: 50px;
	text-decoration: none;
	padding: 20px 0;
	color: #333;
}
/*#caneraMode .layer-btn a {
    height: 28px;
    line-height: 28px;
    margin: 5px 5px 0;
    padding: 10px 15px;
    border: 1px solid #dedede;
    background-color: #fff;
    color: #333;
    border-radius: 2px;
    font-weight: 400;
    cursor: pointer;
    text-decoration: none;
}
#caneraMode .layer-btn a {
    display: inline-block;
    *display: inline;
    *zoom: 1;
    vertical-align: top;
}*/
#caneraMode .change-input:hover {
    border-color: #D2D2D2!important;
}
#caneraMode .change-input {
    display: block;
    width: 100%;
    padding-left: 10px;
    line-height: 1.3;
    line-height: 38px\9;
    border-width: 1px;
    border-style: solid;
    background-color: #fff;
    border-radius: 2px;
    border-color: #e6e6e6;
    outline: 0;
    -webkit-appearance: none;
    transition: all .3s;
    -webkit-transition: all .3s;
    box-sizing: border-box;
}

#caneraMode table {
	font-size: 25px;
}

#primitive-count {
	text-align: center;
    font-size: 100px;
    font-weight: 400;
}

#caneraMode .arrow-right {
	width: 120px;
	text-align: center;
	font-size: 100px;
}

#now-count {
	width: 300px !important;
    font-size: 100px;
    padding-top: 5px;
    padding-bottom: 5px;
}

#product-name {
	font-size: 35px;
	padding-left: 20px;
	position: absolute; 
	left: 5px; 
	top: 2px;
	width: 70%; 
	overflow: hidden; 
	text-align: left; 
	height: 1.5em;
}

#group-name {
	font-size: 35px;
	position: absolute;
	right: 5px;
	top: 2px;
	width: 25%; 
	overflow: hidden; 
	text-align: right; 
	height: 1.5em;
}
                     
#caneraMode .label {
    color: #aba6a6;
    padding-top: 10px;
    font-size: 25px;
    display: inline-block;
    position: absolute;
    width: 300px;
}

#change-box {
	font-size: 25px;
	text-align: center; 
	position: absolute; 
	left: 0; 
	top: 0; 
	right: 0; 
	height: 100%; 
	display: none;
}
#change-layer-content {
	padding: 100px 50px; 
	line-height: 22px; 
	background-color: #fff; 
	font-weight: 300; 
	text-align: -webkit-center; 
	border-bottom: solid 1px #f1f1f1;
}

#change-layer {
	z-index: 19891017; 
	width: 100%; 
	left: 0; 
	right: 0; 
	top: 30%; 
	position: absolute; 
	display: none;
}

@media screen and (orientation: landscape) {
	#caneraMode #close-box {
		right: 50px;
		width: 90px;
		top: calc(50% - 40px);		
	}
}

@media screen and (orientation: portrait) {
	#caneraMode #close-box {
		bottom: 80px;
		width: 100%;
	}
}
/*2018/12/30 棚卸し機能（在庫照合、在庫数改修） by cxw END*/
</style>
<script type="text/x-kendo-template" id="rowTempalte">
<tr class="detailRow" prodid="_prodid_" detailId="_detailId_" price="_price_" stockId="_stockId_" orgstock="_orgQty_" difftitle="_title_">
<td>
    <label class="switch">
        <input type="checkbox" value="_checkflag_" onchange="changeStatus()" class="_checked_"/>
        <span class="slider round"></span>
		<!--
 		<span class="onchecked" style="display:none;">済</span>
        <span class="nochecked" style="display:block;">未</span>
		-->
    </label>
</td>
<td>
	<img src="_img_" class="imgClass"/>
	<span class="prodClass">_prodnm_<span>
</td>
<td class="stockClass">_stockDt_</td>
<td class="orgQtyClass">
    <span class="qtySpan">_orgQty_</span>
    <span class="warningIcon displayClass" title="該当商品の理論在庫と実際在庫不一致"></span>
</td>
<!-- 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw BEGIN -->
<td class="proQtyClass">_proQty_</td>
<!-- 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw END -->
<td>
    <span class="p-dirty" style="display:none;"></span>
    <input type="number" class="k-input k-textbox" oldvalue="_stockQty_" onchange="chkUpdate()" value="_stockQty_"/>
</td>
<td class="priceClass">_priceformat_</td>
<td>
    <span class="detailAmount">_amount_</span>
</td>
</tr>
</script>
<script>
var PageInfo = {
    // 画面初期化
    DATAREAD:'queryStockData',
    // データ保存
    DATAUPD:'updateStockData',
    // mode保存
    MODESAVE:'saveMode',
    RowTmpe:$("#rowTempalte").html()
};
var _isMobileOS;
kendo.culture("ja-JP");
$(document).ready(function(){
	_isMobileOS = kendo.support.mobileOS;
	// 初期化
	bindEvent();
    bindDropdown();
    bindWindowResize();
    // 画面関係情報刷新
    reloadPageInfo();
    initDataBind();
});
// 初期化
function bindEvent(){
	/* Window:F5 / Ctrl+R  Mac:Command+R 対応[2015/12/10 ADD] */
	var $key = key.noConflict();
	$key.filter = function(event){
		// 全画面から画面更新可能
		return true;
	}
	$key('command+r, ctrl+r, f5', function(e){ 
		reloadMaster();
		e.preventDefault();
		return false;
	});
	/*if(_isMobileOS)*/ $("#camera").click(function(){
		openCamera();
	}).show();
	// 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz BEGIN
	if (_isMobileOS) {
		$("#view_id").attr('content',"target-densitydpi=device-dpi, initial-scale=0.9, minimum-scale=0.2, maximum-scale=2.0, user-scalable=yes;");
	}
	// 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz END
}
function bindWindowResize(){
	$(window).resize(function(){
		resiePage();
	});
	resiePage();
}
function resiePage(){
	var maxHt = document.body.offsetHeight;
	// モビール
	if (_isMobileOS) {
		if (isSf1()) maxHt = $(document).height() - 50; // 50はツールの頭部
		else maxHt = document.body.offsetHeight - 20; // 50はツールの頭部
	}
	var wrapTop = $("div.tableWrap").offset().top;
	var footHt = $("div.footDiv").height();
	var lastHt = maxHt - wrapTop - footHt - 5;
	$("div.tableWrap").css("max-height",lastHt);
}
// remote機能
function remoteCenter(type,req,options,callback,callData){
    if (req == undefined || !req) req = {};
    // 既に定義する売価はプランカラ取得、画面に設定する
    Visualforce.remoting.Manager.invokeAction(
    "{!$RemoteAction.ProductStockInventoryCtrl.remoteCenter}", type,JSON.stringify(req), function(result, event){
        var errorFlag = false;
        if(event.type == 'exception') {
            console.log("-------error-------");
            alert(event.message);
            if (options) options.error();
            errorFlag = true;
        } else if(result != null){
            // html encode
            try{
            } catch(e){}
            if (options) options.success(result);
        }
        if (callback != undefined) callback(result,callData,errorFlag);
    });
}
function bindDropdown(){
    $(".dropdownLst").kendoDropDownList({
        change:function(e){
            var value = this.value();
            if (value == "") $(".itemWrap").show();
            else {
                $(".itemWrap").hide();
                $(".itemWrap[name='" + value + "']").show();
            }
        },
    });
}
// 該当在庫チェック
function chkUpdate(){
    var curTarget = $(event.currentTarget);
    var oldValue = curTarget.attr("oldvalue");
    var curRow = curTarget.closest("tr.detailRow");
    var newValue = kendo.parseFloat(curTarget.val());
    var grid = curTarget.closest("div.itemWrap");
    var orgStock = kendo.parseFloat(curRow.attr("orgstock"));
    if (oldValue != newValue) {
        curRow.addClass("updateElement");
        $(curTarget).prev().show();
    } else {
        curRow.removeClass("updateElement");
        $(curTarget).prev().hide();
    }
    if (orgStock != null) {
        if (orgStock != newValue) $(".warningIcon",curRow).removeClass("displayClass");
        else $(".warningIcon",curRow).addClass("displayClass");
    }
    curRow.find("input:checkbox").prop("checked",true);
    // 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz BEGIN
    var costValue = kendo.parseFloat($(".CostCls",curRow).text());
    var newValuation = newValue * costValue;
    $(".valuationCls",curRow).text(kendo.toString(newValuation,"c"));
    // 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz END
    computeGridAmount(grid);
}
// チェック変更
function changeStatus(){
	var curTarget = $(event.currentTarget);
	var oldValue = curTarget.val();
	var curRow = curTarget.closest("tr.detailRow");
	curTarget.toggleClass("checked");
	if (oldValue == "true" && !curTarget.hasClass("checked") 
		|| oldValue == "false" && curTarget.hasClass("checked")) curRow.addClass("updateElement");
	else curRow.removeClass("updateElement");
}
function reloadPageInfo(){
    // 非表示アイコン
    $(".warningIcon").addClass("displayClass");
    var waringingTitle = '該当商品の理論在庫と実際在庫不一致';
    // 差異状態更新です
    $("tr.detailRow").each(function(){
        var curRow = $(this);
        var orgValue = kendo.parseFloat(curRow.attr("orgstock"));
        var newValue = curRow.find("input.k-input").val();
        // 2018/12/30 棚卸し機能（在庫照合、在庫数改修） by cxw BEGIN
        var title = '';
        //if (orgValue != newValue) $(".warningIcon",curRow).removeClass("displayClass");
        var diffTitle = curRow.attr("difftitle");
	    if (diffTitle != undefined && diffTitle != "") title += diffTitle;
        else if (orgValue != newValue) title += waringingTitle;
        if (title != undefined && title != "") {
        	$(".warningIcon",curRow).attr("title",title);
        	$(".warningIcon",curRow).removeClass("displayClass");
        }
        // 2018/12/30 棚卸し機能（在庫照合、在庫数改修） by cxw END
    });
    // 計算指定棚ろし金額
    computeEachAmount();
    // checkbox状態更新
    $("input:checkbox.checked").prop("checked",true);
    $("input:checkbox:not('.checked')").prop("checked",false);
    // 画面スグールバーチェック
    resizeTotal();
    // 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw BEGIN
    imgFuncSetting();
    // 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw END
}
// 在庫データ保存
function updData(){
    var updLst = [];
    var warp = $("div.itemWrap");
    var groupNm = warp.attr("name");
    // 2019/04/15 宿屋EXPOの棚卸について by zy BEGIN
    var selectors = $('tr.updateElement');
    if (true) selectors = $('tr.detailRow:has(".checked"),tr.updateElement');
    //$("tr.updateElement").each(function(){
    selectors.each(function(){
    // 2019/04/15 宿屋EXPOの棚卸について by zy END
        var curRow = $(this);
        var input = $("input.k-input",curRow);
        var curGrid = curRow.closest("div.itemWrap");
        var accountId = curRow.attr("prodid");
        var stockId = curRow.attr("stockId");
        var initStock = input.val();
        var checkbox = $("input:checkbox",curRow);
        var checkValue = checkbox.val();
        // チェック済み→未の場合特処理
        if (checkValue == "true" && !checkbox.is(":checked"))　initStock = kendo.parseFloat(curRow.attr("orgstock"));
        var obj = {
            accountId:accountId,
            stockQty:initStock,
            stockId:stockId,
            groupName:groupNm,
            checkFlag:checkbox.is(":checked")
        };
        updLst.push(obj);
    });
    // 2018/12/30 棚卸画面保存状態表現追加 by zy BEGIN
   	onblockUi();
    // 2019/04/15 宿屋EXPOの棚卸について by zy BEGIN
    if (updLst.length > 1000) alert('1,000件以内に選択してください。');
    // 2019/04/15 宿屋EXPOの棚卸について by zy END
    if (updLst.length > 0) {
    	//onblockUi();
    	remoteCenter(PageInfo.DATAUPD,updLst,false,afterUpdate);
    }else {
    	setTimeout(unblockUi, 500);
    }
    // 2018/12/30 棚卸画面保存状態表現追加 by zy END
}
function canData(){
    $("tr.updateElement").each(function(){
        var curRow = $(this);
        var input = $("input.k-input",curRow);
        input.val(input.attr("oldvalue"));
        // チェック取り消し
        var checkbox = $("input:checkbox",curRow);
        checkbox.prop("checked",checkbox.val() == "true");
        if (checkbox.val() != "true") checkbox.removeClass("checked");
    });
    $(".p-dirty").hide();
    $("tr.updateElement").removeClass("updateElement");
     // 画面関係情報刷新
    reloadPageInfo();
}
function onblockUi(){
    JINYACONNECT.blockUi();
}
function unblockUi(){
    JINYACONNECT.unblockUi();
}
function afterRead(data){
    loadPage(data);
}
function afterUpdate(data){
    unblockUi();
    $(".p-dirty").hide();
    $("tr.updateElement").removeClass("updateElement");
    loadPage(data);
}
// 画面内容刷新
function loadPage(result, flag){
    var grids = $("div.itemWrap");
    for (var i = 0 ; i < result.length ; i++) {
        var row = result[i];
        var curGrid = grids.filter("[name='" + row.mstId + "']");
        var curRow = $("tr.detailRow[prodid='" + row.accountId + "']");
        if (curRow.length == 0) {
            var rowHtml = createRow(row);
            $("table.inventoryTable",curGrid).append($(rowHtml));
        } else {
            updateRow(curRow,row);
        }
    }
     // 画面関係情報刷新
    reloadPageInfo();
    if(!flag) JINYACONNECT.unblockUi();
}
// 計算指定棚ろし金額
function computeEachAmount(grids){
    if (grids == undefined) grids = $("div.itemWrap");
    grids.each(function(){
        var grid = $(this);
        computeGridAmount(grid);
    });
}
// 指定棚内容刷新
function computeGridAmount(grid){
    var totalAmount = 0;
    $("tr.detailRow",grid).each(function(){
        var price = $(this).attr("price");
        var cnt = 0;
        var priceFloat = kendo.parseFloat(price);
        var detailAmount = 0;
        cnt = kendo.parseFloat($("input.k-input",this).val());
        if (cnt == null) cnt = 0;
        if (priceFloat != null) {
            detailAmount = priceFloat * cnt;
            totalAmount += detailAmount;
        }
        $(".detailAmount",this).text(kendo.toString(detailAmount,"c"));
    });
    $(".totalAmount",grid).text(kendo.toString(totalAmount,"c"));
}
// 在庫情報行作成
function createRow(data){
    var dt = data.stockDt;
    var accId = data.accountId;
    var price = data.price;
    var detailId = data.detailId;
    var accountNm = data.accountNm;
    var stockId = data.stockId;
    var orgQty = data.orgQty;
    var stockQty = data.stockQty;
    var amount = data.amount;
    var checkFlag = data.checkFlag;
    var checkclass = checkFlag ? 'checked':'';
    var img = htmlCode(data.image);
    // 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw BEGIN
    var proQty = data.reasonableStockQty;
    // 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw END
    // 2018/12/30 棚卸し機能（在庫照合、在庫数改修） by cxw BEGIN
    var title = data.title;
    // 2018/12/30 棚卸し機能（在庫照合、在庫数改修） by cxw END
    if (dt == undefined) dt = '';
    if (stockId == undefined || stockId == "") stockId = '';
    if (accId == undefined) accId = '';
    if (price == undefined) price = 0;
    if (detailId == undefined) detailId = '';
    if (accountNm == undefined) accountNm = '';
    if (orgQty == undefined) orgQty = 0;
    if (stockQty == undefined) stockQty = '';
    if (amount == undefined) amount = 0;
    else amount = kendo.toString(data.amount,"c");
    // 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw BEGIN
    if (proQty == undefined) proQty = 0;
    // 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw END
    // 2018/12/30 棚卸し機能（在庫照合、在庫数改修） by cxw BEGIN
    if (title == undefined || title == null) title = "";
    // 2018/12/30 棚卸し機能（在庫照合、在庫数改修） by cxw END
    var rowHtml = PageInfo.RowTmpe.replace(/_prodid_/g,accId)
                            .replace(/_price_/g,price)
                            .replace(/_priceformat_/g,kendo.toString(price,"c"))
                            .replace(/_prodnm_/g,accountNm)
                            .replace(/_checkflag_/g,checkFlag)
                            .replace(/_checked_/g,checkclass)
                            .replace(/_stockDt_/g,dt)
                            .replace(/_orgQty_/g,orgQty)
                            .replace(/_stockQty_/g,stockQty)
                            .replace(/_stockId_/g,stockId)
                            .replace(/_amount_/g,amount)
                            // 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw BEGIN
                            .replace(/_proQty_/g,proQty)
                            // 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw END
                            // 2018/12/30 棚卸し機能（在庫照合、在庫数改修） by cxw BEGIN
                            .replace(/_title_/g,title)
                            // 2018/12/30 棚卸し機能（在庫照合、在庫数改修） by cxw END
                            .replace(/_img_/g,img);
    return rowHtml;
}
//　在庫情報行更新です
function updateRow(curRow,data){
    var dt = data.stockDt;
    if (dt == undefined) dt = '';
    var stockId = data.stockId;
    if (stockId == undefined || stockId == "") stockId = '';
    // 既存フラグ
    var checkFlag = data.checkFlag
    curRow.attr("price",data.price);
    curRow.attr("stockId",stockId);
    curRow.attr("orgstock",data.orgQty);
    // 2018/12/30 棚卸し機能（在庫照合、在庫数改修） by cxw BEGIN
    var title = data.title;
    if (title == undefined || title == null) title = "";
    curRow.attr("difftitle",title);
    // 2018/12/30 棚卸し機能（在庫照合、在庫数改修） by cxw END
    curRow.find(".prodClass").text(htmlCode(data.accountNm));
    curRow.find(".imgClass").attr("src",htmlCode(data.image));
    curRow.find(".orgQtyClass span.qtySpan").text(data.orgQty);
    var input = curRow.find(".k-input");
    input.val(data.stockQty);
    input.attr("oldvalue",data.stockQty);
    curRow.find(".stockClass").text(dt);
    curRow.find(".priceClass").text(kendo.toString(data.price,"c"));
    curRow.find(".detailAmount").text(kendo.toString(data.amount,"c"));
    // 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz BEGIN
    curRow.find(".CostCls").text(kendo.toString(data.stockCost,"c"));
    var valuation = data.stockQty * data.stockCost;
    curRow.find(".valuationCls").text(kendo.toString(valuation,"c"));
    // 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz END
    // 既存フラグ
    if (checkFlag) curRow.find("input:checkbox").addClass("checked");
    else curRow.find("input:checkbox").removeClass("checked");
    curRow.find("input:checkbox").val(checkFlag);
    // 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw BEGIN
    var proQty = data.reasonableStockQty;
    if (proQty == undefined) proQty = 0;
    curRow.find(".proQtyClass").text(proQty);
    // 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw END
}
//　該当棚のデータ刷新
function reloadMaster(){
    JINYACONNECT.blockUi();
    var warp = $("div.itemWrap");
    var groupNm = warp.attr("name");
    var obj = {groupName:groupNm};
    remoteCenter(PageInfo.DATAREAD,obj,false,afterRead);
}
// 変更棚後対応
function afterChangeMaster(){
    JINYACONNECT.unblockUi();
     // 画面関係情報刷新
    reloadPageInfo();
}
// 画面スグールバーチェック
function resizeTotal(){
	var wrapWd = $("div.tableWrap").innerWidth();
	var tableTble = $(".inventoryTable.gridBackGround").innerWidth();
	// スグールバー存在
	var diffWd = wrapWd - tableTble;
	if (diffWd > 0) $(".footDiv.gridBackGround>span").css("margin-right",diffWd);
}
// 写真変更
function changeMode(showFlag){
	var curTarget = $(event.currentTarget);
	$(".k-button.selected").removeClass("selected");
	if (showFlag) {
		curTarget.addClass("selected");
		$("div.tableWrap").removeClass("noImage");
	} else {
		curTarget.addClass("selected");
		$("div.tableWrap").addClass("noImage");
	}
	remoteCenter(PageInfo.MODESAVE,showFlag);
}
function htmlCode(res){
	var curDiv = $("<div/>");
	curDiv.html(res);
	return curDiv.text();
}
// 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw BEGIN
function imgFuncSetting(){
	// 初期化商品位置設定
	$("img.hoverImg").each(function(){
		var curTd = $(this).closest("td");
		var curSpan = $("span.prodClass",curTd);
		var leftVal = curSpan.position().left - 2;
		var wrapWd = curTd.width() - leftVal;
		if (wrapWd <= 0) wrapWd = curSpan.width();
		curSpan.css({ left:leftVal,width:wrapWd});
		if (_isMobileOS) {
			this.addEventListener( 'touchstart',setImgTop,false);
		}
		var obj = {currentTarget : this};
		setImgTop(obj);
	});
	$("img.hoverImg").mouseenter(function(){
		var curTd = $(this).closest("td");
		var top = curTd.get(0).getBoundingClientRect().top;
		$(this).css("top", top);
		$(window).bind('mousewheel', function(event, delta) { return false; });
	}).mouseleave(function(){
		$(window).unbind('mousewheel');
	});
} 
function setImgTop(evt){
	var curTd = $(evt.currentTarget).closest("td");
	var top = curTd.get(0).getBoundingClientRect().top;
	$(this).css("top", top);
}
// 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw END
/*2018/12/30 棚卸し機能（在庫照合、在庫数改修） by cxw BEGIN*/
function CameraUtil(video, canvas, callback, area){
	if(!(video && video.tagName == "VIDEO")) throw new Error("video invalid");
	if(!(canvas && canvas.tagName == "CANVAS")) throw new Error("canvas invalid");
	if(!(callback && callback instanceof Function)) throw new Error("callback invalid");
	this._autorefrsh = true;
	this.video = video;
	this.canvas = canvas;
	this.callback = callback;
	this.area = area;
	this.iosRear = false;
	this.devices = undefined;
	this.activeIndex = 0;
	this.localStream = null;
	this.ios = /iPad|iPhone|iPod|Mac/i.test(navigator.userAgent);
}

CameraUtil.prototype = {
	init: function(){
		var that = this;
		Instascan.Camera.getCameras()
		   .then(function (cameras) {
		       that.devices = cameras;
		       that.changeCamera(that.devices.length - 1);
		   })
		   .catch(function (err) {
		   	   that._autorefrsh = false;
		   	   alert(err.message);
		       throw err;
		   });
		   return this;
	},
	pause: function(){
		clearInterval(this.intervalHandle);
	},
	destroy: function(){
		if (this.localStream) this.localStream.getVideoTracks()[0].stop();
		clearInterval(this.intervalHandle);
	},
	changeCamera: function(index){
		if (this.localStream) this.localStream.getVideoTracks()[0].stop();	
		this.activeIndex = index;
		this.iosRear = !this.iosRear;
		this.setCamera();
	},
	setCamera: function(){
		navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || windiow.navigator.mozGetUserMedia;
		          window.URL = window.URL || window.webkitURL;
		          var videoOptions, that = this;
		          if (this.ios) {
		              videoOptions = {
		                  facingMode: {
		                      exact: (that.iosRear) ? 'environment' : 'user'
		                  }
		              };
		          } else {
		              videoOptions = {
		                  mandatory: {
		                      sourceId: that.devices[that.activeIndex].id,
		                      minWidth: 600,
		                      maxWidth: 800,
		                      minAspectRatio: 1.6
		                  },
		                  optional: []
		              };
		          }
		
		          navigator.getUserMedia(
		              {
		                  audio: false,
		                  video: videoOptions
		              },
		              function (stream) {
		                  if (that.ios) {
		                      that.video.srcObject = stream;
		                  } else {
		                      that.video.src = window.URL.createObjectURL(stream);
		                  }
		                  that.localStream = stream;
		              },
		              function (err) {
		
		              }
		          );
		
		          that.startReadQR();
	},
	startReadQR: function() {
		var that = this;
		this.intervalHandle = setInterval(function(){
			that.decode();
		}, 500);
    },
    decode: function(){
		if (this.localStream) {
		    var canvas = this.canvas, that = this;
		    var ctx = canvas.getContext('2d');
		    var img = document.getElementById('img');
		    var position = this.area.position();
		    var size = {width: this.area.innerWidth(), height: this.area.innerHeight()};
		    canvas.setAttribute('width', 300);
		    canvas.setAttribute('height', 300);
		    var percent = {w: this.video.offsetWidth / this.video.videoWidth, h: this.video.offsetHeight / this.video.videoHeight};
		    var left = position.left / percent.w;
		    var top = position.top / percent.h;
		    var width = size.width / percent.w;
		    var height = size.height / percent.h;
		    ctx.drawImage(this.video, left, top, width, height, 0, 0, 300, 300);
		    that.decodeImageFromBase64(canvas.toDataURL('image/png'), function (decodeInformation) {
		        if (!(decodeInformation instanceof Error)) {
		            that.callback(decodeInformation);
		        }
		    });
		}
    },
    decodeImageFromBase64: function(data, callback){
		qrcode.callback = callback;
		qrcode.decode(data);
    }
};

function openCamera(){
	var scan = $("#scan");
	var $caneraMode = $("#caneraMode");
	hideScrollbar();
	$caneraMode.show(200, function(){
		$caneraMode.data("CAMERA_UTIL" ,new CameraUtil(document.getElementById("video"), document.getElementById("canvas"), function(string){
			openChangeBox(string);
		}, scan).init());
	});
}

function closeCamera(){
	var $caneraMode = $("#caneraMode"); // CAMERA_UTIL
	if($caneraMode.length){
		var instance = $caneraMode.data("CAMERA_UTIL");
		if(instance) instance.destroy();
		$caneraMode.hide(200);
		showScrollbar();
		if(instance._autorefrsh) reloadMaster();
	}
}

function openChangeBox(string){
	var $caneraMode = $("#caneraMode");
	if($caneraMode.length){
		var instance = $caneraMode.data("CAMERA_UTIL");
		if(instance) instance.pause();
	}
	remoteProductDesc([string.trim()], function(result){
		kendo.ui.progress($("#change-box"), false);
		if(result.length > 0){
			result = result[0];
			$caneraMode.data("RESULT", result);
			setChangeBoxValue(result);
			setChangeBoxPopupPosition("CENTER");
			$(window).resize(function(){
				setChangeBoxPopupPosition("CENTER");
			});
			$("#change-layer").show(200, function(){
				$("#now-count").trigger("click").focus();
			});		
		}else{
			closeChangeBox();
			alert("商品がみつからない!");
		}
	});
	$("#change-box").show();
	kendo.ui.progress($("#change-box"), true);
}

function setChangeBoxValue(result){
	window.dataBind.productName = result.accountNm || "";
	window.dataBind.primitiveCount = result.stockQty || 0;
	window.dataBind.nowCount = result.stockQty || 0;
	window.dataBind.changeLastTime = result.stockDt;
	window.dataBind.groupName = result.groupName || "";
}

function closeChangeBox(){
	$("#change-layer").hide(200, function(){
		$("#change-box").hide();
		var $caneraMode = $("#caneraMode");
		if($caneraMode.length){
			var instance = $caneraMode.data("CAMERA_UTIL");
			if(instance) instance.startReadQR(); // start
			$(window).unbind("resize");
		}
	});
}

function setChangeBoxPopupPosition(POSITION){
	switch(POSITION){
		case "CENTER":
			var height = $(window).height();
			if (window.orientation == 90 || window.orientation == -90) {
				$("#change-layer-content").css({"padding-top": "50px", "padding-bottom": "50px"});
			}else{
				$("#change-layer-content").css({"padding-top": "100px", "padding-bottom": "100px"});
			}
			var top = (height - $("#change-layer").height()) / 2;
			$("#change-layer").css("top", top);
			break;
	}
}

function hideScrollbar(){
	document.body.parentNode.style.overflowY = "hidden";
}

function showScrollbar(){
	document.body.parentNode.style.overflowY = "";
}

function initDataBind(){
	window.dataBind = new DataBind();
	dataBind.bind("productName", $("#product-name")[0]); // 商品名
	dataBind.bind("primitiveCount", $("#primitive-count")[0]); // 原始数量
	dataBind.bind("groupName", $("#group-name")[0]); // 棚名
	dataBind.bind("nowCount", $("#now-count")[0]); // 现在数量
	dataBind.bind("changeLastTime", $("#change-last-time")[0]); // 上次修改时间
	// $(window).height($(window).height());
}

function save(){
	var $caneraMode = $("#caneraMode");
	var result = $caneraMode.data("RESULT");
	if(result){
		kendo.ui.progress($("#change-layer"), true);
		result.stockQty = window.dataBind.nowCount || 0;
		result.checkFlag = true;
		remoteCenter(PageInfo.DATAUPD,[result],false,function(result){
			kendo.ui.progress($("#change-layer"), false);
			closeChangeBox();
		});
	}else{
		closeChangeBox();
	}
}

function remoteProductDesc(Ids, callback){
	remoteCenter('remoteProductDesc',Ids,false,callback);
}

function DataBind(){}
DataBind.prototype = {
	bind: function(name, element){
		if(element instanceof Element){
			var command = "";
			if(/INPUT|TEXTAREA/.test(element.tagName)){
				command = "value";
			}else{
				command = "innerText";
			}
			Object.defineProperty(this, name, {
				get: function(){
					return element[command];
				},
				set: function(value){
					element[command] = value;
				}
			});		
		}
	}
};
/*2018/12/30 棚卸し機能（在庫照合、在庫数改修） by cxw END*/
</script>
<div id="contentWrap">
    <apex:form >
    <div class="toolbar gridBackGround">
        <span id="functionBtn">
            <!-- 
            <span class="k-button" onclick="canData()">キャンセル</span>
             -->
            <span class="k-button" onclick="updData()">保存</span>
        </span>
        <span id="toolBtn">
            <apex:selectList value="{!masterOptVal}" styleClass="dropdownLst">
                <apex:selectOptions value="{!masterOpts}"/>
                <apex:actionSupport event="onchange" action="{!changeMaster}" rerender="masterWrap" onsubmit="JINYACONNECT.blockUi();" oncomplete="afterChangeMaster();" />
            </apex:selectList>
            <!-- 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw BEGIN
            <!--
            <span class="k-button k-button-icon {!if(showFlag,'selected','')}" onclick="changeMode(true)">
           	 	<span class="k-icon k-i-grid-layout"></span>
            </span>
            <span class="k-button k-button-icon {!if(showFlag,'','selected')}" style="float: right" onclick="changeMode(false)">
            	<span class="k-icon k-i-layout-side-by-side"></span>
            </span>
             	2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw END
             -->
        </span>
        <span id="camera" class="k-button" style="display:none; opacity: .7; position: fixed; right: 0; top: calc(50% - 40px); z-index: 2;">
	        <span class="k-icon k-i-photo-camera" style="font-size: 80px;"></span>
        </span>
    </div>
    </apex:form>
    <apex:form id="masterWrap">
        <div class="itemWrap" name="{!masterOptVal}">
            <div class="gridBackGround">
                <div class="titleItem">
                    <span class="headerSpan">確認</span>
                    <span class="headerSpan">商品</span>
                    <!-- 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz BEGIN -->
                    <span class="headerSpan">原価</span>
                    <span class="headerSpan">棚卸評価額</span>
                    <!-- 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz END -->
                    <span class="headerSpan">棚卸日</span>
                    <span class="headerSpan">理論在庫</span>
                    <!-- 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw BEGIN -->
                    <span class="headerSpan">適正在庫</span>
                    <!-- 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw END -->
                    <span class="headerSpan">実際在庫</span>
                    <span class="headerSpan">単価</span>
                    <span class="headerSpan">金額</span>
                </div>
            </div>
            <div class="tableWrap {!if(showFlag,'','noImage')}">
            <table class="inventoryTable gridBackGround">
                <apex:repeat value="{!stocks}" var="stock">
                    <tr class="detailRow" prodid="{!stock.accountId}" price="{!stock.price}" stockId="{!stock.stockId}" orgstock="{!stock.orgQty}" id="{!stock.accountId}"
                    	difftitle="{!stock.title}">
                        <td>
                            <label class="switch">
                              <input type="checkbox" value="{!stock.checkFlag}" onchange="changeStatus()" class="{!if(stock.checkFlag,'checked','')}"/>
                              <span class="slider round"></span>
                              <!-- 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw BEGIN
                              <span class="onchecked" style="display:none;">済</span>
                              <span class="nochecked" style="display:block;">未</span>
                               2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw END -->
                            </label>
                        </td>
                        <td>
							<img src="{!stock.image}" class="imgClass {!if(stock.defaultFlag,'','hoverImg')}"/>
							<span class="prodClass">{!stock.accountNm}</span>
						</td>
                        <!-- 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz BEGIN -->
                        <td class="priceClass CostCls">
                            <apex:outputtext value="{!CurrencySybmol}{0,number,{!NumberFormat}}">
                              <apex:param value="{!stock.stockCost}"></apex:param>
                             </apex:outputtext>
                        </td>
                        <td class="priceClass valuationCls">
                            <apex:outputtext value="{!CurrencySybmol}{0,number,{!NumberFormat}}">
                              <apex:param value="{!stock.valuation}"></apex:param>
                             </apex:outputtext>
                        </td>
                        <!-- 2019/09/30 棚卸機能(原価、棚卸評価額項目追加と連絡)改善 BY zyz END -->
                        <td class="stockClass">{!stock.stockDt}</td>
                        <td class="orgQtyClass">
                            <span class="qtySpan">{!stock.orgQty}</span>
                            <span class="warningIcon displayClass" title="該当商品の理論在庫と実際在庫不一致"></span>
                        </td>
                        <!-- 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw BEGIN -->
                        <td class="proQtyClass">{!stock.reasonableStockQty}</td>
                        <!-- 2018/11/8 棚卸画面、「適正在庫」列は追加の対応 by cxw END -->
                        <td>
                            <span class="p-dirty" style="display:none;"></span>
                            <!-- 2018/12/30 JINYABUG-1297 bug fix by cxw BEGIN -->
                            <input type="number" class="k-input k-textbox stock-qty-input" oldvalue="{!stock.stockQty}" onchange="chkUpdate()" value="{!stock.stockQty}"/>
                        	<!-- 2018/12/30 JINYABUG-1297 bug fix by cxw END -->
                        </td>
                        <td class="priceClass">
                            <apex:outputtext value="{!CurrencySybmol}{0,number,{!NumberFormat}}">
                              <apex:param value="{!stock.price}"></apex:param>
                             </apex:outputtext>
                        </td>
                        <td>
                            <span class="detailAmount">{!stock.amount}</span>
                        </td>
                    </tr>
                </apex:repeat>
                
            </table>
            <!-- 2018/12/30 JINYABUG-1297 bug fix by cxw BEGIN -->
            <script>
            	$(":input.stock-qty-input").each(function(){
            		this.value = parseFloat(this.value) || 0;
            		this.classList.remove("stock-qty-input");
            	});
            </script>
            <!-- 2018/12/30 JINYABUG-1297 bug fix by cxw END -->
            </div>
            <div class="footDiv gridBackGround">
                <span style="float:right;">
                    <span>合計</span>
                    <span class="totalAmount"></span>
                </span>
            </div>
        </div>
    </apex:form>
</div>
<div id="functionDiv">
    
</div>  
<!-- 2018/12/30 棚卸し機能（在庫照合、在庫数改修） by cxw BEGIN -->
<div id="caneraMode" style="display: none;">
	<div data-type="video-box">
		<video id="video" autoplay="true" playsinline="playsinline" width="100%" height="100%" style="width: 100%; height: 100%;"></video>
	</div>
	<div data-type="canvas-box" style="display: none;">
		<canvas id="canvas"></canvas>
	</div>
	<div data-type="scan-box">
		<div class="ocrloader" id="scan">
		  <em></em>
		  <span></span>
		</div>
	</div>
	<div data-type="close-box" style="text-align: center; position: absolute;" id="close-box">
		<span class="k-icon k-i-close-circle" style="font-size: 80px; color: red;" onclick="closeCamera();"></span>
	</div>
	
	<div data-type="change-box" id="change-box">
		<div style="position: absolute; left: 0; top: 0; bottom: 0; right:0; background-color: #000; opacity: 0.8"></div>
		<div class="layer layer-page" id="change-layer">
		    <div class="layer-content">
		    	<div id="product-name" style=""></div>
		    	<div id="group-name" ></div>
		        <div id="change-layer-content">
		        	<table>
		        		<tr>
		        			<td>もとの数</td>
		        			<td></td>
		        			<td>変更後の数</td>
		        		</tr>
		        		<tr>
		        			<td id="primitive-count"></td>
		        			<td class="arrow-right"><span class="k-icon k-i-arrow-right" style="font-size: inherit;"></span></td>
		        			<td style="position:relative;">
		        				<input type="number" class="change-input" id="now-count" oninput = "value=value.replace(/[^\d]/g,'')"/>
		        				<label class="label">棚卸日: <span id="change-last-time"></span></label>
		        			</td>
		        		</tr>
		        	</table>
		        </div>
		    </div>
		    <div class="layer-btn">
		    	<a class="layer-btn-c layer-btn1" onclick="closeChangeBox();">キャンセル</a>
		    	<a class="layer-btn-c layer-btn0" onclick="save();">棚卸</a>
		    </div>
		</div>
	</div>
</div>
<!-- 2018/12/30 棚卸し機能（在庫照合、在庫数改修） by cxw END -->
</apex:page>