<!-- 会計 -->
<apex:page standardController="AccountAcount__c" extensions="BillSimpleInputCtrl" title="{!$Label.ps__msg_006_0251}"
    sidebar="false" action="{!initAction}" tabstyle="AccountAcount__c">

<meta name="viewport" content="width=1280;initial-scale=0.5;user-scalable=yes;"/>

<c:CommHeaderComp />
<!-- 2018/03/30 会計書の店舗切替を保存 WGCH BEGIN -->
<c:UserConfigComp functiontype="KREP" rendered="{!spCdCookieFlg}"/>
<!-- 2018/03/30 会計書の店舗切替を保存 WGCH END -->
<!-- Plan Extend plugIn -->
<apex:includeScript value="{!$Resource.planExtendPlug}"/>
<!-- JSで単価金額計算ロジック -->
<c:CommProductFeeCalJsComp />
<apex:includeScript value="{!URLFOR($Resource.OrderLib, 'js/process.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.OrderLib, 'js/PrintJs.js')}"/>
<!-- レイアウトIDを定義する -->
<apex:variable var="BillSimpleProductCompId" value="{!'BillSimpleProductComp'}" />
<!--  2019/11/15 最近利用している商品一覧機能を提供する BY zyz BEGIN -->
<c:AutoAccountMasterComp />
<!--  2019/11/15 最近利用している商品一覧機能を提供する BY zyz END -->
<apex:variable var="BillSimplePaymentCompId" value="{!'BillSimplePaymentComp'}" />
<!-- 2020/07/30 入湯税の自動入力機能について改善 zyz BEGIN -->
<c:CustomBathTaxAutoSet />
<!-- 2020/07/30 入湯税の自動入力機能について改善 zyz END -->
<style>
th.totalRowNumCell {
    text-align: right;
}

.ui-autocomplete { 
    max-height: 200px;
    overflow-y: auto;
    overflow-x: hidden;
    top:0px;
}
/* IE 6 doesn't support max-height
 * we use height instead, but this forces the menu to always be this tall
 */
* html .ui-autocomplete {
    height: 200px;
}
.ui-autocomplete-loading { background: white url({!URLFOR($Resource.queryfiles, "css/ui-lightness/images/ui-anim_basic_16x16.gif")}) right center no-repeat; }
.ui-autocomplete { position: absolute; cursor: default;z-index:30 !important;}
/*绑定造成页面宽度问题*/
.ui-helper-hidden-accessible{
    top:0;
}
.pointImg{
    cursor: move;
}
/*
 * Salesforce Stand Css Edit
 */
/* Salesforce Calendar Link No Show */
.tranDetailRow .dateFormat{
    display:none;
}
/* Salesforce Lookup Item */
.lookupInput input {
    width:100%;
}
/* Lookup Icon Css */
.lookupInput a {
    width: 25px;
    height: 22px;
    padding:0px;
    margin-left: -25px;
}
.lookupIcon {
    padding:0px;
    margin-right:0px ;
}
/* PageBlock Title Css */
.bPageBlock .pbTitle {
    width: 0px;
}
.bPageBlock .pbBottomButtons .pbTitle {
    width: 0px;
}
td.pbTitle {    
    white-space: nowrap;    
}
.bPageBlock.apexDefaultPageBlock .pbHeader>table {
    padding:  0px 5px;
}
.bPageBlock .pbHeader>table>tbody>tr>td {
    padding: 0px 5px;
}
.apexp .bPageBlock .pbHeader .btn {
    margin-right: 0px;
}
body .apexp .bPageBlock.apexDefaultPageBlock .pbBody{
    margin: 7px 5px 7px;
}
body .apexp .bPageBlock.apexDefaultPageBlock .pbBottomButtons {
    margin-top: 0px;
}
/* 会計明細 */
div#tranPanel .list td {
    padding: 1px 2px 1px 1px;
}
div#tranPanel .detailCommStyle{
    font-size: 12px;
}
div#tranPanel .headerRow {
    text-align: center;
    font-size: 12px;
    padding: 0px;
    margin: 0px;
}
div#tranPanel .totalRow {
    background-color: #f2f3f3;
    text-align: center;
    font-size: 12px;
    padding: 0px;
    margin: 0px;
}
div#tabstrip .bPageBlock .pbHeader {
    display: none;
}
/*
div#tranPanel .pbBody table.list tr.headerRow th{
    text-algin: center;
    color: red;
}*/
/*
* Kendo UI Stand Css Edit
*/
.k-combobox .k-dropdown-wrap, .k-dropdown .k-dropdown-wrap {
    height: 21px;
}
.k-dropdown-wrap .k-input {
    height: 21px;
    padding: 0px;
}
input.k-textbox {
    height: 23px;
    padding: 0px;
}
.k-button-icontext {
    padding-right: 0px;
    overflow: hidden;
}
/*
* ToolBar Css Style
*/
div.toolButttonStyle {
    text-align: center; 
    min-width: 64px;
    white-space:nowrap;
    /*border: groove 2px #ffffff;*/
    border-right: groove 2px #ffffff;
    float: left;
    padding:0px 2px 0px 2px;
}
div#PrintPdfStartDialog.overlayDialog .innerContent {
    padding:4px;
    margin: 2px;
}
div#PrintPdfStartDialog.overlayDialog .innerContent input {
    font-size: 100%;
}
/* 2018/06/06 支払メニューが横幅調整後、請求金額正確に表示されない不具合改修 BEGIN
@media screen and (max-width: 1640px) {
    td.fixedWidthCol0 {
        width: {!VALUE(payLayoutInfo.tableWidth) -10 - 28}px!important;
    }
    div#tranPanel .list td.fixedWidthCol1 {
        width: {!(VALUE(payLayoutInfo.tableWidth) -10 -18 - 36)/4}px!important;
    }
    div#tranPanel .list td.fixedWidthCol2 {
        width: {!(VALUE(payLayoutInfo.tableWidth) -10 -18 - 36)/4}px!important;
    }
    div#tranPanel .list td.fixedWidthCol3 {
        width: {!(VALUE(payLayoutInfo.tableWidth) -10 -18 - 36)/4}px!important;
    }
    div#tranPanel .list td.fixedWidthCol4 {
        width: {!(VALUE(payLayoutInfo.tableWidth) -10 -18 - 36)/4}px!important;
    }
}
*/
@media screen and (min-width: 1640px) {
    div#tranPanel .list td.left_fixedWidthCol3 {
        width: 7%!important;
    }
    div#tranPanel .list td.left_fixedWidthCol4 {
        width: 6%!important;
    }
    div#tranPanel .list td.left_fixedWidthCol5 {
        width: 7%!important;
    }
}
@media screen and (min-width: 1280px) and (max-width: 1540px) {
    div#tranPanel .list td.left_fixedWidthCol3 {
        width: 5%!important;
    }
    div#tranPanel .list td.left_fixedWidthCol4 {
        width: 4%!important;
    }
    div#tranPanel .list td.left_fixedWidthCol5 {
        width: 6%!important;
    }
}
@media screen and (min-width: 1540px) and (max-width: 1640px) {
    div#tranPanel .list td.left_fixedWidthCol3 {
        width: 6%!important;
    }
    div#tranPanel .list td.left_fixedWidthCol4 {
        width: 4.5%!important;
    }
    div#tranPanel .list td.left_fixedWidthCol5 {
        width: 6%!important;
    }
}
/*2018/06/06 支払メニューが横幅調整後、請求金額正確に表示されない不具合改修 BEGIN*/
td.fixedWidthCol0 {
    width: {!VALUE(payLayoutInfo.tableWidth) -10 - 28}px!important;
}
div#tranPanel .list td.fixedWidthCol1 {
    width: {!(VALUE(payLayoutInfo.tableWidth) -10 -18 - 36)/4}px!important;
}
div#tranPanel .list td.fixedWidthCol2 {
    width: {!(VALUE(payLayoutInfo.tableWidth) -10 -18 - 36)/4}px!important;
}
div#tranPanel .list td.fixedWidthCol3 {
    width: {!(VALUE(payLayoutInfo.tableWidth) -10 -18 - 36)/4}px!important;
}
div#tranPanel .list td.fixedWidthCol4 {
    width: {!(VALUE(payLayoutInfo.tableWidth) -10 -18 - 36)/4}px!important;
}
/* END*/
tr.tranDetailRowDemo td.dataCell{
    height:0px;
    border-left: 1px solid #ededed;
    visibility:hidden;
    background: #f2f3f3;
}
.StickyHeadRow{
    border-bottom: #f2f3f3 !important;
}
div#tranPanel .colHeadr {
    text-align: center;
    font-size: 12px;
    padding: 0px;
    margin: 0px;
    height:0px;
    display: none;
}
div#tranPanel .colHeadrVis {
    text-align: center;
    font-size: 12px;
    visibility:hidden;
}
#contentDiv tr.tranHeadRow{
    height:0px;
}
/*更改显示top正好挡住blockui*/
#costMachine{
    margin: 280px 25%;
    text-align: right;
    background: white;
    display:none;
    position: fixed;
    border-radius: 4px; 
}
/*更改显示层级刚好在blockui上*/
.printBack{
    z-index:1016 !important;
    background: rgba(0, 0, 0, 0.6) !important;
}
#loading-image{
    float: left;
}
/* 2018/12/15 請求書-領収書新規レイアウトを追加 WGCH BEGIN */
#printPdfWinTabStrip > div{
    overflow-x: hidden !important;
}
/* 2018/12/15 請求書-領収書新規レイアウトを追加 WGCH END */
tr.tranDetailRow input[id$=price][readonly=true] {
    background-color: #DCDCDC;
}
</style>
<script>
$=jQuery.noConflict();
beenFocused = true;
/** 書式処理 */
var currency = kendo.culture().numberFormat.currency;
var orginPrice,focusFlag = false;
var _CONST_PRICE_ROOM_TYPE = '室料';          // 室料のKeyWord定義する
currency.decimals = JINYACONNECT.NumberPointLen;
currency.symbol = JINYACONNECT.CurrencySybmol;
currency.pattern = ["$-n","$n"];
var _CONST_NOSETAMOUNTFLG = {!accountNoSetAmountWhenNoShowFlg};
// 2020/01/30 非表示の一括解除、あるいは金額を0円にしない非表示設定の追加 WGCH BEGIN
var _CONST_SETAMOUNTFLG = ("{!accountNoSetAmountWhenNoShowMode}" == "2");
// 2020/01/30 非表示の一括解除、あるいは金額を0円にしない非表示設定の追加 WGCH END
// 2019/01/30 会計の売上計上日が自動入力機能対応 BEGIN
var oldSakesdateVal,
    _CONST_RECEIPTDTAUTOSETFLG = {!accReceiptDtAutoSetFlg};
// 2019/01/30 会計の売上計上日が自動入力機能対応 END
// 支払メデイア関連情報を取得する
var g_paymentCovnertMap = JSON.parse("{!JSENCODE(payTypeConvertJson)}");
// 返金比較用キー
var g_refundKeyArr = JSON.parse("{!JSENCODE(refundItemString)}");
var _g_ns = JINYACONNECT.NS;
// 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応
var mrShowSelectHtml = '';
// 2016/02/25 Log Output
var logger = new Array();
// clear the one row info
// 2020/07/30 入湯税の自動入力機能について改善 zyz BEGIN
// HTML索引值初期设定
ACTCUSTOM.TAGINITFUN("[id$=tran1Table] tbody tr.tranDetailRow", "hidProductId", "rowindex", "hidBTaxAccMstId", "hidBTaxToPlanRowIndex", "orderNums", "clearProduct", "hidBTaxAccMstItem", "autoGetProductInfo", "refreshOrder", "addTranItemFun");
// 2020/07/30 入湯税の自動入力機能について改善 zyz END
// 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH BEGIN
// 初期调用保存FLG
var initUpsertFlg = {!initUpsertFlg};
kendo.culture("ja-JP");
COMM_SET = {
    ACTTYPE_AR : "{!JSENCODE(ACTTYPE_AR)}",
    ACTTYPE_PAY: "{!JSENCODE(ACTTYPE_PAY)}",
    ACTTYPE_PLAN : "{!JSENCODE(ACTTYPE_PLAN)}",
    ACTTYPE_PAY_DIS_PRICE : "{!JSENCODE(ACTTYPE_PAY_DIS_PRICE)}",
    ACTTYPE_PAY_DIS_RATE : "{!JSENCODE(ACTTYPE_PAY_DIS_RATE)}",
    ACTTYPE_PAY_ADD_RATE : "{!JSENCODE(ACTTYPE_PAY_ADD_RATE)}",
    DEF_DEV_POS_NO : "{!JSENCODE(DEF_DEV_POS_NO)}",
    TAX_NUMBER_FOMART : "{!JSENCODE(TaxNumberFormat)}",
    MEDIA_TYPE_COPON : "{!JSENCODE(MEDIA_TYPE_COPON)}",
    MEDIA_TYPE_DISCOUNT : "{!JSENCODE(MEDIA_TYPE_DISCOUNT)}",
    BOOKEST_USE_DATE : "{!bookEstUserDateFlg}" == "true",
    SHOP_CODE : "{!JSENCODE(oShopCode)}",
    IS_DEBUG : false,
    BILL_SIPLIT_SRC : "{!URLFOR('/apex/' & $Setup.CommDefine__c.AppNS__c & 'BillSimpleSplitProcess')}?scontrolCaching=1&id={!oAcountSobj.id}",
    ACCOUNT_SKIP_SRC:"{!URLFOR('/apex/' & $Setup.CommDefine__c.AppNS__c & 'AccountSkip')}?scontrolCaching=1&id={!oAcountSobj.id}"
}
// 明細行対象
class ProdItem {
    constructor(){
        this.accRefId = "";
        this.amoutExcTax = null;
        this.amoutIncTax = null;
        // 非表示不是手动变更的情况下
        this.autoSetInvoiceNoShowFlg = true;
        this.bathTaxAutoSetupFlg = false;
        this.bookEstItemId = "";
        this.bTaxAccMstId = "";
        this.bTaxAccMstItem = "";
        this.bTaxToPlanRowIndex = "";
        this.changeAmout = 0;
        this.index = 0;
        this.initPlanInfo = 0;
        this.isARProduct = false;
        this.isEstItemFlg = false;
        this.isNoUpdate = true;
        this.isPayProduct = false;
        this.isPlanMasterFlg = false;
        this.isPlanProduct = false;
        this.isValidata = true;
        this.orgLeadId = "";
        this.orgSpecialTax = 0;
        this.orgAmoutExcTax = null;
        this.orgAmoutIncTax = null;
        this.orgInvoiceNoShowFlg = false;
        this.orgActionType = '';
        this.orgPaymentType = '';
        this.paymentIconUrl = "";
        this.planBrkInfo = "";
        this.productCd = "";
        this.productNm = "";
        this.quantity = 0;
        this.rowNo = 0;
        this.servicePriceIncTax = 0;
        this.sobj = {};
        this.specialTax = 0;
        this.strSpecialTax = "";
        this.serviceLabel = "";
        this.taxAmount = 0;
        this.taxRate = 0;
        this.taxUnitPrice = 0;
        this.tranId = "";
        this.tranUseDate = null;
        this.taxValLabel = "";
        this.unitPrice = 0;
        this.usedAmount = 0;
        // 2021/07/15 #12910 bug fixed by zy BEGIN
        this.planItemLst = null;
        // 2021/07/15 #12910 bug fixed by zy END
    }
    // 転換画面用行
    convertSobj(){
        var obj = this;
        var sobjArr = ['TaxRate__c','ServiceRate__c','ActionType__c','Field7__c','UseDate__c'];
        sobjArr.forEach(function(name){
            obj.triggerAfter(name,obj.get(name));
        });
    }
    // データ設定後
    triggerAfter (name,value) {
        if (name == 'TaxRate__c') {
            this.taxValLabel = (kendo.toString(commUtils.mathNumDiv(value, 100), COMM_SET.TAX_NUMBER_FOMART))
        }
        if (name == 'ServiceRate__c') {
            this.serviceLabel = (value === 0 ? value : (value == null ? "" : value));
        }
        if (name == 'Field20__c') {
            this.unitPrice = (value === 0 ? value : (value == null ? "" : value));
        }
        if (name == 'SpecialTax__c') {
            // 宿泊税は０の場合、空白に設定を行う
            var strSpecialTax = (value === 0 ? value : (value == null ? "" : value));
            this.specialTax = value;
            this.strSpecialTax = strSpecialTax;
        }
        if (name == 'Field7__c') {
            this.productId = value;
        }
        if (name == 'ActionType__c') {
            this.actionType = value;
        }
        if (name == 'productCd') {
            // ImgUrl Path Append 情報を設定する
            if (this.actionType == COMM_SET.ACTTYPE_AR || this.actionType == COMM_SET.ACTTYPE_PAY) {
                // 該当ボタンのアイコンURLを取得する
                this.paymentIconUrl = {!BillSimplePaymentCompId}_getButtonIconUrl(value);
            } else {
                this.paymentIconUrl = null;
            }
        }
        // 2021/04/31 #10649 bug fixed by zy BEGIN
        if (name == 'UseDate__c') {
            this.tranUseDate = ((value == null || value === "") ? null : kendo.toString(new Date(value),JINYACONNECT.DateFormat));
        }
        // 2021/04/31 #10649 bug fixed by zy END
    }
    // 数据设定
    set (name,value){
        var obj = this;
        if (typeof name === "string") {
            // 当前数据设定
            if (name in obj) obj[name] = value;
            else if (name.includes("__c") || name.includes("__r")) {
                obj.sobj[(_g_ns + name)] = value;
            }
            this.triggerAfter(name, value);
        } else if (typeof name === "object") {
            for (var key in name) {
                if (typeof key === "string") {
                    // object模式下value存的是trigger
                    obj.set(key,name[key],value);
                }
            }
        }
    }
    // 根据数据名取值
    get (name){
        if (name != undefined) {
            var value;
            if (name in this) value = this[name];
            else if (name in this.sobj) value = this.sobj[name];
            else if ((_g_ns + name) in this.sobj) value = this.sobj[(_g_ns + name)];
            if (typeof value === "string") return name,value || "";
            else if (typeof value === "number") return value || 0;
            else if (typeof value === "boolean") return value;
            else return value || "";
        }
        return null;
    }
    // 計算無効チェック
    checkValidata (){
        return (this.get('Field20__c') + "") != "" && 
            (this.get('Field21__c') + "") != "" && (this.get('Field7__c') != "");
    }
    // 合計無効チェック
    amountValidata(){
        return !this.get('InvoiceNoShowFlg__c');
    }
    // 支払い画像取得
    getPaymentIcon (){
        if ( this.paymentIconUrl != null &&  this.paymentIconUrl != ""){
            return '<img style="width:22px;height:22px;margin-right: 0px;" src="' + this.paymentIconUrl + '" />';
        } else if (this.paymentIconUrl != null){
            return '<img style="width:22px;height:22px;margin-right: 0px;" src="{!JSENCODE(PayiconDefault)}" />';
        }
        return "";
    }
    // 2021/05/31 #11504 bug fixed by zy BEGIN
    isPayMentType(){
        if (this == undefined) {
            return false;
        }
        var actionType = this.get('actionType'),
            ACTTYPE_AR = COMM_SET.ACTTYPE_AR,
            ACTTYPE_PAY = COMM_SET.ACTTYPE_PAY;
        return actionType == ACTTYPE_AR || actionType == ACTTYPE_PAY;
    }
    // 2021/05/31 #11504 bug fixed by zy END
}
// 会計処理中心
J_ACCOUNT_CENTER = {
    rowTemplate : '',
    details:[],   // 会計明細
    totalAmountIncTax: 0,   // 利用金額
    totalAmountExcTax: 0,   // 利用金額（税抜き）
    // 2021/05/31 #11513 bug fixed by zy BEGIN
    totalRealAmountIncTax:0, // 画面すべて会計明細「表示・非表示」利用金額
    // 2021/05/31 #11513 bug fixed by zy END
    totalReqAmount:0,       // 請求金額
    totalReciveAmount:0,    // 預かり金額
    totalDiscountAmount:0,  // 値引き金額、
    totalNormalPayAmount:0, // 通常支払金額
    totalPayAmount:0,       //支払金額
    totalChargeAmount:0,    //お釣り金額
    // 2021/05/31 #11334 bug fixed by zy BEGIN
    payArr:[],
    // 2021/05/31 #11334 bug fixed by zy END
    lastProdId : '',
    lastIndex : 0,
    needAddRowFlg : false,
    currentRows : null,   // 該当明細部の行
    autoCheckFlg : false, // 請求書非表示機能制御対応 
    addRowsLength : 5, // 行追加数
    autoSaveLimit : 200,　// 自動保存数
    // 空行関連のデータ
    blankRow : {
        invoiceCheck : '',
        useDate : '',
        paymentImg : '',
        productNm : '',
        planshow : 'hidden',
        readonly : '',
        unitPrice : "",
        quantity : "",
        amoutIncTax : "",
        amoutExcTax : "",
        taxRate : "",
        serviceRate : "",
        specialTax : "",
        isplan : false
    },
    // 処理状態
    PROCESS_TYPE_UPD:"upd",
    PROCESS_TYPE_INS:"ins",
    PROCESS_TYPE_CLEAR:"clear",
    action:"",
    // 関数初期化
    initData:function(){
        this.lastProdId = '';
        this.lastIndex = 0;
        this.rowTemplate = $("#rowTemplate").text();
        this.autoCheckFlg = $("#hidCommNoShowRequestFlg").val() == "false";
        // 行追加
        var addRowLen = kendo.parseInt($("#hidTransRowInt").val());
        this.addRowsLength = addRowLen == null ? 5 : addRowLen;
        // 自動保存数
        var limitInt = kendo.parseInt($("#hidAutoSaveLimit").val());
        this.autoSaveLimit = limitInt == null ? 200 : limitInt;
    },
    // データ取得
    loadData:function(){
        // 2021/04/31 #10743 bug fixed by zy BEGIN
        if (!getErrorFlg() && !$(".message.errorM3").is(":visible")) {
        this.details = JSON.parse($("[id$=hidItemJsons]").val());
        } 
        // 2021/04/31 #10743 bug fixed by zy END
        var that = this;
        this.details.forEach(function(item,idx){
            if (!("get" in item)) {
                that.details[idx] = Object.assign(new ProdItem(), item);
                that.details[idx].convertSobj();
            }
        });
    },
    // noRenderFlg : 不刷新明细部节点
    // 明細部初期化
    init:function(noRenderFlg){
        if (noRenderFlg != true) {
            this.initData();
            this.loadData();
            this.resizeTable();
            this.render();
        } else {
            this.loadData();
        }
        // 処理行更新
        this.currentRows = $("table[name='tranDetailTable']>tbody>tr.tranDetailRow");
        this.refresh();
        if (noRenderFlg != true) {
            this.bindEvents();
            // 軽減税率機能対応
            setPlanBrkInfo();
            // 增税商品-自动设定
            autoSetTaxIncProductFun(CUST_AUTOGETPRODUCTMODE_INIT);
            consoleLog('增税商品 END');
        }
        consoleLog('init end');
    },
    // 元素機能BIND
    bindEvents:function(){
        consoleLog('kendoDraggable BEGIN');
        // Drop Acton
        $("[id$=tran1Table]").kendoDraggable({
            //2017/01/18 鼠标选中 行追加失效功能添加 by zy BEGIN
            filter:'.pointIndex:not(.disabled)',
            //2017/01/18 鼠标选中 行追加失效功能添加 by zy END
            hint: function(e) {
                var dragLeadElement = $(e).parents("tr.tranDetailRow");
                var hintTable = $("<table style='background:white;'/>");
                var tranTale = $("#tran1Table");
                hintTable.append(tranTale.find("colgroup").clone());
                hintTable.width(tranTale.width());
                return hintTable.append(dragLeadElement.clone());
            },
            dragstart: draggableOnDragStart,
            dragend: draggableOnDragEnd
        });
    },
    // 明細部 横幅刷新
    resizeTable:function(){
        var that = this;
        var contentDiv = $("#contentDiv");
        var contentWidth = $("table[name=totalTable]").width() - 20; // 40为tab组件需要的空白
        contentDiv.css("width",this.rowLength > 10 ? "calc(100% + 15px)" : "100%");
        var headTable = $("table[name=tranHeadTable]"),
            detailTable = $("table[name=tranDetailTable]"),
            colgroup = $(">colgroup",detailTable),
            headGroup = $(">colgroup",headTable);
        var colArr = [30,55,65,90,0,80,40,"7%","7.5%","6%","5%","5%"];
        var headArr = [85,65,90,0,80,40,"7%","7.5%","6%","5%","5%"];
        var sumWidth = 0;
        var autoIdx = -1;
        headTable.width(contentWidth);
        detailTable.width(contentWidth);
        colArr.forEach(function(item,idx){
            var parseInt = kendo.parseFloat(item,"p");
            if (parseInt != 0) {
                var wd;
                if (parseInt > 1 ) wd = parseInt;
                else if (parseInt > 0) wd = kendo.parseInt(contentWidth * parseInt);
                colgroup.eq(idx).width(wd);
                sumWidth += wd;
            } else {
                autoIdx = idx;
            }
        });
        if (autoIdx >= 0) {
            colgroup.eq(autoIdx).width(contentWidth - sumWidth);
        }
        headArr.forEach(function(item,idx){
            var parseInt = kendo.parseFloat(item,"p");
            if (parseInt != 0) {
                var wd;
                if (parseInt > 1 ) wd = parseInt;
                else if (parseInt > 0) wd = kendo.parseInt(contentWidth * parseInt);
                headGroup.eq(idx).width(wd);
            } else {
                headGroup.eq(idx).width(contentWidth - sumWidth);
            }
        });
    },
    getRowIndex:function(curRow){
        return this.currentRows.index(curRow);
    },
    getRowStr:function(trStr,blank,index,data){
        var invoiceCheck = blank.invoiceCheck,
            useDate = blank.useDate,
            paymentImg = blank.paymentImg,
            productNm = blank.productNm,
            planshow = blank.planshow,
            unitPrice = blank.unitPrice,
            quantity = blank.quantity,
            amoutIncTax = blank.amoutIncTax,
            amoutExcTax = blank.amoutExcTax,
            taxRate = blank.taxRate,
            serviceRate = blank.serviceRate,
            isplan = blank.isplan,
            readonly = blank.readonly,
            specialTax = blank.specialTax;
        if (data != undefined) {
            // 2021/06/31 #11196 bug fixed by zy BEGIN
            // 入湯税の自動設定機能対応
            if ( data.get('bathTaxAutoSetupFlg')){
                data = this.update(data);
            }
            // 2021/06/31 #11196 bug fixed by zy END
            invoiceCheck = data.get('InvoiceNoShowFlg__c') ? "checked='checked'" : "",
            useDate = data.get("UseDate__c"),
            // 2021/04/31 #10659 bug fixed by zy BEGIN
            useDate = (useDate == null || useDate == "" ) ? "" : kendo.toString(new Date(useDate),JINYACONNECT.DateFormat),
            // 2021/04/31 #10659 bug fixed by zy END
            productNm = data.get("productNm"),
            unitPrice = data.get('unitPrice'),
            quantity = data.get('quantity'),
            amoutIncTax = kendo.toString(data.get('amoutIncTax'),"c"),
            amoutExcTax = kendo.toString(data.get('amoutExcTax'),"c"),
            taxRate = kendo.toString(data.get('taxValLabel') ||0,"c"),
            serviceRate = (data.get('serviceLabel')||0) +'%',
            specialTax = kendo.toString(data.get('strSpecialTax') ||0,"c"),
            actionType = data.get('actionType'),
            paymentImg= data.getPaymentIcon();
            if (actionType == COMM_SET.ACTTYPE_PLAN) {
                planshow = "visibility";
                readonly = 'readonly="true"';
            }
        }
        var row = trStr.replace(/_index_/g,index).replace(/_invoicecheck_/g,invoiceCheck).replace(/_usedate_/g,useDate).replace(/_paymentImg_/g,paymentImg).replace(/_productNm_/g,productNm).replace(/_planshow_/g,planshow).replace(/_readonly_/g,readonly).replace(/_unitPrice_/g,unitPrice).replace(/_quantity_/g,quantity).replace(/_amoutIncTax_/g,amoutIncTax).replace(/_amoutExcTax_/g,amoutExcTax).replace(/_taxRate_/g,taxRate).replace(/_serviceRate_/g,serviceRate).replace(/_specialTax_/g,specialTax);
        return row;
    },
    // 明細部を表現する
    render:function(){
        var trStr = this.rowTemplate;
        var rowArr = [];
        var blank = this.blankRow;
        var rowLen = this.addRowsLength;
        if (this.details.length > rowLen) {
            rowLen = Math.ceil(this.details.length / rowLen) * rowLen;
        }
        // 2021/04/31 #10669 bug fixed by zy BEGIN
        if (rowLen == this.details.length) {
            rowLen += this.addRowsLength;
        }
        // 2021/04/31 #10669 bug fixed by zy END
        for (var i = 0 ; i < rowLen; i++) {
            var row = this.getRowStr(trStr,blank,i,this.details[i]);
            rowArr.push(row);
        }
        consoleLog('makerow');
        var tbody = $("#transDetailTableBody");
        tbody.html(rowArr.join(''));
        consoleLog('HTML end');
        var index = 0;
        if (this.details.length > 0) {
            index = this.details.length - 1;
        }
        tbody.find("tr.tranDetailRow [id$=productName]").eq(index).focus();
        consoleLog('renderRow');
    },
    // 新規行
    insert:function(prod){
        var idx = prod.index;
        var org = this.details[idx];
        // 新規
        this.details[idx] = new ProdItem();
        if (org != null && ("sobj" in org) && org.sobj.Id != "") {
            this.details[idx].sobj.Id = org.sobj.Id;
        }
        this.details[idx].index = idx;
        prod["isNoUpdate"] = false;
        this.details[idx].set(prod);
        this.computeAmoutPrice(this.details[idx],true);
        return this.details[idx];
    },
    // 変更行
    update:function(prod){
        var idx = prod.index;
        var org = this.details[idx];
        prod["orgAmoutIncTax"] = org.amoutIncTax;
        prod["orgAmoutExcTax"] = org.amoutExcTax;
        prod["orgInvoiceNoShowFlg"] = org.get('InvoiceNoShowFlg__c');
        prod["isNoUpdate"] = false;
        prod["orgActionType"] = org.get('ActionType__c');
        prod["orgPaymentType"] = org.get('PaymentType__c');
        // 明細更新
        this.details[idx].set(prod);
        prod = this.details[idx];
        // 非表示不是手动变更的情况下
        if (prod.checkValidata() && prod.get('autoSetInvoiceNoShowFlg')) {
            this.setupRowInvoiceStatus(prod);
        }
        this.computeAmoutPrice(prod,false);
        return this.details[idx];
    },
    // 削除行
    remove:function(idx){
        consoleLog('remove');
        this.action = this.PROCESS_TYPE_CLEAR;
        var item = this.get(idx);
        if (idx == this.lastIndex) {
            this.lastProdId = '';
        }
        if (item) {
            var prodId = item.get('productId');
            var clearObj = {
                    index : idx,
                    isNoUpdate:item.sobj.Id == null,
                    Field7__c:'',
                    Field20__c:'',
                    Field21__c:'',
                    productNm : '',
                    productId : '',
                    initPlanInfo : 0,
                    UseDate__c : null,
                    TaxRate__c: '',
                    ServiceRate__c: '',
                    serviceLabel : '',
                    InvoiceNoShowFlg__c : false,
                    paymentIconUrl:null,
                    amoutIncTax : 0,
                    tranId:'',
                    accRefId:'',
                    PlanDetailSyncInfo__c:'',
                    amoutExcTax : 0,
                    bTaxAccMstItem : '',
                    autoSetInvoiceNoShowFlg:true,
                    // 2021/04/31 #10655 bug fixed by zy BEGIN
                    SpecialTax__c:0,
                    // 2021/04/31 #10655 bug fixed by zy END
            }
            var prod = this.update(clearObj);
            // TODO 宿泊税計算 WGCH BEGIN
            this.proBathTaxRowFun(prod);
            // 2021/05/31 #11161 bug fixed by zy BEGIN
            // 2021/05/31 #11504 bug fixed by zy BEGIN
            this.refresh([prod],prod.isPayMentType());
            // 2021/05/31 #11504 bug fixed by zy END
            // 2021/05/31 #11161 bug fixed by zy END
            // 2016/02/25 Log Output BEGIN
            var logLine = "DEL," + (1*item.index + 1) + ',' + Date.now();
            logger.push(logLine);
            // 2016/02/25 Log Output END
        }
    },
    // 保存前
    beforeSave:function(){
        // 実際のインデックス刷新
        this.refreshIndex();
        var valids = this.details.filter(function(item){
            // 支付明细每次保存
            // 2021/04/31 #10743 bug fixed by zy BEGIN
            // 传入变更行，金额有效行，支付行
            return item != null && (!item.isNoUpdate || item.checkValidata() || item.get('actionType') == COMM_SET.ACTTYPE_PAY);
            // 2021/04/31 #10743 bug fixed by zy END
            
        });
        var changeItems = [];
        // 2021/04/31 #10743 bug fixed by zy BEGIN
        // 2021/04/31 #10644 bug fixed by zy BEGIN
        var _hotelTax = getHotelTaxInfoFun(),t = this; // 获取カスタムメタデータ型:宿泊税定义信息
        // 2021/04/31 #10644 bug fixed by zy END
        valids.forEach(function(item){
            var chgItem = Object.assign(new ProdItem(), item);
            var useDt = chgItem.get('UseDate__c');
            if (useDt != '') {
                useDt = kendo.toString(new Date(useDt),'yyyy-MM-dd');
                chgItem.set({UseDate__c:useDt,tranUseDate:useDt});
            }
            // 未変更のデータ
            if (item.isNoUpdate) {
                // INNER対象変更
                chgItem = { sobj:item.sobj,
                            isNoUpdate : item.isNoUpdate,
                            isEstItemFlg : false,
                            tranId : item.tranId,
                            amoutIncTax : item.amoutIncTax,
                            usedAmount : item.usedAmount,
                            changeAmout : item.changeAmout,
                            // 2021/04/31 #10820 bug fixed by zy BEGIN
                            bathTaxAutoSetupFlg : item.bathTaxAutoSetupFlg,
                            // 2021/04/31 #10820 bug fixed by zy END
                         };
            } else {
                if (chgItem.unitPrice == "") {
                    chgItem.unitPrice = 0;
                }
                // 后台保存不相关数据，但是影响转JSON
                chgItem.bTaxAccMstItem = "";
            }
            // 2021/04/31 #10644 bug fixed by zy BEGIN
            if (isReducedTaxFlg) {
                var ACTTYPE_PLAN = COMM_SET.ACTTYPE_PLAN;
                var planBrkInfo = item.get('planBrkInfo');
                if (ACTTYPE_PLAN == item.get('ActionType__c')) {
                    if(_hotelTax.planBrkToHeaderCalFlg){
                        var planKey = t.getPlanKeyFun(item.index);
                        var _row = t.getRowInfoFun(item); // 获取当前PLAN行数据集
                        // 2021/07/15 #12910 bug fixed by zy BEGIN
                        var _data = commUtils.getPlanResInfoFun(item.planItemLst, _row, _hotelTax, isReducedTaxFlg);
                        // 2021/07/15 #12910 bug fixed by zy END
                        chgItem.itemDataArr = _data.itemDataArr;
                    } else {
                        chgItem.planBrkInfo = planBrkInfo;
                    }
                }
            }
            // 2021/04/31 #10644 bug fixed by zy END
            changeItems.push(chgItem);
        });
        // 2021/04/31 #10743 bug fixed by zy END
        consoleLog(changeItems);
        $("[id$=hidItemJsons]").val(JSON.stringify(changeItems));
    },
    // 根据index取得明細行の情報
    get:function(idx){
        // 内部データなし
        if (this.details == undefined) return null;
        // 数字タイプ書式設定
        idx = kendo.parseInt(idx);
        // 非数字対応
        if (idx == null) return this.details;
        // 該当インデックスが内部リストの長さを超出する
        // 2021/07/15 #13486 bug fixed by zy BEGIN
        if (idx >= this.details.length) {
        // 2021/07/15 #13486 bug fixed by zy END
            // 内部リストの長さの超出部分を充填する
            for (var i = this.details.length - 1 ; i < idx ; i++) {
                // 空欄を充填する
                this.details.push(new ProdItem());
            }
        }
        // 取得情報
        var item = null;
        //　インデックスに内部リスト中のデータ
        if (idx in this.details) item = this.details[idx];
        //　該当インデックスは内部リストに存在しません
        else return null;
        // 初期化チェック
        if (!("set" in item)) {
            // 新対象を作成する
            item = this.details[idx] = Object.assign(new ProdItem(), item);
        }
        // 正しいインデックス保持
        if (item.index != idx) {
            item.set("index",idx);
        }
        return item;
    },
    filter:function(name,value){
        return this.details.filter(function(item){
            return item.get(name) == value;
        });
    },
    // 取得内容非保存
    getNextIdx:function(){
        var index = this.getBlankDataIdx();
        if (index < 0) {
            index = this.details.length;
        }
        return index;
    },
    // 取得内容保存
    getNextIndex:function(prodId,skipFlag){
        if (this.lastProdId != prodId || !skipFlag) {
            // 上次商品保持
            if (prodId != undefined) {
                this.lastProdId = prodId;
            }
            this.lastIndex = this.getNextIdx();
            return false;
        }
        return true;
    },
    getBlankDataIdx:function(){
        var index = -1,that = this;
        for (var i = 0 ; i < this.details.length ; i++) {
            var item = this.details[i];
            // 無効の行をチェックする
            if (item == undefined || !item.checkValidata()) {
                index = i;
                break;
            }
        }
        return index;
    },
    computeValidData:function(){
        var that = this;
        return this.details.filter(function(item,idx){
            return item.checkValidata();
        });
    },
    // 内容刷新
    refresh:function(prods,totalComputeFlag){
        var rows = this.currentRows;
        // 行追加 
        if (rows.length <= this.lastIndex) {
            // 行追加
            this.addRows();
        }
        if (prods != undefined) {
            if (totalComputeFlag != true) {
                var res = this.computeRowChgAmount(prods);
                this.setTotalAmount(res);
            }
            this.renderRow(prods);
        } else  {
            totalComputeFlag = true;
        }
        if (totalComputeFlag){
            this.computeTotalAmount();
            consoleLog('金額計算 END');
        }
        // 总金額DOM设定
        this.renderAmount();
    },
    //　チェック変更明細が限定を超えて
    checkAutoSave:function(){
        // 有効な明細と変更の明細をフィルターする
        var valids = this.details.filter(function(item){
            return item != null && !item.isNoUpdate;
        });
        // 有効な明細と変更の明細
        if (valids.length >= this.autoSaveLimit) {
             // 非空数据判断
            if (checkRequired()) {
                $("#inputFormErrorMsg").show();
                $(window).scrollTop(0);
                return false;
            }
            this.beforeSave();
            var message = getAutoSaveMessage();
            printBlockUI(message);
            upsertTempDataFunction();
        }
    },
    // 行内容設定（DOM操作）
    renderRow:function(prods){
        var t = this;
        prods.forEach(function(prod){
            var row = t.currentRows.eq(prod.index);
            // 行内操作DOM取得
            var rowElement = t.getRowDom(row);
            // 指定内容設定
            rowElement.prodInput.val(prod.get('productNm'));
            rowElement.priceInput.val(prod.get('unitPrice'));
            rowElement.numInput.val(prod.get('Field21__c'));
            if (prod.get("UseDate__c") == "") {
                rowElement.useDateInput.val(prod.get("UseDate__c"));
            } else {
                rowElement.useDateInput.val(kendo.toString(new Date(prod.get("UseDate__c")),JINYACONNECT.DateFormat));
            }
            var isValidata = prod.checkValidata();
            rowElement.specialTaxInput.val(isValidata ? prod.get('strSpecialTax') : "");
            rowElement.taxRateTypeSpan.text(isValidata ? kendo.toString(prod.get('taxValLabel') ||0,"c") : "");
            rowElement.serviceRateSpan.text(isValidata ? ((prod.get('serviceLabel')|| 0) + '%') : "");
           
            // 金額対応
            var amountInc = prod.get('amoutIncTax'),
                amountIncStr = (!isValidata || amountInc === "" || amountInc == null) ? "" : kendo.toString(amountInc,"c"),
                amoutExc = prod.get('amoutExcTax'),
                amoutExcStr = (!isValidata || amoutExc === "" || amoutExc == null) ? "" : kendo.toString(amoutExc,"c"),
                paymentUrl = !isValidata ? "" : prod.getPaymentIcon();
            rowElement.amountIncSpan.text(amountIncStr);// 金額（税込み）
            rowElement.amountExcSpan.text(amoutExcStr);// 金額（税抜き） 
            // 該当行目に商品コードにより、アイコン設定をを行う
            rowElement.paymentIconSpan.html(paymentUrl);
            // プラン設定の切り替え
            // 展開imgの表示・非表示を制御する
            if (t.action == t.PROCESS_TYPE_INS || t.action == t.PROCESS_TYPE_CLEAR) {
                t.dispExtendImg(prod,rowElement);
            }
            rowElement.InvoiceNoShowChkbox.prop('checked',(prod.get('InvoiceNoShowFlg__c') ? 'checked' : false));
            // プランの単価入力制御
            t.switchPriceStatus(rowElement);
            consoleLog('プラン設定の切り替え end');
        });
    },
    // 行内操作DOM取得
    getRowDom:function(row){
        return {
            row:row,
            prodInput:$("input:text[id$=':productName']",row),
            priceInput : $("input:text[id$=':price']",row),
            numInput : $("input:text[id$=':orderNums']",row),
            useDateInput : $("input:text[id$=':useDate']",row),
            specialTaxInput : $("input:text[id$=':specialTax']",row),
            taxRateTypeSpan : $("span[id$=':taxRateType']",row),
            serviceRateSpan : $("span[id$=':serviceRate']",row),
            InvoiceNoShowChkbox : $("input:checkbox[id$='InvoiceNoShowFlg']",row),
            amountIncSpan : $("span[id$=':amoutPriceIncTax']",row),
            amountExcSpan : $("span[id$=':amoutPriceExcTax']",row),
            planExpandImg : $("[id^='showDetailEvent']",row),
            paymentIconSpan : $("span[id$=icon_span]",row),
        }
    },
    // プランの単価入力制御
    switchPriceStatus:function(rowElement){
        var detailEvent = rowElement.planExpandImg;
        if (detailEvent.css("visibility") == "hidden") {
            rowElement.priceInput.attr('readonly', false).css('background-color', '');
        } else {
            rowElement.priceInput.attr('readonly', true).css('background-color', '#DCDCDC');
        }
    },
    // 展開imgの表示・非表示を制御する
    dispExtendImg:function(prod,rowElement){
        var actionType = prod.get('actionType'),
            ACTTYPE_PLAN = COMM_SET.ACTTYPE_PLAN;
        // プラン設定の切り替え
        if(actionType == ACTTYPE_PLAN && prod.checkValidata()){
            rowElement.planExpandImg.attr("style", "cursor: pointer;display: true; width: 18px; height: 18px; visibility:visible");
        } else {
            rowElement.planExpandImg.attr("style", "cursor: pointer;display: true; width: 18px; height: 18px; visibility:hidden");
        }
        if (rowElement.planExpandImg.attr("openStatus") == "true"){
            rowElement.planExpandImg.attr("src","{!URLFOR($Resource.AppImages, 'extend/jiahao.png')}")
                        .attr("openStatus","false")
                        //展開
                        .attr("title","{!$Label.MSG_006_0214}")
                        .parents("tr .tranDetailRow").next().remove();
        }
    },
    // 总金額DOM设定
    renderAmount:function(){
        $("#totalAmountExcTax").val(this.totalAmountExcTax);
        $("#usedAmountBlock").text(kendo.toString(this.totalAmountIncTax, "c"));// 利用金額
        $("#reqAmountBlock").text(kendo.toString(this.totalReciveAmount, "c"));// 請求金額
        // 手動で入金確認の場合
        var isAccountPaidFlg = "{!isAccountPaidFlg}";
        var handRquestFlg = $("input[id$=':inp_handReq_paymentFlg']").val(); 
        // 手動で入金確認の場合
        if (isAccountPaidFlg == "true" && handRquestFlg != "1" && (this.totalAmountIncTax != 0 || this.totalReciveAmount != 0)) {
            $payFlg = $("input[id$=':inp_paymentFlg']");
            $payDate = $("input[id$=':inp_receiptDate']");
            if (this.totalReciveAmount == 0) {
                if ($payFlg.length > 0) {
                    $payFlg.prop('checked',true);
                }
                if ($payDate.length > 0) {
                    $payDate.val(kendo.toString(new Date(), JINYACONNECT.DateFormat));
                }
            }
            else {
                if ($payFlg.length > 0) {
                    $payFlg.prop('checked',false);
                }
                if ($payDate.length > 0) {
                    $payDate.val("");
                }
            }
        }
    },
    // isFromCallBackFun = 0时 是按照请求金计算,还是按照全部金额计算
    computeAmoutPrice:function(prod,isFromCallBackFun){
        // PLAN明细数据更新处理
        this.updatePlanItemMapFun(prod);
        var hidPlandetail = prod.get('initPlanInfo'), // プラン明細課税、非課税混在合計金額計算対応
            invoiceCheck = prod.get('InvoiceNoShowFlg__c'),
            unitPrice = kendo.parseFloat(prod.get('Field20__c')) || 0,
            // 消費税率
            tax = kendo.parseFloat(prod.get('TaxRate__c')) || 0,
            // サビース料率
            service = kendo.parseFloat(prod.get('ServiceRate__c')) || 0,
            // 数量
            nums = kendo.parseFloat(prod.get("Field21__c")) || 0,
            // 特別税
            numSepcTax = kendo.parseFloat(prod.get("SpecialTax__c")) || 0,
            // 単価定義区分
            unitPriceKbn = prod.get("UnitPriceDefKbCal__c") || "",
            // 関連金額を計算する
            amountIncTax,amountExcTax,
            rowIndex = prod.index,
            res,
            // 支払情報の場合、単価は自動残りの請求金額で設定を行う
            actionType = prod.get('actionType'),
            ACTTYPE_AR = COMM_SET.ACTTYPE_AR,
            ACTTYPE_PLAN = COMM_SET.ACTTYPE_PLAN,
            ACTTYPE_PAY = COMM_SET.ACTTYPE_PAY;
        if(hidPlandetail > 0 ) {
            var unitPriceIncTax = commUtils.mathNumSub(unitPrice, hidPlandetail);
            res = JINYACONNECT.PRODUCT.PROCESS(unitPriceIncTax, nums, tax, service, unitPriceKbn);
            var resPriceIncTax = res.priceIncTax;
            var resPriceExcTax = res.priceExcTax;
            var resExc = JINYACONNECT.PRODUCT.PROCESS(hidPlandetail, nums, 0, service, unitPriceKbn);
            amountIncTax = commUtils.mathNumAdd(resPriceIncTax , resExc.priceIncTax );
            amountIncTax = commUtils.mathNumAdd(amountIncTax, numSepcTax);
            amountExcTax = resPriceExcTax + resExc.priceExcTax;
            // 2019/07/30 軽減税率機能対応 WGCH BEGIN
            if(isReducedTaxFlg){
                // 获取最新的数据集合
                var resInfo = this.getResInfoFun(prod, res);
                // 重置RES
                res = resInfo.res;
                // 重置合計金額
                amountIncTax = res.priceIncTax;
                // 重置合計金額(税抜)
                amountExcTax = res.priceExcTax;
                // 重置特别税
                numSepcTax = resInfo.numSepcTax;
                // 重置合計金額
                amountIncTax = commUtils.mathNumAdd(amountIncTax, numSepcTax);
            }
            // 2019/07/30 軽減税率機能対応 WGCH END
        } else {
            res = JINYACONNECT.PRODUCT.PROCESS(unitPrice, nums, tax, service, unitPriceKbn);
            // 2019/07/30 軽減税率機能対応 WGCH BEGIN
            if(isReducedTaxFlg){
                // 获取最新的数据集合
                var resInfo = this.getResInfoFun(prod, res, unitPrice, nums, tax, service, numSepcTax, unitPriceKbn);
                // 重置RES
                res = resInfo.res;
                // 重置特别税
                numSepcTax = resInfo.numSepcTax;
            }
            // 2019/07/30 軽減税率機能対応 WGCH END
            // 合計金額計算を行う
            amountIncTax = commUtils.mathNumAdd(res.priceIncTax , numSepcTax);
            amountExcTax = res.priceExcTax;
        }
        // 2015/10/16 プラン明細課税、非課税混在合計金額計算対応 END
        // 支払情報の場合、単価は自動残りの請求金額で設定を行う商品処理種別
        if (actionType == ACTTYPE_AR || actionType == ACTTYPE_PAY) {
            // 支払種別は「COPON】の場合、クーポン利用の返金「manasCoponFlg」を選べる場合、支払金額はマイナス計算を行う
            // 支払情報は０の場合、元の支払金額+残り金額で自動設定を行う
            // 残りの請求金額から設定する
            if (amountIncTax == 0 && isFromCallBackFun) {
                // 残りの請求金額から設定する
                var reqAmount = this.totalReciveAmount;
                var payAmount = kendo.parseFloat(reqAmount);
                //2017/03/17 お釣りプリンター機能　by zy BEGIN
                payAmount = changeAmount(payAmount);
                //2017/03/17 お釣りプリンター機能　by zy END
                // 該当メデイアに支払金額が存在する場合、自動設定を行わない
                var orgPayAmount = kendo.parseFloat(prod.get('amoutIncTax'));
                // 2015/11/03 BugFix BEGIN
                var payType = prod.get('PaymentType__c');
                // 2015/11/03 BugFix END
                // 未請求金額はマナスの場合、現在の金額はそのまま
                if (payAmount <= 0) {
                    if(!isRefundItem(payType))
                        payAmount = orgPayAmount;
                    else
                        payAmount = Math.abs(payAmount);
                } else {
                    // 未支払金額が存在する場合、元の支払金額は０の場合、自動全額を支払
                    // 既に金額が存在する場合、そのまま
                    if (orgPayAmount != null && orgPayAmount > 0) {
                        payAmount = orgPayAmount;
                    }else if(isRefundItem(payType)){
                        payAmount = orgPayAmount;
                    }
                }
                var _loctotalPayed = payAmount;
                if (_loctotalPayed == null) _loctotalPayed = 0;
                prod.set('Field20__c',_loctotalPayed);
                prod.set('Field21__c',1);
                amountIncTax = amountExcTax = _loctotalPayed;
            }
        }
        // TODO 宿泊税計算,軽減税率機能対応
        if(!isReducedTaxFlg){
            if(!specialTaxFlg){
                if(actionType == _CONST_PRICE_ROOM_TYPE && hotelData.hotelTaxDefInstance[COMM_SET.SHOP_CODE] != undefined){
                    res = JINYACONNECT.PRODUCT.PROCESS(unitPrice, nums, tax, service, unitPriceKbn);
                    var newNumSepcTax = commUtils.mathNumMulti(commUtils.getHotelTaxFun(res.unitPriceIncServiceExcTax, hotelData.hotelTaxDefInstance[COMM_SET.SHOP_CODE]), nums);
                    prod.set("SpecialTax__c",newNumSepcTax);
                    amountIncTax = commUtils.mathNumAdd(commUtils.mathNumSub(amountIncTax, numSepcTax), newNumSepcTax);
                } else if(actionType == ACTTYPE_PLAN && hotelData.hotelTaxDefInstance[COMM_SET.SHOP_CODE] != undefined){
                    var planItemPriceLst = [], newNumSepcTax = 0;
                    // 判断plan是否展开过
                    var _PlanBrkDn = $("input[parentindex='" + rowIndex + "']");
                    if(_PlanBrkDn.length == 0){ // Plan未展开的情况
                        if(!planItemPriceMap.get(this.getPlanKeyFun(rowIndex))){
                            var pTranId = prod.get('tranId');
                            planItemPriceLst = hotelData.planItemPriceMap[pTranId];
                        } else planItemPriceLst = planItemPriceMap.get(this.getPlanKeyFun(rowIndex));
                        planItemPriceLst = planItemPriceLst ? planItemPriceLst : [];
                        for(var i = 0; i < planItemPriceLst.length; i++){
                            var planRes = JINYACONNECT.PRODUCT.PROCESS(planItemPriceLst[i] * 1, 1, tax, service, unitPriceKbn);
                            newNumSepcTax = commUtils.mathNumAdd(newNumSepcTax, commUtils.mathNumMulti(commUtils.getHotelTaxFun(planRes.unitPriceIncServiceExcTax, hotelData.hotelTaxDefInstance[COMM_SET.SHOP_CODE]), nums));
                        }
                    } else { // Plan展开的情况
                        var childcls = "showDetailEvent" + rowIndex + "_child";
                        $("[class='"+ childcls +"'][data-actiontype = '" + _CONST_PRICE_ROOM_TYPE + "']").each(function(){
                            var price = $(this).val().replaceAll(",","");
                            if(price == "" || !price || isNaN(parseFloat(price)) ) price = 0;
                            planItemPriceLst.push(price);
                            var planRes = JINYACONNECT.PRODUCT.PROCESS(price, 1, tax, service, unitPriceKbn)
                            newNumSepcTax = commUtils.mathNumAdd(newNumSepcTax, commUtils.mathNumMulti(commUtils.getHotelTaxFun(planRes.unitPriceIncServiceExcTax, hotelData.hotelTaxDefInstance[COMM_SET.SHOP_CODE]), nums));
                        });
                        planItemPriceMap.set(this.getPlanKeyFun(rowIndex), planItemPriceLst);
                    }
                    prod.set("SpecialTax__c",newNumSepcTax);
                    amountIncTax = commUtils.mathNumAdd(commUtils.mathNumSub(amountIncTax, numSepcTax), newNumSepcTax);
                }
            }
            specialTaxFlg = false;
        }
        if (!_CONST_SETAMOUNTFLG && prod.get('InvoiceNoShowFlg__c') && _CONST_NOSETAMOUNTFLG) {
            amountIncTax = 0;
        }
        var setObj = {amoutExcTax:amountExcTax,amoutIncTax:amountIncTax,Field23__c:amountIncTax,GoukeinoneTax__c:amountExcTax};
        prod.set(setObj);
        // 2019/07/30 軽減税率機能対応 WGCH BEGIN
        if(isReducedTaxFlg){
            var amountExcTaxEnd = kendo.parseFloat(amountExcTax);
            if(amountExcTaxEnd == null) amountExcTaxEnd = 0;
            var priceExcTax = 0;
            if(nums != 0) priceExcTax = amountExcTaxEnd/nums;
            // 金額（单价税抜き）
            prod.set('TankanonetaxNew__c',priceExcTax);
        } else {
            // 2019/11/11 BUGFIEX修正 WGCH BEGIN
            var tankanonetaxNewVal = kendo.parseFloat(prod.get('TankanonetaxNew__c'));
            // 2019/11/11 BUGFIEX修正 WGCH END
            if(tankanonetaxNewVal == null) tankanonetaxNewVal = 0;
            // 金額（单价税抜き）
            if(tankanonetaxNewVal != 0) prod.set('TankanonetaxNew__c',0); 
        }
    },
    // PLAN明细数据更新处理
    updatePlanItemMapFun:function(prod){
        var _row = this.getRowInfoFun(prod); // 获取当前PLAN行数据集
        if(_row.actionType != ACTTYPE_PLAN) return;
        var rowIndex = prod.index;
        // 2021/07/15 #12910 bug fixed by zy BEGIN
        // 当前PLAN明细ARR
        var _planItemLst= prod.planItemLst;
        // 2021/07/15 #12910 bug fixed by zy END
        if(commUtils.isUndefined(_planItemLst)) return;
        var wkLen = _planItemLst.length; // PLAN明细数量
        if(wkLen == 0) return;
        // 最新的当前PLAN明细ARR
        var newPlanItemLst = new Array();
        // 变更的当前行会計商品ID
        var planBrkInfo = "";
        for(var i = 0; i < wkLen; i++){
            // 当前明细数据集
            var _data, // 当前行的数据集
                _pd = $j.extend(true, {}, _planItemLst[i]);
            // 当前明细的会計商品ID「最新的防止变更会计商品，不能直接用_pd.productId」
            // 当前明细的会計商品ID「最新的防止变更会计商品，不能直接用_pd.productId」
            var $productId = $j("#"+rowIndex+"_prodid_"+i);
            if($productId.length > 0){
                productId = $productId.val();
                // 单价
                var unitPrice = kendo.parseFloat($j("#"+rowIndex+"_prodPrice_"+i).val());
                if(unitPrice == null) unitPrice = 0;
                // 消费税
                var tax = kendo.parseFloat($j("#"+rowIndex+"_workHidTaxRate_"+i).val());
                if(tax == null) tax = 0;
                // サビース料
                var serviceRate = kendo.parseFloat($j("#"+rowIndex+"_workHidServiceTaxRate_"+i).val());
                if(serviceRate == null) serviceRate = 0;
                // 商品処理種別
                var actionType = $j("#"+rowIndex+"_workHidActType_"+i).val();
                // 当前行设置最新的数据集
                _data = commUtils.setData(_row.rowIndex, unitPrice, tax, serviceRate, _row.nums, _pd.specialTax, _row.unitPriceKbn, productId, actionType, true);
            } else{
                _data = commUtils.setData(_row.rowIndex, _pd.unitPrice, _pd.tax, _pd.serviceRate, _row.nums, _pd.specialTax, _row.unitPriceKbn, _pd.productId, _pd.actionType, true);
            }
            // PUSH最新的数据集
            newPlanItemLst.push(_data);
            // 2019/10/08 メディア毎消費税額修正对应 WGCH BEGIN
            // PlanBrkInfo=> 単価 : 消費税 : サービス料 : 数量 : 特別税 : 会計商品単価定義区分 : 会計商品Id : 商品処理種別;
            planBrkInfo += _data.unitPrice + ':' + _data.tax + ':' + _data.serviceRate + ':' + _data.nums + ':' + _data.specialTax + ':' + _data.unitPriceKbn + ':' + _data.productId + ':' + _data.actionType + ';';
            // 2019/10/08 メディア毎消費税額修正对应 WGCH END
        }
        // 2019/10/08 メディア毎消費税額修正对应 WGCH BEGIN
        prod.set('planBrkInfo',planBrkInfo);
        // 2019/10/08 メディア毎消費税額修正对应 WGCH END
        // 2021/07/15 #12910 bug fixed by zy BEGIN
        // 更新最新的PLAN明细数据集
        prod.set('planItemLst',newPlanItemLst);
        // 2021/07/15 #12910 bug fixed by zy END
    },
    // 初期重置RES处理
    getResInfoFun:function(prod,res){
        var hasNumSepcTaxSum = 0, // 合計金額(税抜) 列 含有的宿泊税
            newNumSepcTaxSum = 0, // 特別税        列 显示的宿泊税
            _newRes = $j.extend(true, {}, res), // 防止地址共存
            _row = this.getRowInfoFun(prod), // 获取当前行数据集
            _hotelTax = getHotelTaxInfoFun(); // 获取カスタムメタデータ型:宿泊税定义信息
        // 2019/10/30 一扣非表示性能优化处理修正 WGCH BEGIN
        // 2020/01/30 非表示の一括解除、あるいは金額を0円にしない非表示設定の追加 WGCH BEGIN
        // if(_row.invoiceNoShow) return {
        if(!_CONST_SETAMOUNTFLG && _row.invoiceNoShow) return {
        // 2020/01/30 非表示の一括解除、あるいは金額を0円にしない非表示設定の追加 WGCH END
            res : _newRes,
            numSepcTax : _row.specialTax
        };
        // 2019/10/30 一扣非表示性能优化处理修正 WGCH END
        // 宿泊税有效, 处理种别是室料
        if(_hotelTax.isEffectiveFlg && _row.actionType == _CONST_PRICE_ROOM_TYPE){
            // 获取宿泊税计算后数据集
            var _res = commUtils.getSepcTaxInfoFun(res, _row, _hotelTax.data);
            _newRes = _res.res; // 最终的RES「置换」
            hasNumSepcTaxSum = _res.hasNumSepcTaxSum; // 合計金額(税抜) 列 含有的宿泊税「赋值」
            newNumSepcTaxSum = _res.newNumSepcTaxSum; // 特別税        列 显示的宿泊税「赋值」
        // 处理种别是PLAN
        } else if(_row.actionType == ACTTYPE_PLAN){
            // 2021/07/15 #12910 bug fixed by zy BEGIN
            var _data = commUtils.getPlanResInfoFun(prod.planItemLst, _row, _hotelTax, isReducedTaxFlg);
            // 2021/07/15 #12910 bug fixed by zy END
            // TODO: 目前之后处理只用的这里个变量「只置换了这两个变量」* 进来了就说明功能已经打开的
            _newRes.priceIncTax = _data.priceIncTaxSum; // 最新值设定「合計金額」
            _newRes.priceExcTax = _data.priceExcTaxSum; // 最新值设定「合計金額(税抜)」
            hasNumSepcTaxSum = _data.hasNumSepcTaxSum; // 合計金額(税抜) 列 含有的宿泊税「赋值」
            newNumSepcTaxSum = _data.newNumSepcTaxSum; // 特別税        列 显示的宿泊税「赋值」
        }
        // 设置特别税列数据
        if(!specialTaxFlg && _hotelTax.isEffectiveFlg){
            // 宿泊税は０の場合、空白に設定を行う
            prod.set('SpecialTax__c',newNumSepcTaxSum);
            _row.specialTax = newNumSepcTaxSum; // 最新的特别税「赋值」
        }
        specialTaxFlg = false;
        return {
            res : _newRes,
            numSepcTax : _row.specialTax
        };
    },
    // 获取当前行数据集
    getRowInfoFun:function(prod){
        // プラン明細課税、非課税混在合計金額計算
        var hidPlandetail = prod.get('initPlanInfo'),
            // 单价
            unitPrice = kendo.parseFloat(prod.get('Field20__c')) || 0,
            // 消費税率
            tax = kendo.parseFloat(prod.get('TaxRate__c')) || 0,
            // サビース料率
            service = kendo.parseFloat(prod.get('ServiceRate__c')) || 0,
            // 数量
            nums = kendo.parseFloat(prod.get("Field21__c")) || 0,
            // 特別税
            numSepcTax = kendo.parseFloat(prod.get("SpecialTax__c")) || 0,
            // 単価定義区分
            unitPriceKbn = prod.get("UnitPriceDefKbCal__c") || "",
            // 金額（税込み） 
            amoutPriceIncTax = kendo.parseFloat(prod.get('amoutIncTax')) || 0,
            // 金額（税抜き）
            amountExcTax = kendo.parseFloat(prod.get('amoutExcTax')) || 0,
            rowIndex = prod.index,
            // 商品処理種別
            actionType = prod.get('actionType'),
            // 支付種別
            payType = prod.get('PaymentType__c'),
            // 商品ID
            productId = prod.get('productId'),
            invoiceNoShow = prod.get('InvoiceNoShowFlg__c');
        return commUtils.setData(rowIndex, unitPrice, tax, service, nums, numSepcTax, unitPriceKbn, productId, actionType, payType, false, hidPlandetail, amountExcTax, amoutPriceIncTax, invoiceNoShow);
    },
    computeProdsAmount:function(prods,orgFlag,gRemaindPayMoney){
        // 利用金額
        var totalUsed = 0,
            totalPayed = 0,     // 支払金額
            discountPayArr = [],// 値引きの支払情報格納行
            coponPayArr = [],// Coponの支払情報格納行
            normalPayArr = [],// 普通の支払情報
            totalAmountExcTax = 0,
            gtotalUsed = 0,
            gtotalAmountExcTax = 0,
            amountIncName = orgFlag ? 'orgAmoutIncTax' : 'amoutIncTax',
            amountExcName = orgFlag ? 'orgAmoutExcTax' : 'amoutExcTax',
            invoiceFlgName = orgFlag ? 'orgInvoiceNoShowFlg' : 'InvoiceNoShowFlg__c',
            actionTypeName = orgFlag ? 'orgActionType' : 'actionType',
            paymentTypeName = orgFlag ? 'orgPaymentType' : 'PaymentType__c',
            ACTTYPE_AR = COMM_SET.ACTTYPE_AR,
            ACTTYPE_PAY = COMM_SET.ACTTYPE_PAY,
            MEDIA_TYPE_COPON = COMM_SET.MEDIA_TYPE_COPON,
            MEDIA_TYPE_DISCOUNT = COMM_SET.MEDIA_TYPE_DISCOUNT;
        // 2021/05/31 #11334 bug fixed by zy BEGIN
        // 单独行差额计算用利用金额
        if (gRemaindPayMoney != undefined) {
            gtotalUsed = totalUsed = gRemaindPayMoney;
        }
        // 2021/05/31 #11334 bug fixed by zy END
        // 全て有効な利用金額を集計を行う
        prods.forEach(function(prod,idx){
            var actionType = prod.get(actionTypeName), // 商品処理種別
                payType = prod.get(paymentTypeName), // 支払種別
                amoutIncTax = prod.get(amountIncName), // 金額（税込み)
                amoutExcTax = prod.get(amountExcName), // 金額（税抜き）
                invoiceNoShow = prod.get(invoiceFlgName);
            // 支払情報
            if (actionType == ACTTYPE_AR || actionType == ACTTYPE_PAY) {
                // 商品処理種別は「支払」の場合
                if (actionType == ACTTYPE_PAY) {
                    var payMediaLabel = getPayMeidaLabel(payType);
                    if (payMediaLabel == MEDIA_TYPE_DISCOUNT) {
                        discountPayArr.push(prod);
                    } else if (payMediaLabel == MEDIA_TYPE_COPON) {
                        coponPayArr.push(prod);
                    } else {
                        // 値引き、クーポン支払情報以外の場合
                        normalPayArr.push(prod);
                    }
                } else {
                    // 前受付金の場合
                    normalPayArr.push(prod);
                }
                if(_CONST_SETAMOUNTFLG && invoiceNoShow){
                    // 金額
                    // 返金の場合、入力の金額は減算を行う
                    if (isRefundItem(payType)) amoutIncTax = - amoutIncTax;
                    totalPayed = commUtils.mathNumSub(totalPayed, amoutIncTax);
                }
                // 2021/05/31 #11334 bug fixed by zy BEGIN
                if (gRemaindPayMoney == undefined) {
                    J_ACCOUNT_CENTER.payArr.push(prod);
                }
                // 2021/05/31 #11334 bug fixed by zy END
            } else {
                // 請求書非表示する場合、利用金額は集計対象外
                if (!invoiceNoShow|| (!_CONST_SETAMOUNTFLG && !_CONST_NOSETAMOUNTFLG) || _CONST_SETAMOUNTFLG) {
                    // 非表示の一括解除、あるいは金額を0円にしない非表示設定の追加
                    totalAmountExcTax = commUtils.mathNumAdd(totalAmountExcTax, amoutExcTax);
                    totalUsed = commUtils.mathNumAdd(totalUsed, amoutIncTax);
                }
                // 2020/04/30 非表示BUGFIX WGCH BEGIN
                if (!invoiceNoShow && _CONST_SETAMOUNTFLG) {
                    gtotalAmountExcTax = commUtils.mathNumAdd(gtotalAmountExcTax, amoutExcTax);
                    gtotalUsed = commUtils.mathNumAdd(gtotalUsed, amoutIncTax);
                }
            }
        });
        consoleLog(' 全て有効な利用金額を集計を行う');
        // 利用総金額
        var remaindPayMoney = totalUsed;
        // 値引き支払情報存在する場合
        discountPayArr.forEach(function(prod){
            // 支払金額残り場合 if (remaindPayMoney > 0) {
            // 預かり金額
            // 2021/05/31 #11334 bug fixed by zy BEGIN
            var recivePrice = prod.get('amoutIncTax');
            // 2021/05/31 #11334 bug fixed by zy END
            // 該当行値引き金額は全体支払
            if (remaindPayMoney >= recivePrice) {
                totalPayed = commUtils.mathNumAdd(totalPayed, recivePrice);
                // 預かり金額：値引き金額、支払金額：値引き金額、お釣り金額：０円（値引き返金なし）
                prod.set({usedAmount : recivePrice,changeAmout:0});
            } 
            // 値引き金額は利用金額により、大きくの場合、返金なし
            else {
                totalPayed = commUtils.mathNumAdd(totalPayed, remaindPayMoney);
                // 預かり金額：値引き金額、支払金額：残り利用金額、お釣り金額：０円（値引き返金なし）
                prod.set({usedAmount : remaindPayMoney,changeAmout:0});
            }
            // 残り未支払金額再計算を行う
            remaindPayMoney = commUtils.mathNumSub(remaindPayMoney, recivePrice);

            // 値引き超える金額は返金しない設定
            if (remaindPayMoney < 0) remaindPayMoney = 0;

        });
        consoleLog(' 利用総金額');
        // クーポン计算
        if (coponPayArr.length > 0) {
            var coponManasFlg = $("input[id$=':manasCoponFlg']").prop("checked");
            var recivePriceTotal = 0;
            coponPayArr.forEach(function(prod){
                // 預かり金額
                // 2021/05/31 #11334 bug fixed by zy BEGIN
                var recivePrice = prod.get('amoutIncTax');
                // 2021/05/31 #11334 bug fixed by zy END
                recivePriceTotal = commUtils.mathNumAdd(recivePriceTotal, recivePrice);
                // 全金額支払でも、たりない場合
                if (remaindPayMoney >= recivePrice) {
                    prod.set({usedAmount : recivePrice,changeAmout:0});
                // 預かり金額は未支払い金額は超える場合、お釣り存在場合
                } else {
                    var locRemaindPay = remaindPayMoney < 0 ? 0 : remaindPayMoney; 
                    recivePrice = coponManasFlg ? recivePrice : locRemaindPay;
                    prod.set({usedAmount : locRemaindPay,changeAmout:commUtils.mathNumSub(recivePrice, locRemaindPay)});
                }
            });
            // クーポン计算
            /*
            * recivePriceTotal: 代金卷合计值
            * remaindPayMoney: 总消费金额
            */
            recivePriceTotal = coponManasFlg ? recivePriceTotal : (recivePriceTotal < 0 ? 0 : 
                                                        (recivePriceTotal > remaindPayMoney ? remaindPayMoney : recivePriceTotal));
            totalPayed = commUtils.mathNumAdd(totalPayed, recivePriceTotal);
            remaindPayMoney = commUtils.mathNumSub(remaindPayMoney, recivePriceTotal);

        }
        consoleLog(' クーポン计算');
        normalPayArr.forEach(function(prod){
            // 2021/05/31 #11402 bug fixed by zy BEGIN
            var recivePrice = prod.get('amoutIncTax'),// 預かり金額
            // 2021/05/31 #11402 bug fixed by zy END
                payType = prod.get('PaymentType__c'); // 支払種別
            // 返金の場合、入力の金額は減算を行う
            if (isRefundItem(payType) && recivePrice > 0) {
                recivePrice = -recivePrice;
            }
            // 全金額支払でも、たりない場合
            if (remaindPayMoney >= recivePrice) {
                prod.set({usedAmount : recivePrice,changeAmout:0});
            } 
            // 預かり金額は未支払い金額は超える場合、お釣り存在場合
            else {
                var locRemaindPay = remaindPayMoney < 0 ? 0 : remaindPayMoney; 
                prod.set({usedAmount : locRemaindPay, changeAmout:commUtils.mathNumSub(recivePrice,locRemaindPay)});
            }
            totalPayed = commUtils.mathNumAdd(totalPayed, recivePrice);
            // 残り未支払金額計算
            remaindPayMoney = commUtils.mathNumSub(remaindPayMoney, recivePrice);
        });
        consoleLog(' normalPayArr');
        // 2021/05/31 #11513 bug fixed by zy BEGIN
        /*
        if(_CONST_SETAMOUNTFLG) {
            totalUsed = gtotalUsed;
        }*/
        // 2021/05/31 #11513 bug fixed by zy END
        return {
            // 利用金額（税抜き）
            totalAmountExcTax : _CONST_NOSETAMOUNTFLG ? gtotalAmountExcTax : totalAmountExcTax,
            // 2021/05/31 #11513 bug fixed by zy BEGIN
            // 利用金額
            totalAmountIncTax : _CONST_SETAMOUNTFLG ? gtotalUsed : totalUsed,
            // 2021/05/31 #11513 bug fixed by zy END
            // 支払金額
            totalPayed : totalPayed,
            // 2021/05/31 #11513 bug fixed by zy BEGIN
            totalRealAmountIncTax : totalUsed, // 画面すべて会計明細「表示・非表示」利用金額
            // 2021/05/31 #11513 bug fixed by zy END
        }
    },
    // 差金額計算：[prods]該当変更の会計明細
    computeRowChgAmount:function(prods){
        // 2021/05/31 #11334 bug fixed by zy BEGIN
        // 変更行以外の利用金額
        // 2021/05/31 #11513 bug fixed by zy BEGIN
        // 非表示の場合、あるいは金額を0円にしない
        // すべて状態の明細利用金額・利用金額
        var totalInc =  _CONST_SETAMOUNTFLG ? this.totalRealAmountIncTax : this.totalAmountIncTax;
        // 2021/05/31 #11513 bug fixed by zy END
        // 2021/07/15 #13476 bug fixed by zy BEGIN
        var processProds = $.extend([], prods);
        // 2021/07/15 #13476 bug fixed by zy END
        prods.forEach(function(prod){
            var orgAmount = prod.get('orgAmoutIncTax') || 0;
            if (orgAmount != 0) {
                // 2021/05/31 #11513 bug fixed by zy BEGIN
                var invoiceNoShow = prod.get('orgInvoiceNoShowFlg');
                // 2021/06/31 #11698 bug fixed by zy BEGIN 
                // 請求書非表示する場合、利用金額は集計対象外
                if (!invoiceNoShow || (!_CONST_SETAMOUNTFLG && !_CONST_NOSETAMOUNTFLG) || _CONST_SETAMOUNTFLG) {
                // 2021/06/31 #11698 bug fixed by zy END
                   // 非表示の一括解除、あるいは金額を0円にしない非表示設定の追加
                    totalInc -= orgAmount;
                }
                // 2021/05/31 #11513 bug fixed by zy END
            }
        });
        // 2021/05/31 #11402 bug fixed by zy BEGIN
        //  before支払い不計算
        this.payArr.forEach(function(prod){
            prod.orgSpecialTax = 0;
            prod.orgAmoutExcTax = null;
            prod.orgAmoutIncTax = null;
            prod.orgInvoiceNoShowFlg = false;
            prod.orgActionType = '';
            prod.orgPaymentType = '';
            // 2021/07/15 #13476 bug fixed by zy BEGIN
            // 支払いリスト追加
            // prods.push(prod);
            processProds.push(prod);
            // 2021/07/15 #13476 bug fixed by zy END
        });
        // 2021/05/31 #11402 bug fixed by zy END
        // 2021/05/31 #11334 bug fixed by zy END
        // 2021/07/15 #13476 bug fixed by zy BEGIN
        var before = this.computeProdsAmount(processProds,true, totalInc),
            after = this.computeProdsAmount(processProds,false,totalInc);
        // 2021/07/15 #13476 bug fixed by zy END
        return {
            // 利用金額（税抜き）
            totalAmountExcTax : after.totalAmountExcTax - before.totalAmountExcTax,
            // 利用金額
            totalAmountIncTax : after.totalAmountIncTax - before.totalAmountIncTax,
            // 支払金額
            totalPayed : after.totalPayed - before.totalPayed,
            // 2021/05/31 #11513 bug fixed by zy BEGIN
            totalRealAmountIncTax : after.totalRealAmountIncTax - before.totalRealAmountIncTax
            // 2021/05/31 #11513 bug fixed by zy END
        }
    },
    // 画面明細から総金額利用金額と請求金額を計算を行う
    computeTotalAmount:function(){
        // 全部集計の場合、合計金額初期化
        this.totalAmountIncTax = 0, //　利用金額
        this.totalAmountExcTax = 0, // 利用金額（税抜き）
        this.totalReqAmount = 0,        // 請求金額
        this.totalReciveAmount = 0, // 預かり金額
        this.totalDiscountAmount = 0,   // 値引き金額、
        this.totalPayAmount = 0,        //支払金額
        this.totalChargeAmount = 0; //お釣り金額
        // 2021/05/31 #11334 bug fixed by zy BEGIN
        this.payArr = [];       // 支払い情報
        // 2021/05/31 #11688 bug fixed by zy BEGIN
        // 画面すべて会計明細「表示・非表示」利用金額
        this.totalRealAmountIncTax = 0;
        // 2021/05/31 #11688 bug fixed by zy END
        // 2021/05/31 #11334 bug fixed by zy END
        var result = this.computeProdsAmount(this.computeValidData());
        this.setTotalAmount(result);
    },
    setTotalAmount(result){
        // 利用金額（税抜き）
        this.totalAmountExcTax += result.totalAmountExcTax;
        // 該当金額から計算を行う
        this.totalAmountIncTax += result.totalAmountIncTax;
        // 支払金額
        // 2021/05/31 #11402 bug fixed by zy BEGIN
        // 支払い計算「変更後−０」
        this.totalPayAmount = result.totalPayed;
        // 2021/05/31 #11402 bug fixed by zy END
        // 2021/05/31 #11334 bug fixed by zy BEGIN
        // 請求金額
        this.totalReciveAmount = commUtils.mathNumSub (this.totalAmountIncTax , this.totalPayAmount);
        // 2021/05/31 #11334 bug fixed by zy END
        // 残りの請求金額
        this.totalReqAmount = (this.totalAmountIncTax - this.totalPayAmount);
        // 2021/05/31 #11513 bug fixed by zy BEGIN
        this.totalRealAmountIncTax += result.totalRealAmountIncTax;
        // 2021/05/31 #11513 bug fixed by zy END
    },
    addRows:function(){
        consoleLog('addRows beg');
        var rowArr = [];
        var trStr = this.rowTemplate;
        var blankRow = this.blankRow;
        var begIndex = this.currentRows.length;
        for (var i = 0 ; i < this.addRowsLength ; i++) {
            var row = this.getRowStr(trStr,blankRow,begIndex);
            rowArr.push(row);
            begIndex ++;
        }
        let $table = $("<table/>");
        $table.html(rowArr.join(''));
        $("#transDetailTableBody").append($table.find(">tr"));
        this.currentRows = $("table[name='tranDetailTable']>tbody>tr.tranDetailRow");
        consoleLog('addRows end');
    },
    paymentProcessed:function(result){
        var unitPrice = result.unitPrice;
        if (result.actionType == COMM_SET.ACTTYPE_PAY && result.paymentType == COMM_SET.ACTTYPE_PAY_DIS_RATE ) {
            // 既存の請求金額から割引計算を行う
            // 割引%は未設定すると、画面から割引率を入力するWINDOWを表示する
            var discountRate = kendo.parseFloat(result.discountRate);
            if (discountRate == null) discountRate == 0;
            // 利用金額に対して、一括割引処理を行う
            var usedAmount = kendo.parseFloat(this.totalAmountIncTax);//　利用金額
            var reqAmount = this.totalReciveAmount + "";                    // 未支払請求金額
                reqAmount = reqAmount.replace(JINYACONNECT.CurrencySybmol,"");
                reqAmount = kendo.parseFloat(reqAmount);
                // 利用金額から計算後の値引き金額を計算を行う
                unitPrice = commUtils.mathRound( commUtils.mathNumDiv (commUtils.mathNumMulti( usedAmount, discountRate) , 100), JINYACONNECT.PRODUCT.CAL.POINT_LEN, JINYACONNECT.PRODUCT.CAL.ROUND_MODE);
                // 割引金額は未支払金額は超える場合、未請求金額を表示する
                if(unitPrice > reqAmount && (reqAmount != null && reqAmount > 0)) unitPrice = reqAmount;
        } else if (result.paymentType == COMM_SET.ACTTYPE_PAY_ADD_RATE ) {
            // 既存の請求金額から割引計算を行う
            // 割引%は未設定すると、画面から割引率を入力するWINDOWを表示する
            var plusRate = kendo.parseFloat(result.discountRate);
            if (plusRate == null) plusRate == 0;
            // 利用金額（税抜き）から計算後の割増金額を計算を行う
            var totalAmountExcTax = this.totalAmountExcTax;
            var unitOnePrice = commUtils.mathNumDiv (commUtils.mathNumMulti( totalAmountExcTax, plusRate) , 100);
            unitOnePrice = commUtils.mathRound(unitOnePrice, JINYACONNECT.PRODUCT.CAL.POINT_LEN, JINYACONNECT.PRODUCT.CAL.ROUND_MODE);
            unitPrice = JINYACONNECT.PRODUCT.CONVERTPRICE(unitOnePrice,result.tax,result.serviceRate,JINYACONNECT.PRODUCT.CAL.PRICE_KBN_DEF.KBN4,JINYACONNECT.PRODUCT.CAL.PRICE_KBN)
        }
        result.unitPrice = unitPrice;
    },
    // 利用日は設定を行う
    salesDate:function(obj){
        // 新規予約ウインドウ、見積明細設定画面の利用日は常に到着日で設定する機能対応 
        var salesdateDtStr = $("input[id$=':salesdate']").val();
        if (obj.UseDate__c == undefined || obj.UseDate__c == "") {
            // 簡易会計「予約なし」
            if($("#hidCurrLeadIdStr").val() == "" ) {
                // TIMEZON fix 
                var salesdateDt = kendo.parseDate(salesdateDtStr,JINYACONNECT.DateFormat);
                // 売上計上日の日付で設定する
                obj.UseDate__c = kendo.toString((salesdateDt == null ? new Date() : salesdateDt), JINYACONNECT.DateFormat);
            } else {
                obj.UseDate__c = kendo.toString((salesdateDt == null ? new Date() : salesdateDt), JINYACONNECT.DateFormat);
            }
        }
        // 利用日は設定を行う
        if (_CONST_RECEIPTDTAUTOSETFLG) {
            // 利用日モード: 3 的情况下处理
            if($("[id$=':sakesdateRo']").length > 0) salesdateDtStr = $("[id$=':sakesdateRo']").text();
            var salesdateDt = kendo.parseDate(salesdateDtStr,JINYACONNECT.DateFormat);
            // 売上計上日の日付で設定する
            obj.UseDate__c = kendo.toString((salesdateDt == null ? new Date() : salesdateDt), JINYACONNECT.DateFormat);
        } 
        if (COMM_SET.BOOKEST_USE_DATE) {
            if($("[id$=':strEntryDateId']").length > 0) salesdateDtStr = $("[id$=':strEntryDateId']").text();
            var salesdateDt = kendo.parseDate(salesdateDtStr,JINYACONNECT.DateFormat);
            // 売上計上日の日付で設定する
            obj.UseDate__c = kendo.toString((salesdateDt == null ? new Date() : salesdateDt), JINYACONNECT.DateFormat);
        }
    },
    // 請求書非表示設定の処理の呼び出し
    setupRowInvoiceStatus:function(prod){
        // 請求書非表示機能制御対応 
        if (this.autoCheckFlg ) return;
        // 自動設定するがどうかチェックする
        if (
            prod.get('NoShowRequestFlg__c') == "1"
            || (prod.get('productNm') || "") == ""
            ){
            prod.set('InvoiceNoShowFlg__c' ,true);
            return; 
        }
        var price = prod.get('Field20__c') || 0 ,
            orderNum = prod.get('Field21__c') || 0,
            special =prod.get('SpecialTax__c') || 0 ;
        if ((price * orderNum + special) == 0) {
            prod.set('InvoiceNoShowFlg__c' ,true);
            return;
        }
        prod.set('InvoiceNoShowFlg__c' ,false);
    },
    // 商品添加
    addProduct:function(result,mode){
        this.action = this.PROCESS_TYPE_INS;
        // 数据处理
        var prod = this.processData(result);
        // dom操作
        // (DOM)内容刷新
        // 2021/05/31 #11504 bug fixed by zy BEGIN
        this.refresh([prod],prod.isPayMentType());
        // 2021/05/31 #11504 bug fixed by zy END
        consoleLog('DOM操作 end');
        // 2021/04/31 #10888 bug fixed by zy BEGIN
        // MODE == CUST_AUTOGETPRODUCTMODE_RETURN 自動作成行フラグ
        // 以下の動作不実行
        if(mode != CUST_AUTOGETPRODUCTMODE_RETURN){
            // 增税商品-自动设定
            if ( prod.get('TaxRate__c') > 0) {
                autoSetTaxIncProductFun();
            } 
            // ポップ商品選択後の入湯税自動処理
            this.bathPopupCallBackFun(prod);
            // 自动设定响应时不调用自动check
            this.checkAutoSave();
        }
        
    },
    // 行数据变更
    updProduct:function(index){
        this.action = this.PROCESS_TYPE_UPD;
        // 当前行
        var curRow = this.currentRows.eq(index);
        var prod = this.get(index);
        // 行内操作DOM取得
        var rowElement = this.getRowDom(curRow);
        var orgQty = prod.get('Field21__c');
        var newQty = kendo.parseInt(rowElement.numInput.val())|| 0;
        var orgPrice = kendo.parseFloat(prod.get('unitPrice'))|| 0;
        var newPrice = kendo.parseFloat(rowElement.priceInput.val())|| 0;
        var orgSpecialTax = kendo.parseFloat(prod.get('strSpecialTax'))|| 0;
        var newSpecialTax = kendo.parseFloat(rowElement.specialTaxInput.val()) || 0;
        var orgInvoiceFlg = prod.get("InvoiceNoShowFlg__c");
        var newInvoiceFlg = rowElement.InvoiceNoShowChkbox.prop("checked")
        var updObj = {};
        var chgFlag = false;
        if (orgQty != newQty){
            updObj['Field21__c'] = newQty;
            chgFlag = true;
        } else if (orgPrice != newPrice) {
            updObj['Field20__c'] = newPrice;
            chgFlag = true;
        } else if (orgSpecialTax != newSpecialTax) {
            updObj['SpecialTax__c'] = newSpecialTax;
            chgFlag = true;
        } else if (orgInvoiceFlg != newInvoiceFlg) {
            updObj['InvoiceNoShowFlg__c'] = newInvoiceFlg;
            chgFlag = true;
        }
        if (chgFlag) {
            updObj.index = index;
            this.update(updObj);
            consoleLog('行金額計算 END');
            // TODO 宿泊税計算 WGCH BEGIN
            this.proBathTaxRowFun(prod);
            // 2021/05/31 #11161 bug fixed by zy BEGIN
            // 2021/05/31 #11504 bug fixed by zy BEGIN
            this.refresh([prod],prod.isPayMentType());
            // 2021/05/31 #11504 bug fixed by zy END
            // 2021/05/31 #11161 bug fixed by zy END
            // 2021/04/31 #10889 bug fixed by zy BEGIN
            autoSetTaxIncProductFun();
            // 2021/04/31 #10889 bug fixed by zy END
        }
        // 2021/04/31 #10710 bug fixed by zy BEGIN
        this.checkAutoSave();
        // 2021/04/31 #10710 bug fixed by zy END
    },
    // ポップ商品選択後の入湯税自動処理
    bathPopupCallBackFun:function(prod){
        // プランの入湯税に自動入力設定无效跳出
        if(!ACTCUSTOM.OBJ.ISBATHTAXSETFLG) return;
        var hidBTaxAccMstItem = prod.get('bTaxAccMstItem');
        if(hidBTaxAccMstItem && hidBTaxAccMstItem != ""){
            // 入湯税の自動入力
            this.bathTaxAutoSetFun(prod, hidBTaxAccMstItem);
        }
    },
    // 入汤税设定处理
    bathTaxAutoSetFun(prod,result){
        // プランの入湯税に自動入力設定无效跳出
        if(!ACTCUSTOM.OBJ.ISBATHTAXSETFLG) return;
        // 无效数据集跳出(NULL == UNDEFINED) => TRUE
        if(commUtils.isUndefined(result)) return;
        var insertProdId = result.productId;
        // 存在入汤税商品
        var bathProds = this.filter('productId',insertProdId);
        // 相同指定的商品FLG
        var isHasBathTaxAccMstFlg = bathProds.length > 0;
        var thisRowIndex = prod.get('index');
        var hasBlankRow = this.currentRows.length > this.details.length;
        
        // 不存在相同指定的商品
        if(!isHasBathTaxAccMstFlg){
            // 设定第一次当前Plan行对应的入汤税商品Id
            // 2020/07/30 BUG-FIX-#7100 WGCH BEGIN
            if(thisRowIndex != null) {
                prod.set({bTaxAccMstId : result.productId,bTaxToPlanRowIndex : result.rowIndex});
            }
            // PAGE页面自动设定商FUNCTION名
            // 2021/04/31 #10888 bug fixed by zy BEGIN
            // CUST_AUTOGETPRODUCTMODE_RETURN→自動保存停止
            this.addProduct(result,CUST_AUTOGETPRODUCTMODE_RETURN);
            // 2021/04/31 #10888 bug fixed by zy END
            // 2020/07/30 BUG-FIX-#7106 WGCH BEGIN
            var planRowIndex = commUtils.isUndefined(thisRowIndex) ? result["hidBTaxToPlanRowIndex"] : thisRowIndex;
            if(!commUtils.isUndefined(planRowIndex)){
                // 入汤税商品行设定对应关联的PLAN行RowNo
                prod.set('bTaxToPlanRowIndex',planRowIndex);
            }
            // 2020/07/30 BUG-FIX-#7106 WGCH END
            return;
        }
    },
    // 处理入湯税行
    proBathTaxRowFun(prod){
        // プランの入湯税に自動入力設定无效跳出
        if(!ACTCUSTOM.OBJ.ISBATHTAXSETFLG) return;
        // 设定第一次当前Plan行对应的入汤税商品Id
        // 2020/07/30 BUG-FIX-#7100 WGCH BEGIN
        var hidBTaxAccMstId = prod.get('bTaxAccMstId');
        // 2020/07/30 BUG-FIX-#7100 WGCH END
        // 当クリア处理是非关联入汤税PLAN行的情况
        if(hidBTaxAccMstId == ""){
            // クリア处理
            if(this.action == this.PROCESS_TYPE_CLEAR){
                // 获取该行关联的Plan行RowIndex
                // 2020/07/30 BUG-FIX-#7100 WGCH BEGIN
                var planRowIndex = prod.get('bTaxToPlanRowIndex');
                // 2020/07/30 BUG-FIX-#7100 WGCH END
                if(planRowIndex != ""){
                    // 清空关联行入汤税商品Id
                    // 2020/07/30 BUG-FIX-#7100 WGCH BEGIN
                    prod.set('bTaxAccMstId',"");
                    // 2020/07/30 BUG-FIX-#7100 WGCH END
                }
            }
            return;
        }
        // 当前入汤税商品INPUT
        var taxAccProds = this.filter('productId',hidBTaxAccMstId),$c = this;
        if(taxAccProds.length <= 0) return;
        taxAccProds.forEach(function(p){
            var currRowIndex = p.index;
            // 处理与被处理不可以是同一行防止死循环
            if (currRowIndex != prod.index) {
                // 当前没关联PlanClear, 联动クリア「入湯税行」
                if($c.action == $c.PROCESS_TYPE_CLEAR){
                    $c.remove(currRowIndex);
                } else if ($c.action = $c.PROCESS_TYPE_UPD) {
                    // 联动数量
                    var row = $c.currentRows.eq(currRowIndex);
                    var rowElement = $c.getRowDom(row);
                    rowElement.numInput.val(prod.get('Field21__c'));
                    $c.updProduct(currRowIndex);
                }
            }
        });
    },
    getPlanKeyFun:function(index){
        var prod = this.get(index);
        return this.getPlanKeyStr(prod.get('Field7__c'),prod.get('index'));
    },
    getPlanKeyStr:function(prodId,index){
        return prodId  + '_' + index;
    },
    // 数据处理
    processData : function(result){
        // 割引％計算機能設定
        this.paymentProcessed(result);
        consoleLog('既存の請求金額から割引計算を行う END');
        var unitPrice = result.unitPrice,
            paymentType = result.paymentType,
            productName = result.prodcutName,
            ACTTYPE_PAY = COMM_SET.ACTTYPE_PAY,
            DEF_DEV_POS_NO = COMM_SET.DEF_DEV_POS_NO,
            index = -1,
            sameprodflg = false;
        // 指定index场合
        if (result.rowIndex != undefined) {
            index = result.rowIndex;
        } else {
            sameprodflg = this.getNextIndex(result.productId , result._selfClickType == 'product');
            index = this.lastIndex;
        }
        // 直接从选择的商品中重置数据，plan设定，有处理顺序，不可放置在计算之后
        if (!sameprodflg) {
            // 宿泊税計算 
            planItemPriceMap.set(this.getPlanKeyStr(result.productId,index), result.planItemPriceLst);
        }
        consoleLog('上一次商品Idx END');
        var taxRate = kendo.parseFloat(result.tax);
        if (taxRate == null) taxRate = 0;
        var obj = {
            index : index,
            productNm : productName,
            orgProductNm : productName,
            Field7__c : result.productId,
            Field20__c : unitPrice,
            Field21__c : 1,
            TaxRate__c : taxRate,
            ServiceRate__c : result.serviceRate,
            ActionType__c : result.actionType,
            PaymentType__c : paymentType,
            initPlanInfo : result.unitPriceExcTax,
            productCd : result.prodcutCode,
            SpecialTax__c : result.specialTax,
            bTaxAccMstItem: result.bTaxAccMstItem,
            InvoiceNoShowFlg__c : false,
        }
        // ポース機能追加する
        if (result.actionType == ACTTYPE_PAY) {
            obj.POSNo__c = DEF_DEV_POS_NO;
        }
        // 利用日は設定を行う
        this.salesDate(obj);
        consoleLog('利用日は設定 END');
        var prod = this.get(index);
        // 相同商品数量+1
        if (sameprodflg) {
            // 2021/06/31 #11206 bug fixed by zy BEGIN
            prod.set('Field21__c',prod.get('Field21__c') + 1);
            // 2021/06/31 #11206 bug fixed by zy END
            prod = this.update(prod);
        } else {
             // 2021/07/15 #12910 bug fixed by zy BEGIN
            var planItemLst;
            // 軽減税率機能対応 
            // 如果有PLAN明细加到MAP里
            if(!commUtils.isEmpty(result.pdProductItem)){
                planItemLst = result.pdProductItem; // 軽減税率機能有効のプランの明細リスト
            }
            obj.planItemLst = planItemLst;
            // 2021/07/15 #12910 bug fixed by zy END
            if (prod != null && prod.checkValidata()) {
                prod = this.update(obj);
            } else {
                if (prod != null && !prod.checkValidata()) {
                    // 既存データ変更用字段保持
                    obj = Object.assign(obj,{Id:prod.get('Id'),Field1__c:prod.get('Field1__c'),RelAccount__c :prod.get('RelAccount__c')});
                }
                prod = this.insert(obj);
            }
        }
        // 計算後で機能を行く
        // 請求書非表示設定の処理の呼び出し
        if (prod.checkValidata()) {
            this.setupRowInvoiceStatus(prod);
        }
        // 后续联动
        // 2016/02/25 Log Output BEGIN
        var logLine = "";
        if (sameprodflg) {
            logLine = "明細行自動追加,," + Date.now();
        } else {
            logLine = "INS," + (1*g_currRowIndex+1) + ',' + Date.now() + ',' + prod.get('productNm') + ',' + prod.get('actionType') + ',' + prod.get('PaymentType__c') + ',' + prod.get('productCd');
        }
        logger.push(logLine);
        // 2016/02/25 Log Output END
        return prod;
    },
    // 明細の順序変更
    moveDetail:function(curRow){
        var from = J_ACCOUNT_CENTER.getRowIndex(curRow);
        this.currentRows = $("table[name='tranDetailTable']>tbody>tr.tranDetailRow");
        var to = J_ACCOUNT_CENTER.getRowIndex(curRow);
        var detialLen = this.details.length;
        var startIdx = Math.min(to,from) - 1, startIdx = startIdx > 0 ? startIdx : 0;
        var endIdx = Math.max(to,from);
        if (detialLen <= endIdx) {
            for (var i = detialLen ; i <= endIdx ; i++) {
                this.details.push(new ProdItem());
            }
        }
        this.details.splice(to,0,this.details.splice(from,1)[0]);
        this.get(to).set({'RowNo__c':to,isNoUpdate:false});
        this.refreshIndex();
        // 2021/04/31 #10710 bug fixed by zy BEGIN
        this.checkAutoSave();
        // 2021/04/31 #10710 bug fixed by zy END
    },
    // 実際のインデックス刷新
    refreshIndex:function(){
        var t = this;
        var beforeIdx = -1;
        // 前排某一位数据被删除并没有重新更新其他数据，则当前位空出
        t.details.forEach(function(item,idx){
            // 該当行データ有効の場合
            if (item != null && (item.checkValidata())) {
                var currIndex = item.get('RowNo__c');
                // 2021/04/31 #10793 bug fixed by zy BEGIN
                var beforeIndex = 0;
                // 2021/04/31 #10793 bug fixed by zy END
                var orgItem = t.get(beforeIdx);
                if (orgItem != null) {
                    beforeIndex = orgItem.get('RowNo__c');
                }
                if (currIndex === "" || beforeIndex >= currIndex){
                    item.set('RowNo__c',beforeIndex + 1);
                    item.isNoUpdate = false;
                }
                beforeIdx = idx;
            }
            // 2021/07/15 #13476 bug fixed by zy BEGIN
            item.index = idx;
            // 2021/07/15 #13476 bug fixed by zy END
        });
    },
    //　チェック変更明細
    hasUpadte:function(){
        var changedRows = this.details.filter(function(prod){
            return prod.isNoUpdate == false;
        });
        return changedRows.length > 0;
    }
}
$(document).ready(function() {
    bindEvents();
    bindDetailEvents();
    consoleLog('bindEvents');
});
// ****** 画面初期化Event呼び出し *****//
function bindEvents() {
    J_ACCOUNT_CENTER.init();
    consoleLog('BEGIN');
    // 会計状態ステータメッセージをTIPSに設定する
    var accountFlgCalSpan = $("span[id$=':accountFlgCalId']");
    accountFlgCalSpan.attr("title",accountFlgCalSpan.find("img").attr("alt"));
    // 利用日設定を行う
    if($("#hidCurrLeadIdStr").val() == "") {
        $("input[id$=':useDate']").attr("disabled", "disabled");
    }
    consoleLog('refreshContact BEGIN');
    // 会計メッセージ項目自定義機能追加
    refreshContact();
    // 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応
    var mrStr = "{!JSENCODE(mrStr)}";
    var mrlst = JSON.parse($("#hidmrTypeLstJson").val());
    mrShowSelectHtml ='';
    for(var i=0;i<mrlst.length;i++){
        mrShowSelectHtml += "<option value='"+mrlst[i]+"'"+ (mrlst[i] == mrStr ? ' selected' : '') +">" +mrlst[i] +"</option>"; 
    }
    // 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい
    if (isAutoScanerConect()) {
        onDeviceStart();
    }
    // 但しデイフォル値設定機能対応 
    consoleLog('但しデイフォル値設定機能対応 BEGIN');
    var accountNamesDs = $.parseJSON("{!JSENCODE(accountNames)}");
    var accountProvisosDs = $.parseJSON("{!JSENCODE(accountProvisos)}");
    var accountProvisosDsDefVal = "";
    for (i=0; i < accountProvisosDs.length; i++) {
        var defaultPos = accountProvisosDs[i].value.indexOf(':1');
        if (defaultPos > 0) {
            var orgVal = accountProvisosDs[i].value.substr(0,defaultPos);
            accountProvisosDs[i].label = orgVal;
            accountProvisosDs[i].value = orgVal;
            if (accountProvisosDsDefVal.length == 0) accountProvisosDsDefVal = orgVal;
        }
    }
    // 会計書宛名情報設定用
    $("[id$=':accountNameSel'],[id$=':accountReciptSel']").kendoComboBox({
       dataTextField: "label",
       dataValueField: "value",
       dataSource: accountNamesDs,
    }).css({ fontSize: 13, height:24, padding:0});
    $("[id$=':accountProvisoSel']").kendoComboBox({
       dataTextField: "label",
       dataValueField: "value",
       dataSource: accountProvisosDs,
    });
    if (accountProvisosDsDefVal.length > 0) { 
        var accountProvisoSelCombobox = $("[id$=':accountProvisoSel']").data("kendoComboBox");
        if (accountProvisoSelCombobox.value().length == 0) {
            accountProvisoSelCombobox.value(accountProvisosDsDefVal);
        }
    }
    // 但しデイフォル値設定機能対応 END
    $("[id$=':languageSel']").kendoDropDownList();
    consoleLog('但しデイフォル値設定機能対応 END');
    // 2019/01/30 会計の売上計上日が自動入力機能対応 BEGIN
    // すべて入力の全角数字は半額に変更を行う
    var baseInfoPage = $("[id$=baseInfoPage]");
    $('input',baseInfoPage).change(function(){
        var txt  = $(this).val();
        var han = txt.replace(/[Ａ-Ｚａ-ｚ０-９]/g,function(s){return String.fromCharCode(s.charCodeAt(0)-0xFEE0)});
        $(this).val(han);
        var salesdateDt = kendo.parseDate(han,JINYACONNECT.DateFormat);
        var oldSalesdateDt = kendo.parseDate(oldSakesdateVal,JINYACONNECT.DateFormat);
        if( _CONST_RECEIPTDTAUTOSETFLG && // 功能开启
            $(this).hasClass("sakesdateCls") && // 判断是否为売上計上日的Input
            oldSalesdateDt != null && // 判断Input内变更前的值处理
            salesdateDt != null) {
            // 2021/04/31 #10649 bug fixed by zy BEGIN
            var sameDateProds = J_ACCOUNT_CENTER.filter('tranUseDate',oldSakesdateVal).filter(function(prod){
                return prod.get('productId') != "";
            });
            var message = "既存の" + oldSakesdateVal + "利用日を" + han + "に変更しますか";
            if(sameDateProds.length > 0 ){
                $(this).attr("disabled",true);
                if (confirm(message)){
                    var salesDateStr = kendo.toString((salesdateDt == null ? new Date() : salesdateDt), JINYACONNECT.DateFormat);
                    sameDateProds.forEach(function(prod){
                        prod.set({UseDate__c:salesDateStr,isNoUpdate:false});
                        var curRow = J_ACCOUNT_CENTER.currentRows.eq(prod.index);
                        J_ACCOUNT_CENTER.getRowDom(curRow).useDateInput.val(salesDateStr);
                    });
                }
                var thisDate = $(this);
                setTimeout(function(){thisDate.removeAttr("disabled");});
            }
            // 2021/04/31 #10649 bug fixed by zy END
        }
    }).on('focus', function(e) {
        if(_CONST_RECEIPTDTAUTOSETFLG && $(this).hasClass("sakesdateCls")) oldSakesdateVal = $(this).val();
    });
    $("a",baseInfoPage).click(function(){ // dateFormat A标签对应
        if(!_CONST_RECEIPTDTAUTOSETFLG) return;
        var $salesdate = $("input[id$=':salesdate']"); // dateFormat A标签对应
        if($salesdate.length > 0){ // 売上計上日处理
            // 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH BEGIN
            // if($(this).attr("href").indexOf($salesdate.attr("id")) >= 0){
            var href = $(this).attr("href");
            if(href && href.indexOf($salesdate.attr("id")) >= 0){
            // 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH END
                oldSakesdateVal = $salesdate.val();
            }
        }
    });
    // 2019/01/30 会計の売上計上日が自動入力機能対応 END 
    // 人数焦点
    $("input[id$=':stayPeople']").focus();
    // 2021/05/31 #11257 bug fixed by zy BEGIN
    // 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH BEGIN
    if(initUpsertFlg){
        // 开启提示
        window.onbeforeunload = function(e){e.returnValue = "編集内容を保存していません。";};
        clickUpsertFun();
        initUpsertFlg = false;
    }
    // 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH END
    // 2021/05/31 #11257 bug fixed by zy END
}
function bindDetailEvents(){
    /**
    TAB绑定
    **/
    $("#tabstrip").on("keydown", function (e) {
        // kendo.keys is documented at http://docs.telerik.com/kendo-ui/api/javascript/kendo#fields-keys
        if (e.keyCode == kendo.keys.DOWN || e.keyCode == kendo.keys.UP || e.keyCode == kendo.keys.LEFT || e.keyCode == kendo.keys.RIGHT) {
            // prevent the built-in TabStrip keyboard navigation
            e.stopImmediatePropagation();
            // prevent page scroll
            //e.preventDefault();
        }
    });
    var ts = $("#tabstrip").kendoTabStrip({
        select:function(e,options){
            var tabId = e.item["id"];
            // 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH BEGIN
            var $accountSkipIframe = $("#accountSkipIframe");
            if($accountSkipIframe.length > 0 && "treeCloseFun" in $accountSkipIframe[0].contentWindow){
                $accountSkipIframe[0].contentWindow.treeCloseFun();
            }
            var hasUpadteFlg = J_ACCOUNT_CENTER.hasUpadte();
            // 会計分割の場合
            if(tabId == "tab_transplit"){
                var $tableBody = $(this.contentElement($(e.item).index()));
                if (!$tableBody.hasClass("htmlRedered")) {
                    var src = hasUpadteFlg ? "" : COMM_SET.BILL_SIPLIT_SRC;
                    var iframBody = '<iframe id="billSplitProcess" height="100%" width="100%" style="border:0;" frameborder="no" scrolling="no" name="theIframe" src="' + src + '" ></iframe>';
                    $tableBody.html(iframBody);
                    $tableBody.addClass("htmlRedered")
                }
                JINYACONNECT.blockUi();
            }
            if(accSkipTabShow && tabId == "tab_accountSkip"){
                var $tableBody = $(this.contentElement($(e.item).index()));
                if (!$tableBody.hasClass("htmlRedered")) {
                    var src = hasUpadteFlg ? "" : COMM_SET.ACCOUNT_SKIP_SRC;
                    var iframBody = '<iframe id="accountSkipIframe" height="100%" width="100%" style="border:0;" frameborder="no" scrolling="no" name="theIframe" src="' + src + '" ></iframe>';
                    $tableBody.html(iframBody);
                    $tableBody.addClass("htmlRedered")
                }
                JINYACONNECT.blockUi();
            }
            // 有未保存的有效明细
            if(hasUpadteFlg){
                clickUpsertFun();
                // 2021/04/31 #10788 bug fixed by zy BEGIN
                var updSelector = tabId == "tab_accountSkip" ?  "#tab_transplit" : "#tab_accountSkip";
                $(updSelector).addClass("updateNoRefresh");
                // 2021/04/31 #10788 bug fixed by zy END
                if ( tabId == "tab_accountSkip" && $accountSkipIframe.length > 0 && "blockUi" in $accountSkipIframe[0].contentWindow){
                    $accountSkipIframe[0].contentWindow.blockUi();
                }
            }
            // 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH END
            if(tabId != "tab_trandetail") {
                // 支払メデイアメニューを非表示になる:componet id:BillSimplePaymentComp
                $(".{!BillSimplePaymentCompId}_body").hide();
            } else {
                $(".{!BillSimplePaymentCompId}_body").show();
            }
        },
        contentLoad:function(){
            JINYACONNECT.unblockUi();
        },
        show:function(){
            JINYACONNECT.unblockUi();
        },
        activate:function(e){
            // 2021/03/04 CPU LIMITの最適化 BUG[#PC9837] WGCH BEGIN
            // TODO : WGCH, 2020/03/04, 2020/03/30
            /*
            var iframeHeightvalue = $("#billSplitProcess").contents().height();
            $("#billSplitProcess").height(iframeHeightvalue);
            // 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH BEGIN
            resizeDetail();
            resizeDetailAccountSkipTabHeight();
            // 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH END
            */
            try {
                resizeContent(this);
                // 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH BEGIN
                //  resizeDetail();
                // resizeDetailAccountSkipTabHeight();
                // 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH END
            } catch(err) {
                consoleLog(err);
            }
            // 2021/03/04 CPU LIMITの最適化 BUG[#PC9837] WGCH END
            // JINYACONNECT.unblockUi();
        }
    }).data('kendoTabStrip');
    $("#tabstrip ul").show();
    consoleLog('TAB END');
    J_ACCOUNT_CENTER.resizeTable();
    $(window).resize(function(){
        J_ACCOUNT_CENTER.resizeTable();
    });
    //レシート印刷機能追加
    initChangeDevice();
    //レシート印刷機能追加
}
function setupCalSumAmountPrice(){
    J_ACCOUNT_CENTER.refresh();
}
// 指定行の入力情報をクリアする[Clear Button]
function clearProductInfo() {
    var $el = $(event.currentTarget);
    var curRow = $el.closest("tr.tranDetailRow");
    var rowIndex = J_ACCOUNT_CENTER.getRowIndex(curRow);
    // 2021/04/31 #10889 bug fixed by zy BEGIN
    var prod = J_ACCOUNT_CENTER.get(rowIndex);
    var prodId = prod != "" ? prod.get("productId") : "";
    J_ACCOUNT_CENTER.remove(rowIndex);
    // 增税商品-自动设定
    autoSetTaxIncProductFun(CUST_CLICKMODE_CLEAR, prodId);
    // 2021/04/31 #10889 bug fixed by zy END
    return;
}
// <!--支払種別から支払メディア種別取得 -->
function getPayMeidaLabel(payType) {
    // 支払種別ー支払メディアへ変換用オブジェクト
    if (g_paymentCovnertMap.hasOwnProperty(payType)) {
        return g_paymentCovnertMap[payType];
    } else {
        return "";
    }
}
// <!--　該当支払情報は返金するがどうかチェック -->
function isRefundItem(paytype) {
    return (paytype.length > 0 && g_refundKeyArr.indexOf(paytype) >= 0);
}
// 入力部の機能対応
function focusToBindEvent(){
    var $el = $(event.currentTarget),idStr = $el.attr("id");
    if (idStr) {
        if (idStr.includes("productName")) {
            if (!$el.hasClass("bindEvented")) {
                bindAutoComplete($el);
                $el.addClass("bindEvented");
        }
        } else if (idStr.includes("orderNums") || idStr.includes("price") || idStr.includes("specialTax")) {
            if (!$el.hasClass("bindEvented")) {
                bindContentChg($el);
                $el.addClass("bindEvented");
            }
        } else if (idStr.includes("useDate")) {
            bindDataPicker($el);
        }
    }
}
// 2021/04/31 #10643 bug fixed by zy BEGIN
// 商品名変更
function productNameChg(){
    var $currentInput = $(event.currentTarget);
    var tranRow = $currentInput.closest("tr.tranDetailRow");
    var index = J_ACCOUNT_CENTER.getRowIndex(tranRow);
    var prod = J_ACCOUNT_CENTER.get(index);
    // 該当行有効チェック
    if (prod != null && prod.checkValidata()) {
        prod.set({productNm:$currentInput.val(),isNoUpdate : false});
    }
}
// 2021/04/31 #10643 bug fixed by zy END
// 自動行追加
function lastAddRows(){
    var curRow = $(event.currentTarget).closest("tr.tranDetailRow");
    var rowIdx = J_ACCOUNT_CENTER.getRowIndex(curRow);
    if (rowIdx == (J_ACCOUNT_CENTER.currentRows.length - 1)) {
        var prod = J_ACCOUNT_CENTER.get(rowIdx);
        if (prod != null && prod.checkValidata()) {
            J_ACCOUNT_CENTER.addRows();
        }
    }
}
function bindAutoComplete(el){
    // 会計商品AutoComplete[1桁以上]
    $(el).autocomplete({
        minLength: 1,
        source: function (request, response) {
            Visualforce.remoting.Manager.invokeAction(
                "{!$RemoteAction.BillSimpleInputCtrl.getArrayProductItemInfo}", request.term, function(result, event){
                if (event.type == 'exception') {
                    alert(event.message);
                } else {
                    response($.map(result, function (item) {
                        item.id = item.productId;
                        item.value = item.prodcutName + "("+item.prodcutCode+")";
                        return item;
                    }));
                } // End else
            });
        },
        focus: function (event, ui) {
            // 2021/04/31 #10642 bug fixed  by zy BEGIN
            var curRow = $(this).closest("tr.tranDetailRow");
            g_currRowIndex = J_ACCOUNT_CENTER.getRowIndex(curRow);
            // 2021/04/31 #10642 bug fixed  by zy END
            ui.item.rowIndex = g_currRowIndex;
            // 当前行清空再计算
            J_ACCOUNT_CENTER.remove(g_currRowIndex);
            focusFlag = true;
            // 2019/04/30 増税仮対応 WGCH BEGIN
            // autoGetProductInfo(ui.item);
            autoGetProductInfo(ui.item, CUST_AUTOGETPRODUCTMODE_RETURN);
            // 2019/04/30 増税仮対応 WGCH END
            return false;
        },
        select: function (event, ui) {
            // 2021/04/31 #10642 bug fixed  by zy BEGIN
            var curRow = $(this).closest("tr.tranDetailRow");
            g_currRowIndex = J_ACCOUNT_CENTER.getRowIndex(curRow);
            // 2021/04/31 #10642 bug fixed  by zy END
            ui.item.rowIndex = g_currRowIndex;
            // 当前行清空再计算
            J_ACCOUNT_CENTER.remove(g_currRowIndex);
            focusFlag = false;
            autoGetProductInfo(ui.item);
            // 2019/11/15 最近利用している商品一覧機能を提供する BY zyz BEGIN
            if ("accMasterFun" in window) accMasterFun(ui.item.id);
            // 2019/11/15 最近利用している商品一覧機能を提供する BY zyz END
            // 2020/07/30 入湯税の自動入力機能について改善 zyz BEGIN
            // 触发追加入汤税行
            // ACTCUSTOM.BATHTAXAUTOSETFUN(g_currRowIndex, ui.item.bTaxAccMstItem);
            // 2020/07/30 入湯税の自動入力機能について改善 zyz END
            return false;
        },
    });
    
}
function bindContentChg(el){
    $(el).on("change",function(){
        // 2021/04/31 #10868 bug fixed by zy BEGIN
        if (this.id.includes("specialTax")) {
            specialTaxFlg = true;
        } else {
            specialTaxFlg = false;
        }
        // 2021/04/31 #10868 bug fixed by zy END
        var curRow = $(this).closest("tr.tranDetailRow");
        var index = J_ACCOUNT_CENTER.getRowIndex(curRow);
        J_ACCOUNT_CENTER.updProduct(index);
    });
}
function bindDataPicker(el){
    if (!el.hasClass("focused") && !el.hasClass("changeed")) {
        DatePicker.pickDate(true, el.attr('id'), false);
        var datePickerTop = parseInt($('.datePicker').css('top'),10);
        if(!isNaN(datePickerTop)){
            $('.datePicker').css('top', (datePickerTop - $('#contentDiv').scrollTop()) + 'px');
        }                               
        el.addClass("focused")                    
    } else {
        el.removeClass("focused")
    }
}
function dateChange(){
    consoleLog('datechange');
    var $dateInput = $(event.currentTarget);
    $dateInput.addClass("changeed");
    DatePicker.getDatePicker().hide(event.currentTarget);
    setTimeout(function(){
        $dateInput.removeClass("changeed");
        // 2021/04/31 #10889 bug fixed by zy BEGIN
        DatePicker.getDatePicker().skipReopen = false;
        // 2021/04/31 #10889 bug fixed by zy END
    },50);
    var curRow = $dateInput.closest("tr.tranDetailRow");
    var index = J_ACCOUNT_CENTER.getRowIndex(curRow);
    var prod = J_ACCOUNT_CENTER.get(index);
    if (prod != null) {
        prod.set({UseDate__c:$dateInput.val(),isNoUpdate:false});
    }
    // 2021/04/31 #10889 bug fixed by zy BEGIN
    autoSetTaxIncProductFun();
    // 2021/04/31 #10889 bug fixed by zy END
}
function changeInvoice() {
    var $chk = $(event.currentTarget);
    var curRow = $chk.closest("tr.tranDetailRow");
    var index = J_ACCOUNT_CENTER.getRowIndex(curRow);
    var prod = J_ACCOUNT_CENTER.get(index);
    if (prod != null) {
        prod.set('autoSetInvoiceNoShowFlg',false);
        J_ACCOUNT_CENTER.updProduct(index);
    }
}
function resizeContent(tabstrip){
    if (!("resizeContentInt" in window)) {
        window.resizeContentInt = 0;
    }
    var conent = tabstrip.contentElements.filter(".k-state-active");
    if (conent != undefined) {
        var avtiveId = tabstrip.select().attr("id");
        if (avtiveId == "tab_trandetail") {
            setTimeout(function(){
                J_ACCOUNT_CENTER.resizeTable();
                JINYACONNECT.unblockUi();
            },200);
            return ;
        }
        var childIfrme = conent.children("iframe");
        if (childIfrme.length > 0) {
            childIfrme = childIfrme.get(0);
            if (childIfrme != undefined && childIfrme.contentDocument != undefined && (("bindEvents" in childIfrme.contentWindow) || ("treeCloseFun" in childIfrme.contentWindow))) {
                delete window.resizeContentInt;
                // 保存状態チェック
                if (!$('.btn').hasClass("btnDisabled")){
                    JINYACONNECT.unblockUi();
                    // 2021/04/31 #10788 bug fixed by zy BEGIN
                    if (tabstrip.select().hasClass("updateNoRefresh")) {
                        iframeReload();
                    }
                    // 2021/04/31 #10788 bug fixed by zy END
                }
                return;
            }
        }
    }
    // 10秒以后自动解锁页面
    if (window.resizeContent == 10000) {
        delete window.resizeContentInt;
    }
    setTimeout(function(){
        window.resizeContentInt += 1000;
        resizeContent(tabstrip);
    },100);
}
// ****** 明細分割タブの高さ調整 *****//
function resizeDetailSplitTabHeight() {
    var conent = $("#tabstrip div.k-state-active");
    var iframeHeightvalue = $("#billSplitProcess").contents().height();
    $("#billSplitProcess").height(iframeHeightvalue);
    JINYACONNECT.unblockUi();
}
// ****** 会計飛ばしタブの高さ調整 *****//
function resizeDetailAccountSkipTabHeight() {
    var conent = $("#tabstrip div.k-state-active");
    var iframeHeightvalue = $("#accountSkipIframe").contents().height();
    $("#accountSkipIframe").height(iframeHeightvalue);
    JINYACONNECT.unblockUi();
}
// 会計書順位調整JS
function draggableOnDragStart(e) {
    var table = $("[id$=tran1Table]");
    var dropTargets = $(">tbody tr.tranDetailRow:not(:has(.bindDrop))",table);
    if (dropTargets.length > 0) {
        dropTargets.kendoDropTarget({
            drop: droptargetOnDrop
        });
        dropTargets.addClass("bindDrop");
    }
    var curRow = $(e.currentTarget).closest("tr");
    curRow.hide();
    var imgFun = curRow.find('img[id^=showDetailEvent]');        
    if(imgFun.attr("openStatus")=="true"){
        showDetailFun(imgFun);
    }
}
function droptargetOnDrop(e){
    $("tr.droped").removeClass("droped");
    $(e.dropTarget).addClass("droped");
}
function draggableOnDragEnd(e) {
    var draggable = $('table').data("kendoDraggable");
    var curRow = $(e.currentTarget).closest("tr.tranDetailRow");
    var afterIndex = J_ACCOUNT_CENTER.getRowIndex(curRow);
    curRow.show();
    curRow.attr("moveIndex",afterIndex);
    var dropRow = $("tr.droped");
    if (dropRow.length == 0) {
        return;
    }
    dropRow.before(curRow);
    dropRow.removeClass("droped");
    J_ACCOUNT_CENTER.moveDetail(curRow);
}
function refreshOrder(){
    J_ACCOUNT_CENTER.refreshIndex();
}
// プラン明細表示機能
function showDetailFun(obj) {
    if ($(obj).attr("openStatus") == "false") {
        $(obj).attr("openStatus","true");
        //折りたたむ
        $(obj).attr("title","{!$Label.MSG_006_0233}");
        $(obj).attr("src","{!URLFOR($Resource.AppImages, 'extend/jianhao.png')}");
        var curRow = $(obj).closest("tr.tranDetailRow");
        // Javasceipr Remotingでデータを取得する
        var g_currRowIndex = J_ACCOUNT_CENTER.getRowIndex(curRow),
            prod = J_ACCOUNT_CENTER.get(g_currRowIndex),
            ctrlId = prod.get('productId'),
            tranId = prod.get('tranId'),
            accId = prod.get('accRefId'),
            estItemId = prod.get('bookEstItemId'),
            syncInfo = prod.get('PlanDetailSyncInfo__c');
        var childcls = ('showDetailEvent' + g_currRowIndex) + "_child";
        // 該当商品はMEMORYに格納していない場合

        hashMap.Clear();        
        if (syncInfo != "") {
            syncInfo = syncInfo.substring(0, syncInfo.length-1);
            var synInfoArr = syncInfo.split(";");
            for (i = 0; i < synInfoArr.length; i++){
                hashMap.Put(synInfoArr[i].split(":")[0], synInfoArr[i].split(":")[1]);
                // 2019/12/30 会計機能、会計画面でプランの内訳を編集出来るように WGCH BEGIN
                if(isPlanEditFlg){
                    var setupInfArr = synInfoArr[i].split(":");
                    var sobjId = setupInfArr[0];
                    var mapKey2 = g_currRowIndex + "_i_" + sobjId;      // 設定明細の会計商品ID
                    var mapKey3 = g_currRowIndex + "_n_" + sobjId;      // 設定明細の会計商品名
                    if (setupInfArr.length > 2) hashMap.Put(mapKey2, setupInfArr[2]); // 会計商品ID
                    if (setupInfArr.length > 3) hashMap.Put(mapKey3, setupInfArr[3]); // 会計商品名
                }
                // 2019/12/30 会計機能、会計画面でプランの内訳を編集出来るように WGCH END
            }
        }

JINYACONNECT.blockUi();
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.BillSimpleInputCtrl.getAccountMstLstByPlan}',
            tranId, accId, ctrlId, estItemId,
            function(result, event){
JINYACONNECT.unblockUi();
                if (event.status) {
                    if(result== null || result.length == 0){
                    //データ詳細がありません。
                        $(obj).parents("tr .tranDetailRow").after("<tr><td colspan='10' style='margin-right: 200px;' >{!$Label.MSG_006_0235}</td></tr>");
                    }else{
                        // プラン明細設定情報を格納用
                        var planSyncInf = '';
                        var tabStrHead = "<tr><td colspan='13'>" +
                                  "<table style='width:50%' class='list' border='0' cellpadding='0' cellspacing='0'>" +
                                  "<thead class='rich-table-thead'>" +
                                  "<tr class='headerRow' nowrap='nowrap'>" +
                                  //商品名
                                  //単価
                                      "<th class='headerRow' nowrap='nowrap' style='width:70%'>{!$Label.MSG_006_0212}</th>" +
                                      "<th class='headerRow' nowrap='nowrap' style='width:30%'>{!$Label.MSG_006_0213}</th></tr></thead>" +
                                  "<tBody>";
                                  //合計
                        var tabStrFoot = "</tBody> <tFoot><tr><td style='text-align: right;'><span style='margin-right:3px'>{!$Label.MSG_006_0402}：</span></td><td style='text-align:right;'><span id='$summaryPriceId$' style='float:right;margin-right: 3px'></span></td></tr>"
                                        + "</tFoot> </table></td></tr>";
                        var tabStrBody = "";

                        for (var i=0; i<result.length; i++) {
                            // メモーに既存場合、メモーの設定情報から、単価を設定する
                            var memoryPrice = hashMap.Contains(result[i].sobjId) ? hashMap.Get(result[i].sobjId) : result[i].prodPrice;
                            var prodtaxflg = '';
                            if(result[i].prodTaxRate !=null && result[i].prodTaxRate !='') prodtaxflg = '1';
                            // 2019/12/30 会計機能、会計画面でプランの内訳を編集出来るように WGCH BEGIN
                            // tabStrBody += "<tr><td style='background-color: #FFEBCD;'>"; + result[i].prodName;
                            tabStrBody += "<tr><td style='background-color: #FFEBCD;'>";
                            var mapKey4 = groupIndex + "_t_" + result[i].sobjId;        // 設定明細の会計商品Type
                            var actionType = planItemTypeMap.get(mapKey4) ? planItemTypeMap.get(mapKey4) : result[i].actionType;
                            var productId = result[i].prodid;
                            if(isPlanEditFlg){
                                var mapKey2 = g_currRowIndex + "_i_" + result[i].sobjId;        // 設定明細の会計商品ID
                                var mapKey3 = g_currRowIndex + "_n_" + result[i].sobjId;        // 設定明細の会計商品名
                                productId = hashMap.Contains(mapKey2) ? hashMap.Get(mapKey2) : result[i].prodid;
                                var productNm = hashMap.Contains(mapKey3) ? hashMap.Get(mapKey3) : result[i].prodName;
                                tabStrBody += "<input type='hidden' id='" + g_currRowIndex + "_workHidItem' />";
                                tabStrBody += "<input type='text'style='width:180px' value='" + productNm + "' id='" + g_currRowIndex + "_prodName_" + i + "' rowidx='" + i + "' parentIndex='" + g_currRowIndex + "' />";
                                tabStrBody += "<img onmouseover='this.className = \"lookupIconOn\";this.className = \"lookupIconOn\";'";
                                tabStrBody += "onmouseout='this.className = \"lookupIcon\";this.className = \"lookupIcon\";'";
                                tabStrBody += "onfocus='this.className = \"lookupIconOn\";' onblur='this.className = \"lookupIcon\";'";
                                tabStrBody += "class='lookupIcon' src='/s.gif' style='cursor: pointer;'";
                                tabStrBody += "name='childrenProductPopup' onclick='javascript:openChildProdutWin(\"" + g_currRowIndex + "\",\"" + i + "\")'/>";
                            } else tabStrBody += result[i].prodName;
                            // 2019/12/30 会計機能、会計画面でプランの内訳を編集出来るように WGCH END
                            tabStrBody += "<input type='hidden' value='" + result[i].sobjId + "' id='" + g_currRowIndex + "_" + i + "' /></td>";
                            tabStrBody += "<td style='background-color: #FFEBCD;text-align: right;'>";
                            // 2019/07/30 軽減税率機能対応 WGCH BEGIN
                            // 2019/12/30 会計機能、会計画面でプランの内訳を編集出来るように WGCH BEGIN
                            tabStrBody += "<input type='hidden' id='" + g_currRowIndex + "_prodid_" + i + "' value='" + productId + "' />";
                            // 2019/12/30 会計機能、会計画面でプランの内訳を編集出来るように WGCH END
                            tabStrBody += "<input type='hidden' id='" + g_currRowIndex + "_workHidTaxRate_" + i + "' value='" + result[i].prodTaxRate + "' />";
                            tabStrBody += "<input type='hidden' id='" + g_currRowIndex + "_workHidServiceTaxRate_" + i + "' value='" + result[i].prodServiceRate + "' />";
                            // 2019/12/30 会計機能、会計画面でプランの内訳を編集出来るように WGCH BEGIN
                            tabStrBody += "<input type='hidden' id='" + g_currRowIndex + "_workHidActType_" + i + "' value='" + actionType + "' />";
                            // tabStrBody += "<input type='text' style='text-align:right;' parentIndex='"+g_currRowIndex+"' data-actiontype='" + actionType + "' rowIndex='" + i + "' class='" + childcls + "' value='" + memoryPrice + "' taxflg='" + prodtaxflg + "' /></td></tr>";
                            tabStrBody += "<input type='text' id='" + g_currRowIndex + "_prodPrice_" + i + "' style='text-align:right;' parentIndex='"+g_currRowIndex+"' data-actiontype='" + actionType + "' rowIndex='" + i + "' class='" + childcls + "' value='" + memoryPrice + "' taxflg='" + prodtaxflg + "' /></td></tr>";
                            // 2019/12/30 会計機能、会計画面でプランの内訳を編集出来るように WGCH END
                            // 2019/07/30 軽減税率機能対応 WGCH END

                            planSyncInf += result[i].sobjId + ':' + memoryPrice.replaceAll(",","") + ';';
                        }
                        var summaryPriceId = g_currRowIndex + "_summary";
                        $(obj).parents("tr .tranDetailRow").after(tabStrHead + tabStrBody + tabStrFoot.replace("$summaryPriceId$",summaryPriceId));

                        // 連携用情報、HIDDEN項目に格納する
                        // $("input[id$=':" + g_currRowIndex + ":hidSyncInfo']").val(planSyncInf);
                        prod.set('PlanDetailSyncInfo__c',planSyncInf);
                        // 単価合計値計算して、プランの単価へ反映する
                        //old value input
                        $("[class='"+ childcls +"']").unbind("keydown");
                        $("[class='"+ childcls +"']").on('keydown', function(e){
                            $(this).data("olddata",$(this).val().replaceAll(",",""));
                        });
                        // 2018/07/27 宿泊税計算 WGCH BEGIN
                        $("[class='"+ childcls +"']").focus(function(){
                            $(this).data("olddata",$(this).val().replaceAll(",",""));
                        });
                        // 2018/07/27 宿泊税計算 WGCH END
                        // Event Binding
                        $("[class='"+ childcls +"']").unbind("keyup");
                        $("[class='"+ childcls +"']").on('keyup', function(e){
                            var price = $(this).val().replaceAll(",","");
                            var oldValue = $(this).data("olddata");
                            if(oldValue == price)return;
                            var parentRowIndex = $(this).attr("parentIndex");
                            setTimeout(function(){__reComputePrice(childcls,parentRowIndex);},500);
                        });
                        $("[class='"+ childcls +"']").unbind("blur");
                        $("[class='"+ childcls +"']").on('blur', function(e){
                            var price = $(this).val().replaceAll(",","");
                            if (!$.isNumeric(price)) price = "0";
                            $(this).val(commUtils.numFormat(price));
                        });
                        // 2019/12/30 会計機能、会計画面でプランの内訳を編集出来るように WGCH BEGIN
                        if(isPlanEditFlg){
                            // 入力の商品コードで、商品自動設定を行う
                            var groupIndex = g_currRowIndex;
                            // 作成した項目は自動商品コードのAutoComplete機能を追加する
                            $("input[id^='"+groupIndex+"_prodName_']").autocomplete({
                                minLength: 1,
                                source: function (request, response) {
                                    Visualforce.remoting.Manager.invokeAction(
                                        "{!$RemoteAction.BillSimpleInputCtrl.getArrayProductItemInfoNoPlan}", request.term, function(result, event){
                                        if (event.type == 'exception') {
                                            alert(event.message);
                                        } else {
                                            response($.map(result, function (item) {
                                                item.id = item.productId;
                                                item.value = item.prodcutName + "("+item.prodcutCode+")";
                                                return item;
                                            }));
                                        } // End else
                                    });
                                },
                                focus: function (event, ui) {
                                    var rowidx = $(this).attr("rowidx");
                                    ui.item.rowIndex = rowidx;
                                    ui.item.groupIndex = $(this).attr("parentIndex");
                                    // 2019/04/30 増税仮対応 WGCH BEGIN
                                    autoGetChildProductInfo(ui.item, CUST_AUTOGETPRODUCTMODE_RETURN);
                                    // 2019/04/30 増税仮対応 WGCH END
                                    return false;
                                },
                                select: function (event, ui) {
                                    var rowidx = $(this).attr("rowidx");
                                    ui.item.rowIndex = rowidx;
                                    ui.item.groupIndex = $(this).attr("parentIndex");
                                    autoGetChildProductInfo(ui.item);
                                    return false;
                                },
                            });
                        }
                        // 2019/12/30 会計機能、会計画面でプランの内訳を編集出来るように WGCH END
                        _autoGetSetupSyncInfo(g_currRowIndex);
                    }

                } else if (event.type === 'exception') {
                    // データ詳細がありません。
                    $(obj).parents("tr .tranDetailRow").after("<tr><td colspan='10' style='margin-left: 200px;' >{!$Label.MSG_006_0235}</td></tr>");
                } else {
                    // データ詳細がありません。
                    $(obj).parents("tr .tranDetailRow").after("<tr><td colspan='10' style='margin-left: 200px;' >{!$Label.MSG_006_0235}</td></tr>");
                }
            },
            {escape: true}
        );
        //$(obj).parent().parent().parent().after("<tr><td colspan='10' style='margin-left: 200px;' ><table><tr><td>444</td><td>555</td><td>666</td></tr></table> </td></tr> ");
    } else {
        $(obj).attr("src","{!URLFOR($Resource.AppImages, 'extend/jiahao.png')}");
        $(obj).attr("openStatus","false");
        //展開
        $(obj).attr("title","{!$Label.MSG_006_0214}");
        $(obj).parents("tr .tranDetailRow").next().remove();
    }
}
function _autoGetSetupSyncInfo(groupIndex) {
    var planSyncInf = "";
    var sumVal = 0;
    var isHaveShituliaoFlag = false;
    var ExcTaxPrice = 0;
    var prod = J_ACCOUNT_CENTER.get(groupIndex);
    //$("[class='"+ childcls +"']").each(function(idx){
    $("input.showDetailEvent"+groupIndex+"_child").each(function(idx){
        var hidFieldId = groupIndex + "_" + $(this).attr("rowIndex");
        // 見積明細ID/プラン明細ID ： 単価 ： 会計商品ID ： 会計商品名
        var unitPrice = $(this).val().replaceAll(",","");
        if(unitPrice == "" || !unitPrice || isNaN(parseFloat(unitPrice)) ) unitPrice = 0;
        sumVal = commUtils.mathNumAdd(sumVal,unitPrice);
        // 2019/12/30 会計機能、会計画面でプランの内訳を編集出来るように WGCH BEGIN
        // planSyncInf += $("#"+hidFieldId).val() + ':' + unitPrice + ';';
        if(isPlanEditFlg){
            var rowidx = $(this).attr("rowIndex");
            var hidProdId = groupIndex + "_prodid_" + rowidx;
            var hidProdNm = groupIndex + "_prodName_" + rowidx;
            // 見積明細ID/プラン明細ID ： 単価 ： 会計商品ID ： 会計商品名
            planSyncInf += $("#"+hidFieldId).val() + ':' + unitPrice + ':' + $("#"+hidProdId).val()+ ':' + $("#"+hidProdNm).val() +';';
            var actionType = $("#"+groupIndex+"_workHidActType_" + rowidx).val();
            planItemTypeMap.set((groupIndex + "_t_" + $("#"+hidFieldId).val()), actionType);
        } else planSyncInf += $("#"+hidFieldId).val() + ':' + unitPrice + ';';
        // 2019/12/30 会計機能、会計画面でプランの内訳を編集出来るように WGCH END
        // 2015/10/16 プラン明細課税、非課税混在合計金額計算対応 BEGIN
        if($(this).attr("taxflg") != 1) {
            ExcTaxPrice = commUtils.mathNumAdd(ExcTaxPrice,unitPrice);
        }
        var actionType = $(this).data("actiontype");
        if(actionType == _CONST_PRICE_ROOM_TYPE)
            isHaveShituliaoFlag = true;
    });
    var summaryPriceId = groupIndex + "_summary";
    var summaryPriceInputFlag = $("#"+summaryPriceId).is('input');
        // 合計値でプランの単価に反映する
    if(isHaveShituliaoFlag){
        if(summaryPriceInputFlag){
            $("#"+summaryPriceId).val(sumVal);
        }else{
            $("#"+summaryPriceId).replaceWith('<input type="text" id="' + summaryPriceId + '" style="text-align:right;" value="' + commUtils.numFormat(sumVal) + '" />');
            $("#"+summaryPriceId).keydown(function(){
                $(this).data("olddata",$(this).val().replaceAll(",",""));
            });
            // 2018/07/27 宿泊税計算 WGCH BEGIN
            $("#"+summaryPriceId).focus(function(){
                $(this).data("olddata",$(this).val().replaceAll(",",""));
            });
            // 2018/07/27 宿泊税計算 WGCH END
            $("#"+summaryPriceId).unbind("keyup");
            $("#"+summaryPriceId).keyup(function(e){
                //if((e.keyCode<48 || e.keyCode>57) && e.keyCode!=46 && e.keyCode != 8 ) return;
                var price = $(this).val().replaceAll(",","");
                if(price == $(this).data("olddata")) return;
                setTimeout(function(){__reComputeShitulyou(groupIndex,summaryPriceId);},300);
            });
        }
    }else if(summaryPriceInputFlag)
            $("#"+summaryPriceId).replaceWith('<span id="' + summaryPriceId + '" style="float:right;margin-right: 3px">' + commUtils.numFormat(sumVal) +'</span>');
    else $("#"+summaryPriceId).text(commUtils.numFormat(sumVal));
    // 2021/04/31 #10802 bug fixed by zy BEGIN
    prod.set({PlanDetailSyncInfo__c:planSyncInf,isNoUpdate:false});
    // 2021/04/31 #10802 bug fixed by zy END
    return planSyncInf;
}
function __reComputeShitulyou(groupIndex,summaryPriceId){
    var otherPrice = 0;
    var ExcTaxPrice = 0;
    var childcls = "showDetailEvent" + groupIndex + "_child";
    var planSyncInf = "";
    var prod = J_ACCOUNT_CENTER.get(groupIndex);
    //var hadShitulyouElement = $("input[id^='" + groupIndex + "_workHidActType_'][value='" + _CONST_PRICE_ROOM_TYPE + "']:eq(0)");
    // 合計値計算を行う
    $("[class='"+ childcls +"']:not([data-actiontype = '" + _CONST_PRICE_ROOM_TYPE + "'])").each(function(idx){
        var unitPrice = $(this).val().replaceAll(",","");
        var hidFieldId = groupIndex + "_" + $(this).attr("rowIndex");
        if(unitPrice == "" || !unitPrice || isNaN(parseFloat(unitPrice)) ) unitPrice = 0;
        otherPrice = commUtils.mathNumAdd(otherPrice,unitPrice);
        // 2019/12/30 会計機能、会計画面でプランの内訳を編集出来るように WGCH BEGIN
        // planSyncInf += $("#"+hidFieldId).val() + ':' + unitPrice + ';';
        if(isPlanEditFlg){
            var rowidx = $(this).attr("rowIndex");
            var hidProdId = groupIndex + "_prodid_" + rowidx;
            var hidProdNm = groupIndex + "_prodName_" + rowidx;
            // 見積明細ID/プラン明細ID ： 単価 ： 会計商品ID ： 会計商品名
            planSyncInf += $("#"+hidFieldId).val() + ':' + unitPrice + ':' + $("#"+hidProdId).val()+ ':' + $("#"+hidProdNm).val() +';';
        } else planSyncInf += $("#"+hidFieldId).val() + ':' + unitPrice + ';';
        // 2019/12/30 会計機能、会計画面でプランの内訳を編集出来るように WGCH END
        // 2015/10/16 プラン明細課税、非課税混在合計金額計算対応 BEGIN
        if($(this).attr("taxflg") != 1) {
            ExcTaxPrice = commUtils.mathNumAdd(ExcTaxPrice,unitPrice);
        }
    });
    var firstShituLyoElement;
    $("[class='"+ childcls +"'][data-actiontype = '" + _CONST_PRICE_ROOM_TYPE + "']").each(function(idx){
        var unitPrice = $(this).val().replaceAll(",","");
        if(unitPrice == "" || !unitPrice || isNaN(parseFloat(unitPrice)) ) unitPrice = 0;
        if(!firstShituLyoElement){ 
            firstShituLyoElement = $(this);
            return true;
        }
        var hidFieldId = groupIndex + "_" + $(this).attr("rowIndex");
        otherPrice = commUtils.mathNumAdd(otherPrice,unitPrice);
        // 2019/12/30 会計機能、会計画面でプランの内訳を編集出来るように WGCH BEGIN
        // planSyncInf += $("#"+hidFieldId).val() + ':' + unitPrice + ';';
        if(isPlanEditFlg){
            var rowidx = $(this).attr("rowIndex");
            var hidProdId = groupIndex + "_prodid_" + rowidx;
            var hidProdNm = groupIndex + "_prodName_" + rowidx;
            // 見積明細ID/プラン明細ID ： 単価 ： 会計商品ID ： 会計商品名
            planSyncInf += $("#"+hidFieldId).val() + ':' + unitPrice + ':' + $("#"+hidProdId).val()+ ':' + $("#"+hidProdNm).val() +';';
        } else planSyncInf += $("#"+hidFieldId).val() + ':' + unitPrice + ';';
        // 2019/12/30 会計機能、会計画面でプランの内訳を編集出来るように WGCH END
        // 2015/10/16 プラン明細課税、非課税混在合計金額計算対応 BEGIN
        if($(this).attr("taxflg") != 1) {
            ExcTaxPrice = commUtils.mathNumAdd(ExcTaxPrice,unitPrice);
        }
    }); 
    var summaryElement = $("#" + summaryPriceId);
    var summaryPrice = summaryElement.val().replaceAll(",","");
    if(summaryPrice == "" || !summaryPrice || isNaN(parseFloat(summaryPrice)) ) summaryPrice = 0;
    var changePrice = commUtils.mathNumSub(parseFloat(summaryPrice), otherPrice);
    //var firstShituLyoElement = $("[class='"+ childcls +"'][data-actiontype = '" + _CONST_PRICE_ROOM_TYPE + "']:eq(0)");
    firstShituLyoElement.val(changePrice);
    var hidFieldId = groupIndex + "_" + firstShituLyoElement.attr("rowIndex");
    ExcTaxPrice = commUtils.mathNumAdd(ExcTaxPrice,changePrice);
    planSyncInf += $("#"+hidFieldId).val() + ':' + changePrice + ';';
    var parentRowIndex = firstShituLyoElement.attr("parentindex");
    var curRow = J_ACCOUNT_CENTER.currentRows.eq(parentRowIndex);
    J_ACCOUNT_CENTER.getRowDom(curRow).priceInput.val(summaryPrice);
    // 2021/04/31 #10802 bug fixed by zy BEGIN
    prod.set({initPlanInfo : ExcTaxPrice,PlanDetailSyncInfo__c : planSyncInf,isNoUpdate:false});
    // 2021/04/31 #10802 bug fixed by zy END
    J_ACCOUNT_CENTER.updProduct(parentRowIndex);
    consoleLog('__reComputeShitulyou');
    // 2013/11/08 単価計算後、総金額計算を行う
    // J_ACCOUNT_CENTER.refresh(prod);
    /*
    var rowIndex = $("input[id$=':"+ parentRowIndex + ":clearProduct']").attr("rowIndex");
    setupInvoiceNoShowFlg(rowIndex, false);
    */
}
// 2019/12/30 会計機能、会計画面でプランの内訳を編集出来るように WGCH BEGIN
var isPlanEditFlg = {!isPlanEditFlg};
var planItemTypeMap = new Map();
function openChildProdutWin(groupIndex,rowIndex) {
    var dumyField = $("#"+groupIndex+"_workHidItem").get(0);
    // 引き渡し値を設定して、選択画面を開く
    ctrlNm = $("#"+groupIndex+"_prodName_"+rowIndex).get(0);
    ctrlId = $("#"+groupIndex+"_prodid_" + rowIndex).get(0);
    ctrlHidNm = dumyField;
    ctrlPriceId = dumyField;
    ctrlOrderNumId = dumyField;
    ctrlTaxRate = dumyField;
    ctrlHidTaxRate = dumyField;
    ctrlServiceTaxRate = dumyField;
    ctrlHidServiceTaxRate = dumyField;
    // 2019/07/30 軽減税率機能対応 WGCH BEGIN
    if(isReducedTaxFlg){
        var taxRateField = $("#"+groupIndex+"_workHidTaxRate_"+rowIndex).get(0);
        ctrlTaxRate = taxRateField;
        ctrlHidTaxRate = taxRateField;
        var serviceTaxRateField = $("#"+groupIndex+"_workHidServiceTaxRate_"+rowIndex).get(0);
        ctrlServiceTaxRate = serviceTaxRateField;
        ctrlHidServiceTaxRate = serviceTaxRateField;
    }
    // 2019/07/30 軽減税率機能対応 WGCH END
    ctrlSpecialTax = dumyField;
    ctrlHidSpecialTax = dumyField;
    ctrlHidActionType = $("#"+groupIndex+"_workHidActType_" + rowIndex).get(0);
    var openUrl = "/apex/ProductSearch?np=1";
    // 呼び出し順番とPOPUP画面の設定順番は必ず一致するが必要
    objs = new Array(ctrlNm, ctrlId, ctrlHidNm, ctrlPriceId, ctrlOrderNumId,
        ctrlTaxRate, ctrlHidTaxRate, ctrlServiceTaxRate, ctrlHidServiceTaxRate, ctrlSpecialTax, ctrlHidSpecialTax, ctrlHidActionType);
    commUtils.popup(openUrl, "SearchProductInfo", objs, null, null, popupChildCallback(groupIndex));
}
function popupChildCallback(groupIndex) {
    return function() {
        _autoGetSetupSyncInfo(groupIndex)
        // 2021/04/31 #10650 bug fixed by zy BEGIN
        J_ACCOUNT_CENTER.refresh();
        // 2021/04/31 #10650 bug fixed by zy END
    }
}
// 2019/04/30 増税仮対応 WGCH BEGIN
function autoGetChildProductInfo(result, mode) {
// 2019/04/30 増税仮対応 WGCH END
    var rowIndex = result.rowIndex;  
    var groupIndex = result.groupIndex;
    $("#"+groupIndex+"_prodName_"+rowIndex).val(result.prodcutName);
    $("#"+groupIndex+"_prodid_" + rowIndex).val(result.productId);
    $("#"+groupIndex+"_workHidActType_" + rowIndex).val(result.actionType);
    // 2019/07/30 軽減税率機能対応 WGCH BEGIN
    // 消费税
    $("#"+groupIndex+"_workHidTaxRate_"+rowIndex).val(result.tax);
    // サビース料
    $("#"+groupIndex+"_workHidServiceTaxRate_"+rowIndex).val(result.serviceRate);
    // 2019/07/30 軽減税率機能対応 WGCH END
    _autoGetSetupSyncInfo(groupIndex);
    // 2021/04/31 #10650 bug fixed by zy BEGIN
    J_ACCOUNT_CENTER.refresh();
    // 2021/04/31 #10650 bug fixed by zy END
}
// 2019/12/30 会計機能、会計画面でプランの内訳を編集出来るように WGCH END
function __reComputePrice(childcls,parentRowIndex){
    var sumVal = 0;
    // 2015/10/16 プラン明細課税、非課税混在合計金額計算対応 BEGIN
    var ExcTaxPrice = 0;
    // 2015/10/16 プラン明細課税、非課税混在合計金額計算対応 END
    // 合計値計算を行う
    $("[class='"+ childcls +"']").each(function(idx){
        var hidFieldId = parentRowIndex + "_" + $(this).attr("rowIndex");
        var unitPrice = $(this).val().replaceAll(",","");
        if(unitPrice == "" || !unitPrice || isNaN(parseFloat(unitPrice)) ) unitPrice = 0;
        //sumVal += 1 * unitPrice;
        sumVal = commUtils.mathNumAdd(sumVal,unitPrice);
        // 2015/10/16 プラン明細課税、非課税混在合計金額計算対応 BEGIN
        if($(this).attr("taxflg") != 1) {
            ExcTaxPrice = commUtils.mathNumAdd(ExcTaxPrice,unitPrice);
        }
     });
    /*
     $("input:hidden[id$=':" + parentRowIndex + ":hidPlandetail']").val(ExcTaxPrice);
     // 2015/10/16 プラン明細課税、非課税混在合計金額計算対応 END
     // 合計値でプランの単価に反映する
     $("input[id$=':"+ parentRowIndex + ":price']").val(sumVal);
     // 2013/11/08 単価計算後、総金額計算を行う
     var rowIndex = $("input[id$=':"+ parentRowIndex + ":clearProduct']").attr("rowIndex");
     */
    // 合計値でプランの単価に反映する
    var prod = J_ACCOUNT_CENTER.get(parentRowIndex);
    // 当前行
    var curRow = J_ACCOUNT_CENTER.currentRows.eq(parentRowIndex);
    J_ACCOUNT_CENTER.getRowDom(curRow).priceInput.val(sumVal);
    prod.set({initPlanInfo : ExcTaxPrice});
    J_ACCOUNT_CENTER.updProduct(parentRowIndex);
     _autoGetSetupSyncInfo(parentRowIndex);
     // setupInvoiceNoShowFlg(rowIndex, false);
}
var g_currRowIndex = 0;

//2017/04/19 レシート印刷機能追加　by zy BEGIN
// 最新支払い情報を取得する
function autoGetPayProductInfo(result) {
    //2017/03/17 お釣りプリンター機能　by zy BEGIN
    if (changeChk(result)) {
        paymentBtn(result);
    }
    //2017/03/17 お釣りプリンター機能　by zy END
}
// 最新商品情報を取得する
// 2019/04/30 増税仮対応 WGCH BEGIN
/*
function autoGetProductInfo(result){
    paymentBtn(result);
}
*/
function autoGetProductInfo(result, mode){
    paymentBtn(result, null, mode);
}
// 2019/04/30 増税仮対応 WGCH END
//2017/04/19 レシート印刷機能追加　by zy END
 // 2017/08/10 入金自動レシート印刷機能追加　by　zy BEGIN
// 2019/04/30 増税仮対応 WGCH BEGIN
// function paymentBtn(result,remoteflag){
function paymentBtn(result,remoteflag,mode){
// 2019/04/30 増税仮対応 WGCH END
 // 2017/08/10 入金自動レシート印刷機能追加　by　zy END
    // 2015/04/11 会計明細タブはActive場合、設定可能 BEGIN
    // 2021/03/04 CPU LIMITの最適化 BUG[#PC9837] WGCH BEGIN
    // var tabStrip = $("#tabstrip").kendoTabStrip().data("kendoTabStrip");
    var tabStrip = $("#tabstrip").data("kendoTabStrip");
    if (!tabStrip) {
       tabStrip = $("#tabstrip").kendoTabStrip().data("kendoTabStrip");
    }
    // 2021/03/04 CPU LIMITの最適化 BUG[#PC9837] WGCH END
    var activeTabId = tabStrip.select().attr("id");
    if (activeTabId != "tab_trandetail") return;
    // 2015/04/11 会計明細タブはActive場合、設定可能 END
    return paymentBtnBill(result,remoteflag,mode);
    }
function paymentBtnBill(result,remoteflag,mode){
    // 2015/06/16 割引％計算機能設定 BEGIN
    J_ACCOUNT_CENTER.addProduct(result,mode);
    // 保存数据并打印信息,行追加时不执行
    if (remoteflag && g_currRowIndex != undefined) saveAccount();
     // 2017/08/10 入金自動レシート印刷機能追加　by　zy END
     // 2018/06/12 SCANER機能新規 by zy BEGIN
    if (curGuuid != undefined && curGuuid != "") $j("tr.tranDetailRow").eq(g_currRowIndex).attr("scanUid",curGuuid);
    // 2018/06/12 SCANER機能新規 by zy END
}
// 会計書情報はHIDDEN項目に設定する
function copySelectValToHidden() {
    // 2017/09/06 会計メッセージ項目自定義機能追加 by zy BEGIN
    // 非空数据判断
    if (checkRequired()) {
        $("#inputFormErrorMsg").show();
        $(window).scrollTop(0);
        return false;
    }
    // 2017/09/06 会計メッセージ項目自定義機能追加 by zy END
    $("input:hidden[id$=':hidAccountId']").val($("[id$=':accountNameSel']").val());
    $("input:hidden[id$=':hidReceiptId']").val($("[id$=':accountReciptSel']").val());
    $("input:hidden[id$=':hidProvisoId']").val($("[id$=':accountProvisoSel']").val());
    // 操作ログは項目に設定する
    // 2016/02/25 Log Output BEGIN
    var logLine = "会計保存,," + Date.now();
    logger.push(logLine);
    // DBへ反映項目を設定
    $("input:hidden[id$=':hidClientLogId']").val(logger.join("{!JSENCODE(clinetLogSplitChar)}"));
    logger = new Array();
    // 2016/02/25 Log Output END
    J_ACCOUNT_CENTER.beforeSave();
    // 2017/09/06 会計メッセージ項目自定義機能追加 by zy BEGIN
    return true;
    // 2017/09/06 会計メッセージ項目自定義機能追加 by zy END
}

// Disable Button
function buttonsEnabled(enabled) {
    // retrieve all of the buttons or links on the page
    // with the css class of btn
    var $buttons = $('.btn');
    if (enabled === false) {
        // add the btnDisabled class to give it the look of being disabled
        // add the disabled attribute to actually disable interactability
        $buttons.toggleClass('btnDisabled', true).attr('disabled', 'disabled');
    } else {
        // remove the css class and the disabled attribute
        $buttons.toggleClass('btnDisabled', false).attr('disabled', null);
        // Remove BlockUI
        JINYACONNECT.unblockUi();
    } 
}
// -------------------
// 会計書一括印刷画面起動
// 画面指定のパラメータにより、会計書一括起動を行う(会計書直接起動)
// -------------------
function directOpenAccountPdf() {
    // 2015/10/30 多店舗兼務の場合、店舗選択できるWINを表示対応 BEGIN
    var accStrShopSelectHtml = locGetMulitiShopsHtml("");
    //2017/04/19 レシート印刷機能追加　by zy BEGIN
    if (accStrShopSelectHtml != "" || chkPrintReady() ) {
    //if (accStrShopSelectHtml != "" ) {
    //2017/04/19 レシート印刷機能追加　by zy END
        return openAccoPdfWin();
    }
    // 2015/10/30 多店舗兼務の場合、店舗選択できるWINを表示対応 END
    // 領収証宛名＝画面の領収証宛名 >> 画面のご請求先 >> 画面のお客様
    var strReceiptName = $("[id$=':accountReciptSel']").val();
    // 領収証但し
    var strReovisoSel = $("[id$=':accountProvisoSel']").val();
    // 会計書宛名
    var strAccountName = $("[id$=':accountNameSel']").val();
    // 引き渡しパラメータを連結する
    var custNameUrl = "&cuName=" + encodeURIComponent(strAccountName);
    // 2015/05/11 直接印刷の場合、画面の宛名を取得、印刷パラメータに設定する
    //if (strReceiptName.length > 0) {
        custNameUrl += "&recpName=" + encodeURIComponent(strReceiptName);
    //}
    //if (strReovisoSel.length > 0) {
        custNameUrl += "&accountProviso=" + encodeURIComponent(strReovisoSel);
    //}
    // 領収証日付
    var strAccountReceiptDate = $("[id$=':accountReceiptDate']").val();
    if ($.trim(strAccountReceiptDate).length > 0) {
        custNameUrl += "&accRepDt=" + encodeURIComponent(strAccountReceiptDate);
    }else {
        custNameUrl += "&accRepDt=";
    }
    // 利用日登録期間を取得する
    custNameUrl += locGetUseDataRangeParam();
    
    var idList = $.parseJSON($("#hidRelAccountIds").val());
    if (idList.length > 0) {
        var currAccId = $("#hidCurrAccountId").val();
        var openUrl = "{!URLFOR('/apex/' & $Setup.CommDefine__c.AppNS__c & 'AccountPdfBulkSelector')}?id="+currAccId;
        // 2019/10/30 会計書、請求書のマージ機能対応 WGCH BEGIN
        if(isPdfMergeFlg) openUrl = getBukkUrl(currAccId, false);
        // 2019/10/30 会計書、請求書のマージ機能対応 WGCH END
        window.open(openUrl+custNameUrl);
    }
}
// -------------------
// 会計書印刷画面起動
// 画面指定のパラメータにより、会計書ポップ画面起動を行う
// -------------------
function openAccoPdfWin () {

    var d = sfdcPage.dialogs['AccoPdfStartDialog'], close;
    if (!d) {
        // if the dialog doesn't exist create one
        d = sfdcPage.dialogs['AccoPdfStartDialog'] = new SimpleDialog('AccoPdfStartDialog', false);
        // set general information on your dialog and finally run the create function
        d.setWidth(420);
        d.createDialog();
    }
    //会計書
    d.setTitle('{!$Label.MSG_006_0226}');
    
    // 請求宛名入力項目表示可否判断
    var receiptHtml = "";
    // 施設コード
    var facilityCode = "{!JSENCODE(oFacilityCode)}";
    // 下記会計書の場合、領収書項目存在
    if (isHaveReceiptFun(facilityCode)) {
        // 領収証宛名＝画面の領収証宛名 >> 画面のご請求先 >> 画面のお客様
        var strReceiptName = $("[id$=':accountReciptSel']").val();
        if ($.trim(strReceiptName) == "") strReceiptName = $("span[id$=':accountName']").text();
        if ($.trim(strReceiptName) == "") strReceiptName = $("[id$=':inp_contactName']").val();
        strReceiptName = strReceiptName.replace(/\"/g, '&quot;');
        // 領収証但し
        var strReovisoSel = $("[id$=':accountProvisoSel']").val();
        strReovisoSel = strReovisoSel.replace(/\"/g, '&quot;');
        // Hmtl出力
        //領収証宛名
        receiptHtml += '<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0227}</label></td><td class="data2Col first "><input id="dialog_receiptName" type="text" style="width:90%" value="'+strReceiptName+'"/></td></tr>';
        //領収証但し
        receiptHtml += '<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0228}</label></td><td class="data2Col first "><input id="dialog_accountProviso" type="text" style="width:90%" value="'+strReovisoSel+'"/></td></tr>';
    }

    // 一括印刷（室料・朝食・ALL）
    //一括印刷  室料      室料・朝食       ALL
    var mergePrint = '<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0229}</label></td><td class="data2Col first "><select id="dialog_printType"><option value="r">{!$Label.MSG_006_0230}</option><option value="rf">{!$Label.MSG_006_0231}</option><option value="" selected>{!$Label.MSG_006_0232}</option></select></td></tr>';
    // 一括印刷項目表示のパラメータ切替
    if ({!accountPrintTypeIsShowFlg}.toString().toLowerCase() != "true") {
        mergePrint = '';
    }
    // 2015/04/13 会計書宛名
    var strAccountName = $("[id$=':accountNameSel']").val();
    if ($.trim(strAccountName) == "") {
        strAccountName = $("[id$=':inp_contactName']").val();
    }
    strAccountName = strAccountName.replace(/\"/g, '&quot;');
    // 言語リスト
    var strLanguageVal = $("[id$=':languageSel']").val();
    var strLanguageJpn = "";
    var strLanguageEng = "";
    if (strLanguageVal == "jp") strLanguageJpn=" selected ";
    if (strLanguageVal != "jp") strLanguageEng=" selected ";
    //日本語       英語
    strLanguageSelectHtml = '<select id="dialog_language"><option value="jp"'+strLanguageJpn+'>{!$Label.MSG_006_0234}</option><option value="en"'+strLanguageEng+'>{!$Label.MSG_006_0236}</option></select>';
    // give your dialog some content (I usually use an iframe linking to another visualforce page
    // change the url, height, width to your needs
    var accoPrefixKey = '_acco_';
    var accStrShopSelectHtml = locGetMulitiShopsHtml(accoPrefixKey);
    // 2017/04/12 会計書の領収書欄を表示する・しない選択できる制御フラグ[BUGFIX]
    var accReceiptOptHtml = locGetAccReceiptOptHtml(facilityCode);  
    //2017/04/24 レシート印刷機能追加　by zy BEGIN
    var reshitoBtnHtml = locPrintTypeHtml();
    // 2018/04/27 会計書ハンコ表示・非表示機能対応 BEGIN by zh
    // ハンコ表示・非表示制御初期値設定 
    var stampIsShowFlgStr = {!accStampIsShowFlg} ? "checked=\'checked\'" : ""; 
    // 2018/04/27 会計書ハンコ表示・非表示機能対応 END by zh
    // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz BEGIN
    var RespectFlg = $("#hidRespectFlg").val();
    var mrSelectHtml = respectHtml(facilityCode,RespectFlg,"accmultiselectId");
    // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz END
    
    //会計書宛名     言語      キャンセル       会計書作成
    //$(d.dialog).find('#AccoPdfStartDialogInner').html('<div class="pbBody" id=""><div><div class="pbSubsection"><table class="detailList" style="table-layout: fixed;width: 400px;" border="0" cellpadding="1" cellspacing="1">'+accStrShopSelectHtml+'<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0237}</label></td><td class="data2Col first "><input id="dialog_acc_accName" type="text" style="width:90%" value="'+strAccountName+'"/></td></tr>' + receiptHtml + mergePrint + '<tr style="vertical-align: top;"><td class="labelCol "><label>{!$Label.MSG_006_0238}</label></td><td class="data2Col ">'+strLanguageSelectHtml+'</td></tr>'+accReceiptOptHtml+'<tr><td colspan="2" style="text-align: center;padding-top:10px"><input class="btn" id="dialog_cancelBtn" style="width: 100px" type="button" value="{!$Label.MSG_006_0239}" /> <input class="btn" id="dialog_printoutBtn_acc" style="min-width: 100px" type="button" value="{!$Label.MSG_006_0240}" /></td></tr></table></div></div></div>');
    //$(d.dialog).find('#AccoPdfStartDialogInner').html('<div class="pbBody" id=""><div><div class="pbSubsection"><table class="detailList" style="table-layout: fixed;width: 400px;" border="0" cellpadding="1" cellspacing="1">'+accStrShopSelectHtml+'<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0237}</label></td><td class="data2Col first "><input id="dialog_acc_accName" type="text" style="width:90%" value="'+strAccountName+'"/></td></tr>' + receiptHtml + mergePrint + '<tr style="vertical-align: top;"><td class="labelCol "><label>{!$Label.MSG_006_0238}</label></td><td class="data2Col ">'+strLanguageSelectHtml+'</td></tr>'+accReceiptOptHtml+ reshitoBtnHtml +'<tr><td colspan="2" style="text-align: center;padding-top:10px"><input class="btn" id="dialog_cancelBtn" style="width: 100px" type="button" value="{!$Label.MSG_006_0239}" /> <input class="btn" id="dialog_printoutBtn_acc" style="min-width: 100px" type="button" value="{!$Label.MSG_006_0240}" /></td></tr></table></div></div></div>');
    $(d.dialog).find('#AccoPdfStartDialogInner').html('<div class="pbBody" id=""><div><div class="pbSubsection"><table class="detailList" style="table-layout: fixed;width: 400px;" border="0" cellpadding="1" cellspacing="1">'+accStrShopSelectHtml+'<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0237}</label></td><td class="data2Col first "><input id="dialog_acc_accName" type="text" style="width:90%" value="'+strAccountName+'"/></td></tr>' + receiptHtml + mergePrint
    // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz BEGIN
    +mrSelectHtml
    // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz END
    +'<tr style="vertical-align: top;"><td class="labelCol "><label>{!$Label.MSG_006_0238}</label></td><td class="data2Col ">'+strLanguageSelectHtml+'</td></tr>'
    // 2018/04/27 会計書ハンコ表示・非表示機能対応 BEGIN by zh
    +'<tr><td class="labelCol"><label>{!$Label.MSG_006_0220}</label></td><td class="data2Col first "><input type="checkbox" id="dialog_accStampIsShowFlg" ' + stampIsShowFlgStr + '/></td></tr>'    
    // 2018/04/27 会計書ハンコ表示・非表示機能対応 END by zh
    +accReceiptOptHtml+ reshitoBtnHtml +'<tr><td colspan="2" style="text-align: center;padding-top:10px"><input class="btn" id="dialog_cancelBtn" style="width: 100px" type="button" value="{!$Label.MSG_006_0239}" /> <input class="btn" id="dialog_printoutBtn_acc" style="min-width: 100px" type="button" value="{!$Label.MSG_006_0240}" /></td></tr></table></div></div></div>');   
    //2017/04/19 レシート印刷機能追加　by zy END
    $(d.dialog).find('input[type="button"]').on('click', function() {
        var btnId = $(this).attr("id");
        if (btnId == "dialog_cancelBtn") {
            d.hide();
        } else if (btnId == "dialog_printoutBtn_acc") {
            // 会計書画面を起動する
            var receiptNameLen = $("#dialog_receiptName").length;
            var receiptName = $("#dialog_receiptName").val();
            var accountProvisoLen = $("#dialog_accountProviso").length;
            var accountProviso = $("#dialog_accountProviso").val();
            var custName = $("#dialog_acc_accName").val();
            var language = $("#dialog_language").val();
            var printType = $("#dialog_printType").length > 0 ? $("#dialog_printType").val() : "";
            var accSelectShopLen = $("#"+accoPrefixKey+"dialog_shopcd").length;
            var accSelectShopVal = $("#"+accoPrefixKey+"dialog_shopcd").val();
            // 2018/04/27 会計書ハンコ表示・非表示機能対応 BEGIN by zh
            var stampIsShowFlg = $("#dialog_accStampIsShowFlg").prop('checked');
            // 2018/04/27 会計書ハンコ表示・非表示機能対応 END by zh
            // 2018/03/30 会計書の店舗切替を保存 WGCH BEGIN
            if(getSpcdCookieFlg()) setSpCdCookieFun('ACCSPCD', accSelectShopVal);
            // 2018/03/30 会計書の店舗切替を保存 WGCH END
            // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz BEGIN
            var mrTypeSelectVal = $("#accmultiselectId").val();
            // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz END

            var custNameUrl = "&cuName=" + encodeURIComponent(custName) + "&language=" + encodeURIComponent(language) + "&pType=" + encodeURIComponent(printType);
            if (receiptNameLen > 0) {
                custNameUrl += "&recpName=" + encodeURIComponent(receiptName);
            }
            if (accountProvisoLen > 0) {
                custNameUrl += "&accountProviso=" + encodeURIComponent(accountProviso);
            }
            // 領収証日付
            var strAccountReceiptDate = $("[id$=':accountReceiptDate']").val();
            if ($.trim(strAccountReceiptDate).length > 0) {
                custNameUrl += "&accRepDt=" + encodeURIComponent(strAccountReceiptDate);
            } else {
                custNameUrl += "&accRepDt=";
            }
            // 2018/04/27 会計書ハンコ表示・非表示機能対応 BEGIN by zh
            custNameUrl += "&stampFlg=" + encodeURIComponent(stampIsShowFlg);
            // 2018/04/27 会計書ハンコ表示・非表示機能対応 END by zh
            // 利用日登録期間を取得する
            custNameUrl += locGetUseDataRangeParam();
            if (accSelectShopLen > 0 && accSelectShopVal != "") {
                custNameUrl += "&shopcd=" + encodeURIComponent(accSelectShopVal);
            }
            // 2017/04/12 会計書の領収書欄を表示する・しない選択できる制御フラグ[BUGFIX] BEGIN
            var acccReceiptFlgLen = $("#dialog_accountReceipt").length;
            if(acccReceiptFlgLen > 0 && $("#dialog_accountReceipt").prop("checked") == false){
                custNameUrl += "&noreceipt=1";
            }
            // 2017/04/12 会計書の領収書欄を表示する・しない選択できる制御フラグ[BUGFIX] END
            // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz BEGIN
            if(RespectFlg == "true") custNameUrl += "&mr=" + mrTypeSelectVal;
            // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz END
            var idList = $.parseJSON($("#hidRelAccountIds").val());
            if (idList.length > 0) {
                //2017/04/24 印刷会計書判定　by zy BEGIN
                if(chkOpenOrRedict(custNameUrl)) return;
                //2017/04/24 印刷会計書判定　by zy END
                var currAccId = $("#hidCurrAccountId").val();
                var url = "{!URLFOR('/apex/' & $Setup.CommDefine__c.AppNS__c & 'AccountPdfBulkSelector')}?id="+currAccId;
                // 2019/10/30 会計書、請求書のマージ機能対応 WGCH BEGIN
                if(isPdfMergeFlg) url = getBukkUrl(currAccId, false);
                // 2019/10/30 会計書、請求書のマージ機能対応 WGCH END
                window.open(url+custNameUrl);
            }
            d.hide();
        }
    });
    // we also need to make sure we have a close button on the dialog
    if ($(d.dialog).find('#InlineEditDialogX').size() == 0) {
        // if there is none we create it
        close = $('<a id="InlineEditDialogX" title="Close" tabindex="0" href="javascript:void(0)" class="dialogClose">Close</a>');
        // add some functionality to the close button (for the default ui we change the classname on mouseover/out
        close.mouseover(function() {
            this.className = 'dialogCloseOn';
        }).mouseout(function() {
            this.className = 'dialogClose';
        }).click(function() {
            // finally our on click handler which closes the dialog
            d.hide();
        });
        // insert the new generated close button before the h2 tag so it'll show up on the top right corner
        close.insertBefore($(d.dialog).find('.topLeft h2'));
    }
    // now it's time to show the new dialog
    d.show();
    // 2018/03/30 会計書の店舗切替を保存 WGCH BEGIN
    if(getSpcdCookieFlg() && getAccSpcd() != '') $j("#_acco_dialog_shopcd").val(getAccSpcd());
    // 2018/03/30 会計書の店舗切替を保存 WGCH END
}
// -------------------
// 請求書一括印刷画面起動
// 画面指定のパラメータにより、請求書一括起動を行う
// -------------------
// 2018/05/08 請求書のコメント欄を毎回手打ちし自動 zyz BEGIN
function _getCommentHtml(){
    var commOpts = JSON.parse("{!JSENCODE(mulitiComments)}");
    var comHtml = "";
    var comment = "";
    var targetId = "dialog_comment";
    if (commOpts.length > 1) {
        var tHtml = '<select size="1" style="margin-bottom:1px;width:280px;height: 20px;" onchange="_commentSelectVal(\''+targetId+'\',this,this.value)">$$_OPTBODY_$$</select>';
        var oHtml = '<option value=""/>';
        for (i=0;i<commOpts.length;i++) {
            oHtml+='<option value="'+commOpts[i].val+'">'+commOpts[i].lab+'</option>';
        }
        comHtml = tHtml.replace('$$_OPTBODY_$$',oHtml);
    } else if (commOpts.length == 1) {
        comment = commOpts[0].val;
    }
    comHtml+='<textarea id="'+targetId+'"rows="4" style="width: 280px;">'+comment+'</textarea>';
    return comHtml;
}
// 選択内容はコメントに設定する
function _commentSelectVal(targetId, that, val) {
    $("#"+targetId).val(val).focus();
}
// 2018/05/08 請求書のコメント欄を毎回手打ちし自動 zyz END
// 2019/1/15 請求書に掲載する振込先口座情報を、同一店舗内で切り替えする BY cxw BEGIN
function _getFixedMsgHtml(){
    var html = '<tr style="vertical-align: top;" id="div_fixed_msg"><td class="labelCol "><label>口座情報</label></td><td class="data2Col"><div><div><select size="1" style="margin-bottom:1px;width:280px;height: 20px;" id="select_fixed_msg"></select></div></div></td></tr>';
    return html;
}

function bindSpcdChange(){
    var $spcd = $("#dialog_shopcd");
    if($spcd.length && !$spcd.data("CHANGE")){
        var param = $spcd[0];
        if(getSpcdCookieFlg() && getBillSpCd()){
            param = {};
            param['value'] = getBillSpCd();
        }
        spcdChange.call(param);
        $spcd.change(spcdChange);
        $spcd.data("CHANGE", true);
    }else spcdChange.call({value: "{!NULLVALUE($User.DefaultShopCode__c, '')}"});
}

function spcdChange(){
    var fixedMsg = JSON.parse("{!JSENCODE(jsonFixedMsg)}");
    var value = this.value;
    var showItems = [];
    showItems = showItems.concat(fixedMsg[""] || []).concat(value ? (fixedMsg[value] || []) : []);
    var $select = $("#select_fixed_msg").html("");
    var $div = $("#div_fixed_msg");
    if(!showItems.length) return $div.hide();
    var html = '<option value=""/>', def = false;
    for(var i = 0; i < showItems.length; i++) html += '<option value="'+ showItems[i].Msg +'" ' + (showItems[i].bDefault && !def ? (def = true,'selected') : '') + '>'+ showItems[i].Label +'</option>';
    $select.html(html);
    $select.show();
    $div.show();
}
// 2019/1/15 請求書に掲載する振込先口座情報を、同一店舗内で切り替えする BY cxw END
// 2019/10/30 会計書、請求書のマージ機能対応 WGCH BEGIN
var isPdfMergeFlg = ("{!isPdfMergeFlg}" == "true");
function getBukkUrl(currAccId, isBillFlg){
    var url = "{!URLFOR('/apex/' & $Setup.ps__CommDefine__c.ps__AppNS__c & 'AccountPdfBulkSelectorAll')}?id="+currAccId;
    if(isBillFlg) url += "&bill=1";
    return url;
}
// 2019/10/30 会計書、請求書のマージ機能対応 WGCH END
function openBillPdf () {
        
    var d = sfdcPage.dialogs['BillPdfStartDialog'], close;
    if (!d) {
        // if the dialog doesn't exist create one
        d = sfdcPage.dialogs['BillPdfStartDialog'] = new SimpleDialog('BillPdfStartDialog', false);
        // set general information on your dialog and finally run the create function
        d.setWidth(420);
        d.createDialog();
    }
    //請求書
    d.setTitle('{!$Label.MSG_006_0215}');

    // 2014/07/18 USD（通貨設定はJPY以外の場合、会計書為替レートにより、金額計算を行う)
    var locCurrency = "{!oDefaultCurrency}";
    var exchangeRateSelect = "";
    if (locCurrency != "JPY") {
        //通貨        JPY
        exchangeRateSelect = '<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0217}</label></td><td class="data2Col first "><select id="dialog_currencyType"><option value="JPY">{!$Label.MSG_006_0216}</option><option value="' + locCurrency + '">' + locCurrency + '</option></select></td></tr>';
    }
    // 2018/06/08 レシート印刷機能言語選択する WGCH BEGIN
    exchangeRateSelect += '<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0238}</label></td><td class="data2Col first "><select id="bill_dialog_language"><option value="jp" {!IF(oAcountSobj.AccountLanguage__c == "jp", "selected", "")}>{!$Label.MSG_006_0234}</option><option value="en" {!IF(oAcountSobj.AccountLanguage__c == "en", "selected", "")}>{!$Label.MSG_006_0236}</option></select></td></tr>';
    // 2018/06/08 レシート印刷機能言語選択する WGCH END
    // 2015/01/26 ハンコ表示・非表示制御初期値設定
    var stampIsShowFlg = "{!billStampIsShowFlg}";
    var stampIsShowFlgStr = "";
    if (stampIsShowFlg == "true") stampIsShowFlgStr = "checked=\'checked\'";
    // 2019/04/30 請求書の送付表新規作成 BY zyz BEGIN
    var shippingHtml = "";
    var letterIsShow = "{!billLetterFlg}";
    if(letterIsShow == "true"){
        shippingHtml = '<tr style="vertical-align: top;"><td class="labelCol "><label>送付状あり</label></td><td class="data2Col"><input type="checkbox" id="dialog_shipping" checked="checked"/></td></tr>';
    }
    // 2019/04/30 請求書の送付表新規作成 BY zyz END
    // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz BEGIN
    var RespectFlg = $("#hidRespectFlg").val();
    var mrSelectHtml = respectHtml("billpdf",RespectFlg,"billmultiselectId");
    // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz END
    
    // 2015/04/13 請求宛名 = 会計宛名 >> お客様
    var strAccountName = $("[id$=':accountNameSel']").val();
    if ($.trim(strAccountName) == "") {
        strAccountName = $("[id$=':inp_contactName']").val();
    }
    strAccountName = strAccountName.replace(/\"/g, '&quot;');
    // 2015/08/17 請求書店舗
    var strShopSelectHtml = locGetMulitiShopsHtml("");

    var todayStr = "<apex:outputtext value="{0, date,yyyy/MM/dd}"><apex:param value="{!TODAY()}"></apex:param></apex:outputtext>";
    // give your dialog some content (I usually use an iframe linking to another visualforce page
    // change the url, height, width to your needs
    //請求宛名
    //発行日付
    //ハンコ表示
    //コメント
    //コメント：１行18文字、4列以内入力ください。
    //キャンセル
    //請求書作成 
    // 2018/05/08 請求書のコメント欄を毎回手打ちし自動 zyz BEGIN
    var commentHtml = _getCommentHtml();
    // 2018/05/08 請求書のコメント欄を毎回手打ちし自動 zyz END
    // 2019/1/15 請求書に掲載する振込先口座情報を、同一店舗内で切り替えする BY cxw BEGIN
    var fixedMsgHtml = _getFixedMsgHtml();
    // 2019/1/15 請求書に掲載する振込先口座情報を、同一店舗内で切り替えする BY cxw END
    // 領収証宛名＝画面の領収証宛名 >> 画面のご請求先 >> 画面のお客様
    // 2018/12/15 請求書-領収書新規レイアウトを追加 WGCH BEGIN
    // $(d.dialog).find('#BillPdfStartDialogInner').html('<div class="pbBody"><div><div class="pbSubsection"><table class="detailList" style="table-layout: fixed;width: 400px;" border="0" cellpadding="1" cellspacing="1">'+strShopSelectHtml+'<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0218}</label></td><td class="data2Col first " width="320px"><input id="dialog_accName" type="text"  style="width:90%" value="'+strAccountName+'"/></td></tr><tr><td class="labelCol"><label>{!$Label.MSG_006_0219}</label></td><td class="data2Col first "><input id="dialog_acountdate" type="text"  style="width:90%" value="'+todayStr+'"/></td></tr>' + exchangeRateSelect + '<tr><td class="labelCol"><label>{!$Label.MSG_006_0220}</label></td><td class="data2Col first "><input type="checkbox" id="dialog_stampIsShowFlg" ' + stampIsShowFlgStr + '/></td></tr><tr style="vertical-align: top;"><td class="labelCol "><label>{!$Label.MSG_006_0221}</label></td><td class="data2Col ">'+commentHtml+'<p>{!$Label.MSG_006_0222}</p></td></tr><tr><td colspan="2" style="text-align: center;"><input class="btn" id="dialog_cancelBtn" style="width: 100px" type="button" value="{!$Label.MSG_006_0223}" /> <input class="btn" id="dialog_printoutBtn" style="width: 100px" type="button" value="{!$Label.MSG_006_0224}" /></td></tr></table></div></div></div>');
    var billReceiptHtml = '';
    if({!billRcptIsShowFlg}){
        var strReceiptName = $("[id$=':accountReciptSel']").val();
        if ($.trim(strReceiptName) == "") strReceiptName = $("span[id$=':accountName']").text();
        if ($.trim(strReceiptName) == "") strReceiptName = $("[id$=':inp_contactName']").val();
        strReceiptName = strReceiptName.replace(/\"/g, '&quot;');
        // 領収証但し
        var strReovisoSel = $("[id$=':accountProvisoSel']").val();
        strReovisoSel = strReovisoSel.replace(/\"/g, '&quot;');
        // 領収証宛名
        billReceiptHtml += '<tr><td class="labelCol first " width="80px"><label>{!$Label.msg_006_0227}</label></td><td class="data2Col first "><input id="bill_dialog_receiptName" type="text" style="width:90%" value="'+strReceiptName+'"/></td></tr>';
        // 領収証但し
        billReceiptHtml += '<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0228}</label></td><td class="data2Col first "><input id="bill_dialog_accountProviso" type="text" style="width:90%" value="'+strReovisoSel+'"/></td></tr>'; 
    }
    // 2019/04/30 請求書の送付表新規作成 BY zyz BEGIN
    // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz BEGIN
    // $(d.dialog).find('#BillPdfStartDialogInner').html('<div class="pbBody"><div><div class="pbSubsection"><table class="detailList" style="table-layout: fixed;width: 400px;" border="0" cellpadding="1" cellspacing="1">'+strShopSelectHtml+'<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0218}</label></td><td class="data2Col first " width="320px"><input id="dialog_accName" type="text"  style="width:90%" value="'+strAccountName+'"/></td></tr>' + billReceiptHtml + '<tr><td class="labelCol"><label>{!$Label.MSG_006_0219}</label></td><td class="data2Col first "><input id="dialog_acountdate" type="text"  style="width:90%" value="'+todayStr+'"/></td></tr>' + exchangeRateSelect + '<tr><td class="labelCol"><label>{!$Label.MSG_006_0220}</label></td><td class="data2Col first "><input type="checkbox" id="dialog_stampIsShowFlg" ' + stampIsShowFlgStr + '/></td></tr><tr style="vertical-align: top;"><td class="labelCol "><label>{!$Label.MSG_006_0221}</label></td><td class="data2Col ">'+commentHtml+'<p>{!$Label.MSG_006_0222}</p></td></tr>'+fixedMsgHtml+shippingHtml+'<tr><td colspan="2" style="text-align: center;"><input class="btn" id="dialog_cancelBtn" style="width: 100px" type="button" value="{!$Label.MSG_006_0223}" /> <input class="btn" id="dialog_printoutBtn" style="width: 100px" type="button" value="{!$Label.MSG_006_0224}" /></td></tr></table></div></div></div>');
    $(d.dialog).find('#BillPdfStartDialogInner').html('<div class="pbBody"><div><div class="pbSubsection"><table class="detailList" style="table-layout: fixed;width: 400px;" border="0" cellpadding="1" cellspacing="1">'+strShopSelectHtml+'<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0218}</label></td><td class="data2Col first " width="320px"><input id="dialog_accName" type="text"  style="width:90%" value="'+strAccountName+'"/></td></tr>' + billReceiptHtml + '<tr><td class="labelCol"><label>{!$Label.MSG_006_0219}</label></td><td class="data2Col first "><input id="dialog_acountdate" type="text"  style="width:90%" value="'+todayStr+'"/></td></tr>' +mrSelectHtml+ exchangeRateSelect + '<tr><td class="labelCol"><label>{!$Label.MSG_006_0220}</label></td><td class="data2Col first "><input type="checkbox" id="dialog_stampIsShowFlg" ' + stampIsShowFlgStr + '/></td></tr><tr style="vertical-align: top;"><td class="labelCol "><label>{!$Label.MSG_006_0221}</label></td><td class="data2Col ">'+commentHtml+'<p>{!$Label.MSG_006_0222}</p></td></tr>'+fixedMsgHtml+shippingHtml+'<tr><td colspan="2" style="text-align: center;"><input class="btn" id="dialog_cancelBtn" style="width: 100px" type="button" value="{!$Label.MSG_006_0223}" /> <input class="btn" id="dialog_printoutBtn" style="width: 100px" type="button" value="{!$Label.MSG_006_0224}" /></td></tr></table></div></div></div>');
    // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz END
    // 2019/04/30 請求書の送付表新規作成 BY zyz END
    // 2018/12/15 請求書-領収書新規レイアウトを追加 WGCH END
    // 2019/1/15 請求書に掲載する振込先口座情報を、同一店舗内で切り替えする BY cxw BEGIN
    bindSpcdChange();
    // 2019/1/15 請求書に掲載する振込先口座情報を、同一店舗内で切り替えする BY cxw END

    $(d.dialog).find('input[type="button"]').on('click', function() {
        var btnId = $(this).attr("id");
        if (btnId == "dialog_cancelBtn") {
            d.hide();
        } else if (btnId == "dialog_printoutBtn") {
            // 請求書画面を起動する
            var custName = $("#dialog_accName").val();
            var comment = $("#dialog_comment").val();
            // 2019/1/15 請求書に掲載する振込先口座情報を、同一店舗内で切り替えする BY cxw BEGIN
            var fixedMsg = $("#select_fixed_msg").val() || "";
            // 2019/1/15 請求書に掲載する振込先口座情報を、同一店舗内で切り替えする BY cxw END
            var reqDate = $("#dialog_acountdate").val();
            var currencyLen = $("#dialog_currencyType").length;
            var currencyVal = $("#dialog_currencyType").val();
            var stampIsShowFlg = $("#dialog_stampIsShowFlg").prop('checked');
            var selectShopLen = $("#dialog_shopcd").length;
            var selectShopVal = $("#dialog_shopcd").val();
            // 2018/06/08 レシート印刷機能言語選択する WGCH BEGIN
            var language = $("#bill_dialog_language").val();
            // 2018/06/08 レシート印刷機能言語選択する WGCH END
            // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz BEGIN
            var mrTypeSelectVal = $("#billmultiselectId").val();
            // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz END
            // 2018/03/30 会計書の店舗切替を保存 WGCH BEGIN
            if(getSpcdCookieFlg()) setSpCdCookieFun('BILLSPCD', selectShopVal);
            // 2018/03/30 会計書の店舗切替を保存 WGCH END
            // 2018/12/15 請求書-領収書新規レイアウトを追加 WGCH BEGIN
            var receiptNameLen = $("#bill_dialog_receiptName").length;
            var receiptName = $("#bill_dialog_receiptName").val();
            var accountProvisoLen = $("#bill_dialog_accountProviso").length;
            var accountProviso = $("#bill_dialog_accountProviso").val();
            // 2018/12/15 請求書-領収書新規レイアウトを追加 WGCH END
            var custNameUrl = "&cuName=" + encodeURIComponent(custName) + "&comment=" + encodeURIComponent(comment);
            // 2019/1/15 請求書に掲載する振込先口座情報を、同一店舗内で切り替えする BY cxw BEGIN
            custNameUrl += "&fixedMsg=" + encodeURIComponent(fixedMsg);
            // 2019/1/15 請求書に掲載する振込先口座情報を、同一店舗内で切り替えする BY cxw END
            custNameUrl += "&pdt=" + encodeURIComponent(reqDate);
            custNameUrl += "&stampFlg=" + encodeURIComponent(stampIsShowFlg);
            // 2018/06/08 レシート印刷機能言語選択する WGCH BEGIN
            custNameUrl += "&language=" + encodeURIComponent(language);
            // 2018/06/08 レシート印刷機能言語選択する WGCH END
            // 2018/12/15 請求書-領収書新規レイアウトを追加 WGCH BEGIN
            if(receiptNameLen > 0) custNameUrl += "&recpName=" + encodeURIComponent(receiptName);
            if(accountProvisoLen > 0) custNameUrl += "&accountProviso=" + encodeURIComponent(accountProviso);
            // 2018/12/15 請求書-領収書新規レイアウトを追加 WGCH END
            if (currencyLen > 0 && currencyVal == "JPY") {
                custNameUrl += "&cy=" + encodeURIComponent(currencyVal);
            }
            // 利用日登録期間を取得する
            custNameUrl += locGetUseDataRangeParam();
            if (selectShopLen > 0 && selectShopVal != "") {
                custNameUrl += "&shopcd=" + encodeURIComponent(selectShopVal);
            }
            // 2019/04/30 請求書の送付表新規作成 BY zyz BEGIN
            if($("#dialog_shipping").prop("checked")){ 
                custNameUrl += "&letter"; 
            } 
            // 2019/04/30 請求書の送付表新規作成 BY zyz END
            // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz BEGIN
            if(RespectFlg == "true") custNameUrl += "&mr=" + mrTypeSelectVal;
            // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz END
            var idList = $.parseJSON($("#hidRelAccountIds").val());
            // 画面に連泊の場合
            if (idList.length >= 0) {
                var currAccId = $("#hidCurrAccountId").val();
                var url = "{!URLFOR('/apex/' & $Setup.CommDefine__c.AppNS__c & 'BillPdfBulkSelector')}?id="+currAccId;
                // 2019/10/30 会計書、請求書のマージ機能対応 WGCH BEGIN
                if(isPdfMergeFlg) url = getBukkUrl(currAccId, true);
                // 2019/10/30 会計書、請求書のマージ機能対応 WGCH END
                //commUtils.popup(url+custNameUrl, "simpleInput_acc_pdfpage", null, window.screen.width, "600px");
                window.open(url+custNameUrl);
            }
            d.hide();
        }
    });
    // we also need to make sure we have a close button on the dialog
    if ($(d.dialog).find('#InlineEditDialogX').size() == 0) {
        // if there is none we create it
        close = $('<a id="InlineEditDialogX" title="Close" tabindex="0" href="javascript:void(0)" class="dialogClose">Close</a>');
        // add some functionality to the close button (for the default ui we change the classname on mouseover/out
        close.mouseover(function() {
            this.className = 'dialogCloseOn';
        }).mouseout(function() {
            this.className = 'dialogClose';
        }).click(function() {
            // finally our on click handler which closes the dialog
            d.hide();
        });
        // insert the new generated close button before the h2 tag so it'll show up on the top right corner
        close.insertBefore($(d.dialog).find('.topLeft h2'));
    }  
    // now it's time to show the new dialog
    d.show();
    // 2018/03/30 会計書の店舗切替を保存 WGCH BEGIN
    if(getSpcdCookieFlg() && getBillSpCd() != '') $j("#dialog_shopcd").val(getBillSpCd());
    // 2018/03/30 会計書の店舗切替を保存 WGCH END
}
//2017/04/19 レシート印刷機能追加　by zy BEGIN
//共通印刷状态用
var accountMessPnt = $.WebPrint({
    //2017/04/19 レシート印刷機能追加　by zy BEGIN
    cashDrawer:false,
    //2017/04/19 レシート印刷機能追加　by zy END
    connectMessage:function(e){
        try{
            var res = JSON.parse(e.data);
            if ("CashDrawer" in res) {
                //2017/04/19 レシート印刷機能追加　by zy BEGIN
                if ( res.CashDrawer == 'Open') {
                    //accountCommPnt.nextStep();
                    this.cashDrawer = true;
                } else {
                    // 断开全部链接   
                    //printCtl('close');
                    this.cashDrawer = false;
                //2017/04/19 レシート印刷機能追加　by zy END
                }
            }
        }catch(err){
            //consoleLog(err);
        }
    }
});
//共同印刷送信用
var accountCommPnt = $.WebPrint({
    // 2017/08/10 入金自動レシート印刷機能追加　by　zy BEGIN
    addError:function(){},
    // 2017/08/10 入金自動レシート印刷機能追加　by　zy END
    // 2017/07/26 ログ機能追加　by　zy BEGIN
    // ログアドレス
    remoteSaveLog:"{!$RemoteAction.BillSimpleInputCtrl.savePrintLodToDb}",
    // 2017/07/26 ログ機能追加　by　zy END
    sendMesssage:function(e){
        try{
            //2017/04/19 レシート印刷機能追加　by zy BEGIN
            // dorr open、最後のコメンド「ドルーオプンー」の場合
            if (accountMessPnt.cashDrawer) {
                // 只剩一个命令
                if (this.callBackSeqArr.length == 1){
                    // 命令为dooropen
                    if(this.callBackSeqArr[0].indexOf('kick_drawer')>=0){
                        // 断开全部链接   
                        printCtl('close');
                        return;
                    }
                }
            }  
            //if (e.data.indexOf("lastResponse") >= 0 ) {
            // 最後コメンドなしの場合（通常：控え）
            if (this.callBackSeqArr.length > 0){
                this.nextStep();
            // コメンドなし
            } else {
                // 断开全部链接   
                printCtl('close');
            }
            //}
            /*
            //2017/04/19 レシート印刷機能追加　by zy END
            var res = JSON.parse(e.data);
            //consoleLog(res);
            if (res.responses.indexOf("OK") >= 0){
                // 指令队列，第二个命令为收银机弹出命令
                if (this.callBackSeqArr.length > 0 && !this.doorHadOpen) {
                    if (!accountMessPnt.cashDrawer) {
                        accountCommPnt.nextStep();
                    }
                // 队列里没有数据
                } else {
                    // 断开全部链接   
                    printCtl('close');
                }
            }*/
        }catch(err){
        }
    },
    //送信error
    addError:errorProcess
});
var printReady;
function chkPrintReady(){
    if (printReady == undefined) {
        //共通定义
        var commPrintFlag = "{!JSENCODE(strPrintReadyState)}" == 'true';
        var chkIp = $("#hidPrintIncludeIps").val();
        //如果ip存在打印机,则表示打印机就绪
        var isPrintReady = false ;
        if (chkIp != ""){
            var localIP = $("input[id$=hidLocalIp]").val();
            var res = JSON.parse(chkIp);
            isPrintReady = $.inArray(localIP,res) >= 0;
        }
        //是否要有レシート印刷btn
        printReady = commPrintFlag && isPrintReady;
    }
    return printReady;
}
function locPrintTypeHtml(){
    var reshitoBtnHtml = '';
    if (chkPrintReady()) {
        reshitoBtnHtml =  '<tr><td class="data2Col first">印刷タイプ</td><td class="data2Col"><input type="radio" name="dialog_printTypeSel" checked value="pdf"/>PDF <input type="radio" name="dialog_printTypeSel" value="reshito"/>レシート <span id="printErrorMsg"></span></td></tr>';
    }
    return reshitoBtnHtml;
}

//打印信息
function reshitoPrint() {
    // 准备打印信息
    var res_arr = printMsgInfo();
    //执行打印
    printDo(res_arr);
}
// 初始化打印机信息
function printMsgInfo(){
    var res_arr = [];
    endpoint_comm = $("input[id$=hidPrinUrl]").val();
    endpoint_mess = $("input[id$=hidStatusUrl]").val();
    accountCommPnt.webComm = endpoint_comm;
    // 2017/07/26 ログ機能追加　by　zy BEGIN
    accountCommPnt.baseInfo = '****オーダーエンドリ：' + $("input[id$=hidCurPos]").val() + '会計ID：' + $("input[id$=hidCurrAccountId]").val() + '****';
    // 2017/07/26 ログ機能追加　by　zy END
    accountMessPnt.webComm = endpoint_mess;
    if (accountCommPnt.webComm != "" && accountMessPnt.webComm != ""){
        var pntInfoStr = $("input[id$=printJson]").val();
        res_arr = JSON.parse(pntInfoStr);
    }
    return res_arr;
}
function printDo(res_arr){
    if (accountCommPnt.webComm != "" && accountMessPnt.webComm != ""){
        var jsonMsgArr = new Array();
        for (var i = 0 ;i < res_arr.length ; i++) {
            var pntInfo = res_arr[i];
            if (pntInfo != null && pntInfo != '' && pntInfo != undefined ){
                var jsonMsg = JSON.stringify(pntInfo);
                jsonMsgArr.push(jsonMsg);
            }
        }
        // 2017/07/26 ログ機能追加　by　zy BEGIN
        //accountCommPnt.consoleLog(JSON.stringify(res_arr));
        // 2017/07/26 ログ機能追加　by　zy END
        accountCommPnt.callBackSeqArr = jsonMsgArr;
        printCtl('open');
    } else {
        errorProcess();
    }
}
//エラー処理する
function errorProcess(e){
    // 2017/08/22 自動保存効率up by zy BEGIN
    // 如果正在执行则等待执行
    if (actionSaveFlag) {
        setTimeout(function(){
            errorProcess(e)
        },500);
        return;
    }
    // 2017/08/22 自動保存効率up by zy END
    // 打印error信息
    accountCommPnt.consoleLog(e);
    var currAccId = $("#hidCurrAccountId").val();
    var url = "{!URLFOR('/apex/' & $Setup.CommDefine__c.AppNS__c & 'AccountPdfBulkSelector')}?id="+currAccId;
    // 2017/08/10 入金自動レシート印刷機能追加　by　zy BEGIN
    if ('custNameUrl' in accountCommPnt) url += accountCommPnt.custNameUrl;
    else {
        // 利用日登録期間を取得する
        var custNameUrl = locGetUseDataRangeParam();
        url += custNameUrl;
    }
    // 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH BEGIN
    // window.open(url);
    if(!printPdfFlg){
        window.open(url);
    }
    // 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH END
    // 2017/08/10 入金自動レシート印刷機能追加　by　zy END
    // 断开全部链接   
    printCtl('close');
}
//关闭连接
function printCtl(status){
    if ( status == 'open') {
        accountCommPnt.nextStep();
        accountMessPnt.connect();
    } else {
        $("#printErrorMsg").html('');
        $("#dialog_printoutBtn_acc").removeAttr("disabled");
        accountCommPnt.disconnect();
        accountMessPnt.disconnect();
        //隐藏画面
        $("#dialog_cancelBtn").click();
        // 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH BEGIN
        mergeTabCallbackFun();
        // 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH END
    }
}
//2017/04/19 レシート印刷機能追加　by zy END
// 領収書ありPDFチェックする
function isHaveReceiptFun(facilityCode) {
    return (facilityCode == '2' || 
            facilityCode == '3' || 
            facilityCode == '4' || 
            facilityCode == '8' || 
            facilityCode == '9' || 
            facilityCode == '23' || 
            facilityCode == '24' || 
            facilityCode == '15' || 
            facilityCode == '13' || 
            facilityCode == '14' ||
            facilityCode == '33' || 
            facilityCode == '34');  
}
/**********************************
* 印刷機能対応
***********************************/
function openPrintPdfWin () {
    var d = sfdcPage.dialogs['PrintPdfStartDialog'],close;
    if (!d) {
        // if the dialog doesn't exist create one 
        d = sfdcPage.dialogs['PrintPdfStartDialog'] = new SimpleDialog('PrintPdfStartDialog', false);
        // set general information on your dialog and finally run the create function 
        d.setWidth(440);
        d.createDialog();
    }
    //印刷
    d.setTitle('{!$Label.MSG_006_0225}');
    //会計書
    //請求書
    var printContentHtml = '<div id="printPdfWinTabStrip" style="width: 100%;"><ul><li id="printPdfWinTabStrip_acco" class="k-state-active">{!$Label.MSG_006_0226}</li><li id="printPdfWinTabStrip_bill">{!$Label.MSG_006_0215}</li></ul>';
    var accoPdfInputHtml = "";
    var billPdfInputHtml = "";
    var accoPrefixKey = '_acco_';
    // 会計書入力用のHTML作成
    if (accoPdfInputHtml == "") {
        // 請求宛名入力項目表示可否判断
        var receiptHtml = "";
        // 施設コード
        var facilityCode = "{!JSENCODE(oFacilityCode)}";
        // 下記会計書の場合、領収書項目存在
        if (isHaveReceiptFun(facilityCode)) {
            // 領収証宛名＝画面の領収証宛名 >> 画面のご請求先 >> 画面のお客様
            var strReceiptName = $("[id$=':accountReciptSel']").val();
            if ($.trim(strReceiptName) == "") strReceiptName = $("span[id$=':accountName']").text();
            if ($.trim(strReceiptName) == "") strReceiptName = $("[id$=':inp_contactName']").val();
            strReceiptName = strReceiptName.replace(/\"/g, '&quot;');
            // 領収証但し
            var strReovisoSel = $("[id$=':accountProvisoSel']").val();
            strReovisoSel = strReovisoSel.replace(/\"/g, '&quot;');
            // Hmtl出力
            //領収証宛名
            receiptHtml += '<tr><td class="labelCol first " width="80px"><label>{!$Label.ps__msg_006_0227}</label></td><td class="data2Col first "><input id="dialog_receiptName" type="text" style="width:90%" value="'+strReceiptName+'"/></td></tr>';
            //領収証但し
            receiptHtml += '<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0228}</label></td><td class="data2Col first "><input id="dialog_accountProviso" type="text" style="width:90%" value="'+strReovisoSel+'"/></td></tr>';
        }
    
        // 一括印刷（室料・朝食・ALL）
        //一括印刷  室料      室料・朝食       ALL
        var mergePrint = '<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0229}</label></td><td class="data2Col first "><select id="dialog_printType"><option value="r">{!$Label.MSG_006_0230}</option><option value="rf">{!$Label.MSG_006_0231}</option><option value="" selected>{!$Label.MSG_006_0232}</option></select></td></tr>';
        // 一括印刷項目表示のパラメータ切替
        if ({!accountPrintTypeIsShowFlg}.toString().toLowerCase() != "true") {
            mergePrint = '';
        }
        // 2015/04/13 会計書宛名
        var strAccountName = $("[id$=':accountNameSel']").val();
        if ($.trim(strAccountName) == "") {
            strAccountName = $("[id$=':inp_contactName']").val();
        }
        strAccountName = strAccountName.replace(/\"/g, '&quot;');
        // 言語リスト
        var strLanguageVal = $("[id$=':languageSel']").val();
        var strLanguageJpn = "";
        var strLanguageEng = "";
        if (strLanguageVal == "jp") strLanguageJpn=" selected ";
        if (strLanguageVal != "jp") strLanguageEng=" selected ";
        //日本語       英語
        strLanguageSelectHtml = '<select id="dialog_language"><option value="jp"'+strLanguageJpn+'>{!$Label.ps__msg_006_0234}</option><option value="en"'+strLanguageEng+'>{!$Label.ps__msg_006_0236}</option></select>';
        // give your dialog some content (I usually use an iframe linking to another visualforce page
        // change the url, height, width to your needs
        var accStrShopSelectHtml = locGetMulitiShopsHtml(accoPrefixKey);
        // 2016/07/04 会計書の領収書欄を表示する・しない選択できる制御フラグ
        var accReceiptOptHtml = locGetAccReceiptOptHtml(facilityCode);
        //2017/04/19 レシート印刷機能追加　by zy BEGIN
        var reshitoBtnHtml = locPrintTypeHtml();
        // 2018/04/27 会計書ハンコ表示・非表示機能対応 BEGIN by zh
        // ハンコ表示・非表示制御初期値設定 
        var stampIsShowFlgStr = {!accStampIsShowFlg} ? "checked=\'checked\'" : ""; 
        // 2018/04/27 会計書ハンコ表示・非表示機能対応 END by zh
        // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz BEGIN
        var RespectFlg = $("#hidRespectFlg").val();
        var mrSelectHtml = respectHtml(facilityCode,RespectFlg,"accmultiselectId");
        // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz END
        
        //会計書宛名     言語      キャンセル       会計書作成
        //accoPdfInputHtml = '<div class="pbBody" id=""><div><div class="pbSubsection"><table class="detailList" style="table-layout: fixed;width: 400px;" border="0" cellpadding="1" cellspacing="1">'+accStrShopSelectHtml+'<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0237}</label></td><td class="data2Col first "><input id="dialog_acc_accName" type="text" style="width:90%" value="'+strAccountName+'"/></td></tr>' + receiptHtml + mergePrint + '<tr style="vertical-align: top;"><td class="labelCol "><label>{!$Label.MSG_006_0238}</label></td><td class="data2Col ">'+strLanguageSelectHtml+'</td></tr>'+accReceiptOptHtml+reshitoBtnHtml + '<tr><td colspan="2" style="text-align: center;padding-top:10px"><input class="btn" id="dialog_cancelBtn" style="width: 100px" type="button" value="{!$Label.MSG_006_0239}" /> <input class="btn" id="dialog_printoutBtn_acc" style="width: 100px" type="button" value="{!$Label.MSG_006_0240}" /></td></tr></table></div></div></div>';
        accoPdfInputHtml = '<div class="pbBody" id=""><div><div class="pbSubsection"><table class="detailList" style="table-layout: fixed;width: 400px;" border="0" cellpadding="1" cellspacing="1">'+accStrShopSelectHtml+'<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0237}</label></td><td class="data2Col first "><input id="dialog_acc_accName" type="text" style="width:90%" value="'+strAccountName+'"/></td></tr>' + receiptHtml + mergePrint
        // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz BEGIN
        +mrSelectHtml
        // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz END
        +'<tr style="vertical-align: top;"><td class="labelCol "><label>{!$Label.MSG_006_0238}</label></td><td class="data2Col ">'+strLanguageSelectHtml+'</td></tr>'
        // 2018/04/27 会計書ハンコ表示・非表示機能対応 BEGIN by zh
        +'<tr><td class="labelCol"><label>{!$Label.MSG_006_0220}</label></td><td class="data2Col first "><input type="checkbox" id="dialog_accStampIsShowFlg" ' + stampIsShowFlgStr + '/></td></tr>'    
        // 2018/04/27 会計書ハンコ表示・非表示機能対応 END by zh
        +accReceiptOptHtml+reshitoBtnHtml + '<tr><td colspan="2" style="text-align: center;padding-top:10px"><input class="btn" id="dialog_cancelBtn" style="width: 100px" type="button" value="{!$Label.MSG_006_0239}" /> <input class="btn" id="dialog_printoutBtn_acc" style="width: 100px" type="button" value="{!$Label.MSG_006_0240}" /></td></tr></table></div></div></div>';
        //2017/04/19 レシート印刷機能追加　by zy END
    }
    if (billPdfInputHtml == "") {
        // 2014/07/18 USD（通貨設定はJPY以外の場合、会計書為替レートにより、金額計算を行う)
        var locCurrency = "{!oDefaultCurrency}";
        var exchangeRateSelect = "";
        if (locCurrency != "JPY") {
            //通貨        JPY
            exchangeRateSelect = '<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0217}</label></td><td class="data2Col first "><select id="dialog_currencyType"><option value="JPY">{!$Label.MSG_006_0216}</option><option value="' + locCurrency + '">' + locCurrency + '</option></select></td></tr>';
        }
        // 2018/06/08 レシート印刷機能言語選択する WGCH BEGIN
        exchangeRateSelect += '<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0238}</label></td><td class="data2Col first "><select id="bill_dialog_language"><option value="jp" {!IF(oAcountSobj.AccountLanguage__c == "jp", "selected", "")}>{!$Label.MSG_006_0234}</option><option value="en" {!IF(oAcountSobj.AccountLanguage__c == "en", "selected", "")}>{!$Label.MSG_006_0236}</option></select></td></tr>';
        // 2018/06/08 レシート印刷機能言語選択する WGCH END
        // 2015/01/26 ハンコ表示・非表示制御初期値設定
        var stampIsShowFlg = "{!billStampIsShowFlg}";
        var stampIsShowFlgStr = "";
        if (stampIsShowFlg == "true") stampIsShowFlgStr = "checked=\'checked\'";
        // 2019/04/30 請求書の送付表新規作成 BY zyz BEGIN
        var shippingHtml = "";
        var letterIsShow = "{!billLetterFlg}";
        if(letterIsShow == "true"){
            shippingHtml = '<tr style="vertical-align: top;"><td class="labelCol "><label>送付状あり</label></td><td class="data2Col"><input type="checkbox" id="dialog_shipping" checked="checked"/></td></tr>';
        }
        // 2019/04/30 請求書の送付表新規作成 BY zyz END 
        
        // 2015/04/13 請求宛名 = 会計宛名 >> お客様
        var strAccountName = $("[id$=':accountNameSel']").val();
        if ($.trim(strAccountName) == "") {
            strAccountName = $("[id$=':inp_contactName']").val();
        }
        strAccountName = strAccountName.replace(/\"/g, '&quot;');
        // 2015/08/17 請求書店舗
        var strShopSelectHtml = locGetMulitiShopsHtml("");
        // 2016/11/25 TIMEZON fix BEGIN by zh
        //var todayStr = "<apex:outputtext value="{0, date,yyyy/MM/dd}"><apex:param value="{!TODAY()}"></apex:param></apex:outputtext>";
        var todayStr = "<apex:outputtext value="{0, date,{!DateFormat}}"><apex:param value="{!TODAY()}"></apex:param></apex:outputtext>";
        // 2016/11/25 TIMEZON fix END by zh
        // give your dialog some content (I usually use an iframe linking to another visualforce page
        // change the url, height, width to your needs
        //請求宛名
        //発行日付
        //ハンコ表示
        //コメント
        //コメント：１行18文字、4列以内入力ください。
        //キャンセル
        //請求書作成
        // 2018/05/08 請求書のコメント欄を毎回手打ちし自動 zyz BEGIN
        var commentHtml = _getCommentHtml();
        // 2018/05/08 請求書のコメント欄を毎回手打ちし自動 zyz END
        // 2018/12/15 請求書-領収書新規レイアウトを追加 WGCH BEGIN
        // 2019/1/15 請求書に掲載する振込先口座情報を、同一店舗内で切り替えする BY cxw BEGIN
        var fixedMsgHtml = _getFixedMsgHtml();
        // 2019/1/15 請求書に掲載する振込先口座情報を、同一店舗内で切り替えする BY cxw END
        // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz BEGIN
        var RespectFlg = $("#hidRespectFlg").val();
        var mrSelectHtml = respectHtml("billpdf",RespectFlg,"billmultiselectId");
        // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz END
        // billPdfInputHtml = '<div class="pbBody"><div><div class="pbSubsection"><table class="detailList" style="table-layout: fixed;width: 400px;" border="0" cellpadding="1" cellspacing="1">'+strShopSelectHtml+'<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0218}</label></td><td class="data2Col first " width="320px"><input id="dialog_bill_accName" type="text" style="width:90%" value="'+strAccountName+'"/></td></tr><tr><td class="labelCol"><label>{!$Label.MSG_006_0219}</label></td><td class="data2Col first "><input id="dialog_acountdate" type="text" style="width:90%" value="'+todayStr+'"/></td></tr>' + exchangeRateSelect + '<tr><td class="labelCol"><label>{!$Label.MSG_006_0220}</label></td><td class="data2Col first "><input type="checkbox" id="dialog_stampIsShowFlg" ' + stampIsShowFlgStr + '/></td></tr><tr style="vertical-align: top;"><td class="labelCol "><label>{!$Label.MSG_006_0221}</label></td><td class="data2Col ">'+commentHtml+'<p>{!$Label.MSG_006_0222}</p></td></tr><tr><td colspan="2" style="text-align: center;"><input class="btn" id="dialog_cancelBtn" style="width: 100px" type="button" value="{!$Label.MSG_006_0223}" /> <input class="btn" id="dialog_printoutBtn_bill" style="width: 100px" type="button" value="{!$Label.MSG_006_0224}" /></td></tr></table></div></div></div>';
        var billReceiptHtml = '';
        if({!billRcptIsShowFlg}){
            // 領収証宛名＝画面の領収証宛名 >> 画面のご請求先 >> 画面のお客様
            var strReceiptName = $("[id$=':accountReciptSel']").val();
            if ($.trim(strReceiptName) == "") strReceiptName = $("span[id$=':accountName']").text();
            if ($.trim(strReceiptName) == "") strReceiptName = $("[id$=':inp_contactName']").val();
            strReceiptName = strReceiptName.replace(/\"/g, '&quot;');
            // 領収証但し
            var strReovisoSel = $("[id$=':accountProvisoSel']").val();
            strReovisoSel = strReovisoSel.replace(/\"/g, '&quot;');
            // Hmtl出力
            // 領収証宛名
            billReceiptHtml += '<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0227}</label></td><td class="data2Col first "><input id="bill_dialog_receiptName" type="text" style="width:90%" value="'+strReceiptName+'"/></td></tr>';
            // 領収証但し
            billReceiptHtml += '<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0228}</label></td><td class="data2Col first "><input id="bill_dialog_accountProviso" type="text" style="width:90%" value="'+strReovisoSel+'"/></td></tr>';
        }
        // 2019/04/30 請求書の送付表新規作成 BY zyz BEGIN
        // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz BEGIN
        // billPdfInputHtml = '<div class="pbBody"><div><div class="pbSubsection"><table class="detailList" style="table-layout: fixed;width: 400px;" border="0" cellpadding="1" cellspacing="1">'+strShopSelectHtml+'<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0218}</label></td><td class="data2Col first " width="320px"><input id="dialog_bill_accName" type="text" style="width:90%" value="'+strAccountName+'"/></td></tr>' + billReceiptHtml + '<tr><td class="labelCol"><label>{!$Label.MSG_006_0219}</label></td><td class="data2Col first "><input id="dialog_acountdate" type="text" style="width:90%" value="'+todayStr+'"/></td></tr>' + exchangeRateSelect + '<tr><td class="labelCol"><label>{!$Label.MSG_006_0220}</label></td><td class="data2Col first "><input type="checkbox" id="dialog_stampIsShowFlg" ' + stampIsShowFlgStr + '/></td></tr><tr style="vertical-align: top;"><td class="labelCol "><label>{!$Label.MSG_006_0221}</label></td><td class="data2Col ">'+commentHtml+'<p>{!$Label.MSG_006_0222}</p></td></tr>'+fixedMsgHtml+shippingHtml+'<tr><td colspan="2" style="text-align: center;"><input class="btn" id="dialog_cancelBtn" style="width: 100px" type="button" value="{!$Label.MSG_006_0223}" /> <input class="btn" id="dialog_printoutBtn_bill" style="width: 100px" type="button" value="{!$Label.MSG_006_0224}" /></td></tr></table></div></div></div>';
        billPdfInputHtml = '<div class="pbBody"><div><div class="pbSubsection"><table class="detailList" style="table-layout: fixed;width: 400px;" border="0" cellpadding="1" cellspacing="1">'+strShopSelectHtml+'<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0218}</label></td><td class="data2Col first " width="320px"><input id="dialog_bill_accName" type="text" style="width:90%" value="'+strAccountName+'"/></td></tr>' + billReceiptHtml + '<tr><td class="labelCol"><label>{!$Label.MSG_006_0219}</label></td><td class="data2Col first "><input id="dialog_acountdate" type="text" style="width:90%" value="'+todayStr+'"/></td></tr>' + mrSelectHtml + exchangeRateSelect + '<tr><td class="labelCol"><label>{!$Label.MSG_006_0220}</label></td><td class="data2Col first "><input type="checkbox" id="dialog_stampIsShowFlg" ' + stampIsShowFlgStr + '/></td></tr><tr style="vertical-align: top;"><td class="labelCol "><label>{!$Label.MSG_006_0221}</label></td><td class="data2Col ">'+commentHtml+'<p>{!$Label.MSG_006_0222}</p></td></tr>'+fixedMsgHtml+shippingHtml+'<tr><td colspan="2" style="text-align: center;"><input class="btn" id="dialog_cancelBtn" style="width: 100px" type="button" value="{!$Label.MSG_006_0223}" /> <input class="btn" id="dialog_printoutBtn_bill" style="width: 100px" type="button" value="{!$Label.MSG_006_0224}" /></td></tr></table></div></div></div>';
        // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz END
        // 2019/04/30 請求書の送付表新規作成 BY zyz END
        // 2018/12/15 請求書-領収書新規レイアウトを追加 WGCH END
    }
    
    // 会計書タブ情報を格納する
    printContentHtml += accoPdfInputHtml;
    printContentHtml += billPdfInputHtml;
    
    $(d.dialog).find('#PrintPdfStartDialogInner').html(printContentHtml);
    // 2019/1/15 請求書に掲載する振込先口座情報を、同一店舗内で切り替えする BY cxw BEGIN
    bindSpcdChange();
    // 2019/1/15 請求書に掲載する振込先口座情報を、同一店舗内で切り替えする BY cxw END

    $(d.dialog).find('input[type="button"]').on('click', function() {
        var btnId = $(this).attr("id");
        if (btnId == "dialog_cancelBtn") {
            d.hide();
        } else if (btnId == "dialog_printoutBtn_acc") {
            // 会計書画面を起動する 
            var receiptNameLen = $("#dialog_receiptName").length;
            var receiptName = $("#dialog_receiptName").val();
            var accountProvisoLen = $("#dialog_accountProviso").length;
            var accountProviso = $("#dialog_accountProviso").val();
            var custName = $("#dialog_acc_accName").val();
            var language = $("#dialog_language").val();
            var printType = $("#dialog_printType").length > 0 ? $("#dialog_printType").val() : "";
            var accSelectShopLen = $("#"+accoPrefixKey+"dialog_shopcd").length;
            var accSelectShopVal = $("#"+accoPrefixKey+"dialog_shopcd").val();
            // 2018/04/27 会計書ハンコ表示・非表示機能対応 BEGIN by zh
            var stampIsShowFlg = $("#dialog_accStampIsShowFlg").prop('checked');
            // 2018/04/27 会計書ハンコ表示・非表示機能対応 END by zh
            // 2018/03/30 会計書の店舗切替を保存 WGCH BEGIN
            if(getSpcdCookieFlg()) setSpCdCookieFun('ACCSPCD', accSelectShopVal);
            // 2018/03/30 会計書の店舗切替を保存 WGCH END
            // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz BEGIN
            var mrTypeSelectVal = $("#accmultiselectId").val();
            // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz END

            var custNameUrl = "&cuName=" + encodeURIComponent(custName) + "&language=" + encodeURIComponent(language) + "&pType=" + encodeURIComponent(printType);
            //  2016/07/07    領収書  BY zyz BEGIN
            var acccReceiptFlgLen = $("#dialog_accountReceipt").length;
            if(acccReceiptFlgLen > 0 && $("#dialog_accountReceipt").prop("checked") == false){
                custNameUrl += "&noreceipt=1";
            }
            //  2016/07/07    領収書  BY zyz END
            if (receiptNameLen > 0) {
                custNameUrl += "&recpName=" + encodeURIComponent(receiptName);
            }
            if (accountProvisoLen > 0) {
                custNameUrl += "&accountProviso=" + encodeURIComponent(accountProviso);
            }
            // 領収証日付
            var strAccountReceiptDate = $("[id$=':accountReceiptDate']").val();
            if ($.trim(strAccountReceiptDate).length > 0) {
                custNameUrl += "&accRepDt=" + encodeURIComponent(strAccountReceiptDate);
            } else {
                custNameUrl += "&accRepDt=";
            }
            // 2018/04/27 会計書ハンコ表示・非表示機能対応 BEGIN by zh
            custNameUrl += "&stampFlg=" + encodeURIComponent(stampIsShowFlg);
            // 2018/04/27 会計書ハンコ表示・非表示機能対応 END by zh
            // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz BEGIN
            if(RespectFlg == "true") custNameUrl += "&mr=" + mrTypeSelectVal;
            // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz END
            // 利用日登録期間を取得する
            custNameUrl += locGetUseDataRangeParam();
            if (accSelectShopLen > 0 && accSelectShopVal != "") {
                custNameUrl += "&shopcd=" + encodeURIComponent(accSelectShopVal);
            }
            var idList = $.parseJSON($("#hidRelAccountIds").val());
            if (idList.length > 0) {
                //2017/04/24 印刷会計書判定　by zy BEGIN
                if(chkOpenOrRedict(custNameUrl)) return;
                //2017/04/24 印刷会計書判定　by zy END
                var currAccId = $("#hidCurrAccountId").val();
                var url = "{!URLFOR('/apex/' & $Setup.CommDefine__c.AppNS__c & 'AccountPdfBulkSelector')}?id="+currAccId;
                // 2019/10/30 会計書、請求書のマージ機能対応 WGCH BEGIN
                if(isPdfMergeFlg) url = getBukkUrl(currAccId, false);
                // 2019/10/30 会計書、請求書のマージ機能対応 WGCH END
                window.open(url+custNameUrl);
            }
            d.hide();
        } else if (btnId == "dialog_printoutBtn_bill") {
            // 請求書画面を起動する
            var custName = $("#dialog_bill_accName").val();
            var comment = $("#dialog_comment").val();
            // 2019/1/15 請求書に掲載する振込先口座情報を、同一店舗内で切り替えする BY cxw BEGIN
            var fixedMsg = $("#select_fixed_msg").val() || "";
            // 2019/1/15 請求書に掲載する振込先口座情報を、同一店舗内で切り替えする BY cxw END
            var reqDate = $("#dialog_acountdate").val();
            var currencyLen = $("#dialog_currencyType").length;
            var currencyVal = $("#dialog_currencyType").val();
            var stampIsShowFlg = $("#dialog_stampIsShowFlg").prop('checked');
            var selectShopLen = $("#dialog_shopcd").length;
            var selectShopVal = $("#dialog_shopcd").val();
            // 2018/06/08 レシート印刷機能言語選択する WGCH BEGIN
            var language = $("#bill_dialog_language").val();
            // 2018/06/08 レシート印刷機能言語選択する WGCH END
            // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz BEGIN
            var mrTypeSelectVal = $("#billmultiselectId").val();
            // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz END
            // 2018/03/30 会計書の店舗切替を保存 WGCH BEGIN
            if(getSpcdCookieFlg()) setSpCdCookieFun('BILLSPCD', selectShopVal);
            // 2018/03/30 会計書の店舗切替を保存 WGCH END
            // 2018/12/15 請求書-領収書新規レイアウトを追加 WGCH BEGIN
            var receiptNameLen = $("#bill_dialog_receiptName").length;
            var receiptName = $("#bill_dialog_receiptName").val();
            var accountProvisoLen = $("#bill_dialog_accountProviso").length;
            var accountProviso = $("#bill_dialog_accountProviso").val();
            // 2018/12/15 請求書-領収書新規レイアウトを追加 WGCH END
            var custNameUrl = "&cuName=" + encodeURIComponent(custName) + "&comment=" + encodeURIComponent(comment);
            // 2018/1/15 請求書に掲載する振込先口座情報を、同一店舗内で切り替えする by cxw BEGIN
            custNameUrl += "&fixedMsg=" + encodeURIComponent(fixedMsg);
            // 2018/1/15 請求書に掲載する振込先口座情報を、同一店舗内で切り替えする by cxw END
            custNameUrl += "&pdt=" + encodeURIComponent(reqDate);
            custNameUrl += "&stampFlg=" + encodeURIComponent(stampIsShowFlg);
            // 2018/06/08 レシート印刷機能言語選択する WGCH BEGIN
            custNameUrl += "&language=" + encodeURIComponent(language);
            // 2018/06/08 レシート印刷機能言語選択する WGCH END
            // 2018/12/15 請求書-領収書新規レイアウトを追加 WGCH BEGIN
            if(receiptNameLen > 0) custNameUrl += "&recpName=" + encodeURIComponent(receiptName);
            if(accountProvisoLen > 0) custNameUrl += "&accountProviso=" + encodeURIComponent(accountProviso);
            // 2018/12/15 請求書-領収書新規レイアウトを追加 WGCH END
            if (currencyLen > 0 && currencyVal == "JPY") {
                custNameUrl += "&cy=" + encodeURIComponent(currencyVal);
            }
            // 利用日登録期間を取得する
            custNameUrl += locGetUseDataRangeParam();
            if (selectShopLen > 0 && selectShopVal != "") {
                custNameUrl += "&shopcd=" + encodeURIComponent(selectShopVal);
            }
            // 2019/04/30 請求書の送付表新規作成 BY zyz BEGIN
            if($("#dialog_shipping").prop("checked")){ 
                custNameUrl += "&letter"; 
            } 
            // 2019/04/30 請求書の送付表新規作成 BY zyz END
            // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz BEGIN
            if(RespectFlg == "true") custNameUrl += "&mr=" + mrTypeSelectVal;
            // 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz END
            var idList = $.parseJSON($("#hidRelAccountIds").val());
            // 画面に連泊の場合
            if (idList.length >= 0) {
                var currAccId = $("#hidCurrAccountId").val();
                var url = "{!URLFOR('/apex/' & $Setup.CommDefine__c.AppNS__c & 'BillPdfBulkSelector')}?id="+currAccId;
                // 2019/10/30 会計書、請求書のマージ機能対応 WGCH BEGIN
                if(isPdfMergeFlg) url = getBukkUrl(currAccId, true);
                // 2019/10/30 会計書、請求書のマージ機能対応 WGCH END
                window.open(url+custNameUrl);
            }
            d.hide();
        }
    });
    // we also need to make sure we have a close button on the dialog 
    if ($(d.dialog).find('#InlineEditDialogX').size() == 0) {
        // if there is none we create it 
        close = $('<a id="InlineEditDialogX" title="Close" tabindex="0" href="javascript:void(0)" class="dialogClose">Close</a>');
        // add some functionality to the close button (for the default ui we change the classname on mouseover/out 
        close.mouseover(function() {
            this.className = 'dialogCloseOn';
        }).mouseout(function() {
            this.className = 'dialogClose';
        }).click(function() {
            // finally our on click handler which closes the dialog 
            d.hide();
        });
        // insert the new generated close button before the h2 tag so it'll show up on the top right corner 
        close.insertBefore($(d.dialog).find('.topLeft h2'));
    }
    // TabStrip Init
    $("#printPdfWinTabStrip").kendoTabStrip();
    // now it's time to show the new dialog 
    d.show();
    // 2018/03/30 会計書の店舗切替を保存 WGCH BEGIN
    if(getSpcdCookieFlg() && getAccSpcd() != '') $j("#_acco_dialog_shopcd").val(getAccSpcd());
    if(getSpcdCookieFlg() && getBillSpCd() != '') $j("#dialog_shopcd").val(getBillSpCd());
    // 2018/03/30 会計書の店舗切替を保存 WGCH END
}
// ****** ユーザは複数店舗兼務場合、関連の設定 *****//
function locGetMulitiShopsHtml(prefixKey) {
    var shops = "{!JSENCODE(mulitiShops)}";
    if (shops != "") {
        //店舗兼務
        var shopHtml = '<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0241}</label></td><td class="data2Col first " width="320px"><select id ="'+prefixKey+'dialog_shopcd">' + shops + '</select></td></tr>';
        return shopHtml;
    } else return "";
}
// ****** 会計書の領収書あり・なし選択リストHTMLを取得する *****//
function locGetAccReceiptOptHtml(facilityCode) {
    if (facilityCode != 33 && facilityCode != 34) return "";
    var accReceiptOptFlg = {!accountReceiptOptIsShow}.toString().toLowerCase();
    if (accReceiptOptFlg != "true") return "";
    else return '<tr><td class="labelCol first " width="80px"><label>{!$Label.MSG_006_0440}</label></td><td class="data2Col first "><input type="checkbox" id="dialog_accountReceipt" /></td></tr>';
}
// ****** 会計書、請求書一括印刷画面に表示するの場合、日付表示期間を設定する *****//
function locGetUseDataRangeParam() {
    // 簡易会計の場合、日付を設定を行わない
    if($("#hidCurrLeadIdStr").val() == "") return "";
    var usdDateStr = $("#hidSalesDateRangeStr").val().split(":");
    var startDt = usdDateStr[0];
    var endDt = usdDateStr[1];
    return "&pat=1&psd="+startDt+"&ped="+endDt;
}
// 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH BEGIN
var printPdfFlg = false; // 自动印刷PDFFlg
var accSkipTabShow = {!accSkipTabShow && (oAcountSobj.Relreserve__c != null)};
function iframeReload(){
    var tabstrip = $("#tabstrip").getKendoTabStrip();
    if (tabstrip == undefined) return;
    var tabId = tabstrip.select().attr("id");
    if (tabId == "tab_transplit") {
        JINYACONNECT.blockUi();
        // 2021/04/31 #10788 bug fixed by zy BEGIN
        var $billSplitProcess = $("#billSplitProcess");
        $billSplitProcess.attr('src', COMM_SET.BILL_SIPLIT_SRC);
        $("#tab_transplit").removeClass("updateNoRefresh");
        // 2021/04/31 #10788 bug fixed by zy END
    } else if (tabId == "tab_accountSkip") {
        JINYACONNECT.blockUi();
        // 2021/04/31 #10788 bug fixed by zy BEGIN
        var $accountSkipIframe = $("#accountSkipIframe");
        $accountSkipIframe.attr('src', COMM_SET.ACCOUNT_SKIP_SRC);
        $("#tab_accountSkip").removeClass("updateNoRefresh");
        // 2021/04/31 #10788 bug fixed by zy END
    }
    // 2021/05/31 #11691 bug fixed by zy BEGIN
    // 关闭提示
    window.onbeforeunload = null;
    // 2021/05/31 #11691 bug fixed by zy END
}
function setPrintJsonFun(selectTranIdJson, selectTTendIdJson, roomName){
    printPdfFlg = true;
    $("input[id$='hidSelectTranIdJson']").val(selectTranIdJson);
    $("input[id$='hidSelectTTendIdJson']").val(selectTTendIdJson);
    $("input[id$='hidSelectSendRoomName']").val((roomName||""));
    processPrint();
}
function mergeTabCallbackFun(){
    if(!printPdfFlg) return;
    printPdfFlg = false;
    $("input[id$='hidSelectTranIdJson']").val("");
    $("input[id$='hidSelectTTendIdJson']").val("");
    $("input[id$='hidSelectSendRoomName']").val("");
    var $accountSkipIframe = $("#accountSkipIframe");
    if($accountSkipIframe.length == 0) return;
    $accountSkipIframe[0].contentWindow.updateTranDetail();
}
function clickUpsertFun(){
    // 2021/03/04 CPU LIMITの最適化 BUG[#PC9837] WGCH BEGIN
    $(".upsertClass").click();
    // 2021/03/04 CPU LIMITの最適化 BUG[#PC9837] WGCH END
}
function printBlockUI(str){
    if (str == undefined || str == "") {
        str = 'レシート印刷中...';
    }
    $.blockUI({
        // レシート印刷中
        message: '<h1><img src="{!URLFOR($Resource.queryfiles, 'css/blockui/busy.gif')}" /> ' + str + '</h1>'
    }); 
}
// 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH END
// 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz BEGIN
function respectHtml(facilityCode,RespectFlg,selectMrId){
    // 对应会计书33/34/35/36和请求书
    if(facilityCode !="33" && facilityCode !="34" && facilityCode !="35" && facilityCode !="36" && facilityCode !="billpdf") return '';
    // 共同定义开关控制
    if(RespectFlg != "true") return '';
    else return '<tr><td class="labelCol"><label>敬称</label></td><td class="data2Col first "><select  id="'+ selectMrId +'">'+mrShowSelectHtml+'</select></td></tr>';
    
}
// 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz END
//<!-- 画面リアルタム計算ロジック -->
//<!-- 2015/04/08 DELETE 会計人數入力なし、予約人數から対応する -->
/*
function summaryPeople () {
    // 男性,
    // maleNums
    // femaleNums
    // childrenNums
    var mans = kendo.parseInt($("input[id$=':people_maleNums']").val());
    var felma = kendo.parseInt($("input[id$=':people_femaleNums']").val());
    var children = kendo.parseInt($("input[id$=':people_childrenNums']").val());
    var peoples =   (mans == null ? 0 : mans) + 
                    (felma == null ? 0 : felma) +
                    (children == null ? 0 : children);
    $("span[id$=':peoples']").text(peoples);
}*/
// 2015/12/24 入金確認自動チェック制御機能の追加 BEGIN
function handReqStatus() {
    $("input[id$=':inp_handReq_paymentFlg']").val("1");
}
// 2015/12/24 入金確認自動チェック制御機能の追加 END
// 2016/12/13 会计明细非表示全选 by wx begin 
function isShowAll(isCheck,checkAllId){ 
    //var allCheckFlg = $j(that).prop("checked");
    var changeRows = [];
    // 2021/05/30 #11210 bug fixed by zy BEGIN
    var prods = [];
    // 2021/05/30 #11210 bug fixed by zy END
    J_ACCOUNT_CENTER.details.forEach(function(prod,idx){
        if (prod.get('InvoiceNoShowFlg__c') != isCheck) {
            prod.set({InvoiceNoShowFlg__c:isCheck,autoSetInvoiceNoShowFlg:false,isNoUpdate:false});
            // 2021/05/30 #11210 bug fixed by zy BEGIN
            J_ACCOUNT_CENTER.computeAmoutPrice(prod,false);
            prods.push(prod);
            // 2021/05/30 #11210 bug fixed by zy END
        }
    });
    // 2021/05/30 #11210 bug fixed by zy BEGIN
    J_ACCOUNT_CENTER.renderRow(prods);
    // 2021/04/31 #10890 bug fixed by zy BEGIN
    $("table[name='tranDetailTable']>tbody>tr.tranDetailRow [id$=InvoiceNoShowFlg]").prop("checked",isCheck);
    // 2021/04/31 #10890 bug fixed by zy END
    // 2021/05/30 #11210 bug fixed by zy END
    if ("refreshAmountId" in window) {
        clearTimeout(window.refreshAmountId);
    }
    window.refreshAmountId = setTimeout(function(){
        J_ACCOUNT_CENTER.refresh();
    });
}
// 2016/12/13 会计明细非表示全选 by wx end 
//2017/03/17 お釣りプリンター機能　by zy BEGIN
var changeSwitch = {!changeSwitch};
var hadChgUrlFlag = false;
function initChangeDevice(){
    //2017/04/19 レシート印刷機能追加　by zy BEGIN
    var localIp = window.localStorage["jinya_order_setIp"];
    //2017/04/20 レシート印刷機能bug fix　by zy BEGIN
    if (localIp != "" && localIp != undefined) {
    //2017/04/20 レシート印刷機能bug fix　by zy END
        consoleLog(localIp);
        $("input[id$=hidLocalIp]").val(localIp);
        //2017/04/21 打印功能区分 by zy BEGIN
        if (changeSwitch) getPrintFlag(localIp);
        //2017/04/21 打印功能区分 by zy END
        // 2017/06/29 ポース機能追加する　by　zy　BEGIN
        initDeviceFun();
        // 2017/06/29 ポース機能追加する　by　zy　END
        return;
    }
    //2017/04/19 レシート印刷機能追加　by zy END
    //2017/04/21 打印功能区分 by zy BEGIN
    //if (!changeSwitch) return;
    //2017/04/21 打印功能区分 by zy END
    //2017/06/12 localStorage ipアドー廃棄　by　zy　BEGIN
    var ipTimoutId;
    //2017/06/12 localStorage ipアドー廃棄　by　zy　END
    //ip获取
    try{
        var hadProcessedFlag = true;
        getIPs(function(ip){
            consoleLog(ip);
            if (hadProcessedFlag) {
//2017/04/24 ip set by zy BEGIN
                if (ip != undefined && ip != ""){
                    $("input[id$=hidLocalIp]").val(ip);
                }
//2017/04/24 ip set by zy END
                //2017/06/12 localStorage ipアドー廃棄　by　zy　BEGIN
                //if (changeSwitch) getPrintFlag(ip);
                //2017/06/12 localStorage ipアドー廃棄　by　zy　END
                hadProcessedFlag = false;
            }
            //2017/06/12 localStorage ipアドー廃棄　by　zy　BEGIN
            //清除上一次调用
            clearTimeout(ipTimoutId);
            //启动下一次调用
            ipTimoutId = setTimeout(afterGetIp(),1000);
            //2017/06/12 localStorage ipアドー廃棄　by　zy　END
        });
    } catch(err){
        //2017/06/12 localStorage ipアドー廃棄　by　zy　BEGIN
        /*
        if (changeSwitch) getPrintFlag();
        consoleLog(err);
        */
        afterGetIp();
        //2017/06/12 localStorage ipアドー廃棄　by　zy　END
    }
}
//2017/06/12 localStorage ipアドー廃棄　by　zy　BEGIN
function afterGetIp(){
    var ip = $("input[id$=hidLocalIp]").val();
    //if ( ip == "" && "jinya_order_setIp" in window.localStorage) ip = window.localStorage["jinya_order_setIp"];
    if (changeSwitch) getPrintFlag(ip);
    $("input[id$=hidLocalIp]").val(ip);
    initDeviceFun();
}
//2017/06/12 localStorage ipアドー廃棄　by　zy　END
// 2017/08/22 自動保存効率up by zy BEGIN
// actionfunction保存lock
var actionSaveFlag = false;
// 2017/08/22 自動保存効率up by zy END
// 釣銭機の機能起動制御
function changeChk(result){
    if (!changeSwitch) return true;
    //お釣り機能
    if ( hadChgUrlFlag && result.paymentType == '現金'){
        // 2017/09/06 会計メッセージ項目自定義機能追加 by zy BEGIN
        // 非空数据判断
        if (checkRequired()) {
            $("#inputFormErrorMsg").show();
            $(window).scrollTop(0);
            return false;
        }
        // 2017/09/06 会計メッセージ項目自定義機能追加 by zy END
        var reqAmount = $("#reqAmountBlock").text();
        $("#total").text(reqAmount);
        $("#charge").text(kendo.toString(0, "c"));
        $("#curTotal").text(kendo.toString(0, "c"));
        reqAmount = reqAmount.replace(kendo.getCulture().numberFormat.currency.symbol,"");
        var payAmount = kendo.parseFloat(reqAmount);
        // 如果请求金额为 0 不需要进行入金
        if (payAmount <= 0 ) return true;
        // 2017/08/22 自動保存効率up by zy BEGIN
        saveAccount();
        //2017/06/02 釣銭機の改修　by　zy BEGIN
        crgPnt.loadPrice(result,[CHARGE.CHECK,CHARGE.INPUTBEFORE,CHARGE.INPUT],payAmount);
        //2017/06/02 釣銭機の改修　by　zy END
        //机器操作页面初始化信息
        startChangeWin();
        // 2017/08/22 自動保存効率up by zy END
    } else return true;
    return false;
}
//入金信息处理，画面入金值
function changeAmount(amount){
    // 2017/07/14 釣銭機の行追加エラー発生by zy BEGIN
    if (changeSwitch) {
        // 正常情况都是有数据的
        if (crgPnt.inPrice != undefined) amount = crgPnt.total > crgPnt.inPrice ? kendo.parseFloat(crgPnt.inPrice) : kendo.parseFloat(crgPnt.total); 
        // 行追加的情况会出现需要读取差额的情况
        else {
            var inPrice = kendo.parseFloat($("input[id$=hidIntPrice]").val());
            if ( inPrice != null ) amount = inPrice;
            $("input[id$=hidIntPrice]").val('');
        }
    }
    // 2017/07/14 釣銭機の行追加エラー発生by zy END
    return amount;
}
//2017/03/17 お釣りプリンター機能　by zy END
//2017/04/24 印刷会計書判定　by zy BEGIN
function chkOpenOrRedict(custNameUrl){
    //2017/04/19 レシート印刷機能追加　by zy BEGIN
    var dialog_printTypeSel = $("input[name=dialog_printTypeSel]:checked");
    //存在选择印刷方式选择画面
    if (dialog_printTypeSel.length > 0 ) {
        accountCommPnt.custNameUrl = custNameUrl;
        //印刷連携
        if ( dialog_printTypeSel.val() == 'reshito') {
            $("#printErrorMsg").html('<img style="margin-left:10px;" src="../img/loading.gif" alt="Loading..." />');
            $("#dialog_printoutBtn_acc").attr("disabled","disabled");
            // 2018/01/19 会計レシート印刷機能言語選択する　by　zy BEGIN
            //　会計書の設定更新
            setPrintSetting();
            // 2018/01/19 会計レシート印刷機能言語選択する　by　zy END
            processPrint();
            return true;
        }
    }
    return false;
    //2017/04/19 レシート印刷機能追加　by zy END
}
//2017/04/24 印刷会計書判定　by zy END
// 2017/10/18 チェックアウト機能対応 BEGIN
// 一括チェックアウト対応
function _JsCheckoutFunction(leadId, leadIdxId) {
    JINYACONNECT.blockUi();
    // CHECKOUT
    Visualforce.remoting.Manager.invokeAction(
    "{!$RemoteAction.BillSimpleInputCtrl.checkoutAction}", leadId,leadIdxId, function(result, event){
        if (event.type == 'exception') {
           alert(event.message);
           JINYACONNECT.unblockUi();
        } else {
           // ボタン解除
           //buttonsEnabled(true);
           if (result[0] != "") {
                // 複数チェックアウトが必要場合
                var openUrl = "{!URLFOR('/apex/' & $Setup.CommDefine__c.AppNS__c & 'AccountPdfBulkPrint')}?fp=1&ldx=" + result[0] + "&qdt=" + result[1];
                // 2020/06/30 ユーザの所属店舗かご予約の部屋タイプに紐づく店舗対応 WGCH BEGIN
                // 2020/06/30 追加对应-#6540 WGCH BEGIN
                // 会計書、請求書、見積書のロゴ取得元
                var shopDefCdSetMode = "{!JSENCODE(shopDefCdSetMode)}";
                // 1: 予約の部屋タイプに紐づいた店舗ロゴを表示する; 2: ユーザの所属店舗ロゴを表示する => 设定店铺Code
                if(shopDefCdSetMode == "1" || shopDefCdSetMode == "2") openUrl += "&shopcd={!JSENCODE(oShopCode)}";
                // 2020/06/30 追加对应-#6540 WGCH END
                // 2020/06/30 ユーザの所属店舗かご予約の部屋タイプに紐づく店舗対応 WGCH END
                window.open(openUrl);
           }
           // 画面解除
           JINYACONNECT.unblockUi();
        }
    });
}
// 2017/10/18 チェックアウト機能対応 END
// 2017/09/06 会計メッセージ項目自定義機能追加 by zy BEGIN
// リアルお客様情報
function refreshContact(){
    if ($("input.contactClass").length == 0) return;
    if (!$("input[id$=inp_contactName]").hasClass("binded")) {
        var inputContact = $("input[id$=inp_contactName]:not(.binded)");
        inputContact.on("blur",function(){
            var oldValue = $(this).attr("oldvalue");
            var newValue = $(this).val();
            if (newValue != oldValue){
                refreshContactStatus();
                if ($(this).val() == "" ) {
                    $(this).attr("oldvalue","");
                } else {
                    $(this).attr("oldvalue",newValue);
                    getContactMessage();
                }
            }
        });
        inputContact.addClass("binded")
    }
    refreshContactStatus();
}
function refreshContactStatus(){
    var accountName = $("input[id$=inp_contactName]").val();
    var contactFileds = $(".contactClass");
    if ( accountName == "" ) {
        contactFileds.each(function(){
            if (this.nodeName == 'TEXTAREA') {
                $(this).text("");
            } else {
                if (this.type == 'checkbox') $(this).prop("checked",false);
                else $(this).val("");
            } 
            $(this).attr("disabled","disabled");
            $(this).css("background","lightgray");
        });
    } else {
        contactFileds.each(function(){
            $(this).removeAttr("disabled");
            $(this).css("background","");
        });
    }
}
// 获取お客様信息
function getContactMessage(){
    var contactId = $("input[id$=inp_contactName_lkid]").val();
    if (contactId == "") return;
    var filedNames = '';
    $(".contactClass").each(function(){
        var fileName = $(this).attr("fileName");
        filedNames += fileName + ',';
    });
    var objInfo = {
        accountId : contactId,
        contactFields : filedNames
    }
    var requestInfo = JSON.stringify(objInfo);
    Visualforce.remoting.Manager.invokeAction(
        "{!$RemoteAction.BillSimpleInputCtrl.getContactById}", requestInfo, function(result, event){
        if (event.type == 'exception') {
        } else {
            if ( result != undefined) {
                $(".contactClass").each(function(){
                    var fileName = $(this).attr("fileName");
                    if ( fileName in result) {
                        var field = result[fileName];
                        if (field.value == undefined) field.value = "";
                        // 日付タイプ
                        if ( field.typeName == 'DATE') {
                            if (field.value == undefined || field.value == "" ) $(this).val(field.value);
                            else $(this).val(kendo.toString(new Date(field.value),JINYACONNECT.DateFormat));
                        } else if (field.typeName == 'DATETIME') {
                            if (field.value == undefined || field.value == "" ) $(this).val(field.value);
                            else $(this).val(kendo.toString(new Date(field.value),JINYACONNECT.DateTmFormat));
                        } else if (field.typeName == 'BOOLEAN') {
                            $(this).prop("checked",field.value);
                            var checkboxValue = field.value ? 1 : "";
                            $(this).val(checkboxValue);
                        } else if (field.typeName == 'TEXTAREA') $(this).text(field.value);
                        else if (field.typeName == 'REFERENCE') {
                            var elementId = $(this).attr("id");
                            $("[id='" + elementId + "_lkid]'").val(field.id);
                            $(this).val(field.value);
                        }
                        else $(this).val(field.value);
                    }
                });
            }
        } // End else
    });
}
function checkRequired(){
    var hadNoRequireFlag = false;
    $("div.requiredInput").each(function(){
        var reuireInput = $("input",this).val();
        if ( reuireInput == "" ) {
            hadNoRequireFlag = true;
        }
    });
    return hadNoRequireFlag;
}
// 2017/09/06 会計メッセージ項目自定義機能追加 by zy END
// 2018/01/19 会計レシート印刷機能言語選択する　by　zy BEGIN
//　会計書の設定更新
function setPrintSetting(){
    // レシート言語
    var language = $("#dialog_language").val();
    var printObj = {'language':language};
    var pntSetting = JSON.stringify(printObj);
    $("input[id$=hidReciptJson]").val(pntSetting);
}
// 2018/01/19 会計レシート印刷機能言語選択する　by　zy END
// 2018/03/30 会計書の店舗切替を保存 WGCH BEGIN
function getUserId() {
    return $("#hidUserId").val();
}
function getAccSpcd(){
    return $("#hidAccSpCd").val();
}
function getBillSpCd(){
    return $("#hidBillSpCd").val();
}
function getSpcdCookieFlg(){
    return $("#hidSpCdCookieFlg").val() == "true";
}
function setSpCdCookieFun(demoKey, cookVal){
    // 2019/03/29 印刷エラー発生bug fix by zy BEGIN
    if (cookVal != undefined) {
        JINYACONNECT.CONFIG.saveKrepConfig(demoKey, cookVal ,getUserId(),'');
    }
    // 2019/03/29 bug fix by zy END
}
// 2018/03/30 会計書の店舗切替を保存 WGCH END
// 2019/06/30 会計書の発行日付を変更機能 BY zyz BEGIN
function getReceiptDate(){
    var strAccountReceiptDate = $("[id$=':accountReceiptDate']").val();
    var custUrl = "";
    if ($.trim(strAccountReceiptDate).length > 0) {
        custUrl += "&accRepDt=" + encodeURIComponent(strAccountReceiptDate);
    } else {
        custUrl += "&accRepDt=";
    }
    return custUrl;
}
// 2019/06/30 会計書の発行日付を変更機能 BY zyz END
</script>
<!-- 2018/06/12 SCANER機能新規 by zy BEGIN -->
<script>
var devicePnt,loadingData = [],curGuuid;
var getDataCommand = '{"parameter":{},"scanner":true,"sequence":"barcodereaderdata"}';
var endDataCommand = '{"parameter":{},"scanner":true,"sequence":"barcodereaderclear"}';
var processInterId,scrannTimeoutId;
var hadClosed = false;
var SCANNERLABEL = {
    BEGIN:"{!$LABEL.MSG_006_0456}",
    END:"{!$LABEL.MSG_006_0457}",
}
function scrannerInit(){
    if (devicePnt == undefined) {
        var url = $j("[id$=hidPrinUrl]").val();
            if (url == "" || url == null) return;
        try {
        devicePnt = $j.WebPrint({
            // 2017/07/26 4）ログ情報はDBに記載する by zy BEGIN
            //ログ保存アド
            remoteSaveLog:"{!$RemoteAction.BillSimpleInputCtrl.savePrintLodToDb}",
            // 2017/07/26 4）ログ情報はDBに記載する by zy END
            webComm:url,
            isDebug:true,
            // 2018/06/25 ログのメーセッジ表示不正修正　JINYABUG-649　by zy  BEGIN
            baseInfo:'****Scanner：' + '[ip：' + $("input[id$=hidLocalIp]").val() + ']****',
            // 2018/06/25 ログのメーセッジ表示不正修正　JINYABUG-649　by zy  END
            sendMesssage:function(e){
                try{
                    analyScrannResponse(e.data);
                }catch(err){
                }
            },
            curSeq:getDataCommand,
            // 2021/01/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy BEGIN
            afterClose:function(e){
                if (devicePnt.isRunning) {
                    //如果收银页面打开
                    this.errorMessage = '接続失敗、<span class="scanTime">3</span>秒後再接続';
                    this.isRunning = false;
                    if (this.TITLE.CONNECTFAIL == this.connectStatus) {
                        if ($j("#scannerSpan").is(":visible")) {
                            $j("#scannerSpan").html(this.errorMessage);
                            //调用定时器重新启动此次呼叫
                            this.failTimeout = 3;
                            clearInterval(this.interval);
                            clearTimeout(this.timoutId);
                            var timeOut = kendo.parseInt(this.failTimeout);
                            var minus = timeOut;
                            this.interval = setInterval(function(){
                                if (minus == 0) clearInterval(this.interval);
                                $("span.scanTime").text(minus);
                                minus--;
                            },1000);
                            this.timoutId = setTimeout(onDeviceStart,(timeOut + 1)*1000);
                        }
                    }
                }
            }
            // 2021/01/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy END
        });
        }catch(e){
            consoleLog(e);
        }
        // 2020/12/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy BEGIN 
        if (isAutoScanerConect()) onDeviceStart();
        // 2020/12/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy END 
    }
}
// 选中时启动时间
function onDeviceStart(){
    hadClosed = false;
    // 防止多次启动
    if (devicePnt != undefined && !devicePnt.isRunning) {
        $j("#scannerSpan").text(SCANNERLABEL.BEGIN);
        devicePnt.isRunning = true;
        // 无连接时进行启动，防止重复链接
        if (!devicePnt.isConnect()) scrannerStart();
        if (processInterId) clearInterval(processInterId);
        processInterId = setInterval(function(){
            getNextProdAccount();
        },100);
        // 2021/01/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy BEGIN
        clearInterval(devicePnt.interval);
        clearTimeout(devicePnt.timoutId);
        // 2021/01/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy END
    }
}
// 关闭射频
// 2020/12/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy BEGIN 
function scrannerEnd(stopFlg){
// 2020/12/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy END 
    if (devicePnt == undefined) return;
    // 2020/12/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy BEGIN 
    if (stopFlg != true && isAutoScanerConect()) return;
    // 2020/12/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy END 
    try{
        // 清除监视器
        // 链接断开、处理数据为空
        if (processInterId) clearInterval(processInterId);
        // 清除计时器
        if (scrannTimeoutId) clearTimeout(scrannTimeoutId);
        devicePnt.isRunning = false;
        devicePnt.disconnect();
        hadClosed = true;
        // 2018/06/25 再開データ取込不正エラー修正 JINYABUG-650　by zy BEGIN
        curGuuid = '';
        loadingData = [];
        // 2018/06/25 再開データ取込不正エラー修正 JINYABUG-650　by zy END
        // 2021/01/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy BEGIN
        clearInterval(devicePnt.interval);
        clearTimeout(devicePnt.timoutId);
        // 2021/01/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy END
    }catch(e) {
        consoleLog(e);
    }
    if ($j("#scannerSpan").is(":visible")) $j("#scannerSpan").text(SCANNERLABEL.END);
}
// 清空射频内容
function clearScan(){
    devicePnt.send(endDataCommand);
}
//射频处理开始
function scrannerStart(){
    // 正常链接
    devicePnt.reConnectLast();
}
// 回传值分析
function analyScrannResponse(res){
    // 射频抢反馈信息
    if (res.indexOf("scanner")>=0) {
        // 分析返回字符串
        var response = JSON.parse(res);
        // 射频抢中读取到数据
        if (response.prods.length > 0) {
            // 存在处理中的数据
            setAccountData(response.prods);
        }
    }
    if (scrannTimeoutId) clearTimeout(scrannTimeoutId);
    scrannTimeoutId = setTimeout(function(){
        scrannerStart();
    },50);
}
// 回传值存放
function setAccountData(prods){
    if (prods.length == 0) return;
    loadingData = loadingData.concat(prods);
}
// 处理商品
function processAccountMaster(){
    if (loadingData.length > 0) {
        var loadLength = loadingData.length;
        var prodCode = loadingData[0];
        if (prodCode == "") {
            skipAccount();
            return;
        }
        curGuuid = kendo.guid();
        // 2020/12/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy BEGIN 
        var prodBtn = $j("[data-jancode='" + prodCode + "']");
        if (prodBtn.length == 0) prodBtn = $j("[data-code='" + prodCode + "']");
        // 2020/12/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy END
        if (prodBtn.length > 0) {
            prodBtn.get(0).click();
        } else {
             Visualforce.remoting.Manager.invokeAction(
                "{!$RemoteAction.BillSimpleInputCtrl.getArrayProductItemInfo}", prodCode, function(result, event){
                if (event.type == 'exception') {
                } else {
                    if (result.length == 0) {
                        // 2020/12/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy BEGIN 
                        alert("コード「" + prodCode + "」の会計商品が見つかりませんでした、読み込み対象外となります。");
                        // 2020/12/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy END 
                        skipAccount();
                        return;
                    }
                    var item = result[0];
                    item.id = item.productId;
                    item.value = item.prodcutName + "("+item.prodcutCode+")";
                    // 2018/06/28 会計商品取得の場合行追加　バグ修正JINYABUG-662　by　zy BEGIN
                    // 会計商品のフラグ
                    item._selfClickType = 'product';
                    // 2018/06/28 会計商品取得の場合行追加　バグ修正JINYABUG-662　by　zy END
                    autoGetProductInfo(item);
                } // End else
            });
        }
    }
}
// 跳过一个商品
function skipAccount(){
    curGuuid = "";
    // 下一个执行内容作成
    nextAccountData();
}
// 下一个执行内容作成
function nextAccountData(){
    if (loadingData.length > 0) loadingData.splice(0,1);
    if (loadingData.length == 0) curGuuid = "";
}
// 判断是否要进行下一个
function getNextProdAccount(){
    // 当前有处理中的prod
    if (curGuuid != undefined && curGuuid != "") {
        var tranDetail = $j("tr.tranDetailRow[scanUid='" + curGuuid + "']");
        // 证明处理成功可以进行下一个
        if (tranDetail.length > 0) {
            // 根据当前row进行滚动
            chkScrollRowToScreen(tranDetail);
            nextAccountData();
            processAccountMaster();
        }
    } else processAccountMaster();
}
// 根据当前row进行滚动
function chkScrollRowToScreen(screenRow){
    var condiv = $j("#contentDiv");
    var screenHt = condiv.height();
    if (screenRow == undefined || screenRow.length == 0) return;
    var screenTop =  screenRow.position().top;
    var conDivTop = condiv.position().top;
    var changeTop = screenTop - conDivTop + $j("#contentDiv").scrollTop();
    if (conDivTop > screenTop || screenTop > (conDivTop + screenHt)) condiv.scrollTop(changeTop);
}
// 2018/07/27 宿泊税計算 WGCH BEGIN
var specialTaxFlg = false;
var planItemPriceMap = new Map();
var hotelData = {!hotelInfoJson};
// 2018/07/27 宿泊税計算 WGCH END
// 2019/04/30 増税仮対応 WGCH BEGIN
// 自己写一个set函数=>set转成array
Object.defineProperty(Set.prototype, 'arr', {get : function(){ var arr = []; this.forEach(function(value, key){arr.push(value);}); return arr;}});
// 标识符-不自动进入増税处理函数
var CUST_AUTOGETPRODUCTMODE_RETURN = 'RETUEN';
// 2019/05/31 消費税の端数計算は見積書と一致しなかった、対応 WGCH BEGIN
// 标识符-初期处理函数
var CUST_AUTOGETPRODUCTMODE_INIT = 'INIT';
// 2019/05/31 消費税の端数計算は見積書と一致しなかった、対応 WGCH END
// 标识符-clearOnclick
var CUST_CLICKMODE_CLEAR = 'CLEAR';
// 增税商品数据集
var taxIncInfo = '{!taxIncMstItemJson}';
// 増税处理函数
function autoSetTaxIncProductFun(click_mode, productId){
    // 2021/04/31 #10894 bug fixed by zy BEGIN
    try {
    // 2021/04/31 #10894 bug fixed by zy END
    // 增税商品数据集转成sobj
    var taxIncMstDs = $.parseJSON(taxIncInfo);
    if(taxIncMstDs == undefined) return;
    // 不存在有效的增税商品 跳出处理
    if(taxIncMstDs.taxIncMst  == undefined || taxIncMstDs.taxIncMstId == "") return;
    // clear 增税商品时跳出处理
    if(click_mode == CUST_CLICKMODE_CLEAR && productId == taxIncMstDs.taxIncMstId) return;
    // 有效数据Map<利用日, [tr1, tr2, ...]>
    var nowProdMap = new Map();
    // 增税商品Map
    var taxIncMstMap = new Map();
    // 获取指定的增税商品Input
    var $taxIncMstInput = J_ACCOUNT_CENTER.filter("productId",taxIncMstDs.taxIncMstId);
    for (var i = 0 ; i < $taxIncMstInput.length ; i++) {
        var prod = $taxIncMstInput[i];
        // 2021/04/31 #10886 bug fixed by zy BEGIN
        var useDate = prod.get('tranUseDate');
        // 2021/04/31 #10886 bug fixed by zy END
        if (useDate == undefined || useDate == "") continue;
        if(!taxIncMstMap.has(useDate)) taxIncMstMap.set(useDate, new Array());
        taxIncMstMap.get(useDate).push(prod.index);
    }
    // 已存在的有效增税商品行
    var notTaxIncMstArr = Array.from(taxIncMstMap.keys());
    // 获取明细所有行
    var details = J_ACCOUNT_CENTER.computeValidData();
    for (var i = 0 ; i < details.length ; i++) {
        var prod = details[i];
        var useDate = prod.get('tranUseDate'),
            prodId = prod.get('Field7__c');
        if (prodId != "" && useDate != undefined && useDate != ""){
            // 当前利用日 < 定义開始日 || 当前指定日 > 終了日 跳出处理
            if(useDate < taxIncMstDs.startDate || useDate > taxIncMstDs.endDate) continue;
            if (prod.get('InvoiceNoShowFlg__c')) continue;
            if(taxIncMstDs.filterMstIdSet.indexOf(prodId) >= 0 ) continue;
            // 数量
            var nums = kendo.parseFloat(prod.get('Field21__c') || 0);
            if (nums == null) nums = 0;
            if (nums <= 0) continue;
            var tax = kendo.parseFloat(prod.get('TaxRate__c') || 0);
            // 集计消费税 > 0 的Tr
            if(tax > 0) {
                if(!nowProdMap.has(useDate)) nowProdMap.set(useDate, new Array());
                nowProdMap.get(useDate).push(prod);
                // 去掉有存在数据的
                notTaxIncMstArr.remove(useDate);
            }
        }
    }
    // 去掉无效数据处理
    if(notTaxIncMstArr.length > 0){
        for (var useDate of notTaxIncMstArr) {
            if(!taxIncMstMap.has(useDate)) continue;
            for(var wkRowIndex of taxIncMstMap.get(useDate)){
                // 2021/04/31 #10908 bug fixed by zy BEGIN
                var prod = J_ACCOUNT_CENTER.get(wkRowIndex);
                // 既存会計明細削除ない
                if (prod == null ||  prod.get('Id') != null || prod.get('Id') != "") {
                    continue;
                }
                // 2021/04/31 #10908 bug fixed by zy END
                // 当前没有处理行时, 清空增税商品行
                J_ACCOUNT_CENTER.remove(wkRowIndex);
            }
            // 去掉无效数据集
            taxIncMstMap.delete(useDate);
        }
    }
    // 处理有效行
    if(nowProdMap.size > 0){
        nowProdMap.forEach(function(nowProdArr, useDate, thisMap){
            var wkRowIndex, // 最终增税商品RowNo
                wkPriceTax = 0; // 最终增税商品单价(数量固定1)
                // ps: 计算行有可能回存在bug
            for (var i = 0; i < nowProdArr.length;i++) {
                // 当前PROD
                var prod = nowProdArr[i];
                // 当前行-消費税率
                var tax = kendo.parseFloat(prod.get('TaxRate__c'));
                if (tax == null) tax = 0;
                // 当前行-金額（税込み）
                var amountIncTax = kendo.parseFloat(prod.get('amoutIncTax'));
                if (amountIncTax == null) amountIncTax = 0;
                // 当前行-金額（税抜き）
                var amountExcTax = kendo.parseFloat(prod.get('amoutExcTax'));
                if (amountExcTax == null) amountExcTax = 0;
                // 当前行-特別税
                var numSepcTax = kendo.parseFloat(prod.get('SpecialTax__c'));
                if (numSepcTax == null) numSepcTax = 0;
                /*
                * commUtils.mathNumSub(A, B) => A - B
                * commUtils.mathNumAdd(A, B) => A + B
                * commUtils.mathNumDiv(A, B) => A / B
                * commUtils.mathNumMulti(A, B) => A * B
                算法公式:
                    增税金额 = 增税率 / 商品-消费税率 * 商品-消费税金额
                */
                // 当前行-商品-消费税金额 => 当前行-金額（税込み）-(减) 当前行-金額（税抜き）-(减) 当前行-特別税
                var priceTax = commUtils.mathNumSub( commUtils.mathNumSub(amountIncTax, amountExcTax), numSepcTax);
                // 增税金额 = 增税率 / 商品-消费税率 * 商品-消费税金额
                if(tax > 0){ // 虽然此tax一定大于0，防御处理
                    // taxIncMstDs.taxIncRate => 增税率
                    wkPriceTax = commUtils.mathNumAdd( wkPriceTax, commUtils.mathNumMulti( commUtils.mathNumDiv(taxIncMstDs.taxIncRate, tax), priceTax));
                } 
            }
            // 2019/05/31 消費税の端数計算は見積書と一致しなかった、対応 WGCH BEGIN
            // 如果已存在增税商品, 把新的增税商品-RowNo 替换成 当前存在的增税商品-RowNo
            if(taxIncMstMap.has(useDate)) {
                if(click_mode == CUST_AUTOGETPRODUCTMODE_INIT) return true;
                wkRowIndex = taxIncMstMap.get(useDate)[0];
            }
            // 2019/05/31 消費税の端数計算は見積書と一致しなかった、対応 WGCH END
            else {
                // 処理行
                // 非空行
                var index = J_ACCOUNT_CENTER.getBlankDataIdx();
                // 空行
                if (index < 0) {
                    // 2021/04/31 #10865 bug fixed by zy BEGIN
                    index = J_ACCOUNT_CENTER.getNextIdx();
                    // 2021/04/31 #10865 bug fixed by zy END
                }
                if (J_ACCOUNT_CENTER.currentRows.length > index) {
                    wkRowIndex = index;
                } else {
                    // 2020/01/30 行追加时有非空字段为空时会报错 by zy BEGIN
                    // 非空数据判断
                    if (checkRequired()) {
                        $("#inputFormErrorMsg").show();
                        $(window).scrollTop(0);
                        return false;
                    }
                    J_ACCOUNT_CENTER.addRows();
                    return;
                }
            }
            // 如果已存在增税商品, 把新的增税商品-RowNo 替换成 当前存在的增税商品-RowNo
            // if( $taxIncMstInput.length > 0) wkRowIndex = $taxIncMstInput.eq(0).attr("rowindex");
            // 最终增税商品单价(数量固定1) 小数点处理
            // 2019/05/31 消費税の端数計算は見積書と一致しなかった、対応 WGCH BEGIN
            // wkPriceTax = commUtils.mathRound(wkPriceTax, JINYACONNECT.PRODUCT.CAL.POINT_LEN, JINYACONNECT.PRODUCT.CAL.ROUND_MODE);
            wkPriceTax = commUtils.mathRound(wkPriceTax, JINYACONNECT.PRODUCT.CAL.POINT_LEN, taxIncMstDs.pointRoundModeStr);
            // 2019/05/31 消費税の端数計算は見積書と一致しなかった、対応 WGCH END
            // 数据集-克隆处理-防止地址共存【true: 深度克隆; false: 浅度克隆(def) 】
            _thisTaxIncMstDs = $.extend(true, {}, taxIncMstDs);
            // 最终增税商品RowNo赋值
            _thisTaxIncMstDs.taxIncMst.rowIndex = wkRowIndex;
            // 最终增税商品单价(数量固定1)赋值
            _thisTaxIncMstDs.taxIncMst.unitPrice = wkPriceTax;
            // 最终增税商品单价 > 0 时再处理追加或更新 增税商品
            if(wkPriceTax > 0){
                autoGetProductInfo(_thisTaxIncMstDs.taxIncMst, CUST_AUTOGETPRODUCTMODE_RETURN);
                // 这个利用日优先显示*自动设定売上計上日优先级略低
                var prod = J_ACCOUNT_CENTER.get(wkRowIndex);
                prod.set({UseDate__c : useDate});
                var curRow = J_ACCOUNT_CENTER.currentRows.eq(prod.index);
                J_ACCOUNT_CENTER.getRowDom(curRow).useDateInput.val(useDate);
            }
            // 如果当前行存在增税商品数据=>clear当前行数据
            else {
                var prod = J_ACCOUNT_CENTER.get(wkRowIndex);
                if (prod != null && prod.get('Field7__c') == taxIncMstDs.taxIncMstId) {
                    // 当前没增税金额时, 清空增税商品行
                    J_ACCOUNT_CENTER.remove(wkRowIndex);
                }
            }
        });
    }
    // 2021/04/31 #10894 bug fixed by zy BEGIN
    }catch (err) {
        console.log(err);
    }
    // 2021/04/31 #10894 bug fixed by zy END
}
// 2019/04/30 増税仮対応 WGCH END
// 2019/07/30 軽減税率機能対応 WGCH BEGIN
var isReducedTaxFlg = {!isReducedTaxFlg}, // 軽減税率機能FLG
    // _planItemMap = new Map(), // 选中所有PLAN对应的PLAN明细MAP
    CUST_TABLE = "table[id$=':tran1Table']", // 明细行TableID
    ACTTYPE_PLAN = "{!JSENCODE(ACTTYPE_PLAN)}"; // プラン
/*
* 获取カスタムメタデータ型:宿泊税定义信息
*/
function getHotelTaxInfoFun(){
    var _hotelTaxData = hotelData.hotelTaxDefInstance["{!JSENCODE(oShopCode)}"];
    return {
        data : _hotelTaxData, // 宿泊税定义信息
        isEffectiveFlg : _hotelTaxData != undefined // 判断是否有效的宿泊税数据集
        // 2019/10/02 PlanHeader算法切换对应 WGCH BEGIN
        ,planBrkToHeaderCalFlg : {!planBrkToHeaderCalFlg}
        // 2019/10/02 PlanHeader算法切换对应 WGCH END
    }
}
// 軽減税率機能対応
function setPlanBrkInfo(){
    var pAccMasterMap = JSON.parse($("input:hidden[id$=':planBrkInfoMapJsonId']").val());
    // 所有的入力明细行
    for(var i = 0, len = J_ACCOUNT_CENTER.details.length; i < len; i++){
        // 当前行-RowNo
        var prod = J_ACCOUNT_CENTER.get(i);
        // 获取当前行数据集
        var _row = J_ACCOUNT_CENTER.getRowInfoFun(prod);
        // Plan类型处理
        if(_row.actionType != ACTTYPE_PLAN) continue;
        var pTranId = prod.get('tranId');
        var _dataArr = pAccMasterMap[pTranId];
        if(commUtils.isUndefined(_dataArr)) continue;
        var newPlanItemLst = new Array();
        // 2019/10/08 メディア毎消費税額修正对应 WGCH BEGIN
        var planBrkInfo = "";
        // 2019/10/08 メディア毎消費税額修正对应 WGCH END
        for(var m = 0, pdLen = _dataArr.length; m < pdLen; m++){
            // 当前明细数据集
            var _pd = _dataArr[m];
            // PUSH最新的数据集
            newPlanItemLst.push(commUtils.setData(_row.rowIndex, _pd.unitPrice, _pd.tax, _pd.serviceRate, _row.nums, _pd.specialTax, _pd.unitPriceKbn, _pd.productId, _pd.actionType, true));
            // 2019/10/08 メディア毎消費税額修正对应 WGCH BEGIN
            // PlanBrkInfo=> 単価 : 消費税 : サービス料 : 数量 : 特別税 : 会計商品単価定義区分 : 会計商品Id : 商品処理種別;
            planBrkInfo += _pd.unitPrice + ':' + _pd.tax + ':' + _pd.serviceRate + ':' + _pd.nums + ':' + _pd.specialTax + ':' + _pd.unitPriceKbn + ':' + _pd.productId + ':' + _pd.actionType + ';';
            // 2019/10/08 メディア毎消費税額修正对应 WGCH END
        }
        // 2019/10/08 メディア毎消費税額修正对应 WGCH BEGIN
        prod.set({planBrkInfo:planBrkInfo});
        // 2019/10/08 メディア毎消費税額修正对应 WGCH END
        // 2021/07/15 #12910 bug fixed by zy BEGIN
        // 更新最新的PLAN明细数据集
        prod.set('planItemLst',newPlanItemLst);
        // 2021/07/15 #12910 bug fixed by zy END
    }
}
// 2019/07/30 軽減税率機能対応 WGCH END
// 2020/12/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy BEGIN 
function isAutoScanerConect(){
    return $("input[id=hidAutoScanerConnectFlg]").val() == "true";
}
// 2020/12/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy END 
// 2021/03/30 CPU LIMITの最適化 WGCH BEGIN
function getLimitFlg(){
    return $("input:hidden[id$='hidLimitFlgId']").val() == "true";
}
function getAutoSaveMessage(){
    return $("input[id$=hidAutoSaveMessage]").val();
}
function noRefreshUpsertCallBack(){
    // 釣銭機ありの場合
    if (changeSwitch) {
        if (actionSaveFlag) {
            addPaysInfo();
        }
        // 结束执行后保存锁解开
        actionSaveFlag = false;
    }
    //恢复正常颜色
    JINYACONNECT.unblockUi();
}
// 2021/03/30 CPU LIMITの最適化 WGCH END
function consoleLog(str){
    if (COMM_SET.IS_DEBUG){
        console.log(str);
    }
}
// 2021/04/31 #10743 bug fixed by zy BEGIN
function getErrorFlg(){
    return $("input[id$=hisIsErrorFlg]").val() == "true";
}
// 2021/04/31 #10743 bug fixed by zy END
</script>
<!-- 2018/06/12 SCANER機能新規 by zy END -->
<apex:form id="billInputForm" > 
<apex:outputPanel id="errPanel">
<apex:pageMessages />
<!-- 2017/09/06 会計メッセージ項目自定義機能追加 by zy BEGIN -->
<div class="message errorM3" id="inputFormErrorMsg" role="alert" style="display:none;">
    <table border="0" cellpadding="0" cellspacing="0" class="messageTable" style="padding:0px;margin:0px;">
        <tbody>
            <tr valign="top">
                <td><img alt="ERROR" class="msgIcon" src="/s.gif" title="ERROR"/></td>
                <td class="messageCell">
                    <div class="messageText">
                        <span style="color:#cc0000"><h4>{!$Label.CONST_003_0132}:</h4></span>{!$Label.MSG_003_0105}<br/>
                    </div>
                </td>
            </tr>
            <tr>
                <td></td>
                <td></td>
            </tr>
        </tbody>
    </table>
</div>
<!-- 2017/09/06 会計メッセージ項目自定義機能追加 by zy END -->
</apex:outputPanel>
<input type="hidden" id="hidRelAccountIds" value="{!RelAccountIds}"/>
<input type="hidden" id="dumyfieldId" />
<input type="hidden" id="hidCommNoShowRequestFlg" value="{!commNoShowRequestFlg}"/>
<input type="hidden" id="hidCurrAccountId" value="{!oAcountSobj.id}" />
<input type="hidden" id="hidSalesDateRangeStr" value="{!gSalesDateRangeStr}" />
<input type="hidden" id="hidCurrLeadIdStr" value="{!oAcountSobj.Relreserve__c}" />
<!--//2017/04/19 レシート印刷機能追加　by zy BEGIN-->
<input type="hidden" id="hidPrintIncludeIps" value="{!printIncludeIp}" />
<apex:outputPanel id="printPanel">
    <apex:inputHidden value="{!localIp}" id="hidLocalIp" />
    <apex:inputHidden value="{!prinUrl}" id="hidPrinUrl" />
    <apex:inputHidden value="{!statusUrl}" id="hidStatusUrl" />
    <apex:inputHidden value="{!printJson}" id="printJson"/>
    <!-- 2017/06/29 ポース機能追加する　by　zy　BEGIN -->
    <apex:inputHidden value="{!curPosNo}" id="hidCurPos"/>
    <!-- 2017/06/29 ポース機能追加する　by　zy　END -->
    <!-- 2018/01/19 会計レシート印刷機能言語選択する　by　zy BEGIN -->
    <apex:inputHidden value="{!reciptJson}" id="hidReciptJson"/>
    <!-- 2018/01/19 会計レシート印刷機能言語選択する　by　zy END -->
    <!--2020/12/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy BEGIN  -->
    <input type="hidden" id="hidAutoScanerConnectFlg" value="{!autoScanerConnectFlg}" />
    <!--2020/12/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy END  -->
</apex:outputPanel>
<!--//2017/04/19 レシート印刷機能追加　by zy END-->
<!-- 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH BEGIN -->
<!--
<apex:actionFunction name="insertDataFunction" 
        action="{!insertData}" 
        oncomplete="bindEvents();buttonsEnabled(true);"
        rerender="billInputForm,eventBindPanel" />
<apex:actionFunction name="upsertDataFunction" 
        action="{!upsertData}" 
        oncomplete="bindEvents();buttonsEnabled(true);"
        rerender="billInputForm,eventBindPanel" />
-->
<apex:inputHidden value="{!selectTranIdJson}" id="hidSelectTranIdJson" />
<apex:inputHidden value="{!selectTTendIdJson}" id="hidSelectTTendIdJson" />
<apex:inputHidden value="{!selectSendRoomName}" id="hidSelectSendRoomName" />
<apex:actionFunction name="insertDataFunction" 
        action="{!insertData}" 
        oncomplete="bindEvents();buttonsEnabled(true);iframeReload();"
        rerender="errPanel,baseInfoPage,tran1Block,tran1Table,printPanel,eventBindPanel" />
<apex:actionFunction name="upsertDataFunction" 
        action="{!upsertData}" 
        oncomplete="bindEvents();buttonsEnabled(true);iframeReload();"
        rerender="errPanel,baseInfoPage,tran1Block,tran1Table,printPanel,eventBindPanel" />
<apex:actionFunction name="upsertTempDataFunction" action="{!upsertData}"
             oncomplete="bindEvents();noRefreshUpsertCallBack()" reRender="errPanel,printPanel,baseInfoPage"/>
<!-- 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH END -->
<apex:actionFunction name="gotoCancelFunction" action="{!gotoCancel}" immediate="true" />
<!--//2017/04/19 レシート印刷機能追加　by zy BEGIN-->
<apex:actionFunction name="processPrint" action="{!print}" oncomplete="reshitoPrint();" rerender="printPanel" />
<!-- 2017/06/29 ポース機能追加する　by　zy　BEGIN -->
<!-- 2018/06/12 SCANER機能新規 by zy BEGIN -->  
<apex:actionFunction name="initDeviceFun" action="{!initDevice}"  rerender="printPanel" oncomplete="scrannerInit();" />
<!-- 2018/06/12 SCANER機能新規 by zy END -->    
<!-- 2017/06/29 ポース機能追加する　by　zy　END -->
<!--//2017/04/19 レシート印刷機能追加　by zy END-->
<style>
input.inputTextClass {
    
    height: 21px;
    border-top-width: 0px;
    border-right-width: 0px;
    border-bottom-width: 1px;
    border-left-width: 0px;
    border-top-style: none;
    border-right-style: none;
    border-bottom-style: solid;
    border-left-style: none;
    background-color: transparent;
    font-size: 100%;
}
/*
a {
text-decoration: none;
}*/
table.infoTableClass {
    table-layout: fixed;
    width:100%;
    word-spacing: 0px;
    border-collapse: 0px;
    border-spacing: 0px;
    border: 1px;
}
table.infoTableClass tr{
    height: 24px;
    min-height: 24px;
}
.k-numerictextbox .j-numberInput {
    width:96%;
    text-align: right;
    padding-right: 5px !important;
    font-size: 1em;
    font-weight: bold; 
}
</style>


<!-- 2021/03/30 CPU LIMITの最適化 WGCH BEGIN -->
<input type="hidden" id="hidLimitFlgId" value="{!limitFlg}" />
<!-- 2021/03/30 CPU LIMITの最適化 WGCH END -->
<table style="width:100%;word-spacing: 0px;border-collapse: 0px;border-spacing: 0px;border: 0px;">
    <tr>
    
    <!-- 会計関連情報 -->
    <td style="width: 50%; vertical-align: top;">
    
    <apex:pageblock title="" id="baseInfoPage">
        <!-- 2021/07/15 #13633 bug fixed by zy  BEGIN -->
        <!-- 軽減税率機能対応 -->
        <apex:inputHidden value="{!planBrkInfoMapJson}" id="planBrkInfoMapJsonId" />
        <!-- 2021/07/15 #13633 bug fixed by zy  END -->
        <!-- Hidden Info -->
        <apex:inputHidden value="{!oAcountSobj.AccountName__c}" id="hidAccountId"/>
        <apex:inputHidden value="{!oAcountSobj.AccountReceiptName__c}" id="hidReceiptId"/>
        <apex:inputHidden value="{!oAcountSobj.AccountProviso__c}" id="hidProvisoId"/>
        <!-- 2016/02/25 Log Info -->
        <apex:inputHidden value="{!clientLog}" id="hidClientLogId" />       
        <apex:inputHidden value="{!itemJson}" id="hidItemJsons" />
        <!-- 2021/04/31 #10743 bug fixed by zy BEGIN -->
        <apex:inputHidden value="{!isErrorFlg}" id="hisIsErrorFlg"/>
        <!-- 2021/04/31 #10743 bug fixed by zy END -->
        <apex:pageBlockButtons location="top">

            <apex:outputPanel >
            <table style="min-width: 100%;table-layout: fixed;">
                <tr>
                <td style="width: 202px">
                    <h2 class="mainTitle">
                        <img style="width:32px;height:32px;" src="/img/icon/bank32.png"/>
                        <span style="margin-left:4px;font-size:1.2em;vertical-align: super;">{!oAcountSobj.Name}</span>
                    </h2>
                </td>
                <!-- 2017/11/20 英語の場合対応　by　zy　BEGIN -->
                <td style="width: 390px;text-align: left;">
                <!-- 2017/11/20 英語の場合対応　by　zy　END -->
                    <table><tr>
                    <td>
                        <!-- 保存 -->
                        <!-- 2018/06/12 SCANER機能新規 by zy BEGIN -->  
                        <!-- 2020/12/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy BEGIN  -->
                        <!-- 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH BEGIN -->
                        <apex:outputPanel rendered="{!oPage.isUpd}" layout="block" styleClass="toolButttonStyle upsertClass" style="border-left: groove 2px #ffffff;cursor:pointer"
                            onclick="scrannerEnd(true);if(!copySelectValToHidden()){return false;};refreshOrder();upsertDataFunction();buttonsEnabled(false);JINYACONNECT.blockUi();" >
                        <!-- 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH END -->
                        <!-- 2018/06/12 SCANER機能新規 by zy END -->        
                            <img title="{!$Label.MSG_006_0242}" alt="{!$Label.MSG_006_0242}" src="{!URLFOR($Resource.AppImages, 'toolbtnicon/save.png')}" />
                            <br/><span style="">{!$Label.MSG_006_0242}</span>
                        </apex:outputPanel>
                        <!-- 保存 -->
                        <!-- 2018/06/12 SCANER機能新規 by zy BEGIN -->  
                        <!-- 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH BEGIN -->
                        <apex:outputPanel rendered="{!oPage.isIns}" layout="block" styleClass="toolButttonStyle upsertClass" style="border-left: groove 2px #ffffff;cursor:pointer"
                            onclick="scrannerEnd(true);if(!copySelectValToHidden()){return false;};refreshOrder();insertDataFunction();buttonsEnabled(false);JINYACONNECT.blockUi();" >
                        <!-- 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH END -->
                        <!-- 2018/06/12 SCANER機能新規 by zy END -->        
                            <img title="{!$Label.MSG_006_0242}" alt="{!$Label.MSG_006_0242}" src="{!URLFOR($Resource.AppImages, 'toolbtnicon/save.png')}" />
                            <br/><span style="">{!$Label.MSG_006_0242}</span>
                        </apex:outputPanel>
                        <!-- 2020/12/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy END  -->
                        <!-- キャンセル -->
                        <!-- 2018/06/12 SCANER機能新規 by zy BEGIN -->  
                        <apex:outputPanel layout="block" styleClass="toolButttonStyle"
                            onclick="scrannerEnd();gotoCancelFunction();buttonsEnabled(false);JINYACONNECT.blockUi();" style="cursor:pointer" rendered="{!!isFromBookingFlexApp}"> 
                        <!-- 2018/06/12 SCANER機能新規 by zy END -->        
                            <img title="{!$Label.MSG_006_0239}" alt="{!$Label.MSG_006_0239}" src="{!URLFOR($Resource.AppImages, 'toolbtnicon/cancel.png')}" />
                            <br/><span style="">{!$Label.MSG_006_0239}</span>
                        </apex:outputPanel>
                        <apex:outputPanel layout="block" rendered="{!isFromBookingFlexApp}">
                            <a class="toolButttonStyle" href="{!returnUrl}" 
                                onclick="JINYACONNECT.blockUi();"
                                style="width: 75px; float: left; text-align: center;border-right: groove 2px #ffffff;cursor:pointer;text-decoration:none;">
                                <img title="{!$Label.MSG_006_0239}" alt="{!$Label.MSG_006_0239}" src="{!URLFOR($Resource.AppImages, 'toolbtnicon/cancel.png')}" />
                                <br/><span style="">{!$Label.MSG_006_0239}</span>
                            </a>
                        </apex:outputPanel>
                        <!-- 会計書 -->
                        <!-- 2018/06/12 SCANER機能新規 by zy BEGIN -->  
                        <apex:outputPanel rendered="{!oPage.isUpd && !accountPopupIsShowFlg && !ISBLANK(oAcountSobj.Field53__c)}" layout="block" styleClass="toolButttonStyle"
                            onclick="javascript:directOpenAccountPdf();scrannerEnd();" style="cursor:pointer" >
                        <!-- 2018/06/12 SCANER機能新規 by zy END -->        
                            <img title="{!$Label.MSG_006_0226}" alt="{!$Label.MSG_006_0226}" src="{!URLFOR($Resource.AppImages, 'toolbtnicon/accountpdf.png')}" />
                            <br/><span style="">{!$Label.MSG_006_0226}</span>
                        </apex:outputPanel>
                        <!-- 請求書 -->
                        <!-- 2018/06/12 SCANER機能新規 by zy BEGIN -->  
                        <apex:outputPanel rendered="{!oPage.isUpd && !accountPopupIsShowFlg && !ISBLANK(oAcountSobj.Field53__c)}" layout="block" styleClass="toolButttonStyle"
                            onclick="javascript:openBillPdf();scrannerEnd();" style="cursor:pointer"  >
                        <!-- 2018/06/12 SCANER機能新規 by zy END -->        
                            <img title="{!$Label.MSG_006_0215}" alt="{!$Label.MSG_006_0215}" src="{!URLFOR($Resource.AppImages, 'toolbtnicon/billpdf.png')}" />
                            <br/><span style="">{!$Label.MSG_006_0215}</span>
                        </apex:outputPanel>     
                        <!-- 印刷 --> 
                        <!-- 2018/06/12 SCANER機能新規 by zy BEGIN -->  
                        <apex:outputPanel rendered="{!oPage.isUpd && accountPopupIsShowFlg && !ISBLANK(oAcountSobj.Field53__c)}" layout="block" styleClass="toolButttonStyle"
                            onclick="javascript:openPrintPdfWin();scrannerEnd();" style="cursor:pointer" >
                        <!-- 2018/06/12 SCANER機能新規 by zy END -->        
                            <img title="{!$Label.MSG_006_0225}" alt="{!$Label.MSG_006_0225}" src="{!URLFOR($Resource.AppImages, 'toolbtnicon/print.png')}" />
                            <br/><span style="">{!$Label.MSG_006_0225}</span>
                        </apex:outputPanel>
                        <!-- 2017/10/18 チェックアウト機能対応 BEGIN -->   
                        <!-- チェックアウト -->
                        <!-- 2018/06/12 SCANER機能新規 by zy BEGIN -->  
                        <apex:outputPanel rendered="{!oPage.isUpd && !ISBLANK(oAcountSobj.Field53__c) && isShowCheckOutBtn}" layout="block" styleClass="toolButttonStyle"
                            onclick="scrannerEnd();_JsCheckoutFunction('{!JSENCODE(oAcountSobj.Relreserve__c)}','{!JSENCODE(oAcountSobj.Relreserve__r.LeadIndexRef__c)}');" style="cursor:pointer" >
                        <!-- 2018/06/12 SCANER機能新規 by zy END -->        
                            <!-- 2017/12/18  チェックアウトLabel WGCH BEGIN -->
                            <img title="{!$Label.MSG_006_0449}" alt="{!$Label.MSG_006_0449}" src="{!URLFOR($Resource.AppImages, 'toolbtnicon/checkout.png')}" />
                            <!-- 2017/12/18 チェックアウトLabel WGCH END -->
                            <br/><span style="">{!$Label.MSG_006_0449}</span>
                        </apex:outputPanel>
                        <!-- 2017/10/18 チェックアウト機能対応 END -->
                    </td>
                    </tr></table>
                </td>
                <td></td>
                <!-- 2017/11/20 英語の場合対応　by　zy　BEGIN -->
                <td style="width: 80px;vertical-align: top;" class="labelCol">
                <!-- 2017/11/20 英語の場合対応　by　zy　END -->
                </td>
                <td style="width: 18px;"><apex:outputField value="{!oAcountSobj.AccountedFlgCal__c}" id="accountFlgCalId"/></td>
                </tr>

            </table>
            </apex:outputPanel>
        </apex:pageBlockButtons>
        <table class="infoTableClass" style="table-layout: fixed;">
            <colgroup style="width: 100px;min-width: 100px;"></colgroup>
            <colgroup style="width: 210px;min-width: 210px;"></colgroup>
            <colgroup style="width: 130px;min-width: 100px;"></colgroup>
            <colgroup style="width: 180px;min-width: 180px;"></colgroup>
            <!-- RIGHT-LINE① -->
            <tr>
                <!-- ご予約 -->
                <td class="labelCol" width="100px"><apex:outputLabel value="{!$ObjectType.AccountAcount__c.Fields.Relreserve__c.label}" /></td>
                <td width="210px">
                    <apex:outputField value="{!oAcountSobj.Relreserve__c}" rendered="{!oPage.isUpd}"/>
                    <apex:inputField value="{!oAcountSobj.Relreserve__c}" rendered="{!oPage.isIns}" styleClass="k-textbox" />
                </td>
                <!-- 入金確認 -->
                <td class="labelCol" width="130px">
                <apex:outputLabel value="{!$ObjectType.AccountAcount__c.Fields.PaymentFlg__c.label}" rendered="{!!oPage.isReceipt}"/>
                <apex:outputLabel value="{!$ObjectType.AccountAcount__c.Fields.ReceiptDt__c.label}" rendered="{!oPage.isReceipt}"/>
                </td>
                <td width="180px">
                <apex:inputField value="{!oAcountSobj.PaymentFlg__c}" id="inp_paymentFlg" onclick="handReqStatus()" rendered="{!!oPage.isReceipt}"/>
                <apex:inputHidden value="{!oAcountSobj.PaymentHandReqFlg__c}" id="inp_handReq_paymentFlg"/>
                <apex:inputField value="{!ReceiptDate.WorkDay__c}" id="inp_receiptDate"  onchange="handReqStatus()" styleClass="k-textbox" rendered="{!oPage.isReceipt}" />
                </td>
            </tr>
            <tr>
                <!-- 到着日 -->
                <td class="labelCol" width="100px"><apex:outputLabel value="{!$ObjectType.Lead__c.Fields.EntryTime__c.label}" /></td>
                <td width="210px">
                    <!-- 2019/09/15 新規予約ウインドウ、見積明細設定画面の利用日は常に到着日で設定する機能対応 WGCH BEGIN -->
                    <!-- <apex:outputText value="{!oPage.strEntryDate}" rendered="{!oPage.isUpd}"/> -->
                    <apex:outputText value="{!oPage.strEntryDate}" rendered="{!oPage.isUpd}" Id="strEntryDateId" />
                    <!-- 2019/09/15 新規予約ウインドウ、見積明細設定画面の利用日は常に到着日で設定する機能対応 WGCH END -->
                </td>
                <!-- 売上計上日 -->
                <td class="labelCol">
                    <apex:outputLink value="javascript:void(0)" onclick="window.open('/{!oAcountSobj.frs__c}' , '_blank')" rendered="{!oPage.isUpd}">
                    <apex:outputLabel value="{!$ObjectType.AccountAcount__c.Fields.SalesDate__c.label}" />
                    </apex:outputLink>
                    <apex:outputLabel value="{!$ObjectType.AccountAcount__c.Fields.SalesDate__c.label}" rendered="{!oPage.isIns}"/>
                </td>
                <td>
                    <!-- 2019/01/30 会計の売上計上日が自動入力機能対応 BEGIN -->
                    <!--
                    <apex:inputField value="{!oAcountSobj.SalesDate__c}" id="salesdate" required="true"  styleClass="k-textbox" rendered="{!oAcountSobj.Relreserve__c == null || useDateSimpleMode}"/>
                    <apex:outputField value="{!oAcountSobj.SalesDate__c}"  rendered="{!oAcountSobj.Relreserve__c != null && NOT(useDateSimpleMode)}"/>
                    -->
                    <apex:inputField value="{!oAcountSobj.SalesDate__c}" id="salesdate" required="true"  styleClass="k-textbox sakesdateCls" rendered="{!oAcountSobj.Relreserve__c == null || useDateSimpleMode}"/>
                    <apex:outputField value="{!oAcountSobj.SalesDate__c}" id="sakesdateRo" rendered="{!oAcountSobj.Relreserve__c != null && NOT(useDateSimpleMode)}"/>
                    <!-- 2019/01/30 会計の売上計上日が自動入力機能対応 END -->
                </td>
            </tr>
            <tr>
                <!-- 出発日 -->
                <td class="labelCol" width="100px"><apex:outputLabel value="{!$ObjectType.Lead__c.Fields.Departure__c.label}" /></td>
                <td width="210px">
                    <apex:outputText value="{!oPage.strDepartureDate}" rendered="{!oPage.isUpd}"/>
                </td>
                <!-- お客様 -->
                <td class="labelCol"><apex:outputLabel value="{!$ObjectType.AccountAcount__c.Fields.relaccount__c.label}" /></td>
                <td>
                    <!-- 2017/09/06 会計メッセージ項目自定義機能追加 by zy BEGIN -->
                    <apex:inputField value="{!oAcountSobj.relaccount__c}" styleClass="k-textbox" html-oldvalue="{!oAcountSobj.relaccount__c}" id="inp_contactName" 
                                     rendered="{!(curRowInfos.size == 0) || (oAcountSobj.Relreserve__c == null)}"/>
                    <apex:outputpanel rendered="{!(curRowInfos.size > 0) && (oAcountSobj.Relreserve__c != null)}">
                        <apex:outputfield value="{!oAcountSobj.relaccount__c}"/>
                        <input type="hidden" value="{!oAcountSobj.relaccount__c}" id="0:inp_contactName"/>
                    </apex:outputpanel>
                    <!-- 2017/09/06 会計メッセージ項目自定義機能追加 by zy END -->
                </td>
            </tr>
            <tr>
                <!-- お部屋 -->
                <td class="labelCol"><apex:outputLabel value="{!$Label.ps__msg_006_0243}" /></td>
                <td>
                    <apex:outputField value="{!oAcountSobj.Relreserve__r.Rroom__c}" rendered="{!oPage.isIns}" />
                    <apex:inputField value="{!oAcountSobj.Field150__c}" styleClass="k-textbox" rendered="{!AND(oPage.isUpd, oAcountSobj.Relreserve__c == null)}" />
                    <apex:outputField value="{!oAcountSobj.Relreserve__r.Rroom__c}" rendered="{!AND(oPage.isUpd, oAcountSobj.Relreserve__c != null)}" />
                </td>
                <!-- ご請求先 -->
                <td class="labelCol"><apex:outputLabel value="{!$ObjectType.AccountAcount__c.Fields.BillingCal__c.label}" /></td>
                <td>
                    <apex:outputField value="{!oAcountSobj.relaccount__r.AccountId}" id="accountName"/>
                </td>
            </tr>
            <tr>
                <!--部屋タイプ  -->
                <td class="labelCol"><apex:outputLabel value="{!$Label.ps__msg_006_0244}" /></td>
                <td><apex:outputField value="{!oAcountSobj.Relreserve__r.refTypeOfRooms__c}" /></td>
                <!-- 会計宛名 -->
                <!-- 会計書宛名 -->
                <td class="labelCol"><apex:outputLabel value="{!$Label.ps__msg_006_0237}" /></td>
                <td><apex:inputField id="accountNameSel" value="{!oAcountSobj.AccountName__c}" style="width:100%" /></td>
            </tr>
            <tr>
                <!-- 予約人數 -->
                <td class="labelCol"><apex:outputLabel value="{!$ObjectType.Lead__c.Fields.StayPersons__c.label}" /></td>
                <td><apex:inputField value="{!orgLeadSobj.StayPersons__c}" styleClass="k-textbox" style="width:50px" id="stayPeople"/></td>
                <!-- 請求書宛名 -->
                <!-- 領収証宛名 -->
                <td class="labelCol"><apex:outputLabel value="{!$Label.ps__msg_006_0227}" /></td>
                <td><apex:inputField id="accountReciptSel" value="{!oAcountSobj.AccountReceiptName__c}" style="width:100%" /></td>
            </tr>
            <tr>
                <!-- 領収書言語 -->
                <td class="labelCol"><apex:outputLabel value="{!$ObjectType.AccountAcount__c.Fields.AccountLanguage__c.label}" /></td>
                <td>
                    <apex:selectList value="{!oAcountSobj.AccountLanguage__c}" multiselect="false" size="1" id="languageSel" style="width:100%">
                        <!-- 日本語 -->
                        <apex:selectOption itemValue="jp" itemLabel="{!$Label.ps__msg_006_0234}" />
                        <!-- 英語 -->
                        <apex:selectOption itemValue="en" itemLabel="{!$Label.ps__msg_006_0236}" />
                    </apex:selectList>
                </td>
                <!-- 会計人數 -->
                <!-- 
                <td class="labelCol"><apex:outputLabel value="{!$ObjectType.AccountAcount__c.Fields.Field57__c.Label}" for="peoples" /></td>
                <td ><apex:outputField value="{!oAcountSobj.Field57__c}" style="width:24px;margin-right: 1px;" id="peoples"/></td>
                 -->
                <!-- 領収書日付 -->
                <td class="labelCol"><apex:outputLabel value="{!$ObjectType.AccountAcount__c.Fields.AccountReceiptDate__c.label}" /></td>
                <td><apex:inputField value="{!oAcountSobj.AccountReceiptDate__c}" styleClass="k-textbox" id="accountReceiptDate"/></td>

            </tr>
            <tr>
                <apex:variable var="varCommentMaxStrLen" value="{!commentMaxStrSize}" />
                <!-- Comment -->
                <td rowspan="2" class="labelCol" style="vertical-align: top;text-align: right;padding-right: 0px;">
                    <span class="helpButton" id="commentHelpLabel-_help">
                        <apex:outputLabel value="{!$ObjectType.AccountAcount__c.Fields.comment__c.label}" />
                        <img src="/s.gif" alt="" class="helpOrb" title="" style="vertical-align: middle;"/>
                        <!-- 最大入力桁数は -->    <!-- 桁です -->
                        <script>sfdcPage.setHelp('commentHelpLabel', '{!$Label.MSG_006_0245}{!varCommentMaxStrLen}{!$Label.MSG_006_0246}');</script>
                    </span>
                </td>
                <td rowspan="2" style="vertical-align: top;">
                    <apex:inputField value="{!oAcountSobj.comment__c}" label="" html-maxlength="{!varCommentMaxStrLen}" style="width:100%;height:100%"  id="accountComment"/>
                </td>
                <!-- 領収書但し -->
                <!-- 領収証但し -->
                <td class="labelCol">{!$Label.MSG_006_0228}</td>
                <td>
                <apex:inputField id="accountProvisoSel" value="{!oAcountSobj.AccountProviso__c}" style="width:100%" />
                </td>
            </tr>
            <tr>
                <!-- クーポン利用の返金 -->
                <td class="labelCol"><apex:outputLabel value="{!$Label.ps__msg_006_0247}" /></td>
                <td>
                    <apex:inputField value="{!oAcountSobj.CouponReturnFlg__c}" id="manasCoponFlg" onclick="setupCalSumAmountPrice()"/>
                </td>
            </tr>
            <!-- 
            <tr>
                <td class="labelCol" style="vertical-align: top;">
                    <apex:outputLabel value="{!$ObjectType.AccountAcount__c.Fields.comment__c.label}" />
                </td>
                <td colspan="3" style="vertical-align: top;">
                    <apex:inputField value="{!oAcountSobj.comment__c}" style="width:50%;height:100%" html-placeholder="B5 会計書: 12桁 / A4 会計書: 16桁 ごとにリターンキーを入力してください。"/>
                </td>
            </tr>
             -->
            <tr style="{!IF(isShowInCommentFlg,'','display:none')};">
                <!-- コメント（社内） -->
                <td class="labelCol" style="vertical-align: top;">
                    <apex:outputLabel value="{!$ObjectType.AccountAcount__c.Fields.Comment2__c.label}" />
                </td>
                <td style="vertical-align: top;">
                    <apex:inputField value="{!oAcountSobj.Comment2__c}" label="" style="width:100%;height:100%"/>
                </td>
                <td colspan="2"></td>
            </tr>
             <!-- 2017/09/06 会計メッセージ項目自定義機能追加 by zy BEGIN -->
             <apex:repeat value="{!curRowInfos}" var="row">
                <tr>
                    <apex:repeat value="{!row.columns}" var="col">
                        <td class="labelCol"><apex:outputLabel value="{!col.fieldLabel}" /></td>
                        <td class="customClass" colspan="{!if(row.columnInt == 1 ,'3','1')}">
                             <apex:inputField value="{!oAcountSobj[col.fieldName]}" html-fileName="{!col.name}" styleClass="{!col.styleClass}" style="width:{!if(isBlank(col.fieldStyle),'auto',col.fieldStyle)};" required="{!col.isRequired}" rendered="{!col.fieldType =='account' &&!ISBLANK(col.fieldName)}"/>
                             <apex:inputField value="{!newContact[col.fieldName]}" html-fileName="{!col.name}" styleClass="{!col.styleClass}" style="width:{!if(isBlank(col.fieldStyle),'auto',col.fieldStyle)};" required="{!col.isRequired}" rendered="{!col.fieldType =='contact' &&!ISBLANK(col.fieldName)}"/>
                             <apex:inputtextarea value="{!newContact[col.fieldName]}" html-fileName="{!col.name}" styleClass="{!col.styleClass}" style="width:{!if(isBlank(col.fieldStyle),'auto',col.fieldStyle)};" required="{!col.isRequired}" rendered="{!col.fieldType =='textarea' &&!ISBLANK(col.fieldName)}"/>
                        </td>
                    </apex:repeat>
                </tr>
            </apex:repeat>
            <!-- 2017/09/06 会計メッセージ項目自定義機能追加 by zy END -->
        </table>

    </apex:pageblock>
    </td>


    <!-- Right Panel -->
    <td style="vertical-align: top;">
        <c:BillSimpleProductComp container="{!BillSimpleProductCompId}" callbackFun="autoGetProductInfo" shopCode="{!oShopCode}" rendered="{!oPage.isUpd}"/>
    </td>
    </tr>
</table>



<!-- 下部情報 -->
<table class="infoTableClass" style="table-layout: fixed;">
    <tr>
    <!-- LEFT PANEL -->
    <td style="width: 100%; vertical-align: top;">
    <div id="tabstrip" style="width: 100%;{!if( oPage.isUpd, 'display:true','display:none')}" tabindex="-1">
        <ul style="display: none;">
            <li id="tab_trandetail" class="k-state-active">
                <!-- 保存 -->     <!-- 会計明細 -->       <!-- 会計明細 -->
                <img title="{!$Label.MSG_006_0242}" alt="{!$Label.MSG_006_0248}" style="position:relative;left:2px;top:1px;width:20px;height:20px;" src="/img/icon/creditCard32.png" />
                <span style="padding-right: 2px;">{!$Label.MSG_006_0248}</span>
            </li>
            <li id="tab_transplit"> 
                <!-- 明細分割 -->       <!-- 保存 -->     <!-- 明細分割 -->
                <img title="{!$Label.MSG_006_0249}" alt="{!$Label.MSG_006_0242}" style="position:relative;left:2px;top:1px;width:20px;height:20px;" src="{!URLFOR($Resource.AppImages, 'toolbtnicon/accountsplit.png')}" />
                <span style="padding-right: 2px;">{!$Label.MSG_006_0249}</span>
            </li>
            <!-- 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH BEGIN -->
            <li id="tab_accountSkip" style="{!IF(accSkipTabShow && (oAcountSobj.Relreserve__c != null), '', 'display:none;')}"> 
                <!-- 会計飛ばし -->
                <img title="{!$Label.MSG_006_0464}" alt="{!$Label.MSG_006_0464}" style="position:relative;left:2px;top:1px;width:20px;height:20px;" src="{!URLFOR($Resource.AppImages, 'toolbtnicon/contract-approve.png')}" />
                <span style="padding-right: 2px;">{!$Label.MSG_006_0464}</span>
            </li>
            <!-- 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH END -->
        </ul>
    <!-- 仮情報格納用 -->
    <input type="hidden" id="hidCallBtnId" />
    <!-- 2017/07/14 釣銭機の行追加エラー発生by zy BEGIN-->
    <input type="hidden" id="hidIntPrice" />
    <!-- 2017/07/14 釣銭機の行追加エラー発生by zy END-->
    <apex:pageblock title="" id="tran1Block" rendered="{!oPage.isUpd}" >
        
        <!-- 新規一行追加 -->
        <apex:actionFunction name="addTranItemFun" action="{!addTran1Item}" status="JINYACONNECT_LOADINGSTATUS" 
            oncomplete="bindEvents();autoFocus();" reRender="tran1Table"/>
        <!-- 2017/08/10 入金自動レシート印刷機能追加　by　zy BEGIN -->
        <!-- 会計明細リアル -->
        <!-- 2017/11/23 釣銭機自動保存の場合、usedAmount設定不正の修正　by　zy BEGIN -->
        <apex:actionFunction name="refreshTranItemFun" action="{!refreshTran1Item}"
             oncomplete="bindEvents();noRefreshUpsertCallBack()" reRender="errPanel,printPanel,baseInfoPage"/>
        <!-- 2017/11/23 釣銭機自動保存の場合、usedAmount設定不正の修正　by　zy END -->
        <!-- 2017/08/10 入金自動レシート印刷機能追加　by　zy END -->
    <!-- 会計明細 -->
    <div id="tranPanel" style="overflow: hidden;">
        <table style="border: 0;border-spacing: 0;width: 100%;table-layout: fixed;">
        <tr><td>
            <!-- 2018/06/12 SCANER機能新規 by zy BEGIN -->
            <span id="scannerSpan" style="font-size: 15px;color: green;position: absolute;"></span>
            <!-- 2018/06/12 SCANER機能新規 by zy END -->
        <table style="border-spacing: 0px;border-collapse: 0px;table-layout: fixed;width:100%" name="totalTable">
            <tr>
            <td style="width:75.5%; text-align: right;vertical-align: middle;text-align: right;">
                <table style="width: 100%; border-spacing: 0px;border-collapse: 0px; font-size: 16px;font-weight: bold;table-layout: fixed;text-align: right;">
                    <tr>
                        <td style="height: 24px;">
                            <!-- ご利用金額(税込)： -->
                            <span>{!$Label.MSG_006_0250}</span>
                        </td>
                        <td style="width: 110px">
                            <input type="hidden" id="totalAmountExcTax" />
                            <apex:outputPanel style="margin-right: 2px;" id="usedAmount">
                                <span id="usedAmountBlock"></span>      
                            </apex:outputPanel>
                        </td>
                    </tr>
                    <tr>
                        <!-- 2020/01/30 行追加ボタン機能対応 BY zyz BEGIN -->
                        <td style="height: 24px;position:relative;">
                        <!-- 2020/01/30 行追加ボタン機能対応 BY zyz END -->
                            <!-- ご請求金額(税込)： -->
                            <span>{!$Label.MSG_006_0259}</span>
                            <!-- 2020/01/30 行追加ボタン機能対応 BY zyz BEGIN -->
                            <!-- 行追加  -->  
                            <span style="position: absolute;left: 0px;top: 0px;">
                                <input class="btn" value="{!$Label.MSG_011_0052}" type="button" onclick="J_ACCOUNT_CENTER.addRows();" style="width: 100px;" />
                                <!-- 2021/02/28 CPU LIMITの最適化 WGCH BEGIN -->
                                <!-- <span id="warningMsgSpan" style="font-size: 15px; color: #f90; z-index:1; display:none; margin-left: 10px; font-weight: 100;">{!maxRowsMsg}</span> -->
                                <!-- 2021/02/28 CPU LIMITの最適化 WGCH END -->
                            </span>
                            <!-- 2020/01/30 行追加ボタン機能対応 BY zyz END -->
                        </td>
                        <td style="width: 110px">
                            <apex:outputPanel style="margin-right: 2px;" id="reqAmount">
                                <span id="reqAmountBlock"></span>   
                            </apex:outputPanel>
                        </td>
                    </tr>
                    
                </table>
                <!-- 
                <div style="float: right;">
                    <div style="font-size: 16px; font-weight: bold; text-align: center; vertical-align: bottom; height: 24px; width: 240px; background-color: transparent;">
                    <span style="float: left; margin-left: 2px;">ご利用金額(税込)：</span>
                    <apex:outputPanel style="float: right; margin-right: 2px;font-weight: bold;" id="usedAmount">
                        <span id="usedAmountBlock"></span>      
                    </apex:outputPanel>
                </div>
                
                    <div style="margin-top:1px ;font-size: 16px; font-weight: bold; text-align: center; vertical-align: bottom; height: 24px; width: 240px; background-color: transparent;">
                    <span style="float: left; margin-left: 2px;">ご請求金額(税込)：</span>
                    <apex:outputPanel style="float: right; margin-right: 2px;font-weight: bold;" id="reqAmount">
                        <span id="reqAmountBlock"></span>   
                    </apex:outputPanel>
                </div>
                </div>
                 -->
            </td>
            <td style="width: 24.5%" class="fixedWidthCol0">&nbsp;</td><!-- 金額(税抜)~以後の列の横幅 -->
            </tr>
        </table>
        <!-- 商品情報 -->
        <table class="list" style="height: 18px;overflow-x: hidden;background: #f2f3f3;table-layout: fixed;" name="tranHeadTable" border="0" cellpadding="0" cellspacing="0">
            <colgroup/>
            <colgroup/>
            <colgroup/>
            <colgroup/>
            <colgroup/>
            <colgroup/>
            <colgroup/>
            <colgroup/>
            <colgroup/>
            <colgroup/>
            <colgroup/>
            <thead>
                <tr class="headerRow StickyHeadRow">
                    <th class="headerRow" style="text-align: center;">
                        <span>{!$Label.MSG_006_0252}</span>
                    </th>
                    <th class="headerRow" style="text-align: center;">
                        <input type="checkbox" id="show" style="position: relative;top:2px;" onclick="isShowAll(this.checked,'show')"/>{!$Label.MSG_006_0254}
                    </th>
                <!-- ご利用日 -->
                    <th class="headerRow"  style="text-align: center;">
                    {!$Label.MSG_006_0255}
                    </th>
            <!-- 商品コード -->
            <!-- 商品明細 -->
                    <th class="headerRow">
                        {!$Label.MSG_006_0256}
                    </th>
                    <!-- 単価-->
                    <th class="headerRow">
                        {!$Label.msg_006_0404}
                    </th>
                    <!-- 数量-->
                    <th class="headerRow">
                        {!$Label.msg_006_0405}
                    </th>
            <!-- 合計金額 -->
                    <th class="headerRow" >
                        {!$Label.MSG_006_0257}
                    </th>
            <!-- 合計金額(税抜) -->
                    <th class="headerRow">
                        {!$Label.MSG_006_0258}
                    </th>
            <!-- 消費税　種別-->
                    <th class="headerRow">
                        {!$Label.msg_006_0406}
                    </th>
            <!-- サビース料 -->
                    <th class="headerRow">
                        {!$Label.msg_006_0407}
                    </th>
            <!-- 特別税 -->
                    <th class="headerRow">
                        {!$Label.msg_006_0408}
                    </th>
                </tr>
            </thead>
                </table>
        <!-- 商品情報 -->
        <div id="contentDiv" style="width: 100%;overflow-x:hidden;overflow:scroll;height:286px;overflow-x: hidden;" >
            <table name="tranDetailTable" id="tran1Table" class="list" style="table-layout: fixed; border-top:0px" border="0" cellpadding="0" cellspacing="0">
                <colgroup/>
                <colgroup/>
                <colgroup/>
                <colgroup/>
                <colgroup/>
                <colgroup/>
                <colgroup/>
                <colgroup/>
                <colgroup/>
                <colgroup/>
                <colgroup/>
                <colgroup/>
                <tbody id="transDetailTableBody"></tbody>
            </table>
</div>
        </td>
        </tr></table>
    </div>
        <apex:pageBlockButtons location="bottom">
        
            <table style="table-layout: fixed;"><tr><td width="160px"></td>
                <td>
                <!-- 2018/06/12 SCANER機能新規 by zy BEGIN -->  
                <!-- 2020/12/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy BEGIN  -->
                <apex:outputPanel rendered="{!oPage.isUpd}" layout="block" styleClass="toolButttonStyle" 
                    style="border-left: groove 2px #ffffff;cursor:pointer"
                    onclick="scrannerEnd(true);if(!copySelectValToHidden()){return false;};refreshOrder();upsertDataFunction();buttonsEnabled(false);JINYACONNECT.blockUi();" >
                <!-- 2018/06/12 SCANER機能新規 by zy BEGIN -->      
                    <!-- 保存 -->
                    <img title="{!$Label.MSG_006_0242}" alt="{!$Label.MSG_006_0242}" src="{!URLFOR($Resource.AppImages, 'toolbtnicon/save.png')}" />
                    <br/><span style="">{!$Label.MSG_006_0242}</span>
                </apex:outputPanel>
                <!-- 2018/06/12 SCANER機能新規 by zy BEGIN -->  
                <apex:outputPanel rendered="{!oPage.isIns}" layout="block" styleClass="toolButttonStyle" 
                    style="border-left: groove 2px #ffffff;cursor:pointer"
                    onclick="scrannerEnd(true);if(!copySelectValToHidden()){return false;};refreshOrder();insertDataFunction();buttonsEnabled(false);JINYACONNECT.blockUi();" >
                <!-- 2020/12/15 会計商品にJANコードを登録し、それをバーコードリーダーで読み取り、会計処理が行えるようにしたい by zy END  -->
                <!-- 2018/06/12 SCANER機能新規 by zy END -->        
                    <!-- 保存 -->
                    <img title="{!$Label.MSG_006_0242}" alt="{!$Label.MSG_006_0242}" src="{!URLFOR($Resource.AppImages, 'toolbtnicon/save.png')}" />
                    <br/><span style="">{!$Label.MSG_006_0242}</span>
                </apex:outputPanel>
                <!-- 2018/06/12 SCANER機能新規 by zy BEGIN -->  
                <apex:outputPanel layout="block" styleClass="toolButttonStyle"
                    onclick="scrannerEnd();gotoCancelFunction();buttonsEnabled(false);JINYACONNECT.blockUi();" style="cursor:pointer" rendered="{!!isFromBookingFlexApp}"> 
                <!-- 2018/06/12 SCANER機能新規 by zy END -->     
                    <img title="{!$Label.MSG_006_0239}" alt="{!$Label.MSG_006_0239}" src="{!URLFOR($Resource.AppImages, 'toolbtnicon/cancel.png')}" />
                    <br/><span style="">{!$Label.MSG_006_0239}</span>
                </apex:outputPanel>
                <apex:outputPanel layout="block" rendered="{!isFromBookingFlexApp}">
                    <a class="toolButttonStyle" href="{!returnUrl}" 
                        onclick="JINYACONNECT.blockUi();"
                        style="width: 75px; float: left; text-align: center;border-right: groove 2px #ffffff;cursor:pointer;text-decoration:none;">
                        <img title="{!$Label.MSG_006_0239}" alt="{!$Label.MSG_006_0239}" src="{!URLFOR($Resource.AppImages, 'toolbtnicon/cancel.png')}" />
                        <br/><span style="">{!$Label.MSG_006_0239}</span>
                    </a>
                </apex:outputPanel>
                <!-- 2018/06/12 SCANER機能新規 by zy BEGIN -->  
                <apex:outputPanel rendered="{!oPage.isUpd && !accountPopupIsShowFlg && !ISBLANK(oAcountSobj.Field53__c)}" layout="block" styleClass="toolButttonStyle"
                    onclick="javascript:directOpenAccountPdf();scrannerEnd();" style="cursor:pointer" >
                <!-- 2018/06/12 SCANER機能新規 by zy END -->        
                    <!-- 会計書 -->
                    <img title="{!$Label.MSG_006_0226}" alt="{!$Label.MSG_006_0226}" src="{!URLFOR($Resource.AppImages, 'toolbtnicon/accountpdf.png')}" />
                    <br/><span style="">{!$Label.MSG_006_0226}</span>
                </apex:outputPanel>
                <!-- 2018/06/12 SCANER機能新規 by zy BEGIN -->  
                <apex:outputPanel rendered="{!oPage.isUpd && !accountPopupIsShowFlg && !ISBLANK(oAcountSobj.Field53__c)}" layout="block" styleClass="toolButttonStyle"
                    onclick="javascript:openBillPdf();scrannerEnd();" style="cursor:pointer"  >
                <!-- 2018/06/12 SCANER機能新規 by zy END -->        
                    <!-- 請求書 -->
                    <img title="{!$Label.MSG_006_0215}" alt="{!$Label.MSG_006_0215}" src="{!URLFOR($Resource.AppImages, 'toolbtnicon/billpdf.png')}" />
                    <br/><span style="">{!$Label.MSG_006_0215}</span>
                </apex:outputPanel>
                <!-- 2018/06/12 SCANER機能新規 by zy BEGIN -->          
                <apex:outputPanel rendered="{!oPage.isUpd && accountPopupIsShowFlg && !ISBLANK(oAcountSobj.Field53__c)}" layout="block" styleClass="toolButttonStyle"
                    onclick="javascript:openPrintPdfWin();scrannerEnd();" style="cursor:pointer" >
                <!-- 2018/06/12 SCANER機能新規 by zy END -->    
                    <!-- 印刷 -->
                    <img title="{!$Label.MSG_006_0225}" alt="{!$Label.MSG_006_0225}" src="{!URLFOR($Resource.AppImages, 'toolbtnicon/print.png')}" />
                    <br/><span style="">{!$Label.MSG_006_0225}</span>
                </apex:outputPanel> 
                <!-- 2017/10/18 チェックアウト機能対応 BEGIN -->   
                <!-- チェックアウト -->
                <!-- 2018/06/12 SCANER機能新規 by zy BEGIN -->
                <apex:outputPanel rendered="{!oPage.isUpd && !ISBLANK(oAcountSobj.Field53__c) && isShowCheckOutBtn}" layout="block" styleClass="toolButttonStyle"
                    onclick="scrannerEnd();_JsCheckoutFunction('{!JSENCODE(oAcountSobj.Relreserve__c)}','{!JSENCODE(oAcountSobj.Relreserve__r.LeadIndexRef__c)}');" style="cursor:pointer" >
                <!-- 2018/06/12 SCANER機能新規 by zy END -->    
                    <!-- 2017/12/18  チェックアウトLabel WGCH BEGIN -->
                    <img title="{!$Label.MSG_006_0449}" alt="{!$Label.MSG_006_0449}" src="{!URLFOR($Resource.AppImages, 'toolbtnicon/checkout.png')}" />
                    <!-- 2017/12/18  チェックアウトLabel WGCH END -->
                    <br/><span style="">{!$Label.MSG_006_0449}</span>
                </apex:outputPanel>
                <!-- 2017/10/18 チェックアウト機能対応 END -->
            </td></tr></table>
        </apex:pageBlockButtons>
    </apex:pageblock>
    <div id="billSplitProcessTabBody" style="display:none; ">
    </div>
    <!-- 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH BEGIN -->
    <div id="accountSkipTabBody" style="display:none; ">
    </div>
    <!-- 2021/02/28 会計画面上から確定した会計明細・支払を別の部屋の会計に移動する機能 WGCH END -->
</div>

    </td>
    
    <!-- RIGHT PANEL [PAY MEMENT INFO BLOCK]-->
    <td style="vertical-align: top;" id="paymentButtonTd" >
        <!-- 2017/04/19 レシート印刷機能追加　by zy BEGIN -->
        <c:BillSimplePaymentComp container="{!BillSimplePaymentCompId}" callbackFun="autoGetPayProductInfo"  shopCode="{!oShopCode}" rendered="{!oPage.isUpd}"/>
        <!-- 2017/04/19 レシート印刷機能追加　by zy END -->
    </td>
    </tr>
</table>

</apex:form>

<!-- <div id="usedAmountSplitDialog" title="割り勘結果"></div> -->

<!-- This component is added to show call register popup -->
<c:CallRegisterPopup rendered="true"/>
<!-- //2017/03/17 お釣りプリンター機能　by zy BEGIN -->
<apex:outputPanel rendered="{!changeSwitch}">
<script>
//ip对应信息
var ipMap = new Object();
var CHARGE = {
    INPUT:'入金',
    INPUTOVER:'入金完了',
    INPUTBEFORE:'入金準備',
    CHARGEOUT:'釣銭放出',
    CONNECTING:'接続中',
    UNCONNECT:'未接続',
    //2017/06/02 釣銭機の改修　by　zy BEGIN
    //状态check
    STOP:'中止...',
    CHECK:'チェック',
    REST:'リセット',
    REOPEN:'計数再開',
    //2017/06/02 釣銭機の改修　by　zy END
    // 2017/08/01 计数停止分段命令 by zy BEIGN
    INPUTSTOP :  '入金停止',
    INPUTEND : '入金終了'
    // 2017/08/01 计数停止分段命令 by zy END
    // 2018/04/16 釣銭不足ロジック対応 by ZY BEGIN
    ,CHECKMACHINE : '精査'
    ,NOCHARGEOUT:'お釣りが不足、補充して後に「再開」ボタンを押下してください'
    // 2018/04/16 釣銭不足ロジック対応 by ZY END
};
var STATUS_KEY = {
    MACHINE:'装置状態',
    KEISUU : '計数停止'
};
var STATUS = {
    OTHER:"0:その他",
    SOH: "1:計数動作中（SOHと同等）", 
    EM:"2:計数停止中（EMと同等）",
    NO:'0:計数停止コマンド未受信',
    YES:'1:受信済み'
};
var crgPnt = $.WebPrint({
    unPrice:0,
    firstAmount:0,
    allReturn:false,
    errorMessage:'',
    isSetting : {!isSetting},
    onMessage:processResponse,
    // stop命令已经送过后重复发送LOCK
    cmdHadSend : false,
    // 2017/07/26 ログ機能追加　by　zy BEGIN
    remoteSaveLog:"{!$RemoteAction.BillSimpleInputCtrl.savePrintLodToDb}",
    // 2017/07/26 ログ機能追加　by　zy END
    isSimulaterFlag:false,
    beforeConnect:function(){
        /*
        chgWrapStatus('unconnect','',CHARGE.UNCONNECT);
        chgWrapStatus('loading',CHARGE.CONNECTING);
        this.render.show();
        $("#msg,#listmessage",".printBack").hide();
        this.render.append($("#costMachine").show());
        */
    },
    beforeSend:function(e){
        $(".printBack").show();
        this.errorMessage = '';
        // 不进行页面显示
        //chgWrapStatus('loading',this.curSeq);
    },
    afterClose:function(e){
        //如果收银页面打开
        if($(".printBack").is(":visible")){
            this.errorMessage = this.ERROR;
            // 关闭原因为占用时
            if (this.TITLE.BUSY == this.connectStatus){
                chgWrapStatus('unconnect',this.TITLE.CONNECTFAIL,this.TITLE.BUSY);
                this.errorMessage = this.WAITERRPR;
            //其他情况
            } else chgWrapStatus('unconnect','',CHARGE.UNCONNECT);
            //更新エラー内容
            chgWrapStatus('error',this.errorMessage);
            //调用定时器重新启动此次呼叫
            this.autoReConnect($("#loading-image"),$(".curStatus .recClass"),imediateConnect);
        }
    },
    getMsgInfo:function(seq){
        switch(seq){
            //入金準備
            case CHARGE.INPUTBEFORE:
                var objParas = [{key:'real', val:'false'}, {key: 'timeout', val: '-1'},];
                return '{"sequence": "' + encodeURIComponent(seq) + '", ' + 
                                buildWSRequestParameter(objParas) + ', ' +
                                '"token": ""}';
            //入金
            case CHARGE.INPUT:
                //超时时间,设置后10秒内一直返回response
                var timeout = crgPnt.inputTimeout;
                var objParas = [{key:'real', val:"true" }, {key: 'timeout', val: timeout},];
                // 2018/04/09 釣銭機入金方式更新 BY ZY BEGIN
                var oldWayFlag = $j("#hidOldWayFlag").val();
                var isOldWayFlag = oldWayFlag == 'true';
                if (!isOldWayFlag) objParas = [{key:'real', val:"false" }, {key: 'timeout', val: '-1'},];
                // 2018/04/09 釣銭機入金方式更新 BY ZY END
                return '{"sequence": "' + encodeURIComponent(seq) + '", ' + 
                                buildWSRequestParameter(objParas) + ', ' +
                                '"token": ""}';
            //入金完了
            case CHARGE.INPUTOVER:
                var objParas = [{key:'real', val:'false'}, {key: 'timeout', val: '-1'}, {key: 'amount', val: 0} ];
                // 2017/08/01 指令分步执行更改 by zy BEGIN
                var nextCommand = seq;
                // 如果对象存在command指令
                if ('command' in  this) {
                    nextCommand = this.command;
                }
                //return '{"sequence": "' + encodeURIComponent(seq) + '", ' + 
                return '{"sequence": "' + encodeURIComponent(nextCommand) + '", ' + 
                // 2017/08/01 指令分步执行更改 by zy END
                                buildWSRequestParameter(objParas) + ', ' +
                                '"token": ""}';
            //釣銭放出
            case CHARGE.CHARGEOUT:
                //枚数指定放出
                if ( crgPnt.allReturn && crgPnt.isSetting) {
                    var retAmount = crgPnt.returnAmount;
                    var objParas = [
                        {key: 'real'    , obj: 'false'   },
                        {key: 'timeout' , obj: '-1'},
                        {key: 'amount'  , obj: '0' },
                        {key: 'contact' , obj: '0'},
                        {key: 'amt_10k' , obj: retAmount.return_amt_10k },
                        {key: 'amt__5k' , obj: retAmount.return_amt_5k },
                        {key: 'amt__2k' , obj: retAmount.return_amt_2k },
                        {key: 'amt__1k' , obj: retAmount.return_amt_1k },
                        {key: 'amt_500' , obj: retAmount.return_amt_500 },
                        {key: 'amt_100' , obj: retAmount.return_amt_100 },
                        {key: 'amt__50' , obj: retAmount.return_amt_50 },
                        {key: 'amt__10' , obj: retAmount.return_amt_10 },
                        {key: 'amt___5' , obj: retAmount.return_amt_5 },
                        {key: 'amt___1' , obj: retAmount.return_amt_1},
                    ];
                    var json = "";
                    for (var i = 0; i < objParas.length; i ++) {
                        if (json.length > 0) json = json + ", ";
                        json = json + jsonParameter(objParas[i].key, objParas[i].obj);
                    }
                    //crgPnt.consoleLog('釣銭枚数指定放出:::' + price_format);
                    // 2017/07/26 中止ボタンコマンド変更　by　zy BEGIN
                    return '{"sequence": "' + encodeURIComponent('中止放出') + '", ' + 
                    // 2017/07/26 中止ボタンコマンド変更　by　zy END
                                    '"parameter": \"{' + json + '}\"' + ', ' +
                                    '"token": ""}';
                //最小指定金额放出
                } else {
                //2017/06/01 入金中止の機能追加する　by　zy BEGIN
                //var pleaseTotal = $("#total").text();
                //pleaseTotal = pleaseTotal.replace(kendo.getCulture().numberFormat.currency.symbol,"");
                //var total_format = kendo.parseFloat(pleaseTotal);
                var price_format = crgPnt.getTotal;
                //if (this.allReturn) {
                    //chargPrice = $("#curTotal").text();
                    //total_format = 0;
                //} 
                //2017/06/01 入金中止の機能追加する　by　zy END
                //var price_format = getTotal - total_format;
                crgPnt.consoleLog('釣銭放出:::' + price_format);
                var objParas = [{key:'real', val:'false'}, {key: 'timeout', val: '-1'}, {key: 'amount', val: price_format} ];
                return '{"sequence": "' + encodeURIComponent(seq) + '", ' + 
                                buildWSRequestParameter(objParas) + ', ' +
                                '"token": ""}';
                }
            //2017/06/07 釣銭機の状態の事前チェック　by　zy BEGIN
            //
            case CHARGE.STOP:
                var objParas = [{key:'real', val:'false'}, {key: 'timeout', val: '-1'}, {key: 'amount', val: 0} ];
                // 2017/08/01 指令分步执行更改 by zy BEGIN
                var nextCommand = CHARGE.INPUTOVER;
                // 如果对象存在command指令
                if ('command' in  this && this.command != undefined) {
                    nextCommand = this.command;
                }
                //return '{"sequence": "' + encodeURIComponent(CHARGE.INPUTOVER) + '", ' + 
                return '{"sequence": "' + encodeURIComponent(nextCommand) + '", ' + 
                // 2017/08/01 指令分步执行更改 by zy END
                                buildWSRequestParameter(objParas) + ', ' +
                                '"token": ""}';
            case CHARGE.CHECK:
                //超时时间,设置后10秒内一直返回response
                var objParas = [{key:'real', val:"false" }, {key: 'timeout', val: '-1'},];
                return '{"sequence": "' + encodeURIComponent(CHARGE.INPUT) + '", ' + 
                                buildWSRequestParameter(objParas) + ', ' +
                                '"token": ""}';
            //リセット命令
            case CHARGE.REST:
                //超时时间,设置后10秒内一直返回response
                var objParas = [{key:'real', val:"false" }, {key: 'timeout', val: '-1'},];
                return '{"sequence": "' + encodeURIComponent(CHARGE.REST) + '", ' + 
                                buildWSRequestParameter(objParas) + ', ' +
                                '"token": ""}';
            //2017/06/07 釣銭機の状態の事前チェック　by　zy END
            // 2018/04/09 釣銭機入金方式更新 BY ZY BEGIN
            default :
                //超时时间,设置后10秒内一直返回response
                var objParas = [{key:'real', val:"false" }, {key: 'timeout', val: '-1'}];
                return '{"sequence": "' + encodeURIComponent(seq) + '", ' + 
                                buildWSRequestParameter(objParas) + ', ' +
                                '"token": ""}';
            ;
            // 2018/04/09 釣銭機入金方式更新 BY ZY END   
        }
    }
});

function imediateConnect(){
    $("input.sucBtn").removeAttr("disabled");
    crgPnt.reConnectLast();
}
var stopPrint = $.WebPrint({
    beforeConnect:function(){
        crgPnt.consoleLog(getCurTime() + ' command stop send');
    }
});
//お釣り機のウィンドウ状态反应
function chgWrapStatus(type,msg,conMsg){
    //去掉入金准备的状态显示
    if (msg == CHARGE.INPUTBEFORE) msg = CHARGE.INPUT;
    //2017/05/31 中止の改修する　by zy BEGIN
    if (crgPnt.allReturn) msg = CHARGE.STOP;
    //2017/06/07 釣銭機の状態の事前チェック　by　zy BEGIN
    // エラー発生の場合、表示メッセージ不正改修　by　zy BEGIN
    else if (crgPnt.curSeq == CHARGE.CHECK && type != 'error'){ 
    // エラー発生の場合、表示メッセージ不正改修　by　zy END
        msg = CHARGE.INPUT;
        $("#loading-image").show();
    }
    //2017/06/07 釣銭機の状態の事前チェック　by　zy END
    //2017/05/31 中止の改修する　by zy END
    //エラー場合　
    if (type == 'error'){
        //$("#error-image").show();
        $(".curStatus").html(msg);
    } else if (type == 'loading'){
        $("#loading-image").show();
        //$("input.orgBtn,input.retBtn").show();
        $(".curStatus").text(msg);
    //サクセス場合
    } else if (type == 'success') {
        //$("#sucess-image").show();
        $(".curStatus").text(msg);
    }　else if (type == 'connect') {
        $("#costMachine input.btn").hide();
        $(".icon-status").hide();
        $("#sucess-image").show();
        //$("input.sucBtn,input.retBtn").show();
        $("input.retBtn").show();
        $(".connectStatus").text(conMsg);
        $(".curStatus").text(msg);
    } else if (type == 'unconnect') {
        $("#costMachine input.btn").hide();
        $(".icon-status").hide();
        $("#error-image").show();
        $("input.orgBtn,input.retBtn").show();
        $(".connectStatus").text(conMsg);
        $(".curStatus").text(msg);
    }
}
var allReturn = false;
//2017/05/31 中止の改修する　by zy BEGIN
// 点x关闭窗口
function closeAccount(){
    //如果没连接就直接停止
    if (confirm("強制終了よろしいですか?")) {
        crgPnt.allReturn = true;
        clearTimeout(crgPnt.timoutId);
        // 2018/04/09 釣銭機入金方式更新 BY ZY BEGIN
        if (!printStop()) stopPrint.connect();
        // 2018/04/09 釣銭機入金方式更新 BY ZY END
        crgPnt.curSeq = "";
        clearPrint(true);
    }
}
//2017/05/31 中止の改修する　by zy BEGIN
//返金
function hideAccount(){
    crgPnt.consoleLog('stop button click');
    $("input.retBtn").attr("disabled","disabled");
    $("input.sucBtn").attr("disabled","disabled");
    crgPnt.allReturn = true;
    // 2017/07/14 釣銭機の行追加エラー発生by zy BEGIN
    // 中止直接响应
    chgWrapStatus('loading',CHARGE.STOP);
    // 2017/07/14 釣銭機の行追加エラー発生by zy END
    //2017/05/31 中止の改修する　by zy BEGIN
    var printStopFlag = printStop();
    clearTimeout(crgPnt.timoutId);
    if (crgPnt.ws.CLOSED == crgPnt.ws.readyState){
        // 关闭状态下直接关闭
        clearPrint(true);
    }
    /*
    var retBtn = $("input.retBtn") ;
    if (retBtn.hasClass("activeClass")) {
        crgPnt.callBackSeqArr = [CHARGE.STOP];
        crgPnt.nextStep();
        retBtn.removeClass("activeClass");
        return;
    }*/
    // 2018/04/09 釣銭機入金方式更新 BY ZY BEGIN
    if (printStopFlag) return;
    // 2018/04/09 釣銭機入金方式更新 BY ZY END
    //入金完了状态金额全退
    if (crgPnt.curSeq == CHARGE.CHECK ) {
        stopPrint.connect();
        clearPrint();
        return ;
    } else if (crgPnt.curSeq == CHARGE.INPUTBEFORE) {
        stopPrint.connect();
        crgPnt.callBackSeqArr = [CHARGE.STOP];
        crgPnt.command = CHARGE.INPUTSTOP;
        crgPnt.nextStep();
        return ;
    } else if (crgPnt.curSeq == CHARGE.INPUT){ 
        crgPnt.callBackSeqArr = [CHARGE.STOP];
        stopPrint.connect();
    // 入金完了时只更改参数就好不需要再次发送命令
    } else if (crgPnt.curSeq == CHARGE.INPUTOVER) {
        // 未收到stop命令
        if (crgPnt.command == undefined) {
            crgPnt.callBackSeqArr = [CHARGE.STOP];
            crgPnt.command = CHARGE.INPUTSTOP;
            crgPnt.nextStep();
        }
    // 釣銭放出前に精査コマンド
    } else if (crgPnt.curSeq == CHARGE.CHECKMACHINE){
        crgPnt.callBackSeqArr = [CHARGE.CHARGEOUT];
        crgPnt.nextStep();
        return;
    }
    crgPnt.curSeq = CHARGE.STOP;
    //2017/05/31 中止の改修する　by zy END
}
//入金完了
function successAccount(){
    clearTimeout(crgPnt.timoutId);
    // 2018/04/09 釣銭機入金方式更新 BY ZY BEGIN
    if (!printStop()) {
    // 2018/04/09 釣銭機入金方式更新 BY ZY END
        //2017/06/05 計数中の状態メッセージ反応　by zy BEGIN
        var sucBtn = $("input.sucBtn") ;
        if (sucBtn.hasClass("activeClass") || crgPnt.curSeq == CHARGE.INPUTBEFORE) {
            crgPnt.callBackSeqArr = [CHARGE.INPUTOVER];
            crgPnt.nextStep();
            sucBtn.removeClass("activeClass");
        } else {
        //2017/06/05 計数中の状態メッセージ反応　by zy END
            crgPnt.curSeq = CHARGE.INPUTOVER;
        //2017/06/05 計数中の状態メッセージ反応　by zy BEGIN
        }
        //2017/06/05 計数中の状態メッセージ反応　by zy END
        stopPrint.connect();
    // 2018/04/09 釣銭機入金方式更新 BY ZY BEGIN
    }
    // 2018/04/09 釣銭機入金方式更新 BY ZY END
    $("input.sucBtn").attr("disabled","disabled");
}
//手动入力
function oldAccount(){
    if (actionSaveFlag) {
        oldAccountAuto();
        return;
    } 
    //继续呼叫原方法后在进行clear 顺序不可更改
    delete crgPnt.inPrice;
    if ("result" in crgPnt ) {
        crgPnt.result.unitPrice = 0;
        paymentBtn(crgPnt.result);
        clearPrint();
    }
}
function oldAccountAuto(callback){
    if (callback != undefined) {
        if (actionSaveFlag) {
            setTimeout(function(){
                oldAccountAuto(callback);
            },200);
        } else {
            eval(callback);
        }
        return;
    }
    closeChangeWin(true);
    jinyaConnectBlockUi();
    oldAccountAuto('oldAccount();');
}
function refreshInput(lastReq){
    if (lastReq.cmd == "0x41" && lastReq.amount != undefined) {
        //2017/05/31 印刷設備の中止対応　by　zy　BEGIN
        if(crgPnt.allReturn){
            return lastReq.amount;
        }
        //2017/05/31 印刷設備の中止対応　by　zy　END
        var curAmount = lastReq.amount - crgPnt.firstAmount ;
        crgPnt.firstAmount += curAmount;
        crgPnt.inPrice += curAmount;
        crgPnt.unPrice += crgPnt.result.unitPrice + curAmount;
        var chg = crgPnt.unPrice - crgPnt.total;
        if (chg > 0) $("#charge").text(kendo.toString(chg, "c"));
        $("#curTotal").text(kendo.toString(crgPnt.unPrice, "c"));
        //2017/06/05 計数中の状態メッセージ反応　by zy BEGIN
        //計数データリードコマント
        /*
        var paperKey = "紙幣部詳細情報";
        var coinKey = "硬貨部詳細情報";
        var paperMessage = lastReq[paperKey];
        var coinMessage = lastReq[coinKey];
        if (paperMessage.indexOf("0:") >= 0 || paperMessage.indexOf("1:") >= 0 || paperMessage.indexOf("2:") >= 0 ||
            coinMessage.indexOf("0:") >= 0 || coinMessage.indexOf("0:") >= 0 || coinMessage.indexOf("0:") >= 0 ) {
            $("#inputStatus").hide();
        } else {
            $("#inputStatus").show();
            $("#paperOpening").text(paperMessage);
            $("#coinOpening").text(coinMessage);
        }*/
        //2017/06/05 計数中の状態メッセージ反応　by zy END
        return chg;
    }
}
//response返回值处理
function processResponse(result){
    //没有返回值 不进行处理
    if(result.data == "" && result.data == undefined ) return;
    if(result.data.indexOf("welcome") >= 0 ) {
        //链接成功
        chgWrapStatus('connect','',crgPnt.TITLE.CONNECT);
        //当前执行指令
        chgWrapStatus('success',crgPnt.curSeq);
        //按照队列发送下一个操作
        //2017/06/01 入金中止の機能追加する　by　zy BEGIN
        //crgPnt.nextStep();
        //2017/06/01 入金中止の機能追加する　by　zy END
    } else {
        var seq = crgPnt.curSeq;
        //2017/06/01 入金中止の機能追加する　by　zy BEGIN
        var connMst = JSON.parse(decodeURIComponent(result.data));
        //2017/06/01 入金中止の機能追加する　by　zy END
        var lastReq = connMst.lastResponse;
        /*
        不需要提前判定在分析的时候进行判定以免影响显示信息
        //链接成功
        chgWrapStatus('connect','',crgPnt.TITLE.CONNECT);
        */
        //var curSeq = crgPnt.curSeq;
        //2017/06/01 入金中止の機能追加する　by　zy BEGIN
        if (seq == CHARGE.INPUTBEFORE || seq == CHARGE.INPUT || seq == CHARGE.INPUTOVER || seq == CHARGE.CHARGEOUT){
            chgWrapStatus('loading',seq);
        //当前执行状态
        } else chgWrapStatus('success',seq);
        
        //2017/06/01 入金中止の機能追加する　by　zy END
        //2017/06/07 釣銭機の状態の事前チェック　by　zy BEGIN
        //処理遷移
        analyResponse(connMst,lastReq);
        return;
        //2017/06/07 釣銭機の状態の事前チェック　by　zy END
    }
}
//清理页面及参数
// 添加不判断自动关闭入金画面flag
function clearPrint(flag){
    //2017/06/15 復旧機能追加　by　zy BEGIN
    var curResult = crgPnt.result;
    crgPnt.init();
    //2017/06/15 復旧機能追加　by　zy END
    // 关联参数移形
    //crgPnt.allReturn = false;
    crgPnt.unPrice = 0;
    crgPnt.getTotal = 0;
    $("input.sucBtn").removeAttr("disabled");
    $("input.retBtn").removeAttr("disabled");
    //2017/03/17 お釣りプリンター機能　by zy END
    // 未用到
    $("#inputStatus").hide();
    //2017/03/17 お釣りプリンター機能　by zy END
    //2017/06/15 復旧機能追加　by　zy BEGIN
    // 关联参数移形
    //crgPnt.disconnect();
    // 更改hide页面为关闭判断
    closeChangeWin(flag == true);
    //$(".printBack").hide();
    //2017/06/15 復旧機能追加　by　zy END
    // stop命令已经送过后重复发送LOCK复位
    crgPnt.cmdHadSend = false;
    // comman命令复位
    crgPnt.command = undefined;  
    crgPnt.errorCnt = 0;
}
// 关闭入金窗口
function closeChangeWin(directFlag){
    if (!directFlag) {
        if(actionSaveFlag) {
            setTimeout(function(){
                closeChangeWin();
            },200);
            return;
        }
    // 如果直接关闭的时候要判断是否正在保存
    // コメント「中止」以外
    // 自動保存中
    } else if ( actionSaveFlag &&  !crgPnt.allreturn) {
        jinyaConnectBlockUi();
    }
    crgPnt.allReturn = false;
    crgPnt.disconnect();
    $(".printBack").hide();
}
//2017/04/19 レシート印刷機能追加　by zy BEGIN
function getPrintFlag(ip){ 
    //2017/04/19 レシート印刷機能追加　by zy BEGIN
    if (!changeSwitch) return ;
    //2017/04/19 レシート印刷機能追加　by zy END
    var json = '{!chargeJson}';
    if (json != "") {
        if (!ipMap.hasOwnProperty()){
            ipMap = JSON.parse(json);
        }
    }
    //2017/04/19 レシート印刷機能追加　by zy BEGIN
    if (ip != undefined && ipMap[ip] != undefined) {
    //2017/04/19 レシート印刷機能追加　by zy END
        var ipRes = ipMap[ip];
        // 参数不存在bug fix
        //if (ipRes == undefined ) ipRes = ipMap[localIp];
        if (ipRes != undefined ){
            hadChgUrlFlag = true;
            crgPnt.webComm = ipRes.connect + '?KEEP=&UUID=' + kendo.guid();
            // 2017/07/26 ログ機能追加　by　zy BEGIN
            // 2018/03/13 ログ機能設備IP追加　by　zy BEGIN
            crgPnt.baseInfo = '釣銭機[' + ip + ']（' + ipRes.pos + '会計ID：' + $("input[id$=hidCurrAccountId]").val() ;
            // 2018/03/13 ログ機能設備IP追加　by　zy END
            // 2017/07/26 ログ機能追加　by　zy END
            stopPrint.webComm = ipRes.stopurl;
            if (ipMap['fail'] != "" && ipMap['fail'] != undefined)
                crgPnt.failTimeout = ipMap['fail'];
            if (ipMap['timeout'] != "" && ipMap['timeout'] != undefined)
                crgPnt.inputTimeout = ipMap['timeout'];
            crgPnt.curSeq = "";
            //2017/06/08 釣銭機の表示部分更新する　by　zy BEGIN
            /*
            if (ipRes["allReturn"] != "" && ipRes["allReturn"] != undefined)
                allReturn = ipRes["allReturn"];
            */
            //2017/04/19 レシート印刷機能追加　by zy BEGIN
            //stopPrint.connect();
            //2017/04/19 レシート印刷機能追加　by zy END
            clearPrint();
        }
    }
}
//2017/04/19 レシート印刷機能追加　by zy END
//2017/03/17 お釣りプリンター機能　by zy END
// 2017/06/05 釣銭機の復旧処理　by　zy BEGIN
function analyResponse(connMst,lastReq){
    //crgPnt.consoleLog(crgPnt.curSeq + ' ::: ' + JSON.stringify(lastReq));
    // 返回值NG时显示リセットボタン
    if (!("result" in lastReq )) {
        //$(".restBtn").show();
        return;
    }
    // 2018/04/09 釣銭機入金方式更新 BY ZY BEGIN
    /*
    var STATUS_KEY = {
        MACHINE:'装置状態',
        KEISUU : '計数停止'
    };
    var STATUS = {
        OTHER:"0:その他",
        SOH: "1:計数動作中（SOHと同等）", 
        EM:"2:計数停止中（EMと同等）",
        NO:'0:計数停止コマンド未受信',
        YES:'1:受信済み'
    };*/
    // 2018/04/09 釣銭機入金方式更新 BY ZY END
    //入金チュック
    if (crgPnt.curSeq == CHARGE.CHECK){
        if(crgPnt.isSimulaterFlag){
            //計数中の場合
            //crgPnt.callBackSeqArr = [CHARGE.INPUT];
            // 为了模拟器好用特意注释
            crgPnt.nextStep();
            return;
        } 
        // 2018/04/09 釣銭機入金方式更新 BY ZY BEGIN
        if(changeInputCheck(lastReq)) crgPnt.nextStep();
        // 2018/04/09 釣銭機入金方式更新 BY ZY END
    //入金準備
    } else if (crgPnt.curSeq == CHARGE.INPUTBEFORE) {
        //準備しました
        if (lastReq.code == "ACK" || lastReq.code == "ETB") {
            crgPnt.nextStep();
        //準備ありません
        } else {
            //chgWrapStatus('error','入金処理中に異常が発生しました。');
            //$("#loading-image").hide();
            // 中止与rest按钮只显示一个
            $(".restBtn").show();
            $(".retBtn").hide();
        }
    //入金
    } else if (crgPnt.curSeq == CHARGE.INPUT) {
        // 2018/04/09 釣銭機入金方式更新 BY ZY BEGIN
        changeInput(lastReq);
        // 2018/04/09 釣銭機入金方式更新 BY ZY END
    //入金完了
    } else if (crgPnt.curSeq == CHARGE.INPUTOVER || crgPnt.curSeq == CHARGE.STOP) {
        // エラー回数上限場合，处理停止，リセットボタン表示する
        // 2017/10/09 自動入金後で入金失効エラー修正　by　zy　BEGIN
        if (crgPnt.errorCnt >= 2 && lastReq.cmd == '0x41') {
        // 2017/10/09 自動入金後で入金失効エラー修正　by　zy　END
            var paperKey = "紙幣部詳細情報";
            var coinKey = "硬貨部詳細情報";
            var paperMessage = lastReq[paperKey];
            var coinMessage = lastReq[coinKey];
            if (!$("#inputStatus").is(":visible")) {
                $("#inputStatus").show();
            }
            // 2017/10/09 自動入金後で入金失効エラー修正　by　zy　BEGIN
            // メーセッジあり
            if (paperMessage != undefined && coinMessage != undefined) {
            // 2017/10/09 自動入金後で入金失効エラー修正　by　zy　END
                var errorImg = $("#loading-image").clone();
                var successImg = $("#sucess-image").clone();
                errorImg.removeAttr("id");
                successImg.removeAttr("id");
                errorImg.show();
                successImg.show();
                var errorImgClone = errorImg.clone();
                successImgClone = successImg.clone();
                if (paperMessage.indexOf("1:") >= 0) {
                    $("#paperOpening").html(errorImgClone);
                    errorImgClone.css({width:'18px',position: 'relative',top: '3px;'});
                } else {
                    $("#paperOpening").html(successImgClone);
                    successImgClone.css({width:'18px',position: 'relative',top: '3px;'});
                }
                var otherErrorImgClone = errorImg.clone();
                var otherSuccessImgClone = successImg.clone();
                if (coinMessage.indexOf("1:") >= 0) {
                    $("#coinOpening").html(otherErrorImgClone);
                    otherErrorImgClone.css({width:'18px',position: 'relative',top: '3px;'});
                } else {
                    $("#coinOpening").html(otherSuccessImgClone);
                    otherSuccessImgClone.css({width:'18px',position: 'relative',top: '3px;'});
                }
            // 2017/10/09 自動入金後で入金失効エラー修正　by　zy　BEGIN
            }
            // 2017/10/09 自動入金後で入金失効エラー修正　by　zy　END
        }
        if ( !("command" in crgPnt) || crgPnt.command == undefined ) {
            crgPnt.errorCnt = 0;
            //接收stop命令或者入金循环命令处理
            if (lastReq.timeout != undefined && lastReq.timeout == 'over') {
                //可以执行入金完了命令
                if (crgPnt.curSeq == CHARGE.STOP) crgPnt.callBackSeqArr = [CHARGE.STOP];
                else crgPnt.callBackSeqArr = [CHARGE.INPUTOVER];
                // 添加command命令，打断入金完了命令，改成分段执行
                crgPnt.command = CHARGE.INPUTSTOP;
                crgPnt.nextStep();
                return;
            //仍存在入金数据
            } else if (connMst.responses.length == 1 && lastReq.cmd=='0x41'){
                stopPrint.connect();
                return;
            }
        }
        // 計数停止のコマンド場合
        if (crgPnt.command == CHARGE.INPUTSTOP) {
            if ( "cmd" in lastReq && lastReq.cmd=='0x47') {
                // 直接转为下一个命令
                crgPnt.command = CHARGE.INPUT;
            } else if ("result" in lastReq && lastReq.result=='stop') {
                // 直接转为下一个命令
                crgPnt.command = CHARGE.INPUTSTOP;
            }
            crgPnt.callBackSeqArr = [crgPnt.curSeq];
            // 等待300毫秒以后进行下一步操作，缓冲停止
            setTimeout(function(){
                crgPnt.nextStep();
            },300);
        // 計数停止後は状態チェックコマンド
        } else if (crgPnt.command == CHARGE.INPUT && lastReq.cmd=='0x41') {
            // シミュレーションのモード場合
            if(crgPnt.isSimulaterFlag){
                //判断装置计数停止ok，可以进行计数终止命令
                crgPnt.command = CHARGE.INPUTEND;
                crgPnt.callBackSeqArr = [crgPnt.curSeq];
                crgPnt.nextStep();
                return;
            } 
            var keisuuInfo = lastReq[STATUS_KEY.KEISUU];
            if( keisuuInfo == STATUS.NO){
                crgPnt.errorCnt++;
                crgPnt.errorContent = STATUS_KEY.KEISUU + ':' + keisuuInfo ;
                // 装置未收到停止命令
                crgPnt.command = CHARGE.INPUTSTOP;
                crgPnt.callBackSeqArr = [crgPnt.curSeq];
                // 等待300毫秒以后进行check 因为未受信不需要延迟送
                //setTimeout(function(){
                    crgPnt.nextStep();
                //},300);
            //收到停止命令
            } else if ( keisuuInfo == STATUS.YES ) {
                // 判断机器状态
                var machineInfo = lastReq[STATUS_KEY.MACHINE];
                // 装置状态为「1:計数動作中(SOH と同等)」check命令重新发送
                if ( machineInfo == STATUS.SOH) {
                    crgPnt.errorCnt++;
                    crgPnt.errorContent = STATUS_KEY.MACHINE + ':' + STATUS.SOH;
                    // 等待300毫秒以后进行check
                    setTimeout(function(){
                        crgPnt.reConnectLast();
                    },300);
                // 装置状态为「0:その他」、「2:計数停止中(EM と同等)」
                } else {
                    //判断装置计数停止ok，可以进行计数终止命令
                    crgPnt.command = CHARGE.INPUTEND;
                    crgPnt.callBackSeqArr = [crgPnt.curSeq];
                    crgPnt.nextStep();
                }
            }
        } else if (crgPnt.command == CHARGE.INPUTEND && lastReq.cmd=='0x46') {
            var changeTotal = 0;
            crgPnt.errorContent = "";
            for (var i = 0 ; i < connMst.responses.length ; i++) {
                var res = connMst.responses[i];
                    if ("code" in res && res.code != "ACK" && res.code != "ETB") {
                        crgPnt.errorContent = res.memo;
                    }
                    if ( res.cmd == "0x41") {
                        //2017/03/30 釣り金为0时 不进行 釣銭放出 动作 by zy BEGIN
                        changeTotal = refreshInput(res);
                        crgPnt.getTotal = changeTotal;
                        meisuuRequest(res);
                    }
            }
            if (crgPnt.errorContent != "" ) {
                crgPnt.errorCnt++;
                // 等待300毫秒以后进行check
                setTimeout(function(){
                    crgPnt.reConnectLast();
                },300);
                return;
            }
            //2017/06/02 釣り金为0时 不进行 釣銭放出 动作 by zy END
            if (changeTotal > 0){
                // 2017/08/22 自動保存効率up by zy BEGIN
                //自动入金用退款金额
                //crgPnt.autoPrintTotal = changeTotal;
                // 2018/04/09 釣銭機入金方式更新 BY ZY BEGIN
                //if (!crgPnt.allReturn) changeInOver(crgPnt.result,changeTotal,crgPnt.res_arr,crgPnt.total);
                // 2017/08/22 自動保存効率up by zy END
                //如果有零钱则进行找钱
                if (crgPnt.allReturn) crgPnt.callBackSeqArr = [CHARGE.CHARGEOUT];
                else crgPnt.callBackSeqArr = [CHARGE.CHECKMACHINE];
                // 2018/04/09 釣銭機入金方式更新 BY ZY END
                chgWrapStatus('loading',CHARGE.CHARGEOUT);
                //按照队列发送下一个操作
                crgPnt.nextStep();
            } else {
                // 2017/08/10 入金自動レシート印刷機能追加　by　zy BEGIN
                // 中止の場合、明細不作成
                // 2017/08/22 自動保存効率up by zy BEGIN
                if (!crgPnt.allReturn)  changeInOver(crgPnt.result,0,crgPnt.res_arr,crgPnt.total);
                // 2017/08/22 自動保存効率up by zy END
                // 2017/08/10 入金自動レシート印刷機能追加　by　zy END
                clearPrint();
            }
            //2017/03/30 釣り金为0时 不进行 釣銭放出 动作 by zy END
        }
    // 釣銭放出
    } else if (crgPnt.curSeq == CHARGE.CHARGEOUT){
        for (var i = 0 ; i < connMst.responses.length ; i++) {
            var res = connMst.responses[i];
            if (res.cmd == "0x31") {
                // 2017/08/10 入金自動レシート印刷機能追加　by　zy BEGIN
                //if (!crgPnt.allReturn) paymentBtn(crgPnt.result,true);
                // 2017/08/10 入金自動レシート印刷機能追加　by　zy END
                clearPrint(true);
            // 2017/07/26 中止ボタンコマンド変更　by　zy BEGIN
            // 枚数指定放出コマンド（中止）
            } else if (res.cmd == "0x56") {
            // 2017/07/26 中止ボタンコマンド変更　by　zy END
                clearPrint(true);
                break;
            }
        }
    }　else if (crgPnt.curSeq == CHARGE.REST){
        // 直接关闭窗口
        clearPrint(true);
    // 2018/04/09 釣銭機入金方式更新 BY ZY BEGIN
    } else if (crgPnt.curSeq == CHARGE.CHECKMACHINE) {
        // 如果关闭则不进行check直接放出
        var befChkFlag = $j("#hidBeforeChkFlag").val();
        if (befChkFlag == "true" && lastReq.cmd == '0x32') {
            changeMachine.processReqToNum(lastReq);
            //如果有零钱则进行找钱
            if (!changeMachine.checkAmountHas(crgPnt.getTotal)) {
                $("#loading-image").hide();
                chgWrapStatus('error',CHARGE.NOCHARGEOUT);
                $j("input.reOpenBtn").show();
                return;
            }
        }
        if (!crgPnt.allReturn) changeInOver(crgPnt.result,crgPnt.getTotal,crgPnt.res_arr,crgPnt.total);
        crgPnt.callBackSeqArr = [CHARGE.CHARGEOUT];
        chgWrapStatus('loading',CHARGE.CHARGEOUT);
        crgPnt.nextStep();
    // 2018/04/09 釣銭機入金方式更新 BY ZY END
    }
}
function changeInOver(result,change,arr,total){
    // 如果不是中止的情况 进行レーシト印刷
    if ( change != undefined && !crgPnt.allReturn) autoReshitoPrint(arr,change,total);
    // 保存lock判断
    if (actionSaveFlag) {
        setTimeout(function(){
            changeInOver(result);
        },200);
        return;
    }
    if (!crgPnt.allReturn) paymentBtn(result,true);
}
function restFun(){
    crgPnt.callBackSeqArr = [CHARGE.REST];
    crgPnt.curSeq = CHARGE.REST;
    crgPnt.nextStep();
}
// 2017/06/05 釣銭機の復旧処理　by　zy END
// 打开窗口响应
function startChangeWin(){
    chgWrapStatus('unconnect','',CHARGE.UNCONNECT);
    chgWrapStatus('loading',CHARGE.CONNECTING);
    crgPnt.render.show();
    $("#msg,#listmessage",".printBack").hide();
    crgPnt.render.append($("#costMachine").show());
}
function meisuuRequest(res){
    //if ( crgPnt.allReturn && crgPnt.isSetting && crgPnt.curSeq == CHARGE.STOP) {
        crgPnt.returnAmount = {
            return_amt_10k : res['1万円処理枚数'],
            return_amt_5k :  res['5千円処理枚数'],
            return_amt_2k :  res['2千円処理枚数'],
            return_amt_1k :  res['1千円処理枚数'],
            return_amt_500 : res['500円処理枚数'],
            return_amt_100 : res['100円処理枚数'],
            return_amt_50 :  res['50円処理枚数'],
            return_amt_10 :  res['10円処理枚数'],
            return_amt_5 :   res['5円処理枚数'],
            return_amt_1 :   res['1円処理枚数'],
        };
    //}
}
function jsonParameter(jsonKeyName, objectName) {
    var value = safeValue(objectName);
    
    var json = '\\"' + jsonKeyName + '\\": '  + encodeURIComponent(value);
    
    return json;
}
function safeValue(obj) {
    if (!obj) return "0";
    var value = obj;
    if (!value || value == "") value = '"0"';
    return value;
}
// 2017/08/10 入金自動レシート印刷機能追加　by　zy BEGIN
// 自動保存、入金完了反応する
function saveAccount(){
    // 自動機能判定
    var isAutoSaveFlag = {!isAutoFlag};
    if (isAutoSaveFlag){
        // 2017/08/22 自動保存効率up by zy BEGIN
        // 一次保存比较
        actionSaveFlag = true; 
        // 2017/08/22 自動保存効率up by zy END
        jinyaConnectBlockUi(true);
        copySelectValToHidden();
        refreshTranItemFun();
    }
}
// 2017/08/22 自動保存効率up by zy BEGIN
// loading页面隐藏block
function jinyaConnectBlockUi(hiddenFlag){
    JINYACONNECT.blockUi();
    // hide background
    if (hiddenFlag) $(".blockUI.blockOverlay").hide();
}
// 为打印信息添加支付
function addPaysInfo(){
    // 准备打印信息
    crgPnt.res_arr = printMsgInfo();
    // 添加现金支付信息
    var payAmount = $("#total").text();
    var result = crgPnt.result;
    // 存在商品才说明被执行性或者调用
    if (result != undefined) {
        for (var i = 0 ; i < crgPnt.res_arr.length ; i++) {
            var pntInfo = crgPnt.res_arr[i];
            if ("pays" in pntInfo.parameter) {
                var paysArr = pntInfo.parameter.pays;
                paysArr.push({'name': encodeURIComponent(result.prodcutName),'price':payAmount});
            }
        }
    }
}
// レシート印刷
function autoReshitoPrint(res_arr,change,total){
    for (var i = 0 ; i < res_arr.length ; i++) {
        var pntInfo = res_arr[i];
        // 2017/08/10 入金自動レシート印刷機能追加　by　zy BEGIN
        // 入金完了自动调用判断
        if("change" in pntInfo.parameter ) {
            pntInfo.parameter.change = kendo.toString(change,"c");
            var receviedStr = pntInfo.parameter.recevied;
            receviedStr = receviedStr.replace(kendo.getCulture().numberFormat.currency.symbol,"");
            var receviedAmount = kendo.parseFloat(receviedStr);
            receviedAmount += change;
            pntInfo.parameter.recevied = kendo.toString(receviedAmount,"c");
        }
        // 2017/08/10 入金自動レシート印刷機能追加　by　zy END
    }
    //执行打印
    printDo(res_arr);
}
// 2017/08/22 自動保存効率up by zy END
// 2018/04/09 釣銭機入金方式更新 BY ZY BEGIN
// 印刷閉じる
function printStop(stopFlag){
    var oldWayFlag = $j("#hidOldWayFlag").val();
    var isOldWayFlag = oldWayFlag == 'true';
    var stopFlag = stopFlag == true ? true : false; 
    // 链接状态情况下
    if (!isOldWayFlag && crgPnt.isConnect()) {
        if (stopFlag) crgPnt.callBackSeqArr = [CHARGE.STOP];
        else crgPnt.callBackSeqArr = [CHARGE.INPUTOVER];
        crgPnt.command = CHARGE.INPUTSTOP;
        crgPnt.nextStep();
    }
    return !isOldWayFlag;
}
// 入金チェック対応
function changeInputCheck(lastReq){
    var oldWayFlag = $j("#hidOldWayFlag").val();
    var isOldWayFlag = oldWayFlag == 'true';
    var machineInfo = lastReq[STATUS_KEY.MACHINE];
    if (isOldWayFlag) {
        if( machineInfo == STATUS.SOH){
            // 中止
            crgPnt.curSeq = CHARGE.STOP;
            crgPnt.allReturn = true;
            stopPrint.connect();
            return false;
        } else if ( machineInfo == STATUS.EM ) {
            crgPnt.callBackSeqArr = [CHARGE.STOP];
            crgPnt.allReturn = true;
        }
    } else if( machineInfo == STATUS.SOH || machineInfo == STATUS.EM){
        crgPnt.callBackSeqArr = [CHARGE.STOP];
        crgPnt.allReturn = true;
        // 跳过復旧処理 直接调用中止
        //復旧処理フラグ
        crgPnt.command = CHARGE.INPUTSTOP;
    }
    return true;
}
// 入金消息对应
function changeInput(lastReq){
    var oldWayFlag = $j("#hidOldWayFlag").val();
    var isOldWayFlag = oldWayFlag == 'true';
    if (isOldWayFlag) {
        //入金返回数据超时后
        if (lastReq.timeout != undefined && lastReq.timeout == 'over') {
            //重新执行
            crgPnt.reConnectLast();
            return;
        } 
    } 
    // 获取变更金额
    var changeTotal = refreshInput(lastReq);
    // 如果存在变更金额则自动入金完了
    if (changeTotal >= 0 ) {
        successAccount();
    // 入金不超过找零の場合
    } else if (!isOldWayFlag){
        //　200ミリ秒後重新执行
        setTimeout(function(){
            crgPnt.reConnectLast();
        },200);
    }
}
// 2018/04/09 釣銭機入金方式更新 BY ZY END
// 零钱机状态
var changeMachine = {
    array:['TenThousandCash','FiveThousandCash','TowThousandCash','OneThousandCash','FiveHundredCash','OneHundredCash','FiftyCash','TenCash','FiveCash','OneCash'],
    'TenThousandCash':{
        int:10000,
        label:'紙幣機内総金額-1万円',
    },
    'FiveThousandCash':{
        int:5000,
        label:'紙幣機内総金額-5千円',
    },
    'TowThousandCash':{
        int:2000,
        label:'紙幣機内総金額-2千円',
    },
    'OneThousandCash':{
        int:1000,
        label:'紙幣機内総金額-1千円',
    },
    'FiveHundredCash':{
        int:500,
        label:'硬貨機内総金額-500円',
    },
    'OneHundredCash':{
        int:100,
        label:'硬貨機内総金額-100円',
    },
    'FiftyCash':{
        int:50,
        label:'硬貨機内総金額-50円',
    },
    'TenCash':{
        int:10,
        label:'硬貨機内総金額-10円',
    },
    'FiveCash':{
        int:5,
        label:'硬貨機内総金額-5円',
    },
    'OneCash':{
        int:1,
        label:'硬貨機内総金額-1円',
    },
    // 币种数量添加
    processReqToNum:function(lastReq){
        if (this.array.length > 0) {
            for(var i = 0 ; i < this.array.length ; i++) {
                var curLabel = this.array[i];
                // 币种存在
                if (curLabel in this) {
                    // 指定币种数量
                    var num = lastReq[this[curLabel].label];
                    if (curLabel in this) this[curLabel].num = num;
                }
            }
        }
    },
    // 获取当前币种
    getCurCashByIndex:function(){
        return this[this.array[this.checkIndex]];
    },
    // 查看是否能找零
    checkAmountHas:function(amount){
        this.checkIndex = 0;
        while (amount > 0) {
            if (this.checkIndex >= this.array.length) break;
            var curCash = this.getCurCashByIndex();
            var maxNum = curCash.num;
            this.checkIndex++;
            for (var i = maxNum ; i > 0 ; i--) {
                var maxAmount = i*curCash.int;
                if (amount >= maxAmount) {
                    amount-= maxAmount;
                    break;
                }
            }
        }
        return amount == 0;
    },
}
// 当前命令再送
function reSendMsg(){
    // 隐藏「再開」按钮
    $j("input.reOpenBtn").hide();
    // 状況更新
    chgWrapStatus('loading',CHARGE.CHARGEOUT);
    // 釣銭機再開
    crgPnt.reConnectLast();
}
</script>
<!-- 2018/04/09 釣銭機入金方式更新 BY ZY BEGIN -->
<input type="hidden" value="{!oldWayFlag}" id="hidOldWayFlag"/>
<input type="hidden" value="{!beforeChkFlag}" id="hidBeforeChkFlag"/>
<!-- 2018/04/09 釣銭機入金方式更新 BY ZY END -->
    <div id="costMachine">
        <!-- 
        <div style="background: #f8f8f8;width:100%;text-align: left; font-size: 20px;font-weight: bold; border-bottom: 1px solid #dbdbdb;">
            <img src="../img/icon/computer32.png" alt="Loading..." style="vertical-align: middle;"/><span>釣銭機</span>
        </div>
         -->
        <table style="border-spacing: 0px;background:#fffff;border-collapse: 0px;table-layout: fixed;width:100%">
            <tr>
                <td style="width:85%; text-align: left;vertical-align: middle;">
                    <table style="width: 100%; border-spacing: 0px;border-collapse: 0px;  font-size: 16px;font-weight: bold;table-layout: fixed;">
                        <tr>
                            <td colspan="3" style="border-bottom: 1px solid #dbdbdb;">
                                <table style="width: 100%; border-spacing: 0px;border-collapse: 0px; background:#f8f8f8;font-size: 16px;font-weight: bold;table-layout: fixed;">
                                    <tr>
                                        <td style="width:30px;">
                                            <img id="error-image" class="icon-status" src="../img/msg_icons/error24.png" alt="Loading..." />
                                            <img id="sucess-image" class="icon-status" src="../img/msg_icons/confirm24.png" alt="Loading..." />
                                        </td>
                                        <td style="text-align: left;">
                                            <div class="connectStatus"></div>
                                        </td>
                                        <td>
                                            <div style="float:right;"> <img src="/img/x.gif" style="cursor: pointer;" onclick="closeAccount()"/> </div>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr>
                            <td style="width:300px;">
                                <table style="table-layout: fixed;">
                                    <tr>
                                        <td style="width:30px;">
                                            <img id="loading-image" class="icon-status" src="../img/loading32.gif" alt="Loading..." />
                                        </td>
                                        <td>
                                            <div class="curStatus"></div>
                                        </td>
                                    </tr>
                                </table>
                                <div id="inputStatus" style="position: absolute;display:none;">
                                    <div>紙幣：<span id="paperOpening"></span></div>
                                    <div>硬貨：<span id="coinOpening"></span></div>
                                </div>
                            </td>
                            <td colspan="2">
                                <table>
                                    <tr>
                                        <td style="height: 24px;width:200px;">
                                            <!-- ご請求金額(税込)： -->
                                            <span>{!$Label.MSG_006_0259}</span>
                                        </td>
                                        <td style="text-align: right;padding:0px 26px;">
                                            <span id="total" ></span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="height: 24px;">
                                            <span>現金入金:</span>
                                        </td>
                                        <td style="text-align: right;padding:0px 26px;">
                                            <span id="curTotal" ></span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="height: 24px;">
                                            <!-- ご利用金額(税込)： -->
                                            <span>お釣り:</span>
                                        </td>
                                        <td style="text-align: right;padding:0px 26px;">
                                            <span id="charge" ></span>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
        <div style="text-align: center;height: 40px;margin-top:20px; padding: 10px 1px 1px;">
            <input type="button" class="btn orgBtn" style="width:100px;height: 30px;font-size: 13px;" value="手動入力" onclick="oldAccount()"/>
            <input type="button" class="btn sucBtn" style="width:100px;height: 30px;font-size: 13px;" value="入金完了" onclick="successAccount()"/>
            <input type="button" class="btn retBtn" style="width:100px;height: 30px;font-size: 13px;"  value="中止" onclick="hideAccount()"/>
            <input type="button" class="btn restBtn" style="width:100px;height: 30px;font-size: 13px;display:none;" value="リセット" onclick="restFun()"/>
            <!-- 2018/04/09 釣銭機入金方式更新 BY ZY BEGIN -->
            <input type="button" class="btn reOpenBtn" style="width:100px;height: 30px;font-size: 13px;" value="再開" onclick="reSendMsg()"/>
            <!-- 2018/04/09 釣銭機入金方式更新 BY ZY END -->
        </div>
    </div>
</apex:outputPanel>
<input type="hidden" value="{!mulitiComments}" id="billCommentHid" />
<!-- 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz BEGIN -->
<input type="hidden" value="{!mrTypeLstJson}" id="hidmrTypeLstJson" />
<input type="hidden" value="{!RespectFlg}" id="hidRespectFlg" />
<!-- 2019/10/15 見積書、請求書、会計書、予約確認書の敬称を選択できるように改善対応 BY zyz END -->

<!-- JS get Change-->
<input type="hidden" value="{!userId}" id="hidUserId"/>
<input type="hidden" value="{!accSpCd}" id="hidAccSpCd"/>
<input type="hidden" value="{!billSpCd}" id="hidBillSpCd"/>
<input type="hidden" value="{!spCdCookieFlg}" id="hidSpCdCookieFlg"/>
<input type="hidden" value="{!transRowInt}" id="hidTransRowInt"/>
<input type="hidden" value="{!autoSaveLimit}" id="hidAutoSaveLimit"/>
<input type="hidden" value="{!autoSaveMessage}" id="hidAutoSaveMessage"/>

<script id="rowTemplate" type="text/x-kendo-template">
    <tr class="tranDetailRow dataRow">
        <td class="dataCell">
            <div title="{!$Label.MSG_006_0311}"  class="pointIndex" rowIndex = "_index_">
                <img title="" class="pointImg" alt="" src="{!URLFOR($Resource.AppImages, 'extend/blur.png')}" />  
            </div>
        </td>
        <td class="dataCell">
            <input type="button" title="{!$Label.MSG_006_0253}" value="{!$Label.MSG_006_0253}" id=":_index_:clearProduct" onclick="clearProductInfo();" rowIndex = "_index_" class="detailCommStyle"/>
        </td>
        <td class="dataCell" style="text-align: center;">
            <input type="checkbox" title="{!$Label.MSG_006_0253}" value="{!$Label.MSG_006_0253}" id=":_index_:InvoiceNoShowFlg" onclick="changeInvoice();" class="detailCommStyle" _invoicecheck_/>
        </td>
        <td class="dataCell">
            <input type="text" value="_usedate_" onfocus="focusToBindEvent()" onchange="dateChange()" onblur="lastAddRows()"  style="width:90%;height:100%" id=":_index_:useDate" class="detailCommStyle"/>
        </td>
        <td class="dataCell">
            <span class="lookupInput">
                <table style="width: 100%;border-spacing: 0;border: 0; padding: 0">
                    <tr>
                        <td width="24px;" style="border-bottom:0px">
                            <span id=":tran1Table:_index_:icon_span">
                                _paymentImg_
                            </span>
                        </td>
                        <td style="border-bottom:0px">
                            <input type="text" value="_productNm_" id="_index_:productName" onfocus="onDeviceStart();focusToBindEvent()" onchange="productNameChg()" onblur="lastAddRows()"  maxlength="80" style="width:100%;height:100%" rowIndex="_index_"  styleClass="detailCommStyle"/>
                        </td>
                        <td style="width: 2px; border-bottom:0px">　</td>
                        <td style="width: 22px;border-bottom:0px">
                        <img title="{!$Label.MSG_006_0214}" src="{!URLFOR($Resource.AppImages, 'extend/jiahao.png')}"
                            style="cursor: pointer;width: 18px; height: 18px; visibility:_planshow_"
                            id="showDetailEvent_index_" onclick="showDetailFun(this)" openStatus="false"
                            rowIndex = "_index_" />
                        </td>
                    </tr>
                </table>
            </span>
        </td>
        <td class="dataCell">
            <input type="text" value="_unitPrice_" onfocus="focusToBindEvent()" onblur="lastAddRows()"  _readonly_ id="_index_:price" size="20" style="width:90%;height:100%" class="detailCommStyle"/>
        </td>
        <td class="dataCell">
            <input type="text" value="_quantity_" onfocus="focusToBindEvent()" onblur="lastAddRows()"  id="_index_:orderNums" maxlength="11" size="20"style="width:90%;height:100%" class="detailCommStyle"/>
        </td>
        <td class="dataCell" style="text-align: right; background-color: #FFEBCD;">
            <span id='_index_:amoutPriceIncTax'>_amoutIncTax_</span>
        </td>
        <td class="dataCell" style="text-align: right; background-color: #FFEBCD;">
            <span id='_index_:amoutPriceExcTax'>_amoutExcTax_</span>
        </td>
        <td class="dataCell" style="text-align: right;">
            <span id="_index_:taxRateType">_taxRate_</span>
        </td>
        <td class="dataCell" style="text-align: right;">
            <span id='_index_:serviceRate'>_serviceRate_</span>
        </td>
        <td class="dataCell">
            <input type="text" class="detailCommStyle" onfocus="focusToBindEvent()" onblur="lastAddRows()" value="_specialTax_" id="_index_:specialTax" style="width:90%;height:100%"/>
        </td>
    </tr>
</script>
</apex:page>