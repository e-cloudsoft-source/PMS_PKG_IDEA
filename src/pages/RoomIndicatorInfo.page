<!-- ルームインジケータ -->
<apex:page controller="RoomIndicatorInfo" action="{!gotoDate}" id="RoomIndicatorPage"
sidebar="false"  title="{!$Label.ps__msg_008_0001}" showheader="{!!isIncludeMode}" >

<!-- Load Css Style -->
<apex:stylesheet value="{!URLFOR($Resource.yahooFiles, 'css/skin.css')}"/>
<apex:stylesheet value="{!URLFOR($Resource.kendoFiles, 'styles/kendo.common.min.css')}"/>
<apex:stylesheet value="{!URLFOR($Resource.kendoFiles, 'css/ui-lightness/jquery-ui-1.10.2.custom.min.css')}"/>
<apex:stylesheet value="{!URLFOR($Resource.kendoFiles, 'styles/kendo.default.min.css')}"/>
<!-- Load Js Core Lib --> 
<apex:includeScript value="{!URLFOR($Resource.kendoFiles, 'js/jquery.min.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.kendoFiles, 'js/jquery-ui-1.10.2.custom.min.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.kendoFiles, 'js/kendo.web.min.js')}"/>

<!-- Load jQuery Plugin -->
<apex:includeScript value="{!URLFOR($Resource.queryfiles, 'js/dateformat.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.queryfiles, 'js/jquery.blockUI.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.dateplugin, 'date/date.js')}"/>
<!-- 2014/11/25 六曜計算追加 -->
<apex:includeScript value="{!URLFOR($Resource.dateplugin, 'date/qreki.js')}" />
<apex:includeScript value="{!URLFOR($Resource.dateplugin, 'date/qrekiHelp.js')}" /> <!-- 和暦LIBのサポート関数 -->
<!-- 2014/11/27 CKEDITOR追加 -->
<apex:includeScript value="{!URLFOR($Resource.ckeditor, 'ckeditor.js')}" />
<apex:includeScript value="{!URLFOR($Resource.ckeditor, 'util.js')}" />
<!-- 2015/07/10 KeyDefine追加 -->
<apex:includeScript value="{!URLFOR($Resource.queryfiles, 'js/keymaster.js')}"/>

<!-- Load YUI -->
<apex:includeScript value="{!URLFOR($Resource.yahooFiles, 'js/yahoo-dom-event.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.yahooFiles, 'js/container-min.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.yahooFiles, 'js/animation-min.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.yahooFiles, 'js/dragdrop-min.js')}"/>

<apex:stylesheet value="{!URLFOR($Resource.multiselectlib, 'css/jquery.multiselect.css')}"/>
<apex:includeScript value="{!URLFOR($Resource.multiselectlib, 'js/jquery.multiselect.min.js')}"/>

<!-- Load CommJsLib -->
<apex:includeScript value="{!$Resource.CommJs}"/>
<apex:includeScript value="{!$Resource.planExtendPlug}"/>

<c:CommHeaderComp loadJsLib="false"/>
<!--  2019/11/15 最近利用している商品一覧機能を提供する BY zyz BEGIN -->
<c:AutoAccountMasterComp />
<!--  2019/11/15 最近利用している商品一覧機能を提供する BY zyz END -->
<!-- 2016/10/13 BEGIN by zh-->
<!-- JSで単価金額計算ロジック -->
<c:CommProductFeeCalJsComp />
<!-- 2016/10/13 BEGIN by zh-->
<!-- 2019/09/15 指定日自动记忆機能対応 WGCH BEGIN -->
<c:UserConfigComp functiontype="KREP"/>
<!-- 2019/09/15 指定日自动记忆機能対応 WGCH END -->
<style>
/* Info Block Container */
html { {!IF(isShowTimeTable, 'width: 1720px;', '')} }
#container{
    position:relative;
	height:100%;
	padding: 0;
	vertical-align: top;
	text-align: center;
	border-width: 1px;
	border-style: solid;
	border-color: white;
}
/* Salesforce Calendar Link No Show */
div.hideCurrDate span.dateInput span.dateFormat{
	display:none;
}
span.dateInput span.dateFormat{
	display:none;
}
h2 .mainTitle {
	font-size: 14px;
}
/* Room Indicator Info Block Css */
#iconheader{
 font-weight:bold;
 width:{!roomDivWidth}px;
 height:14px;
 margin: 0 auto;
 overflow:hidden;
}
/* Info Block Header */
#header{
 font-weight:bold;
 width:{!roomDivWidth}px;
 height:14px;
 margin: 0 auto;
 overflow:hidden;
}
/* Info Block Middle */
#midbody{
 width:{!roomDivWidth}px;
 height:14px;
 margin:0 auto;
 background: #ffffcc;
 overflow:hidden;
 margin-top: 2px;
}
/* Info Block Footer */
#foot{
 width:{!roomDivWidth}px;
 height:14px;
 margin:0 auto;
 vertical-align:bottom;
 overflow:hidden;
 white-space: nowrap;
 margin-top: 2px;
}
/* 予約人数 */
#foot2{
 height:14px;
 margin:0 auto;
 overflow:hidden;
 white-space: nowrap;
 margin-top: 2px;
 /* 2019/10/24 20191021.01.iOS13.1.2以降にバージョンアップすると、ルームインジケータの縦セルに定義した項目が完全に表示されません by zy BEGIN*/
 width:{!roomDivWidth}px;
 /* 2019/10/24 20191021.01.iOS13.1.2以降にバージョンアップすると、ルームインジケータの縦セルに定義した項目が完全に表示されません by zy END*/
}
/* 色設定 */
/* 2014/08/29 色のカスタムマイズ機能追加 */
.isNoneStatus{}								/* 未設定場合 */
.isEmptyStatus{background:#FFFFFF;}         /* 空室 */
/*.isAssignedStatus{background:#00ccff;} */	/* 割当済 */
/*.isAssignedStatus_1{background:#00ccff;} */
/*.isStayStatus{background:#90EE90;} */          /* 滞在 */
/*.isStayStatus_1{background:#90EE90;} */        /* 滞在 */
/*.isChkOutDayStatus{background:#FDD017;} */     /* 出発予定 */
/*.isChkOutStatus{background:#F75D59;} */        /* 出発 */
/*.isBadStatus{background:#2554C7;} */           /* 故障 */
/*.isCleanStatus{background:#B0C4DE;} */         /* 未清掃      ->判断条件は判断要 */
.isAssignedStatus{background:{!BLANKVALUE((statusColor.RS_RoomAssigned),"#00ccff")};}	/* 割当済 */
.isAssignedStatus_1{background:{!BLANKVALUE((statusColor.RS_RoomAssigned),"#00ccff")};}	/* 割当済 */
/* 2019/02/28 滞在・外出状態の管理 WGCH BEGIN */
.isOutStatus{background:{!BLANKVALUE((statusColor.RS_RoomOut),"#CCCCCC")};} /* #C1FFC1外出 */
/* 2019/02/28 滞在・外出状態の管理 WGCH END */
.isStayStatus{background:{!BLANKVALUE((statusColor.RS_RoomStay),"#90EE90")};}			/* 滞在 */
.isStayStatus_1{background:{!BLANKVALUE((statusColor.RS_RoomStay),"#90EE90")};}			/* 滞在 */
.isChkOutDayStatus{background:{!BLANKVALUE((statusColor.RS_RoomChkOutDay),"#FDD017")};}	/* 出発予定 */
.isChkOutStatus{background:{!BLANKVALUE((statusColor.RS_RoomChkOut),"#F75D59")};}		/* 出発 */
.isBadStatus{background:{!BLANKVALUE((statusColor.RS_RoomBad),"#2554C7")};}				/* 故障 */
.isCleanStatus{background:{!BLANKVALUE((statusColor.RS_RoomNoClean),"#B0C4DE")};}		/* 未清掃      ->判断条件は判断要 */

.isConfirmationing{background:#E238EC;}     /* 仮チェックイン */

/* AutoComplete */
.ui-autocomplete {
    max-height: 160px;
    overflow-y: auto;
    /* prevent horizontal scrollbar */
    overflow-x: hidden;
}
/* IE 6 doesn't support max-height
 * we use height instead, but this forces the menu to always be this tall
 */
* html .ui-autocomplete {
    height: 160px;
}
.ui-autocomplete-loading { background: white url({!URLFOR($Resource.queryfiles, "css/ui-lightness/images/ui-anim_basic_16x16.gif")}) right center no-repeat; }
.ui-autocomplete { position: absolute; cursor: default;z-index:30 !important;}
/* Menu Icon Setup */
.context-menu-item.icon-clean { background-image: url({!URLFOR($Resource.queryfiles, "css/contextmenu/images/cleanicon.png")}); }
/* 未割合の予約データ情報/毎情報　 */
/*
.guestdiv {
	width: 240px;
	height:30px;
	font-size: 14px;
}*/
/* Drop範囲入る表示用 */
.drop-ui-state-hover {
	color : #ffa500
}
.drop-ui-state-hover-noAssignWin {
	border: 2px dashed #ffa500;
}

/*
.noAssignLead-view {
    width: 270px;
    height: 30px;
    margin: 2px;
    padding: 5px;
    
    border-top: 1px solid rgba(255,255,255,1);
    border-right: 1px solid rgba(0,0,0,0.1);
    border-bottom: 1px solid rgba(0,0,0,0.1);
    border-left: 1px solid rgba(255,255,255,0.1);
	
    background: -moz-linear-gradient(top,  rgba(0,0,0,0.05) 0%, rgba(0,0,0,0.10) 100%);
    background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(0,0,0,0.05)), color-stop(100%,rgba(0,0,0,0.10)));
    background: -webkit-linear-gradient(top,  rgba(0,0,0,0.05) 0%,rgba(0,0,0,0.10) 100%);
    background: -o-linear-gradient(top,  rgba(0,0,0,0.05) 0%,rgba(0,0,0,0.10) 100%);
    background: -ms-linear-gradient(top,  rgba(0,0,0,0.05) 0%,rgba(0,0,0,0.10) 100%);
    background: linear-gradient(to bottom,  rgba(0,0,0,0.05) 0%,rgba(0,0,0,0.10) 100%);
}*/
.k-widget {
	background-color:#FFFFFF;{!IF(WatermarkRate, 'filter:alpha(opacity=85);-moz-opacity:0.85;-khtml-opacity:0.85;opacity:0.85;', '')}
}
.roomTypeClass {
    border-top: 1px solid rgba(255,255,255,1);
    border-right: 1px solid rgba(0,0,0,0.1);
    border-bottom: 1px solid rgba(0,0,0,0.1);
    border-left: 1px solid rgba(255,255,255,0.1);
    background:orange;
	vertical-align: middle;
	text-align:center;
	min-width: 80px;
	width: 80px;
	float: left;
	height: 30px;
	font-size: 14px;
	cursor: pointer;
}

/* Time Table Css */
.ui-selecting{background:#F60;}
.ui-selected{background:#F60;}
.comfirmStatus{background:#CCCC33;}
.comfirmedStatus{background:#33CC66;}
.tmpBookinged{background:#FFCCFF;}
.partyroomBook{background:#6699ff;}

/** float lock image */
.floatLeftImg {
    z-index:4;
    position:relative;
    margin-right:0px;
    float:left;
    margin: 0px 1px 0px 1px;
}
.addNewEventIcon {
	width:14px;
	height:14px;
	margin: 2px 0px 0px 1px;
	z-index:1;
    float:left;
}
.addNewEventIcon:hover{
	cursor: pointer;
	background-color: #F5F6CE;
}
/* 2019/12/30 小部屋の作成 BY zyz BEGIN */
.addNewRoomIcon {
	width:14px;
	height:14px;
	z-index:1;
    float:left;
}
.addNewRoomIcon:hover{
	cursor: pointer;
	background-color: #F5F6CE;
}
/* 2019/12/30 小部屋の作成 BY zyz END */
div.hideCurrDate span.dateInput span.dateFormat{
   display:none;
}
span.dateInput span.dateFormat{
   display:none;
}
.triangle-topright {
    position:absolute;
    z-index:4;
	top:0;
	right:0;
	width:22px;
	height:22px;
	line-height:22px;
    margin:0 auto;
    text-align:center;
    opacity: 0.8;
	background-image:url("{!URLFOR($Resource.AppImages, 'extend/coner.png')}");
	background-position:center top;
	background-repeat:no-repeat;
	-moz-background-size:cover;
	background-size:cover;
	color:white;
	cursor: pointer;
}
.triangle-topright:hover{
	font-size: 18px;
}

.blackCream{
	position: relative;
}

/*2018/12/15 ルームインジケータ画面に連絡事項は１項目に変更対応 by cxw BEGIN*/
/* CKEDITOR RICH TEXTAREA CSS */
/*.cke_contents {
    height: 80px !important;
}*/

/* KENDO UI CSS EDIT */
/*2018/12/15 ルームインジケータ画面に連絡事項は１項目に変更対応 by cxw END*/
/* 予約名、お客様名いり替え制御 */
.noAssignLeadListWindowClass {
    position: fixed !important;
}
span .assignRoomIsShowPanel .k-dropdown .k-dropdown-wrap{
    height: 20px;
    padding:0px;
    margin-top: 0px;
}
span .assignRoomIsShowPanel .k-dropdown-wrap .k-input {
	height: 20px;
	padding: 0px;
}
span .assignRoomIsShowPanel .k-widget.k-dropdown.k-header {
	height: 23px;
}
/* XML___wgch 2016/11/16 BEGIN*/
.roomChangeTd{
	display:none;
}
.timeChangeTd{
	display:none;
}
#myPanel td.data2Col, #myPanel th.labelCol.vfLabelColTextWrap, #myPanel td.dataCol, #myPanel td.labelCol.empty{
	{!IF(isLineHeightFlg,'padding-top: 0px !important;padding-bottom: 0px !important;','')}
	
}
.TextAreaTd{
 	word-wrap: break-word;
	word-break: normal;
	/*display: block;*/
}
#myPanel th.labelCol.vfLabelColTextWrap.last,#myPanel td.data2Col.last,#myPanel td.dataCol.last{
	border-bottom-width: 1px !important;
}
.coloumn2Class{
	/*max-width: {!widthPx/4}px;*/
	word-wrap: break-word;
}
.coloumn1Class{
	max-width: {!widthPx*0.7}px;
	word-wrap: break-word;
}
.pbSubheader.brandTertiaryBgr.tertiaryPalette{
	margin-top: 0px;
}
/* XML___wgch 2016/11/16 END*/
/* 2017/01/25 新規画面の項目自定義機能　by　zy　BEGIN*/
.cusRepuiredClass{
	background-color: #c00;
    position: absolute;
    left: -4px;
    width: 3px;
    top: 1px;
    bottom: 1px;
}
td.dataCol{
	position: relative;
}
.repuired{
    background-color: #c00;
    position: absolute;
    left: -4px;
    width: 3px;
    top: 1px;
    bottom: 1px;
}
/* 2017/01/25 新規画面の項目自定義機能　by　zy　END*/
/* 2017/12/22 画面フィルター機能追加　by　zy　BEGIN */
.filteredRow{
	display:none;
}
/* 2017/12/22 画面フィルター機能追加　by　zy　END */
/* 2019/05/30 こちらをルームインジケータ上からも1日単位の作成、削除（削除だけでもほしい）by zy BEGIN */
div[id=foot].isBadStatus{
	cursor: pointer;
}
/* 2019/05/30 こちらをルームインジケータ上からも1日単位の作成、削除（削除だけでもほしい）by zy END */
/* 2019/12/30 名前か電話番号のどちらかだけ一致するお客様がすでに存在する BY zyz BEGIN */
#contact_tableId tr:nth-child(even){background-color: #f1f1f1;}
.contactheader{
background-image: none,linear-gradient(to bottom,rgba(255,255,255,.6) 0,rgba(255,255,255,.0) 100%);
background-position: 50% 50%;
background-color: #e3e3e3;
}
/* 2019/12/30 名前か電話番号のどちらかだけ一致するお客様がすでに存在する BY zyz END */
</style>
<!-- 2019/11/15 ルームインジケータの表示について、清掃済だけでなくインスペ完の状況を追加したいです。 by zy BEGIN-->
<style>
    <apex:repeat value="{!cleansLst}" var="clean" rendered="{!cleansLst.size > 0}">
    .status_{!clean.name}{
        background:{!clean.color};
    }
    </apex:repeat>
</style>
<!-- 2019/11/15 ルームインジケータの表示について、清掃済だけでなくインスペ完の状況を追加したいです。 by zy END-->
<script>
// 2018/12/15 ルームインジケータ画面に連絡事項は１項目に変更対応 by cxw BEGIN
CKEDITOR && (CKEDITOR.config.height = 80);
// 2018/12/15 ルームインジケータ画面に連絡事項は１項目に変更対応 by cxw END
// 2016/10/13 BEGIN by zh
var _showFlg = {!(isPlanDetailFlag)};
if (typeof JINYACONNECT === "undefined") {
	JINYACONNECT = {};
}
if (typeof JINYACONNECT.CUSTOM === "undefined") {
	JINYACONNECT.CUSTOM = {};
} 
// clear the one row info
JINYACONNECT.CUSTOM.clearItemIdArr = new Array(':hidProductId',':hidProductNm',
     ':productName',':price',':orderNums',
     ':amoutPriceExcTax',':amoutPriceIncTax',':hidSyncInfo',':amoutPriceExcTax',':amoutPriceIncTax',
     ':hidAmoutPriceIncTax',':hidAmoutPriceExcTax',':hidPlandetail',':hidHadRoomFlag',
     // 2019/07/30 軽減税率機能対応 WGCH BEGIN
     // 支払種別未清空Bug修订
     ':hidPaymentType',
     // 2019/07/30 軽減税率機能対応 WGCH END
     // 2020/07/30 入湯税の自動入力機能について改善 WGCH BEGIN
     ':hidBTaxAccMstId',':hidBTaxToPlanRowIndex',':hidBTaxAccMstItem',
     // 2020/07/30 入湯税の自動入力機能について改善 WGCH END
	 // 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH BEGIN
     ':hidBasePlanNum',':hidEstGuestType',
     // 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH END
     ':taxRateType', ':hidTaxRateType', ':serviceRate', ':hidServiceRate', ':specialTax', ':hidSpecialTax', ':hidActionType');
// 2016/10/13 END by zh
beenFocused = true;
var $j = jQuery.noConflict();
var autoFunExcuteFlag = false;
// 2019/07/31 20190527.04.タイムテーブル、ルームインジケータ、マルチタスク機能編集モードと読み込み専用モード対応必要 by zy END
// 日付書式化用変数
var dateFormat = new DateFormat(JINYACONNECT.DateFormat);
// チェックアウト完了文言定数
//チェックアウト完
var JS_LEADSTATUS_CHECKOUT='{!JSENCODE(mulitiCheckoutLabel)}';
// 2019/02/28 滞在・外出状態の管理 WGCH BEGIN
// 外出中
var JS_LEADSTATUS_OUT='{!JSENCODE(mulitiOutLabel)}';
// チェックイン完
var JS_LEADSTATUS_CHECKIN='{!JSENCODE(mulitiCheckinLabel)}';
// 2019/02/28 滞在・外出状態の管理 WGCH END
var timerInterval = 1*{!$Setup.CommDefine__c.ps__TimerSecond__c}*1000;
var intervalId = null;
// 2019/07/31 20190527.04.タイムテーブル、ルームインジケータ、マルチタスク機能編集モードと読み込み専用モード対応必要 by zy BEGIN
var _g_isCanUpdateFlg = {!(isCanUpdateLead && notReadOnlyFlg)};
var notReadOnlyFlg = {!notReadOnlyFlg};
// 2019/07/31 20190527.04.タイムテーブル、ルームインジケータ、マルチタスク機能編集モードと読み込み専用モード対応必要 by zy END
// 予約人數
var JS_StayPersons = 1 * {!BLANKVALUE($Setup.CommDefine__c.ps__BookingMansDef__c,0)} + 1 * {!BLANKVALUE($Setup.CommDefine__c.ps__BookingFemailsDef__c,0)} + 1 * {!BLANKVALUE($Setup.CommDefine__c.ps__BookingChildrenDef__c,0)};
$j(document).ready(function() {
	document.forms["RoomIndicatorPage:actionForm"].onsubmit = function(event){
		//console.log(autoFunExcuteFlag);
		if(!autoFunExcuteFlag) stopRunning();
	}
});
var beforeFilter = '';
</script>
<!-- 2020/07/30 入湯税の自動入力機能について改善 WGCH BEGIN -->
<c:CustomBathTaxAutoSet />
<script>
// HTML索引值初期设定
ACTCUSTOM.TAGINITFUN("[id$=BookEstTable] tbody tr.tranDetailRow", "hidProductId", "rowindex", "hidBTaxAccMstId", "hidBTaxToPlanRowIndex", "orderNums", "clearProduct", "hidBTaxAccMstItem", "autoGetProductInfo", "refreshOrder", "checkAddTranItem");
</script>
<!-- 2020/07/30 入湯税の自動入力機能について改善 WGCH END -->
<apex:actionStatus id="refStatusBlock"	onstart="javascript:blockUi();" onstop="unblockUi();" />	<!-- 処理中場合、画面BLOCK処理 -->
<apex:actionStatus id="autoUpdatePageStatus" onstart="callAutoUpdatePageFun()" rendered="false"/>	<!-- Timer自動処理のSTATUS制御 -->

<!-- Room Indicator -->		<!-- ルームインジケータ -->
<apex:sectionHeader title="{!$Label.ps__msg_008_0002}" subtitle="{!$Label.ps__msg_008_0001}" rendered="{!!isIncludeMode}"/>
<!--連絡事項情報FORM -->

<apex:outputPanel rendered="{!$Setup.CommDefine__c.MessageIsShowFlg__c}">
<apex:variable var="cnt" value="{!1}"/>
<apex:repeat value="{!MsgCompSpLst}" var="spcd">
<c:MessageItemComp yyyymmddStr="{!messageObj.name}" maxRows="{!$Setup.CommDefine__c.MessageRows__c}" id="messagitemcomp"
refreshMessageFunName="_messageComp_refreshMessage" container="m_{!spcd}" shopcode="{!spcd}" idx="{!cnt}" rendered="{!isShowMessageCompFlg}" ckeditor="{!$Setup.CommDefine__c.MessageIsRichTextFlg__c}"/>
<apex:variable var="cnt" value="{!cnt + 1}"/>
</apex:repeat>
</apex:outputPanel>

<apex:form id="actionForm" >
<!-- 自動更新を行う
<apex:actionPoller action="{!gotoDate}" id="timerPoller" oncomplete="refreshDS()" rendered="false"
    interval="{!$Setup.CommDefine__c.TimerSecond__c}" reRender="roomIndicator,timetablePanel" /> -->
<!-- Timer Poller 
<apex:actionPoller interval="{!$Setup.CommDefine__c.TimerSecond__c}" status="autoUpdatePageStatus" rendered="false"/>
		-->					
<apex:actionFunction name="timerRefreshInfoFun" action="{!gotoDate}" oncomplete="refreshDS();" 
		reRender="roomIndicator,timetablePanel" />							<!-- Read Newest Page Date 画面BLOCK処理なし -->
<apex:actionFunction name="refreshInfoFun" action="{!gotoDate}" oncomplete="refreshDS()"
		reRender="roomIndicator,timetablePanel" status="refStatusBlock" />	<!-- 画面最新情報を取得する、画面BLOCK処理あり -->
<apex:actionFunction name="refreshRoomAndMessage" action="{!gotoDate}" oncomplete="refreshDS()"
		reRender="roomIndicator,timetablePanel,messagitemcomp" status="refStatusBlock" />	<!-- 画面最新情報を取得する、画面BLOCK処理あり -->
<!-- 部屋アサイン情報BLOCK -->
<apex:pageBlock id="roomIndicator" title="{!strToday}">
<apex:outputPanel rendered="{!!(branchShopLst.size > 0 && multiSelectCompFlg)}">
<style>
.ui-state-default{
	overflow:hidden;
	background-image: none;
	border-color: #c5c5c5;
	background-color: #EEEEEE;
	color: #2e2e2e;
	vertical-align: middle;
	font-weight: normal;
	margin-left: 2px;
	   height: 24px;
}
label.ui-corner-all.ui-state-hover{
	border: 1px solid #bcb4b0;
	background: #C7C1BD url(images/ui-bg_glass_100_fdf5ce_1x400.png) 50% 50% repeat-x;
	font-weight: normal;
	color: #2e2e2e;
}
.ui-widget {
	font-family:'MS UI Gothic','MS PGothic','Hiragino Kaku Gothic Pro','Osaka','Arial','Helvetica',sans-serif;
	font-size: 13px;
}
.ui-multiselect-checkboxes li{
	font-size: 13px;
}   
.ui-state-default .ui-icon {
	background-image: url({!URLFOR($Resource.kendoFiles, 'css/ui-lightness/images/ui-icons_222222_256x240.png')});
}
.ui-state-hover{
	border: 1px solid #bcb4b0;
	background: #C7C1BD url(images/ui-bg_glass_100_fdf5ce_1x400.png) 50% 50% repeat-x;
	font-weight: normal;
	color: #2e2e2e;
}
ul li, ol li{
	margin-left: 0.5em;
}
.spanIco{
	width: 20px;
	display: block;
	display: inline-block;
}
.spanText{
	display: block;
	display: inline-block;
	white-space: nowrap;
	text-overflow: ellipsis;
	overflow: hidden;
	text-indent: .33em;
	/* 2020/08/30 BUG-FIX-#7467-浏览器缩放问题改善 WGCH BEGIN */
	width: calc(100% - 20px) !important;
	/* 2020/08/30 BUG-FIX-#7467-浏览器缩放问题改善 WGCH END */
}
input.k-textbox {
	height: 24px;
}
.k-dropdown-wrap .k-input {
	height: 22px;
	padding:0px;
	margin-top: 0px;
}
</style>
</apex:outputPanel>
<!-- 2021/03/05 50001エラー修正 by zy BEGIN-->
<!-- ALL店舗の警告メッセージ追加-->
<apex:outputPanel rendered="{!limitShopStr != ''}">
	<div class="message errorM3" role="alert">
	  	<table border="0" cellpadding="0" cellspacing="0" class="messageTable" style="padding:0px;margin:0px;">
	  		<tbody>
	  			<tr>
	  				<td><img src="/img/msg_icons/warning16.png" title="ERROR"/></td>
	                <td class="messageCell">
	                    <div class="messageText">
	                        <span><h4></h4></span><span class="errorText"></span>
	                        処理制限を超えました、店舗を選択してください
	                        <br/>
	                    </div>
	                </td>
	            </tr>
	  			<tr>
	  				<td></td>
	  				<td></td>
	  			</tr>
	  		</tbody>
	  	</table>
	</div>
</apex:outputPanel>
<!-- 2021/03/05 50001エラー修正 by zy END-->
<apex:outputPanel >
    <!-- 2018/05/11 複数店舗を選択表示できる機能対応 BEGIN -->
    <apex:actionFunction name="refreshBranShopFun" action="{!refreshBranShop}" />
	<c:MultiSelectComp dataSourceId="branchShopCd" assingTargetId="multiDepartCds" callBackFunction="refreshBranShopFun" selectedValue="{!multiDepartCds}" rendered="{!branchShopLst.size > 0 && multiSelectCompFlg}" />
	<apex:inputHidden value="{!multiDepartCds}" id="multiDepartCds"/>
	<apex:selectList size="1" value="{!branchShopNm}" rendered="{!branchShopLst.size > 0 && multiSelectCompFlg}" id="branchShopCd" html-multiple="multiple" >
    	<!-- All -->	
        <apex:selectOption itemValue="" itemLabel="{!$Label.ps__msg_008_0003}"/>
        <apex:selectOptions value="{!branchShopLst}" />
    </apex:selectList>
    <apex:inputHidden value="{!branchShopNm}" id="branchShopNm"/>
    <apex:selectList size="1" value="{!branchShopNm}" rendered="{!branchShopLst.size > 0 && !multiSelectCompFlg}" id="branchShopCdDef">
    	<!-- All -->
        <apex:selectOption itemValue="" itemLabel="{!$Label.ps__msg_008_0003}"/>
        <apex:selectOptions value="{!branchShopLst}" />
        <apex:actionSupport event="onchange" action="{!refreshBranShop}" />
    </apex:selectList>
    <!-- 2018/05/11 複数店舗を選択表示できる機能対応 END -->
    <!-- 2019/2/15 ルームインジケータの部屋タイプ絞り込み機能を、タイムテーブルと同じように、複数タイプ指定できるようにして欲しい by cxw BEGIN -->
    <apex:inputHidden value="{!multiRoomTypeIds}" id="multiRoomTypeIds"/>
    <apex:selectList size="1" value="{!roomTypeNm}" rendered="{!roomTypeLst.size > 0}" id="roomTypeSelectId" html-multiple="multiple">
    <!-- 2019/2/15 ルームインジケータの部屋タイプ絞り込み機能を、タイムテーブルと同じように、複数タイプ指定できるようにして欲しい by cxw END -->
    	<!-- All -->
        <apex:selectOption itemValue="" itemLabel="{!$Label.ps__msg_008_0003}"/>
        <apex:selectOptions value="{!roomTypeLst}" />
        <apex:actionSupport event="onchange" action="{!gotoDate}" reRender="roomIndicator,messageBlock,timetablePanel" status="refStatusBlock"  oncomplete="refreshDS()" rendered="false"/>
    </apex:selectList>
</apex:outputPanel>

<input type="hidden" value="{!rRoomsStatusinfo}" id="rRoomsStatusinfoHid" />
<input type="hidden" value="{!rRoomsStatusColorinfo}" id="rRoomsStatusColorinfoHid" />
<!-- 2017/03/29 レジカード一括印刷対応 BEGIN -->
<input type="hidden" value="{!processDate}" id="processDateHid" />
<!-- 2017/03/29 レジカード一括印刷対応 END -->
<apex:inputHidden value="{!isShowToday}" id="isShowTodayHid"/>
<apex:inputHidden value="{!topLeadIdsHid}" id="topLeadIdsHid"/>
<!-- 2017/12/22 画面フィルター機能追加　by　zy　BEGIN -->
<apex:inputHidden value="{!filterHidRoom}" id="hidFilterRoom"/>
<apex:inputHidden value="{!filteText}" id="hidFilterText"/>
<!-- 2017/12/22 画面フィルター機能追加　by　zy　END -->
<!-- 2020/02/28 ルームインジケータ、タイムテーブル改修対象画面 BY zyz BEGIN -->
<input type="hidden" value="{!confirmChgFlg}" id="hidConfirmFlg" />
<!-- 2020/02/28 ルームインジケータ、タイムテーブル改修対象画面 BY zyz END -->

<!-- 2019/10/15 iPadは陣屋コネクトとして推奨しているモバイル端末であり、iPadでは一切ドラッグ＆ドロップができなくなるのも困りますので、編集モードと閲覧モードの切り替えができる様にお願いします by zy BEGIN -->
<input type="hidden" value="{!mobileReadOnlyFlg}" id="hidMobileReadOnly" />
<!-- 2019/10/15 iPadは陣屋コネクトとして推奨しているモバイル端末であり、iPadでは一切ドラッグ＆ドロップができなくなるのも困りますので、編集モードと閲覧モードの切り替えができる様にお願いします by zy END -->
<!-- 2021/03/05 50001エラー修正 by zy BEGIN-->
<!-- ALL店舗の制限の店舗コード集合-->
<input type="hidden" value="{!limitShopStr}" id="hidLimitShopCode"/>
<!-- 2021/03/05 50001エラー修正 by zy END-->
<!-- BUTTON処理する -->
<apex:pageBlockButtons location="top" >
	<!-- 2019/10/30 ルームインジケータに「自動一括アサイン」ボタンが欲しい by zy BEGIN-->
	<apex:outputPanel style="vertical-align: middle;height:30px;white-space:nowrap">
	<!-- 2019/10/30 ルームインジケータに「自動一括アサイン」ボタンが欲しい by zy END-->
	<!-- 前日 -->		<!-- 今日 -->		<!-- 翌日 -->
	<!-- 2019/09/15 指定日自动记忆機能対応 WGCH BEGIN -->
    <apex:commandButton style="width:90px;" value="{!$Label.ps__msg_008_0004}" action="{!toPrev}" 	reRender="roomIndicator,messagitemcomp,messageBlock,timetablePanel" status="refStatusBlock"  oncomplete="refreshDS();setCheckInDayCookieFun();"  rendered="{!isShowHisFlg}"/>
    <apex:commandButton style="width:90px;" value="{!$Label.ps__msg_008_0005}" action="{!toToday}" reRender="roomIndicator,messagitemcomp,messageBlock,timetablePanel" status="refStatusBlock"  oncomplete="refreshDS();setCheckInDayCookieFun();"  rendered="{!isShowHisFlg}" />
    <apex:commandButton style="width:90px;" value="{!$Label.ps__msg_008_0006}" action="{!toNext}" 	reRender="roomIndicator,messagitemcomp,messageBlock,timetablePanel" status="refStatusBlock"  oncomplete="refreshDS();setCheckInDayCookieFun();"  rendered="{!isShowHisFlg}" />
    <!-- 2019/09/15 指定日自动记忆機能対応 WGCH END -->
    
    <apex:outputPanel id="calendarPanel" rendered="{!isShowHisFlg}" style="display:-moz-inline-box; display:inline-block; min-width:180px;">
    <!-- 指定日 -->
    <apex:outputLabel value="{!$Label.ps__msg_008_0007}" for="gotoDate" styleClass="label" style="font-weight: bold;" />&nbsp;
    <apex:inputField value="{!selectDate.Checkinday__c}" id="gotoDate" style="font-size: 1.2em; width:120px">
        <!-- 2019/09/15 指定日自动记忆機能対応 WGCH BEGIN -->
        <apex:actionSupport event="onchange" onsubmit="clearTop()" action="{!gotoDate}" rerender="roomIndicator,messagitemcomp,messageBlock,timetablePanel" status="refStatusBlock"  oncomplete="refreshDS();setCheckInDayCookieFun();" />
        <!-- 2019/09/15 指定日自动记忆機能対応 WGCH END -->
    </apex:inputField>
    </apex:outputPanel>

    <apex:outputPanel rendered="{!selectDate.Checkinday__c == TODAY()}">
    <!-- 当日の場合、下記２つボタンを表示する -->
    <!-- チェックイン -->
    <apex:commandButton style="width:90px;" value="{!$Label.ps__msg_008_0024}" onclick="isShowTodayFun(true);" action="{!isShowTodayAction}" rendered="{!!isShowToday}"
    	reRender="roomIndicator,messageBlock,timetablePanel" status="refStatusBlock"  oncomplete="refreshDS()" />
    <!-- チェックアウト -->
    <apex:commandButton style="width:90px;" value="{!$Label.ps__msg_008_0025}" onclick="isShowTodayFun(false);" action="{!isShowTodayAction}" rendered="{!isShowToday}"
    	reRender="roomIndicator,messageBlock,timetablePanel" status="refStatusBlock"  oncomplete="refreshDS()" />
	</apex:outputPanel>
    <!-- お客様名、予約名切り替え表示機能 -->
    <span class="assignRoomIsShowPanel" style="margin-left: 2px; height:30px;vertical-align: text-top;">
	<apex:selectList size="1" value="{!roomNameType}" id="roomNameSelect">
    	<apex:selectOptions value="{!roomNameTypeOptions}" />
        <apex:actionSupport event="onchange" action="{!gotoDate}" rerender="roomIndicator" status="refStatusBlock"/>
    </apex:selectList>
	</span>
	<!-- ステータス切り替え表示機能 -->
    <span class="assignRoomIsShowPanel" style="margin-left: 2px; height:30px;vertical-align: text-top;">
	<apex:selectList size="1" value="{!statusCode}" id="statusSelect">
    	<!-- 部屋ｽﾃｰﾀｽ -->
    	<apex:selectOption itemValue="{!constStatusCodeRoom}" itemLabel="{!$Label.ps__msg_008_0117}"/>
    	<!-- 予約ｽﾃｰﾀｽ -->
    	<apex:selectOption itemValue="{!constStatusCodeLead}" itemLabel="{!$Label.ps__msg_008_0118}"/>
        <apex:actionSupport event="onchange" action="{!changeStatusMode}" rerender="roomIndicator" status="refStatusBlock"/>
    </apex:selectList>
	</span>
	<!-- タイムテーブル -->
	<apex:outputPanel rendered="{!!isIncludeMode}">
	<input type="button" value="{!$Label.MSG_008_0041}" class="btn" style="width:90px;" onclick="openBookingInfoWin()"/>
	</apex:outputPanel>
	<!-- 2017/02/21  レジカード一括印刷機能  BEGIN zyz-->
	<apex:outputPanel >
		<input type="button" value="レジカード一括印刷" class="btn" style="width:110px;" onclick="cardPrintWin()"/>
	</apex:outputPanel>
	<!-- 2017/02/21  レジカード一括印刷機能  END zyz -->
	<!-- 2017/09/18  会計一括印刷機能  WGCH BEGIN　-->
	<apex:outputPanel rendered="{!accPrnShowBtnFlg}">
		<!-- ビル一括印刷　-->
		<input type="button" value="{!$Label.MSG_008_0123}" class="btn" style="width:90px;" onclick="openAccountPdfBulkPrint();"/>
	</apex:outputPanel>
	<!-- 2017/09/18 会計一括印刷機能  WGCH END -->
	<!-- 2019/10/30 ルームインジケータに「自動一括アサイン」ボタンが欲しい by zy BEGIN-->
	<input type="button" class="btn" onclick="autoAssignAllRoom()" value="自動一括アサイン"/>
	<!-- 2019/10/30 ルームインジケータに「自動一括アサイン」ボタンが欲しい by zy END-->
	<!-- 2019/11/15 更新ボタンの機能を追加 BY zyz BEGIN -->
	<input type="button" class="btn" id="reloadId" style="width:70px;" value="更新" onclick="reloadFun(this)"/>
	<!-- 2019/11/15 更新ボタンの機能を追加 BY zyz END -->
	</apex:outputPanel>
</apex:pageBlockButtons>
<apex:outputPanel >
<apex:outputPanel id="colorpanel" rendered="{!statusCode != constStatusCodeLead}">
<!-- 空室 --><!-- 割当済 --><!-- 滞在 --><!-- 出発予定 --><!-- 出発 --><!-- 故障 --><!-- 未清掃 -->
<span style="vertical-align: middle; font-weight: bold;">&nbsp;{!$Label.MSG_008_0008}&nbsp;[{!iEmptyStatusSum}]&nbsp;<img src="{!URLFOR($Resource.reportFiles, 'img/blank')}" style=" height: 20px;width:60px;vertical-align:middle; " class="isEmptyStatus"/></span>

<span style="vertical-align: middle; font-weight: bold;">&nbsp;{!$Label.MSG_008_0042}&nbsp;[{!isAssignedStatusSum}]&nbsp;<img src="{!URLFOR($Resource.reportFiles, 'img/blank')}" style=" height: 20px;width:60px;vertical-align:middle; " class="isAssignedStatus_1"/></span>
<!-- 2019/02/28 滞在・外出状態の管理 WGCH BEGIN -->
<!-- 外出中 -->
<span style="vertical-align: middle; font-weight: bold;display:{!IF(outButtonShowFlg, '', 'none;')}">&nbsp;{!$Label.MSG_008_0125}&nbsp;[{!outStatusSum}]&nbsp;<img src="{!URLFOR($Resource.reportFiles, 'img/blank')}" style=" height: 20px;width:60px;vertical-align:middle; " class="isOutStatus"/></span>
<!-- 2019/02/28 滞在・外出状態の管理 WGCH END -->
<span style="vertical-align: middle; font-weight: bold;">&nbsp;{!$Label.MSG_008_0009}&nbsp;[{!isStayStatusSum}]&nbsp;<img src="{!URLFOR($Resource.reportFiles, 'img/blank')}" style=" height: 20px;width:60px;vertical-align:middle; " class="isStayStatus_1"/></span>
<span style="vertical-align: middle; font-weight: bold;">&nbsp;{!$Label.MSG_008_0010}&nbsp;[{!checkOutDayStatusSum}]&nbsp;<img src="{!URLFOR($Resource.reportFiles, 'img/blank')}" style=" height: 20px;width:60px;vertical-align:middle; " class="isChkOutDayStatus"/></span>
<span style="vertical-align: middle; font-weight: bold;">&nbsp;{!$Label.MSG_008_0011}&nbsp;[{!checkOutStatusSum}]&nbsp;<img src="{!URLFOR($Resource.reportFiles, 'img/blank')}" style=" height: 20px;width:60px;vertical-align:middle; " class="isChkOutStatus"/></span>

</apex:outputPanel>

<apex:outputPanel rendered="{!statusCode == constStatusCodeLead}">
	<apex:repeat value="{!leadStatusInfoLst}" var="statusItem">
	<span style="vertical-align: middle; font-weight: bold;">&nbsp;{!statusItem.label}&nbsp;
				<img src="{!URLFOR($Resource.reportFiles, 'img/blank')}"
				style=" height: 20px;width:60px;vertical-align:middle;background-color: {!leadStatusColorMap[statusItem.value].val}"/></span>
	</apex:repeat>
</apex:outputPanel>

<span style="vertical-align: middle; font-weight: bold;">&nbsp;{!$Label.MSG_008_0012}&nbsp;[{!isBadStatusSum}]&nbsp;<img src="{!URLFOR($Resource.reportFiles, 'img/blank')}" style=" height: 20px;width:60px;vertical-align:middle; " class="isBadStatus"/></span>
<!-- 2019/11/15 ルームインジケータの表示について、清掃済だけでなくインスペ完の状況を追加したいです。 by zy BEGIN-->
<span style="vertical-align: middle; font-weight: bold;{!if(headSameCleanStautsFlg,'display:none;','')}">&nbsp;{!$Label.MSG_008_0013}&nbsp;[{!isNoCleanStatusSum}]&nbsp;<img src="{!URLFOR($Resource.reportFiles, 'img/blank')}" style=" height: 20px;width:60px;vertical-align:middle; " class="isCleanStatus"/></span>
<apex:repeat value="{!cleansLst}" var="clean" rendered="{!cleansLst.size > 0}">
    <span style="vertical-align: middle; font-weight: bold;">&nbsp;{!clean.name}&nbsp;<span class="cleanCnt"></span>
                <img class="status_{!clean.name}" src="{!URLFOR($Resource.reportFiles, 'img/blank')}"
                style=" height: 20px;width:60px;vertical-align:middle;"/></span>
</apex:repeat>
<!-- 2019/11/15 ルームインジケータの表示について、清掃済だけでなくインスペ完の状況を追加したいです。 by zy END-->
</apex:outputPanel>
<br></br>
<apex:outputPanel >
<img src="{!URLFOR($Resource.reportFiles, 'img/blank')}" style="height:4px; width: 100%"/>
</apex:outputPanel>

<!-- Message Panel Block -->        
<apex:outputPanel id="ciTableMessagePanel" rendered="{!mainIsShowErr}">
   <apex:pageMessages id="inputLeadFormMsg" rendered="{!!bookingCreateOK}"/>
</apex:outputPanel>
	
<apex:outputPanel id="ciTable" >

<script>
// 画面更新可否判断フラグ
var canRefreshFlag = true;
// 当日のシステム日付を設定する
var JS_SYS_TODAY = "{!TODAY()}";
// 過去の未割り当て予約アサインできる制御フラグ
var JS_SYS_SHOW_HIS_FLG = "{!isShowHisAssignWinFlg}".toLowerCase();
var JS_SYS_DEVICE_MOBILE_FLG = kendo.support.mobileOS || !_g_isCanUpdateFlg;
// 2021/03/31 9914 BUG FIXED by zy BEGIN
var JS_DETAIL_WIN_CONTACT_PREFIX = 'contactDetail_';
// 2021/03/31 9914 BUG FIXED by zy END
// Refresh JsBind
$j(document).ready(function() {
	if(JS_SYS_DEVICE_MOBILE_FLG && _g_isCanUpdateFlg){
		$j("[name=roomstatusBlock]").css("font-size","10px");
		// 2019/10/24 20191021.01.iOS13.1.2以降にバージョンアップすると、ルームインジケータの縦セルに定義した項目が完全に表示されません by zy BEGIN
		$j(".roomExtField>span").contents().unwrap();
		// 2019/10/24 20191021.01.iOS13.1.2以降にバージョンアップすると、ルームインジケータの縦セルに定義した項目が完全に表示されません by zy END
	}
	// 旧暦情報設定を行う
	if({!isShowQreqki}) setQrekiToTilte();
	// 関連BIND再設定を行う
    bindEvent();
    // 2017/02/20 Window Resize Begin
    $j(window).resize(function(){
    	var assignWindow = $j(".noAssignLeadListWindowClass");
    	var resizeLeft = $j(this).width() - assignWindow.width() - 10;
    	assignWindow.css({left:resizeLeft});
    });
    // 2017/02/20 Window Resize End
    // 2019/04/15 ベネフィットホテル様より改善要望 by zy BEGIN
    initProductWin();
    // 2019/04/15 ベネフィットホテル様より改善要望 by zy END
    // 2019/11/15 更新ボタンの機能を追加 BY zyz BEGIN
    initload();
    // 2019/11/15 更新ボタンの機能を追加 BY zyz END
});
// 2017/12/22 画面フィルター機能追加　by　zy　BEGIN
// 过滤信息
// 未确认式样
// 过滤后单击打开画面事件不好用，因为stoprunning，导致与打开页面的规则发生冲突
// 导致页面无法打开
var filterRoomId;
function onKeyUpFilterRow(el){
	// 清空计时器
	if (filterRoomId) clearTimeout(filterRoomId);
	// 无论何时直接结束筛选
	var filterStr = $j("#filterInput").val();
	if (filterStr == "") {
		endFilter();
		return;
	}
	if (filterStr.length == 1) return;
	beforeFilter = filterStr;
	// 过滤开始
	filterRoomId = setTimeout(function(){
		ajaxRefreshFilterRoom(filterStr);
	},300);
}
// 过滤房间
function filterRowRoom(roomArr,filterText){
	var conditions = [];//[{cls:'filterClass',nm:'roomTypeNm',tp:'c',val:filterText},{cls:'filterClass',nm:'leadName',tp:'c',val:filterText}];
	var rowConditions = [];//[{cls:'filterClass',nm:'roomTypeNm',tp:'c',val:filterText},{cls:'filterClass',nm:'leadName',tp:'c',val:filterText}];
	var curtable = $j("#dTable");
	var firstLoadFlag = !curtable.hasClass("hadFilter");
	// 第一次的时候执行
	if (firstLoadFlag) beginFilter();
	clearFilter();
	// 查询到房间
	if (roomArr.length > 0) {
		for (var i = 0 ; i < roomArr.length ; i++) {
			var roomid = roomArr[i];
			conditions.push({cls:'filterClass',nm:'roomId',tp:'eq',val:roomid});
			rowConditions.push({cls:'filterClass',nm:'roomId',tp:'eq',val:roomid});
		}
	/*
	// 未查询到房间过滤自动处理
	} else{
		conditions = [{cls:'filterClass',nm:'roomTypeNm',tp:'c',val:filterText},{cls:'filterClass',nm:'leadName',tp:'c',val:filterText}];
		rowConditions = [{cls:'filterClass',nm:'value',tp:'c',val:filterText},{cls:'filterClass',nm:'roomTypeNm',tp:'c',val:filterText},{cls:'filterClass',nm:'leadName',tp:'c',val:filterText}];
	}*/
		nextFilter(rowConditions,conditions);
		var roomArr = [];
		$j("#dTable td:visible").each(function(){
			var roomid = $j("[roomid]",this).first().attr("roomid");
			if (roomid != "") roomArr.push(roomid);
		});
		$j("input[id$=hidFilterText]").val(filterText);
		$j("input[id$=hidFilterRoom]").val(roomArr.join(','));
	} else $j("#dTable>tbody>tr:visible").hide();
}
// 开始进行筛选
function beginFilter(){
	var curtable = $j("#dTable");
	// 最大高度设定
	// 外侧固定，防止hide的时候串动 BEGIN
	var warpDiv = curtable.closest("div.pbBody");
	if ( !warpDiv.hasClass("regular") ) {
		var maxWidth = warpDiv.width();
		warpDiv.css({"min-width":maxWidth});
		warpDiv.addClass("regular");
		$j("thead.rich-table-thead th").slice(0,2).each(function(){
			$j(this).css({width:$j(this).width()});
		});	
	}
	// 外侧固定，防止hide的时候串动 END
	$j("#dTable").addClass("hadFilter");
	$j("#dTable").css("width","auto");
}
// 执行筛选条件
function nextFilter(rowConditions,conditions){
	// 筛选行
	filterTable($j("#dTable>tbody>tr:visible"),rowConditions);
	// 筛选格
	filterTable($j("#dTable tr:visible"),conditions,'td:not(.onShow)');
	// 筛选后特殊处理
	var talbeFilter = $j("#dTable tr:visible td:not(.onShow)");
	// 空格去掉
	talbeFilter.find("div.roomblock[roomid='']").closest("td").hide();
	// 点击显示详细信息页面回复
	$j("div[name='roomstatusBlock']",talbeFilter).addClass("filtered");
}
// 筛选数据
function filterTable(elements,conditions,chdSelector) {
	var rowSelectorArr = [];
	for (var i = 0 ; i < conditions.length ; i++) {
		var condition = conditions[i];
		rowSelectorArr.push(condition);
	}
	var hasSelector = getSelector(rowSelectorArr);
	var notSelector = getSelector(hasSelector,true);
	//不存在子过滤
	if (chdSelector == undefined || chdSelector == null) {
		var hasSelectElement = elements.filter(hasSelector);
		if (hasSelectElement.length > 0) elements.filter(notSelector).hide();
		hasSelectElement.show();
	} else {
		// 逐行检索
		elements.each(function(){
			var hasSelectElement = $j(chdSelector,this).filter(hasSelector);
			if (hasSelectElement.length > 0) $j(chdSelector,this).filter(notSelector).hide();
			hasSelectElement.show();
		});
	}
}
// 清空内容
function clearFilter(){
	var talbeRows = $j("#dTable tbody tr");
	talbeRows.removeClass("filteredRow");
	talbeRows.show();
	$j("td",talbeRows).show();
	$j("input[id$=hidFilterRoom]").val("");
	$j("input[id$=hidFilterText]").val("");
}
// 结束筛选
function endFilter(){
	clearFilter();
	$j(".filtered").removeClass("filtered");
	$j("#dTable").css("width","100%");
	$j("#dTable").removeClass("hadFilter");
}
// 根据给定信息编辑过滤字段
function getSelector(arr,isNotFlag){
	var exportSelector = '';
	if (typeof arr == 'object') {
		var selectorArr = [];
		for (var i = 0 ; i < arr.length ; i++ ) {
			var obj = arr[i];
			var selector = '';
			if ("cls" in obj) selector += '.' + obj.cls;
			if ("nm" in obj) selector += '[' + obj.nm ;
			if ("tp" in obj) {
				if (obj.tp == 'c') selector += '*="';
				else if (obj.tp == 'eq') selector += '="';
				else if (obj.tp == 'bg') selector += '^="';
				else if (obj.tp == 'ed') selector += '$="';
			}
			if ("val" in obj) selector += obj.val + '"]';
			selectorArr.push(selector);
		}
		if (selectorArr.length > 0) {
			exportSelector = ':has(' + selectorArr.join(',') + ')';
		}
	} else if (typeof arr == 'string') exportSelector = arr;
	
	if (isNotFlag) return  ':not(' + exportSelector + ')';
			else return exportSelector;
	return '';
}
// 2017/12/22 画面フィルター機能追加　by　zy　END
// 2019/11/15 更新ボタンの機能を追加 BY zyz BEGIN
function initload(){
	var _JS_SYS_DEVICE_MOBILE = kendo.support.mobileOS;
	if(_JS_SYS_DEVICE_MOBILE) return ;
	$j("#reloadId").css({'display':'none'});
}
function reloadFun(e){
	if (isCanRunning()) {
		stopRunning();
		refreshRoomAndMessage();
	}
	e.preventDefault();
}
// 2019/11/15 更新ボタンの機能を追加 BY zyz END
</script>
    <table id="dTable" class="list" border="0" cellpadding="0" cellspacing="0" style="{!if(ISBLANK(filteText) || filteText == '' ,'','width:auto;')}">
        <thead class="rich-table-thead">
        <tr class="headerRow" >
            <th class="headerRow" nowrap="nowrap" style="font-size: 13px;">
            	<!-- 場所 -->
                <apex:outputText value="{!$Label.ps__msg_008_0014}"/>
            </th>
            <th class="headerRow" nowrap="nowrap" style="font-size: 13px;">
            	<!-- フロア -->
                <apex:outputText value="{!$Label.ps__msg_008_0015}"/>
            </th>
            <th colspan="{!(maxRooms)}" style="font-size: 13px;text-align: left;position: relative;" id="gotoDateLbTh">
            	<input type="text" id="filterInput"  value="{!filteText}" style="position:relative;top:1px;left:1px; width:480px;height: 20px;" placeholder="{!$Label.MSG_008_0124}" onkeyup="onKeyUpFilterRow(this)" onfocus="javascript:stopRunning()" onblur="javascript:startRunning();" class="k-textbox"/>
            	<img id="loadIcon" style="position: relative; top: 3px;height:14px;display:none;" src="../img/loading.gif"/>
            	<!-- 客室 -->
            	<span id="gotoDateLB" style="display: none;" >{!$Label.MSG_008_0016} [<span id="showCalendarInfo">{!strProcessDate}</span> <span style="color: {!rRoomsStaProcessColorinfo}">{!rRoomsStaProcessinfo}</span>]</span>
            </th>
        </tr>
        </thead>

        <tbody>
        <apex:repeat var="area" value="{!areaInfLst}">
        <apex:repeat var="floor" value="{!area.floorRoomLst}">
        <tr class="{!floor.cssClass}">
            <td class="dataCell onShow" nowrap="nowrap">
                <input type="button" value="{!area.areaName}" style="{!IF(area.areaName == '', 'display:none','')}" class="filterClass btn {!IF(area.areaName == '','', 'honkanBtn')}" onclick="javascript:roomCleanShow(this,'{!JSENCODE(area.areaName)}')"/>
            </td> 
            <td class="dataCell onShow" nowrap="nowrap">
                <input type="button" value="{!floor.floorName}" style="{!IF(floor.floorName == '', 'display:none','')}" class="filterClass btn {!IF(floor.floorName == '','', 'honkanBtn')}" onclick="javascript:roomCleanShow(this,'{!JSENCODE(area.areaName)}','{!JSENCODE(floor.floorName)}')"/>
            </td>
            <apex:repeat var="room" value="{!floor.roomLst}">
            	
            	<apex:variable var="lookupSobjectId" value="{!IF(roomNameType == TEXT(ROOM_INFO_NAME_TYPE_GUESTNAME), room.leadDetail.Relcontact__c, room.leadDetail.Id)}" />
            	<apex:variable var="lookupsId" value="{!IF(roomNameType == TEXT(ROOM_INFO_NAME_TYPE_GUESTNAME), 'room_' + room.leadDetail.Relcontact__c, 'lead_' + room.leadDetail.Id)}" />
				<td valign="top" class="{!room.filterClass}">
				<!-- Room Info Block -->
				<!-- 2018/07/27 宿泊税計算 WGCH BEGIN -->
				<div id="container" name="roomstatusBlock" roomspcd="{!room.sobj.ShopInfoRef__r.ShopCode__c}" roomId="{!room.sobj.id}" roomTypeId="{!room.sobj.TypeRoomRef__c}" roomTypeNm="{!room.sobj.TypeRoomRef__r.Name}"
						leadId="{!room.leadId}" class="filterClass {!if(room.isCanClick, if(room.isCanMove, 'roomcanmove', ''), 'roomblock')} {!if(room.isUnClean, 'isCanContextMenu', '')}"
                        isBlocked="{!room.isBlocked}" times="{!IF(room.sobj.id != null, roomTimesMap[room.sobj.Id], '')}"  leadName='{!room.leadDetail.Name}'
                        leadIndexId="{!room.leadDetail.LeadIndexRef__c}" data-class="{!room.cssClass}"
                        style="display: {!if(room.sobj.id != null, 'true', 'none')}; {!if(room.isCanClick || room.isUnClean, 'cursor:pointer;', '')};" >
				<!-- 2018/07/27 宿泊税計算 WGCH END -->
                	<!-- 
                	<div class="triangle-topright" roomId="{!room.sobj.id}" title="予約件数:{!room.leadsCount}件"
                        style="display: {!if(room.leadsCount>1,'true','none')};">  
                    	{!room.leadsCount}
                    </div>
				   <span class="floatLeftImg" style="{!IF(room.isBlocked, 'display: block', 'display: none')};" >
				   <img src="{!URLFOR($Resource.AppImages, 'extend/lock.ico')}" class="leftBlockImg" title="ブロッキング" style="border: none;width:14px;height:14px "></img>
				   </span>
                 	<div id="iconheader">
                 		<img src="/s.gif" class="addNewEventIcon" name="{!room.sobj.id}"/>
                 	</div>
                 	 -->
                 	<div id="iconheader">
                    	<div class="floatLeftImg" style="{!IF(room.isBlocked, 'display: block', 'display: none')};" >
                    	<!-- ブロッキング -->
				   		<img src="{!URLFOR($Resource.AppImages, 'extend/lock.ico')}" class="leftBlockImg" title="{!$Label.MSG_008_0043}" style="border: none;width:14px;height:14px "></img>
                 		</div>
						<div class="floatLeftImg" style="{!IF(isCanUpdateLead,'','display:none')}">
						<!-- 新規予約 -->
                 		<img src="/s.gif" class="addNewEventIcon" name="{!room.sobj.id}" title="{!$Label.MSG_008_0044}" style="border: none;width: 14px;height: 14px;"  />
                 		</div>
                 		<!-- 2017/12/21 レジカードにサインしたのがルームインジケータでわかるように改善対応 zyz BEGIN -->
                 		<div  class="floatLeftImg" style="{!IF((room.isYadoStr =='true'), 'display: block', 'display: none')};">
                 		<!-- レジカード署名済 -->
                 		<img src="/img/func_icons/util/checkmark16.gif" class="leftBlockImg" title="署名済" style="border: none;width:14px;height:14px "></img>
                 		</div>
                 		<div  class="floatLeftImg" style="{!IF((room.isYadoStr =='false'), 'display: block', 'display: none')};">
                 		<!-- レジカード未署名 -->
                 		<img src="/img/icon/custom51_100/pencil16.png" class="leftBlockImg" title="未署名" style="border: none;width:12px;height:12px "></img>
                 		</div>
                 		<!-- 2017/12/21 レジカードにサインしたのがルームインジケータでわかるように改善対応 zyz END -->
                 		<div  class="floatLeftImg" style="{!IF(room.isDayUseFlg, 'display: block', 'display: none')};" >
                 		<!-- 昼 -->
                 		<img src="{!$Resource.Day}" class="leftBlockImg" title="{!$Label.MSG_008_0045}" style="border: none;width:14px;height:14px "></img>
                 		</div>
                 		<!-- 印刷済み標識 TODO-->
                 		<div  class="floatLeftImg" style="{!IF(room.isAccountedFlg, 'display: block', 'display: none')};" >
                 		<!-- 印刷済 -->
                 		<img src="{!$Resource.printicon}" class="leftBlockImg" title="{!$Label.MSG_008_0046}" style="border: none;width:14px;height:14px "></img>
                 		</div>
                 		<!-- 予約件数 -->		<!-- 件 -->
                 		<div class="triangle-topright" roomId="{!room.sobj.id}" title="{!$Label.MSG_008_0047}:{!room.leadsCount}{!$Label.MSG_008_0048}"
                        style="display: {!if(room.leadsCount>1,'true',if(room.isBadRoom,'true','none'))};">
                    	{!room.leadsCount}
                    	</div>
                    	<!-- 2019/12/30 小部屋の作成 BY zyz BEGIN -->
                    	<!-- 2020/02/29 小部屋機能改善 BY zyz BEGIN -->
                    	<div class="floatLeftImg" style="{!IF((room.leadId != null && room.leadId !='' && smallRoomFlg && room.isRoomFlg), 'display: block', 'display: none')};">
                    	<!--<img src="/img/icon/bank32.png" title="{!IF(room.isSmallRoomFlg,'小部屋データ作成済','小部屋作成する')}" onclick="leadStayNightFun(this,'{!room.leadId}','{!room.sobj.Id}','{!room.leadDetail.LeadIndexRef__c}','{!room.leadDetail.EntryTime__c}');" class="addNewRoomIcon" style="height: 14px;width: 14px; background-repeat: no-repeat;filter:{!IF(room.isSmallRoomFlg,'grayscale(100%)','')}"/>-->
                    	<img name="roomImgOnName" src="{!URLFOR($Resource.AppImages, 'extend/SmallRoom1.png')}" title="小部屋作成する" onclick="leadStayNightFun(this,'{!room.leadId}','{!room.sobj.Id}','{!room.leadDetail.LeadIndexRef__c}','{!room.leadDetail.EntryTime__c}','{!room.roomTypeCode}');" class="addNewRoomIcon" style="height: 14px;width: 14px; background-repeat: no-repeat;display:{!IF(room.isSmallRoomFlg,'none','')}"/>
                    	<img name="roomImgOffName" src="{!URLFOR($Resource.AppImages, 'extend/SmallRoom2.png')}" title="小部屋データ作成済" onclick="leadStayNightFun(this,'{!room.leadId}','{!room.sobj.Id}','{!room.leadDetail.LeadIndexRef__c}','{!room.leadDetail.EntryTime__c}','{!room.roomTypeCode}');" class="addNewRoomIcon" style="height: 14px;width: 14px; background-repeat: no-repeat;display:{!IF(room.isSmallRoomFlg,'','none')}"/>
                    	<!-- 2020/02/29 小部屋機能改善 BY zyz END -->
                    	</div>
                    	<!-- 2019/12/30 小部屋の作成 BY zyz END -->			            		
                 	</div>
                 	<!-- ROOM NAME -->
		    	   <!-- 2019/11/15 ルームインジケータの表示について、清掃済だけでなくインスペ完の状況を追加したいです。 by zy BEGIN-->
				   <div id="header" class="{!if(room.isUnClean, 'isCleanStatus', '')} {!if (room.status == null , '' , 'status_' + room.status)}" style="position:relative;">
				   <!-- 2019/11/15 ルームインジケータの表示について、清掃済だけでなくインスペ完の状況を追加したいです。 by zy END-->
				   {!room.sobj.Name}
				   </div>
				   <div id="midbody" >
				   
				   <span style="display: none;">
				   <input type="checkbox" id="mid_cleanRoomId" value="{!room.sobj.Id}" 
				   	attrAreaName="{!area.areaName}" attrFloorName="{!floor.floorName}" roomName="{room.simpleGuestNm}"
				   	attrIsNoClean="{!room.isUnClean}" style="vertical-align:top;"/>
				   </span>
				   <span id="mid_roomTypeName">{!room.sobj.TypeRoomRef__r.Name}</span>
				   </div>
				   <div id="foot" title="{!room.guestName}" class="{!room.cssClass}" style="vertical-align: middle;position:relative;{!room.leadStatusStyle}"
                        isBlocked="{!room.isBlocked}" startTime="{!room.startTime}" endTime="{!room.endTime}" roomNm="{!room.sobj.Name}" contactId = "{!room.leadDetail.Relcontact__c}"
				   		roomId="{!room.sobj.id}" roomtypeuid="{!room.sobj.TypeRoomRef__c}" roomTypeUnm="{!room.sobj.TypeRoomRef__r.Name}" leadUid="{!room.leadId}" 
				   		>
				   		{!room.simpleGuestNm}
					</div>
				   	<div id="foot2" title="{!room.stayPersonHelp1} {!room.stayPersonHelp2}" 
				   		style="white-space:nowrap;
								   display: {!if(room.leadDetail.id != null && isShowStayPerson, 'true', 'none')};">
				   		<!-- 名 -->
						<apex:outputtext value="{0,number,###}{!$Label.ps__msg_008_0049} ({1,number,###},{2,number,###}" >
					      <apex:param value="{!NULLVALUE(room.leadDetail.StayPersons__c, 0)}" />
					      <apex:param value="{!NULLVALUE(room.leadDetail.Mans__c, 0)}"  />
					      <apex:param value="{!NULLVALUE(room.leadDetail.Femails__c, 0)}"  />
						</apex:outputtext>
						<apex:outputtext value=",{0,number,###}" rendered="{!(room.childrens > 0)}">
					      <apex:param value="{!NULLVALUE(room.childrens, 0)}" />
						</apex:outputtext>
						<apex:outputtext value=")" />
				   	</div>
				   	<!-- 2017/08/17 ルームインジケータ画面に、縦セルに表示項目をカスタマイズできるように改善対応 WGCH BEGIN -->
                    <apex:repeat var="roomExtField" value="{!roomExtLeadFieldApiLst}">
						<!-- 2019/10/24 20191021.01.iOS13.1.2以降にバージョンアップすると、ルームインジケータの縦セルに定義した項目が完全に表示されません by zy BEGIN -->
	                    <div id="foot" class="roomExtField" title="{!room.leadDetail[roomExtField]}" style="white-space:nowrap;display: {!if(ISBLANK(room.leadDetail[roomExtField]), 'none', 'true')};">
						<!-- 2019/10/24 20191021.01.iOS13.1.2以降にバージョンアップすると、ルームインジケータの縦セルに定義した項目が完全に表示されません by zy END-->  
							<apex:outputField value="{!room.leadDetail[roomExtField]}"/>
	                    </div>
                    </apex:repeat>
                    <!-- 2017/08/17 ルームインジケータ画面に、縦セルに表示項目をカスタマイズできるように改善対応 WGCH END -->
				   	<div class="blackCream" isBlocked="{!room.isBlocked}" title="{!room.guestName} {!room.stayPersonHelp1} {!room.stayPersonHelp2}" leadUid="{!room.leadId}">
				   		<div class="{!room.cssClass}" id="blackCreamBlock"
				   		isBlocked="{!room.isBlocked}" startTime="{!room.startTime}" endTime="{!room.endTime}" roomNm="{!room.sobj.Name}"
				   		roomId="{!room.sobj.id}" roomtypeuid="{!room.sobj.TypeRoomRef__c}" roomTypeUnm="{!room.sobj.TypeRoomRef__r.Name}" leadUid="{!room.leadId}"
				   		leadIndexId="{!room.leadDetail.LeadIndexRef__c}" contactId = "{!room.leadDetail.Relcontact__c}"
				   		style="vertical-align: middle;font-size: smaller;position:relative;visibility: hidden;display: none;" >
				   		{!room.simpleGuestNm}</div>
				   	</div>

				</div>
				</td>
            </apex:repeat>
            <!-- 2018/05/10 レスバンス15M超出修正　by　zy BEGIN -->
            <apex:repeat var="room" value="{!floor.blankSize}">
            	<td class="{!IF(filterHidRoom == '','','filteredRow')}"></td>
            </apex:repeat>
            <!-- 2018/05/10 レスバンス15M超出修正　by　zy END -->
        </tr>
        </apex:repeat>
        </apex:repeat>
        </tbody>
    </table>

</apex:outputPanel>
</apex:pageBlock>
</apex:form>
<!-- XML___wgch 2016/11/16 BEGIN --> 
<div id="myPanel" style="display: none;width:{!widthPx}px;" >
<!-- XML___wgch 2016/11/16 END --> 
  <div class="hd">
  	<!-- 部屋詳細情報 -->
    <apex:outputText value="{!$Label.ps__msg_008_0017}" />
  </div>

	<apex:outputPanel layout="block" styleClass="bd" >
		<apex:form >
			<!-- 2017/12/22 画面フィルター機能追加　by　zy　BEGIN -->
			<apex:inputHidden value="{!filterHidRoom}" id="hidFilterRoom"/>
			<apex:inputHidden value="{!filteText}" id="hidFilterText"/>
			<!-- 2017/12/22 画面フィルター機能追加　by　zy　END -->
		<!-- <div style="overflow: auto;height:400px;">  -->
		<div style="overflow: auto;" id ='myPanel_Div' >
		<!-- ORG VALUE HIDDEN SAVE --> 
		<apex:inputHidden value="{!leadInfo.orgLeadPeopleNum}" id="bHidPeopleNumId"/>
		<apex:inputHidden value="{!leadInfo.orgNights}" id="bHidNightId"/>
		<apex:inputHidden value="{!leadInfo.leadRoomId}" id="bHidRoomId"/>
		<apex:inputHidden value="{!leadInfo.entryTime}" id="bHidEntryTime" />
		<apex:inputHidden value="{!leadInfo.departureTime}" id="bHidDepartureTime" />
		<!-- XML___wgch 2016/11/16 BEGIN -->
		<apex:inputHidden value="{!leadInfo.Comment3}" id="bHidComment3" />
		<apex:inputHidden id="leadIdHidden" value="{!strLeadId}" /> 
		<apex:inputHidden id="accIdHidden"  value="{!leadInfo.accountId}"/>
		<apex:inputHidden id="leadStatusHidden" value="{!leadInfo.customStatus}" />
		<!-- XML___wgch 2016/11/16 END --> 
		<apex:inputHidden id="bHidGroupLeadId" value="{!groupLeadIds}"  />
		<!-- XML___wgch 2016/11/16 BEGIN -->
		<apex:inputHidden id="bHidLeadIndexId" value="{!leadInfo.leadIndexId}"/>
		<!-- XML___wgch 2016/11/16 END -->
		<apex:inputHidden id="bHidGroupFlg" value="{!isGroupFlg}" />
		<!-- XML___wgch 2016/11/16 BEGIN -->
		<apex:inputHidden id="bHidLeadFields" value="{!leadFields}" />
		<apex:inputHidden id="bHidContactFields" value="{!contactFields}" />
		<apex:inputHidden id="mapLeadPingFieldId" value="{!mapleadPingField}" />
		<apex:inputHidden id="hidContact" value="{!hadUpdContactFlag}"/>
		<apex:inputHidden id="hidContactMapFields" value="{!contactMapFields}"/>
		<!-- 2020/02/29 レジカードのロゴを出力した部屋の「店舗情報」対応 BY zyz BEGIN -->
		<input type="hidden" value="{!shopLst}" id="hidshopLstId"/>
		<!-- 2020/02/29 レジカードのロゴを出力した部屋の「店舗情報」対応 BY zyz END -->
		
		<!-- XML___wgch 2016/11/16 END -->
		<!-- 2017/05/12 部屋詳細情報画面レジカード機能対応 zyz BEGIN -->
		<apex:inputHidden id="yadoIdHidden"  value="{!leadInfo.yadoId}"/>
		<!-- 2017/05/12 部屋詳細情報画面レジカード機能対応 zyz END -->
		<!-- 泊数変更機能(ActionFunction) -->
		<apex:actionFunction name="chgSaveNightsInfoFun" rerender="roomIndicator,leadDetailWinMsgPanel" 
			action="{!chgSaveNightsInfo}" 
			oncomplete="bookingCreateCallBack();unblockUi();" />
	        
		<apex:pageBlock id="dblock">
		
		<!-- Message Panel Block -->        
		<apex:outputPanel id="leadDetailWinMsgPanel">
		  <apex:pageMessages id="inputFormMsg"/>
		  <apex:inputHidden value="{!bookingCreateOK}" id="hidDataCreateOK"/><!-- Hidden:Data Create IS OK -->
		</apex:outputPanel>
		
<!-- XML___wgch 2016/11/16 BEGIN  -->
          <apex:pageBlockSection columns="1">
          	<!-- 予約番号 -->
			<apex:pageBlockSectionItem >
				<apex:outputLabel value="{!$Label.ps__msg_008_0051}" />
				<apex:outputText id="bLeadIndexNo" />
			</apex:pageBlockSectionItem>
			<!-- 予約名 -->
			<apex:pageBlockSectionItem >
				<apex:outputLabel value="{!$Label.ps__msg_008_0052}" />
		       	<apex:outputText id="bname" value="{!RoomDetail.leadDetail.name}" />
          	</apex:pageBlockSectionItem>
          	<!-- お客様 -->
			<apex:pageBlockSectionItem >
				<apex:outputLabel value="{!$Label.ps__msg_008_0018}" />
				<apex:outputText id="bContactRef" />
			</apex:pageBlockSectionItem>
          	<apex:outputField id="bField298__c"    value="{!RoomDetail.leadDetail.Field298__c}"/>

          	<apex:pageBlockSectionItem >
          		<apex:outputLabel value="{!$ObjectType.Lead__c.Fields.EntryTime__c.Label}" />
          		<apex:outputPanel >
	           	<table >
            	<tr >
                    <td style="vertical-align: middle">
                    <apex:outputText id="bEntryTime__c" />&nbsp;&nbsp;<apex:outputText id="bField4__c" />
					</td>
                    <td style="vertical-align: middle" class="timeChangeTd">→</td>
                    <td style="vertical-align: middle" class="timeChangeTd">
                        <apex:inputField id="bInputField4__c" value="{!RoomDetail.leadDetail.Field4__c}" />
                    </td>
                </tr>
                </table>
	          	</apex:outputPanel>
			</apex:pageBlockSectionItem>
			<apex:pageBlockSectionItem >
				<apex:outputLabel value="{!$ObjectType.Lead__c.Fields.Departure__c.Label}" />
				<apex:outputPanel >
	           	<table >
            	<tr >
                    <td style="vertical-align: middle">
                    <apex:outputText id="bDepartureDate__c" />&nbsp;&nbsp;<apex:outputText id="bDepartureTime__c" />
					</td>
                    <td style="vertical-align: middle" class="timeChangeTd">→</td>
                    <td style="vertical-align: middle" class="timeChangeTd">
                        <apex:inputField id="bInputField3__c" value="{!RoomDetail.leadDetail.Field3__c}"/>
                    </td>
                </tr>
                </table>
            	</apex:outputPanel>
            </apex:pageBlockSectionItem>
			<apex:pageBlockSectionItem >
				<!-- 泊数 -->
				<apex:outputLabel value="{!$Label.ps__msg_008_0053}" />
				<apex:outputLabel >
	           	<table >
            	<tr >
                    <td style="vertical-align: middle"><apex:outputText id="bNights" /></td>
                    <td style="vertical-align: middle" class="roomChangeTd">→</td>
                    <td style="vertical-align: middle" class="roomChangeTd">
                        <apex:inputText value="{!leadInfo.nights}" id="bInputNights" 
                        				style="width:40px;font-size: 14px;" 
                        				onchange="setDepartureDateAuto()"/>
                    </td>
                </tr>
                </table>
				</apex:outputLabel>
			</apex:pageBlockSectionItem>
			
			<apex:pageBlockSectionItem >
				<apex:outputLabel value="{!$ObjectType.Lead__c.Fields.StayPersons__c.Label}" />
				<apex:outputLabel >
	           	<table >
            	<tr >
                    <td style="vertical-align: middle"><apex:outputText id="bStayPersons__c" /></td>
                    <td style="vertical-align: middle" class="roomChangeTd">→</td>
                    <td style="vertical-align: middle" class="roomChangeTd">
                        <apex:inputText value="{!leadInfo.leadPeopleNum}" id="bInputStayPersons" 
                        				style="width:40px;font-size: 14px;"
                        				onchange="chkStayPersons()"/>
                    </td>
                </tr>
                </table>
				</apex:outputLabel>
			</apex:pageBlockSectionItem>
            
            <apex:pageBlockSectionItem >
            	<!-- 予約チャネル -->
            	<apex:outputLabel value="{!$Label.ps__msg_008_0019}" />
            	<apex:outputField id="bField2__c" value="{!RoomDetail.leadDetail.Field2__c}" />
            </apex:pageBlockSectionItem>

            <apex:outputField id="bplaninfo"    value="{!RoomDetail.leadDetail.Field310__c}" />
            <apex:pageBlockSectionItem labelStyle="vertical-align: middle;">
            	<!-- 部屋 -->
				<apex:outputLabel value="{!$Label.ps__msg_008_0020}" />
				<!-- ルーム・チェンジ -->
				<apex:outputText id="bRroom__c" />
            </apex:pageBlockSectionItem>
          </apex:pageBlockSection>
          <!-- 2016/11/24　カスタム画面追加　BEGIN -->
		  <apex:repeat value="{!pageLst}" var="p"> 
		  	<apex:inputHidden id="bcolumnsInt" value="{!p.columnsInt}"/>
			<apex:pageBlockSection columns="{!p.columnsInt}" title="{!p.title}" showHeader="{!p.isHeadShowFlag}" Id="sobjectMap">
				<apex:repeat value="{!p.fieldLst}" var="fieldNm"> 
					<apex:pageBlockSectionItem rendered="{!fieldTypeMap[fieldNm] == 'lead'}" dataStyleClass="lead_{!pathToFieldMap[fieldNm]} {!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
						<apex:outputLabel value="{!fieldLabelMap[fieldNm]}"/><!-- {!fieldLabelMap[fieldNm]} -->
						<apex:outputField value="{!newLead[pathToFieldMap[fieldNm]]}"  id="showColumn" />
					</apex:pageBlockSectionItem>
					<!-- 2021/03/31 9914 BUG FIXED by zy BEGIN -->
					<apex:pageBlockSectionItem rendered="{!fieldTypeMap[fieldNm] == 'contact'}" dataStyleClass="contactDetail_{!pathToFieldMap[fieldNm]} {!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
					<!-- 2021/03/31 9914 BUG FIXED by zy END -->
						<apex:outputLabel value="{!fieldLabelMap[fieldNm]}"/><!-- {!fieldLabelMap[fieldNm]} -->
						<apex:outputpanel >
							<apex:outputField value="{!newContact[pathToFieldMap[fieldNm]]}" id="showColumn" />
							<apex:inputField value="{!newContact[pathToFieldMap[fieldNm]]}" id="editColumn" />
						</apex:outputpanel>
					</apex:pageBlockSectionItem>
					<apex:pageBlockSectionItem rendered="{!fieldTypeMap[fieldNm] == 'blank'}" dataStyle="height: {!IF(isLineHeightFlg,'12px;','13px;')}">
                    	<apex:outputLabel value=""/>
                    </apex:pageBlockSectionItem>
				</apex:repeat>
			</apex:pageBlockSection>
		</apex:repeat>
		 <!-- 2016/11/24　カスタム画面追加　END -->
		<!-- 特記事項 -->
		<apex:pageBlockSection columns="1" id="CommentSection">
            <apex:pageBlockSectionItem >
                <apex:outputLabel value="{!$ObjectType.Lead__c.Fields.Comment3__c.Label}" />
    			<apex:outputpanel >
    				<apex:outputField id="bComment3__c" value="{!RoomDetail.leadDetail.Comment3__c}" styleClass="TextAreaTd"/>
                    <div id="chgMemoEditor" class="ckeditorClass2"></div>
    			</apex:outputpanel>
            </apex:pageBlockSectionItem>
		</apex:pageBlockSection>
<!--XML___wgch 2016/11/16 END -->			
	</apex:pageBlock>
		      </div>
			  <div style="text-align: right;margin-top: 5px" >
			  <!-- 清掃済 -->
	  	<input type="button" value="{!$Label.MSG_008_0054}" id="cleanRoomBtn" style="width: 100px;{!IF(isCanUpdateLead,'','display:none')}" class="btn" onclick="roomCleanAct(this,{!isShowGroupConfirm})"/>
        		<!-- 2019/05/30 こちらをルームインジケータ上からも1日単位の作成、削除（削除だけでもほしい）by zy BEGIN -->
				<!-- 故障解除 -->
        		<input type="button" value="故障解除" id="badRoomRemoveBtn" onclick="removeBadRoom()" style="width: 100px;{!IF(isCanUpdateLead,'','display:none')}" class="btn"/>
				<!-- 2019/05/30 こちらをルームインジケータ上からも1日単位の作成、削除（削除だけでもほしい）by zy END -->    
	    <!-- 変更 -->
	    <input type="button" value="{!$Label.MSG_008_0055}" id="chgNightsBtn" style="width: 100px;{!IF(isCanUpdateLead,'','display:none')}" class="btn"/>
	    <!-- 保存 -->
	    <input type="button" value="{!$Label.MSG_008_0056}" id="chgNightsSaveBtn" style="width: 100px;{!IF(isCanUpdateLead,'','display:none')}" class="btn"/>
		<!-- 2016/11/04 予約キャンセル BEGIN -->
		<!-- 2017/01/05 予約のキャンセルボタンを表示する・しない対応 BEGIN by wx-->
		<apex:outputPanel id="cancelpanel" rendered="{!!roomIndicatorIsShowLeadCancelBtn}">
		<!-- 2017/01/05 予約のキャンセルボタンを表示する・しない対応 END by wx-->
        <input type="button" value="{!$Label.MSG_008_0119}" id=":leadCancelCheckBtn" actKbn="leadCancel" onclick="teamConfig(this,{!isShwoGroupCancelConfirm})" style="width: 100px" class="btn"/>
		<apex:actionFunction name="leadCancel" oncomplete="bookingCreateCallBack();" action="{!leadCancel}" 
           	reRender="roomIndicator,leadDetailWinMsgPanel"  status="refStatusBlock" />   	
        <!-- 2017/01/05 予約のキャンセルボタンを表示する・しない対応 BEGIN by wx-->   		  
		</apex:outputPanel>
		<!-- 2017/01/05 予約のキャンセルボタンを表示する・しない対応 END by wx-->   	
		<!-- 2016/11/04 予約キャンセル END -->
	     <!-- チェックイン -->
	    <input type="button" value="{!$Label.ps__msg_008_0024}" id=":leadCheckInBtn" actKbn="checkin" onclick="teamConfig(this,{!isShowGroupConfirm})" style="width: 100px;{!IF(isCanUpdateLead,'','display:none')}" class="btn"/>
	    <apex:actionFunction name="checkInByRoom" oncomplete="bookingCreateCallBack();" action="{!checkInByRoom}" 
           	reRender="roomIndicator,leadDetailWinMsgPanel"  status="refStatusBlock" />
	    <!-- 
	    <apex:commandButton value="チェックアウト"
	        oncomplete="bookingCreateCallBack();" action="{!checkOutByRoom}" id="leadCheckOutBtn"
	        reRender="roomIndicator,leadDetailWinMsgPanel"  status="refStatusBlock"  style="width: 100px" />
	     -->
	     <!-- チェックアウト -->
	    <input type="button" value="{!$Label.ps__msg_008_0025}" id=":leadCheckOutBtn" actKbn="checkout" onclick="teamConfig(this,{!isShowGroupConfirm})" style="width: 100px;{!IF(isCanUpdateLead,'','display:none')}" class="btn"/>
		<apex:actionFunction name="checkOutByRoom" oncomplete="bookingCreateCallBack();" action="{!checkOutByRoom}" 
           	reRender="roomIndicator,leadDetailWinMsgPanel"  status="refStatusBlock" />
		<!-- 2019/02/28 滞在・外出状態の管理 WGCH BEGIN -->
		<!-- 外出 -->
		<apex:outputPanel id="outpanel" rendered="{!outButtonShowFlg}">
		<!-- 2019/07/15 多泊の場合、外出の場合、多泊の予約に同じ状態を更新する BY zyz BEGIN -->
		<input type="button" value="{!$Label.MSG_008_0126}" id=":leadOutBtn" actKbn="out" onclick="teamConfig(this,{!isShowGroupOIConfirm})" style="width: 100px;{!IF(isCanUpdateLead,'','display:none')}" showFlg="{!outButtonShowFlg}" class="btn"/>
		<!-- 2019/07/15 多泊の場合、外出の場合、多泊の予約に同じ状態を更新する BY zyz END -->
		<apex:actionFunction name="outByRoom" oncomplete="bookingCreateCallBack();" action="{!outByRoom}" 
           	reRender="roomIndicator,leadDetailWinMsgPanel"  status="refStatusBlock" />
		<!-- 戻る -->
		<!-- 2019/07/15 多泊の場合、外出の場合、多泊の予約に同じ状態を更新する BY zyz BEGIN -->
		<input type="button" value="{!$Label.MSG_008_0127}" id=":leadReturnBtn" actKbn="return" onclick="teamConfig(this,{!isShowGroupOIConfirm})" style="width: 100px;{!IF(isCanUpdateLead,'','display:none')}" showFlg="{!outButtonShowFlg}" class="btn"/>
		<!-- 2019/07/15 多泊の場合、外出の場合、多泊の予約に同じ状態を更新する BY zyz END -->
		<apex:actionFunction name="returnByRoom" oncomplete="bookingCreateCallBack();" action="{!returnByRoom}" 
           	reRender="roomIndicator,leadDetailWinMsgPanel"  status="refStatusBlock" />
		</apex:outputPanel>
		<!-- 2019/02/28 滞在・外出状態の管理 WGCH END -->
        <!-- 会計 -->	
	    <input type="button" value="{!$Label.MSG_008_0026}" id="accBtn" class="btn" style="width: 100px;{!IF(isCanUpdateLead,'','display:none')}" onclick="javascript:openAccWindos()"/>
	    <!-- 印刷 -->
	    <input type="button" value="{!$Label.MSG_008_0057}" id="prtBtn" class="btn" style="width: 100px;{!IF(isCanUpdateLead,'','display:none')}" onclick="javascript:openAccPdfs()"/>
        <!-- 2017/05/12 部屋詳細情報画面レジカード機能対応 zyz BEGIN -->
        <!-- レジカード -->
	    <input type="button" value="レジカード" id="cardbtn" onclick="javascript:openyadoPdf()" class="btn" style="width: 100px;display:none;" />
        <!-- 2017/05/12 部屋詳細情報画面レジカード機能対応 zyz END -->
	    <!-- キャンセル -->
	    <input type="button" value="{!$Label.MSG_008_0027}" id="cancelBtn" class="btn" style="width: 100px" />
	  </div>
	</apex:form>

	</apex:outputPanel>
</div>

<!-- isShowTimeTable -->
<apex:outputPanel id="timetablePanel" >
<!-- タイムテーブル情報BLOCK -->
<apex:form id="timetableForm" rendered="{!isShowTimeTable}">
	<!-- 2017/12/22 画面フィルター機能追加　by　zy　BEGIN -->
	<apex:inputHidden value="{!filterHidRoom}" id="hidFilterRoom"/>
	<apex:inputHidden value="{!filteText}" id="hidFilterText"/>
	<!-- 2017/12/22 画面フィルター機能追加　by　zy　END -->
<!-- 時 -->
<apex:pageBlock id="block" title="{!$Label.ps__msg_008_0058}" >
<apex:outputLabel id="messageBlock" >
<!-- 下記予約の出発時刻には到着時刻以降の時刻を設定ください。 -->
<apex:pageMessage summary="{!$Label.ps__msg_008_0059}" 
			severity="error" strength="3" escape="false" rendered="{!LEN(dayInfo.showInfoError)>0}"
			detail="{!dayInfo.showInfoError}"/>
</apex:outputLabel>
<apex:outputPanel >
<!-- 仮予約 -->		<!-- 会場おさえ -->  <!-- 確定 -->  <!-- キャンセルまち -->
<span style="vertical-align: middle; font-weight: bold;">{!$Label.MSG_008_0060}&nbsp;<img src="{!URLFOR($Resource.reportFiles, 'img/blank')}" style=" height: 20px;width:60px;vertical-align:middle; " class="tmpBookinged"/></span>
<span style="vertical-align: middle; font-weight: bold;">&nbsp;{!$Label.MSG_008_0061}&nbsp;<img src="{!URLFOR($Resource.reportFiles, 'img/blank')}" style=" height: 20px;width:60px;vertical-align:middle; " class="partyroomBook"/></span>
<span style="vertical-align: middle; font-weight: bold;">&nbsp;{!$Label.MSG_008_0062}&nbsp;<img src="{!URLFOR($Resource.reportFiles, 'img/blank')}" style=" height: 20px;width:60px;vertical-align:middle; " class="comfirmedStatus"/></span>
<span style="vertical-align: middle; font-weight: bold;">&nbsp;{!$Label.MSG_008_0063}&nbsp;<img src="{!URLFOR($Resource.reportFiles, 'img/blank')}" style=" height: 20px;width:60px;vertical-align:middle; " class="comfirmStatus"/></span>
</apex:outputPanel>
<br></br>
<apex:outputPanel >
<img src="{!URLFOR($Resource.reportFiles, 'img/blank')}" style="height:3px; width: 100%"/>
</apex:outputPanel>
<!-- 明細情報 -->
<apex:outputPanel id="ciTable" >
<table width="98%" style="border:solid 1px #777; background:#FFF; border-radius: 5px;" id="table" cellspacing="0px" cellpadding="0px" class="detailList" >
    <thead>
    
    <tr style="background-color:#F5F5F5; font-weight: bold; height: 20px">
        <td style="width:100px" rowspan="2">
        	<!-- お部屋 -->
            <apex:outputLabel value="{!$Label.ps__msg_008_0064}" styleClass="label" style="margin-left:2px; vertical-align: middle; height:20px; font-size:16px; text-align:center; overflow:hidden;"/>
        </td>
        <apex:repeat value="{!dayInfo.Hours}" var="intHour">
        <td colspan="6"><div style="color:#555; width:60px; margin-left:2px; vertical-align: middle;float:left; vertical-align: middle;">
            <apex:outputLabel value="{!intHour}:00" styleClass="label"/></div></td>
        </apex:repeat>
        <!-- お部屋 -->
        <td style="width:100px"  rowspan="2"><apex:outputLabel value="{!$Label.ps__msg_008_0064}" styleClass="label" style="margin-left:2px; vertical-align: middle; height:20px; font-size:16px; text-align:center; overflow:hidden;"/></td>
    </tr>
    
    <!-- TimeLine ToolTips -->
    <tr style="background-color:#F5F5F5; height: 18px">
    <apex:repeat value="{!dayInfo.headerTimeList}" var="hhmm">
		<td colspan="{!dayInfo.tdColspanInfoMap[hhmm]}" title="{!IF(dayInfo.tdColspanInfoMap[hhmm] > 1, dayInfo.timeTipsMap[hhmm], '')}">
			<span class="{!IF(dayInfo.tdColspanInfoMap[hhmm] > 1, 'ui-icon ui-icon-clock', '')}" >{!IF(dayInfo.tdColspanInfoMap[hhmm] > 1, '', '　')}</span>
		</td>
    </apex:repeat>
	</tr>
    
	</thead>
    <apex:variable var="count" value="{!0}"/>
    <apex:repeat value="{!dayInfo.Room}" var="r">
    <tr>
        <td class="roomNmTd" style="margin-left:2px; vertical-align: middle;border-top:solid 1px #777;border-right:solid 1px #777;font-size:14px; ">
        <a href="javascript:void(0)" class="roomNmLinkCls" style="margin-left: 2px" onclick="window.open('/{!r.id}')" target="_blank" id="{!r.id}" onblur="LookupHoverDetail.getHover('{!r.id}').hide();" onfocus="LookupHoverDetail.getHover('{!r.id}', '/{!r.id}/m?retURL=%2F{!r.id}&isAjaxRequest=1').show();" onmouseout="LookupHoverDetail.getHover('{!r.id}').hide();" onmouseover="LookupHoverDetail.getHover('{!r.id}', '/{!r.id}/m?retURL=%2F{!r.id}&isAjaxRequest=1').show();">
        {!r.name}
        </a>
        <input type="hidden" id="roomId_{!CEILING(count)}" value="{!r.id}" />
        <input type="hidden" id="roomNm_{!CEILING(count)}" value="{!r.name}" />
        <apex:variable var="count" value="{!count+1}"/>
        </td>

        <apex:outputText value="{!dayInfo.roomBookingMap[r.Id].tdHtml}" escape="false"/>

        <td class="roomNmTd" style="margin-left:2px; vertical-align: middle;border-top:solid 1px #777;border-right:solid 1px #777;font-size:14px; ">
        <a href="javascript:void(0)" class="roomNmLinkCls" style="margin-left: 2px" onclick="window.open('/{!r.id}')" target="_blank" id="{!r.id}_r" onblur="LookupHoverDetail.getHover('{!r.id}_r').hide();" onfocus="LookupHoverDetail.getHover('{!r.id}_r', '/{!r.id}/m?retURL=%2F{!r.id}&isAjaxRequest=1').show();" onmouseout="LookupHoverDetail.getHover('{!r.id}_r').hide();" onmouseover="LookupHoverDetail.getHover('{!r.id}_r', '/{!r.id}/m?retURL=%2F{!r.id}&isAjaxRequest=1').show();">
        {!r.name}
        </a>
        </td>
    </tr>
    </apex:repeat>

</table>
</apex:outputPanel>
</apex:pageBlock>
</apex:form>
</apex:outputPanel>


<!-- This is the content of the modal dialog -->
<div id="createLeadPanel" style="display: none; width: 740px" >
  <div class="hd">
  <!-- 新規予約 -->
    <apex:outputText value="{!$Label.ps__msg_008_0065}" />
  </div>
  
  <apex:form id="createForm">
  	<!-- 2017/12/22 画面フィルター機能追加　by　zy　BEGIN -->
	<apex:inputHidden value="{!filterHidRoom}" id="hidFilterRoom"/>
	<apex:inputHidden value="{!filteText}" id="hidFilterText"/>
	<!-- 2017/12/22 画面フィルター機能追加　by　zy　END -->
  <div class="bd" style="height: 540px; overflow: auto;" >
	<!-- Message Panel Block -->        
	<apex:outputPanel id="leadMessagePanel">
		<!-- 2016/10/13 BEGIN by zh--> 
	   <apex:pageMessages id="inputLeadFormMsg"/>
	   <apex:inputHidden value="{!startDays}" id="hidStartDays"/><!-- Hidden:到着日 -->
	   <apex:inputHidden value="{!newLead.Rroom__c}" id="hidRoomId"/>
	   <apex:inputHidden value="{!newLead.refTypeOfRooms__c}" id="hidRoomType"/><!-- Hidden:部屋タイプID -->
	   <div class="message errorM3" id="inputFormErrorMsg" role="alert" style="display:none;">
          	<table border="0" cellpadding="0" cellspacing="0" class="messageTable" style="padding:0px;margin:0px;">
          		<tbody>
          			<tr valign="top">
          				<td><img alt="ERROR" class="msgIcon" src="/s.gif" title="ERROR"/></td>
          				<td class="messageCell">
          					<div class="messageText">
          						<span style="color:#cc0000"><h4>{!$Label.CONST_003_0132}:</h4></span>{!$Label.MSG_003_0105}<br/>
          					</div>
          				</td>
          			</tr>
          			<tr>
          				<td></td>
          				<td></td>
          			</tr>
          		</tbody>
          	</table>
          </div>
          <!-- 2016/10/13 END by zh--> 
	   <apex:inputHidden value="{!bookingCreateOK}" id="lead_hidDataCreateOK"/><!-- Hidden:Data Create IS OK -->
	   <!-- 2016/12/07 ルームインジケータ新規後一画面へ遷移 BEGIN by zh -->
	   <input type="hidden" id="IndexId" value="{!indexId}" />
	   <!-- 2016/12/07 ルームインジケータ新規後一画面へ遷移 END by zh -->
	</apex:outputPanel>
	<!-- input form -->
	<apex:pageBlock id="createPageBlock">
		<!-- 2019/06/15 新規予約を部屋ごとに時間と到着日をデフォルト設定 BY zyz BEGIN -->
		<apex:inputHidden value="{!leadTimeJsons}" id="hidleadTimeJsons" />
		<!-- 2019/06/15 新規予約を部屋ごとに時間と到着日をデフォルト設定 BY zyz END -->
		<!-- 2020/02/29 小部屋機能改善 BY zyz BEGIN -->
		<apex:inputHidden value="{!roomSelectJsonStr}" id="hidroomSelectJsons" />
		<apex:inputHidden value="{!defRoomFlg}" id="hiddefRoomFlg" />
		<!-- 2020/02/29 小部屋機能改善 BY zyz END -->
		<!-- 2017/01/25 新規画面の項目自定義機能　by　zy　BEGIN -->
		<apex:repeat value="{!hadRenderFields}" var="cusField">
		  	<apex:inputHidden id="relcontact" value="{!contactName}" rendered="{!cusField.fieldType == 'relcontact'}"/>
		  	<apex:inputHidden id="refTypeOfRooms" value="{!newLead.refTypeOfRooms__c}" rendered="{!cusField.fieldType == 'refTypeOfRooms'}"/>
		  	<apex:inputHidden id="entryDate" rendered="{!cusField.fieldType == 'entryDate'}" />
			<apex:inputHidden id="departureDate" rendered="{!cusField.fieldType == 'departureDate'}" />
			<apex:inputHidden id="custPhone" value="{!newContact.Phone}" rendered="{!cusField.fieldType == 'custPhone'}" />
			<apex:inputHidden id="stayPerson" value="{!newLead.StayPersons__c}" rendered="{!cusField.fieldType == 'stayPerson'}" />
			<apex:inputHidden id="staysNums" value="{!staysNums}" rendered="{!cusField.fieldType == 'staysNums'}"/>
			<apex:inputHidden id="roomNum"  rendered="{!cusField.fieldType == 'broomNum'}"/> 
			<apex:inputHidden id="katakana"  rendered="{!cusField.fieldType == 'katakana'}"/>
			<apex:inputField id="entryTime" value="{!newLead.Field4__c}" rendered="{!cusField.fieldType == 'entryTime'}" style="display:none"/>
			<apex:inputField id="departureTime" value="{!newLead.Field3__c}" rendered="{!cusField.fieldType == 'departureTime'}" style="display:none"/>
		</apex:repeat>  
		<!-- 2017/11/07 店舗別泊数、到着時刻、出発時刻初期値自動設計できるように改善対応 -->
		<input type="hidden" id="defStaysNums" value="{!staysNums}" />
		<apex:inputHidden value="{!contactInserFields}" id="hidContactInsertField"/>
		<!-- 2016/12/09	zyz	BEGIN -->
		<apex:repeat value="{!newLPg}" var="p"> 
		  	<apex:inputHidden id="bcolumnsInt" value="{!p.columnsInt}"/>
			<apex:pageBlockSection columns="{!p.columnsInt}" title="{!p.title}" showHeader="{!p.isHeadShowFlag}" Id="sobjectMap">
				<apex:repeat value="{!p.cusFields}" var="cusField"> 
					<apex:pageBlockSectionItem rendered="{!cusField.fieldType == 'lead'}" dataStyleClass="lead_{!cusField.localName} {!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
						<apex:outputLabel value="{!cusField.fieldLabel}"/><!-- {!cusField.fieldLabe} -->
						<apex:outputPanel styleClass="requiredInput" layout="block">
							<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
							<!-- 2019/06/15 新規予約を部屋ごとに時間と到着日をデフォルト設定 BY zyz BEGIN -->
							<apex:inputField value="{!newLead[cusField.localName]}" html-element="lead_{!cusField.localName}" style="{!cusField.fieldStyle}" styleClass="{!if(cusField.isRequired,'repuiredClass','')}"  />
							<!-- 2019/06/15 新規予約を部屋ごとに時間と到着日をデフォルト設定 BY zyz END -->
						</apex:outputPanel>
					</apex:pageBlockSectionItem>
					<apex:pageBlockSectionItem rendered="{!cusField.fieldType == 'contact'}" dataStyleClass="contact_{!cusField.name} {!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
						<apex:outputLabel value="{!cusField.fieldLabel}"/><!-- {!cusField.fieldLabe} -->
						<apex:outputpanel styleClass="requiredInput" layout="block">
							<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
							<apex:inputField value="{!newContact[cusField.localName]}" style="{!cusField.fieldStyle}" styleClass="{!if(cusField.isRequired,'repuiredClass','')}"/>
						</apex:outputpanel>
					</apex:pageBlockSectionItem>
					<apex:pageBlockSectionItem rendered="{!cusField.fieldType == 'blank'}" dataStyle="height: {!IF(isLineHeightFlg,'12px;','13px;')}">
                    	<apex:outputLabel value=""/>
                    </apex:pageBlockSectionItem>
                    <apex:pageBlockSectionItem rendered="{!cusField.fieldType == 'ref'}" dataStyleClass="lead_{!cusField.localName} {!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
                    	<apex:outputLabel value="{!cusField.fieldLabel}"/><!-- {!cusField.fieldLabe} -->
						<apex:outputpanel styleClass="requiredInput" layout="block">
							<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
							<apex:outputText value="{!newLead[cusField.localName]}" style="{!cusField.fieldStyle}" />
						</apex:outputpanel>
                    </apex:pageBlockSectionItem>
                    <!--  2017/01/25 新規画面の項目自定義機能　by　zy　END-->
					<apex:pageBlockSectionItem id="relcontactItem" helpText="{!$ObjectType.Contact.Fields.Name1__c.InlineHelpText}" rendered="{!cusField.fieldType == 'relcontact'}" dataStyleClass="{!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}"> 
					<apex:outputLabel value="{!$Label.ps__msg_008_0018}"/>
		            <apex:outputPanel styleClass="requiredInput" layout="block">
					            <apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
		            <!-- INPUT　FIELD　SPAN　SECTION -->
		            <span class="lookupInput">
            		<!-- 2016/10/13 BEGIN by zh-->
				            <apex:inputText id="relcontact" value="{!contactName}" html-placeholder="{!$Label.ps__inf_0002}"  styleClass="{!if(cusField.isRequired,'repuiredClass','')}" style="{!if(ISBLANK(cusField.fieldStyle),'width:200px',cusField.fieldStyle)}" maxlength="80">
	            <!-- 2016/10/13 END by zh-->
				<!-- 2016/12/13 CTI予約 BEGIN by zyz -->
				<apex:inputHidden value="{!ctiContactInf}" id="ctiContactInf"/>
				<!-- 2016/12/13 CTI予約 END by zyz -->
	            <apex:inputHidden value="{!newLead.Relcontact__c}" id="relcontact_lkid"/>
	            <apex:inputHidden id="relcontact_lkold"/>       <!-- PopupWin利用 -->
	            <input type="hidden" id="relcontact_lkid_org" />    <!-- JS判断用 -->
	            <c:AutoCompleteComp objectname="Contact" 
	                additionalfield="{!$Setup.CommDefine__c.AppNS__c}KanaName1__c,{!$Setup.CommDefine__c.AppNS__c}Name1__c,Phone,{!$Setup.CommDefine__c.AppNS__c}CompanyNameCal__c,{!$Setup.CommDefine__c.AppNS__c}Katakana__c"
	                autocomplete_textbox="{!$Component.relcontact}" 
	                showField="{!$Setup.CommDefine__c.AppNS__c}KanaName1__c,{!$Setup.CommDefine__c.AppNS__c}Katakana__c,Phone,{!$Setup.CommDefine__c.AppNS__c}CompanyNameCal__c,Description"
	                maxLenFilter="Description:16"
	                showFieldSeparator=", "
	                jslibnew="true"
	                addFilter="IsDelete__c!=true"
	            />
	            </apex:inputText>
	            <!-- 部屋選択 -->
	            <img title="" onmouseover="this.className = 'lookupIconOn';this.className = 'lookupIconOn';"
	             onmouseout="this.className = 'lookupIcon';this.className = 'lookupIcon';"
	             onfocus="this.className = 'lookupIconOn';"
	             onblur="this.className = 'lookupIcon';"
	             class="lookupIcon" alt="" src="/s.gif" style="cursor: pointer;vertical-align:middle;border: 0px"
	             name="accountPopup" />
			</span>
			</apex:outputPanel>
		</apex:pageBlockSectionItem>
            <!-- 部屋タイプ -->
		            <apex:pageBlockSectionItem id="refTypeOfRoomsItem" rendered="{!cusField.fieldType == 'refTypeOfRooms'}" dataStyleClass="{!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
		                <apex:outputLabel value="{!$Label.ps__msg_008_0066}"/>
		                <apex:outputPanel styleClass="requiredInput" layout="block">
			            	<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
			                <apex:outputText id="refTypeOfRooms" value=""  style="{!cusField.fieldStyle}"/>
		                </apex:outputPanel>
		            </apex:pageBlockSectionItem>
		            <!-- 予約名 -->
		            <apex:pageBlockSectionItem id="leadNameItem" rendered="{!cusField.fieldType == 'leadName'}" dataStyleClass="{!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
		                <apex:outputLabel value="{!$Label.ps__msg_008_0052}"/>
		                <apex:outputPanel styleClass="requiredInput" layout="block">
			            	<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
		                <!-- 2016/10/13 BEGIN by zh-->
		                <apex:inputField id="leadName" value="{!newLead.name}" style="{!if(ISBLANK(cusField.fieldStyle),'width:200px',cusField.fieldStyle)}" styleClass="{!if(cusField.isRequired,'repuiredClass','')}"/>
		                <!-- 2016/10/13 END by zh-->
		                </apex:outputPanel>
		            </apex:pageBlockSectionItem>
		            <!-- $到着日 -->
		            <apex:pageBlockSectionItem id="entryDateItem" rendered="{!cusField.fieldType == 'entryDate'}" dataStyleClass="{!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
		                <apex:outputLabel value="{!$Label.ps__msg_008_0067}"/>
		                <apex:outputPanel styleClass="requiredInput" layout="block">
			            	<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
		                	<apex:outputText id="entryDate" value=""  style="{!cusField.fieldStyle}"/>
		                </apex:outputPanel>
		            </apex:pageBlockSectionItem>
		            <!-- ひらがな -->
					<apex:pageBlockSectionItem helpText="{!$ObjectType.Contact.Fields.Katakana__c.InlineHelpText}" id="katakanaItem" rendered="{!cusField.fieldType == 'katakana'}" dataStyleClass="contact_{!$Setup.CommDefine__c.AppNS__c}Katakana__c {!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
		        		<apex:outputLabel value="{!$ObjectType.Contact.Fields.Katakana__c.label}"/>
		        		<apex:outputPanel styleClass="requiredInput" layout="block">
			            	<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
		        			<apex:inputText id="katakana" value="{!newContact.Katakana__c}"  style="{!cusField.fieldStyle}" styleClass="{!if(cusField.isRequired,'repuiredClass','')}" maxlength="80"/>
		        		</apex:outputPanel>
					</apex:pageBlockSectionItem>
					<!-- 到着時刻 -->
		            <apex:pageBlockSectionItem id="entryTimeItem" rendered="{!cusField.fieldType == 'entryTime'}" dataStyleClass="{!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
		                <apex:outputLabel value="{!$ObjectType.Lead__c.Fields.Field4__c.label}"/>
		                <apex:outputPanel styleClass="requiredInput" layout="block">
			            	<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
			                <!-- 2016/10/13 BEGIN by zh-->
			                <apex:inputField id="entryTime" value="{!newLead.Field4__c}"  style="{!cusField.fieldStyle}" styleClass="{!if(cusField.isRequired,'repuiredClass','')}"/>
			                <!-- 2016/10/13 END by zh-->
		                </apex:outputPanel>
		            </apex:pageBlockSectionItem>
					<!-- カタカナ -->
				    <apex:pageBlockSectionItem helpText="{!$ObjectType.Contact.Fields.KanaName1__c.InlineHelpText}" id="kanaNameItem" rendered="{!cusField.fieldType == 'kanaName'}" dataStyleClass="contact_{!$Setup.CommDefine__c.AppNS__c}KanaName1__c {!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
				        <apex:outputLabel value="{!$Label.ps__msg_008_0068}"/>
				        <apex:outputPanel styleClass="requiredInput" layout="block">
		            		<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
				        	<apex:inputText id="kanaName" value="{!newContact.KanaName1__c}"  style="{!cusField.fieldStyle}" styleClass="{!if(cusField.isRequired,'repuiredClass','')}"/>
				        </apex:outputPanel>
				    </apex:pageBlockSectionItem>
		            <!-- $出発日 -->
		            <apex:pageBlockSectionItem id="departureDateItem" rendered="{!cusField.fieldType == 'departureDate'}" dataStyleClass="{!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
		                <apex:outputLabel value="{!$Label.ps__msg_008_0069}"/>
		                <apex:outputPanel styleClass="requiredInput" layout="block">
		            		<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
		                	<apex:outputText id="departureDate"  style="{!cusField.fieldStyle}" value="" />
		                </apex:outputPanel>
		            </apex:pageBlockSectionItem>       
		     		<!-- TEL -->
					<apex:pageBlockSectionItem id="custPhoneItem" rendered="{!cusField.fieldType == 'custPhone'}" dataStyleClass="{!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')} contact_Phone">
		        		<apex:outputLabel value="{!$Label.ps__msg_008_0070}"/>
		        		<apex:outputPanel styleClass="requiredInput" layout="block">
		            		<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
		        			<apex:inputText id="custPhone" value="{!newContact.Phone}"  style="{!cusField.fieldStyle}" styleClass="{!if(cusField.isRequired,'repuiredClass','')}"/>
		        		</apex:outputPanel>
					</apex:pageBlockSectionItem>
		            <!-- $出発時刻 -->
		            <apex:pageBlockSectionItem id="departureTimeItem" rendered="{!cusField.fieldType == 'departureTime'}" dataStyleClass="{!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
		                <apex:outputLabel value="{!$ObjectType.Lead__c.Fields.Field3__c.label}"/>
		                <apex:outputPanel styleClass="requiredInput" layout="block">
		            		<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
		                	<apex:inputField id="departureTime" value="{!newLead.Field3__c}"  style="{!cusField.fieldStyle}" styleClass="{!if(cusField.isRequired,'repuiredClass','')}"/>
		                </apex:outputPanel>
		            </apex:pageBlockSectionItem>
		            <!-- 予約人数 -->
		            <apex:pageBlockSectionItem id="stayPersonItem" rendered="{!cusField.fieldType == 'stayPerson'}" dataStyleClass="{!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
		                <apex:outputLabel value="{!$Label.ps__msg_008_0071}"/>
		                <apex:outputPanel styleClass="requiredInput" layout="block">
			            	<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
			                <apex:inputField id="stayPerson" value="{!newLead.StayPersons__c}"  style="{!cusField.fieldStyle}" styleClass="{!if(cusField.isRequired,'repuiredClass','')}"/>
		            	</apex:outputPanel>
		            </apex:pageBlockSectionItem>
		            <!-- セミナー 
		            <apex:inputField id="seminarOrderFlg" value="{!newLead.SeminarOrderFlg__c}" rendered="{!isHaveSeminar}"/>
		            <apex:outputLabel value="" rendered="{!!isHaveSeminar}"/>-->
		            <!-- セミナー -->
		            <apex:pageBlockSectionItem rendered="{!cusField.fieldType == 'seminarorder'}" dataStyleClass="{!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
		            	<!--2017/02/28 新版本対応　by zy BEGIN-->
		            	<apex:outputLabel value="{!$ObjectType.Lead__c.Fields.SeminarOrderFlg__c.label}" rendered="{!isHaveSeminar}"/>
		            	<apex:outputPanel styleClass="requiredInput" layout="block">
			            	<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block" rendered="{!isHaveSeminar}"/>
		            		<apex:inputField id="seminarOrderFlg" value="{!newLead.SeminarOrderFlg__c}"  style="{!cusField.fieldStyle}" styleClass="{!if(cusField.isRequired,'repuiredClass','')}" rendered="{!isHaveSeminar}"/>
		            		<apex:outputLabel value="" rendered="{!!isHaveSeminar}"/>
		            	</apex:outputPanel>
		            	<!--2017/02/28 新版本対応　by zy BEGIN-->
		            </apex:pageBlockSectionItem>
		            <!-- 泊数 -->
		            <apex:pageBlockSectionItem id="staysNumsItem" rendered="{!cusField.fieldType == 'staysNums'}" dataStyleClass="{!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
		                <apex:outputLabel value="{!$Label.ps__msg_008_0053}"/>
		                <apex:outputPanel styleClass="requiredInput" layout="block">
		            		<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
		                	<apex:inputText id="staysNums" value="{!staysNums}" onchange="setDepartureDateAuto_1()" maxlength="4"  style="{!cusField.fieldStyle}" styleClass="{!if(cusField.isRequired,'repuiredClass','')}"/>
		                </apex:outputPanel>
		            </apex:pageBlockSectionItem>
		            <!-- エキストラベッド 
		            <apex:inputField id="extrabedFlg" value="{!newLead.ExtraBedChk__c}" rendered="{!isHaveEbInfo}"/>
		            <apex:outputLabel value="" rendered="{!!isHaveEbInfo}"/>-->
		            <apex:pageBlockSectionItem rendered="{!cusField.fieldType == 'extrabedchk'}" dataStyleClass="{!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
		                <apex:outputLabel value="{!$ObjectType.Lead__c.Fields.ExtraBedChk__c.label}"  rendered="{!isHaveEbInfo}"/>
		                <apex:outputPanel styleClass="requiredInput" layout="block">
		            		<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"  rendered="{!isHaveEbInfo}"/>
		                	<apex:inputField id="extrabedFlg" value="{!newLead.ExtraBedChk__c}" styleClass="{!if(cusField.isRequired,'repuiredClass','')}"  style="{!cusField.fieldStyle}" rendered="{!isHaveEbInfo}"/>
		                	<apex:outputLabel value=""  rendered="{!!isHaveEbInfo}"/>
		                </apex:outputPanel>
		            </apex:pageBlockSectionItem>
		            <!-- 部屋 -->
		            <apex:pageBlockSectionItem id="broom" rendered="{!cusField.fieldType == 'brooms'}" dataStyleClass="{!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
		                <apex:outputlabel value="{!$ObjectType.Lead__c.Fields.Rroom__c.label}" />
		                <apex:outputPanel styleClass="requiredInput" layout="block">
		            		<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
		                	<apex:outputText id="roomName" value=""  style="{!cusField.fieldStyle}"/>
		                </apex:outputPanel>
		            </apex:pageBlockSectionItem>
		            <!-- 部屋数 --> 
		            <apex:pageBlockSectionItem id="broomNum" rendered="{!cusField.fieldType == 'broomNum'}" dataStyleClass="{!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
		                <apex:outputlabel value="{!$Label.ps__msg_008_0122}" />
		                <apex:outputPanel styleClass="requiredInput" layout="block">
		            		<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
		                	<apex:outputText id="roomNum" value="1"  style="{!cusField.fieldStyle}" />
		                </apex:outputPanel>
		            </apex:pageBlockSectionItem>
		            <!-- 右側空白列 
		            <apex:outputLabel value="" />-->
		            <!-- プラン -->
		            <!-- 2016/10/13 BEGIN by zh-->
		            <apex:pageBlockSectionItem id="planItem" rendered="{!!isPlanDetailFlag && cusField.fieldType == 'plan'}" dataStyleClass="{!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
		            <!-- 2016/10/13 END by zh-->
		                <apex:outputLabel value="{!$Label.ps__msg_008_0072}"/>
		                <apex:outputPanel styleClass="requiredInput" layout="block">
		            		<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
						    <span class="lookupInput">
				<!-- 2016/12/28 连接plan页面替换标准页面  begin by wx  -->  
				<!-- <apex:inputField id="plan" value="{!newLead.Field310__c}" html-placeholder="{!$Label.ps__inf_0002}" style="width:180px" >-->    
			<apex:inputText id="plan" value="{!planName}" html-placeholder="{!$Label.ps__inf_0002}" style="{!if(ISBLANK(cusField.fieldStyle),'width:180px',cusField.fieldStyle)}"  styleClass="{!if(cusField.isRequired,'repuiredClass','')}"  />
                	<apex:inputHidden value="{!newLead.Field310__c}" id="plan_lkid" />
				<!-- 2016/12/28 连接plan页面替换标准页面  end by wx  -->
									<c:AutoCompleteComp objectname="Plan__c"
										jslibnew="true"
										additionalfield="{!$Setup.CommDefine__c.AppNS__c}PlanNo__c,{!$Setup.CommDefine__c.AppNS__c}PackageCode__c"
										autocomplete_textbox="{!$Component.plan}" addFilter="IsClosed__c=false" callbackFunction="planRest" soslExtend="false"/>
            	<!-- 2016/12/28 连接plan页面替换标准页面  begin by wx  -->
				<!--</apex:inputField>-->
                	<img title="" onmouseover="this.className = 'lookupIconOn';this.className = 'lookupIconOn';"
			              				onmouseout="this.className = 'lookupIcon';this.className = 'lookupIcon';"
			              				onfocus="this.className = 'lookupIconOn';"
			              				onblur="this.className = 'lookupIcon';"
			              				class="lookupIcon" alt="" src="/s.gif" style="cursor: pointer;"
			              				name="planPopup" />
				<!-- 2016/12/28 连接plan页面替换标准页面  end by wx  -->					
			                	<!-- プラン詳細 -->
								<img src="{!URLFOR($Resource.AppImages, 'extend/jiahao.png')}" style="cursor: pointer; width: 18px; height: 18px;"
				                     onclick="javascript:openMiniPlanSetup(this);" id="planCustomeBtn" title="{!$Label.MSG_008_0073}"/>
							</span>
							<apex:inputHidden value="{!newLead.PlanDetailSyncInfo__c}" id="nl_hidPlanDetailInfo"/>
						</apex:outputPanel>
		            </apex:pageBlockSectionItem>
            <!-- 右側空白列 -->
            <!-- 2016/10/13 BEGIN by zh
            <apex:outputLabel value="" rendered="{!IF(isPlanDetailFlag, false, true)}"/>-->
            <!-- 2016/10/13 END by zh-->
		            <!-- 支払方法 -->
		            <apex:pageBlockSectionItem id="paymentTypeItem" rendered="{!cusField.fieldType == 'paymentType'}" dataStyleClass="{!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
		                <apex:outputLabel value="{!$Label.ps__msg_008_0074}"/>
		                <apex:outputPanel styleClass="requiredInput" layout="block">
		            		<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
			                <apex:selectList value="{!newLead.Field315__c}" multiselect="false" size="1" id="paymentType" style="{!cusField.fieldStyle}" styleClass="{!if(cusField.isRequired,'repuiredClass','')}">
			                    <apex:selectOptions value="{!paymentTypeLst}"/>
			                </apex:selectList>
		                </apex:outputPanel>
		            </apex:pageBlockSectionItem>
            <!-- 右側空白列 
            <apex:outputLabel value="" />-->
		            <!-- 予約チャネル -->
		            <apex:pageBlockSectionItem id="channel" rendered="{!cusField.fieldType == 'channel'}" dataStyleClass="{!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
		                <apex:outputLabel value="{!$Label.ps__msg_008_0019}"/>
		                <apex:outputPanel styleClass="requiredInput" layout="block">
		            		<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
			                <apex:inputField value="{!newLead.Field2__c}" id="chanelId" styleClass="{!if(cusField.isRequired,'repuiredClass','')}" style="{!cusField.fieldStyle}" />
		                </apex:outputPanel>
		            </apex:pageBlockSectionItem>
            <!-- 右側空白列 
            <apex:outputLabel value="" />-->
		            <!-- セグメント -->
		            <apex:pageBlockSectionItem id="segmentItem" rendered="{!cusField.fieldType == 'segment'}" dataStyleClass="{!if(p.columnsInt>1,'coloumn2Class','coloumn1Class')}">
		                <apex:outputLabel value="{!$Label.ps__msg_008_0075}"/>
		                <apex:outputPanel styleClass="requiredInput" layout="block">
		            		<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
		                	<apex:inputField id="segment" value="{!newLead.Segment__c}" styleClass="{!if(cusField.isRequired,'repuiredClass','')}" style="{!cusField.fieldStyle}"/>
		                </apex:outputPanel>
		            </apex:pageBlockSectionItem>
		
			
		<!-- Extend Field(自由拡張項目) --> 
		<!-- <apex:outputLabel id="dynamicFields">     	 
		<apex:dynamicComponent componentValue="{!InputExtendFields}" /> -->
		<!-- </apex:outputLabel> -->
		
		<!-- コメント入力項目 -->
		<apex:pageBlockSectionItem rendered="{!cusField.fieldType == 'comment3'}">
		                <apex:outputLabel value="{!$ObjectType.Lead__c.Fields.Comment3__c.label}"/>
		            	<apex:outputPanel styleClass="requiredInput" layout="block">
		            		<apex:outputPanel styleClass="{!if(cusField.isRequired,'cusRepuiredClass','')}" layout="block"/>
		            		<!-- 2018/05/08 特記事項に定型文をクリック一つで入力できる機能 zyz BEGIN -->		
		            		<c:CommentHelperComp commentId="comment3" commentFlg="true"/>
		            		<!-- 2018/05/08 特記事項に定型文をクリック一つで入力できる機能 zyz END -->
			               <apex:inputTextarea value="{!newLead.Comment3__c}" id="comment3" html-element="lead_{!cusField.localName}" richtext="false" rows="4" cols="160" styleClass="ckeditorClass {!if(cusField.isRequired,'repuiredClass','')}"/>
		            	</apex:outputPanel>
		            </apex:pageBlockSectionItem>
				</apex:repeat>
       	</apex:pageBlockSection>
		</apex:repeat>
      </apex:pageBlock>
    <!-- 2016/10/13 BEGIN by zh-->
    <!-- 予約見積明細 -->
  	<apex:outputpanel id="detailPageBlock" rendered="{!isPlanDetailFlag}">
  	<apex:inputHidden value="{!curRows}" id="hidCurRows"/>
  	<!-- 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH BEGIN -->
  	<apex:inputHidden value="{!addRowsMan}" id="hidaddRowsMan"/>
  	<!-- 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH END -->
    <apex:pageBlock >
    <apex:actionFunction name="addTranItemFun" action="{!addBookingItem}"
    	status="refStatusBlock" reRender="detailPageBlock,leadMessagePanel" oncomplete="JINYACONNECT.CUSTOM.detailBindEvent();_gotoLastDetailRow()"/>
        <table style="border-spacing: 0px;border-collapse: 0px;table-layout: fixed;width:100%">
			<tr>
				<td>
					<!-- 2020/01/30 行追加ボタン機能対応 BY zyz BEGIN -->
					<!-- 行追加  -->
    					<input class="btn" value="{!$Label.MSG_011_0052}" type="button" onclick="refreshOrder(true);checkAddTranItem()" style="width: 100px;" />
    					<!-- 2020/01/30 行追加ボタン機能対応 BY zyz END -->
    				<!-- 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH BEGIN -->
    				<input class="btn" value="プラン" type="button" onclick="openPlanWinFun();" style="width: 100px;display:{!IF(isBasePlanFlag,'','none;')}" />
    				<!-- 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH END -->
    			</td>
    			<!-- 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH BEGIN -->
            	<!--<td style="width:75.5%; text-align: right;vertical-align: middle;text-align: right;">-->
            	<td style="width:69%; text-align: right;vertical-align: middle;text-align: right;">
            	<!-- 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH END -->
	                <table style="width: 100%; border-spacing: 0px;border-collapse: 0px; font-size: 16px;font-weight: bold;table-layout: fixed;text-align: right;">
	                	<tr>
	                		<td style="height: 24px;">
	                			<!-- ご利用金額(税込)： -->
	                			<span>{!$Label.MSG_006_0250}</span>
	                		</td>
	                		<td style="width: 110px">
	                			<input type="hidden" class="detailClass" id="totalAmountExcTax" />
			                   	<apex:outputPanel style="margin-right: 2px;" id="usedAmount">
					    			<span id="usedAmountBlock" ></span>  	
			                   	</apex:outputPanel>
	                		</td>
	                	</tr>
	                	<tr>
	                		<td style="height: 24px;">
	                			<!-- ご請求金額(税込)： -->
	                			<span>{!$Label.MSG_006_0259}</span>
	                		</td>
	                		<td style="width: 110px">
			                   	<apex:outputPanel style="margin-right: 2px;" id="reqAmount">
					    			<span id="reqAmountBlock"></span>  	
			                   	</apex:outputPanel>
	                		</td>
	                	</tr>
	                </table>
	    		</td>
	   		</tr>
	   	</table>
	   	
	   	<apex:pageBlockTable value="{!oBookEstLst}" var="t" id="BookEstTable" columnsWidth="1%,3%,37%,10%,10%,9%,7%,7%,7%,9%" rowClasses="tranDetailRow">
				<apex:column width="1%">
				<!-- 移動 -->
					 <div title="{!$Label.MSG_011_0050}"  class="pointIndex {!t.addRowStr}" rowIndex = "{!t.index}" >
					 	  <img title="" class="pointImg" alt="" src="{!URLFOR($Resource.AppImages, 'extend/blur.png')}" />  
				          <apex:inputHidden value="{!t.sobj.RowNo__c}" id="hidRowNo" /> 
					</div>
				</apex:column>
				
				<!-- アクション -->
			 	<apex:column headerValue="{!$Label.ps__msg_011_0061}" footerClass="totalRowCenCell" width="3%">
			 		<!-- クリア -->
					<input type="button" title="{!$Label.MSG_011_0062}" value="{!$Label.MSG_011_0062}" id="clearProduct" rowIndex="{!t.index}" />
				</apex:column>
		
			 	<!-- 商品コード -->
			 	<!-- 商品 -->
		        <apex:column headerValue="{!$Label.ps__msg_011_0063}">
		        		<span class="lookupInput">
		        		<!-- 
		                <input type="text" value="{!t.productNm}" id=":BookEstTable:{!t.index}:productName"
		                    readonly="readonly" style="background-color:#f1f1f1; background-image: url({!URLFOR($Resource.reportFiles, 'img/blank')});" /> -->
		                <table style="width: 100%;border-spacing: 0;border: 0; padding: 0">
		                <tr>
		                <td style="border-bottom:0px;padding: 0px;">
		                <apex:inputText value="{!t.productNm}" id="productName" maxlength="80" style="width:99%;" html-rowIndex="{!t.index}"/>
		                </td>
		                <td style="width: 44px; border-bottom:0px;padding: 0px 0px 0px 2px">
		                <img title="" onmouseover="this.className = 'lookupIconOn';this.className = 'lookupIconOn';"
			              onmouseout="this.className = 'lookupIcon';this.className = 'lookupIcon';"
			              onfocus="this.className = 'lookupIconOn';"
			              onblur="this.className = 'lookupIcon';"
			              class="lookupIcon" alt="" src="/s.gif" style="cursor: pointer;"
			              name="productPopup"
			              rowIndex = "{!t.index}" />
			          	
			            <!-- 単価用ボタン -->
			            <!-- 展開 -->
		                <img title="{!$Label.MSG_011_0064}" src="{!URLFOR($Resource.AppImages, 'extend/jiahao.png')}"
		                    style="cursor: pointer;display: true; width: 18px; height: 18px; visibility:{!IF(t.isPlanProduct,'visible','hidden')}"
		                    id="showDetailEvent{!t.index}" onclick="showDetailFun(this)" openStatus="false"
		                    rowIndex = "{!t.index}" />
						</td></tr></table>
						</span>
					  <apex:inputHidden value="{!t.sobj.PlanDetailSyncInfo__c}" id="hidSyncInfo" />
		              <!-- 関連情報を一時保持するため、別の変数を定義する -->
		              	
		              <!-- 2018/07/27 宿泊税計算 WGCH BEGIN -->
		              <!-- <apex:inputHidden value="{!t.sobj.refAccountMaster__c}" id="hidProductId" /> -->
		              <!-- 2019/04/30 増税仮対応 WGCH BEGIN -->
		              <!-- <apex:inputHidden value="{!t.sobj.refAccountMaster__c}" id="hidProductId" html-rowNo="{!t.rowNo}" /> -->
		              <apex:inputHidden value="{!t.sobj.refAccountMaster__c}" id="hidProductId" html-rowNo="{!t.rowNo}" html-rowindex="{!t.index}" />
		              <!-- 2019/04/30 増税仮対応 WGCH END -->
		              <!-- 2018/07/27 宿泊税計算 WGCH END -->
		              <apex:inputHidden value="{!t.orgProductNm}" id="hidProductNm" />
		              <!-- 関連情報を一時保持するため、別の変数を定義する -->
		              <apex:inputHidden value="{!t.sobj.ActionType__c}" id="hidActionType" />
					  <!-- 支払種別 -->
					  <apex:inputHidden value="{!t.sobj.PaymentType__c}" id="hidPaymentType" />
					  <!-- 金額（税込み) -->
					  <apex:inputHidden value="{!t.amoutIncTax}" id="hidAmoutPriceIncTax" html-rowIndex="{!t.index}"/>
					  <!-- 金額（税抜き） -->
					  <apex:inputHidden value="{!t.amoutExcTax}" id="hidAmoutPriceExcTax" />
					  <!-- 単価定義区分 -->
					  <input type="hidden" value="{!t.sobj.UnitPriceDefKbCal__c}" id=":tran1Table:{!t.index}:hidUnitPriceKbn" />
					  <!-- 2015/10/16 プラン明細課税、非課税混在合計金額計算対応 BEGIN -->
					  <!-- 2016/11/21 行追加后課税商品计算错误 BEGIN by zh -->
					  <apex:inputHidden id="hidPlandetail" value="{!t.initPlanInfo}"/>
					  <!-- 2016/11/21 行追加后課税商品计算错误 END by zh -->
					  <!-- 2015/10/16 プラン明細課税、非課税混在合計金額計算対応 END -->
					  <input type="hidden" id=":BookEstTable:{!t.index}:hidHadRoomFlag" value=""/>
					  <!-- 2018/07/27 宿泊税計算 WGCH BEGIN -->
					  <input type="hidden" id=":BookEstTable:{!t.index}:hidPDetailId" value=""/>
					  <!-- 2018/07/27 宿泊税計算 WGCH END -->
					  <!-- 2019/07/30 軽減税率機能対応 WGCH BEGIN -->
					  <input type="hidden" id=":BookEstTable:{!t.index}:hidPlanBrkInfoId" value=""/>
					  <!-- 2019/07/30 軽減税率機能対応 WGCH END -->
					  <!-- 2020/07/30 入湯税の自動入力機能について改善 WGCH BEGIN -->
					  <!-- 第一笔Plan对应的入汤税商品Id -->
					  <apex:inputHidden value="{!t.bTaxAccMstId}" id="hidBTaxAccMstId" />
					  <!-- 入汤税商品对应关联PLANROWNO -->
					  <apex:inputHidden value="{!t.bTaxToPlanRowIndex}" id="hidBTaxToPlanRowIndex" />
					  <!-- 放大镜入汤税商品 -->
					  <apex:inputHidden value="{!t.bTaxAccMstItem}" id="hidBTaxAccMstItem" />
					  <!-- 2020/07/30 入湯税の自動入力機能について改善 WGCH END -->
					  <!-- 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH BEGIN -->
					  <apex:inputHidden value="{!t.sobj.SysSelBasePlanNums__c}" id="hidBasePlanNum" />
					  <apex:inputHidden value="{!t.sobj.GuestType__c}" id="hidEstGuestType" />
					  <!-- 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH END -->
		        </apex:column>
		
				<!-- 単価-->
		        <apex:column headerValue="{!$Label.ps__msg_006_0404}" >
		            <!-- <apex:inputField value="{!t.sobj.UnitPrice__c}" id="price" style="width:80px"/> -->
		            <apex:inputText value="{!t.unitPrice}" id="price"  style="width:40px"/>
		        </apex:column>
		
				<!-- 数量-->
		        <apex:column headerValue="{!$Label.ps__msg_006_0405}" >
		            <apex:inputText value="{!t.prodNums}" id="orderNums" maxlength="8" style="width:30px"/>
		        </apex:column>
		
				<!-- 合計金額(税抜)-->
		        <apex:column headerValue="{!$Label.ps__msg_006_0258}" 
		        	style="text-align: right; background-color: #FFEBCD; min-width:68px" headerClass="smallTitle">
					<apex:outputText value="{0,number,{!numberFormat}}"  id="amoutPriceExcTax">
					<apex:param value="{!t.amoutExcTax}" />
					</apex:outputText>
		        </apex:column>
		
				<!-- 消費税 -->
		        <apex:column headerValue="{!$Label.ps__msg_006_0406}" style="text-align: right; " >
					<!-- <apex:outputField value="{!t.sobj.TaxRate__c}" id="taxRateType"/> -->
					<apex:outputText value="{0,number, {!TaxNumberFormat}}" id="taxRateType">
		            <apex:param value="{!t.sobj.TaxRate__c/100}" />
		            </apex:outputText>
					<apex:inputHidden value="{!t.sobj.TaxRate__c}" id="hidTaxRateType" />
		        </apex:column>
		        <!-- サービス料 -->
		        <apex:column headerValue="{!$Label.ps__msg_006_0407}" style="text-align: right; " headerClass="smallTitle" >
		            <apex:outputField value="{!t.sobj.ServiceRate__c}" id="serviceRate" />
					<apex:inputHidden value="{!t.sobj.ServiceRate__c}" id="hidServiceRate" />
		        </apex:column>
		        <!-- 特別税 -->
		        <apex:column headerValue="{!$Label.ps__msg_006_0408}" style="text-align: right; " width="5%">
		
		            <apex:outputText value="{0,number,{!numberFormat}}" id="specialTax">
		                <apex:param value="{!t.specialTax}" />
		            </apex:outputText>
					<apex:inputHidden value="{!t.sobj.SpecialTax__c}" id="hidSpecialTax" />
		        </apex:column>
		        <!-- 合計金額(税込) -->
		        <apex:column headerValue="{!$Label.ps__msg_006_0257}" style="text-align: right; background-color: #FFEBCD; min-width:68px" headerClass="smallTitle"
		        	footerClass="totalRowNumCell">
					<apex:outputText value="{0,number,{!numberFormat}}"  id="amoutPriceIncTax" >
						<apex:param value="{!t.amoutIncTax}" />
					</apex:outputText>
		        </apex:column>
			</apex:pageBlockTable>
		</apex:pageBlock>
		</apex:outputpanel>
  <!-- 予約見積明細 -->
  <!-- 2016/10/13 END by zh-->
  </div>

  <!-- Footer -->
  <div class="ft" >
    <apex:outputPanel layout="block">
        <div style="text-align: right;" >
          <input type="reset" value="reset" id="createLeadFormresetbtn" style="display: none;"/>
          <!-- 2016/10/26 BEGIN by zh -->
          <!-- 保存 -->
          <!-- <apex:commandButton value="{!$Label.MSG_008_0076}" onclick="doBeforeSave();" oncomplete="leadCreateCallBack();"
            style="width: 100px" action="{!bookingCreate}" reRender="roomIndicator,leadMessagePanel"  status="refStatusBlock"/> -->
          <!-- 2016/10/26 BEGIN -->
          <input type="button" value="{!$Label.MSG_008_0076}" class="btn disBtn" style="width: 100px"  onclick="doBeforeSave();"/>
           <apex:actionFunction name="saveLeadFun" oncomplete="leadCreateCallBack();" 
                            action="{!bookingCreate}"   reRender="roomIndicator,leadMessagePanel"  />
          <!-- 2016/10/26 END by zh-->
            <!-- キャンセル -->
          <input type="button" value="{!$Label.MSG_008_0080}" class="btn disBtn" style="width: 100px" 	onclick="YAHOO.force.com.hideCreateLead()" />
        </div>
    </apex:outputPanel>
  </div>
  </apex:form>
</div>




<apex:form >
	<!-- 
	<apex:actionFunction name="changeRoomFun" oncomplete="roomChangeAfterAct();"
	action="{!changeRoom}" rerender="roomIndicator" status="refStatusBlock"/>
	 -->
	<apex:actionFunction name="refreshPageFun" rerender="roomIndicator" 
	action="{!refreshPage}" onbeforedomupdate="refreshDS()" oncomplete="YAHOO.force.com.hideMe();unblockUi();"/>
	
	<apex:inputHidden id="chgRoomLeadIdHid" value="{!strLeadId}"/>
	<apex:inputHidden id="chgRoomIdHid" value="{!strNewRoomId}" />
	<apex:inputHidden id="chgRoomNmHid" value="{!strNewRoomNo}" />
	<!-- 2017/12/22 画面フィルター機能追加　by　zy　BEGIN -->
	<apex:inputHidden value="{!filterHidRoom}" id="hidFilterRoom"/>
	<apex:inputHidden value="{!filteText}" id="hidFilterText"/>
	<!-- 2017/12/22 画面フィルター機能追加　by　zy　END -->
</apex:form>
<!-- 画面のアサインした予約情報は部屋移動場合、移動情報はMemory情報反映を行う -->
<apex:form >
	<apex:actionFunction name="updateMemoryRoomLeadFun" rerender="roomIndicator,ciTableMessagePanel" 
	oncomplete="roomChangeAfterAct();unblockUi();"
	action="{!updateMemoryRoomLeadMap}" onbeforedomupdate="refreshDS()"/>
	<apex:inputHidden id="dropFromRoomIdHid" value="{!moveFromRoomId}"/>
	<apex:inputHidden id="dropFromLeadIdHid" value="{!moveFromLeadId}" />
	<apex:inputHidden id="dropToRoomIdHid" value="{!moveToRoomId}" />
	<apex:inputHidden id="dropToLeadIdHid" value="{!moveToLeadId}" />
    <apex:inputHidden id="dropTopLeadIdsHid" value="{!topLeadIdsHid}" />
    <!-- 2017/12/22 画面フィルター機能追加　by　zy　BEGIN -->
	<apex:inputHidden value="{!filterHidRoom}" id="hidFilterRoom"/>
	<apex:inputHidden value="{!filteText}" id="hidFilterText"/>
	<!-- 2017/12/22 画面フィルター機能追加　by　zy　END -->
</apex:form>
<!-- 注意情報 -->
<!-- 
<div id="messageWindow">
<apex:form id="messageForm">
<apex:pageBlock >
	<apex:pageBlockSection columns="1">
		<apex:pageBlockSectionItem >
		    <apex:outputLabel value="{!$ObjectType.MessageItem__c.fields.Message1__c.Label}"/>
		    <apex:inputField value="{!messageObj.Message1__c}" style="width:450px"/>
		</apex:pageBlockSectionItem>
		<apex:pageBlockSectionItem >
		    <apex:outputLabel value="{!$ObjectType.MessageItem__c.fields.Message2__c.Label}"/>
		    <apex:inputField value="{!messageObj.Message2__c}" style="width:450px;"/>
		</apex:pageBlockSectionItem>
		<apex:pageBlockSectionItem >
		    <apex:outputLabel value="{!$ObjectType.MessageItem__c.fields.Message3__c.Label}"/>
		    <apex:inputField value="{!messageObj.Message3__c}" style="width:450px"/>
		</apex:pageBlockSectionItem>
		<apex:pageBlockSectionItem >
		    <apex:outputLabel value="{!$ObjectType.MessageItem__c.fields.Message4__c.Label}"/>
		    <apex:inputField value="{!messageObj.Message4__c}" style="width:450px"/>
		</apex:pageBlockSectionItem>
		<apex:pageBlockSectionItem >
		    <apex:outputLabel value="{!$ObjectType.MessageItem__c.fields.Message5__c.Label}"/>
		    <apex:inputField value="{!messageObj.Message5__c}" style="width:450px"/>
		</apex:pageBlockSectionItem>
		<apex:pageBlockSectionItem dataStyle="text-align: right;">
		<apex:commandButton style="width:100px; " value="事項保存" action="{!saveMessageItem}" reRender="messageForm" status="refStatusBlock"/>
		</apex:pageBlockSectionItem>
	</apex:pageBlockSection>
</apex:pageBlock>
</apex:form>
</div>
 -->
<!-- 部屋は未割り当て の予約データ可能 -->
<div id="noAssignLeadListWindow" >
<div id="noAssignLeadListView"></div>
</div>
<!-- DayUse部屋情報リストを格納表示用 -->
<div id="roomLeadListWindow">
</div>

<!-- 印刷用URL情報を格納用 -->
<input type="hidden" id="pdfurlHid" />

<script id="treeview-template" type="text/x-kendo-tmpl">

<span class="noAssignLead" 
	childrenItems="#:item.subdataid#"
	groupflg="#:item.isHasChildren#" 
	leadUid="#:item.id#" 
	roomTypeUnm="#=item.roomTypeName#" 
	roomTypeUid="#:item.roomTypeId#" 
    starttime="#:item.startDateTime#"
    endtime="#:item.endDateTime#"
	dataid="#:item.id#" >
	# if (! item.isHasChildren ) { #	
		# if (item.statusIcon != "" ) { #
		<img src="#= item.statusIcon #" style="width:18px;height:18px;vertical-align: middle;" />			
		# }	#
		<a href="/#=item.id #" target="_blank">#=item.text #</a>
	# } else { #
		#=item.text #
	# }	#
	</span>
</script>

<script>

/***********************
* 画面更新する場合、自動Evetn　Bindを行う
***********************/
//2019/2/15 ルームインジケータの部屋タイプ絞り込み機能を、タイムテーブルと同じように、複数タイプ指定できるようにして欲しい by cxw BEGIN
function getRoomTypeNameVals($this) {
	return ($this.val() == null ? "" : $this.val().join(","));
}
//2019/2/15 ルームインジケータの部屋タイプ絞り込み機能を、タイムテーブルと同じように、複数タイプ指定できるようにして欲しい by cxw END
function bindEvent() {
	// 2019/10/15 iPadは陣屋コネクトとして推奨しているモバイル端末であり、iPadでは一切ドラッグ＆ドロップができなくなるのも困りますので、編集モードと閲覧モードの切り替えができる様にお願いします by zy BEGIN
	var mobileReadOnly = $j("#hidMobileReadOnly").val() == "true";
	JS_SYS_DEVICE_MOBILE_FLG = (kendo.support.mobileOS && mobileReadOnly) || !_g_isCanUpdateFlg; 
	// 2019/10/15 iPadは陣屋コネクトとして推奨しているモバイル端末であり、iPadでは一切ドラッグ＆ドロップができなくなるのも困りますので、編集モードと閲覧モードの切り替えができる様にお願いします by zy END
	// 2018/05/11 複数店舗を選択表示できる機能対応 BEGIN
	// 支店情報が存在する場合「選択リストUI処理」
	//2019/2/15 ルームインジケータの部屋タイプ絞り込み機能を、タイムテーブルと同じように、複数タイプ指定できるようにして欲しい by cxw BEGIN 
	// 2018/02/01 kendoMultiSelect/*setDropDropDownWidth(  {!multiSelectCompFlg}*/
	if({!branchShopLst.size > 0 && !multiSelectCompFlg}) {
		$j('select[id$="branchShopCdDef"]').kendoDropDownList();
	}
	if(true) {
		var roomTypeDropDown = $j("select[id$='roomTypeSelectId']").css({ fontSize: 13, height:24, padding:0}).multiselect({ 
		// 2018/07/24 显示高度改善 WGCH BEGIN
		classes: 'roomTypeMaxHeight',
		// 2018/07/24 显示高度改善 WGCH END
		selectedList: 4,
		header: false,
		click: function(event, ui){
			//  2017/02/13 页面自动刷新功能 by wx begin 
			stopRunning();
			//  2017/02/13 页面自动刷新功能 by wx end
			$this= $j(this);
			$thisLable= event.currentTarget.parentElement;
			$allLable= $j("select[id$='roomTypeSelectId']").multiselect("widget").find("ul.ui-multiselect-checkboxes li");
			if(ui.checked) $j($thisLable).addClass("k-state-selected").className= "ui-corner-all ui-state-hover k-state-selected";
			else $thisLable.className= "ui-corner-all ui-state-hover";
			// All Selected
			if (ui.value == "") {
				$this.multiselect("uncheckAll");
				$this.val("");
				$this.multiselect("widget").find("input")[0].checked= true;
				if($allLable.children("label").hasClass("k-state-selected")) $allLable.children("label").removeClass("k-state-selected"); 
				$allLable.children("label:first").addClass("k-state-selected");
				$this.multiselect("close");
			} else {
				var length = $this.multiselect("widget").find("input:checked").length;
				if (length == 0) {
					$this.multiselect("widget").find("input")[0].checked= true;
					$allLable.children("label:first").addClass("k-state-selected");
				} else {
					$this.multiselect("widget").find("input")[0].checked= false;
					if($allLable.children("label:first").hasClass("k-state-selected")) $allLable.children("label:first").removeClass("k-state-selected");
				}
			}	
		},
		beforeopen: function(){
			$roomTypeSelectIdWidget = $j("select[id$='roomTypeSelectId']").multiselect("widget")
			$allChecked= $roomTypeSelectIdWidget.find("input")[0].checked;
			$allLable= $roomTypeSelectIdWidget.children("ul").children("li").children("label:first");
			if($allChecked) $allLable.addClass("k-state-selected");
			else if(!$allChecked && $allLable.hasClass("k-state-selected")) $allLable.removeClass("k-state-selected");
		},
		open: function(){
			$this = $j(this);
			var orgVal = getRoomTypeNameVals($this);
			$this.attr("orgVal", orgVal);
			// 2018/07/24 显示高度改善 WGCH BEGIN
			var multiselectHt = $j(window).height() > 400 ? $j(window).height() - 300 : 100;
			$j("div.roomTypeMaxHeight ul.ui-multiselect-checkboxes").css("height","");
			$j("div.roomTypeMaxHeight ul.ui-multiselect-checkboxes").css("max-height", multiselectHt + "px");
			// 2018/07/24 显示高度改善 WGCH END
		},
		close: function(){
			$this = $j(this);
			var orgVal = $this.attr("orgVal");
			var selectVal = getRoomTypeNameVals($this);
			if (orgVal != selectVal) {
				$j("input[id$=':multiRoomTypeIds']").val(selectVal);
				refreshInfoFun();
			//  2017/02/13 页面自动刷新功能 by wx begin	
			}else{
				startRunning();
			//  2017/02/13 页面自动刷新功能 by wx end	
			}
		},
	});
	$roomTypeDropDown=$j(roomTypeDropDown);
	$roomTypeDropDown.multiselect("widget").css("width","auto");
	var roomTypeDropDownWidth = $roomTypeDropDown.multiselect("widget").width() + 26;
	$roomTypeDropDown.multiselect({minWidth:roomTypeDropDownWidth});
	// 2019/01/15 タイムテーブルを開いた際、デフォルトで表示される部屋タイプを指定できるようにする by zy BEGIN
	initDepartmentSel($roomTypeDropDown,$j("input[id$=multiRoomTypeIds]").val());
	// 2019/01/15 タイムテーブルを開いた際、デフォルトで表示される部屋タイプを指定できるようにする by zy END
	let id = roomTypeDropDown.attr('id');
	$j("span", `button[id^="${id}"]`).eq(0).addClass("spanIco");
	$j("span", `button[id^="${id}"]`).eq(1).addClass("spanText").css("width",roomTypeDropDownWidth- 30);
	//2019/2/15 ルームインジケータの部屋タイプ絞り込み機能を、タイムテーブルと同じように、複数タイプ指定できるようにして欲しい by cxw END
	}
	// 2018/05/11 複数店舗を選択表示できる機能対応 END
	var roomNmTypeFlg = $j("select[id$=roomNameSelect]").val() == {!TEXT(ROOM_INFO_NAME_TYPE_GUESTNAME)} ? true : false;
    // 入力項目Readlonly[2013/02/15 ADD]
    $j("input[id$=':gotoDate']").attr('readonly', true);

    // Booking Btn Click
    // 部屋BLOCKをクリックする場合
    !notReadOnlyFlg || $j("div[name='roomstatusBlock']").click(function() {
// 2014/10/01 実施可否機能対応
// 2017/12/22 画面フィルター機能追加　by　zy　BEGIN
if (!isCanRunning() && !$j(this).has("filtered")) {
// 2017/12/22 画面フィルター機能追加　by　zy　END
	return;
}
    	var $this = $j(this);
    	var uncleanFlg = $this.hasClass("isCanContextMenu");
        var p1 = $this.attr("roomId");
        var p2 = $this.attr("leadId");
        // 予約データが非存在する場合
        if(p2 == null || p2 == ''){
			// 2019/05/30 こちらをルームインジケータ上からも1日単位の作成、削除（削除だけでもほしい）by zy BEGIN
            var badflag = $this.has(".isBadStatus").length > 0;
            // 2019/05/30 こちらをルームインジケータ上からも1日単位の作成、削除（削除だけでもほしい）by zy END
            if (uncleanFlg) {
                // 未清掃の部屋を表示する、清掃処理する画面を開く
                ajaxGetRoomInfo(p1, p2, uncleanFlg);
            // 2019/05/30 こちらをルームインジケータ上からも1日単位の作成、削除（削除だけでもほしい）by zy BEGIN
	    	} else if (badflag){
                // 未清掃の部屋を表示する、清掃処理する画面を開く
                ajaxGetRoomInfo.call({bad:badflag},p1, p2, uncleanFlg);
            // 2019/05/30 こちらをルームインジケータ上からも1日単位の作成、削除（削除だけでもほしい）by zy END
            } else {
                YAHOO.force.com.hideMe();
            }
        }else{
        	//$j("div[id^=window].lookupHoverDetail").hide();
            LookupHoverDetail.hideAllHovers();
            // 部屋にアサインする予約詳細情報画面を開く
            ajaxGetRoomInfo(p1, p2, uncleanFlg);
        }
    });
    // 団体情報色設定機能
    $j("div[name='roomstatusBlock']").filter("[leadId!='']").mouseenter(function() {
// 2014/10/01 実施可否機能対応
if (!isCanRunning()) {
	return;
}
    	var $this = $j(this);
    	var leadIndexId = $this.attr("leadIndexId");
    	if (leadIndexId != "") {
    		// 2014/08/20 部屋割り当てキャンセル機能対応
    		//var grouprooms = $j("div[leadIndexId='"+leadIndexId+"']");
    		var grouprooms = getContainerTeamGroupRooms(leadIndexId);
    		// 2018/07/24 ルームインジケータで複数部屋のリスト表示 zy BEGIN
    		var roomNames = [];
    		// 2018/07/24 ルームインジケータで複数部屋のリスト表示 zy END
    		if (grouprooms.length > 1) {
	    		// 団体の部屋情報は全部取得、色を設定する
	    		grouprooms.each(function() {
	    			//var blackWidth = $j('#container').width();
    				//var blackHeight = $j('#container').height();
	    			//$j(this).addClass("grouproom-ui-state-hover");
	    			var blackWidth = $j(this).width();
	    			var blackHeight = $j(this).height();
	    			$j(this).css({"border-color":"white"});
	    			var blackElement = $j(this).find('.blackCream');
	    			blackElement.css({
	    				"visibility": "visible",
					    "position": "absolute",
					    "width": blackWidth,
					    "height": blackHeight,
					    "top": " 0",
					    "margin": "0",
					    "padding": "0",
					    "z-index":"3",
					    "background-color": "#000000",
					    "filter": "alpha(opacity=10)",
						"-moz-opacity": "0.1",
						"-khtml-opacity": " 0.1",
						"opacity": " 0.1",
					    "transition": " background .2s linear, color .2s linear",
					    "-moz-transition": "background .2s linear, color .2s linear",
					    "-webkit-transition": "background .2s linear, color .2s linear",
					    "-o-transition": "background .2s linear, color .2s linear"
	    			});
	    			var creamElement = blackElement.children();
	    			creamElement.show();
	    			creamElement.css({
	    				"width": {!JSENCODE(TEXT(roomDivWidth))},
						"height": "14px",
						"margin": "0 auto",
						"vertical-align": "bottom",
						"overflow": "hidden",
						"white-space": " nowrap",
						"margin-top": " 40px"
	    			});
	    			creamElement.addClass("backChild");
	    			var leadId = $j(creamElement).attr("leadUid");
					if(leadId != '' && leadId != null)
					{
						var msgId = roomNmTypeFlg ?  $j(creamElement).attr("contactId") : leadId;
						var msgWinId = (msgId != leadId) ? ('window_message_' + leadId + '_' + msgId) : ('window_message_' + msgId);
						var isBlocked =  $j(creamElement).attr("isBlocked");
						wrapHoverMiniWin(creamElement,msgId,leadId,isBlocked);
					}
					// 2018/07/24 ルームインジケータで複数部屋のリスト表示 zy BEGIN
					var roomnm = $j("div[roomnm]",this).attr("roomnm");
					roomNames.push(roomnm);
					// 2018/07/24 ルームインジケータで複数部屋のリスト表示 zy END
	    		});
				// 2018/07/24 ルームインジケータで複数部屋のリスト表示 zy BEGIN
	    		if(!$j(this).hasClass("titleChanged") && roomNames.length > 0) {
	    			var blackElement = $j(this).find('.blackCream');
	    			var title = blackElement.attr("title");
	    			blackElement.attr("title",title + '\r\n' + roomNames.join('　'));
	    			$j(this).addClass("titleChanged")
	    		}
				// 2018/07/24 ルームインジケータで複数部屋のリスト表示 zy END
    		}
    	}
    }).mouseleave(function() {
    	var $this = $j(this);
    	var leadIndexId = $this.attr("leadIndexId");
    	if (leadIndexId != "") {
    		// 団体の部屋情報は全部取得、色を外す
    		// 2014/08/20 部屋割り当てキャンセル機能対応
    		//$j("div[leadIndexId='"+leadIndexId+"']").each(function() {
    		getContainerTeamGroupRooms(leadIndexId).each(function() {
    			//$j(this).removeClass("grouproom-ui-state-hover");
    			$j(this).css({"border-color":"white"});
    			$j(this).find('.blackCream').children().hide()
    			$j(this).find('.blackCream').css("visibility","hidden");
    		});
    	}
    });
    // 複数予約データが存在する場合、複数ICONをクリックすると、関連のDayUse一覧情報を表示する
    !notReadOnlyFlg || $j(".triangle-topright").click(function(e) {
    	// Event Stop
    	e.stopPropagation();
    	// DayUse情報画面を開く
        var $this = $j(this);
        var roomId = $this.attr("roomId");
        //$j('#chkroomId').val(p1);
        // 指定日取得
        var queryDate = getQueryDate();
        // 当日はチェックイン情報・チェックアウト情報表示制御フラグ
        var isShowTodayInfo = getShowTodayFlg();
        // DayUse情報表示URLを作成する
		var topLeadId = $j('#foot[roomId="'+ roomId +'"]').attr('leadUid');
        var url = "/apex/RoomIndicatorInfoDayUse?roomId=" + roomId + "&queryDate=" + queryDate + "&checkflag=" + isShowTodayInfo +"&topLeadId=" + topLeadId;
        // DayUse情報表示画面を開らく
        $j("#roomLeadListWindow").data("kendoWindow").refresh({
            url: url,
        });
        // 表示画面を開く
        $j("#roomLeadListWindow").data("kendoWindow").center();
        $j("#roomLeadListWindow").data("kendoWindow").open();

    });
    // 2019/07/31 20190527.04.タイムテーブル、ルームインジケータ、マルチタスク機能編集モードと読み込み専用モード対応必要 by zy BEGIN
    if (notReadOnlyFlg) {
    // 2019/07/31 20190527.04.タイムテーブル、ルームインジケータ、マルチタスク機能編集モードと読み込み専用モード対応必要 by zy END
	// キャンセル
    $j("#cancelBtn").click(function(e){
       	// Error Message Panel Clear[Attention: Error Class IDはSF設定依存]
       	$j("span[id$=':inputFormMsg']").hide();
        YAHOO.force.com.hideMe();
    });

	/**
	* Bind Event Clear
	**/
    //$j("[id$=':bNewRoomOK']").unbind("click");
    //$j("[id$=':bNewRoomNG']").unbind("click");
    //$j("[id$=':roomChangeBtn']").unbind("click");
	$j("#chgNightsBtn").unbind("click");
	$j("#chgNightsSaveBtn").unbind("click");
	
    // ルーム・チェンジBUTTON[泊数変更起動起動]
    $j("#chgNightsBtn").click(function(){
    	// ルーム・チェンジBUTTON非表示
        //$j(".roomChangeBtnTd").hide();
    	// 2016/11/07 予約キャンセル BEGIN   
        $j("[id$=':leadCancelCheckBtn']").hide();
    	// 2016/11/07 予約キャンセル END    
        $j("[id$=':leadCheckInBtn']").hide();
        $j("[id$=':leadCheckOutBtn']").hide();
        // 2019/02/28 滞在・外出状態の管理 WGCH BEGIN
        // 外出
        $j("[id$=':leadOutBtn'][showFlg='true']").hide();
        // 戻る
        $j("[id$=':leadReturnBtn'][showFlg='true']").hide();
        // 2019/02/28 滞在・外出状態の管理 WGCH END
        $j("#chgNightsBtn").hide();
        $j("#accBtn").hide();
        $j("#prtBtn").hide();
        $j("#cleanRoomBtn").hide();
        // 2017/12/29 レジカードは泊数変更の場合、該当ボタンを非表示する
        $j("#cardbtn").hide();
        $j("#chgNightsSaveBtn").show();
        // ルーム・チェンジ情報入力BLOCK
        $j(".roomChangeTd").show();
		// ルーム・チェンジ部屋設定
        //$j("[id$=':bNewRoom']").focus();
        // 時刻変更機能
        $j(".timeChangeTd").show();
        // XML___wgch 2016/11/16 BEGIN
        $viewData = $j("[id$=':bComment3__c']");
        $viewData.hide();
        CKEDITOR.jinya.initInstance($j, "ckeditorClass2");
        CKEDITOR.instances["chgMemoEditor"].setData($viewData.html());
		// XML___wgch 2016/11/16 END
		$j("td[class*=contact] span[id$=showColumn]").hide();
		$j("[id*=editColumn]").show();
    });
    // 泊数変更の保存機能呼び出し[泊数変更により、設定内容はオブジェクトへ反映する]
    $j("#chgNightsSaveBtn").click(function(){
   
		// 事前チェックを行う
		// 新泊数は２以上の場合、チェックを行う
		var newNights = 1*$j("input[id$=':bInputNights']").val();
		var orgNights = 1*$j("input[id$=':bHidNightId']").val();
		// 予約人数
        var newStayPeo = 1*$j("input[id$=':bInputStayPersons']").val();
        var orgStayPeo = 1*$j("input[id$=':bHidPeopleNumId']").val();
		// 時刻関連
		var newSTime = $j("select[id$=':bInputField4__c']").val();
		var orgSTime = $j("span[id$=':bField4__c']").text();
		var newETime = $j("select[id$=':bInputField3__c']").val();
		var orgETime = $j("span[id$=':bDepartureTime__c']").text();
		// XML___wgch 2016/11/16 BEGIN
        CKEDITOR.jinya.copyValue($j, "ckeditorClass2");
		var newComment = $j("#chgMemoEditor").val();
		var orgComment = $j("[id$=':bComment3__c']").html();
        
		var isUpdContactFlag = false;
		// 2021/03/31 9914 BUG FIXED by zy BEGIN
		$j("[id$=editColumn]").each(function(){
			var orgValue = $j(this).closest("span").find("span[id='showColumn']").text();
			if($j(this).val() != "" && $j(this).val() != null && orgValue != $j(this).val()){
				isUpdContactFlag = true;
				return false;
			}
		});
		// 2021/03/31 9914 BUG FIXED by zy END
		// XML___wgch 2016/11/16 END
        // 処理終了
		if (newNights == orgNights && newStayPeo == orgStayPeo &&
			newSTime == orgSTime && newETime == orgETime && newComment == orgComment && !isUpdContactFlag) {
			$j("#cancelBtn").click();
			return true;
		}
		// 時刻は非設定する場合、エラー表示
		if (newSTime == "" || newETime == "") {
		//出発時刻と到着時刻を指定して下さい
			alert("{!$Label.MSG_008_0077}");
			return false;
		}
		// SFへ反映の時刻をHID項目に反映する
		$j("input[id$=':bHidEntryTime']").val(newSTime);
		$j("input[id$=':bHidDepartureTime']").val(newETime);
		
		var Comment = newComment != orgComment ? newComment : orgComment;
		$j("input[id$=':bHidComment3']").val(Comment);
		// 期間短縮の場合、チェック対象外
		if ( newNights <= 1 || orgNights >= newNights || isUpdContactFlag) {
			// 日帰りに変更する場合、時刻順番をチェックを行う
			if (newNights == 0) {
				if (newSTime > newETime) {
				//出発時刻には到着時刻以降の時刻を指定して下さい
					alert("{!$Label.MSG_008_0078}");
					return false;
				}
			}
			blockUi();
			if(isUpdContactFlag) $j("input[id$=hidContact]").val(isUpdContactFlag);
			chgSaveNightsInfoFun();
			
		} else {
		
			// 指定日取得
			var queryDate = getQueryDate(); //$j("input[id$=':gotoDate']").length > 0 ? $j("input[id$=':gotoDate']").val() : "";
			// 指定した予約ID
			var queryLeadId = $j("input[id$=':leadIdHidden']").val();
			// 照会する部屋ID
			var queryRoomId = $j("input[id$=':bHidRoomId']").val();
			// 当日はチェックイン情報・チェックアウト情報表示制御フラグ
			var isShowTodayInfo = getShowTodayFlg();
			
			blockUi();
			// 事前チェックを行う
			Visualforce.remoting.Manager.invokeAction(
			   "{!$RemoteAction.RoomIndicatorInfo.preChgSaveNightsInfo}", queryRoomId,queryLeadId,orgNights,newNights,queryDate,isShowTodayInfo, function(result, event){
		        // 異常
		     	if(event.type == 'exception') {
		            alert(event.message);
		            gobalToElement.removeClass("drop-ui-state-hover");
		            unblockUi();
		     	} else {
		     		if (result.errMsg == "" && result.infMsg == "" ) {
						// Memory更新
						chgSaveNightsInfoFun();
		     		} else {
		     			if (result.errMsg != "" ) {
		     				alert(result.errMsg);
							unblockUi();
		     			} else {
			     			// 既存の予約が存在する場合
			     			if(window.confirm(result.infMsg)) {
			     				chgSaveNightsInfoFun();
			     			} else {
								unblockUi();
			     			}
		     			}
		     		}
				}
		    });
		} // End if ( (1 * newNights ) <= 1)
    });
	// 2019/07/31 20190527.04.タイムテーブル、ルームインジケータ、マルチタスク機能編集モードと読み込み専用モード対応必要 by zy BEGIN
	}
	if(!JS_SYS_DEVICE_MOBILE_FLG && notReadOnlyFlg){
	// 2019/07/31 20190527.04.タイムテーブル、ルームインジケータ、マルチタスク機能編集モードと読み込み専用モード対応必要 by zy END
	// アサインできる部屋にAction　Bindする
	$j(".roomblock, .roomcanmove").kendoDropTarget({
		filter:".isAssignedStatus",
	    dragenter: droptargetOnDragEnter,
	    dragleave: droptargetOnDragLeave,
	    drop: droptargetOnDrop
	});
	
	// 空室「部屋アサイン済み、未チェックインの部屋」
	// 泊中も移動可能に対応する「2013/06/16」
	
	$j(".blackCream").kendoDraggable({
		hint: function(e) {
			dragLeadElement = $j(e).clone();
			// 2020/09/30 7743 bug fixed by zy BEGIN
			var footDiv = $j(e).children().closest("td").find("#foot");
			if ($j(e).children().attr("isBlocked").toLowerCase() == "true" || footDiv.filter(".isAssignedStatus,.isStayStatus,.isOneDayStayStatus").length == 0) {
				this.cantmoveFlg = true;
			// 2020/09/30 7743 bug fixed by zy END
				return;	
			}
			if($j(e).hasClass("blackCream")){
				dragLeadElement = $j(e).find("div").clone().css({"visibility": "visible","display" :"true"});
			}
			return dragLeadElement;
		},
		dragstart:function(e){
			// 2020/09/30 7743 bug fixed by zy BEGIN
			if (this.cantmoveFlg ) {
				e.preventDefault();
				delete this.cantmoveFlg;
			}
			// 2020/09/30 7743 bug fixed by zy END
		}
	});
	// 2020/09/30 当日チェックアウトの日帰り予約がチェックイン後にルームチェンジできなくなる不具合の解消 by zy BEGIN
	$j(".isAssignedStatus,.isStayStatus,.isOneDayStayStatus").kendoDraggable({
	// 2020/09/30 当日チェックアウトの日帰り予約がチェックイン後にルームチェンジできなくなる不具合の解消 by zy END
		hint: function(e) {
			dragLeadElement = $j(e).clone();
			if ($j(e).attr("isBlocked").toLowerCase() == "true") {
				return;	
			}
			if($j(e).hasClass("blackCream")){
				dragLeadElement = $j(e).clone().css({"visibility": "visible"});
			}
			return dragLeadElement;
		},
	});
	}
	/*
	// Tip Info Bind
	$j(".triangle-topright,.leftBlockImg").kendoTooltip({
		width: 120,
		position: "top"
	}).data("kendoTooltip");
	*/
	/*
	// Right ContextMenu Disable
	$j(".isCleanStatus").bind("contextmenu",function(e){
		return false;
	});
	*/
	// Right ContextMenu Disable

	/* 2013/10/09 ContextMenu機能削除する
	// Block Right ContextMenu Add
	$j.contextMenu({
       selector: '.isCanContextMenu',
       callback: function(key, options) {
           //var m = "clicked: " + key;
           if (key == "cleanRoom") {
		        var roomId = $j(this).attr("roomId");
		        var leadId = $j(this).attr("leadId");
				// 部屋クリア処理を行う
				roomCleanActComm(leadId,roomId);
           }
           //window.console && console.log(m) || alert(m);
       },
       //autoHide : true,
       items: {
           "cleanRoom": {name: "清掃済", icon: "clean"},
           //"sep1": "---------",
           //"quit": {name: "Quit", icon: "quit"}
       }
	});*/
	// DB READ();
	//noAssingLeadInfoDs.read();
	
	//$j("#table").stickyTableHeaders();
	// *****************************
	// 2015/10/28 CTI->PAST機能対応
	// *****************************
    _call_pasteInfo();
	// 2019/07/31 20190527.04.タイムテーブル、ルームインジケータ、マルチタスク機能編集モードと読み込み専用モード対応必要 by zy BEGIN
	if (notReadOnlyFlg) {
	// 2019/07/31 20190527.04.タイムテーブル、ルームインジケータ、マルチタスク機能編集モードと読み込み専用モード対応必要 by zy END
    // *****************************
    // 予約新規登録機能起動（2014/04/15)
    // *****************************
    $j("img[name='accountPopup']").unbind("click");
     // お客様情報を選択する
    $j("img[name='accountPopup']").click(function() {
		var lkfmVal = $j("form[id$=':createForm']").attr("id");
		var lknmVal= $j("input[id$=':relcontact']").attr("id");
		var lktpVal ="003";
		// 2017/08/08 SFのJavascriptからパラメータ指定ENCODE化対応 by zh BEGIN
		var lksrchVal =  encodeURIComponent($j("input[id$=':relcontact']").val());
		// 2017/08/08 SFのJavascriptからパラメータ指定ENCODE化対応 by zh END
		var url = "/_ui/common/data/LookupPage?lkfm=" + lkfmVal + "&lknm=" +lknmVal + "&lktp=" + lktpVal; 
		openLookup(url, 670, '1', "&lksrch=" + lksrchVal);
		// 2021/03/31 予約ポップやルームインジケータから予約作成する際に郵便番号検索が使えるようにして欲しい by zy BEGIN
		if ("jinyaZipCodeSearceBind" in window) {
			jinyaZipCodeSearceBind(curPopupWindow);
		}
		// 2021/03/31 予約ポップやルームインジケータから予約作成する際に郵便番号検索が使えるようにして欲しい by zy END
    });
    // 新規予約画面起動用
    $j(".addNewEventIcon").click(function(e) {
    	LookupHoverDetail.hideAllHovers();
    	// Input Form Show
    	YAHOO.force.com.showCreateLead();
		// 初期値設定を行う
    	var obj = $j(this).parents('#container')
    	setValue(obj); 
    	// Event Stop
    	e.stopPropagation();
    });
    // お客名はクリアする場合、自動的にIDをクリアする
    $j("input[id$=':relcontact']").blur(function() {
        if ($j(this).val() == "") {
            $j("input[id$=':relcontact_lkid']").val("");
            $j("input[id$=':relcontact_lkold']").val("");
            $j("#relcontact_lkid_org").val("");
            $j("input[id$=':katakana']").val("");
            $j("input[id$=':kanaName']").val("");
            $j("input[id$=':custPhone']").val("");
        }
    });
	// お客名にて、自動予約名に設定を行う
    $j("input[id$=':leadName']").focus(function() {
        autoSetupLeadName();
    });
    // 顧客変更する場合、顧客情報を自動取得、基本情報を画面に設定する　
    $j("[id$=':relcontact']").on('blur', function(){
		// 2017/02/14  お客様自定义关联的字段的值自动设定 FIX by zh BEGIN
		var mapContactPingField = $j("input[id$=hidContactMapFields]").val();
		var mapContactPingFieldLst = mapContactPingField.split(',');
		var contactFieldToPath = new Object();
		for (var i = 0; i < mapContactPingFieldLst.length ; i++) {
			if(mapContactPingFieldLst[i] == "" || mapContactPingFieldLst[i] == null) continue;
			var mapContactPingFieldSobj = mapContactPingFieldLst[i].split(':');
			contactFieldToPath[mapContactPingFieldSobj[0]] = mapContactPingFieldSobj[1];
		}
		// 2017/02/14  お客様自定义关联的字段的值自动设定 FIX by zh END
         var $this = $j(this);
         // 設定内容が存在する場合
         if ($this.val() != "") {
             // Content Changed
             if ($j("#relcontact_lkid_org").val().substring(0,15) != $j("input[id$=':relcontact_lkid']").val().substring(0,15)) {
                 // お客様情報のID情報を格納する
                 $j("#relcontact_lkid_org").val($j("input[id$=':relcontact_lkid']").val());
                 // 顧客情報を更新する
                 var contactId = $j("input[id$=':relcontact_lkid']").val();
                 var contactName = $this.val();
		 // 2017/01/25 新規画面の項目自定義機能　by　zy　BEGIN
                 var contactFields = $j("input[id$=hidContactInsertField]").val();
		 // 2017/01/25 新規画面の項目自定義機能　by　zy　END
                 blockUi();
                 // 既に定義する売価はプランカラ取得、画面に設定する
                 Visualforce.remoting.Manager.invokeAction(
		 // 2017/01/25 新規画面の項目自定義機能　by　zy　BEGIN
                 //"{!$RemoteAction.RoomIndicatorInfo.refreshContcatInfo}", contactId,contactName, function(result, event){
                 "{!$RemoteAction.RoomIndicatorInfo.refreshCustomContcatInfo}", contactId,contactFields, function(result, event){
		 // 2017/01/25 新規画面の項目自定義機能　by　zy　END
		     if(event.type == 'exception') {
                         alert(event.message);
                     } else {
		// 2017/01/25 新規画面の項目自定義機能　by　zy　BEGIN
                     	if (result != undefined){
                     		for (key in result){
                     			if (typeof(key) == 'string') {
                     				var resValue = result[key];
                     				var contactEle = $j("[class~='contact_" + key + "']","[id$=createPageBlock]");
                     				if(contactEle.length > 0){
                     					if(contactFieldToPath[key] != undefined) {
                     						// お客様自定义关联的日期型字段
                     						if (contactFieldToPath[key] == "Date") {
                     							$j("input,select,textarea",contactEle).val(kendo.toString(new Date(resValue),'{!DateFormatStr}'));
                     						// お客様自定义关联的datetime型字段
                     						}else if (contactFieldToPath[key] == "DateTime") {
                     							$j("input,select,textarea",contactEle).val(kendo.toString(new Date(resValue),'{!DateTimeFormatStr}'));
                     						// お客様自定义关联的checkbox型字段
                     						}else if(contactFieldToPath[key] == "Boolean"){
                     							//チェック
                     							if(resValue){
													$j("input,select,textarea",contactEle).prop("checked",true);
									    		//チェックなし
									    		}else {
													$j("input,select,textarea",contactEle).prop("checked",false);
									    		}
                     						}else $j("input,select,textarea",contactEle).val(resValue);
                     						
                     					}else $j("input,select,textarea",contactEle).val(resValue);
                     				}
                     			}
                     		}
                   		}
		
                         // 取得するお客様情報を画面に設定する
						/*
                         $j("input[id$=':katakana']").val(result.KatakanaName);
                         $j("input[id$=':kanaName']").val(result.KanaName);
                         $j("input[id$=':custPhone']").val(result.phone);
                         */
			 // 2017/01/25 新規画面の項目自定義機能　by　zy　END
                         // 予約名自動設定を行う
                         autoSetupLeadName();
                     }
                     // 画面解除する
                     unblockUi();
                 });
             }
	 // 2017/01/25 新規画面の項目自定義機能　by　zy　BEGIN    
         } else {
         	$j("[class*=contact_]","[id$=createForm]").each(function(){
         	});
         }
	 // 2017/01/25 新規画面の項目自定義機能　by　zy　END
         clearAutoCompletePanel();
     });
		
		// 2016/12/28 连接plan页面替换标准页面  begin by wx
    	$j("img[name='planPopup']").unbind("click");
    	$j("img[name='planPopup']").click(function() {    		
    		ctrllId = $j("input:hidden[id$=':planItem:plan_lkid']").get(0);      
	        ctrllNm = $j("input:text[id$=':planItem:plan']").get(0);
	        objs = new Array(ctrllId, ctrllNm);
	        commUtils.popup("/apex/PlanSearch" ,"PlanSearch",objs, null, null, popupplanCallback());
	        //planRest();
	    });	    
	    // 2016/12/28 连接plan页面替换标准页面  end by wx   
	 
 		// プランを切り替えする場合、関連のプラン明細・非表示制御追加
		
	    $j("input[id$=':plan']").unbind("change");
	    $j("input[id$=':plan']").change(function (){
	    	// 2016/12/28 连接plan页面替换标准页面  begin by wx
			// 2017/07/28 change清空id导致选择的plan也被清空 by zy BEGIN
			//$j("input:hidden[id$=':planItem:plan_lkid']").val("");
			// 2017/07/28 change清空id导致选择的plan也被清空 by zy END
	    	// 2016/12/28 连接plan页面替换标准页面  end by wx 
	        // 2015/10/28 プラン明細表示のRESET
	        planRest();
	    })
	    
	// 2016/10/13 BEGIN by zh
	if (detailEventFlag)
	    	JINYACONNECT.CUSTOM.detailBindEvent();
	else{
	// 2016/10/13 END by zh
	$j("#planCustomeBtn").unbind("jinyaPlanExtend");
	$j("#planCustomeBtn").jinyaPlanExtend({
        selectorRoot : $j("#planCustomeBtn").parent().parent().parent().parent(),
        planInputField : $j("input[id$=':planItem:plan_lkid']"),
        //planId : planIdVal,
        colspanNum : 4,
        planSetupSyncField : $j("input[id$=':nl_hidPlanDetailInfo']"),
        startfun : blockUi,
        endfun : unblockUi,
		actionOpenImg : "{!URLFOR($Resource.AppImages, 'extend/jiahao.png')}",
		actionCloseImg: "{!URLFOR($Resource.AppImages, 'extend/jianhao.png')}",
        remotePlanQuery  : "{!$RemoteAction.RoomIndicatorInfo.getPlanDetailListById}",
        remoteProdQuery  : "{!$RemoteAction.RoomIndicatorInfo.getArrayProductItemInfo}",
        labels : {NOFOUND:"{!JSENCODE($Label.MSG_006_0235)}",PRODUCTNM:"{!JSENCODE($Label.MSG_006_0212)}",UNITPRICE:"{!JSENCODE($Label.MSG_006_0213)}",SUMMARY:"{!JSENCODE($Label.MSG_006_0402)}"}
	});
	// 2016/10/13 BEGIN by zh
	}
	// 2016/10/13 END by zh
	// 2019/07/31 20190527.04.タイムテーブル、ルームインジケータ、マルチタスク機能編集モードと読み込み専用モード対応必要 by zy BEGIN
	}
	// 2019/07/31 20190527.04.タイムテーブル、ルームインジケータ、マルチタスク機能編集モードと読み込み専用モード対応必要 by zy END
	$j("div #foot").each(function(){
		var leadId = $j(this).attr("leadUid");
		if(leadId != '' && leadId != null)
		{
			var msgId = roomNmTypeFlg ?  $j(this).attr("contactId") : leadId;
			var isBlocked =  $j(this).attr("isBlocked");
			wrapHoverMiniWin(this,msgId,leadId,isBlocked);
		}
	});
	// お客様名・予約名切替機能
	$j("select[id$=':roomNameSelect'],select[id$=':statusSelect']").css({width:110, fontSize: 13,padding:0}).kendoDropDownList();

	// 指定日項目は画面に表示される場合、下記処理を行う
	if ($j("span[id$=':calendarPanel']").length > 0) {
		// 指定日関連の日付表示情報（客室文言表示も含めて、場所を設定する) 
		var $orgXp=$j("span[id$=':calendarPanel']").positionRelative("BODY");
		var $tarParentXp=$j("#gotoDateLbTh").positionRelative("BODY");
		// 2017/12/22 画面フィルター機能追加　by　zy　BEGIN
		var filterWidth = $j("#filterInput").width();
		var orgLeft = $orgXp.left-$tarParentXp.left;
		if (orgLeft < filterWidth) orgLeft = filterWidth + 50;
		$j("#gotoDateLB").css({top: 4, left: orgLeft, position:'absolute'});
		// 2017/12/22 画面フィルター機能追加　by　zy　END
	}
	// 2020/06/15 予約ポップのデフォルト字段エラー修正 by zy BEGIN
	$j("#createLeadFormresetbtn").unbind('click');
	// レセット昨日対応
	$j("#createLeadFormresetbtn").bind("click",function(){
		// 該当予約新規画面の選択項目、デフォルト値再設定
		$j(this).closest("form").find("select").each(function(){
			// 選択項目フィルター
			$j("option",this).prop('selected', function() {
				return this.defaultSelected;
			});
		});
	});
	// 2020/06/15 予約ポップのデフォルト字段エラー修正 by zy END
	$j("#gotoDateLB").show();
	startRunning();
	// 2019/11/15 ルームインジケータの表示について、清掃済だけでなくインスペ完の状況を追加したいです。 by zy BEGIN
	initCleanCnt();
	// 2019/11/15 ルームインジケータの表示について、清掃済だけでなくインスペ完の状況を追加したいです。 by zy END
}
// 2016/12/28 连接plan页面替换标准页面  begin by wx 
function popupplanCallback() {
	return function () {
		planRest();
	}
}
// 2016/12/28 连接plan页面替换标准页面  end by wx 

// 画面の指定日情報を取得する
function getQueryDate() {
	// 指定日取得
	return $j("input[id$=':gotoDate']").length > 0 ? $j("input[id$=':gotoDate']").val() : kendo.toString(new Date(), JINYACONNECT.DateFormat );
}
// 部屋清掃処理起動
function roomCleanAct(that, isCheckTeamFlg) {
	// 指定した予約ID
	//var queryLeadId = $j("input[id$=':leadIdHidden']").val();
	// 照会する部屋ID
	var queryRoomId = $j("input[id$=':bHidRoomId']").val();
	// 該当予約と同じ予約IndexIdを取得する
	//一括清掃よろしいですか
	var confirmMsg = "{!$Label.MSG_008_0108}";
	// 清掃部屋リスト
	var roomIds = new Array();
	roomIds.push(queryRoomId);
	// 初期値設定
	//$j('input[id$="bHidGroupLeadId"]').val("");
	$j('input[id$="bHidGroupFlg"]').val(false);	// 一括チェックインなし
	// 予約インデクスIDを取得する
	var leadIndexId = $j('input[id$="bHidLeadIndexId"]').val();
	// 空室の部屋が清掃処理以外の場合
	if (leadIndexId != "") {
		// 同じの予約インデクスの部屋リストを取得する
		var grouprooms = getContainerTeamGroupRooms(leadIndexId);
		// 一括チェックイン機能起動 && 団体予約の場合
		if(isCheckTeamFlg && grouprooms.length > 1) {
			if(confirm(confirmMsg)) {
				$j('input[id$="bHidGroupFlg"]').val(true);
	   			// 団体の部屋情報は全部取得、色を設定する
	    		grouprooms.each(function() {
	    			roomIds.push($j(this).attr('roomid'));
	    		});
			}
		}
	}
	// 部屋クリア処理を行う
	roomCleanActComm(roomIds);
}
function roomCleanActComm(queryRoomId) {
	blockUi();
	// 検索条件を設定する 
	var queryDate = getQueryDate();
	// make AJAX request to the remote service
	Visualforce.remoting.Manager.invokeAction(
	 "{!$RemoteAction.RoomIndicatorInfo.cleanRoomAction}", queryRoomId,queryDate, 
	 function (result, event) {
	    // 異常
	 	if(event.type == 'exception') {
	        alert(event.message);
	        unblockUi();
	 	} else {
			// 処理完了
			refreshPageFun();
		}
	},{escape: true});
	
}
function wrapHoverMiniWin(element,msgId,leadId,isBlocked)
{
	var dlhFlg = {!rLookupHoverIsShowFlg};
	if(dlhFlg == true) { 
	var msgWinId = (msgId != leadId) ? ('window_message_' + leadId + '_' + msgId) : ('window_message_' + msgId);
	var msgLink = "<span  id='"+ msgWinId +"' isBlocked='" + + "'  onblur='LookupHoverDetail.getHover(\""+ msgWinId +"\").hide();' onfocus='LookupHoverDetail.getHover(\""+ msgWinId +"\", \"/"+ msgId +"/m?retURL=%2F"+ msgId + "&isAjaxRequest=1\").show();' onmouseover='LookupHoverDetail.getHover(\""+ msgWinId +"\", \"/"+ msgId +"/m?retURL=%2F"+ msgId + "&isAjaxRequest=1\").show();' onmouseout='LookupHoverDetail.getHover(\""+ msgWinId +"\").hide();'></span>" ;
	
	$j(element).wrap(msgLink);
	}
}
// Room　Change後のJS処理
function roomChangeAfterAct() {
	$j("#cancelBtn").click();
}
// 2017/05/12 部屋詳細情報画面レジカード機能対応 zyz BEGIN
var g_cashRegSwithCode = "{!JSENCODE($Setup.CommDefine__c.ps__CashRegisterSwitchCode__c)}";
function openyadoPdf() {
   	var yadoId = $j("input[id$=':yadoIdHidden']").val();
   	var switchCode = g_cashRegSwithCode;
   	// 2020/02/29 レジカードのロゴを出力した部屋の「店舗情報」対応 BY zyz BEGIN
   	var openUrlPlus = "";
   	/*
	// 予約確認書４の場合
	// 2017/05/25 署名PDF5機能 zyz BEGIN
	if ( switchCode == "4" || switchCode == "5") {
	// 2017/05/25 署名PDF5機能 zyz END
		//金額を表示しますか？
		if (window.confirm( "{!$Label.MSG_012_0133}")) {
			openUrlPlus = "&smy=1";
		}
	}*/
	// 2020/02/29 レジカードのロゴを出力した部屋の「店舗情報」対応 BY zyz END
	// 2017/10/23 全画面サイン、画像ファイルに保存の改善対応 zyz BEGIN
	var SignFlg = "{!isCashRegisterSignFlg}";
	// 2020/02/29 レジカードのロゴを出力した部屋の「店舗情報」対応 BY zyz BEGIN
	// 判断打开的是否为签名页面
	var canvasFlg = (SignFlg =="true" && (switchCode == "4" || switchCode == "5" || switchCode == "7" || switchCode == "8"));
	var shops = $j("[id$='hidshopLstId']").val();
	if(shops != "") { 
		var yadoUrl = "?id="+yadoId;
		openGuestWindow(yadoUrl,canvasFlg,shops);
	}else {
	if ( switchCode == "4" || switchCode == "5") {
		//金額を表示しますか？
		if (window.confirm( "{!$Label.MSG_012_0133}")) {
			openUrlPlus = "&smy=1";
		}
	}
	// 2020/02/29 レジカードのロゴを出力した部屋の「店舗情報」対応 BY zyz END
		// 2019/10/30 レジカード8のカスタマイズ機能の改善 BY zyz BEGIN
		if (SignFlg == "true" && (switchCode == "4" || switchCode == "5" || switchCode == "7" || switchCode == "8")){
			var openUrl = "{!URLFOR('/apex/CashRegisterCardSignSwitch')}"+"?id="+yadoId + openUrlPlus;
		/*
		// 2019/10/30 レジカード8のカスタマイズ機能の改善 BY zyz END
		if (SignFlg == "true" && switchCode == "4"){
			var openUrl = "{!URLFOR('/apex/CashRegisterCardPDF4Sign')}"+"?id="+yadoId + openUrlPlus;
		} else if (SignFlg == "true" && switchCode == "5"){
			var openUrl = "{!URLFOR('/apex/CashRegisterCardPDF5Sign')}"+"?id="+yadoId + openUrlPlus;
		// 2018/07/17 レジカードコード7の署名機能追加 zyz BEGIN
		} else if (SignFlg == "true" && switchCode == "7"){
			var openUrl = "{!URLFOR('/apex/CashRegisterCardPDF7Sign')}"+"?id="+yadoId + openUrlPlus;
		// 2018/07/17 レジカードコード7の署名機能追加 zyz END
		// 2019/10/30 レジカード8のカスタマイズ機能の改善 BY zyz BEGIN
		} else if (SignFlg == "true" && switchCode == "8"){
			var openUrl = "{!URLFOR('/apex/CashRegisterCardPDF8Sign')}"+"?id="+yadoId + openUrlPlus;
		*/
		// 2019/10/30 レジカード8のカスタマイズ機能の改善 BY zyz END
		} else {
			var openUrl = "{!URLFOR('/apex/CashRegisterCardPDFSwitch')}"+"?id="+yadoId + openUrlPlus;
		}
		window.open(openUrl, "CashRegisterCardPDF","width=780, height=980,scrollbars=no,toolbar=no,menubar=no,status=no,directories=no,resizable=no");
		// 2017/10/23 全画面サイン、画像ファイルに保存の改善対応 zyz END
		// 画面閉じる
		$j("#cancelBtn").click();
	// 2020/02/29 レジカードのロゴを出力した部屋の「店舗情報」対応 BY zyz BEGIN
	}
	// 2020/02/29 レジカードのロゴを出力した部屋の「店舗情報」対応 BY zyz END
}
// 2017/05/12 部屋詳細情報画面レジカード機能対応 zyz END
// 2020/02/29 レジカードのロゴを出力した部屋の「店舗情報」対応 BY zyz BEGIN
function openGuestWindow(yadoUrl,canvasFlg,shops){
	var _g_ns = "{!JSENCODE($Setup.CommDefine__c.AppNS__c)}";
	var locNs = (_g_ns.length > 2) ? (_g_ns.slice(0,-2) + ".") : "";
	// 店铺处理
    var locShopCode = "{!$User.ShopCode__c}"; 
    var locShopHtmls = ""; 
    if (locShopCode.indexOf(",") > 0) { 
        var locOptStr = ""; 
        // 選択できる店舗リストを取得する 
        var currUsrId = "{!$User.Id}"; 
        var defaultShop = "{!$User.DefaultShopCode__c}"; 
        // var shops = JSON.parse($j("[id$='hidshopLstId']").val());
        shops = JSON.parse(shops);
        for(i=0;i<shops.length;i++) { 
            var shopinf = shops[i].split(":"); 
            locOptStr +="<option value='"+shopinf[0]+"'"+ (defaultShop == shopinf[0] ? ' selected' : '') +">" +shopinf[1] +"</option>"; 
        }
        if (locOptStr != "") { 
            //店舗 
            locShopHtmls = '<tr><td class="labelCol first " width="120px"><label>{!$Label.MSG_006_0241}</label></td><td class="data2Col first "><select id="dialog_shopcd" style="max-width: 170px;">' + locOptStr + '</select></td></tr><tr><td colspan="2" style="width:350px;height:2px"></td></tr>'; 
        } 
    }
    // 店铺选择列表为空，直接打开PDF
    if(locShopHtmls != ""){
		var d = sfdcPage.dialogs['MyCoolDialog'], close;
		if (!d) {
			// if the dialog doesn't exist create one
			d = sfdcPage.dialogs['MyCoolDialog'] = new SimpleDialog('MyCoolDialog', false);
			// set general information on your dialog and finally run the create function
			d.setWidth(380);
			d.createDialog();
		}
		d.setTitle('レジカード');
		// 按钮显示
		var buttonIdStr = 'dialog_printoutBtn';
		if(canvasFlg) buttonIdStr = 'dialog_canvasBtn';
		var buttonHtml = '<input class="btn" id="'+buttonIdStr+'" style="width: 100px" type="button" value="確定" /></td>';
		// 金額を表示しますか？
		var symHtml = '';
		var smyUrl = '';
		var switchCode = g_cashRegSwithCode;
		if(switchCode == "4" || switchCode == "5"){
			symHtml = '<tr><td class="labelCol first " width="120px"><label>{!$Label.MSG_012_0133}</label><td class="data2Col first "><input type="checkbox" id="dialog_symId" checked="checked" value="" /></td>';
		}
		$j(d.dialog).find('#MyCoolDialogInner').html('<div class="pbBody"><div><div class="pbSubsection"><table class="detailList" border="0" cellpadding="1" cellspacing="1">' + locShopHtmls + symHtml +'<tr><td colspan="2" style="text-align: right;"><input class="btn" id="dialog_cancelBtn" style="width: 100px" type="button" value="キャンセル" />    '+buttonHtml+'</tr></table></div></div></div>');
		// 按钮事件
		$j(d.dialog).find('input[type="button"]').on('click', function() {
			var btnId = $j(this).attr("id");
			if (btnId == "dialog_cancelBtn") {
				d.hide();
			} else if (btnId == "dialog_printoutBtn") {
				var openUrl = "{!URLFOR('/apex/' & $Setup.CommDefine__c.AppNS__c & 'CashRegisterCardPDFSwitch')}"+yadoUrl;
				var custNameUrl = "";
				var selectShopLen = $j("#dialog_shopcd").length; 
				var selectShopVal = $j("#dialog_shopcd").val(); 
				if (selectShopLen > 0 && selectShopVal != "") { 
					custNameUrl += "&shopcd=" + encodeURIComponent(selectShopVal); 
				}
				var symFlg = $j("#dialog_symId").prop('checked');
				if(symFlg) smyUrl = '&smy=1';
				window.open(openUrl + custNameUrl + smyUrl,"CashRegisterCardPDF","width=780, height=980, menubar=no, toolbar=no, scrollbars=yes");
				d.hide();
			} else if (btnId == "dialog_canvasBtn") {
				var openUrl = "{!URLFOR('/apex/CashRegisterCardSignSwitch')}"+yadoUrl;
				var custNameUrl = "";
				var selectShopLen = $j("#dialog_shopcd").length; 
				var selectShopVal = $j("#dialog_shopcd").val(); 
				if (selectShopLen > 0 && selectShopVal != "") { 
					custNameUrl += "&shopcd=" + encodeURIComponent(selectShopVal); 
				}
				var symFlg = $j("#dialog_symId").prop('checked');
				if(symFlg) smyUrl = '&smy=1';
				window.open(openUrl + custNameUrl + smyUrl,"CashRegisterCardPDF","width=780, height=980, menubar=no, toolbar=no, scrollbars=yes");
				d.hide();
			}
			
		});
		d.show();
		// 画面閉じる
		$j("#cancelBtn").click();
	}
}
// 2020/02/29 レジカードのロゴを出力した部屋の「店舗情報」対応 BY zyz END
// 会計
function openAccWindos() {
   	var accId = $j("input[id$=':accIdHidden']").val();
   	//YAHOO.force.com.hideMe();
	window.open("/" + accId+"/e?retURL=/" + accId);
	// 画面閉じる
	$j("#cancelBtn").click();
}
// 印刷ボタン
function openAccPdfs() {
	var div = document.createElement('div');
	div.innerHTML = $j("#pdfurlHid").val();
	var url = div.firstChild.nodeValue;
	//console.debug(url);
	window.open(encodeURI(url));
	// 画面閉じる
	$j("#cancelBtn").click();
}
// Get RoomDetail Info By Ajax
// 該当部屋にアサインされた予約明細情報を取得、表示を行う
function ajaxGetRoomInfo(roomId, leadId, isCleanFlg) {
    // 2019/05/30 こちらをルームインジケータ上からも1日単位の作成、削除（削除だけでもほしい）by zy BEGIN
    let{bad} = this;
    // 2019/05/30 こちらをルームインジケータ上からも1日単位の作成、削除（削除だけでもほしい）by zy END
	// XML___wgch 2016/11/16 BEGIN
	var leadField =$j("input[id$=bHidLeadFields]").val();
	var contactFields = $j("input[id$=bHidContactFields]").val();
	Visualforce.remoting.Manager.invokeAction(
	    '{!$RemoteAction.RoomIndicatorInfo.getRoomInfoExt}',
	// XML___wgch 2016/11/16 END    
	    roomId,leadId,leadField,contactFields,
	    function(result, event){
	        if (event.status) {
	            if(result== null || result.length == 0){
	            //データ詳細がありません。
	                alert("{!$Label.MSG_008_0030}");
	            }else{
	            	// 清掃ステータスは設定を行う
	            	result._isCleanFlg = isCleanFlg;
					// 2019/05/30 こちらをルームインジケータ上からも1日単位の作成、削除（削除だけでもほしい）by zy BEGIN
                    result._isBadFlg = bad;
		    		// 2019/05/30 こちらをルームインジケータ上からも1日単位の作成、削除（削除だけでもほしい）by zy END
                    YAHOO.force.com.showMe(result);
	            }

	        } else if (event.type === 'exception') {
	        	//error データ詳細がありません。
	            alert("{!$Label.MSG_008_0031}");
	        } else {
	        	//noknown error データ詳細がありません。
	            alert(" {!$Label.MSG_008_0032}");
	        }
	    },
	    {escape: true}
	);
}
// ------------------------------
// 部屋AREAに入る場合、css設定
// ------------------------------
function droptargetOnDragEnter(e) {
	if (dragLeadElement == null) {
		e.preventDefault();
		return;
	}
	/* 2018/06/26 故障時間外ご予約登録できるように改善対応 by zy BEGIN
	if(e.dropTarget.data("class") == "isBadStatus"){
		e.preventDefault();
    		return;
	}
	2018/06/26 故障時間外ご予約登録できるように改善対応 by zy END*/
	var fromuid = dragLeadElement.attr("roomtypeuid");
	var fromroomid = dragLeadElement.attr("roomId");
	var touid = e.dropTarget.attr("roomTypeId");
	var toroomid = e.dropTarget.attr("roomId");
	var toleadid = e.dropTarget.attr("leadid");
    // 該当部屋はロックされる場合、割り当て不可制御
	if (typeof dragLeadElement.attr("isBlocked") != "undefined" && 
		dragLeadElement.attr("isBlocked").toLowerCase() == "true") {
		e.preventDefault();
		return;	
	}
	//2017/03/13 ルームインジケーターにて、すでに宿泊予約で部屋変更不可の予約が入っている部屋に、アサインができるように改善対応 by zy BEGIN
	if (fromroomid != undefined && $j("[isBlocked=true]",e.dropTarget).length > 0) {
		e.preventDefault();
		return;	
	}
	//2017/03/13 ルームインジケーターにて、すでに宿泊予約で部屋変更不可の予約が入っている部屋に、アサインができるように改善対応 by zy END
	// CSS設定
    // 自分の場合、割り当て対象外になる
    /*
	if (fromroomid == toroomid || (typeof fromroomid == "undefined" && toleadid != "")) {
		e.preventDefault();
		return;	
	}
	e.dropTarget.addClass("drop-ui-state-hover");
	// 部屋タイプは一致しない場合、部屋にアサインができない
    */
    // 同じ部屋の場合、処理中止
    if (fromroomid == toroomid) {
        e.preventDefault();
        return; 
    }
    // 
	/*
    // 割り当て対象の部屋IDはない（未割り当てWINDOWから、
    //typeof fromroomid == "undefined" && 
    if (toleadid != "") {
        // 該当予約情報はすでにアサイン済みの予約時間重複チェックを行う
        var startLeadTime = dragLeadElement.attr("starttime");
        var endLeadTime = dragLeadElement.attr("endtime");
        // 割り当て対象部屋に、既存の予約情報の時刻期間チェックを行う
        var timeArray = new Array();
        // 遷移先の既存の時間帯リスト
        var times = e.dropTarget.attr("times").split(",");
        // 未割り当てWindowから部屋に割り当てる場合
        if (fromroomid == "") {
        	// 変更先の部屋に2予約データは
        	if (times.length > 1) {
	        	for(i = 0; i < times.length; i++){
		            timeArray[i] = times[i].split("||");
		            if ( startLeadTime < timeArray[i][1]  && timeArray[i][0] < endLeadTime  ) {
		                // 既存の予約の期間に、時刻帯を重複する場合、次の処理を中止する
		                //e.stopPropagation();
					e.preventDefault();
					return;	
					}
	        	}
        	}
        } else {
	        // 遷移先の予約数は１の場合、交換可能
	        if (times.length > 1) {
	        	for(i = 0; i < times.length; i++){
		            timeArray[i] = times[i].split("||");
		            if ( startLeadTime < timeArray[i][1]  && timeArray[i][0] < endLeadTime  ) {
		                // 既存の予約の期間に、時刻帯を重複する場合、次の処理を中止する
		                //e.stopPropagation();
					e.preventDefault();
					return;	
					}
	        	}
	        }
	    }
    }*/
    e.dropTarget.addClass("drop-ui-state-hover");
}
//2019/2/15 ルームインジケータの部屋タイプ絞り込み機能を、タイムテーブルと同じように、複数タイプ指定できるようにして欲しい by cxw BEGIN
function initDepartmentSel(muliteSel,values){
	// ツール　と　選択部署　あり
	if (muliteSel) {
		values = values || "";
		var departArr = values.split(',');
		if (departArr.length > 0) {
			var selector = [];
			departArr.forEach(function(depart){
				if (depart != "") selector.push("option[value='" + depart + "']");
			});
			if (selector.length > 0) { 
				var $el = muliteSel.find(selector.join(','));
				if($el.length) $el.attr("selected",true);
				else muliteSel.find('option[value=""]').attr("selected",true); 
			} else {
				muliteSel.find('option[value=""]').attr("selected",true);
			}
				muliteSel.multiselect('refresh');
		}
	}
}
//2019/2/15 ルームインジケータの部屋タイプ絞り込み機能を、タイムテーブルと同じように、複数タイプ指定できるようにして欲しい by cxw END
// 部屋から離れる場合、css設定に戻る
function droptargetOnDragLeave(e) {
	e.dropTarget.removeClass("drop-ui-state-hover");
}
// 部屋割り当てる画面起動
function droptargetOnDrop(e) {
	if(!_g_isCanUpdateFlg) return;
    /*
	// 最後設定するBlockの項目格納
	//dragTargetElement = e.dropTarget;
	var fromuid = dragLeadElement.attr("roomtypeuid");
	var formunm = dragLeadElement.attr("roomTypeUnm");
	if(fromuid == "undefined") {
		formunm = "";
	}
    // 部屋BLOCKされる場合、部屋に割り当て不可制御になる
	if (typeof dragLeadElement.attr("isBlocked") != "undefined" && 
		 dragLeadElement.attr("isBlocked").toLowerCase() == "true") {
		e.preventDefault();
		return;	
	}
	
	var fromroomid = dragLeadElement.attr("roomId");
	var touid = e.dropTarget.attr("roomTypeId");
	var tounm = e.dropTarget.attr("roomTypeNm");
	var toroomid = e.dropTarget.attr("roomId");
	var toleadid = e.dropTarget.attr("leadid");
	// 自分の場合 || 既にアサイン済みの部屋に、未割り当てる予約からアサイン、対象外になる
	if (fromroomid == toroomid　|| (typeof fromroomid == "undefined" && toleadid != "")) {
//	if (fromroomid == toroomid) {
		e.preventDefault();
		return;	
    }*/
    // 割り当て不可の場合、処理中止
    if ( !e.dropTarget.hasClass("drop-ui-state-hover") ) {
        e.preventDefault();
        return; 
    }
    var fromuid = dragLeadElement.attr("roomtypeuid");
    var formunm = dragLeadElement.attr("roomTypeUnm");
    if(typeof fromuid == "undefined") {
        formunm = "";
    }
    var fromroomid = dragLeadElement.attr("roomId");
    var touid = e.dropTarget.attr("roomTypeId");
    var tounm = e.dropTarget.attr("roomTypeNm");
    var toroomid = e.dropTarget.attr("roomId");
    var toleadid = e.dropTarget.attr("leadid");
	// 団体・単体のタイトルで、DROPして、自動アサインする場合
	var groupFlg = (typeof(dragLeadElement.attr("groupFlg"))=="undefined") ? "" : dragLeadElement.attr("groupFlg");
	//var groupFlg = Boolean(fromElement.data("groupFlg"));
//	console.debug("fromroomid:::" + fromroomid);
    if (typeof fromroomid == "undefined") fromroomid = "";
	// 2019/08/31 20190830.01.すでにアサイン済みの部屋をルームチェンジする際、部屋タイプが変更されていなくとも、アラートが出るような設定をしたいです by zy BEGIN
	var roomTypeAlarmFlag = "{!$Setup.CommDefine__c.ps__RoomIndicatorSmTypeMsgIsShowFlg__c}";
	// 2019/08/31 20190830.01.すでにアサイン済みの部屋をルームチェンジする際、部屋タイプが変更されていなくとも、アラートが出るような設定をしたいです by zy END
	if (groupFlg.toLowerCase() != "true") {
		// 個別で部屋アサインする場合
		// 時刻重複チェックを行う
		// 遷移先の１予約のみの場合、遷移元は未割り当ての予約場合
		if (toleadid != "" && fromroomid == "") {
			// 時間帯重複チェックする
			
		}
		// 遷移先はすでに割り当てる予約の場合、部屋交換処理を行う
		
		if (fromuid != touid) {
		//部屋タイプは        タイプから	タイプへ変更されます、宜しいでしょうか
			var confirmMsg = '{!$Label.MSG_008_0033}'+formunm+'{!$Label.MSG_008_0034}'+tounm+'{!$Label.MSG_008_0035}';
			if (formunm == "") {
			//部屋タイプは		タイプへ変更されます、宜しいでしょうか
				confirmMsg = '{!$Label.MSG_008_0033}'+tounm+'{!$Label.MSG_008_0035}';
			}
			if (!window.confirm(confirmMsg)) {
				e.dropTarget.removeClass("drop-ui-state-hover");
				e.preventDefault();
                return false;   
			}
		} else if (roomTypeAlarmFlag == "true") {
			if (!window.confirm('部屋変更されます、宜しいでしょうか')) {
				e.dropTarget.removeClass("drop-ui-state-hover");
				e.preventDefault();
                return false;   
			}
		}
	    // Setup Lead To Room By Memory
	    ajaxSyncNoAssignInfo(dragLeadElement, e.dropTarget);
	} else {
		blockUi();
		// 部屋
		// 一括部屋自動アサイン処理を行う
		ajaxSyncNoAssignInfoByBulk(dragLeadElement, e.dropTarget);
	}

}

// 2014/08/20 Drop処理
function noAssignDroptargetOnDragEnter(e) {
//console.debug("noAssignDroptargetOnDragEnter");
	// 部屋未割り当てWindow画面から移動する場合、処理中止
	if (dragLeadElement == null) {
		e.preventDefault();
		return;
	}
	// 画面からLOCKされた部屋からDROPする場合、対象外
	if (typeof dragLeadElement.attr("isBlocked") != "undefined" && 
		dragLeadElement.attr("isBlocked").toLowerCase() == "true") {
		e.preventDefault();
		return;	
	}
	// 未割り当て予約部屋からDropする場合、処理対象外
	if (dragLeadElement.hasClass("noAssignLead")) {
        e.preventDefault();
        return; 
	}
	// 処理のステータスCSSを設定する
	e.dropTarget.removeClass("k-state-focused");
	e.dropTarget.addClass("drop-ui-state-hover-noAssignWin");
}
function noAssignDroptargetOnDragLeave(e) {	
//console.debug("noAssignDroptargetOnDragLeave");
	// 処理のステータスCSSを外す
	e.dropTarget.removeClass("drop-ui-state-hover-noAssignWin");
}
function noAssignDroptargetOnDrop(e) {
//console.debug("noAssignDroptargetOnDrop");
	if(!_g_isCanUpdateFlg) return;
    // 割り当て不可の場合、処理中止
    if ( !e.dropTarget.hasClass("drop-ui-state-hover-noAssignWin") ) {
        e.preventDefault();
        return; 
    }

   	// 予約ID情報を格納する
   	var groupIds = dragLeadElement.attr("leaduid") + ",";
	// 一括予約IDを取得する
   	var leadIndexId = dragLeadElement.attr("leadIndexId");
   	// 一括予約のIDが存在する場合、
   	if (leadIndexId != "") {
   		// 同じ予約インデクスIDの予約BLOCKリストを取得する
   		var grouprooms = getBlackCreamTeamGroupRooms(leadIndexId);
   		var isCheckTeamFlg = {!isShowGroupClConfirm};	// 一括チェツクイン機能起動の場合、一括取り消しも起動する
   		//var isbulkProcFlg = false;
   		
		// 一括チェックイン機能起動 && 団体予約の場合
		if(isCheckTeamFlg && grouprooms.length > 1)
		{	
			//予約の部屋割り当てを一括取り消しよろしいですか
			if(confirm('{!$Label.MSG_008_0079}'))
			{
				groupIds = "";	// 引き渡すの予約ID
	   			// 団体の部屋情報は全部取得、色を設定する
	    		grouprooms.each(function() {
	    			// ロックされる部屋は取り消し対象外する
	    			if ($j(this).attr("isBlocked").toLowerCase() != "true") {
	    				groupIds += $j(this).attr('leadUid') + ',';
	    			}
	    		});
	    		//isbulkProcFlg = true;
			}
		}
	}
	dragLeadElement.attr("_canelRoomLeadIds",groupIds.slice(0, -1));
   	// 部屋アサイン取り消し処理呼び出し
   	blockUi();
	ajaxSyncCancelAssignInfo(dragLeadElement, e.dropTarget);
	//return false;
}

// 予約データ（移動元）
var dragLeadElement = null;
// 選択した部屋情報格納(移動先)
var dragTargetElement = null;
// 未割り当てのWindowのTitle自動設定を行う
function refreshWindowTitle(recordsNum) {
	var win = $j("#noAssignLeadListWindow").data("kendoWindow");
	//未割り当予約
	//件
	win.title('{!$Label.MSG_008_0037} 【'+recordsNum+'】{!$Label.MSG_008_0048}');
	// 件数０の場合、Windowは自動MINする、１以上場合、Windowを開く(2014/07/29)
	if (1*recordsNum > 0) {
		// 2014/08/13 自動OPEN機能は外す、０件のみ、WINDOWを自動クロスする
		//win.restore();
	} else {
		win.minimize();
	}
}
// 割り当てるできる予約情報BINDする
function bindNoAssignLeadItem() {
	/*
	$j(".noAssignLead-view").kendoDraggable({
		hint: function(e) {
			// golbal var setup
			dragLeadElement = $j(e).clone();
			return dragLeadElement;
		},
	});*/
	var treeview = $j("#noAssignLeadListView").data("kendoTreeView");
	// ALLサブ項目を全展開
	treeview.expand(".k-item");
	// Dragできる項目を定義する
	if(!JS_SYS_DEVICE_MOBILE_FLG || notReadOnlyFlg){
	$j(".noAssignLead").kendoDraggable({
        hint: function(e) {
            // golbal var setup
            dragLeadElement = $j(e).clone();
            return dragLeadElement;
        },
	});
	}
	// 2019/10/30 ルームインジケータに「自動一括アサイン」ボタンが欲しい by zy BEGIN
	// 自動アサイン処理フラグ
	var fromAutoAssign = $j("#noAssignLeadListWindow").attr("assignRoom");
	// 自動アサインあり
	if (fromAutoAssign) {
		// 未割当のウィンドウ、既存予約あり
		if ($j(".noAssignLead[groupflg=false]").length > 0)
			alert("一括割当処理が完了いたしましたが、自動割当できずご予約が存在する、手動で割当してください");
		// 変数削除
		$j("#noAssignLeadListWindow").removeAttr("assignRoom");
	}
	// 2019/10/30 ルームインジケータに「自動一括アサイン」ボタンが欲しい by zy END
}

// 選択リスト変更する際に、未割り当て予約情報を変更する
function syncNoAssignLeadInfo() {
	// 最新の部屋タイプ選択リストを取得する
	noAssingLeadInfoDs.read();
}

// 未割り当予約 DataSource
var noAssingLeadInfoDs = new kendo.data.HierarchicalDataSource({
    transport: {
      read: function (options) {
        // 検索条件を設定する 
        var queryDate = getQueryDate(); //$j("input[id$=':gotoDate']").length > 0 ? $j("input[id$=':gotoDate']").val() : "";
        //var branchCd = $j("select[id$=':branchShopCd']").length > 0 ? $j("select[id$=':branchShopCd']").val() : "";
        var branchCd = _getDefShopCode(true);
		// 当日はチェックイン情報・チェックアウト情報表示制御フラグ
		var isShowTodayInfo = getShowTodayFlg();
		// 2018/11/08 未割り当てウインドウの予約も該当部屋タイプのみ情報を表示する WGCH BEGIN
		var roomTypeSelectId = $j("select[id$=':roomTypeSelectId']").length > 0 ? $j("select[id$=':roomTypeSelectId']").val() : "";
		// 2019/02/10 多選の部屋タイプの場合、未割当予約表示不正　by　zy BEGIN
		if (typeof roomTypeSelectId === 'object') roomTypeSelectId = roomTypeSelectId.join(",");
		// 2019/02/10 多選の部屋タイプの場合、未割当予約表示不正　by　zy END
		// 2018/11/08 未割り当てウインドウの予約も該当部屋タイプのみ情報を表示する WGCH END
        // make AJAX request to the remote service
        Visualforce.remoting.Manager.invokeAction(
          // 2018/11/08 未割り当てウインドウの予約も該当部屋タイプのみ情報を表示する WGCH BEGIN
          // "RemoteAction.RoomIndicatorInfo.noAssingLeadInfoAll}", queryDate,branchCd, isShowTodayInfo function (result, event) {
          "{!$RemoteAction.RoomIndicatorInfo.noAssingLeadInfoAllNew}", queryDate,branchCd, isShowTodayInfo, roomTypeSelectId, function (result, event) {
          // 2018/11/08 未割り当てウインドウの予約も該当部屋タイプのみ情報を表示する WGCH END
            if (event.type == 'exception') {
                alert(event.message);
            } else {
//console.log(result);
                // 顧客一覧情報を引き渡す
                options.success(result);
                // 2013/10/31 総件数統計を行う
                var maxLen = result.length;
                var totleRs = 0;
                for (var i=0 ; i<maxLen ; i++){
                	totleRs += result[i].items.length;
                }
                refreshWindowTitle(totleRs);
                // BIND部屋未割り当ての予約項目情報               
                bindNoAssignLeadItem();
            } // End else
        }, {escape: true});
      }// read
    },// transport
    schema: {
        model: {
            hasChildren: "isHasChildren",
            id: "id",
            children: "items",
        }
    }
}); 
// noAssingLeadInfoDs End
var gobalToElement;
// 予約の部屋は予約に割り当て
function ajaxSyncNoAssignInfo(fromElement, toElement) {
	// 検索条件を設定する 
	var fromRoomId = (typeof(fromElement.attr("roomId"))=="undefined") ? "" : fromElement.attr("roomId");
	var fromLeadId = fromElement.attr("leadUid");
	var toRoomId = toElement.attr("roomId");
	var toLeadId = toElement.attr("leadid");
	var queryDate = getQueryDate(); //$j("input[id$=':gotoDate']").length > 0 ? $j("input[id$=':gotoDate']").val() : "";
	// 当日はチェックイン情報・チェックアウト情報表示制御フラグ
	var isShowTodayInfo = getShowTodayFlg();
			
	$j("input[id$=':dropFromRoomIdHid']").val(fromRoomId);
	$j("input[id$=':dropFromLeadIdHid']").val(fromLeadId);
	$j("input[id$=':dropToRoomIdHid']").val(toRoomId);
	$j("input[id$=':dropToLeadIdHid']").val(toLeadId);
    // 画面から指定する予約LEADIDを設定する
    $j("input[id$=':dropTopLeadIdsHid']").val($j("input[id$=':topLeadIdsHid']").val());
	gobalToElement = toElement;
	
	blockUi();
	// 事前チェックを行う
	Visualforce.remoting.Manager.invokeAction(
	   "{!$RemoteAction.RoomIndicatorInfo.preUpdateMemoryRoomLeadMap}", fromRoomId,fromLeadId,toRoomId,toLeadId,queryDate,null,null,isShowTodayInfo, function(result, event){
        // 異常
     	if(event.type == 'exception') {
            alert(event.message);
            gobalToElement.removeClass("drop-ui-state-hover");
            unblockUi();
     	} else {
     		if (result.errMsg == "" && result.infMsg == "" ) {
				// Memory更新
				updateMemoryRoomLeadFun();
     		} else {
     			if (result.errMsg != "" ) {
     				alert(result.errMsg);
     				gobalToElement.removeClass("drop-ui-state-hover");
					unblockUi();
     			} else {
	     			// 既存の予約が存在する場合
	     			if(window.confirm(result.infMsg)) {
	     				updateMemoryRoomLeadFun();
	     			} else {
	     				gobalToElement.removeClass("drop-ui-state-hover");
						unblockUi();
	     			}
     			}
     		}
			
		}
    });

}
// 予約の部屋は予約に割り当て[一括自動部屋アサインを行う]
// 20130619 
function ajaxSyncNoAssignInfoByBulk(fromElement, toElement) {
	
	// 処理条件を設定する 
	var fromLeadIdsStr = $j.trim(fromElement.attr("childrenItems"));
	//fromLeadIdsStr = fromLeadIdsStr.substring(0, fromLeadIdsStr.length -1);
	var fromLeadIds = fromLeadIdsStr.split(",");
	var toRoomId = toElement.attr("roomId");
	var queryDate = getQueryDate(); //$j("input[id$=':gotoDate']").length > 0 ? $j("input[id$=':gotoDate']").val() : "";

	// 2013/10/10 未清掃部屋リストを取得する
	// 未清掃部屋リストを取得する
	var nocleanRoomIdArray = new Array();
    $j(".isCanContextMenu").each(function() {
    	nocleanRoomIdArray.push($j(this).attr("roomId"));
    });
    // 未清掃部屋でも、割り当てする部屋可能の配列に格納する
    var nocleanRoomOkIds = $j.trim(fromElement.attr("nocleanRoomOkId"));
    var nocleanRoomNgIds = $j.trim(fromElement.attr("nocleanRoomNgId"));
	// 当日はチェックイン情報・チェックアウト情報表示制御フラグ
	var isShowTodayInfo = getShowTodayFlg();
//console.debug(nocleanRoomOkIds);
//console.debug(nocleanRoomNgIds);
//console.debug('fromLeadIds:::' + fromLeadIds);
	// 事前チェックを行う
	Visualforce.remoting.Manager.invokeAction(
	   "{!$RemoteAction.RoomIndicatorInfo.autoAssignRoomToLead}", 
		fromLeadIds,toRoomId,queryDate,
		nocleanRoomIdArray,nocleanRoomOkIds,nocleanRoomNgIds,isShowTodayInfo,
		function(result, event){
        // 異常
     	if(event.type == 'exception') {
            alert(event.message);
            unblockUi();
     	} else {
//console.debug('result.nextLeadIds:'+result.nextLeadIds);
     		if (result.nextLeadIds.length == 0) {
				// 処理完了
				refreshPageFun();
     		} else {
     			// 警告情報を表示する[該当予約データは再割当てする]
     			if (result.message != "") {
     				// 未清掃の部屋でも、該当部屋も割り当てする
     				if (window.confirm(result.message)) {
     					// 未清掃部屋は、該当部屋は割り当てする
					    var nocleanRoomOkIds = $j.trim(fromElement.attr("nocleanRoomOkId"));
					    var tmpRoomIds = nocleanRoomOkIds.split(",");
     					tmpRoomIds.push(result.currRoomId);
     					fromElement.attr("nocleanRoomOkId",tmpRoomIds.join());
//console.debug("--1--" + nocleanRoomOkIds);
//console.debug("--1--" + nocleanRoomNgIds);
     					ajaxSyncNoAssignInfoByBulk(fromElement,toElement);
     				} else {
     					// 未清掃部屋は、該当部屋はSKIPする
     					var nocleanRoomNgIds = $j.trim(fromElement.attr("nocleanRoomNgId"));
     					var tmpRoomIds = nocleanRoomNgIds.split(",");
     					tmpRoomIds.push(result.currRoomId);
     					fromElement.attr("nocleanRoomNgId",tmpRoomIds.join());
//console.debug("--2--" + nocleanRoomOkIds);
//console.debug("--2--" + nocleanRoomNgIds);
     					ajaxSyncNoAssignInfoByBulk(fromElement,toElement);
     				}
     			} else {
//console.debug("--3--" + result.nextLeadIds);
	     			// 次の処理を行う
	     			fromElement.attr("childrenItems",result.nextLeadIds.join());
	     			ajaxSyncNoAssignInfoByBulk(fromElement,toElement);
     			}
     		}
			
		}
    });


}
// 部屋アサイン取り消し
function ajaxSyncCancelAssignInfo(fromElement, toElement) {
	
	var fromLeadIdsStr = $j.trim(fromElement.attr("_canelRoomLeadIds"));	// 割り当て取消の予約ID機能
	var fromLeadIds = fromLeadIdsStr.split(",");
//console.debug("fromLeadIds::" + fromLeadIds);
	// 画面の指定日
    var queryDate = getQueryDate();
    // 当日はチェックイン情報・チェックアウト情報表示制御フラグ
    var isShowTodayInfo = getShowTodayFlg();
    // DropTarget情報記録
    gobalToElement = toElement;
    // 部屋アサイン取り消し処理を呼び出し
    Visualforce.remoting.Manager.invokeAction(
		"{!$RemoteAction.RoomIndicatorInfo.autoCancelAssignRoomToLead}", 
        fromLeadIds,queryDate,isShowTodayInfo,
		function(result, event){
	        // 異常
	     	if(event.type == 'exception') {
	            alert(event.message);
	            // 処理中色外す
				gobalToElement.removeClass("drop-ui-state-hover-noAssignWin");
	            unblockUi();
	     	} else {
				// 全部取消処理完了
	     		if (result.nextLeadIds.length == 0) {
					// 処理完了
					refreshPageFun();
					// 処理中色外す
					gobalToElement.removeClass("drop-ui-state-hover-noAssignWin");
	     		} else { // 処理対象有り場合
	     			// 次の処理を行う
	     			fromElement.attr("_canelRoomLeadIds",result.nextLeadIds.join());
	     			ajaxSyncCancelAssignInfo(fromElement,toElement);
				}
		    }
		},
   		{escape: true}
    );
}
// 未割り当てる予約データソース更新
function refreshDS() {
	// 
	var noAssignLeadListWindow = $j("#noAssignLeadListWindow");
	var isHistoryFlg = $j("input[id$=':gotoDate']").length;
	var queryDate = isHistoryFlg > 0 ? dateFormat.format(Date.parse($j("input[id$=':gotoDate']").val())) :dateFormat.format(Date.parse(JS_SYS_TODAY));
	var jsTodayDt = dateFormat.format(Date.parse(JS_SYS_TODAY));
	// 当日から未来日の場合、自動割り当て画面をOPEN
	if (queryDate >= jsTodayDt || JS_SYS_SHOW_HIS_FLG == "true") {
		//$j("#noAssignLeadListWindow").show();
		if(noAssignLeadListWindow.data("kendoWindow")._closing){
			noAssignLeadListWindow.data("kendoWindow").open();
		}
	} else {
		//$j("#noAssignLeadListWindow").hide();
		noAssignLeadListWindow.data("kendoWindow").close();
		return true;
	}
	autoFunExcuteFlag = false; 
	// 未割り当てる画面Refreshする
	noAssingLeadInfoDs.read();
}

// 連絡事項 AND 部屋割り当てる予約データWINDOW
$j(document).ready(function() {

	// 部屋と予約情報を格納用変数
	//hashMap.Clear();

	var wH = $j(window).height();
	var wW = $j(window).width();
    var p = $j("[id$=':roomIndicator']");
    var position = p.offset();	
    // *************************************
    // DayUse予約リスト表示用Window初期化する
    // *************************************
    var roomLeadsWindow = $j("#roomLeadListWindow");
    if (!roomLeadsWindow.data("kendoWindow")) {
        /*
        roomLeadsWindow.kendoWindow({
            width: "580px",
            //actions: ["Minimize","Close"],
            title: "DAY USE",
            visible: false,
        });*/
            roomLeadsWindow.kendoWindow({
                width: "1000px",
                height:"540px",
                actions: ["Minimize","Close"],
                //予約情報
                title: "{!$Label.MSG_008_0081}",
                //content: url,
                visible: false,
                modal: true,
                iframe: true,
            }).closest(".k-window").css({
                top: 110,
                left: wW
            });
    }
	// *************************************
	// 連絡事項入力ブロック[2013/10/11下記WINDOWは削除する]
	// *************************************
	/*
	var messageWindow = $j("#messageWindow");

	if (!messageWindow.data("kendoWindow")) {
		messageWindow.kendoWindow({
        	width: "580px",
            actions: ["Minimize"],
            title: "連絡事項"
        }).closest(".k-window").css({
			top: 110,
   			left: wW - 600
		});  
		messageWindow.data("kendoWindow").minimize();
	}*/

	// *************************************
	// 未割り当てる顧客情報リスト
	// *************************************
	var sumheigh = wH - position.top;
	var noAssignLeadListWindow = $j("#noAssignLeadListWindow");
	if (!noAssignLeadListWindow.data("kendoWindow")) {
		noAssignLeadListWindow.kendoWindow({
        	width: "320px",
        	// 2016/03/10 高さ自動調整機能対応 BEGIN
        	//height : sumheigh,
			maxHeight: sumheigh,
        	// 2016/03/10 高さ自動調整機能対応　END
            actions: ["Minimize"],
            //未割り当予約
            title: "{!$Label.MSG_008_0037}"
        }).closest(".k-window").css({
			top: 110,
   			left: wW - 330
		});
		noAssignLeadListWindow.data("kendoWindow").minimize();
	}
	/*
	var noAssignLeadListView = $j("#noAssignLeadListView");
	if (!noAssignLeadListView.data("kendoListView")) {
		noAssignLeadListView.kendoListView({
			dataSource: noAssingLeadInfoDs,
			template: kendo.template($j("#noAssingLeadTemplate").html())
	    }) 
	}*/
     $j("#noAssignLeadListView").kendoTreeView({
         dragAndDrop: false,
         //drag: treeviewDrop,
         dataSource: noAssingLeadInfoDs,
         //dataTextField: ["roomTypeName", "nodeInfo"],
         template: kendo.template($j("#treeview-template").html()),
         //collapse : resizeTabs,
     });	
     
     
	// 2014/08/19 部屋割り当ての取り消し機能追加
	noAssignLeadListWindow.parent().addClass("noAssignLeadListWindowClass");
    // 2014/08/19 部屋割り当ての取り消し機能追加
	if(!JS_SYS_DEVICE_MOBILE_FLG){
    $j(".noAssignLeadListWindowClass").kendoDropTarget({
	    dragenter: noAssignDroptargetOnDragEnter,
	    dragleave: noAssignDroptargetOnDragLeave,
	    drop: noAssignDroptargetOnDrop
	});
	}
	// 新規予約初期化呼び出し
	YAHOO.force.com.init();
});




// ******************************************
// YAHOO UI BLOCK
// ******************************************
// Create a namespace for our custom functions
YAHOO.namespace("force.com");
//var dateFormat = new DateFormat("yyyy-MM-dd");
//var dateTimeFormat = new DateFormat("yyyy-MM-dd HH:mm:SS");
// Function called when we want to show the dialog
// XML___wgch 2016/11/16 BEGIN
// 2019/12/30 名前か電話番号のどちらかだけ一致するお客様がすでに存在する BY zyz BEGIN
var _g_Contact_Def_Html = "";
// 2019/12/30 名前か電話番号のどちらかだけ一致するお客様がすでに存在する BY zyz END
YAHOO.force.com.showMe = function(result) {
	// 予約データがない場合
//	if(result.leadId == null){return;}
    document.getElementById("myPanel").style.display = "block";
   // document.getElementById("myPanel").style.width =  (("{!widthPx}").length > 0 ) ? "{!widthPx}" : "550px";
    document.getElementById("myPanel_Div").style.maxHeight =  (("{!heightPx}").length > 0 ) ? "{!heightPx}" : "400px";
    // 予約番号
	if(isInvalid(result.leadIndexNo)){
		$j("span[id$=':bLeadIndexNo']").html("");
	} else {
		var leadIndexId = result.leadIndexId;
		var leadIndexNm = result.leadIndexNo;
		var leadLink = "<a href='javascript:void(0);' onclick='window.open(\"/"+ leadIndexId +"/e\");' >" + leadIndexNm + "</a>" ;
		$j("span[id$=':bLeadIndexNo']").html(leadLink);
	}
	// 予約リンク
	if(isInvalid(result.leadName)){
		$j("span[id$=':bname']").html("");
	} else {
		var leadId = result.leadId;
		var leadNm = result.leadName;
		var leadLink = "<a href='javascript:void(0);'  id='detailwindow_lead_"+ leadId +"' onclick='window.open(\"/"+ leadId +"\");' onblur='LookupHoverDetail.getHover(\"detailwindow_lead_"+ leadId +"\").hide();' onfocus='LookupHoverDetail.getHover(\"detailwindow_lead_"+ leadId +"\", \"/"+ leadId +"/m?retURL=%2F"+ leadId + "&isAjaxRequest=1\").show();' onmouseover='LookupHoverDetail.getHover(\"detailwindow_lead_"+ leadId +"\", \"/"+ leadId +"/m?retURL=%2F"+ leadId + "&isAjaxRequest=1\").show();' onmouseout='LookupHoverDetail.getHover(\"detailwindow_lead_"+ leadId +"\").hide();'>" + leadNm + "</a>" ;
		$j("span[id$=':bname']").html(leadLink);
	}
    // 顧客存在する場合:顧客情報を表示する
    if(isInvalid(result.customId)){
        $j("span[id$=':bContactRef']").html("");
    } else {
        var contactId = result.customId;
        var contactNm = result.customName;
        var contactLink = "<a href='javascript:void(0);' id='detail_"+ contactId +"' onclick='window.open(\"/"+ contactId +"\");'  onblur='LookupHoverDetail.getHover(\"detail_"+ contactId +"\").hide();' onfocus='LookupHoverDetail.getHover(\"detail_"+ contactId +"\", \"/"+ contactId +"/m?retURL=%2F"+ contactId + "&isAjaxRequest=1\").show();' onmouseover='LookupHoverDetail.getHover(\"detail_"+ contactId +"\", \"/"+ contactId +"/m?retURL=%2F"+ contactId + "&isAjaxRequest=1\").show();' onmouseout='LookupHoverDetail.getHover(\"detail_"+ contactId +"\").hide();'>" + contactNm + "</a>" ;
        // 2019/12/30 名前か電話番号のどちらかだけ一致するお客様がすでに存在する BY zyz BEGIN
        if(result.conLst != null) {
        	_g_Contact_Def_Html = "<div class='bPageBlock secondaryPalette'><table id='contact_tableId' cellpadding='4px' cellspacing='0px' style='margin-top: 0px;min-width: 400px;max-width: 600px;width:100%;' ><thead class='contactheader'><tr><th style='text-align: center;'>お客様</th><th style='text-align: center;'>電話</th></tr></thead>";
        	for(var i=0;i<result.conLst.length;i++){
        		var conName = result.conLst[i].Name != undefined ? result.conLst[i].Name  : "";
        		var conPhone = result.conLst[i].Phone != undefined ? result.conLst[i].Phone  : "";
        		_g_Contact_Def_Html +="<tr><td style='overflow: hidden;max-width: 400px;white-space: nowrap;text-align:left;'><a href='javascript:void(0);' id='detail_def"+ result.conLst[i].Id +"' onclick='window.open(\"/"+ result.conLst[i].Id +"\");' >" + conName + "</a></td><td style='overflow: hidden;max-width: 100px;white-space: nowrap;'>"+conPhone+"</td></tr>";
        	}
        	_g_Contact_Def_Html +='</table></div>';
        	if(result.conLst.length != 0) contactLink +="<span id='defContactid' onclick='myConFun();' onmouseenter='myConFun();' onmouseleave='onHide()' style='margin-left:5px;text-decoration:underline;' >関連お客様（"+result.conLst.length+"件）</span>" ;
        }
        // 2019/12/30 名前か電話番号のどちらかだけ一致するお客様がすでに存在する BY zyz END
        $j("span[id$=':bContactRef']").html(contactLink);
    }
	//お客ステータス
	if(isInvalid(result.customStatus)){
		$j("span[id$=':bField298__c']").text("");
		$j("input[id$=':leadStatusHidden']").val("");
	} else {
		$j("span[id$=':bField298__c']").text(result.customStatus);
		$j("input[id$=':leadStatusHidden']").val(result.customStatus);
	}
    // 予約インデックス情報
    // 到着日
	if(isInvalid(result.entryDate)){
		$j("span[id$=':bEntryTime__c']").text("");
	} else {
		//var EntryDate__cFromLong = new Date(result.entryDate);
		//$j("span[id$=':bEntryTime__c']").text(dateFormat.format(EntryDate__cFromLong));
		$j("span[id$=':bEntryTime__c']").text(result.entryDate);
	}
	// 到着時刻
	if (isInvalid(result.entryTime)) {
		$j("span[id$=':bField4__c']").text("");
		$j("select[id$=':bInputField4__c']").val("");
	} else {
		$j("span[id$=':bField4__c']").text(result.entryTime);
		$j("select[id$=':bInputField4__c']").val(result.entryTime);
		$j("input[id$=':bHidEntryTime']").val(result.entryTime);
	}
    // 出発日
	if(isInvalid(result.departureDate)){
		$j("span[id$=':bDepartureDate__c']").text("");
	} else {
		//var DepartureDate__cFromLong = new Date(result.departureDate);
		//$j("span[id$=':bDepartureDate__c']").text(dateFormat.format(DepartureDate__cFromLong));
		$j("span[id$=':bDepartureDate__c']").text(result.departureDate);
	}
    // 出発時刻
    if (isInvalid(result.departureTime)) {
    	$j("span[id$=':bDepartureTime__c']").text("");
    	$j("select[id$=':bInputField3__c']").val("");
    } else {
		$j("span[id$=':bDepartureTime__c']").text(result.departureTime);
		$j("select[id$=':bInputField3__c']").val(result.departureTime);
		$j("input[id$=':bHidDepartureTime']").val(result.departureTime);
	}
	// 泊数
	if (isInvalid(result.nights)) {
		$j("span[id$=':bNights']").text("");
		$j("input[id$=':bInputNights']").val("");
		$j("input[id$=':bHidNightId']").val("");
		
	} else {
		$j("span[id$=':bNights']").text(result.nights);
		$j("input[id$=':bInputNights']").val(result.nights);
		$j("input[id$=':bHidNightId']").val(result.nights);
	}
    // 人数
    if (isInvalid(result.leadPeopleNum)) {
        $j("span[id$=':bStayPersons__c']").text("");
        $j("input[id$=':bInputStayPersons']").val("");
        $j("input[id$=':bHidPeopleNumId']").val("");
    } else {
        $j("span[id$=':bStayPersons__c']").text(result.leadPeopleNum);
        $j("input[id$=':bInputStayPersons']").val(result.leadPeopleNum);
        $j("input[id$=':bHidPeopleNumId']").val(result.leadPeopleNum);
        
    }
    // 予約チャネル
    if (isInvalid(result.leadChannel)) {
        $j("span[id$=':bField2__c']").text("");
    } else {
        $j("span[id$=':bField2__c']").text(result.leadChannel);
    }
    // プラン
	if(isInvalid(result.leadPlan)){
		$j("span[id$=':bplaninfo']").text("");
	} else {
		$j("span[id$=':bplaninfo']").text(result.leadPlan);
	}
	// 部屋
	if(isInvalid(result.leadRoom)){
		$j("span[id$=':bRroom__c']").text("");
		$j("input[id$=':bHidRoomId']").val("");
	} else {
		$j("span[id$=':bRroom__c']").text(result.leadRoom);
		$j("input[id$=':bHidRoomId']").val(result.leadRoomId);
	}
	// 特記事項
	if(isInvalid(result.leadMemo)){
		$j("span[id$=':bComment3__c']").html("");
	}else{
	   // Html <br> -> <br></br> Replace
	   //var comment = (result.leadMemo).replace(new RegExp("&\lt;br&\gt;", "g"), "<br>");
	   var comment = (result.leadMemo).replace(new RegExp("&\lt;", "g"), "<").replace(new RegExp("&\gt;", "g"), ">").replace(new RegExp("&\quot;", "g"), '"');;
       $j("span[id$=':bComment3__c']").html(comment);
	}
if (_g_isCanUpdateFlg) {
	// 予約ID
    $j("input[id$=':leadIdHidden']").val(result.leadId);
    // 会計ID
    if(isInvalid(result.accountId)){
    	$j("#accBtn").hide();
    	$j("input[id$=':accIdHidden']").val("");
    } else {
    	$j("#accBtn").show();
    	$j("input[id$=':accIdHidden']").val(result.accountId);
    }
    // 2017/05/12 部屋詳細情報画面レジカード機能対応 zyz BEGIN
    $j("input[id$=':yadoIdHidden']").val(result.yadoId);
    var yadoFlg = $j("input[id$=':yadoIdHidden']").val();
    if (yadoFlg != ""){
    	document.getElementById("cardbtn").style.display = "inline";
    }else{
    	document.getElementById("cardbtn").style.display = "none";
    }
    // 2017/05/12 部屋詳細情報画面レジカード機能対応 zyz END
    // 会計済みの場合、印刷ボタンを表示する
    $j("#pdfurlHid").val("");
	if(isInvalid(result.isAccountedFlg)){
    	$j("#prtBtn").hide();
	} else {
		var flg = result.isAccountedFlg.toString().toLowerCase();
		if (flg == "true") {
			$j("#prtBtn").show();
			$j("#pdfurlHid").val(result.openAccPdfUrl);
		} else {
			$j("#prtBtn").hide();
		}
	}
	// 該当予約の予約インデックスIDを設定する
	$j('input[id$="bHidLeadIndexId"]').val(result.leadIndexId);
	// 予約データはチェックインありのデータが存在する場合、泊数変更ボタンを表示する、チェックインなし場合、
	// 泊数変更は行わない
	if (result.checkInFlg) {
		// チェックインありの予約データが存在する場合
		$j("#chgNightsBtn").show();
		$j("#chgNightsSaveBtn").hide();
	} else {
		// チェックインなしの予約データが未存在する場合
		$j("#chgNightsBtn").hide();
		$j("#chgNightsSaveBtn").hide();
	}
}
	// 泊数変更項目非表示にする
	$j(".roomChangeTd").hide();
	// 時刻変更項目非表示にする
	$j(".timeChangeTd").hide();
	// XML___wgch 2016/11/16 BEGIN
    $_editor = CKEDITOR.instances["chgMemoEditor"];
    if ($_editor) {
       $_editor.destroy();
       $j("#chgMemoEditor").html("");
    }
	$j("[id$=':bComment3__c']").show();
	// XML___wgch 2016/11/16 END
if (_g_isCanUpdateFlg) {
	// お客様のステータスにより、ボタン制御呼び出し
	popWindowBtnFun();
	
	// ボタン表示制御を行う
	if (result._isCleanFlg) {
		// 部屋清掃機能を処理するため、該当Windowを表示する
		// ボタンは：部屋清掃とキャンセルので
		// 2016/11/07 予約キャンセル BEGIN  
		$j("[id$=':leadCancelCheckBtn']").hide();
		// 2016/11/07 予約キャンセル END
		$j("[id$=':leadCheckInBtn']").hide();
		$j("#cleanRoomBtn").show();
	// 2019/05/30 こちらをルームインジケータ上からも1日単位の作成、削除（削除だけでもほしい）by zy BEGIN
		$j("[id$=badRoomRemoveBtn]").hide();
	} else if (result._isBadFlg){
        $j("#cleanRoomBtn").hide();
        $j("[id$=':leadCancelCheckBtn']").hide();
        $j("[id$=':leadCheckInBtn']").hide();
        $j("[id$=badRoomRemoveBtn]").show();
	// 2019/05/30 こちらをルームインジケータ上からも1日単位の作成、削除（削除だけでもほしい）by zy END
	} else {
		$j("#cleanRoomBtn").hide();
		// 2019/05/30 こちらをルームインジケータ上からも1日単位の作成、削除（削除だけでもほしい）by zy BEGIN
		$j("[id$=badRoomRemoveBtn]").hide();
		// 2019/05/30 こちらをルームインジケータ上からも1日単位の作成、削除（削除だけでもほしい）by zy END
	}
}
	var leadFields = '{!leadFieldsAllStr}';
	var fieldNameLst = leadFields.split(',');
	var contactFields = $j("input[id$=bHidContactFields]").val();
	var contactNameLst = contactFields.split(',');
	// 2017/01/25 新規画面の項目自定義機能　by　zy　BEGIN
	var c_wrap = $j("[id$=dblock]");
	//clearCustomFieldMessage(new Array('lead_','contact_'),new Array(fieldNameLst,contactNameLst));
	// 2021/03/31 9914 BUG FIXED by zy BEGIN
	clearCustomFieldMessage(new Array('lead_',JS_DETAIL_WIN_CONTACT_PREFIX),new Array(fieldNameLst,contactNameLst),c_wrap);
	// 2021/03/31 9914 BUG FIXED by zy END
	// 2017/01/25 新規画面の項目自定義機能　by　zy　END
	if(result.leadObj != undefined){
		var mapLeadPingField = $j("input[id$=mapLeadPingFieldId]").val();
		var mapLeadPingFieldLst = mapLeadPingField.split(',');
		var fieldToPath = new Object();
		for (var i = 0; i < mapLeadPingFieldLst.length ; i++) {
			var mapLeadPingFieldSobj = mapLeadPingFieldLst[i].split(':');
			fieldToPath[mapLeadPingFieldSobj[0]] = mapLeadPingFieldSobj[1];
		}
		setCustomFieldWindow(result.leadObj,'lead_',fieldToPath,fieldNameLst);
		
		if(result.contactObj != undefined){
			var mapContactPingField = $j("input[id$=hidContactMapFields]").val();
			var mapContactPingFieldLst = mapContactPingField.split(',');
			var contactFieldToPath = new Object();
			for (var i = 0; i < mapContactPingFieldLst.length ; i++) {
				if(mapContactPingFieldLst[i] == "" || mapContactPingFieldLst[i] == null) continue;
				var mapContactPingFieldSobj = mapContactPingFieldLst[i].split(':');
				contactFieldToPath[mapContactPingFieldSobj[0]] = mapContactPingFieldSobj[1];
			}
			// 2017/01/25 新規画面の項目自定義機能　by　zy　BEGIN
			//setCustomFieldWindow(result.contactObj,'contact_',contactFieldToPath,contactNameLst);
			// 2021/03/31 9914 BUG FIXED by zy BEGIN
			setCustomFieldWindow(result.contactObj,JS_DETAIL_WIN_CONTACT_PREFIX,contactFieldToPath,contactNameLst,c_wrap);
			// 2021/03/31 9914 BUG FIXED by zy END
			// 2017/01/25 新規画面の項目自定義機能　by　zy　END
		}
	} 
	$j("[id*=editColumn]").hide();
	$j("[id*=editColumn][style*=visibility]").css("visibility","visible");
	stopRunning();
    // Window Show
    YAHOO.force.com.myDialog.show();
    // 2018/05/01 ルームインジケータで予約をクリックして、『部屋詳細情報』が開きます。 by zy BEGIN
    $j("[id$=dblock] a:visible").click(function(){
    	closeDetailWin();
    });
    // 2018/05/01 ルームインジケータで予約をクリックして、『部屋詳細情報』が開きます。 by zy END
}
// 2019/12/30 名前か電話番号のどちらかだけ一致するお客様がすでに存在する BY zyz BEGIN
function myConFun(){
	var tabStripElement = $j("#defContactid").getKendoTooltip();
	if(tabStripElement == undefined){
		tabStripElement = $j("#defContactid").kendoTooltip({
			content: _g_Contact_Def_Html,
			autoHide: false
		}).getKendoTooltip();
	}
	tabStripElement.show();
	if (!tabStripElement.popup.element.hasClass("binded"))
		tabStripElement.popup.element.on("mouseenter",mouseenterFun).on("mouseleave",mouseenterOut).addClass("binded");
}

function onHide(e){
	closeWinFun();
}
function mouseenterFun(){
	toopTipFun(true);
}
function mouseenterOut(){
	toopTipFun(false);
}
function toopTipFun(flag){
	if (flag) {
		window.J_LOCKFLG = true;
	} else {
		window.J_LOCKFLG = false;
		closeWinFun();
	}
}
function closeWinFun(){
	setTimeout(function(){
		if (("J_LOCKFLG" in window) && J_LOCKFLG) return;
		var tabStripElement = $j("#defContactid").getKendoTooltip();
		$j("#defContactid").getKendoTooltip().hide();
	},500);
}
// 2019/12/30 名前か電話番号のどちらかだけ一致するお客様がすでに存在する BY zyz END
//カスタムの項目　クリア機能
function clearCustomFieldMessage(coverObjNameArr,fieldLstArr){
	if(coverObjNameArr.length > 0 ){
		for (var i = 0 ; i < coverObjNameArr.length ; i++){
			var objName = coverObjNameArr[i];
			var fieldNameLst = fieldLstArr[i];
			for (var j = 0; j < fieldNameLst.length ; j++) {
				var fieldName = fieldNameLst[j];
				var curTd = $j("td." + objName + fieldName);
				if(curTd.length > 0){
					$j("span[id$=showColumn]",curTd).text("");
					// 2021/03/31 9914 BUG FIXED by zy BEGIN
					if(objName == JS_DETAIL_WIN_CONTACT_PREFIX) {
						$j("[id*=editColumn]",curTd).val("");
					}
					// 2021/03/31 9914 BUG FIXED by zy END
				}
			}
		}
	}
}
// 2017/01/25 新規画面の項目自定義機能　by　zy　BEGIN
//function setCustomFieldWindow(resultObj,covertObjName,fieldToPath,fieldNameLst){
function setCustomFieldWindow(resultObj,covertObjName,fieldToPath,fieldNameLst,that){
// 2017/01/25 新規画面の項目自定義機能　by　zy　END
	for (var i = 0; i < fieldNameLst.length ; i++) {
		var fieldName = fieldNameLst[i];
        if (fieldName == "") continue;
		// 2017/01/25 新規画面の項目自定義機能　by　zy　BEGIN
        //var curFieldTd = $j("td." + covertObjName + fieldName);
		var curFieldTd = $j("td." + covertObjName + fieldName,that);
		// 2017/01/25 新規画面の項目自定義機能　by　zy　END
		var newValue = resultObj[fieldName] != undefined ? resultObj[fieldName]  : resultObj[JINYACONNECT.NS + fieldName];
        // 2017/01/25 新規画面の項目自定義機能　by　zy　BEGIN
		if (fieldName.indexOf('__r' >= 0)){
			console.log(fieldName);
			var nameArr = fieldName.split(".");
			if(nameArr.length > 0){
				var refValue = resultObj;
				for (var j = 0; j < nameArr.length ; j++){
					var refFiledName = nameArr[j];
					refValue = refValue[refFiledName] != undefined ? refValue[refFiledName]  : refValue[JINYACONNECT.NS + refFiledName];
					console.log(refValue);
				}
				if(curFieldTd.length == 0) curFieldTd = $j("td[class*='" + covertObjName + fieldName + "']");
				newValue = refValue;
			}
		}
		// 2017/01/25 新規画面の項目自定義機能　by　zy　END	
		if(newValue == undefined) newValue = "";
		//日付時間タイプ
		if(fieldToPath[fieldName] == 'DateTime'){
			var newTime = "";
			if(newValue != ""){
				newTime = new Date(newValue);
			}
			$j("span[id$=showColumn]",curFieldTd).text(kendo.toString(newTime,'{!DateTimeFormatStr}'));
			// 2021/03/31 9914 BUG FIXED by zy BEGIN
			if(covertObjName == JS_DETAIL_WIN_CONTACT_PREFIX) {
				$j("[id*=editColumn]",curFieldTd).val(kendo.toString(newTime,'{!DateTimeFormatStr}'));
			}
			// 2021/03/31 9914 BUG FIXED by zy END
		//日付タイプ
		} else if(fieldToPath[fieldName] == 'Date'){
			var newTime = "";
			if(newValue != ""){
				newTime = new Date(newValue);
			}
			$j("span[id$=showColumn]",curFieldTd).text(kendo.toString(newTime,'{!DateFormatStr}'));
			// 2021/03/31 9914 BUG FIXED by zy BEGIN
			if(covertObjName == JS_DETAIL_WIN_CONTACT_PREFIX) {
				$j("[id*=editColumn]",curFieldTd).val(kendo.toString(newTime,'{!DateFormatStr}'));
			}
			// 2021/03/31 9914 BUG FIXED by zy END
		//テクスエリアのタイプの処理
		}  else if(fieldToPath[fieldName] == 'TextArea'){
			$j("." + covertObjName + fieldName).addClass('TextAreaTd');
			$j("span[id$=showColumn]",curFieldTd).text(newValue);
			// 2021/03/31 9914 BUG FIXED by zy BEGIN
			if(covertObjName == JS_DETAIL_WIN_CONTACT_PREFIX) {
				$j("textarea[id*=editColumn]",curFieldTd).val(newValue);
			}
			// 2021/03/31 9914 BUG FIXED by zy END
			var curTalbe = $j(curFieldTd).closest("table");
			var columnsInt = $j("input[id$=bcolumnsInt]",curTalbe).val();
			var myPanelWidth = $j("#myPanel td.data2Col.first").width();
			if (columnsInt == 1) {
				var fieldNameWidth = myPanelWidth;
				$j("." + covertObjName + fieldName).width(fieldNameWidth+'px');
				// 2021/03/31 9914 BUG FIXED by zy BEGIN
				if(covertObjName == JS_DETAIL_WIN_CONTACT_PREFIX) {
				// 2021/03/31 9914 BUG FIXED by zy END
					$j("textarea[id*=editColumn]",curFieldTd).width(fieldNameWidth*0.83);
					$j("textarea[id*=editColumn]",curFieldTd).css("max-height",150);
				}
			} else if(columnsInt == 2) {
				//var fieldNameWidth = myPanelWidth * 0.376;
				$j("." + covertObjName + fieldName).width(fieldNameWidth+'px');
				// 2021/03/31 9914 BUG FIXED by zy BEGIN
				if(covertObjName == JS_DETAIL_WIN_CONTACT_PREFIX) {
				// 2021/03/31 9914 BUG FIXED by zy END
					$j("textarea[id*=editColumn]",curFieldTd).width(125);
					$j("textarea[id*=editColumn]",curFieldTd).css("max-height",150);
				}
			}
		//Boolean タイプ
		} else if(typeof(newValue) == "boolean" && newValue != undefined){
			var isFieldValueFlag = newValue;
			var curSpan = $j("span[id$=showColumn]",curFieldTd);
			var curImg = $j(".checkImg",curSpan);
			//不存在图片的情况下
			if(curImg.length == 0 ){
				$j("[id*=editColumn]",curFieldTd).unbind("click");
				$j("[id*=editColumn]",curFieldTd).bind("click",function(){
					if($j(this).is(":checked")){
						$j(this).attr("value",1);
					} else {
						$j(this).attr("value",0);
					}
				});
				curSpan.append($j('<img src="/img/checkbox_checked.gif" alt="{!$Label.MSG_041_0013}" width="16" height="16" class="checkImg" />'));
				curImg = $j(".checkImg",curSpan);
			}
			//チェック
			if(isFieldValueFlag ){
				curImg.attr('src', "/img/checkbox_checked.gif");
				// 2021/03/31 9914 BUG FIXED by zy BEGIN
				if(covertObjName == JS_DETAIL_WIN_CONTACT_PREFIX) {
				// 2021/03/31 9914 BUG FIXED by zy END
					$j("[id*=editColumn]",curFieldTd).attr("checked","checked");
					$j("[id*=editColumn]",curFieldTd).prop("checked",true);
					$j("[id*=editColumn]",curFieldTd).attr("value",1); 
				}
			//チェックなし
    		} else {
    			curImg.attr('src', "/img/checkbox_unchecked.gif");
    			// 2021/03/31 9914 BUG FIXED by zy BEGIN
				if(covertObjName == JS_DETAIL_WIN_CONTACT_PREFIX) {
				// 2021/03/31 9914 BUG FIXED by zy END
					$j("[id*=editColumn]",curFieldTd).removeAttr("checked");
					$j("[id*=editColumn]",curFieldTd).prop("checked",false);
					$j("[id*=editColumn]",curFieldTd).attr("value",0); 
				}
    		}
    	//その他 タイプ
		} else {
			$j("span[id$=showColumn]",curFieldTd).text(newValue);
   			// 2021/03/31 9914 BUG FIXED by zy BEGIN
			if(covertObjName == JS_DETAIL_WIN_CONTACT_PREFIX) {
				//$j("[id*=editColumn]",curFieldTd).val(newValue);
				setCustomFieldValue(curFieldTd,newValue);
			}
			// 2021/03/31 9914 BUG FIXED by zy END
		}
	}
}
function setCustomFieldValue(curFieldTd,newValue){
	var editElment = $j("[id*=editColumn]",curFieldTd);
    if (editElment.length == 0) return;
	if(editElment[0].nodeName == "SELECT"){
		editElment.val(newValue);
		$j("option",editElment).each(function(){
			if($j(this).text() == newValue || $j(this).val() == newValue){
				$j(this).attr("selected","selected");
				return false;
			}
		});
	} else if (editElment[0].nodeName == "INPUT"){
		editElment.val(newValue);
	} else {
		editElment.text(newValue);
	}
	
}
// XML___wgch 2016/11/16 END
// Function called when we want to show the dialog
YAHOO.force.com.showCreateLead = function() {
	// 2017/06/12 MulitiSelect Clear Bug Fix BEGIN
	multiSelectRest();
	// 2017/06/12 MulitiSelect Clear Bug Fix END
    document.getElementById("createLeadPanel").style.display = "block";
    // Clean Form Value to InitValue
    $j("#createLeadFormresetbtn").click();
    // 2017/01/16 统一行追加功能改修 by zy BEGIN
    //clearBookingItem();
    // 2017/01/16 统一行追加功能改修 by zy END
	// Clear Custom Div
	// 2016/10/13 BEGIN by zh
	var $planItem = $j("#planCustomeBtn");
	if ($planItem.length>0){
		var planItem = $planItem.data("jinyaPlanExtend");
		planItem.reset();
	}
	// 2016/10/13 END by zh
    YAHOO.force.com.createLead.show();
	stopRunning();
    // CKEDITOR処理の呼び出し
   	CKEDITOR.jinya.initInstance($j, "ckeditorClass");
}
// Function called when we want to hide the dialog
YAHOO.force.com.hideCreateLead = function() {
	// 2016/11/22 plan明细窗口不关闭 fix BEGIN by zh
	clearBookingItem();
	// 2017/01/16 统一行追加功能改修 by zy BEGIN
	lastBookingDetail();
	// 2017/01/16 统一行追加功能改修 by zy END
	// 2020/07/30 7117 bug fixed by zy BEGIN 
	if (("ACTCUSTOM" in window) && ("OBJ" in ACTCUSTOM))
          ACTCUSTOM.OBJ.ADDROWCALLBACKRES = null;
    // 2020/07/30 7117 bug fixed by zy END
	$j("input[id$=hidCurRows]").val("");
	// 2016/11/22 plan明细窗口不关闭 fix END by zh
	// ErrMessage Clear
	$j("span[id$=':inputLeadFormMsg']").hide();
	YAHOO.force.com.createLead.hide();
	startRunning();
}
    
// 予約データを登録処理後の自動処理
function bookingCreateCallBack() {
	var createResult = $j("input[id$=':hidDataCreateOK']").val();
	if (createResult.toLowerCase() == "true") {
		$j("input[id$=':hidDataCreateOK']").val("");
		YAHOO.force.com.hideMe();
	}
}
    
function popWindowBtnFun() {
    // 2019/02/28 滞在・外出状態の管理 WGCH BEGIN
    // 外出
    $j("[id$=':leadOutBtn'][showFlg='true']").hide();
    // 戻る
    $j("[id$=':leadReturnBtn'][showFlg='true']").hide();
    // 2019/02/28 滞在・外出状態の管理 WGCH END
	// お客様ステータス
	var leadStatus = $j("input[id$=':leadStatusHidden']").val();
    // チェックインとチェックアウトボタン切り替えする
    if (leadStatus == "") {
    	// 未チェックイン
		// 2016/11/04 予約キャンセル BEGIN
    	$j("[id$=':leadCancelCheckBtn']").show();
		// 2016/11/04 予約キャンセル END
    	$j("[id$=':leadCheckInBtn']").show();
    	$j("[id$=':leadCheckOutBtn']").hide();
    	
    } else if (leadStatus == JS_LEADSTATUS_CHECKOUT) {
    	// チェックアウト済み
		// 2016/11/04 予約キャンセル BEGIN
    	$j("[id$=':leadCancelCheckBtn']").hide();
		// 2016/11/04 予約キャンセル END
    	$j("[id$=':leadCheckInBtn']").hide();
    	$j("[id$=':leadCheckOutBtn']").hide();
    } else {
    	// チェックイン済み、泊まる中
		// 2016/11/04 予約キャンセル BEGIN
    	$j("[id$=':leadCancelCheckBtn']").show();
		// 2016/11/04 予約キャンセル END
    	$j("[id$=':leadCheckInBtn']").hide();
    	$j("[id$=':leadCheckOutBtn']").show();
    	// 2019/02/28 滞在・外出状態の管理 WGCH BEGIN
        // 外出
        if($j("span[id$=':bField298__c']").text() == JS_LEADSTATUS_CHECKIN) $j("[id$=':leadOutBtn'][showFlg='true']").show();
        // 戻る
        if($j("span[id$=':bField298__c']").text() == JS_LEADSTATUS_OUT) $j("[id$=':leadReturnBtn'][showFlg='true']").show();
        // 2019/02/28 滞在・外出状態の管理 WGCH END
    }
}

// Function called when we want to hide the dialog
YAHOO.force.com.hideMe = function() {
	startRunning();
	$j("span[id$=showColumn]").show();
	$j("[id*=editColumn]").hide();
	$j("[id*=editColumn][style*=visibility]").css("visibility","hidden");
    YAHOO.force.com.myDialog.hide();
}

// Function called when the DOM is ready to create the dialog,
// render the dialog into the document body, add our dialog skin
// css to the body tag, and wire up the buttons on our dialog
YAHOO.force.com.init = function() {
    document.body.className = document.body.className + " yui-skin-sam";

    YAHOO.force.com.myDialog = new YAHOO.widget.Panel(
        "myPanel",  // The id of our dialog container
        {
                width           :   600,    // You can play with this until it's right
                visible         :   false,  // Should be invisible when rendered
                draggable       :   true,   // Make the dialog draggable
                close           :   false,  // Don't include a close title button
                modal           :   true,   // Make it modal
                fixedCenter     :   true,   // Keep centered if window is scrolled
                zindex          :   4,     // Make sure it's on top of everything

                // This line adds the appear/vanish fade effect
                effect          :   {
                                      effect:YAHOO.widget.ContainerEffect.FADE,
                                      duration:0.35
                                    }
        }
     );

    // Render the dialog to the document.body level of the DOM
    YAHOO.force.com.myDialog.render(document.body);
    
	// Create Lead Input Panel
    YAHOO.force.com.createLead = new YAHOO.widget.Panel(
        "createLeadPanel",  // The id of our dialog container
        {
                width           :   600,    // You can play with this until it's right
                visible         :   false,  // Should be invisible when rendered
                draggable       :   true,   // Make the dialog draggable
                close           :   false,  // Don't include a close title button
                modal           :   true,   // Make it modal
                fixedCenter     :   true,   // Keep centered if window is scrolled
                zindex          :   4,     // Make sure it's on top of everything

                // This line adds the appear/vanish fade effect
                effect          :   {
                                      effect:YAHOO.widget.ContainerEffect.FADE,
                                      duration:0.35
                                    }
        }
     );

    // Render the dialog to the document.body level of the DOM
    YAHOO.force.com.createLead.render(document.body);  
}
// *********** Add the init method to the window.load event
//YAHOO.util.Event.addListener(window, "load", YAHOO.force.com.init);

// ******************************************
// UI BLOCK
// ******************************************
// 画面Lockする
function blockUi() {
	/*
    $j("[id$=':roomIndicator']").block({
    	baseZ: 60000,
        message: '<h1><img src="{!URLFOR($Resource.queryfiles, 'css/blockui/busy.gif')}" /> Processing...</h1>'
    });
    */ 
    
    $j.blockUI({
        baseZ: 60000,
	//Processing...
        message: '<h1><img src="{!URLFOR($Resource.queryfiles, 'css/blockui/busy.gif')}" /> {!$Label.MSG_008_0039}</h1>'
    });
    return true;
}
/*
function blockUi2() {
    $j("[id$=':messageForm']").block({
    	baseZ: 60000,
        message: '<h1><img src="{!URLFOR($Resource.queryfiles, 'css/blockui/busy.gif')}" /> Processing...</h1>'
    });
    return true;
}*/
// Lock解除
function unblockUi () {
    $j.unblockUI({ fadeOut: 200 }); 
}
// 有効性チェック
function isInvalid(val) {
	return (val == null || val == undefined);
}

// 出発日計算
function setDepartureDateAuto(){
    var starts = $j("span[id$=':bEntryTime__c']").text();
    var stays = $j("input[id$=':bInputNights']");
    if (!commUtils.isInteger(stays.val())) {
    //有効な数字を入力してください。［0－9］
    	alert("{!$Label.MSG_008_0082}");
    	stays.val($j("input[id$=':bHidNightId']").val());
    	return false;
    }
    var endDts = dateFormat.format(new Date((kendo.parseDate(starts,JINYACONNECT.DateFormat)).getTime() + stays.val()*24*60*60*1000));
    var sysDate = dateFormat.format(Date.parse(JS_SYS_TODAY));
    if (endDts < sysDate) {
    //出発日は過去の日付に変更することができません。
    	alert('{!$Label.MSG_008_0083}');
    	stays.val($j("input[id$=':bHidNightId']").val());
    	return false;
    }
    $j("span[id$=':bDepartureDate__c']").text(endDts);
    return true;
}
// 有効な予約人数
function chkStayPersons() {
	var stayPeople = $j("input[id$=':bInputStayPersons']");
    if (!commUtils.isInteger(stayPeople.val())) {
    //有効な数字を入力してください。［0－9］
    	alert("{!$Label.MSG_008_0082}");
    	stayPeople.val($j("input[id$=':bHidPeopleNumId']").val());
    	return false;
    }
    return false;
}
// チェックインレイアウト・チェックアウトレイアウト切替画面関数
// checkInFlg:TRUE→当日チェックインの予約データを表示する
//            FALSE→当日チェックアウトの予約データを表示する
function isShowTodayFun (checkInFlg) {
	$j("input[id$=':isShowTodayHid']").val(checkInFlg);
	//isShowTodayJsFun();
}
// 当日チェックイン・チェックアウト制御フラグ値を取得する
function getShowTodayFlg() {return $j("input[id$=':isShowTodayHid']").val(); }
// ３０日間連泊情報照会画面起動
function openBookingInfoWin() {
	// 指定日 // 支店コード
	var queryDate = getQueryDate();
	//var branchCd = $j("select[id$=':branchShopCd']").length > 0 ? $j("select[id$=':branchShopCd']").val() : "";
	var branchCd = _getDefShopCode();
    window.open("/apex/RoomScheduleReport?dt="+queryDate+"&spcd="+branchCd);
}
//2017/02/21  レジカード一括印刷機能  BEGIN zyz
function cardPrintWin() {
	var switchCode = g_cashRegSwithCode;
	// 指定日
	var cardDate = $j("#processDateHid").val();
	// 店舗コード
	//var shopCd = $j("select[id$=':branchShopCd']").length > 0 ? $j("select[id$=':branchShopCd']").val() : "";
	var shopCd = _getDefShopCode(true);
	// 2018/11/30  レジカード一括印刷機能追加 by zyz BEGIN 
	//var openUrl = "{!URLFOR('/apex/CashRegisterCardPDFSwitch')}"+"?cardDate="+cardDate+"&cardCd="+shopCd;
	var openUrl = "{!IF(isCanSelItemForCashPrint, URLFOR('/apex/CashPdfBulkPrint'),URLFOR('/apex/CashRegisterCardPDFSwitch'))}"+"?cardDate="+cardDate+"&cardCd="+shopCd;
	// 2018/11/30  レジカード一括印刷機能追加 by zyz END
	// 2020/02/29 レジカードのロゴを出力した部屋の「店舗情報」対応 BY zyz BEGIN
	var shops = $j("[id$='hidshopLstId']").val();
	if(shops != "" && "{!(isCanSelItemForCashPrint)}" != "true") {
		var yadoUrl = "?cardDate="+cardDate+"&cardCd="+shopCd;
		openGuestWindow(yadoUrl,false,shops);
	}else{
	// 2020/02/29 レジカードのロゴを出力した部屋の「店舗情報」対応 BY zyz END
	// 予約確認書４の場合
	// 2017/05/25 レジカード５のとき、ご宿泊料金が非表示するポップアップが出ない不具合改修 zyz BEGIN
	// 2020/02/29 レジカードのロゴを出力した部屋の「店舗情報」対応 BY zyz BEGIN
	// if ( switchCode == "4" || switchCode == "5") {
	if ( (switchCode == "4" || switchCode == "5") && ("{!(CashLogoFlg)}" != "true" || shops == "")) {
	// 2020/02/29 レジカードのロゴを出力した部屋の「店舗情報」対応 BY zyz END
	// 2017/05/25 レジカード５のとき、ご宿泊料金が非表示するポップアップが出ない不具合改修 zyz END
		//金額を表示しますか？
		if (window.confirm( "{!$Label.MSG_012_0133}")) {
			openUrl += "&smy=1";
		}    
	}
	// 2018/11/30  レジカード一括印刷機能追加 by zyz BEGIN 
	if("{!(isCanSelItemForCashPrint)}" == "true"){
		window.open(openUrl);
		return;
	}
	// 2018/11/30  レジカード一括印刷機能追加 by zyz END 
	window.open(openUrl, "CashRegisterCardPDF","width=780, height=980, menubar=no, toolbar=no, scrollbars=yes");
	// 2020/02/29 レジカードのロゴを出力した部屋の「店舗情報」対応 BY zyz BEGIN
	}
	// 2020/02/29 レジカードのロゴを出力した部屋の「店舗情報」対応 BY zyz END
}
//2017/02/21  レジカード一括印刷機能  END zyz
// 画面個別指定クリア処理
function clearTop(){
   $j("input[id$=':topLeadIdsHid']").val('');
}
// DayUse画面から呼び出し用Method関数
function childCallfn(roomId,leadId,leadName,startTime,endTime){
	if (roomId != null) {
		// Lead変更するチェック
		var orgLeadId = $j("div[id='foot'][roomId$='"+ roomId + "']").attr("leadUid");
	    // Roomindicator画面に、予約TITLE/予約FOOTERの表示情報を切り替え表示する
	    $j("div[name='roomstatusBlock'][roomId$='"+ roomId + "']").attr("leadId",leadId);
	    $j("div[id='foot'][roomId$='"+ roomId + "']").text(leadName);
	    $j("div[id='foot'][roomId$='"+ roomId + "']").attr("leadUid",leadId);
	    $j("div[id='foot'][roomId$='"+ roomId + "']").attr("startTime",startTime);
	    $j("div[id='foot'][roomId$='"+ roomId + "']").attr("endTime",endTime);
	    
	    // 指定情報はHIDDEN項目に格納する
	    hashMap.Put(roomId,leadId);
	    // Hidden Field Value
	    var topLeadsIds = '';
	    hashMap.KeySet().forEach(function(key){ 
	    	if (key != "undefined") {
	    		topLeadsIds += hashMap.Get(key) + ",";
	    	}
	    });
	   	$j("input[id$=':topLeadIdsHid']").val(topLeadsIds);
    	// 画面情報をRefreshする
    	if (orgLeadId != leadId) refreshInfoFun();
    }
    // Close Window
    roomLeadListWindowClose();

	
}
function roomLeadListWindowClose() {
    // TOPを指定する部屋タイプ
	$j("#roomLeadListWindow").data("kendoWindow").close();
}
// Day Use Window Depend[Don't Delete]
function childCallShow(p1,p2,uncleanFlg){
    $j("#roomLeadListWindow").data("kendoWindow").close();
    // 予約データが非存在する場合
    if(p2 == null || p2 == ''){
        if (uncleanFlg) {
            ajaxGetRoomInfo(p1, p2, uncleanFlg);
        } else {
            YAHOO.force.com.hideMe();
        }
    }else{
        ajaxGetRoomInfo(p1, p2, uncleanFlg);
    }   
}
/***************************
* 予約新規作成のSCRIPT
****************************/
// 新規予約データ作成
function setValue(obj) {
    // 2018/07/27 宿泊税計算 WGCH BEGIN
    thisRoomSpcd = obj.attr("roomspcd");
    // 2018/07/27 宿泊税計算 WGCH END
    // アサインする部屋情報
    var $footer = $j(obj).find("[id='foot']");
    // 予約情報設定FORM
    var $inputPanel = $j('div#createLeadPanel');
    // 部屋と部屋タイプ情報
    var roomTypeId 	= $footer.attr("roomtypeuid");
    var roomTypeNm 	= $footer.attr("roomTypeUnm");
    var roomId 		= $footer.attr("roomId");
    var roomName	= $footer.attr("roomNm");
	var p1 = getQueryDate();
	// 2017/11/07 店舗別泊数、到着時刻、出発時刻初期値自動設計できるように改善対応 BEGIN
	//var stays = 1;
	var stays = $inputPanel.find("#defStaysNums").val();
	// 2017/11/07 店舗別泊数、到着時刻、出発時刻初期値自動設計できるように改善対応 END
	$inputPanel.find("[id$=':hidRoomType']").val(roomTypeId);
	$inputPanel.find("[id$=':refTypeOfRooms']").text(roomTypeNm);
	$inputPanel.find("[id$=':hidRoomId']").val(roomId);
	$inputPanel.find("[id$=':roomName']").text(roomName);
	$inputPanel.find("[id$=':staysNums']").val(stays);
	// 2019/06/15 新規予約を部屋ごとに時間と到着日をデフォルト設定 BY zyz BEGIN
	// 予約人数
	$inputPanel.find("[id$=':stayPerson']").val(JS_StayPersons);
	// 传值房型Id
	getRoomTypeTime(roomTypeId);
	// 获取泊数的值
	var defstaysNum = $j("[id$=':staysNums']").val();
	stays = defstaysNum !="" ? defstaysNum : stays;
	// 2019/06/15 新規予約を部屋ごとに時間と到着日をデフォルト設定 BY zyz END
	// 2017/02/13 移除到着时间、出发时间 变更泊数 fix begin
	//$inputPanel.find("[id$=':entryDate']").html(p1.toString(JINYACONNECT.DateFormat));
	if($j("[id$=entryDate]").get(0).tagName == "INPUT"){
    	$inputPanel.find("[id$=':entryDate']").val(p1.toString(JINYACONNECT.DateFormat));
    }else if($j("[id$=entryDate]").get(0).tagName == "SPAN"){
    	$inputPanel.find("[id$=':entryDate']").html(p1.toString(JINYACONNECT.DateFormat));
    }
	// 2017/02/13 移除到着时间、出发时间 变更泊数 fix end
    $inputPanel.find("[id$=':departureDate']").html(new Date(kendo.parseDate(p1,JINYACONNECT.DateFormat).getTime() + stays*24*60*60*1000).toString(JINYACONNECT.DateFormat));
    if(typeof editor != "undefined") editor.setData("");
    //document.getElementById("RoomIndicatorPage:createForm:createPageBlock:createPageBlockSection:departureDateItem:departureDate").innerHTML=comDateFormat(new Date((new Date(p1)).getTime() + 24*60*60*1000), 'yyyy/MM/dd');
	// 関連項目クリアする
	$inputPanel.find("[id$=':planItem:plan_lkid']").val("");
    // お客様関連情報をクリアする
    $inputPanel.find("[id$=':relcontact']").val("");
	$inputPanel.find("[id$=':relcontact_lkid']").val("");
	$inputPanel.find("[id$=':relcontact_lkold']").val("");
	$inputPanel.find("[id='relcontact_lkid_org']").val("");
	// 2019/06/15 新規予約を部屋ごとに時間と到着日をデフォルト設定 BY zyz BEGIN
	// 予約人数
	// $inputPanel.find("[id$=':stayPerson']").val(JS_StayPersons);
	// 2019/06/15 新規予約を部屋ごとに時間と到着日をデフォルト設定 BY zyz END
	//2016/10/13 BEGIN by zh
	$j("tr.tranDetailRow").show();
	//2016/10/13 END by zh
	// 2016/12/13 zyz CTI予約 BEGIN
	var $ctiContactInf = $j("input[id$=':ctiContactInf']");
	var ctiContactInf = $ctiContactInf.val();
	if(ctiContactInf != "") {
		cti_call_pasteInfo(null,ctiContactInf);
	}
	$ctiContactInf.val("");
	// 2016/12/13 zyz CTI予約 END
}
function setDepartureDateAuto_1(){
	//2017/02/13 移除到着时间、出发时间 变更泊数 fix by zh BEGIN
    //var starts = $j('div#createLeadPanel').find("[id$='entryDate']").html();
    var starts = getELementValue("div#createLeadPanel [id$='entryDate']");
    //2017/02/13 移除到着时间、出发时间 变更泊数 fix by zh END
    var stays = $j('div#createLeadPanel').find("[id$='staysNums']").val();
    $j('div#createLeadPanel').find("[id$='departureDate']").html(new Date(kendo.parseDate(starts,JINYACONNECT.DateFormat).getTime() + stays*24*60*60*1000).toString(JINYACONNECT.DateFormat));
}
//2017/02/13 移除到着时间、出发时间 变更泊数 fix by zh BEGIN
function getELementValue(elementStr){
	var orgEle = $j(elementStr);
	//如果给定的查找条件不存在
	if (orgEle.length == 0) return '';
	if (orgEle.get(0).tagName == 'SPAN') return orgEle.html();
	else return orgEle.val();
}
//2017/02/13 移除到着时间、出发时间 变更泊数 fix by zh END
 // 保存前処理
function doBeforeSave() {
	//2016/10/27 BEGIN by zh
	if (!JINYACONNECT.CUSTOM.checkIfHadRequiredItem()) return false;
	//2016/10/27 END by zh
	// CKEDITOR情報は実勢の項目にコピーする
	CKEDITOR.jinya.copyValue($j, "ckeditorClass");
	// 自定义お客様boolean值的字段、checkbox的value的不显示 Fix BEGIN
	
	var mapContactPingField = $j("input[id$=hidContactMapFields]").val();
	var mapContactPingFieldLst = mapContactPingField.split(',');
	var contactFieldToPath = new Object();
	for (var i = 0; i < mapContactPingFieldLst.length ; i++) {
		if(mapContactPingFieldLst[i] == "" || mapContactPingFieldLst[i] == null) continue;
		var mapContactPingFieldSobj = mapContactPingFieldLst[i].split(':');
		contactFieldToPath[mapContactPingFieldSobj[0]] = mapContactPingFieldSobj[1];
		if (mapContactPingFieldSobj[1] == 'Boolean') {
			//var element = contact_'result[0]';
			var contactEle = $j("[class~='contact_" + mapContactPingFieldSobj[0] + "']","[id$=createPageBlock]");
			var checkfield = $j("input:checkbox",contactEle);
			if (checkfield.is(":checked")){
					checkfield.attr("value",1); 
				}else {
					checkfield.attr("value",2);
				}
		}
	}
	// 自定义お客様boolean值的字段、checkbox的value的不显示 Fix END
// 2017/01/25 新規画面の項目自定義機能　by　zy　BEGIN
    var hideItem = "{!$Component.createForm}:hidStartDays";
    // 2017/02/06 移除到着日出发日项目 Fix by zh Begin
    //$j("input[id$='" + hideItem + "']").val($j('div#createLeadPanel').find("[id$='entryDate'],input:hidden[id$='entryDate']").html());
    $j("input[id$='" + hideItem + "']").val(getELementValue("div#createLeadPanel [id$='entryDate']"));
    // 2017/02/06 移除到着日出发日项目 Fix by zh End
// 2017/01/25 新規画面の項目自定義機能　by　zy　END
	// 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH BEGIN
	$j("[id$=BookEstTable] tbody tr.tranDetailRow").each(function(){
		// plan明细是否展开过
		var isPlanNumFlg = kendo.parseInt($j("input[id$=hidBasePlanNum]",this).val());
		if (isPlanNumFlg == null || isPlanNumFlg != 0){
			$j("input[id$=hidSyncInfo]",this).val("");
		}
		/*
		// 查找plan的展开图
		var planImg = $j(this).find('img[id^=showDetailEvent]');
		if(planImg.length > 0){
			// plan明细是否展开过
			var isPlanNumFlg = $j("input:hidden[id$=':" + syncInt + ":hidBasePlanNum']").val();
			if(isPlanNumFlg == null || isPlanNumFlg == 0){
				$j("input[id$=hidSyncInfo]",this).val("");
			}
			syncInt++;
			*/
			/*
			var planShow = planImg.attr("syncShow");
			if(planShow == "true"){
				// baseplan选择的商品，未展开过的，记录清空，并吧sync清空
				$j(this).removeAttr("syncShow");
				$j("input[id$=hidSyncInfo]",this).val("");
			}
			
		}*/
	});
	// 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH END
    //2016/10/27 BEGIN by zh
    refreshOrder(true);
    //2016/10/27 END by zh
    clearAutoCompletePanel();
    //2016/10/27 BEGIN by zh
    //javascript:JINYACONNECT.CUSTOM.blockUi();
    blockUi();
    saveLeadFun();
    //2016/10/27 END by zh
    return true;
}
// AutoComplete項目選べるリストクリックする処理
function clearAutoCompletePanel() {
	$j(".ui-autocomplete").hide();
	$j(".ui-autocomplete").empty();
 }
// 予約名自動設定機能
function autoSetupLeadName() {
    var contactName = $j("input[id$=':relcontact']").val();
    var leadName = $j("input[id$=':leadName']").val();
    if (leadName == "" && contactName != "") {
        $j("input[id$=':leadName']").val(contactName);
    }
}
// 予約新規作成後のスケータすチェツク
// 予約データを登録処理後の自動処理
function leadCreateCallBack() {
    var createResult = $j("input[id$=':lead_hidDataCreateOK']").val();
    if (createResult.toLowerCase() == "true") {
        $j("input[id$=':lead_hidDataCreateOK']").val("");
       	YAHOO.force.com.hideCreateLead();
       	// 2016/12/07 ルームインジケータ新規後一画面へ遷移 BEGIN by zh
       	var strId = $j("input[id$='IndexId']").val(); 
       	var isIncludeMode = {!isIncludeMode};
       	if(isIncludeMode == false) gotoBookingFlexApp(strId);
        // 2016/12/07 ルームインジケータ新規後一画面へ遷移 END by zh
    }
	// 2016/11/24 故障房间的message 滚动条到顶部 fix BEGIN by zh
    else{ 
		$j("#createLeadPanel div.bd").scrollTop(0);
		unblockUi();
		return;
    }
    // 2016/11/24 故障房间的message 滚动条到顶部 fix END by zh
    // 最新のアサイン情報をRefreshする 【2014/08/19】
    refreshPageFun();
}
// 一括チェックイン・一括チェックアウト・一括清掃機能チェック
// that:　クリックされたボタン
// isCheckTeamFlg: 一括機能起動チェック
function teamConfig(that, isCheckTeamFlg)
{	
	// 2016/11/04 予約キャンセル BEGIN
	var _CONST_CANCEL = 'leadCancel';
	// 2016/11/04 予約キャンセル END
	var _CONST_CHECKIN = 'checkin';
	var _CONST_CHECKOUT= 'checkout';
	// 2019/02/28 滞在・外出状態の管理 WGCH BEGIN
	var _CONST_OUT = 'out';
	var _CONST_RETURN = 'return';
	// 2019/02/28 滞在・外出状態の管理 WGCH END
	// 処理区分
	var actKbn = $j(that).attr("actKbn");
	//一括チックインよろしいですか
	var confirmMsg = "{!$Label.MSG_008_0084}";
	// 2020/02/28 ルームインジケータ、タイムテーブル改修対象画面 BY zyz BEGIN
	// 一括チェックインよろしいですか（「OK」個別チェックイン、「キャンセル」一括チェックイン）
	if (getConfirmFlg()) confirmMsg = '{!$Label.MSG_008_0084_1}';
	// 2020/02/28 ルームインジケータ、タイムテーブル改修対象画面 BY zyz END
	// 2016/11/04 予約キャンセル BEGIN
	if (actKbn == _CONST_CANCEL) {
	//予約キャンセルよろしいですか
		if(!confirm("{!$label.MSG_9003}")) return;
		confirmMsg = "{!$Label.MSG_008_0120}";
	}
	// 2016/11/04 予約キャンセル END
	if (actKbn == _CONST_CHECKOUT) {
	//一括チックアウトよろしいですか
		confirmMsg = "{!$Label.MSG_008_0085}";
		// 2020/02/28 ルームインジケータ、タイムテーブル改修対象画面 BY zyz BEGIN
		// 一括チックアウトよろしいですか（「OK」個別チックアウト、「キャンセル」一括チックアウト）
		if (getConfirmFlg()) confirmMsg = '{!$Label.MSG_008_0085_1}';
		// 2020/02/28 ルームインジケータ、タイムテーブル改修対象画面 BY zyz END
	}
	// 初期値設定
	//$j('input[id$="bHidGroupLeadId"]').val("");
	$j('input[id$="bHidGroupFlg"]').val(false);	// 一括チェックインなし
	
	var leadIndexId = $j('input[id$="bHidLeadIndexId"]').val();
	var groupIds = "";
	    // 2014/08/20 部屋割り当てキャンセル機能対応
		//grouprooms = $j("div[leadIndexId='"+leadIndexId+"']");
	var grouprooms = getContainerTeamGroupRooms(leadIndexId);
	// 一括チェックイン機能起動 && 団体予約の場合
	if(isCheckTeamFlg && grouprooms.length > 1) {
		// 2019/02/28 滞在・外出状態の管理 WGCH BEGIN
		/*
		if(confirm(confirmMsg)) {
			$j('input[id$="bHidGroupFlg"]').val(true);
   			// 団体の部屋情報は全部取得、色を設定する
    		grouprooms.each(function() {
    			groupIds += $j(this).attr('leadId') + ',';
    		});
    		
		}
		*/
		// 2020/02/28 ルームインジケータ、タイムテーブル改修対象画面 BY zyz BEGIN
		// if(actKbn != _CONST_OUT && actKbn != _CONST_RETURN && confirm(confirmMsg)) {
		if(actKbn != _CONST_OUT && actKbn != _CONST_RETURN) {
		/* 中间的alert文字是否需要调整 */
			var selResult = confirm(confirmMsg);
			if (getConfirmFlg() != selResult) {
			// 2020/02/28 ルームインジケータ、タイムテーブル改修対象画面 BY zyz END
			$j('input[id$="bHidGroupFlg"]').val(true);
   			// 団体の部屋情報は全部取得、色を設定する
    		grouprooms.each(function() {
    			groupIds += $j(this).attr('leadId') + ',';
    		});
			// 2020/02/28 ルームインジケータ、タイムテーブル改修対象画面 BY zyz BEGIN
			}
			// 2020/02/28 ルームインジケータ、タイムテーブル改修対象画面 BY zyz END
		}
		// 2019/02/28 滞在・外出状態の管理 WGCH END
	}
	// 2019/07/15 多泊の場合、外出の場合、多泊の予約に同じ状態を更新する BY zyz BEGIN
	// 一括外出
	if(isCheckTeamFlg && grouprooms.length > 1 && actKbn != _CONST_CANCEL && actKbn != _CONST_CHECKOUT) {
		// 2020/02/28 ルームインジケータ、タイムテーブル改修対象画面 BY zyz BEGIN
		// if(actKbn != _CONST_CHECKIN && actKbn != _CONST_RETURN && confirm("一括外出よろしいですか")) {
		if(actKbn != _CONST_CHECKIN && actKbn != _CONST_RETURN) {
			// 一括外出よろしいですか
			var msg = "{!$label.MSG_008_0128}"; 
			// 一括外出よろしいですか（「OK」個別外出、「キャンセル」一括外出）
			if (getConfirmFlg()) msg = "{!$label.MSG_008_0128_1}"; 
			var selResult = confirm(msg);
			if (getConfirmFlg() != selResult) {
				/* 中间的alert文字是否需要调整 */
				// 2020/02/28 ルームインジケータ、タイムテーブル改修対象画面 BY zyz END
				$j('input[id$="bHidGroupFlg"]').val(true);
				// 団体の部屋情報は全部取得、色を設定する
				grouprooms.each(function() {
					groupIds += $j(this).attr('leadId') + ',';
				});
			// 2020/02/28 ルームインジケータ、タイムテーブル改修対象画面 BY zyz BEGIN
			}
			// 2020/02/28 ルームインジケータ、タイムテーブル改修対象画面 BY zyz END
		}
		// 一括入室
		// 2020/02/28 ルームインジケータ、タイムテーブル改修対象画面 BY zyz BEGIN
		// if(actKbn != _CONST_CHECKIN && actKbn != _CONST_OUT && confirm("一括入室よろしいですか")) {
		if(actKbn != _CONST_CHECKIN && actKbn != _CONST_OUT) {
			// 一括入室よろしいですか
			var msg = '{!$Label.MSG_008_0129}';
			// 一括入室よろしいですか（「OK」個別入室、「キャンセル」一括入室）
			if (getConfirmFlg()) msg = '{!$Label.MSG_008_0129_1}';
			var selResult = confirm(msg);
			if (getConfirmFlg() != selResult) {
			// 2020/02/28 ルームインジケータ、タイムテーブル改修対象画面 BY zyz END
				$j('input[id$="bHidGroupFlg"]').val(true);
				// 団体の部屋情報は全部取得、色を設定する
				grouprooms.each(function() {
					groupIds += $j(this).attr('leadId') + ',';
				});
			// 2020/02/28 ルームインジケータ、タイムテーブル改修対象画面 BY zyz BEGIN
			}
			// 2020/02/28 ルームインジケータ、タイムテーブル改修対象画面 BY zyz END
		}
	}
	// 2019/07/15 多泊の場合、外出の場合、多泊の予約に同じ状態を更新する BY zyz END
	if(groupIds == '') groupIds = $j("input[id$=':leadIdHidden' ]").val();
	$j('input[id$="bHidGroupLeadId"]').val(groupIds);
	
	if (actKbn == _CONST_CHECKIN) {
		// チエックイン処理呼び出し
		checkInByRoom();
	} else if (actKbn == _CONST_CHECKOUT) {
		// チエックアウト処理呼び出し
		checkOutByRoom();
	// 2016/11/04 予約キャンセル BEGIN
	} else if (actKbn == _CONST_CANCEL) {
		// 予約キャンセル処理呼び出し
		leadCancel();
	} 
	// 2016/11/04 予約キャンセル BEGIN
	// 2019/02/28 滞在・外出状態の管理 WGCH BEGIN
	else if (actKbn == _CONST_OUT) {
		// 予約外出処理呼び出し
		outByRoom();
	}
	else if (actKbn == _CONST_RETURN) {
		// 予約滞在処理呼び出し
		returnByRoom();
	}
	// 2019/02/28 滞在・外出状態の管理 WGCH END
}
// 団体割り当て済の部屋一覧を取得する
function getContainerTeamGroupRooms (leadIndexId) {
	return $j("div[id='container'][leadIndexId='"+leadIndexId+"']");
}
function getBlackCreamTeamGroupRooms (leadIndexId) {
	return $j("div[id='blackCreamBlock'][leadIndexId='"+leadIndexId+"']");
}
// プラン設定機能
function openMiniPlanSetup(item) {
	// プラン明細を展開する 
	var planItem = $j("#planCustomeBtn").data("jinyaPlanExtend");
	planItem.switchStatus();
}
// 2014/09/22 部屋一括清掃処理機能
// area :アリア
// floor:フロア
// that : クリックされたボタン
function roomCleanShow(that,area, floor) {
	if(!_g_isCanUpdateFlg) return;
	// 部屋一括清掃処理機能
	var isAllAreaClean = (floor == undefined ? true : false);
	var targets = null;
	// アリアの清掃対象部屋
	if (isAllAreaClean) targets = $j("input[id='mid_cleanRoomId'][attrisnoclean='true'][attrareaname='"+area+"']");
	// アリア＆フロアの清掃対象部屋
	else targets = $j("input[id='mid_cleanRoomId'][attrisnoclean='true'][attrareaname='"+area+"'][attrfloorname='"+floor+"']");
	// 対象の清掃対象部屋
	targets.each(function() {
		var $this = $j(this)
		$this.prop("checked","true");
		$this.parent().show();
	});
	// 画面の清掃の制御フラグ
	stopRunning();
	// 清掃ボタンをクリックの関連処理
	//清掃
	var cleanBtn = $j("<input type='button' value='{!$Label.MSG_008_0086}'/>").click(function(){
		var checkElement = $j("input[id='mid_cleanRoomId'][attrisnoclean='true'][attrareaname='"+area+"']");
		var roomIds = new Array();
		checkElement.each(function(){
			if($j(this).prop("checked")) roomIds.push($j(this).val());
			startRunning();
		});
		// 部屋クリア処理を行う
		if(roomIds.length > 0) roomCleanActComm(roomIds);
		else {
			//清掃の対象部屋がありません。
			alert("{!$Label.MSG_008_0087}");
			cancelBtn.click();
		}
	});
	// 清掃の処理の取り消し機能
	//取消
	var cancelBtn = $j("<input type='button' value='{!$Label.MSG_008_0088}'/>").click(function(){
		$j(this).parent("div").remove();
		$j(".honkanBtn").show();
		$j("input[id='mid_cleanRoomId'][attrisnoclean='true'][attrareaname='"+area+"']").parent("span").hide();
		startRunning();
	});
	var div = $j("<div>");
	div.append(cleanBtn);
	div.append("<br/><br/>");
	div.append(cancelBtn);
	$j(that).parent("td").append(div);
	$j(".honkanBtn").hide();
}
// 画面自動更新するがどうか判断処理を行う
function callAutoUpdatePageFun() {
	if(isCanRunning()) {
		LookupHoverDetail.hideHoversExpectDetailShow();
		autoFunExcuteFlag = true;
		// 画面最新情報を取得する
		timerRefreshInfoFun();
		// 連絡画面最新情報を取得する
		// 2017/02/23 連絡事項を非表示の場合のBugFix BEGIN
		if (typeof _messageComp_refreshMessage === "function") _messageComp_refreshMessage();
		//_messageComp_refreshMessage();
		// 2017/02/23 連絡事項を非表示の場合のBugFix END
	}
}
// 機能起動可否判断を行う
// 清掃処理の場合、部屋の詳細情報の照会、団体の全体見える機能処理中止制御
function isCanRunning() {
	return canRefreshFlag;
}
function stopRunning() {
	canRefreshFlag = false;
	clearTimeout(intervalId);
}
function startRunning() {
	canRefreshFlag = true;
	// Timer Define
	clearTimeout(intervalId);
	intervalId = setTimeout(callAutoUpdatePageFun, timerInterval);
}

// Idにより、Window情報を起動する
function showMiniInfoWin(prefix, objId, isShow) {
//console.debug("showMiniInfoWin::" + prefix + '|' + objId + '|' + isShow);
	if (objId == "") return;
	var itemId = prefix + objId;
	if (isShow) {
		LookupHoverDetail.getHover(itemId, '/'+objId+'/m?retURL=%2F'+objId+'&amp;isAjaxRequest=1').show();
	} else {
		LookupHoverDetail.getHover(itemId).hide();
	}
}
//
LookupHoverDetail.hideHoversExpectDetailShow = function () {
    var a = LookupHoverDetail.hovers,
        b;
    for (b in a) 
    {
    	if(b.indexOf('detail') >= 0) continue;
    	a.hasOwnProperty(b) && a[b].hide();
    }
};
// Tilteに旧暦情報を表示する（分単位に表示する)
function setQrekiToTilte() {
	// yyyy-MM-dd HH:mm
	var $title = $j("div[id$=':roomIndicator']").find(".pbHeader").find(".pbTitle").find(".mainTitle");
	var rRoomsStaInfo = $j("#rRoomsStatusinfoHid").val();
	var rRoomsStaColorInfo = $j("#rRoomsStatusColorinfoHid").val();
	var nowInfo = $title.text();
	var nowDate = Date.parse(nowInfo.substr(0,10));
	var substr1 = nowInfo.substr(0,11);
	var substr2 = nowInfo.substr(14,6);
	var yobi = "<span style='font-size:14px'>" + nowInfo.substr(12,1) + "</span>";
	var holiday = "<span style='font-size:14px'>" + nowInfo.slice(20) + "</span>";
	var leftMark = "<span style='font-size:14px;vertical-align:top'>" + nowInfo.substr(11,1) + "</span>";
	var rightMark = "<span style='font-size:14px;vertical-align:top'>" + nowInfo.substr(13,1) + "</span>";
	var jd = nowDate.getJD();
	var d = new kyureki(jd);
	var rokuyo = "<span style='font-size:14px'>" + " " + d.rokuyo + "</span>";
	var rRoom = "<span style='font-size:14px;color: " + rRoomsStaColorInfo + "'>" + " " + rRoomsStaInfo + "</span>";
	var outstr = "<span>" + [substr1,leftMark,yobi,rightMark,substr2,holiday, rokuyo, rRoom].join('') + "</span>";
	// 指定日の日付
	var $processdt = $j("#showCalendarInfo")
	var strProcessDt = $processdt.text();
	var queryDate = Date.parse(strProcessDt.substr(0,10));
	jd = queryDate.getJD();
	d = new kyureki(jd);
	var outstr2 = d.rokuyo;
	$title.html(outstr);
	$processdt.text(strProcessDt + " " + outstr2);
	
}
// 2015/10/28 プラン明細表示のRESET
function planRest(){
	// 前に設定するプラン商品と金額情報をクリアする
	var planItem = $j("#planCustomeBtn").data("jinyaPlanExtend");
	planItem.reset();
}
// 2015/10/28 CTI->PAST機能対応
function _call_pasteInfo() {
	$j("[id$=':relcontact']").unbind('paste');
	$j("[id$=':relcontact']").bind('paste',function(e){
		// 2017/09/23 新規予約ウインドウ、お客様情報反映されない不具合改修 WGCH BEGIN
		var $relcontact = $j(this);
		$relcontact.autocomplete('search', this.value);
		// 2017/09/23 新規予約ウインドウ、お客様情報反映されない不具合改修 WGCH END
		var pastedText = undefined;
		if (window.clipboardData && window.clipboardData.getData) {
			pastedText = window.clipboardData.getData('Text');
		}else {
			pastedText = e.originalEvent.clipboardData.getData('Text');
		}
		/* 2015/11/09 CTI->PAST機能対応
		if (pastedText.indexOf('#') > 0) {
			e.preventDefault();
			$j("[id$=':relcontact']").val(pastedText.split('#')[0]);
			$j("input[id$=':relcontact_lkid']").val(pastedText.split('#')[1]);
			$j("[id$=':relcontact']").blur();
		}*/
		cti_call_pasteInfo(e, pastedText);
	});
}
// 2015/11/09 CTI->PAST機能対応
function cti_call_pasteInfo(e, pastedText) {
	// 入力WINが非表示の場合、自動設定処理中止
	if ($j("#createLeadPanel_c").css("visibility") == "hidden") return false;
	if (pastedText != undefined && pastedText.indexOf('#') > 0) {
		if (e != null) e.preventDefault();
		$j("[id$=':relcontact']").val(pastedText.split('#')[0]);
		$j("input[id$=':relcontact_lkid']").val(pastedText.split('#')[1]);
		$j("[id$=':relcontact']").blur();
	}
	return true;
}
/* 指定ElementまでのPostionを取得する 2014/12/08 NEW ADD */
(function($){
    $.fn.offsetRelative = function(top){
        var $this = $(this);
        var $parent = $this.offsetParent();
        var offset = $this.position();
        if(!top) return offset; // Didn't pass a 'top' element 
        else if($parent.get(0).tagName == "BODY") return offset; // Reached top of document
        else if($(top,$parent).length) return offset; // Parent element contains the 'top' element we want the offset to be relative to 
        else if($parent[0] == $(top)[0]) return offset; // Reached the 'top' element we want the offset to be relative to 
        else { // Get parent's relative offset
            var parent_offset = $parent.offsetRelative(top);
            offset.top += parent_offset.top;
            offset.left += parent_offset.left;
            return offset;
        }
    };
    $.fn.positionRelative = function(top){
        return $(this).offsetRelative(top);
    };
}(jQuery));
/* Window:F5 / Ctrl+R  Mac:Command+R 対応[2015/07/10 ADD] */
$j(document).ready(function() {
	
	var $key = key.noConflict();
	$key.filter = function(event){
		// 全画面から画面更新可能
		return true;
	}
	$key('command+r, ctrl+r, f5', function(e){ 
		if (isCanRunning()) {
			stopRunning();
			// 2015/10/30 最新情報の取得　かつ　ルームインジケータ、タイムテーブル（旧）かつ　連絡事項最新情報を表示
			//refreshInfoFun();
			refreshRoomAndMessage();
		}
		e.preventDefault();
		return false;
	});
	// 2019/09/30 新規予約など、保存(Ctrl+S)対応 WGCH BEGIN
	$key('command+s, ctrl+s', function(e){
		if($j("#createLeadPanel_mask").is(":visible")) doBeforeSave();
		e.preventDefault();
		return false;
	});
	$key('command+s, ctrl+s', function(e){
		if($j("#myPanel_mask").is(":visible")) $j("#chgNightsSaveBtn").click();
		e.preventDefault();
		return false;
	});
	// 2019/09/30 新規予約など、保存(Ctrl+S)対応 WGCH END
});

// 2016/12/07 ルームインジケータ新規後一画面へ遷移 BEGIN by zh
	function gotoBookingFlexApp(strId){
		var gotoBookingFlexAppFlg = {!RoomTypeGotoBookingFlexApp};
		var GotoBookingFlexAppConfirm = {!RoomTypeGotoBookingFlexAppConfirm};
		if(gotoBookingFlexAppFlg) {
			// 2017/02/08 一画面へ新規開く対応 BEGIN
			//window.location.href = '/apex/BookingApp?id=' + strId + '&spcd=' + '{!branchShopNm}';
			var _openUrl = '/apex/BookingApp?id=' + strId + '&spcd=' + '{!JSENCODE(branchShopNm)}';
			window.open(_openUrl,"_blank");
			// 2017/02/08 一画面へ新規開く対応 END
			//window.location.href = '/apex/BookingFlexApp?id=' + strId;
		}else{
			if(GotoBookingFlexAppConfirm){
				//一括予約画面へ遷移しますか？
				if(!confirm("{!$Label.MSG_008_0121}")) return;
				//window.location.href = '/apex/BookingFlexApp?id=' + strId;
				// 2017/02/08 一画面へ新規開く対応 BEGIN
				//window.location.href = '/apex/BookingApp?id=' + strId + '&spcd=' + '{!branchShopNm}';
				var _openUrl = '/apex/BookingApp?id=' + strId + '&spcd=' + '{!JSENCODE(branchShopNm)}';
				window.open(_openUrl,"_blank");
				// 2017/02/08 一画面へ新規開く対応 END
			}
		}
	}
// 2016/12/07 ルームインジケータ新規後一画面へ遷移 END by zh
// 2017/12/22 画面フィルター機能追加　by　zy　BEGIN
function ajaxRefreshFilterRoom(filterText){
	//var spcd = '{!branchShopNm}';
	//if (spcd == undefined || spcd == null) spcd = "";
	var spcd = _getDefShopCode(true);
	// 指定日取得
	var queryDate = getQueryDate(); 
    // 当日はチェックイン情報・チェックアウト情報表示制御フラグ
    var isShowTodayInfo = getShowTodayFlg();
	$j("#loadIcon").show();
	// 事前チェックを行う
	Visualforce.remoting.Manager.invokeAction(
	   "{!$RemoteAction.RoomIndicatorInfo.getFilterRooms}", filterText,spcd,queryDate,isShowTodayInfo, function(result, event){
	   var roomArr = [];
	   if ( result != undefined && result != "" && result != null) {
	   	  roomArr = result;
	   }
	   var filterStr = $j("#filterInput").val();
	   if (filterStr == "") {
	   	  $j("#loadIcon").hide();
	      return;
	   }
	   filterRowRoom(roomArr,filterText);
	   $j("#loadIcon").hide();
	});
}
// 2017/12/22 画面フィルター機能追加　by　zy　END
// 2020/02/28 ルームインジケータ、タイムテーブル改修対象画面 BY zyz BEGIN
// 指定フラグ取得
function getConfirmFlg(){
	return $j("#hidConfirmFlg").val() == "true";
}
// 2020/02/28 ルームインジケータ、タイムテーブル改修対象画面 BY zyz END
</script>

<!-- 2016/10/13 BEGIN by zh -->
<script>
//見積もり明細のフラグ
var detailEventFlag = {!isPlanDetailFlag};
/** 書式処理 */
var currency = kendo.culture().numberFormat.currency;
var _CONST_PRICE_ROOM_TYPE = '室料';			// 室料のKeyWord定義する
currency.decimals = JINYACONNECT.NumberPointLen;
currency.symbol = JINYACONNECT.CurrencySybmol;
currency.pattern = ["$-n","$n"];
JINYACONNECT.CUSTOM.checkIfHadRequiredItem = function (){
   	// CKEDITOR情報は実勢の項目にコピーする
       CKEDITOR.jinya.copyValue($j, "ckeditorClass");
   	var checkFlag = false;
	$j(".repuiredClass").each(function(){
		$this = $j(this);
		if(($this[0].tagName == "INPUT" && $this[0].type != "checkbox") || $this[0].tagName == "SELECT" || $this[0].tagName == "TEXTAREA" ){
			if($j(this).val()  == "") {
				checkFlag = true;
				//return false;
			}
		}else if($this[0].tagName == "SPAN"){
			if ($j(this).text() == ""){
				checkFlag = true;
				//return false;
			}
		}
	});
	if (checkFlag) {
	if(!$j("[id$=inputLeadFormMsg] div.message").is(":visible"))
		$j("#inputFormErrorMsg").show();
		$j("#createLeadPanel div.bd").scrollTop(0);
		return false;
	}else
		$j("#inputFormErrorMsg").hide();
	return true;
}
    
function clearBookingItem(){
	// Error Message Panel Clear[Attention: Error Class IDはSF設定依存]
    var showDiv = $j("div.errorM3:visible");
	if (showDiv.length > 0 ) showDiv.hide();
    clearAutoCompletePanel();
    if (detailEventFlag){
	    //$j("#inputFormErrorMsg").hide();
	    $j("tr.tranDetailRow").each(function(){
	    	var $this = $j(this);
	    	var curDiv = $j("div.pointIndex",$this);
			var rowIndex = curDiv.attr("rowindex");
	    	dispExtendImg("hidden", rowIndex);
	    	for (var i = 0; i < JINYACONNECT.CUSTOM.clearItemIdArr.length; i++){
	            clearObj = $j("[id$=':BookEstTable:" + rowIndex + JINYACONNECT.CUSTOM.clearItemIdArr[i] + "']");
	            if (clearObj.is(":checkbox")) {
	                clearObj.removeAttr('checked');
	            } else if (clearObj.is("select")) {
	                clearObj.get(0).selectedIndex = 0;
	            } else if (clearObj.is("span")) {
	                clearObj.text("");
	            } else {
	            	clearObj.get(0).defaultValue = '';
	                clearObj.val("");
	            }
	        }
	    });
	    $j("tr.tranDetailRow").hide();
	    setupCalSumAmountPrice();
    }
    // 2019/04/15 ベネフィットホテル様より改善要望 by zy BEGIN
    clearProdWin();
    // 2019/04/15 ベネフィットホテル様より改善要望 by zy END
    $j(".rowStr").closest("tr.dataRow").remove();
}


// 2016/10/13 BEGIN 
JINYACONNECT.CUSTOM.detailBindEvent = function(){
    // Clear Button
    $j("input[id='clearProduct']").unbind("click");
    $j("input[id='clearProduct']").click(function() {
        var groupindex = $j(this).attr("rowindex");
        // 2020/07/30 入湯税の自動入力機能について改善 WGCH BEGIN
		// 联动清空处理第一次Plan行对应的入汤税商品
		ACTCUSTOM.PROBATHTAXROWFUN(groupindex, ACTCUSTOM.TPYE.CLEAR);
        // 2020/07/30 入湯税の自動入力機能について改善 WGCH END
        // 2019/04/30 増税仮対応 WGCH BEGIN
        var productId = $j("input:hidden[id$=':" + groupindex + ":hidProductId']").val();
        // 2019/04/30 増税仮対応 WGCH END
        dispExtendImg("hidden", groupindex); // 展開imgを非表示にする
        // 2019/04/15 ベネフィットホテル様より改善要望 by zy BEGIN
        // 同じ行クリア
        if(("lastIndex" in window) && window.lastIndex == kendo.parseInt(groupindex)) {
          delete window.productId;
          delete window.lastIndex;
        }
        // 2019/04/15 ベネフィットホテル様より改善要望 by zy END
        for (var i = 0; i < JINYACONNECT.CUSTOM.clearItemIdArr.length; i++){
            clearObj = $j("[id$=':BookEstTable:" + groupindex + JINYACONNECT.CUSTOM.clearItemIdArr[i] + "']");
            if (clearObj.is(":checkbox")) {
                clearObj.removeAttr('checked');
            } else if (clearObj.is("select")) {
                clearObj.get(0).selectedIndex = 0;
            } else if (clearObj.is("span")) {
                clearObj.text("");
            } else {
                clearObj.val("");
            }
        }
        // 2016/11/21 見積明細設定機能対応 点击clear、关键字检索的窗口关闭  BEGIN by zh
        clearAutoCompletePanel();
        // 2016/11/21 見積明細設定機能対応  点击clear、关键字检索的窗口关闭  END by zh
        setupCalSumAmountPrice();
        // 2019/04/30 増税仮対応 WGCH BEGIN
        // 增税商品-自动设定
        autoSetTaxIncProductFun(CUST_CLICKMODE_CLEAR, productId);
        // 2019/04/30 増税仮対応 WGCH END
    });
    $j("img[name='productPopup']").unbind("click");
    $j("img[name='productPopup']").click(function() {
        var groupindex = $j(this).attr("rowindex");
        // 2019/04/15 ベネフィットホテル様より改善要望 by zy BEGIN
        var bookingEstFlag = "{!$Setup.CommDefine__c.ps__ProductSearchLayoutKbn__c}";
        if (bookingEstFlag == "1") return openProductWin(groupindex);
        // 2019/04/15 ベネフィットホテル様より改善要望 by zy END
        // 引き渡し値を設定して、選択画面を開く
        ctrlNm = $j("input:text[id$=':" + groupindex + ":productName']").get(0);
        ctrlId = $j("input:hidden[id$=':" + groupindex + ":hidProductId']").get(0);
        ctrlHidNm = $j("input:hidden[id$=':" + groupindex + ":hidProductNm']").get(0);
        ctrlPriceId = $j("[id$=':" + groupindex + ":price']").get(0);
        ctrlOrderNumId = $j("[id$=':" + groupindex + ":orderNums']").get(0);
        ctrlTaxRate = $j("span[id$=':" + groupindex + ":taxRateType']").get(0);
        ctrlHidTaxRate = $j("input:hidden[id$=':" + groupindex + ":hidTaxRateType']").get(0);
        ctrlServiceTaxRate = $j("span[id$=':" + groupindex + ":serviceRate']").get(0);
        ctrlHidServiceTaxRate = $j("input:hidden[id$=':" + groupindex + ":hidServiceRate']").get(0);
        ctrlSpecialTax = $j("span[id$=':" + groupindex + ":specialTax']").get(0);
        ctrlHidSpecialTax = $j("input:hidden[id$=':" + groupindex + ":hidSpecialTax']").get(0);
        ctrlHidActionType = $j("input:hidden[id$=':" + groupindex + ":hidActionType']").get(0);
        ctrlHidPaymentType = $j("input:hidden[id$=':" + groupindex + ":hidPaymentType']").get(0);
        ctrlHidPlanDetail = $j("input:hidden[id$=':" + groupindex + ":hidPlandetail']").get(0);
        ctrlHidHadRoomFlag = $j("input:hidden[id$=':" + groupindex + ":hidHadRoomFlag']").get(0);
        
        // 2018/07/27 宿泊税計算 WGCH BEGIN
        ctrlHidPDetailId = $j("input:hidden[id$=':" + groupindex + ":hidPDetailId']").get(0);
        // 2018/07/27 宿泊税計算 WGCH END
        // 2019/07/30 軽減税率機能対応 WGCH BEGIN
        ctrlHidPlanBrkInfoId = $j("input:hidden[id$=':" + groupindex + ":hidPlanBrkInfoId']").get(0);
        // 2019/07/30 軽減税率機能対応 WGCH END
        // 2020/07/30 入湯税の自動入力機能について改善 WGCH BEGIN
        hidBTaxAccMstItem = $j("input:hidden[id$=':" + groupindex + ":hidBTaxAccMstItem']").get(0);
        // 2020/07/30 入湯税の自動入力機能について改善 WGCH END
        var openUrl = "/apex/ProductSearch?idx=" + groupindex + "&par=true";
        // 呼び出し順番とPOPUP画面の設定順番は必ず一致するが必要
        objs = new Array(ctrlNm, ctrlId, ctrlHidNm, ctrlPriceId, ctrlOrderNumId,
            ctrlTaxRate, ctrlHidTaxRate, ctrlServiceTaxRate, ctrlHidServiceTaxRate, ctrlSpecialTax, ctrlHidSpecialTax, ctrlHidActionType,ctrlHidPaymentType,ctrlHidPlanDetail,ctrlHidHadRoomFlag);
        // 2018/07/27 宿泊税計算 WGCH BEGIN
        for(var i = 0; i < 1; i++) objs.push($j('<input/>').get(0));
        objs.push(ctrlHidPDetailId);
        // 2018/07/27 宿泊税計算 WGCH END
        // 2019/07/30 軽減税率機能対応 WGCH BEGIN
        objs.push(ctrlHidPlanBrkInfoId);
        // 2019/07/30 軽減税率機能対応 WGCH END
        // 2020/07/30 入湯税の自動入力機能について改善 WGCH BEGIN
        // 占位_エステなど商品_エステなど商品的JSON就可以满足此需求_减少页面Size
        objs.push(hidBTaxAccMstItem);
        // 2020/07/30 入湯税の自動入力機能について改善 WGCH END
        commUtils.popup(openUrl, "SearchProductInfo", objs, null, null, popupCallback(groupindex));
    });
    // 商品金額関連項目監視設定
    $j("input[id$=':orderNums']").unbind("change");
	$j("input[id$=':orderNums']").on('change', function(e){
		$this =$j(this);
		if (kendo.parseFloat($this.val()) == null) $this.val("0");
		var rowIndex = $this.closest('tr').children().first().children().first().attr("rowindex");
		// 2020/07/30 入湯税の自動入力機能について改善 WGCH BEGIN
		// 处理设定第一次Plan行对应的入汤税商品
		ACTCUSTOM.PROBATHTAXROWFUN(rowIndex, ACTCUSTOM.TPYE.NUMS);
        // 2020/07/30 入湯税の自動入力機能について改善 WGCH END
		setupCalAmoutPrice(rowIndex, false);	
	});
    // 会計商品AutoComplete[1桁以上]
    $j("input[id$=':productName']").autocomplete({
        minLength: 1,
        source: function (request, response) {
            Visualforce.remoting.Manager.invokeAction(
                "{!$RemoteAction.RoomIndicatorInfo.getArrayProductDetailItemInfo}", request.term, function(result, event){
                if (event.type == 'exception') {
                    alert(event.message);
                } else {
                    response($j.map(result, function (item) {
                    	item.id = item.productId;
                    	item.value = item.prodcutName + "("+item.prodcutCode+")";
                    	return item;
                    }));
                } // End else
            });
        },
        focus: function (event, ui) {
	    	var groupindex = $j(this).attr("rowIndex");
    		ui.item.rowIndex = groupindex;
    		// 2019/04/30 増税仮対応 WGCH BEGIN
    		// autoGetProductInfo(ui.item);
    		autoGetProductInfo(ui.item, CUST_AUTOGETPRODUCTMODE_RETURN);
    		// 2019/04/30 増税仮対応 WGCH END
            return false;
        },
        select: function (event, ui) {
	    	var groupindex = $j(this).attr("rowIndex");
    		ui.item.rowIndex = groupindex;
            autoGetProductInfo(ui.item);
            // 2019/11/15 最近利用している商品一覧機能を提供する BY zyz BEGIN
            if ("accMasterFun" in window) accMasterFun(ui.item.id);
            // 2019/11/15 最近利用している商品一覧機能を提供する BY zyz END
            // 2020/07/30 入湯税の自動入力機能について改善 WGCH BEGIN
            // 触发追加入汤税行
            ACTCUSTOM.BATHTAXAUTOSETFUN(groupindex, ui.item.bTaxAccMstItem);
            // 2020/07/30 入湯税の自動入力機能について改善 WGCH END
            event.stopImmediatePropagation();
            return false;
        },
    });
    $j("input[id$=':price']").unbind("change");
    $j("input[id$=':price']").on("change",function(){
    	$this =$j(this);
		if (kendo.parseFloat($this.val()) == null) $this.val("0");
		var rowIndex = $this.closest('tr').children().first().children().first().attr("rowindex");
		setupCalAmoutPrice(rowIndex, false);	
    });
    // 2017/01/12 统一行追加功能改修 by zy BEGIN
    lastBookingDetail();
    //$j("input[id$=':price'],input[id$=':orderNums'],input[id$=':productName']").unbind("blur");
    //$j("input[id$=':price'],input[id$=':orderNums'],input[id$=':productName']").on("blur",function(){
    	/*
    	// 入力できる行目がなかった場合、自動追加する
    	var _productsArr = $j("input[id$=':productName']");
    	// ISBALNK存在の場合、
    	var blankLineNoExist = true;
    	for (i=(_productsArr.length-1);i>=0;i--) {
    		if (_productsArr[i].value == "") {
    			blankLineNoExist = false;
    			break;
    		}
    	}
    	if (blankLineNoExist) {
    		checkAddTranItem();
    	}*/
    //	_checkDetailFullInputFun();
    //});
    // 2017/01/12 统一行追加功能改修 by zy END
    // Drop Acton
	$j("[id$=BookEstTable]").kendoDraggable({
		//2017/01/18 鼠标选中 行追加失效功能添加 by zy BEGIN
		filter:'.pointIndex:not(.disabled)',
		//2017/01/18 鼠标选中 行追加失效功能添加 by zy END
		hint: function(e) {
			dragLeadElement = $j(e).parents("tr.tranDetailRow");
			var cloneELment = dragLeadElement.clone();
			return cloneELment;
		},
		dragstart: draggableOnDragStart,
		dragend: draggableOnDragEnd
	});
	$j("[id$=BookEstTable] tbody tr.tranDetailRow").kendoDropTarget({
		drop: itemdroptargetOnDrop
	});
	$j("tr.tranDetailRow").each(function(){
		var $this = $j(this);
		var price = $this.find("input[id$=price]").val();
		if (price != ""){
			var curRowIdx = $j("input[id$=clearProduct]",$this).attr("rowindex");
			setupCalAmoutPrice(curRowIdx, false);
		}
	});
	switchPriceStatus();
}
// ポップ商品選択後の自動処理
function popupCallback(groupindex) {
	return function () {
		// 2018/07/27 宿泊税計算 WGCH BEGIN
		planItemPriceMap.set(getPlanKeyFun(groupindex), JSON.parse( $j("input[id$='" + groupindex + ":hidPDetailId']").val() ) );
		// 2018/07/27 宿泊税計算 WGCH END
		// 2019/07/30 軽減税率機能対応 WGCH BEGIN
		if(isReducedTaxFlg){
			var pdProductItem = JSON.parse( $j("input[id$='" + groupindex + ":hidPlanBrkInfoId']").val() );
			if(!commUtils.isEmpty(pdProductItem)) _planItemMap.set(getPlanKeyFun(groupindex), pdProductItem);
		}
		// 2019/07/30 軽減税率機能対応 WGCH END
		showProduInfoToView(groupindex);
		// 2017/01/12 统一行追加功能改修 by zy BEGIN
		_checkDetailFullInputFun(groupindex);
		// 2017/01/12 统一行追加功能改修 by zy END
		// 2020/07/30 入湯税の自動入力機能について改善 WGCH BEGIN
		// ポップ商品選択後の入湯税自動処理
		ACTCUSTOM.POPUPCALLBACKFUN(groupindex);
		// 2020/07/30 入湯税の自動入力機能について改善 WGCH END
	}
}
function popupChildCallback(groupIndex) {
	return function() {
		_autoGetSetupSyncInfo(groupIndex)
		// 2018/07/27 宿泊税計算 WGCH BEGIN
		setupCalAmoutPrice(groupIndex, false);
		// 2018/07/27 宿泊税計算 WGCH END
	}
}
// 2019/04/30 増税仮対応 WGCH BEGIN
// function showProduInfoToView(groupindex) {
function showProduInfoToView(groupindex, mode) {
// 2019/04/30 増税仮対応 WGCH END
	// プラン設定の切り替え
	var actType = $j("input:hidden[id$=':" + groupindex + ":hidActionType']").val();
   	if(actType == "{!ACTTYPE_PLAN}"){
       	dispExtendImg("visible", groupindex);
       	/*
       	var hidRoomFlag = $j("input[id$=':" + groupindex + ":hidHadRoomFlag'").val();
		if (hidRoomFlag  == "true" ) {
			var roomPrice = $j("#hidCurRackRatePrice").val(); 
			var detailPrice = $j("input[id$=':"+ groupindex + ":price']").val();
			if (roomPrice){
				//ラックレート　判断
				var summartPrice = commUtils.mathNumAdd(roomPrice,detailPrice);
				$j("input[id$=':"+ groupindex + ":price']").val(summartPrice);
			}
		}*/
	} else{ 
       	dispExtendImg("hidden", groupindex);
   	}
   	// 元の設定情報をクリアを行う
   	// 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH BEGIN
	if(!orderNumsFlg) $j("input:hidden[id$=':" + groupindex + ":hidSyncInfo']").val("");
	// 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH END
    // 宿泊税は０の場合、空白に設定を行う
    //2016/10/26 設定エラー　BEGIN
    /*var specialTax = $j("input:text[id$=':" + groupindex + ":specialTax']").val();
    if (1 * specialTax == 0) $j("input:text[id$=':" + groupindex + ":specialTax']").val("");
    var curDiv = $j("table[id$=BookEstTable] tr.tranDetailRow").eq(groupindex).find("div.pointIndex");
	var rowIndex = curDiv.attr("rowindex");
	setupCalAmoutPrice(rowIndex, true);	*/
	var specialTax = $j("input[id$=':" + groupindex + ":hidSpecialTax']").val();
    if (1 * specialTax == 0) $j("span[id$=':" + groupindex + ":specialTax']").text("0");
    // 2019/04/30 増税仮対応 WGCH BEGIN
    // setupCalAmoutPrice(groupindex, true);	
    setupCalAmoutPrice(groupindex, true, mode);
    // 2019/04/30 増税仮対応 WGCH END
	//2016/10/26 設定エラー　END
    // ステータス切替
    switchPriceStatus();
}
function itemdroptargetOnDrop(e) {
	$j(e.dropTarget).before($j(dragLeadElement));
}
// 見積書順位調整JS
function draggableOnDragStart(e) {
	$j(dragLeadElement).hide();
	var imgFun = $j(dragLeadElement).find('img[id^=showDetailEvent]');        
	if(imgFun.attr("openStatus")=="true"){
	    showDetailFun(imgFun);
	}
}
function draggableOnDragEnd(e) {
	var draggable = $j('table').data("kendoDraggable");
	$j(dragLeadElement).show();
	// 2016/10/27 BEGIN
    //refreshOrder();
    refreshOrder(false);
    // 2016/10/27 END
    //2017/01/16 行追加共通化　by　zy BEGIN
	setTimeout(function(){
		$j(".lastBlurRow").unbind("blur");
		$j(".lastBlurRow").removeClass("lastBlurRow");
		lastBookingDetail();
	},300);
	//2017/01/16 行追加共通化　by　zy END
}
function refreshOrder(isComputeBlankFlag){
	var rowIndex = 0;
	// 2016/10/26 BEGIN
	var nowProdArr = new Array();
	$j("[id$=BookEstTable] tbody tr.tranDetailRow").each(function(){
	if(isComputeBlankFlag){
			if($j(this).find('[id$=hidProductId]').val() !=''){
				$j(this).find('[id$=hidRowNo]').val(rowIndex);
				rowIndex++;
			}else 
				nowProdArr.push(this);
	}else {
		//if($j(this).find('[id$=productName]').val() !=''){
			$j(this).find('[id$=hidRowNo]').val(rowIndex);
			rowIndex++;
		}
	// 2016/10/26 END
	});
	if(isComputeBlankFlag && nowProdArr.length > 0){
		for (var i = 0; i < nowProdArr.length;i++) {
			$j(nowProdArr[i]).find('[id$=hidRowNo]').val(rowIndex);
			rowIndex++;
		}
	}
}
// 最新商品情報を取得する
// 2019/04/30 増税仮対応 WGCH BEGIN
// function autoGetProductInfo(result) {
function autoGetProductInfo(result, mode) {
// 2019/04/30 増税仮対応 WGCH END
	// 存在の商品情報は画面へ反映する
	var groupindex = result.rowIndex;
    
    var taxRate = kendo.parseFloat(result.tax);
    if (taxRate == null) taxRate = 0;
    var taxValLabel = (kendo.toString(commUtils.mathNumDiv(taxRate, 100), "{!JSENCODE(TaxNumberFormat)}"));
    var serviceLabel = (　result.serviceRate == "" ? "0%" : result.serviceRate + "%");
  
	$j("input:text[id$=':" + groupindex + ":productName']").val(result.prodcutName);
	$j("input:hidden[id$=':" + groupindex + ":hidProductId']").val(result.productId);
	$j("input:hidden[id$=':" + groupindex + ":hidProductNm']").val(result.prodcutName);
	$j("input:text[id$=':" + groupindex + ":price']").val(result.unitPrice);
	$j("input:text[id$=':" + groupindex + ":orderNums']").val(1);
	$j("span[id$=':" + groupindex + ":taxRateType']").text(taxValLabel);
	$j("input:hidden[id$=':" + groupindex + ":hidTaxRateType']").val(result.tax);
	$j("span[id$=':" + groupindex + ":serviceRate']").text(serviceLabel);
	$j("input:hidden[id$=':" + groupindex + ":hidServiceRate']").val(result.serviceRate);
	$j("span[id$=':" + groupindex + ":specialTax']").text(result.specialTax);
	$j("input:hidden[id$=':" + groupindex + ":hidSpecialTax']").val(result.specialTax);
	$j("input:hidden[id$=':" + groupindex + ":hidActionType']").val(result.actionType);
	// 2015/10/16 プラン明細課税、非課税混在合計金額計算対応 BEGIN
    $j("input:hidden[id$=':" + groupindex + ":hidPlandetail']").val(result.unitPriceExcTax);
    // 2015/10/16 プラン明細課税、非課税混在合計金額計算対応 END
    // 2016/08/30 BEGIN
    $j("input:hidden[id$=':" + groupindex + ":hidHadRoomFlag']").val(result.hadRoomFlag);
    // 2016/08/30 END
    // 2018/07/27 宿泊税計算 WGCH BEGIN
    planItemPriceMap.set(getPlanKeyFun(groupindex), result.planItemPriceLst);
    // 2018/07/27 宿泊税計算 WGCH END
    // 2019/07/30 軽減税率機能対応 WGCH BEGIN
    if(isReducedTaxFlg){
    	// 支付种别
    	$j("input:hidden[id$=':" + groupindex + ":hidPaymentType']").val(result.paymentType);
    	// 如果有PLAN明细加到MAP里
    	if(!commUtils.isEmpty(result.pdProductItem)) _planItemMap.set(getPlanKeyFun(groupindex), result.pdProductItem);
    }
    // 2019/07/30 軽減税率機能対応 WGCH END
   	// 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH BEGIN
   	if(orderNumsFlg){
   		var $obj = $j("#showDetailEvent" + groupindex);
   		// $obj.attr("syncShow","true");
   		$j("input:hidden[id$=':" + groupindex + ":hidSyncInfo']").val(result.planSyncInf);
	   	if((result.prodNum !="" && result.prodNum != undefined) || result.prodNum == 0){
	   	 	$j("input:text[id$=':" + groupindex + ":orderNums']").val(result.prodNum);
	   	 	$j("input:hidden[id$=':" + groupindex + ":hidBasePlanNum']").val(result.prodNum);
	   	}
		$j("input:hidden[id$=':" + groupindex + ":hidEstGuestType']").val(result.guestType || "");
   	}
   	// 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH END
    // 2019/04/30 増税仮対応 WGCH BEGIN
    // showProduInfoToView(groupindex);
    showProduInfoToView(groupindex, mode);
    // 2019/04/30 増税仮対応 WGCH END
}
function _autoGetSetupSyncInfo(groupIndex) {
	var planSyncInf = "";
	var sumVal = 0;
	var isHaveShituliaoFlag = false;
	//$("[class='"+ childcls +"']").each(function(idx){
	$j("input[id^='"+groupIndex+"_prodName_']").each(function(idx){
		var rowidx = $j(this).attr("rowidx");
		var hidFieldId = groupIndex + "_sobjId_" + rowidx;
		var hidProdId = groupIndex + "_prodid_" + rowidx;
		var hidProdNm = groupIndex + "_prodName_" + rowidx;
		var unitPrice = groupIndex + "_prodPrice_" + rowidx;
		//sumVal += 1 * unitPrice;
		//sumVal = commUtils.mathNumAdd(sumVal,unitPrice);
		var unitPrice = $j("#"+unitPrice).val().replaceAll(",","");
		if(unitPrice == "" || !unitPrice || isNaN(parseFloat(unitPrice)) ) unitPrice = 0;
		// 見積明細ID/プラン明細ID ： 単価 ： 会計商品ID ： 会計商品名
		planSyncInf += $j("#"+hidFieldId).val() + ':' + unitPrice + ':' + $j("#"+hidProdId).val()+ ':' + $j("#"+hidProdNm).val() +';';
		sumVal = commUtils.mathNumAdd(sumVal,unitPrice);
		
		var actionType = $j("#"+groupIndex+"_workHidActType_" + rowidx).val();
		$j(this).closest("tr").find("td>input.showDetailEvent" + groupIndex + "_child").attr("data-actiontype",actionType);
		// 2018/07/27 宿泊税計算 WGCH BEGIN
		planItemTypeMap.set((groupIndex + "_t_" + $j("#"+hidFieldId).val()), actionType);
		// 2018/07/27 宿泊税計算 WGCH END
		if(actionType == _CONST_PRICE_ROOM_TYPE) 
			isHaveShituliaoFlag = true;
		
	});
	var summaryPriceId = groupIndex + "_summary";
	var summaryPriceInputFlag = $j("#"+summaryPriceId).is('input');
      	// 合計値でプランの単価に反映する
    if(isHaveShituliaoFlag){
   		if(summaryPriceInputFlag){
   			$j("#"+summaryPriceId).val(sumVal);
   		}else{
   			$j("#"+summaryPriceId).replaceWith('<input type="text" id="' + summaryPriceId + '" style="text-align:right;" value="' + commUtils.numFormat(sumVal) + '" />');
			$j("#"+summaryPriceId).unbind("keydown");
			$j("#"+summaryPriceId).on('keydown', function(e){
            	$j(this).data("olddata",$j(this).val().replaceAll(",",""));
            });
            // 2018/07/27 宿泊税計算 WGCH BEGIN
            $j("#"+summaryPriceId).focus(function(){
            	$j(this).data("olddata",$j(this).val().replaceAll(",",""));
            });
            // 2018/07/27 宿泊税計算 WGCH END
			$j("#"+summaryPriceId).unbind("keyup");
			$j("#"+summaryPriceId).keyup(function(e){
				//if((e.keyCode<48 || e.keyCode>57) && e.keyCode!=46 && e.keyCode != 8 ) return;
				var price = $j(this).val().replaceAll(",","");
				if(price == $j(this).data("olddata")) return;
				setTimeout(function(){
					__reComputeShitulyou(groupIndex,summaryPriceId);
					// 2016/10/27 BEGIN
					//var curDiv = $j("table[id$=BookEstTable] tr.tranDetailRow").eq(groupIndex).find("div.pointIndex");
					//var rowIndex = curDiv.attr("rowindex");
					//setupCalAmoutPrice(rowIndex,false);
					setupCalAmoutPrice(groupIndex,false);
					// 2016/10/27 END
					
				},300);
				
			});
     	} 
    }else if(summaryPriceInputFlag) 
     		$j("#"+summaryPriceId).replaceWith('<span id="' + summaryPriceId + '" style="float:right;margin-right: 3px">' + commUtils.numFormat(sumVal) +'</span>');
    else $j("#"+summaryPriceId).text(commUtils.numFormat(sumVal));
	
	$j("input[id$=':" + groupIndex + ":hidSyncInfo']").val(planSyncInf);
	return planSyncInf;
}
function __reComputeShitulyou(groupIndex,summaryPriceId){
	var otherPrice = 0;
	var ExcTaxPrice = 0;
 	var childcls = "showDetailEvent" + groupIndex + "_child";
 	var planSyncInf = "";
 	//var hadShitulyouElement = $j("input[id^='" + groupIndex + "_workHidActType_'][value='" + _CONST_PRICE_ROOM_TYPE + "']:eq(0)");
 	// 合計値計算を行う
	$j("[class='"+ childcls +"']:not([data-actiontype = '" + _CONST_PRICE_ROOM_TYPE + "'])").each(function(idx){
		var rowidx = $j(this).attr("rowindex");
		var hidFieldId = groupIndex + "_sobjId_" + rowidx;
		var hidProdId = groupIndex + "_prodid_" + rowidx;
		var hidProdNm = groupIndex + "_prodName_" + rowidx;
		
		var unitPrice = $j(this).val().replaceAll(",","");
		if(unitPrice == "" || !unitPrice || isNaN(parseFloat(unitPrice)) ) unitPrice = 0;
		// 見積明細ID/プラン明細ID ： 単価 ： 会計商品ID ： 会計商品名
		planSyncInf += $j("#"+hidFieldId).val() + ':' + unitPrice + ':' + $j("#"+hidProdId).val()+ ':' + $j("#"+hidProdNm).val() +';';
		otherPrice = commUtils.mathNumAdd(otherPrice,unitPrice);
      	// 2015/10/16 プラン明細課税、非課税混在合計金額計算対応 BEGIN
      	if($j(this).attr("taxflg") != 1) {
      		ExcTaxPrice = commUtils.mathNumAdd(ExcTaxPrice,unitPrice);
      	}
	}); 
	var firstShituLyoElement;
	$j("[class='"+ childcls +"'][data-actiontype = '" + _CONST_PRICE_ROOM_TYPE + "']").each(function(idx){
		var unitPrice = $j(this).val().replaceAll(",","");
		if(unitPrice == "" || !unitPrice || isNaN(parseFloat(unitPrice)) ) unitPrice = 0;
		if(!firstShituLyoElement){ 
			firstShituLyoElement = $j(this);
			return true;
		}
		var rowidx = $j(this).attr("rowindex");
		var hidFieldId = groupIndex + "_sobjId_" + rowidx;
		var hidProdId = groupIndex + "_prodid_" + rowidx;
		var hidProdNm = groupIndex + "_prodName_" + rowidx;
		var unitPrice = $j(this).val().replaceAll(",","");
		// 見積明細ID/プラン明細ID ： 単価 ： 会計商品ID ： 会計商品名
		planSyncInf += $j("#"+hidFieldId).val() + ':' + unitPrice + ':' + $j("#"+hidProdId).val()+ ':' + $j("#"+hidProdNm).val() +';';
		otherPrice = commUtils.mathNumAdd(otherPrice,unitPrice);
      	// 2015/10/16 プラン明細課税、非課税混在合計金額計算対応 BEGIN
      	if($j(this).attr("taxflg") != 1) {
      		ExcTaxPrice = commUtils.mathNumAdd(ExcTaxPrice,unitPrice);
      	}
	}); 
  	var summaryElement = $j("#" + summaryPriceId);
  	var summaryPrice = summaryElement.val().replaceAll(",","");
  	if(summaryPrice == "" || !summaryPrice || isNaN(parseFloat(summaryPrice)) ) summaryPrice = 0;
 	var changePrice = commUtils.mathNumSub(parseFloat(summaryPrice), otherPrice); 
 	firstShituLyoElement.val(changePrice);
 	var hidFieldId = groupIndex + "_" + firstShituLyoElement.attr("rowIndex");
 	ExcTaxPrice = commUtils.mathNumAdd(ExcTaxPrice,changePrice);
 	$j("input:hidden[id$=':" + parentRowIndex + ":hidPlandetail']").val(ExcTaxPrice);
 	
 	var rowidx = firstShituLyoElement.attr("rowindex");
	var hidFieldId = groupIndex + "_sobjId_" + rowidx;
	var hidProdId = groupIndex + "_prodid_" + rowidx;
	var hidProdNm = groupIndex + "_prodName_" + rowidx;
	// 見積明細ID/プラン明細ID ： 単価 ： 会計商品ID ： 会計商品名
	planSyncInf += $j("#"+hidFieldId).val() + ':' + changePrice + ':' + $j("#"+hidProdId).val()+ ':' + $j("#"+hidProdNm).val() +';';
	$j("input[id$=':" + groupIndex + ":hidSyncInfo']").val(planSyncInf);
 	
 	var parentRowIndex = firstShituLyoElement.attr("parentindex");
 	$j("input[id$=':"+ parentRowIndex + ":price']").val(summaryPrice);
}
// プランの明細情報リスト格納する
// 2019/04/30 増税仮対応 WGCH BEGIN
// function autoGetChildProductInfo(result) {
function autoGetChildProductInfo(result, mode) {
// 2019/04/30 増税仮対応 WGCH END
//console.debug(result);
	var rowIndex = result.rowIndex;  
	var groupIndex = result.groupIndex;
    $j("#"+groupIndex+"_prodName_"+rowIndex).val(result.prodcutName);
    $j("#"+groupIndex+"_prodid_" + rowIndex).val(result.productId);
    $j("#"+groupIndex+"_workHidActType_" + rowIndex).val(result.actionType);
    // 2019/07/30 軽減税率機能対応 WGCH BEGIN
    if(isReducedTaxFlg){
    	// 2019/10/15 PLAN明细换商品修正対応 WGCH BEGIN
    	// 消费税
    	// $j("#"+groupIndex+"_workHidTaxRate_"+rowIndex).val(result.tax);
    	// サビース料
    	// $j("#"+groupIndex+"_workHidServiceTaxRate_"+rowIndex).val(result.serviceRate);
    	// 2019/10/15 PLAN明细换商品修正対応 WGCH END
    }
    // 2019/07/30 軽減税率機能対応 WGCH END
    _autoGetSetupSyncInfo(groupIndex);
    //$("input[id$=':" + parentRowIndex + ":hidSyncInfo']").val(planSyncInf);
    // 2018/07/27 宿泊税計算 WGCH BEGIN
    // 2019/04/30 増税仮対応 WGCH BEGIN
    // setupCalAmoutPrice(groupIndex,false);
    setupCalAmoutPrice(groupIndex,false,mode);
    // 2019/04/30 増税仮対応 WGCH END
    // 2018/07/27 宿泊税計算 WGCH END
}

var _CONST_ADDITEM_TEMPLATE = 
		"<tr ><td colspan='$colspan$'>" +
			"<input type='hidden' id='$groupIndex$_workHidItem' />"+
       	  	"<table style='width:60%;' class='list' border='0' cellpadding='0' cellspacing='0'>" +
       	     	"<tHead class='rich-table-thead'>" +
       	        	"<tr class='headerRow' nowrap='nowrap'>" +
			//商品名
       	              "<th class='headerRow' nowrap='nowrap' style='width:70%'>{!$Label.MSG_011_0048}</th>" +
       	            //単価
       	              "<th class='headerRow' nowrap='nowrap' style='width:30%'>{!$Label.MSG_011_0049}</th></tr>" +

       	         "</tHead>" +
       	         "<tBody>" +
       	         "$tBodyContent$" +
	    		 "</tBody>" +
	    		 //合計
	    		 "<tFoot><tr><td style='text-align: right;'><span style='margin-right:3px'>{!$Label.MSG_011_0071}：</span></td><td style='text-align:right;'><span id='$summaryPriceId$' style='float:right;margin-right: 3px'></span></td></tr>"+
		    		 "</tFoot> " +
	    	"</table></td>" +
	    "</tr>";
var _CONST_ADDITEM_DTEAIL_IMG_TEMPLATE = 
	    "<img onmouseover='this.className = \"lookupIconOn\";this.className = \"lookupIconOn\";'" +
    		"onmouseout='this.className = \"lookupIcon\";this.className = \"lookupIcon\";'" +
    		"onfocus='this.className = \"lookupIconOn\";' onblur='this.className = \"lookupIcon\";'" +
    		"class='lookupIcon' src='/s.gif' style='cursor: pointer;'" +
    		"name='childrenProductPopup' onclick='javascript:openChildProdutWin(\"$groupIndex$\",\"$rowidx$\")'/>";
var _CONST_ADDITEM_DTEAIL_TEMPLATE = 
	    	"<tr><td style='background-color: #FFEBCD;'>" + 
	        "<input type='text'style='width:180px' value='$productName$' id='$groupIndex$_prodName_$rowidx$' rowidx='$rowidx$' parentIndex='$groupIndex$' />" +
	        _CONST_ADDITEM_DTEAIL_IMG_TEMPLATE +
	        // 2019/07/30 軽減税率機能対応 WGCH BEGIN
	        "<input type='hidden' id='$groupIndex$_workHidTaxRate_$rowidx$' value='$taxRate$' />" +
	        "<input type='hidden' id='$groupIndex$_workHidServiceTaxRate_$rowidx$' value='$serviceTaxRate$' />" +
	        // 2019/07/30 軽減税率機能対応 WGCH END
	        "<input type='hidden' value='$productId$' id='$groupIndex$_prodid_$rowidx$' />" +
	        "<input type='hidden' value='$sobjId$' id='$groupIndex$_sobjId_$rowidx$' />"+
	        "<input type='hidden' id='$groupIndex$_workHidActType_$rowidx$' value='$actType$' />" +
	        "<input type='hidden' value='$planDetail$' id='$groupIndex$_hidPlandetail_$rowidx$' /></td>"+
	        "<td style='background-color: #FFEBCD;text-align: right;'>" +
	        //"<input type='text' style='text-align:right;' id='$groupIndex$_price_$rowidx$' class='$childclsItemClass$' value='$memoryPrice$' rowidx='$rowidx$' /></td></tr>";
			"<input type='text' style='text-align:right;' parentIndex='$groupIndex$' id='$groupIndex$_prodPrice_$rowidx$' rowIndex='$rowidx$' class='$childclsItemClass$' value='$memoryPrice$' taxflg='&prodtaxflg&' data-actiontype='$actType$'/></td></tr>";
	    		
function showDetailFun(obj) {
    if ($j(obj).attr("openStatus") == "false") {
		$j(obj).attr("openStatus","true");
		//折りたたむ
		$j(obj).attr("title","{!$Label.MSG_011_0066}");
		$j(obj).attr("src","{!URLFOR($Resource.AppImages, 'extend/jianhao.png')}");
		// Javasceipr Remotingでデータを取得する
		var groupIndex = $j(obj).attr("rowIndex");
		var ctrlId = $j("input:hidden[id$=':" + groupIndex + ":hidProductId']").get(0);
		var childcls = ($j(obj).attr("id")) + "_child";
		hashMap.Clear();
		// 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH BEGIN
		// $j(obj).attr("syncShow","false");
		$j("input:hidden[id$=':" + groupIndex + ":hidBasePlanNum']").val(0);
		// 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH END
		var syncInfo = $j("input[id$=':" + groupIndex + ":hidSyncInfo']").val();
		if (syncInfo != "" && syncInfo.length > 1) {
			syncInfo = syncInfo.substring(0, syncInfo.length-1);
			var synInfoArr = syncInfo.split(";");
			for (i = 0; i < synInfoArr.length; i++){
				var setupInfArr = synInfoArr[i].split(":");
				var sobjId = setupInfArr[0];
				var mapKey1 = groupIndex + "_p_" + sobjId;		// 設定明細の価額
				var mapKey2 = groupIndex + "_i_" + sobjId;		// 設定明細の会計商品ID
				var mapKey3 = groupIndex + "_n_" + sobjId;		// 設定明細の会計商品名
				hashMap.Put(mapKey1, setupInfArr[1]);
				if (setupInfArr.length > 2) hashMap.Put(mapKey2, setupInfArr[2]); // 会計商品ID
				if (setupInfArr.length > 3) hashMap.Put(mapKey3, setupInfArr[3]); // 会計商品名
			}
		}
		//var tierRatePrice = $j("#hidCurRackRatePrice").val();
//JINYACONNECT.CUSTOM.blockUi();
		blockUi();
		Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.RoomIndicatorInfo.getAccountMstLstByPlan}',
           	//ctrlId.value,tierRatePrice,
           	ctrlId.value,
            function(result, event){
unblockUi();
                if (event.status) {
                    if(result== null || result.length == 0){
			//データ詳細がありません。
                        $j(obj).parents("tr.tranDetailRow").after("<tr><td colspan='10' style='margin-right: 200px;' >{!$Label.MSG_011_0067}</td></tr>");
                    }else{
                    	// プラン明細設定情報を格納用
                    	var planSyncInf = '';
                    	
						var tabStrHead = _CONST_ADDITEM_TEMPLATE.replaceAll("$colspan$", 10)
																.replaceAll("$groupIndex$",groupIndex);
	                	var tabStrBody = "";

	                	for (var i=0; i<result.length; i++) {
	                		// メモーに既存場合、メモーの設定情報から、単価を設定する
	                		//var mapKey = groupIndex + "_" + result[i].sobjId;
	                		
							var mapKey1 = groupIndex + "_p_" + result[i].sobjId;		// 設定明細の価額
							var mapKey2 = groupIndex + "_i_" + result[i].sobjId;		// 設定明細の会計商品ID
							var mapKey3 = groupIndex + "_n_" + result[i].sobjId;		// 設定明細の会計商品名
							
	                		var memoryPrice = hashMap.Contains(mapKey1) ? hashMap.Get(mapKey1) : result[i].prodPrice;
	                		var productId = hashMap.Contains(mapKey2) ? hashMap.Get(mapKey2) : result[i].prodId;
	                		var productNm = hashMap.Contains(mapKey3) ? hashMap.Get(mapKey3) : result[i].prodName;
	                		
	                		// 2018/07/27 宿泊税計算 WGCH BEGIN
	                		var mapKey4 = groupIndex + "_t_" + result[i].sobjId;		// 設定明細の会計商品Type
	                		var actionType = planItemTypeMap.get(mapKey4) ? planItemTypeMap.get(mapKey4) : result[i].actionType;
	                		// 2018/07/27 宿泊税計算 WGCH END
	                		
							var prodtaxflg = '';
	                		if(result[i].prodTaxRate !=null && result[i].prodTaxRate !='') prodtaxflg = '1';
		        			tabStrBody += _CONST_ADDITEM_DTEAIL_TEMPLATE.replaceAll("$rowidx$",i)
     											.replaceAll("$groupIndex$",groupIndex)
     											.replaceAll("$productName$",commUtils.escapeQuotes(productNm))
     											.replaceAll("$productId$",productId)
     											.replaceAll("$sobjId$",result[i].sobjId)
     											.replaceAll("$childclsItemClass$",childcls)
     											// 2018/07/27 宿泊税計算 WGCH BEGIN
     											//.replaceAll("$actType$",result[i].actionType)
     											.replaceAll("$actType$",actionType)
     											// 2018/07/27 宿泊税計算 WGCH END
     											// 2019/07/30 軽減税率機能対応 WGCH BEGIN
     											.replaceAll("$taxRate$",result[i].prodTaxRate)
     											.replaceAll("$serviceTaxRate$",result[i].prodServiceRate)
     											// 2019/07/30 軽減税率機能対応 WGCH END
     											.replaceAll("$memoryPrice$",memoryPrice)
     											.replaceAll("&prodtaxflg&",prodtaxflg)
     											.replaceAll("&planDetail&",result[i].planDetail);
							
	                		//planSyncInf += result[i].sobjId + ':' + memoryPrice.replaceAll(",","") + ':' + result[i].prodId + ':' + result[i].prodName + ';';
	                	}
	                	//$(obj).parent().parent().parent().after(tabStrHead + tabStrBody + tabStrFoot);
	                	var summaryPriceId = groupIndex + "_summary";
						$j(obj).parents("tr.tranDetailRow").after(tabStrHead.replaceAll("$tBodyContent$",tabStrBody).replace("$summaryPriceId$",summaryPriceId));
	                	// 連携用情報、HIDDEN項目に格納する
	                	//$("input[id$=':" + groupIndex + ":hidSyncInfo']").val(planSyncInf);

	                	// 単価合計値計算して、プランの単価へ反映する
	                	// Event Binding
	                	//old value input
	                	$j("[class='"+ childcls +"']").unbind("keydown");
	                	$j("[class='"+ childcls +"']").on('keydown', function(e){
	                		$j(this).data("olddata",$j(this).val().replaceAll(",",""));
	                	});
	                	// 2018/07/27 宿泊税計算 WGCH BEGIN
	                	$j("[class='"+ childcls +"']").focus(function(){
	                		$j(this).data("olddata",$j(this).val().replaceAll(",",""));
	                	});
	                	// 2018/07/27 宿泊税計算 WGCH END
	                	$j("[class='"+ childcls +"']").unbind("keyup");
	                	$j("[class='"+ childcls +"']").on('keyup', function(e){
	                		var price = $j(this).val().replaceAll(",","");
	                		var oldValue = $j(this).data("olddata");
	                		if(oldValue == price)return;
	                		var parentRowIndex = $j(this).attr("parentIndex");
							setTimeout(function(){
								__reComputePrice(childcls,parentRowIndex);
								// 2016/10/27 BEGIN
								//var curDiv = $j("table[id$=BookEstTable] tr.tranDetailRow").eq(groupIndex).find("div.pointIndex");
								//var rowIndex = curDiv.attr("rowindex");
								//setupCalAmoutPrice(rowIndex,false);
								setupCalAmoutPrice(groupIndex,false);
								// 2016/10/27 END
							},500);
	                	});
	                	$j("[class='"+ childcls +"']").unbind("blur");
	                	$j("[class='"+ childcls +"']").on('blur', function(e){
			        		var price = $j(this).val().replaceAll(",","");
	                		if (!$j.isNumeric(price)) price = "0";
	                		$j(this).val(commUtils.numFormat(price));
			        	});
						
						// 入力の商品コードで、商品自動設定を行う
						// 作成した項目は自動商品コードのAutoComplete機能を追加する
						$j("input[id^='"+groupIndex+"_prodName_']").autocomplete({
					        minLength: 1,
					        source: function (request, response) {
					            Visualforce.remoting.Manager.invokeAction(
					                "{!$RemoteAction.RoomIndicatorInfo.getArrayProductItemInfoNoPlan}", request.term, function(result, event){
					                if (event.type == 'exception') {
					                    alert(event.message);
					                } else {
					                    response($.map(result, function (item) {
					                    	item.id = item.productId;
					                    	item.value = item.prodcutName + "("+item.prodcutCode+")";
					                    	return item;
					                    }));
					                } // End else
					            });
					        },
					        focus: function (event, ui) {
					        	var rowidx = $j(this).attr("rowidx");
			    				ui.item.rowIndex = rowidx;
			    				ui.item.groupIndex = $j(this).attr("parentIndex");
			    				// 2019/04/30 増税仮対応 WGCH BEGIN
			    				// autoGetChildProductInfo(ui.item);
			    				autoGetChildProductInfo(ui.item, CUST_AUTOGETPRODUCTMODE_RETURN);
			    				// 2019/04/30 増税仮対応 WGCH END
					            return false;
					        },
					        select: function (event, ui) {
						    	var rowidx = $j(this).attr("rowidx");
			    				ui.item.rowIndex = rowidx;
			    				ui.item.groupIndex = $j(this).attr("parentIndex");
					            autoGetChildProductInfo(ui.item);
					            // 2019/11/15 最近利用している商品一覧機能を提供する BY zyz BEGIN
					            if ("accMasterFun" in window) accMasterFun(ui.item.id);
					            // 2019/11/15 最近利用している商品一覧機能を提供する BY zyz END
					            return false;
					        },
					    });
					   _autoGetSetupSyncInfo(groupIndex);
					   __reComputePrice(childcls,groupIndex);
					   // 2016/10/27 BEGIN
					   //var curDiv = $j("table[id$=BookEstTable] tr.tranDetailRow").eq(groupIndex).find("div.pointIndex");
					   //var rowIndex = curDiv.attr("rowindex");
					   //setupCalAmoutPrice(rowIndex, true);	
					   setupCalAmoutPrice(groupIndex, true);
					   // 2016/10/27 BEGIN
						// $("input[id^='"+groupIndex+"_prodName_']").autocomplete END

                    }

                } else if (event.type === 'exception') {
				//データ詳細がありません。
                    $j(obj).parents("tr.tranDetailRow").after("<tr><td colspan='10' style='margin-left: 200px;' >{!$Label.MSG_011_0067}</td></tr>");
                } else {
                //データ詳細がありません。
                    $j(obj).parents("tr.tranDetailRow").after("<tr><td colspan='10' style='margin-left: 200px;' >{!$Label.MSG_011_0067}</td></tr>");

                }
            },
            {escape: true}
        );
		//$(obj).parent().parent().parent().after("<tr><td colspan='10' style='margin-left: 200px;' ><table><tr><td>444</td><td>555</td><td>666</td></tr></table> </td></tr> ");
    } else {
        $j(obj).attr("src","{!URLFOR($Resource.AppImages, 'extend/jiahao.png')}");
        $j(obj).attr("openStatus","false");
	//展開
        $j(obj).attr("title","{!$Label.MSG_011_0064}");

        $j(obj).parents("tr.tranDetailRow").next().remove();
    }
}
function __reComputePrice(childcls,parentRowIndex){
	var sumVal = 0;
 	// 2015/10/16 プラン明細課税、非課税混在合計金額計算対応 BEGIN
    var ExcTaxPrice = 0;
   	// 2015/10/16 プラン明細課税、非課税混在合計金額計算対応 END
 	var planSyncInf = '';
  	// 合計値計算を行う
  	$j("[class='"+ childcls +"']").each(function(idx){
 		var unitPrice = $j(this).val().replaceAll(",","");
 		if(unitPrice == "" || !unitPrice || isNaN(parseFloat(unitPrice)) ) unitPrice = 0;
 		sumVal = commUtils.mathNumAdd(sumVal,unitPrice);
 		// 2015/10/16 プラン明細課税、非課税混在合計金額計算対応 BEGIN
      	if($j(this).attr("taxflg") != 1) {
      		ExcTaxPrice = commUtils.mathNumAdd(ExcTaxPrice,unitPrice);
      	}
 	});
 	$j("input:hidden[id$=':" + parentRowIndex + ":hidPlandetail']").val(ExcTaxPrice);
 	
  	// 同期情報を取得する
  	_autoGetSetupSyncInfo(parentRowIndex);
  	// 合計値でプランの単価に反映する
  	$j("input[id$=':"+ parentRowIndex + ":price']").val(sumVal);
}
function openChildProdutWin(groupIndex,rowIndex) {
    var dumyField = $j("#"+groupIndex+"_workHidItem").get(0);
    // 引き渡し値を設定して、選択画面を開く
    ctrlNm = $j("#"+groupIndex+"_prodName_"+rowIndex).get(0);
    ctrlId = $j("#"+groupIndex+"_prodid_" + rowIndex).get(0);
    ctrlHidNm = dumyField;
    ctrlPriceId = dumyField;
    ctrlOrderNumId = dumyField;
    ctrlTaxRate = dumyField;
    ctrlHidTaxRate = dumyField;
    ctrlServiceTaxRate = dumyField;
    ctrlHidServiceTaxRate = dumyField;
    // 2019/07/30 軽減税率機能対応 WGCH BEGIN
    if(isReducedTaxFlg){
    	var taxRateField = $j("#"+groupIndex+"_workHidTaxRate_"+rowIndex).get(0);
    	ctrlTaxRate = taxRateField;
    	ctrlHidTaxRate = taxRateField;
    	var serviceTaxRateField = $j("#"+groupIndex+"_workHidServiceTaxRate_"+rowIndex).get(0);
    	ctrlServiceTaxRate = serviceTaxRateField;
    	ctrlHidServiceTaxRate = serviceTaxRateField;
    }
    // 2019/07/30 軽減税率機能対応 WGCH END
    ctrlSpecialTax = dumyField;
    ctrlHidSpecialTax = dumyField;
    ctrlHidActionType = $j("#"+groupIndex+"_workHidActType_" + rowIndex).get(0);
    //ctrlHidPlanDetail = $j("#"+groupIndex+"_workHidActType_" + rowIndex).get(0);//ctrlHidPlanDetail
    var openUrl = "/apex/ProductSearch?np=1";
    // 呼び出し順番とPOPUP画面の設定順番は必ず一致するが必要
	objs = new Array(ctrlNm, ctrlId, ctrlHidNm, ctrlPriceId, ctrlOrderNumId,
		ctrlTaxRate, ctrlHidTaxRate, ctrlServiceTaxRate, ctrlHidServiceTaxRate, ctrlSpecialTax, ctrlHidSpecialTax, ctrlHidActionType);
	commUtils.popup(openUrl, "SearchProductInfo", objs, null, null, popupChildCallback(groupIndex));
}

// 会計明細の単価入力制御
function switchPriceStatus() {
	$j("[id^='showDetailEvent']").each(function(idx) {
		var rowIndex = $j(this).attr("rowIndex");
		if ($j(this).css("visibility") == "hidden") {
			$j("input[id$=':" + rowIndex + ":price']").attr('readonly', false);
			$j("input[id$=':" + rowIndex + ":price']").css('background-color', '');
		} else {
			$j("input[id$=':" + rowIndex + ":price']").attr('readonly', true);
			$j("input[id$=':" + rowIndex + ":price']").css('background-color', '#DCDCDC');
		}
	});
}
// 展開imgの表示・非表示を制御する
function dispExtendImg(flg, groupindex){ // flg : visible | hidden
	var idx = groupindex;
	var $obj = $j("#showDetailEvent" + idx);
    $obj.attr("style", "cursor: pointer;display: true; width: 18px; height: 18px; visibility:" + flg);
    if($obj.attr("openStatus") == "true"){
        $obj.attr("src","{!URLFOR($Resource.AppImages, 'extend/jiahao.png')}")
        	.attr("openStatus","false")
        	//展開
        	.attr("title","{!$Label.MSG_011_0064}");
        $obj.parents("tr.tranDetailRow").next().remove();
    }
    switchPriceStatus();
}

function checkAddTranItem(){
	// 必須項目チェック
	// 2017/01/12 统一行追加功能改修 by zy BEGIN
	if (!JINYACONNECT.CUSTOM.checkIfHadRequiredItem()) {
		//第一个项目选中
		$j("input:not(:hidden),select,textarea","[id$=createPageBlock] .dataCol.first:first").focus();
		return false;
	}
	// 関連のEVENTBINDをUNBIND
	$j("input[id$=':price'],input[id$=':orderNums'],input[id$=':productName']").unbind("blur");
	// 行目新規追加
	addTranItemFun();
	// 2017/01/12 统一行追加功能改修 by zy END
}
// 明細情報行情報変更すると
// 明細金額リアルタイム計算
// 2019/04/30 増税仮対応 WGCH BEGIN
// function setupCalAmoutPrice(rowIndex, isFromCallBackFun) {
function setupCalAmoutPrice(rowIndex, isFromCallBackFun, mode) {
// 2019/04/30 増税仮対応 WGCH END
 
	// 2019/07/30 軽減税率機能対応 WGCH BEGIN
	if(isReducedTaxFlg) updatePlanItemMapFun(rowIndex);
	// 2019/07/30 軽減税率機能対応 WGCH END
	// 指定の会計明細情報がCOPON存在する場合
    // 処理種別は「前受金・支払」の場合、減算を行う
    // 税込み、税抜き金額
    // 単価
    // 2015/10/16 プラン明細課税、非課税混在合計金額計算対応 BEGIN
    var hidPlandetail = $j("input:hidden[id$=':" + rowIndex + ":hidPlandetail']").val();
    // 2015/10/16 プラン明細課税、非課税混在合計金額計算対応 END
    var unitPrice = kendo.parseFloat($j("input:text[id$=':" + rowIndex + ":price']").val());
    if (unitPrice == null) unitPrice = 0;
    // 消費税率
    var tax = kendo.parseFloat($j("input:hidden[id$=':" + rowIndex + ":hidTaxRateType']").val());
    if (tax == null) tax = 0;
    // サビース料率
    var service = kendo.parseFloat($j("input:hidden[id$=':" + rowIndex + ":hidServiceRate']").val());
    if (service == null) service = 0;
    // 数量
    var nums = kendo.parseFloat($j("input:text[id$=':" + rowIndex + ":orderNums']").val());
    if (nums == null) nums = 0;
    // 特別税
    var numSepcTax = kendo.parseFloat($j("input[id$=':" + rowIndex + ":hidSpecialTax']").val());
    if (numSepcTax == null) numSepcTax = 0;
    // 単価定義区分
    var unitPriceKbn = $j("input:hidden[id$=':" + rowIndex + ":hidUnitPriceKbn']").val();
    // 関連金額を計算する
    // 2015/10/16 プラン明細課税、非課税混在合計金額計算対応 BEGIN
    var amountIncTax;
    var amountExcTax;
    if(hidPlandetail > 0 ) {
    	var unitPriceIncTax = commUtils.mathNumSub(unitPrice, hidPlandetail);
    	var res = JINYACONNECT.PRODUCT.PROCESS(unitPriceIncTax, nums, tax, service, unitPriceKbn);
    	var resPriceIncTax = res.priceIncTax;
    	var resPriceExcTax = res.priceExcTax;
    	var resExc = JINYACONNECT.PRODUCT.PROCESS(hidPlandetail, nums, 0, service, unitPriceKbn);
		amountIncTax = commUtils.mathNumAdd(resPriceIncTax , resExc.priceIncTax );
		amountIncTax = commUtils.mathNumAdd(amountIncTax, numSepcTax);
		amountExcTax = resPriceExcTax + resExc.priceExcTax;
    	// 2019/07/30 軽減税率機能対応 WGCH BEGIN
      	if(isReducedTaxFlg){
  			// 获取最新的数据集合
    		var resInfo = getResInfoFun(rowIndex, res);
    		// 重置RES
    		res = resInfo.res;
    		// 重置合計金額
    		amountIncTax = res.priceIncTax;
    		// 重置合計金額(税抜)
    		amountExcTax = res.priceExcTax;
    		// 重置特别税
    		numSepcTax = resInfo.numSepcTax;
    		// 重置合計金額
    		amountIncTax = commUtils.mathNumAdd(amountIncTax, numSepcTax);
    	}
    	// 2019/07/30 軽減税率機能対応 WGCH END
    }else {
    	var res = JINYACONNECT.PRODUCT.PROCESS(unitPrice, nums, tax, service, unitPriceKbn);
    	// 2019/07/30 軽減税率機能対応 WGCH BEGIN
    	if(isReducedTaxFlg){
    		// 获取最新的数据集合
    		var resInfo = getResInfoFun(rowIndex, res, unitPrice, nums, tax, service, numSepcTax, unitPriceKbn);
    		// 重置RES
    		res = resInfo.res;
    		// 重置特别税
    		numSepcTax = resInfo.numSepcTax;
    	}
    	// 2019/07/30 軽減税率機能対応 WGCH END
		// 合計金額計算を行う
		amountIncTax = commUtils.mathNumAdd(res.priceIncTax , numSepcTax);
		amountExcTax = res.priceExcTax;
    }
    // 2015/10/16 プラン明細課税、非課税混在合計金額計算対応 END
	// 支払情報の場合、単価は自動残りの請求金額で設定を行う
	var actionType = $j("input:hidden[id$=':" + rowIndex + ":hidActionType']").val()		// 商品処理種別
	if (actionType == "{!JSENCODE(ACTTYPE_AR)}" || actionType == "{!JSENCODE(ACTTYPE_PAY)}") {
		// 支払種別は「COPON】の場合、クーポン利用の返金「manasCoponFlg」を選べる場合、支払金額はマイナス計算を行う
		// 支払情報は０の場合、元の支払金額+残り金額で自動設定を行う
		// 残りの請求金額から設定する
		if (amountIncTax == 0 && isFromCallBackFun) {
			// 残りの請求金額から設定する
			var reqAmount = $j("#reqAmountBlock").text();
			reqAmount = reqAmount.replace(kendo.getCulture().numberFormat.currency.symbol,"");
			var payAmount = kendo.parseFloat(reqAmount);
			// 該当メデイアに支払金額が存在する場合、自動設定を行わない
			var orgPayAmount = kendo.parseFloat($j("span[id$=':" + rowIndex + ":amoutPriceIncTax']").text());
			// 2015/11/03 BugFix BEGIN
			var payType = $j("input:hidden[id$=':" + rowIndex + ":hidPaymentType']").val();
			// 2015/11/03 BugFix END
			// 未請求金額はマナスの場合、現在の金額はそのまま
			if (payAmount <= 0) {
	    		if(!isRefundItem(payType))
					payAmount = orgPayAmount;
				else
					payAmount = Math.abs(payAmount);
			} else {
				// 未支払金額が存在する場合、元の支払金額は０の場合、自動全額を支払
				// 既に金額が存在する場合、そのまま
				if (orgPayAmount != null && orgPayAmount > 0) {
					payAmount = orgPayAmount;
				}else if(isRefundItem(payType)){
					payAmount = orgPayAmount;
				}
			}
			var _loctotalPayed = payAmount;
			if (_loctotalPayed == null) _loctotalPayed = 0;
			$j("input:text[id$=':" + rowIndex + ":price']").val(_loctotalPayed);
			$j("input:text[id$=':" + rowIndex + ":orderNums']").val("1");
			amountIncTax = amountExcTax = _loctotalPayed;
		}
	}

    // 2018/07/27 宿泊税計算 WGCH BEGIN
    // 2019/07/30 軽減税率機能対応 WGCH BEGIN
    if(!isReducedTaxFlg){
	    if(actionType == _CONST_PRICE_ROOM_TYPE && hotelTaxDefineInfoData[thisRoomSpcd] != undefined){
	    	var res = JINYACONNECT.PRODUCT.PROCESS(unitPrice, nums, tax, service, unitPriceKbn);
	    	var newNumSepcTax = commUtils.mathNumMulti(commUtils.getHotelTaxFun(res.unitPriceIncServiceExcTax, hotelTaxDefineInfoData[thisRoomSpcd]), nums);
	    	$j("input[id$=':" + rowIndex + ":hidSpecialTax']").val(newNumSepcTax);
	    	$j("span[id$=':" + rowIndex + ":specialTax']").text(newNumSepcTax);
	    	amountIncTax = commUtils.mathNumAdd(commUtils.mathNumSub(amountIncTax, numSepcTax), newNumSepcTax);
	    } else if(actionType == "{!ACTTYPE_PLAN}" && hotelTaxDefineInfoData[thisRoomSpcd] != undefined){
	    	var planItemPriceLst = [], newNumSepcTax = 0;
	    	// 判断plan是否展开过
	    	var _PlanBrkDn = $j("td>input.showDetailEvent" + rowIndex + "_child");
	    	if(_PlanBrkDn.length == 0){ // Plan未展开的情况
	    		if(planItemPriceMap.get(getPlanKeyFun(rowIndex))) planItemPriceLst = planItemPriceMap.get(getPlanKeyFun(rowIndex));
	    		planItemPriceLst = planItemPriceLst ? planItemPriceLst : [];
	    		for(var i = 0; i < planItemPriceLst.length; i++){
	    			var res = JINYACONNECT.PRODUCT.PROCESS(planItemPriceLst[i] * 1, 1, tax, service, unitPriceKbn);
	    			newNumSepcTax = commUtils.mathNumAdd(newNumSepcTax, commUtils.mathNumMulti(commUtils.getHotelTaxFun(res.unitPriceIncServiceExcTax, hotelTaxDefineInfoData[thisRoomSpcd]), nums));
	    		}
	    	} else { // Plan展开的情况
	    		var childcls = "showDetailEvent" + rowIndex + "_child";
	     		$j("[class='"+ childcls +"'][data-actiontype = '" + _CONST_PRICE_ROOM_TYPE + "']").each(function(){
	    			var price = $j(this).val().replaceAll(",","");
	    			if(price == "" || !price || isNaN(parseFloat(price)) ) price = 0;
	    			planItemPriceLst.push(price);
	    			var res = JINYACONNECT.PRODUCT.PROCESS(price, 1, tax, service, unitPriceKbn)
	    			newNumSepcTax = commUtils.mathNumAdd(newNumSepcTax, commUtils.mathNumMulti(commUtils.getHotelTaxFun(res.unitPriceIncServiceExcTax, hotelTaxDefineInfoData[thisRoomSpcd]), nums));
	    		});
	    		planItemPriceMap.set(getPlanKeyFun(rowIndex), planItemPriceLst);
	    	}
	    	$j("input[id$=':" + rowIndex + ":hidSpecialTax']").val(newNumSepcTax);
	    	$j("span[id$=':" + rowIndex + ":specialTax']").text(newNumSepcTax);
	    	amountIncTax = commUtils.mathNumAdd(commUtils.mathNumSub(amountIncTax, numSepcTax), newNumSepcTax);
	    }
    }
    // 2019/07/30 軽減税率機能対応 WGCH END
    // 2018/07/27 宿泊税計算 WGCH END
 	// 請求書に非表示制御フラグ
 	
    $j("span[id$=':" + rowIndex + ":amoutPriceIncTax']").text(kendo.toString(amountIncTax, "c"));	// 金額（税込み）
    $j("input[id$=':" + rowIndex + ":hidAmoutPriceIncTax']").val(amountIncTax);	// 金額（税込み） 
    $j("span[id$=':" + rowIndex + ":amoutPriceExcTax']").text(kendo.toString(amountExcTax, "c"));	// 金額（税抜き） 
    $j("input[id$=':" + rowIndex + ":hidAmoutPriceExcTax']").val(amountExcTax);	// 金額（税抜き） 
    // 合計金額を計算を行う
    // 関連金額計算を行う
    //if(!false)
    setupCalSumAmountPrice();
    // 2019/04/30 増税仮対応 WGCH BEGIN
    // 增税商品-自动设定
    if(mode != CUST_AUTOGETPRODUCTMODE_RETURN && tax > 0){
    	autoSetTaxIncProductFun();
    }
    // 2019/04/30 増税仮対応 WGCH END
}
// 明細情報から請求金額と利用金額自動計算を行う
function setupCalSumAmountPrice() {
    // 画面明細から総金額利用金額と請求金額を計算を行う
    var totalUsed = 0;		// 利用金額
    var totalPayed = 0;		// 支払金額
    
     // 値引きの支払情報格納行
    var discountPayArr = new Array();
    // Coponの支払情報格納行
    var coponPayArr = new Array();	
    // 普通の支払情報
    var normalPayArr = new Array();
    // 全て有効な利用金額を集計を行う
    //$("input[id$=':hidAmoutPriceIncTax']").each(function() {
    var hidAmountPriceArr = $j("input:hidden[id$=':hidAmoutPriceIncTax']");
    var hidActionTypeArr =  $j("input:hidden[id$=':hidActionType']");
    var hidPaymentTypeArr = $j("input:hidden[id$=':hidPaymentType']");
    var hidAmountPriceExcTaxArr = $j("input[id$='hidAmoutPriceExcTax']");	
	var totalAmountExcTax = 0;
    for (i = 0; i < hidAmountPriceArr.length; i++) {
    	//$this = $(this);
    	$this = $j(hidAmountPriceArr[i]);
    	var _locRowIndex = $this.attr("rowIndex");
    	// 該当行目の計算MARK
	    var actionType = hidActionTypeArr[i].value;
	    // 支払情報
	    if (actionType == "{!JSENCODE(ACTTYPE_AR)}" || actionType == "{!JSENCODE(ACTTYPE_PAY)}") {
	    	//totalPayed = commUtils.mathNumAdd(totalPayed, $this.val());
	    	// 商品処理種別は「支払」の場合
	    	if (actionType == "{!JSENCODE(ACTTYPE_PAY)}") {
	    		var payType = hidPaymentTypeArr[i].value;
	    		
	    		var payMediaLabel = getPayMeidaLabel(payType);
	    		if (payMediaLabel == "{!JSENCODE(MEDIA_TYPE_DISCOUNT)}") {
	    			discountPayArr.push($this);
	    		} else if (payMediaLabel == "{!JSENCODE(MEDIA_TYPE_COPON)}") {
					coponPayArr.push($this);
	    		} else {
	    			// 値引き、クーポン支払情報以外の場合
	    			normalPayArr.push($this);
	    		}
	    	} else {
	    		// 前受付金の場合
	    		normalPayArr.push($this);
	    	}
	    }
	    // 利用情報
	    else {
    		totalAmountExcTax = commUtils.mathNumAdd(totalAmountExcTax, hidAmountPriceExcTaxArr.eq(i).val());
    		totalUsed = commUtils.mathNumAdd(totalUsed, $this.val());
	    }
    }
    $j("#totalAmountExcTax").val(totalAmountExcTax);
    // 利用総金額
    var remaindPayMoney = totalUsed;
//console.debug('remaindPayMoney:::' + remaindPayMoney);
    // 値引き支払情報存在する場合
    $j.each(discountPayArr, function(i) {     
    	// 支払金額残り場合
    	if (remaindPayMoney > 0) {
			//console.debug(.val());
			var $this = discountPayArr[i];
			var _locRowIndex = $this.attr("rowIndex");
			// 預かり金額
			var recivePrice = $this.val();
			// 該当行値引き金額は全体支払
			if (remaindPayMoney >= recivePrice) {
				totalPayed = commUtils.mathNumAdd(totalPayed, recivePrice);
				// 預かり金額：値引き金額、支払金額：値引き金額、お釣り金額：０円（値引き返金なし）
				//setPaymentInfo(_locRowIndex, recivePrice, recivePrice, 0);
			} 
			// 値引き金額は利用金額により、大きくの場合、返金なし
			else {
				totalPayed = commUtils.mathNumAdd(totalPayed, remaindPayMoney);
				// 預かり金額：値引き金額、支払金額：残り利用金額、お釣り金額：０円（値引き返金なし）
				//setPaymentInfo(_locRowIndex, recivePrice, remaindPayMoney, 0);
			}
			// 残り未支払金額再計算を行う
			remaindPayMoney = commUtils.mathNumSub(remaindPayMoney, recivePrice);
			// 値引き超える金額は返金しない設定
			if (remaindPayMoney < 0) remaindPayMoney = 0;
//console.debug('discountPayArr:::' + remaindPayMoney);
		}
	});   
	if (coponPayArr.length > 0) {
		var coponManasFlg = $j("input[id$=':manasCoponFlg']").prop("checked");
		$j.each(coponPayArr, function(i) {     
			var $this = coponPayArr[i];
			var _locRowIndex = $this.attr("rowIndex");
			// 預かり金額
			var recivePrice = $this.val();
			// 預かり金額は未支払い金額は超える場合、お釣り存在場合
			if (remaindPayMoney < recivePrice) {
				var locRemaindPay = remaindPayMoney < 0 ? 0 : remaindPayMoney; 
				recivePrice = coponManasFlg ? recivePrice : locRemaindPay;
			}
			totalPayed = commUtils.mathNumAdd(totalPayed, recivePrice);
			remaindPayMoney = commUtils.mathNumSub(remaindPayMoney, recivePrice);
		});
	}
    $j.each(normalPayArr, function(i) {    
		var $this = normalPayArr[i];
		var _locRowIndex = $this.attr("rowIndex");
		// 預かり金額
		var recivePrice = $this.val();
		// 2015/06/25 返金の場合、入力の金額は減算を行う
		var paytype = $j("input:hidden[id$=':" + _locRowIndex +":hidPaymentType']").val();
		if (isRefundItem(paytype) && recivePrice > 0) recivePrice = -recivePrice;
		
		totalPayed = commUtils.mathNumAdd(totalPayed, recivePrice);
		// 残り未支払金額計算
		remaindPayMoney = commUtils.mathNumSub(remaindPayMoney, recivePrice);
	}); 
    // 該当金額から計算を行う
    $j("#usedAmountBlock").text(kendo.toString(totalUsed, "c"));
    var requestMoney = commUtils.mathNumSub(totalUsed, totalPayed);
    $j("#reqAmountBlock").text(kendo.toString(requestMoney, "c"));// 請求金額
}


<!--支払種別から支払メディア種別取得 -->
function getPayMeidaLabel(payType) {
	// 支払メデイア関連情報を取得する
	var _paymentCovnertMap = JSON.parse("{!JSENCODE(payTypeConvertJson)}");
	// 支払種別ー支払メディアへ変換用オブジェクト
	if (_paymentCovnertMap.hasOwnProperty(payType)) {
		return _paymentCovnertMap[payType];
	} else {
		return "";
	}
}

<!--　該当支払情報は返金するがどうかチェック -->
function isRefundItem(paytype) {
	// 返金比較用キー
	var _refundKeyArr = JSON.parse("{!JSENCODE(refundItemString)}");
	return (paytype.length > 0 && _refundKeyArr.indexOf(paytype) >= 0);
}
// -------------------
// 利用金額、お釣り金額設定
// rowIdx:明細行数
// reciveAmount:預かり金額
// usedAmount:利用金額
// -------------------
function setPaymentInfo (rowIdx, reciveAmount, usedAmount, surplus) {
	// 預かり金額
	// 利用金額
	$j("input:hidden[id$=':" + rowIdx + ":hidUsedAmount']").val(usedAmount);
	// お釣り金額
	$j("input:hidden[id$=':" + rowIdx + ":hidChangeAmout']").val(surplus);
}	
// 2017/01/12 统一行追加功能改修 by zy BEGIN
function _checkDetailFullInputFun(rowindex) {
	/*
   	// 入力できる行目がなかった場合、自動追加する
   	var _productsArr = $j("input[id$=':productName']");
   	// ISBALNK存在の場合、
   	var blankLineNoExist = true;
   	for (i=(_productsArr.length-1);i>=0;i--) {
   		if (_productsArr[i].value == "") {
   			blankLineNoExist = false;
   			break;
   		}
   	}
   	if (blankLineNoExist) {
   		checkAddTranItem();
   	}
   	*/
   	$j("input[id$='" + rowindex + ":productName']").blur();
   	
}
// 2017/01/12 统一行追加功能改修 by zy END
// 見積明細の最後行目の項目をフォックスする
function _gotoLastDetailRow() {
	// 2017/01/12 统一行追加功能改修 by zy BEGIN
	/*
	// 新規追加の行の商品名にFOCUSする
	var _productsArr = $j("input[id$=':productName']");
	for (i=0;i<_productsArr.length;i++) {
   		if (_productsArr[i].value == "") {
   			_productsArr[i].focus();
   			break;
   		}
   	}*/
   	autoFocus();
	// 2017/01/12 统一行追加功能改修 by zy END
}
//2017/01/16 统一行追加功能改修 by zy BEGIN
function lastBookingDetail(){
	var lastSector = "input[id$=':price'],input[id$=':orderNums'],input[id$=':productName']";
	$j(lastSector,"tr.tranDetailRow:last").unbind("focus");
    $j(lastSector,"tr.tranDetailRow:last").on("focus",function(){
    	//2017/01/18 鼠标选中 行追加失效功能添加 by zy BEGIN
	    $j(".pointIndex").addClass("disabled");
	    //2017/01/18 鼠标选中 行追加失效功能添加 by zy END
    });
    $j(lastSector,"tr.tranDetailRow:last").unbind("blur");
    $j(lastSector,"tr.tranDetailRow:last").on("blur",function(){
    	//2017/01/18 排除扩展子明细行取得index值 by zy BEGIN
    	//var rowIndex = $j(this).closest("tr.tranDetailRow").index();
    	var rowIndex = $j("tr.tranDetailRow").index($j(this).closest("tr.tranDetailRow"));
    	//2017/01/18 排除扩展子明细行取得index值 by zy END
    	//2017/01/18 鼠标选中 行追加失效功能添加 by zy BEGIN
	    $j(".pointIndex").removeClass("disabled");
	    //2017/01/18 鼠标选中 行追加失效功能添加 by zy END
    	if (!chkValidate(rowIndex)) return;
    	curFocusUUid = (rowIndex + 1) + ':productName' ;
    	//$j(this).attr("id");
    	refreshOrder(true);
    	checkAddTranItem();
    }).addClass("lastBlurRow");
    //2017/01/18 鼠标选中 行追加失效功能添加 by zy BEGIN
	$j("input.disBtn,input[id$=clearProduct]").unbind("mouseenter");
	$j("input.disBtn,input[id$=clearProduct]").on("mouseenter",function(){
		blurDisabled = true;
	});
	$j("input.disBtn,input[id$=clearProduct]").unbind("mouseleave");
	$j("input.disBtn,input[id$=clearProduct]").on("mouseleave",function(){
		blurDisabled = false;
	});
	//2017/01/18 鼠标选中 行追加失效功能添加 by zy END
}
var curFocusUUid;var blurDisabled = false;
function autoFocus(){
	if (curFocusUUid != undefined){
		$j("[id$='" + curFocusUUid + "']").focus();
		curFocusUUid = undefined;
	}
	// 2019/04/15 ベネフィットホテル様より改善要望 by zy BEGIN
    if ("addRowCallBack" in window) addRowCallBack();
    // 2019/04/15 ベネフィットホテル様より改善要望 by zy END
    // 2020/07/30 入湯税の自動入力機能について改善 WGCH BEGIN
    // 行追加补充入汤税行
    ACTCUSTOM.BATHTAXAUTOSETFUN(null, ACTCUSTOM.OBJ.ADDROWCALLBACKRES, true);
    // 2020/07/30 入湯税の自動入力機能について改善 WGCH END
}
function chkValidate(rowIdx){
	//2017/01/18 鼠标选中 行追加失效功能添加 by zy BEGIN
	if (blurDisabled) return false;
	//2017/01/18 鼠标选中 行追加失效功能添加 by zy END
	var lastSector = "input[id$=':price'],input[id$=':orderNums'],input[id$=':productName']";
	var chkflag = true;
	$j(lastSector,"tr.tranDetailRow:eq(" + rowIdx + ")").each(function(){
		if($j(this).val() == "") {
			chkflag = false;
			//break;
			return false;
		}
	});
	return chkflag;
}
//2017/01/16 统一行追加功能改修 by zy END
// 2017/06/12 MulitiSelect Clear Bug Fix BEGIN
function multiSelectRest(){
	var selectOptins = $j("select[id$='_selected'][multiple='multiple'] option","#createLeadPanel");
	if(selectOptins.length > 0){
		selectOptins.each(function(){
			this.selected = true;
		});
		$j("select[multiple='multiple']:not([id$='_selected'],[id$='_unselected'])","#createLeadPanel").each(function(){
			var elementId = $j(this).attr("id");
			MultiSelectPicklist.handleMSPUnSelect(elementId);
		});
	}
}
// 2017/06/12 MulitiSelect Clear Bug Fix END
// 2017/09/18  会計一括印刷機能  WGCH BEGIN
function openAccountPdfBulkPrint(){
	// 指定日 
	var queryDate = getQueryDate();
	// 支店コード
	//var branchCd = $j("select[id$=':branchShopCd']").length > 0 ? $j("select[id$=':branchShopCd']").val() : "";
	var branchCd = _getDefShopCode();
	var openUrl = "{!URLFOR('/apex/AccountPdfBulkPrint')}" + "?qdt=" + queryDate + " &shopcd=" + branchCd;
	window.open(openUrl);
}
// 2017/09/18  会計一括印刷機能  WGCH END
// 2019/04/30 増税仮対応 WGCH BEGIN
// 标识符-不自动进入増税处理函数
var CUST_AUTOGETPRODUCTMODE_RETURN = 'RETUEN';
// 标识符-clearOnclick
var CUST_CLICKMODE_CLEAR = 'CLEAR';
// 增税商品数据集
var taxIncInfo = '{!taxIncMstItemJson}';
// 増税处理函数
function autoSetTaxIncProductFun(click_mode, productId){
	// 增税商品数据集转成sobj
	var taxIncMstDs = $j.parseJSON(taxIncInfo);
	if(taxIncMstDs == undefined) return;
	// 不存在有效的增税商品 跳出处理
	if(taxIncMstDs.taxIncMst  == undefined || taxIncMstDs.taxIncMstId == "") return;
	// clear 增税商品时跳出处理
	if(click_mode == CUST_CLICKMODE_CLEAR && productId == taxIncMstDs.taxIncMstId) return;
	// 获取当前指定日
	var queryDate = getQueryDate();
	// 当前指定日 < 定义開始日 || 当前指定日 > 終了日 跳出处理
	if(queryDate < taxIncMstDs.startDate || queryDate > taxIncMstDs.endDate) return;
	// 获取指定的增税商品Input
	var $taxIncMstInput = $j("[id$=hidProductId][value][value = '" + taxIncMstDs.taxIncMstId  + "']");
	// 有效处理行Array(消费税 > 0)
	var nowProdArr = new Array();
	// 获取明细所有行
	var $trRowAll = $j("[id$=BookEstTable] tbody tr.tranDetailRow");
	$trRowAll.each(function(){
		var $hidProductId = $j(this).find('[id$=hidProductId]');
		if($hidProductId.val() !=''){
			// 当前行-RowNo
			var rowIndex = $hidProductId.attr("rowindex") * 1;
			// 2019/05/31 消費税の端数計算は見積書と一致しなかった、対応 WGCH BEGIN
			var hidProductId = $j("[id$=':" + rowIndex + ":hidProductId']").val();
			if(taxIncMstDs.filterMstIdSet.indexOf(hidProductId) >= 0 ) return true;
			// 数量
			var nums = kendo.parseFloat($j("input:text[id$=':" + rowIndex + ":orderNums']").val());
			if (nums == null) nums = 0;
			if(nums <= 0) return true;
			// 2019/05/31 消費税の端数計算は見積書と一致しなかった、対応 WGCH END
			// 当前行-消費税率
			var tax = kendo.parseFloat($j("input:hidden[id$=':" + rowIndex + ":hidTaxRateType']").val());
			if (tax == null) tax = 0;
			// 集计消费税 > 0 的Tr
			if(tax > 0) nowProdArr.push(this);
		}
	});
	// 处理有效行
	if(nowProdArr.length > 0){
		var wkRowIndex, // 最终增税商品RowNo
			wkPriceTax = 0; // 最终增税商品单价(数量固定1)
		for (var i = 0; i < nowProdArr.length;i++) {
			// 当前行-RowNo
			var rowIndex = $j(nowProdArr[i]).find('[id$=hidProductId]').attr("rowindex") * 1;
			// 当前行-消費税率
			var tax = kendo.parseFloat($j("input:hidden[id$=':" + rowIndex + ":hidTaxRateType']").val());
			if (tax == null) tax = 0;
			// 当前行-金額（税込み）
			var amountIncTax = kendo.parseFloat($j("input[id$=':" + rowIndex + ":hidAmoutPriceIncTax']").val());
			if (amountIncTax == null) amountIncTax = 0;
			// 当前行-金額（税抜き）
			var amountExcTax = kendo.parseFloat($j("input[id$=':" + rowIndex + ":hidAmoutPriceExcTax']").val());
			if (amountExcTax == null) amountExcTax = 0;
			// 当前行-特別税
			var numSepcTax = kendo.parseFloat($j("input[id$=':" + rowIndex + ":hidSpecialTax']").val());
			if (numSepcTax == null) numSepcTax = 0;
			/*
			* commUtils.mathNumSub(A, B) => A - B
			* commUtils.mathNumAdd(A, B) => A + B
			* commUtils.mathNumDiv(A, B) => A / B
			* commUtils.mathNumMulti(A, B) => A * B
			算法公式:
				增税金额 = 增税率 / 商品-消费税率 * 商品-消费税金额
			*/
			// 当前行-商品-消费税金额 => 当前行-金額（税込み）-(减) 当前行-金額（税抜き）-(减) 当前行-特別税
			var priceTax = commUtils.mathNumSub( commUtils.mathNumSub(amountIncTax, amountExcTax), numSepcTax);
			// 增税金额 = 增税率 / 商品-消费税率 * 商品-消费税金额
			if(tax > 0){ // 虽然此tax一定大于0，防御处理
				// taxIncMstDs.taxIncRate => 增税率
				wkPriceTax = commUtils.mathNumAdd( wkPriceTax, commUtils.mathNumMulti( commUtils.mathNumDiv(taxIncMstDs.taxIncRate, tax), priceTax));
			} 
		}
		// 如果已存在增税商品, 把新的增税商品-RowNo 替换成 当前存在的增税商品-RowNo*防止多笔增税商品
		if( $taxIncMstInput.length > 0) wkRowIndex = $taxIncMstInput.eq(0).attr("rowindex");
		else{
			// 処理行
			var dataRows = $j("tr.tranDetailRow");
			// 非空行
			var noBlankRows = dataRows.has("[id$=hidProductId][value][value!='']");
			// 空行
			var blankRows = dataRows.not(noBlankRows);
			if(blankRows.length > 0) wkRowIndex = blankRows.eq(0).find('[id$=hidProductId]').attr("rowindex") * 1;
			else {
				// 行号处理
				refreshOrder(true);
				checkAddTranItem();
				return;
			}
		}
		// 最终增税商品单价(数量固定1) 小数点处理
		// 2019/05/31 消費税の端数計算は見積書と一致しなかった、対応 WGCH BEGIN
		// wkPriceTax = commUtils.mathRound(wkPriceTax, JINYACONNECT.PRODUCT.CAL.POINT_LEN, JINYACONNECT.PRODUCT.CAL.ROUND_MODE);
		wkPriceTax = commUtils.mathRound(wkPriceTax, JINYACONNECT.PRODUCT.CAL.POINT_LEN, taxIncMstDs.pointRoundModeStr);
		// 2019/05/31 消費税の端数計算は見積書と一致しなかった、対応 WGCH END
		// 数据集-克隆处理-防止地址共存【true: 深度克隆; false: 浅度克隆(def) 】
		_thisTaxIncMstDs = $j.extend(true, {}, taxIncMstDs);
		// 最终增税商品RowNo赋值
		_thisTaxIncMstDs.taxIncMst.rowIndex = wkRowIndex;
		// 最终增税商品单价(数量固定1)赋值
		_thisTaxIncMstDs.taxIncMst.unitPrice = wkPriceTax;
		// 最终增税商品单价 > 0 时再处理追加或更新 增税商品
		if(wkPriceTax > 0) autoGetProductInfo(_thisTaxIncMstDs.taxIncMst, CUST_AUTOGETPRODUCTMODE_RETURN);
		// 如果当前行存在增税商品数据=>clear当前行数据
		else if($j("[id$='" + wkRowIndex + ":hidProductId'][value][value = '" + _thisTaxIncMstDs.taxIncMstId  + "']").length > 0){
			// 当前没增税金额时, 清空增税商品行
			$j("[id$='clearProduct'][rowindex='" + wkRowIndex +"']").click();
		}
	} else if( $taxIncMstInput.length > 0){
		// 当前没有处理行时, 清空增税商品行
		var wkRowIndex =  $taxIncMstInput.eq(0).attr("rowindex");
		$j("[id$='clearProduct'][rowindex='" + wkRowIndex +"']").click();
	}
}
// 2019/04/30 増税仮対応 WGCH END
// 2018/05/01 ルームインジケータで予約をクリックして、『部屋詳細情報』が開きます。 by zy BEGIN
function closeDetailWin(){
	var autoFlag = $j("#hidAutoCloseFlag").val();
	if (autoFlag == "false") $j("#cancelBtn").click();
}
// 2018/05/01 ルームインジケータで予約をクリックして、『部屋詳細情報』が開きます。 by zy END
// 2018/05/11 複数店舗を選択表示できる機能対応 BEGIN
// 選択した店舗コード情報を取得する
function _getDefShopCode(singFlg) {
	var $sp = $j("select[id$=':{!IF( multiSelectCompFlg, 'branchShopCd', 'branchShopCdDef')}']");
	var branchCd = $sp.length > 0 ? $sp.val() : "";
	// 2021/03/05 50001エラー修正 by zy BEGIN
	// 2021/04/31 #10821 bug fixed by zy BEGIN
	var limitSpcd = $j("#hidLimitShopCode").val();
	// 2021/04/31 #10821 bug fixed by zy END
	if (limitSpcd != "") return limitSpcd;
	else 
	// 2021/03/05 50001エラー修正 by zy END
	if (branchCd instanceof Array) return (singFlg ? branchCd.join() : branchCd[0]);
	else return branchCd;
}
// set kendo comobx width
function setDropDropDownWidth(el) {
	if (el.length == 0) return;
    var d = el;
    var p = d.data("kendoDropDownList").popup.element;
    var w = p.css("visibility","hidden").show().outerWidth();
    p.hide().css("visibility","visible");
    d.closest(".k-widget").width(w+30);
}
// 2018/05/11 複数店舗を選択表示できる機能対応 END
// 2018/07/27 宿泊税計算 WGCH BEGIN
var thisRoomSpcd = "";
var planItemPriceMap = new Map();
var planItemTypeMap = new Map();
var hotelTaxDefineInfoData = {!hotelTaxDefineInfoJson};
function getPlanKeyFun(rowIndex){
	var _productId = $j("input:hidden[id$=':" + rowIndex + ":hidProductId']");
	return _productId.val() + '_' + _productId.attr('rowNo');
}
// 2018/07/27 宿泊税計算 WGCH END
// 2019/07/30 軽減税率機能対応 WGCH BEGIN
var isReducedTaxFlg = {!isReducedTaxFlg}, // 軽減税率機能FLG
	_planItemMap = new Map(), // 选中所有PLAN对应的PLAN明细MAP
	CUST_TABLE = "table[id$=':BookEstTable']", // 明细行TableID
	ACTTYPE_PLAN = "{!JSENCODE(ACTTYPE_PLAN)}"; // プラン
/*
* 获取カスタムメタデータ型:宿泊税定义信息
*/
function getHotelTaxInfoFun(){
	var _hotelTaxData = hotelTaxDefineInfoData[thisRoomSpcd];
	return {
		data : _hotelTaxData, // 宿泊税定义信息
		isEffectiveFlg : _hotelTaxData != undefined // 判断是否有效的宿泊税数据集
		// 2019/10/02 PlanHeader算法切换对应 WGCH BEGIN
		,planBrkToHeaderCalFlg : {!planBrkToHeaderCalFlg}
		// 2019/10/02 PlanHeader算法切换对应 WGCH END
	}
}
/*
* 获取当前行数据集
*/
function getRowInfoFun(rowIndex){
	// 单价
	var unitPrice = kendo.parseFloat($j("input:text[id$=':" + rowIndex + ":price']").val());
	if (unitPrice == null) unitPrice = 0;
	// 消費税率
	var tax = kendo.parseFloat($j("input:hidden[id$=':" + rowIndex + ":hidTaxRateType']").val());
	if (tax == null) tax = 0;
	// サビース料率
	var service = kendo.parseFloat($j("input:hidden[id$=':" + rowIndex + ":hidServiceRate']").val());
	if (service == null) service = 0;
	// 数量
	var nums = kendo.parseFloat($j("input:text[id$=':" + rowIndex + ":orderNums']").val());
	if (nums == null) nums = 0;
	// 特別税
	var numSepcTax = kendo.parseFloat($j("input[id$=':" + rowIndex + ":hidSpecialTax']").val());
	if (numSepcTax == null) numSepcTax = 0;
	// 単価定義区分
	var unitPriceKbn = $j("input:hidden[id$=':" + rowIndex + ":hidUnitPriceKbn']").val();
	// 商品ID
	var productId = $j("input:hidden[id$=':" + rowIndex + ":hidProductId']").val();
	// 商品処理種別
	var actionType = $j("input:hidden[id$=':" + rowIndex + ":hidActionType']").val();
	// 支付种别
	var payType = $j("input:hidden[id$=':" + rowIndex + ":hidPaymentType']").val();
	// プラン明細課税、非課税混在合計金額計算
	var hidPlandetail = kendo.parseFloat($j("input:hidden[id$=':" + rowIndex + ":hidPlandetail']").val());
	if (hidPlandetail == null) hidPlandetail = 0;
	// 金額（税抜き）
	var amountExcTax = kendo.parseFloat($j("input:hidden[id$=':" + rowIndex + ":hidAmoutPriceExcTax']").val());
	if (amountExcTax == null) amountExcTax = 0;
	// 金額（税込み） 
	var amoutPriceIncTax = kendo.parseFloat($j("input:hidden[id$=':" + rowIndex + ":hidAmoutPriceIncTax']").val());
	if (amoutPriceIncTax == null) amoutPriceIncTax = 0;
	return commUtils.setData(rowIndex, unitPrice, tax, service, nums, numSepcTax, unitPriceKbn, productId, actionType, false, payType, hidPlandetail, amountExcTax, amoutPriceIncTax);
}
/*
* 初期重置RES处理
*/
function getResInfoFun(rowIndex, res){
	var hasNumSepcTaxSum = 0, // 合計金額(税抜) 列 含有的宿泊税
		newNumSepcTaxSum = 0, // 特別税        列 显示的宿泊税
		_newRes = $j.extend(true, {}, res), // 防止地址共存
		_row = getRowInfoFun(rowIndex), // 获取当前行数据集
		_hotelTax = getHotelTaxInfoFun(); // 获取カスタムメタデータ型:宿泊税定义信息
	// 宿泊税有效, 处理种别是室料
	if(_hotelTax.isEffectiveFlg && _row.actionType == _CONST_PRICE_ROOM_TYPE){
		// 获取宿泊税计算后数据集
		var _res = commUtils.getSepcTaxInfoFun(res, _row, _hotelTax.data);
		_newRes = _res.res; // 最终的RES「置换」
		hasNumSepcTaxSum = _res.hasNumSepcTaxSum; // 合計金額(税抜) 列 含有的宿泊税「赋值」
		newNumSepcTaxSum = _res.newNumSepcTaxSum; // 特別税        列 显示的宿泊税「赋值」
	// 处理种别是PLAN
	} else if(_row.actionType == ACTTYPE_PLAN){
		var _data = commUtils.getPlanResInfoFun(_planItemMap.get(getPlanKeyFun(rowIndex)), _row, _hotelTax, isReducedTaxFlg);
		// TODO: 目前之后处理只用的这里个变量「只置换了这两个变量」* 进来了就说明功能已经打开的
		_newRes.priceIncTax = _data.priceIncTaxSum; // 最新值设定「合計金額」
		_newRes.priceExcTax = _data.priceExcTaxSum; // 最新值设定「合計金額(税抜)」
		hasNumSepcTaxSum = _data.hasNumSepcTaxSum; // 合計金額(税抜) 列 含有的宿泊税「赋值」
		newNumSepcTaxSum = _data.newNumSepcTaxSum; // 特別税        列 显示的宿泊税「赋值」
	}
	// 设置特别税列数据
	if(_hotelTax.isEffectiveFlg){
		$j("input[id$=':" + rowIndex + ":hidSpecialTax']").val(newNumSepcTaxSum); // 最新的特别税「隐藏域赋值」
		$j("span[id$=':" + rowIndex + ":specialTax']").text(newNumSepcTaxSum); // 最新的特别税「显示域赋值」
		_row.specialTax = newNumSepcTaxSum; // 最新的特别税「赋值」
	}
	return {
		res : _newRes,
		numSepcTax : _row.specialTax
	};
}
/*
* PLAN明细数据更新处理
*/
function updatePlanItemMapFun(rowIndex){
	var _row = getRowInfoFun(rowIndex); // 获取当前PLAN行数据集
	if(_row.actionType != ACTTYPE_PLAN) return;
	var planKey = getPlanKeyFun(rowIndex), // 获取当前PLAN的KEY
		_planItemLst = _planItemMap.get(planKey); // 当前PLAN明细ARR
	if(commUtils.isUndefined(_planItemLst)) return;
	var wkLen = _planItemLst.length; // PLAN明细数量
	if(wkLen == 0) return;
	// 最新的当前PLAN明细ARR
	var newPlanItemLst = new Array();
	for(var i = 0; i < wkLen; i++){
		// 当前明细数据集
		var _data, // 当前行的数据集
			_pd = $j.extend(true, {}, _planItemLst[i]);
		// 当前明细的会計商品ID「最新的防止变更会计商品，不能直接用_pd.productId」
		var $productId = $j("#"+rowIndex+"_prodid_"+i);
		if($productId.length > 0){
			productId = $productId.val();
			// 单价
			var unitPrice = kendo.parseFloat($j("#"+rowIndex+"_prodPrice_"+i).val());
			if(unitPrice == null) unitPrice = 0;
			// 消费税
			var tax = kendo.parseFloat($j("#"+rowIndex+"_workHidTaxRate_"+i).val());
			if(tax == null) tax = 0;
			// サビース料
			var serviceRate = kendo.parseFloat($j("#"+rowIndex+"_workHidServiceTaxRate_"+i).val());
			if(serviceRate == null) serviceRate = 0;
			// 商品処理種別
			var actionType = $j("#"+rowIndex+"_workHidActType_"+i).val();
			// 当前行设置最新的数据集
			_data = commUtils.setData(_row.rowIndex, unitPrice, tax, serviceRate, _row.nums, _pd.specialTax, _row.unitPriceKbn, productId, actionType, true);
		} else{
			_data = commUtils.setData(_row.rowIndex, _pd.unitPrice, _pd.tax, _pd.serviceRate, _row.nums, _pd.specialTax, _row.unitPriceKbn, _pd.productId, _pd.actionType, true);
		}
		// PUSH最新的数据集
		newPlanItemLst.push(_data);
	}
	// 更新最新的PLAN明细数据集
	_planItemMap.set(planKey, newPlanItemLst);
}
// 2019/07/30 軽減税率機能対応 WGCH END
// 2019/09/15 指定日自动记忆機能対応 WGCH BEGIN
var isChkInDayFlg = {!isChkInDayFlg};
var userId = "{!JSENCODE(userId)}";
function setCheckInDayCookieFun(){
	if(!isChkInDayFlg) return;
	var cookVal = getQueryDate();
	// DBへ情報格納
	JINYACONNECT.CONFIG.saveKrepConfig('CHECKINDAY', cookVal, userId, '');
}
// 2019/09/15 指定日自动记忆機能対応 WGCH END
// 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH BEGIN
function openPlanWinFun(){
	if (!JINYACONNECT.CUSTOM.checkIfHadRequiredItem()) return false;
	// 既存会計商品画面
	var searchWin = $j("#openPlanWindow");
	// 新規会計商品画面
	if (searchWin.length == 0) {
		searchWin = $j("<div id='openPlanWindow' / >");
		$j("body").append(searchWin);
	}
	var roomTypeId = $j("input[id$=':hidRoomType']").val();
	// var queryDate = getQueryDate();
	var queryDate = $j("input[id$=':gotoDate']").length > 0 ? $j("input[id$=':gotoDate']").val() : kendo.toString(new Date(), JINYACONNECT.DateFormat );
	var src = '/apex/BasePlanSetupView?callback=window.parent.ProdcutPlanSet&roomType=' + roomTypeId + '&queryDate=' + queryDate;
	// KENDOUI初期化
	if (searchWin.data("kendoWindow") == undefined) {
		window.setFocusOnLoad = function (){};
		var orgWd = window.localStorage.J_SEARCH_WIN_WD;
		var orgHt = window.localStorage.J_SEARCH_WIN_HT;
		var posTop = window.localStorage.J_SEARCH_WIN_TOP;
		var posLeft = window.localStorage.J_SEARCH_WIN_LEFT;
		if (orgWd == undefined) orgWd = 540;
		if (orgHt == undefined) orgHt = 550;
		searchWin.kendoWindow({
			visible: false,
			content: src,
			iframe: true,
			width: 760,
			height : 550,
			title : 'ベースプラン商品選択',
			actions: ["close"],
			autoFocus: false,
			dragstart:function(){
				var off = this.wrapper.offset();
				this.wrapper.css("position","absolute");
				this.wrapper.offset(off);
			},
			// 画面位置保持
			dragend:function(){
				var offset = this.wrapper.offset();
				this.wrapper.css("position","fixed");
				this.wrapper.offset(offset);
				var pos = this.wrapper.get(0).getClientRects()[0];
				window.localStorage.J_SEARCH_WIN_TOP = pos.top;
				window.localStorage.J_SEARCH_WIN_LEFT = pos.left;
			},
			// 画面サイズ保持
			resize:function(){
				window.localStorage.J_SEARCH_WIN_WD = this.wrapper.width();
				window.localStorage.J_SEARCH_WIN_HT = this.wrapper.height();
			}
		});
		searchWin.data("kendoWindow")._shouldFocus = function(){};
		var wrapWindow = searchWin.closest("div.k-window");
		wrapWindow.find(".k-i-close").bind("click",function(){
			closeProductWin();
		});
		searchWin.data("kendoWindow").center();
		var cssObj = {"position":"fixed","left":"35%"};
		cssObj.top = kendo.parseFloat("80");
		// 画面様式設定
		wrapWindow.css(cssObj);
	} else {
		var openPlan = $j("#openPlanWindow").getKendoWindow();
		openPlan.options.content.url = src;
		openPlan.refresh();
	}
	var kendoWin = searchWin.data("kendoWindow");
	kendoWin.open();
}
var orderNumsFlg = false;
// 選択会計CALLBACK
function ProdcutPlanSet(restLst) {
orderNumsFlg = true;
	// 空白行数取得
	var blankRows = getBlankRows();
	// 2020/06/01 bug fix BY zyz BEGIN
	var serachWin = $j("#openPlanWindow").data("kendoWindow");
	serachWin.close();
	// 2020/06/01 bug fix BY zyz END
	// 行追加の場合
	if (blankRows.length < restLst.length) {
		// 関数クリア
		if ("addRowCallBack" in window) delete window.addRowCallBack;
		// 行追加後、処理対応
		window.addRowCallBack = function(){
			ProdcutPlanSet(restLst);
			delete window.addRowCallBack;
		}
		$j("input[id$=hidaddRowsMan]").val(restLst.length);
		// 行追加開始
		addTranItemFun();
		return;
	}
for (var i=0; i < restLst.length;i++) {
  var rest = restLst[i];
  var data = $j.extend({},rest);
  if (data.rowIndex != undefined) {
    window.productId = data.productId;
    window.lastIndex = data.rowIndex;
    autoGetProductInfo(data);
    $j("input[id$=productName]").eq(data.rowIndex).focus();
  } else {
    getNextRow(data);
  }
  }
  orderNumsFlg = false;
  $j("input[id$=hidaddRowsMan]").val(0);
}

// 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH END
// 2019/04/15 ベネフィットホテル様より改善要望 by zy BEGIN
// 初期化会計画面
function initProductWin(){
  var bookingEstFlag = "{!$Setup.CommDefine__c.ps__ProductSearchLayoutKbn__c}";
  if (bookingEstFlag != "1") return;
  // 既存会計商品画面
  var searchWin = $j("#producdSearchWindow");
  // 新規会計商品画面
  if (searchWin.length == 0) {
  	// 2019/04/30 $=>$j修正 WGCH BEGIN
  	/*
    searchWin = $("<div id='producdSearchWindow' / >");
    $("body").append(searchWin);
    */
    searchWin = $j("<div id='producdSearchWindow' / >");
    $j("body").append(searchWin);
    // 2019/04/30修正 WGCH END
  }
  // KENDOUI初期化
  if (searchWin.data("kendoWindow") == undefined) {
    window.setFocusOnLoad = function (){};
    var src = '/apex/AccountMasterInput?spcd={!JSENCODE(branchShopNm)}&callback=window.parent.ProdcutSet';
    var orgWd = window.localStorage.J_SEARCH_WIN_WD;
    var orgHt = window.localStorage.J_SEARCH_WIN_HT;
    var posTop = window.localStorage.J_SEARCH_WIN_TOP;
    var posLeft = window.localStorage.J_SEARCH_WIN_LEFT;
    if (orgWd == undefined) orgWd = 540;
    if (orgHt == undefined) orgHt = 550;
    searchWin.kendoWindow({
        visible: false,
        content: src,
        iframe: true,
        width: orgWd,
        height : orgHt,
        title : '商品選択',
        actions: ["close"],
        autoFocus: false,
        dragstart:function(){
          var off = this.wrapper.offset();
          this.wrapper.css("position","absolute");
          this.wrapper.offset(off);
        },
        // 画面位置保持
        dragend:function(){
          var offset = this.wrapper.offset();
          this.wrapper.css("position","fixed");
          this.wrapper.offset(offset);
          var pos = this.wrapper.get(0).getClientRects()[0];
          window.localStorage.J_SEARCH_WIN_TOP = pos.top;
          window.localStorage.J_SEARCH_WIN_LEFT = pos.left;
        },
        // 画面サイズ保持
        resize:function(){
          window.localStorage.J_SEARCH_WIN_WD = this.wrapper.width();
          window.localStorage.J_SEARCH_WIN_HT = this.wrapper.height();
        }
    });
    searchWin.data("kendoWindow")._shouldFocus = function(){};
    var wrapWindow = $j("#producdSearchWindow").closest("div.k-window");
    wrapWindow.find(".k-i-close").bind("click",function(){
      closeProductWin();
    });
    $j("#producdSearchWindow").data("kendoWindow").center();
    var cssObj = {"position":"fixed","left":"60%"};
    if(posTop != undefined) cssObj.top = kendo.parseFloat(posTop);
    if(posLeft != undefined) cssObj.left = kendo.parseFloat(posLeft);
    // 画面様式設定
    wrapWindow.css(cssObj);
  }
}
function clearProdWin(){
  if ("productId" in window) delete window.productId;
  if ("lastIndex" in window) delete window.lastIndex;
  closeProductWin();
}
function closeProductWin(){
  var bookingEstFlag = "{!$Setup.CommDefine__c.ps__ProductSearchLayoutKbn__c}";
  if (bookingEstFlag != "1") return;
  $j("#producdSearchWindow").data("kendoWindow").close();
}
function openProductWin(index){
  var kendoWin = $j("#producdSearchWindow").data("kendoWindow");
  kendoWin.open();
}
// 選択会計CALLBACK
function ProdcutSet(rest) {
  var data = $j.extend({},rest);
  if (data.rowIndex != undefined) {
    window.productId = data.productId;
    window.lastIndex = data.rowIndex;
    autoGetProductInfo(data);
    // 2020/07/30 入湯税の自動入力機能について改善 WGCH BEGIN
    // 触发追加入汤税行
    ACTCUSTOM.BATHTAXAUTOSETFUN(data.rowIndex, data.bTaxAccMstItem);
    // 2020/07/30 入湯税の自動入力機能について改善 WGCH END
    $j("tr.tranDetailRow").has(".pointIndex[rowindex='" + data.rowIndex + "']").focus();
  } else {
    getNextRow(data);
  }
}
// 会計設定行取得
function getNextRow(data){
  // 処理行
  var dataRows = $j("tr.tranDetailRow");
  // 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH BEGIN
  /*
  // 非空行
  var noBlankRows = dataRows.has("[id$=hidProductId][value][value!='']");
  // 空行
  var blankRows = dataRows.not(noBlankRows);
  */
  var blankRows = getBlankRows(dataRows);
  // 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH END
  // 行追加
  if (blankRows.length == 0) {
  	// 行追加後処理
    return addRowCallBack = function(){
      // 既存処理削除
      delete window.addRowCallBack;
      // 会計商品再処理
      ProdcutSet(data);
    },checkAddTranItem();
  }
  // 前回設定会計商品
  var preProdId,preProdIdx;
  if ("productId" in window) preProdId = window.productId;
  if ("lastIndex" in window) preProdIdx = window.lastIndex;
  // 同じ会計商品数量追加
  // 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH BEGIN
  // if ( preProdId == data.productId) {
  if ( preProdId == data.productId && !orderNumsFlg) {
  // 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH END
    var prodNums = $j("input:text[id$=':" + window.lastIndex + ":orderNums']");
    // 数量
    var nums = kendo.parseFloat(prodNums.val());
    // 初期化
    if (nums == null) nums = 0;
    nums++;
    prodNums.val(nums);
    return prodNums.change.call(prodNums);
  }
  // 空白行会計設定
  if (blankRows.length > 0) {
    data.rowIndex = blankRows.first().find(".pointIndex ").attr("rowindex");
    return ProdcutSet(data);
  }
}
// 2019/04/15 ベネフィットホテル様より改善要望 by zy END
// 2019/05/30 こちらをルームインジケータ上からも1日単位の作成、削除（削除だけでもほしい）by zy BEGIN
// 処理完了
function removeBadRoom(){
    // 照会する部屋ID
    var queryRoomId = $j("input[id$=':bHidRoomId']").val();
    // 該当予約と同じ予約IndexIdを取得する
    //一括清掃よろしいですか
    var confirmMsg = "{!$Label.MSG_008_0108}";
    // 清掃部屋リスト
    var roomIds = new Array();
    roomIds.push(queryRoomId);
    // 検索条件を設定する 
	var queryDate = getQueryDate();
	// 2020/06/30 6907 bug fixed by zy BEGIN
	// 当日はチェックイン情報・チェックアウト情報表示制御フラグ
	var isShowTodayInfo = getShowTodayFlg();
	// 2020/06/30 6907 bug fixed by zy END
    var obj = {
        roomIds:roomIds,
		queryDt:queryDate
		// 2020/06/30 6907 bug fixed by zy BEGIN
		,showToday:isShowTodayInfo
		// 2020/06/30 6907 bug fixed by zy END
	}
	// 2020/06/30 6907 bug fixed by zy BEGIN
	indicaorRemoteCenter('badRoomAction',JSON.stringify(obj),refreshPageFun);
	// 2020/06/30 6907 bug fixed by zy BEGIN
}
// 2020/06/30 6907 bug fixed by zy BEGIN
function indicaorRemoteCenter(type,data,callback){
// 2020/06/30 6907 bug fixed by zy END
    blockUi();
    Visualforce.remoting.Manager.invokeAction(
        "{!$RemoteAction.RoomIndicatorInfo.remoteCenter}", type,data, function(result, event){
            // 異常
            if(event.type == 'exception') {
            } else {}
            if (callback) callback(result);
    });
}
// 2019/05/30 こちらをルームインジケータ上からも1日単位の作成、削除（削除だけでもほしい）by zy END
// 2019/06/15 新規予約を部屋ごとに時間と到着日をデフォルト設定 BY zyz BEGIN
function getRoomTypeTime(RTId){
	var leadTimeMap = new Map();
	// 获取时间定义数据
	var defJson = $j("[id$=hidleadTimeJsons]").val();
	leadTimeMap = defJson !="" ? JSON.parse($j("[id$=hidleadTimeJsons]").val()) : undefined;
	if (leadTimeMap) {
		// 获取房型下对应的设定
		var roomTimeLst = leadTimeMap[RTId];
		if(roomTimeLst == "" || roomTimeLst == null || roomTimeLst == undefined) return true;
		for(var i=0 ; i < roomTimeLst.length ; i++){
			var apiName = roomTimeLst[i].nm;
			var apivalue = roomTimeLst[i].val;
			if(apiName.indexOf("__c") >= 0){
				// XML自设定字段对应初期値
				apiName = 'lead_'+ apiName;
				$j("[element="+apiName+"]").val(apivalue);
			} else {
				// XML自设定且特殊定义的字段对应初期値
				$j("[id$=':"+apiName+"']").val(apivalue);
			}
		}
	}
}
// 2019/06/15 新規予約を部屋ごとに時間と到着日をデフォルト設定 BY zyz END
// 2019/10/30 ルームインジケータに「自動一括アサイン」ボタンが欲しい by zy BEGIN
function autoAssignAllRoom(){
	// 画面ロック
	blockUi();
	// 未清掃部屋でも、割り当てする部屋可能の配列に格納する
	var leadArr = [];
	// 未割り当て予約取得
	$j(".noAssignLead[groupflg=true]").each(function(){
		leadArr = leadArr.concat($j(this).attr("childrenitems").split(","));
	});
	if (leadArr.length == 0) {
		unblockUi();
		return;
	}
	// 開始情報作成
	var fromElement = $j("<div/>");
	// 全部分配の予約Idリスト設定
	fromElement.attr("childrenItems",leadArr.join(','));
	// スシテム用のデータ字段の設定
	fromElement.attr("nocleanRoomNgId",[]);
	// 移動目標作成
	var toElement = $j("<div/>");
	// スシテム用のデータ字段の設定
	toElement.attr("roomId",'');
	// Callback変数設定
	$j("#noAssignLeadListWindow").attr("assignRoom",true);
	// 分配開始
	ajaxSyncNoAssignInfoByBulk(fromElement, toElement);
}
// 2019/10/30 ルームインジケータに「自動一括アサイン」ボタンが欲しい by zy END
// 2019/11/15 ルームインジケータの表示について、清掃済だけでなくインスペ完の状況を追加したいです。 by zy BEGIN
function initCleanCnt(){
	var classObjMap = {};
	$j("div#header[class*='status_']").each(function(){
		this.classList.forEach(function(name){
			if (name.includes("status_")){
				if (!(name in classObjMap)) classObjMap[name] = 0;
				classObjMap[name] = classObjMap[name] + 1;
			}
		});
	});
	$j(".cleanCnt").text("[0]");
	for (classNm in classObjMap) {
		$j("img." + classNm).prev(".cleanCnt").text('[' + classObjMap[classNm] + ']');
	}
	
}
// 2019/11/15 ルームインジケータの表示について、清掃済だけでなくインスペ完の状況を追加したいです。 by zy END
// 2019/12/30 小部屋の作成 BY zyz BEGIN
// 2020/02/29 小部屋機能改善 BY zyz BEGIN
function leadStayNightFun(e,leadIdStr,roomIdStr,leadIndexStr,leadEntryStr,roomTypeCode){
// 2020/02/29 小部屋機能改善 BY zyz END
   	LookupHoverDetail.hideAllHovers();
   	window.event.stopPropagation();
	// 小部屋数据已做成，是否继续做成
	var titleStr = $j(e).attr("title");
	if(titleStr == '小部屋データ作成済'){
		// 小部屋データに作成済み、新た小部屋データを作成しますか？
		if(!window.confirm( "{!$Label.MSG_008_0132}")) {
			return false;
		}
	}
   	// 页面锁死
	blockUi();
	// 连泊数据判定
    Visualforce.remoting.Manager.invokeAction(
        "{!$RemoteAction.RoomIndicatorInfo.leadNightInfo}",roomIdStr,leadIndexStr,kendo.toString(new Date(leadEntryStr),JINYACONNECT.DateFormat), function(result, event){
            // 異常
            if(event.type == 'exception') {
	            alert(event.message);
	            unblockUi();
            } else {
            	var win = $j(e);
            	if(result){
            		// 2020/02/29 小部屋機能改善 BY zyz BEGIN
            		// 小部屋連泊データを一括作成する、よろしいですか
            		if (window.confirm( "{!$Label.MSG_008_0130}")) leadRoomCreate(win,leadIdStr,true,roomTypeCode);
            		else leadRoomCreate(win,leadIdStr,false,roomTypeCode);
				} else leadRoomCreate(win,leadIdStr,false,roomTypeCode);
				// 2020/02/29 小部屋機能改善 BY zyz END
            	// unblockUi();
            }
    });
}
// 2020/02/29 小部屋機能改善 BY zyz BEGIN
function leadRoomCreate(win,leadIdStr,LeadStayNightFlg,roomTypeCode){
	var roomJson = $j("[id$=hidroomSelectJsons]").val();
	roomTypeMap = roomJson !="" ? JSON.parse($j("[id$=hidroomSelectJsons]").val()) : undefined;
	var  roomTypeFlg = roomTypeMap[roomTypeCode];
	var defRoomFlg = $j("[id$=hiddefRoomFlg]").val();
	if((roomTypeFlg == undefined && defRoomFlg == "true" ) || roomTypeFlg){
		var d = sfdcPage.dialogs['MyCoolDialog'], close;
		if (!d) {
			// if the dialog doesn't exist create one
			d = sfdcPage.dialogs['MyCoolDialog'] = new SimpleDialog('MyCoolDialog', false);
			// set general information on your dialog and finally run the create function
			d.setWidth(380);
			d.createDialog();
		}
		d.setTitle('小部屋');
		var locRoomHtmls = '<tr><td colspan="2" style="width:350px;"></td></tr><tr><td class="labelCol first " width="80px"><label>作成部屋数</label></td><td class="data2Col first "><select id="dialog_roomNum"><option value="1" >1</option><option value="2" >2</option><option value="3" >3</option><option value="4" >4</option><option value="5" >5</option><option value="6" >6</option><option value="7" >7</option><option value="8" >8</option><option value="9" >9</option><option value="10" >10</option></select></td></tr>';
		// 按钮显示
		var buttonHtml = '<input class="btn" id="dialog_printoutBtn" style="width: 100px" type="button" value="小部屋" /></td>';
		$j(d.dialog).find('#MyCoolDialogInner').html('<div class="pbBody"><div><div class="pbSubsection"><table class="detailList" border="0" cellpadding="1" cellspacing="1">' + locRoomHtmls +'<tr><td colspan="2" style="text-align: right;"><input class="btn" id="dialog_cancelBtn" style="width: 100px" type="button" value="キャンセル" />    '+buttonHtml+'</tr></table></div></div></div>');
		// 按钮事件
		$j(d.dialog).find('input[type="button"]').on('click', function() {
			var btnId = $j(this).attr("id");
			if (btnId == "dialog_cancelBtn") {
				d.hide();
			} else if (btnId == "dialog_printoutBtn") {
				var selectRoomVal = $j("#dialog_roomNum").val(); 
				var obj = {
					leadId:leadIdStr,
					roomNumStr:selectRoomVal
				}
				// 页面锁死
				blockUi();
			    Visualforce.remoting.Manager.invokeAction(
			        "{!$RemoteAction.RoomIndicatorInfo.createLeadInfo}", JSON.stringify(obj),LeadStayNightFlg, function(result, event){
			            // 異常
			            if(event.type == 'exception') {
				            alert(event.message);
				            unblockUi();
			            } else {
			            	win.closest("td").load();
			            	if(result){
			            		// 未割当窗口数据刷新
				            	noAssingLeadInfoDs.read();
				            	// 2020/02/29 小部屋機能改善 BY zyz BEGIN
				            	// 小部屋图标变更颜色
								// win.css({'filter':'grayscale(100%)'});
								$j("img[name=roomImgOnName]" ,win.closest("div")).css('display','none');
								$j("img[name=roomImgOffName]" ,win.closest("div")).css('display','');
								// 小部屋title变更： '小部屋作成する' ==》 '小部屋データ作成済'
								// win.attr('title','小部屋データ作成済');
								// 2020/02/29 小部屋機能改善 BY zyz END
							// 未做成小部屋数据，提示信息："小部屋データが作成できません"
							} else alert("{!$Label.MSG_008_0131}");
							// 页面锁死打开
			            	unblockUi();
			            }
			    });
				d.hide();
			}
			
		});
		d.show();
		// 页面锁死打开
        unblockUi();
	} else {
		var obj = {
			leadId:leadIdStr,
			roomNumStr:'1'
		}
		// 小部屋数据做成
    	Visualforce.remoting.Manager.invokeAction(
        	"{!$RemoteAction.RoomIndicatorInfo.createLeadInfo}", JSON.stringify(obj),LeadStayNightFlg, function(result, event){
        // 2020/02/29 小部屋機能改善 BY zyz END
	            // 異常
	            if(event.type == 'exception') {
		            alert(event.message);
		            unblockUi();
	            } else {
	            	if(result){
	            		// 未割当窗口数据刷新
		            	noAssingLeadInfoDs.read();
		            	// 2020/02/29 小部屋機能改善 BY zyz BEGIN
		            	// 小部屋图标变更颜色
		            	// win.css({'filter':'grayscale(100%)'});
		            	$j("img[name=roomImgOnName]" ,win.closest("div")).css('display','none');
		            	$j("img[name=roomImgOffName]" ,win.closest("div")).css('display','');
						// 小部屋title变更： '小部屋作成する' ==》 '小部屋データ作成済'
						// win.attr('title','小部屋データ作成済');
						// 2020/02/29 小部屋機能改善 BY zyz END
					// 未做成小部屋数据，提示信息："小部屋データが作成できません"
					} else alert("{!$Label.MSG_008_0131}");
					// 页面锁死打开
	            	unblockUi();
	            }
	    });
    // 2020/02/29 小部屋機能改善 BY zyz BEGIN
    }
    // 2020/02/29 小部屋機能改善 BY zyz END
}
// 2019/12/30 小部屋の作成 BY zyz END
// 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH BEGIN 
function getBlankRows(dataRows){
	// 処理行
	if (dataRows == undefined) dataRows = $j("tr.tranDetailRow");
	// 非空行
	var noBlankRows = dataRows.has("[id$=hidProductId][value][value!='']");
	// 空行
	var blankRows = dataRows.not(noBlankRows);
	return blankRows;
}
// 2020/04/30 複数のプランとそれぞれのプランの人数を選択し機能対応 WGCH END
</script>
<!-- 2016/10/13 END by zh -->
<!-- This component is added to show call register popup -->
<c:CallRegisterPopup rendered="{!!isIncludeMode}"></c:CallRegisterPopup>
<!-- 2018/05/01 ルームインジケータで予約をクリックして、『部屋詳細情報』が開きます。 by zy BEGIN -->
<input type="hidden" value="{!isAutoClassFlag}" id="hidAutoCloseFlag"/>
<!-- 2018/05/01 ルームインジケータで予約をクリックして、『部屋詳細情報』が開きます。 by zy END -->
<!-- 2021/03/31 予約ポップやルームインジケータから予約作成する際に郵便番号検索が使えるようにして欲しい by zy BEGIN -->
<c:ZipCodeSearchComp />
<!-- 2021/03/31 予約ポップやルームインジケータから予約作成する際に郵便番号検索が使えるようにして欲しい by zy END -->
</apex:page>